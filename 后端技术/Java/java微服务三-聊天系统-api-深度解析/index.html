<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Java微服务（三）：3. 核心抽象 API 深度解析 | 格物致知</title><meta name="keywords" content="Java微服务-AI篇"><meta name="author" content="Prorise"><meta name="copyright" content="Prorise"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#cee8ff"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Java微服务（三）：3. 核心抽象 API 深度解析"><meta name="application-name" content="Java微服务（三）：3. 核心抽象 API 深度解析"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#cee8ff"><meta property="og:type" content="article"><meta property="og:title" content="Java微服务（三）：3. 核心抽象 API 深度解析"><meta property="og:url" content="https://prorise-cool.github.io/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%89-%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F-api-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/index.html"><meta property="og:site_name" content="格物致知"><meta property="og:description" content="3. 对话核心 API 深度解析 **重点说明：**该教程前端部分无需细扣，真正的前端实战会在后面，目前的前端功能直接复制过去，没有必要去读源码，明白后端如何调用前端即可，因为目前的前端还不够规范！仅为示例！！  在快速入门章节中，我们已经初步体验了 ChatClient 的便捷。现在，是时候深入水"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2025/06/19/68535b23089d0.webp"><meta property="article:author" content="Prorise"><meta property="article:tag" content="全栈, Full Stack, 前端, 后端, Node.js, Vue, React, 数据库, Linux, Docker, 个人博客, 技术分享"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2025/06/19/68535b23089d0.webp"><meta name="description" content="3. 对话核心 API 深度解析 **重点说明：**该教程前端部分无需细扣，真正的前端实战会在后面，目前的前端功能直接复制过去，没有必要去读源码，明白后端如何调用前端即可，因为目前的前端还不够规范！仅为示例！！  在快速入门章节中，我们已经初步体验了 ChatClient 的便捷。现在，是时候深入水"><link rel="shortcut icon" href="/img/icons/favicon.ico"><link rel="canonical" href="https://prorise-cool.github.io/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%89-%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F-api-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="code-xxx"><meta name="msvalidate.01" content="xxx"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media=&quot;all&quot;"><script async="" src="https://www.googletagmanager.com/gtag/js?id=[object Object]"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","[object Object]")</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"与数百名博主无限进步","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"Prorise","mode":"tianli","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"S-DNA1JM95BX2F9L0N","Referer":"https://xx.xx/"},
  diytitle: undefined,
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo.prorise666.site/',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":4000,"accessToken":"b39753735ed0ed5ffeb771bc108e3158","mailMd5":"ec3291d59a8d7d3675df8a0537fcbc979f0fa611c8df55841fb7f4fd162bd07a"},
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"both","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["🤣 全栈开发工程师","🙂 前端架构设计师","🙃 后端服务构建者","🤩 移动端应用开发","🤯 数据库设计专家","🥳 DevOps运维实践者","🤭 技术栈多面手","😎 性能优化达人"]},
  algolia: {"appId":"K8Y7M0RMXQ","apiKey":"11fa7380e2694483a44b143044e69e6e","indexName":"prorise_blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":3,"position":"top","messagePrev":"距离上次更新已经过了","messageNext":"天，文章内容可能已经过时。"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Prorise","link":"链接: ","source":"来源: 格物致知","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"格物致知",title:"Java微服务（三）：3. 核心抽象 API 深度解析",postAI:"true",pageFillDescription:"3. 对话核心 API 深度解析, 3.1 ChatClient 对话的核心枢纽, 3.1.1 call() vs. stream() 同步与流式的抉择, 3.1.2 ChatClient 实战代码, 3.1.3 小结：如何访问和测试API, 3.2 调试与洞察：Advisor 与日志, 3.3 前端环境搭建, 3.3.1 初始化 Vue 3 项目, 3.3.2 集成 Tailwind CSS, 3.3.3 集成 UI 组件库 (DaisyUI amp Element Plus), 3.3.4 主程序入口配置 (main.js), 3.4 阶段小实战：构建企业级AI对话界面, 3.4.1 核心依赖补全, 3.3.2 项目目录结构创建, 3.4.3 核心代码实现, 0.处理API请求（Axios）, 1. 状态管理层 (Pinia), 2. 可组合函数 (Composables), 3. 视图层 (ChatView.vue), 4. 主程序入口 (src/main.js), 5.后端配置跨域请求, 3.5 对话记忆 (Chat Memory)：让 AI 拥有上下文 (查阅), 3.5.1 核心概念：策略与存储的分离, 3.5.2 记忆策略：MessageWindowChatMemory, 3.5.3 记忆存储：从内存到持久化 (ChatMemoryRepository) (查阅), 1. 内存存储库 (InMemoryChatMemoryRepository), 2. JDBC 存储库 (JdbcChatMemoryRepository), 3.5.4 集成与配置：将记忆注入 ChatClient (查阅), 组合配置 CommonConfiguration.java, 3.5.5 实际调用：传递会话 ID, 1. Service 层改造, 2. Controller 层改造, 3.5.6 前端适配：核心代码实现, 1. API 层 src/api/chat.js, 2. 状态管理层 src/stores/conversationStore.js, 3. 逻辑层 Composables, 4. 视图层 src/views/ChatView.vue, 3.6 会话历史：从数据库加载与管理, 3.6.1 后端建设：构建历史记录服务, 1. 引入依赖与配置, 2. 数据访问层 (Entity amp Mapper), 3. 业务逻辑层 (Service amp ServiceImpl), 4. API 接口层 (Controller), 3.6.2 前端集成：实现真正的持久化会话, 1. 新增前端 API 文件, 2. 状态与逻辑层核心升级对话核心深度解析重点说明该教程前端部分无需细扣真正的前端实战会在后面目前的前端功能直接复制过去没有必要去读源码明白后端如何调用前端即可因为目前的前端还不够规范仅为示例在快速入门章节中我们已经初步体验了的便捷现在是时候深入水面之下探索设计的基石核心抽象的可移植性设计哲学正是通过这层优雅的抽象实现的无论你面对的是还是未来的任何新模型你的业务代码始终与一套稳定统一的接口对话本章我将带你逐一解构这些核心接口和对话的核心枢纽是你与大语言模型进行对话交互的唯一入口它将底层不同厂商的复杂性如不同的认证方式请求响应格式错误处理完全封装为你提供了一个极其简洁和统一的编程模型它的核心职责是发送一个包含上下文和指令的并接收模型生成的这个过程可以通过两种方式完成同步和流式同步与流式的抉择和方法是的两个主要动作它们服务于不同的交互场景同步调用这是最直接的方式你的应用发送请求后会一直等待直到模型生成完整的响应后一次性返回它简单易于处理适用于那些不需要实时反馈可以接受短暂等待的场景流式调用这种方式会立即返回一个来自的响应式流模型会像打字机一样逐个可以理解为单词或字符块地将内容推送回来你的应用可以实时接收并处理这些数据片段这极大地提升了用户体验尤其是在构建交互式聊天机器人时下表清晰地对比了两种方法的差异特性方法方法方法签名返回类型单个响应对象响应式数据流执行模式同步阻塞异步非阻塞数据返回一次性返回完整内容逐步分块返回内容典型用例后台任务处理如生成报告总结邮件中简单的问答数据提取与转换交互式聊天机器人界面打字机效果需要处理长文本响应的应用对实时性要求高的场景编程模型传统命令式编程响应式编程实战代码让我们通过一个简单的例子看看如何在代码中使用我们定义一个新的包通过来调用它既能提供一次性的答案也能提供流式输出在这之前我们有必要说明一下我们接下来会用到的两个方法分别是和的区别我用一个表格来清晰地展示它们的区别特性返回类型流中内容纯文本字符串片段例如今天天气不错完整的响应对象信息丰富度基础只包含生成的文字丰富每个对象都包含生成的文本片段消耗信息实时或最终对话结束原因模型等其他元数据性能开销极低网络传输和内存占用都最小只传递最必要的信息略高传输的数据包更大因为包含了元数据需要创建更多对象适用场景绝大多数场景例如在前端像打字机一样流式显示的回答高级或需要监控的场景例如你需要实时计算和显示消耗你需要根据判断对话是因为内容生成完毕还是因为达到了长度限制而结束如果你只关心说了什么那么使用它最简单最高效能满足的需求如果你不仅关心说了什么还关心它是怎么说的比如消耗了多少资源为什么停止等那么使用对于前端流式打字机效果是完美的选择对于需要精细控制或监控的后端服务则提供了更强大的能力通过构造函数注入由自动配置好的同步调用示例一次性获取的完整回答用户的提问生成的完整文本内容是一个便捷的流式入口用于快速构建和发送请求指定了用户角色的消息发起同步调用是一个快捷方法用于直接从中提取文本内容流式调用示例返回一个可以逐块消费的响应流用户的提问一个包含片段的流发起流式调用它会立即返回一个对象调用者可以订阅这个来处理陆续到达的数据流式内容调用返回纯文本内容的响应流用户的提问一个包含文本内容片段的流对于我们进行如下的改变定义一个请求接口以现代响应式的方式流式输出回答接收来自的查询参数一个包含回答文本块的响应式数据流这里必须指定编码否则中文将无法正确编码你是谁通过处理流式聊天请求同步聊天接口一次性返回完整的回答接收来自的查询参数生成的完整文本内容你是谁通过处理同步聊天请求流式聊天接口返回包含更多元数据的流接收来自的查询参数一个包含对象的响应式数据流你是谁通过处理流式请求小结如何访问和测试现在我们已经定义好了业务类和控制器一个功能完备的聊天后端服务就绪了启动你的主应用类接下来我将指导你如何通过常见的工具访问我们创建的三个接口测试这些接口最便捷的工具是你的网页浏览器和命令行工具下表总结了每个接口的访问方式和预期效果接口功能访问示例推荐测试方法预期输出流式返回纯文本打字机效果你好世界浏览器或纯文本的流式输出文字会像打字机一样逐个出现同步返回完整文本你好世界浏览器或等待片刻后浏览器页面上一次性显示完整的回复文本流式返回对象你好世界连续的对象流每个对象都是一个的内容测试流式文本接口浏览器这是最直观的方式直接在浏览器地址栏输入请介绍一下长城并回车你会看到浏览器的加载动画会持续旋转同时页面上的文字会不断地动态增加直到回答完毕在你的命令行终端中输入以下命令请介绍一下长城参数告诉不要使用缓冲立刻将接收到的数据显示在终端上你将看到文字逐行或逐块打印出来测试同步文本接口浏览器在地址栏输入中国的首都是哪里页面会加载一小会儿然后一次性显示出完整答案例如中国的首都是北京中国的首都是哪里终端会等待几秒然后直接打印出完整的回复测试流式接口浏览器不推荐使用浏览器直接访问这个接口由于返回的是的事件流大多数浏览器会尝试下载一个文件或者无法正确地渲染持续到来的对象这是观察其原始输出的最佳方式你好你会在终端看到一系列连续输出的对象每个对象之间可能有换行每一个对象都是一个独立的序列化后的结果格式可能如下所示你好通过以上方法你可以清晰地观察到同步与流式返回纯文本与返回完整响应对象之间的差异建议你亲自尝试并使用浏览器的开发者工具标签页来观察不同请求的响应头和响应体这会让你对协议和设计有更深刻的理解调试与洞察与日志到目前为止我们已经构建了功能强大的但当的回答不符合预期时我们如何知道发送给模型的完整提示到底是什么样的例如我们通过配置的全局指令是如何与我们当前的用户问题组合在一起的为了解决这个黑盒问题提供了顾问机制就像是安装在请求响应链路上的拦截器或中间件它允许我们在请求发送给之前对其进行修改或审查并在收到响应后进行处理提供了一些非常有用的内置顾问本节我们将学习其中用于调试的是一个专门用于调试的工具它的唯一职责就是将发送给大语言模型的最终请求完整和从模型那里收到的原始响应以或级别打印到控制台日志中这为我们提供了一个强大的窥镜可以清晰地看到每一次交互的全部细节在项目中引入日志顾问要使用我们需要完成两步配置第一步启用日志我们需要告诉的日志系统我们希望看到来自的详细调试信息在文件中添加配置新增配置日志级别将包的日志级别设为以激活的输出同时将我们自己应用的包也设为方便观察第二步在中配置日志顾问接下来我们修改在构建时将作为默认顾问添加进去文件路径你是一个由创作出来的大模型名字叫做小请你在以后的回复中以新的身份和语气回复我关键将添加为默认顾问观察日志输出完成以上配置并重启应用后调用任一聊天接口例如访问你好现在请观察您的控制台您会看到类似下面这样的详细日志输出你是一个由创作出来的大模型名字叫做小请你在以后的回复中以新的身份和语气回复我你好你好我是小很高兴能为您服务有什么可以帮助您的吗日志解读这部分清晰地展示了最终发送给大语言模型的完整消息列表我们可以清楚地看到我们配置的系统提示和用户的你好被正确地组合在了一起这部分展示了模型返回的原始消息内容通过我们获得了对内部通信的完全可见性这在进行提示词工程和问题排查时是不可或缺的利器前端环境搭建本节将快速搭建一个基于的前端开发环境初始化项目首先使用和创建并初始化项目使用创建项目进入目录并安装基础依赖集成接下来为项目添加并完成基础配置安装依赖生成配置文件更新配置与样式文件如果目录不存在请创建集成组件库安装依赖安装作为开发依赖安装作为生产依赖在中启用添加插件可选主题等配置启用的主题列表可按需选择组件类是否默认应用默认为是否应用基础样式默认为是否应用工具类默认为是否在控制台显示日志默认为主程序入口配置这是非常关键的一步我们将更新文件它会同时引入的基础样式并全局注册插件确保所有功能都准备就绪引入样式引入的注册插件阶段小实战构建企业级对话界面在的基础上本节将通过安装专业级组件库创建标准化的目录结构并填充模块化的核心代码一步步完整实现一个功能强大结构清晰的聊天机器人前端应用我们保持后端的代码简洁如下定义一个请求接口以现代响应式的方式流式输出回答接收来自的查询参数一个包含回答文本块的响应式数据流修改为流式响应格式你是谁通过处理流式聊天请求流式内容调用返回纯文本内容的响应流用户的提问一个包含文本内容片段的流核心依赖补全节中我们安装了基础库现在我们需要补全应用逻辑所必需的核心库包括状态管理路由工具函数以及本次实战的主角专业的对话组件库安装状态管理网络请求安装和组合式函数工具库安装提供高级对话组件项目目录结构创建一个良好清晰的目录结构是大型项目的基石在目录下执行以下命令创建我们规划好的所有子目录在目录下一次性创建所有规划好的文件夹执行后你的目录结构应如下所示核心代码实现现在我们按照从底层数据逻辑到上层视图的顺序依次填充每个文件处理请求核心接口以流式方式获取回答用户消息返回一个支持流式读取的对象使用封装好的发送请求通过处理流式响应保持项目中请求方式的统一性状态管理层文件负责以组件库所需的标准格式来存储和管理对话数据这是一个使用状态管理库创建的对话存储模块导出一个名为的状态存储用于管理聊天对话的状态定义存储的状态数据存储格式的消息数组消息计数器定义可以修改状态的操作方法添加一条新消息到对话历史中创建符合组件要求的消息对象唯一标识角色定义气泡位置消息内容流式接收时只需要改这个值即可当前气泡的加载状态气泡的形状气泡的样式是否渲染为是否开启打字器效果该属性不会和流式接收冲突是否开启打字雾化效果该效果新增且在为时生效该效果会覆盖的属性头像头像占位大小头像与气泡之间的距离向最后一条消息追加内容用于流式接收回复如果没有消息则直接返回获取最后一条消息只有当最后一条消息是助手的回复时才追加内容清空对话历史可组合函数我们将不同的逻辑关注点分离到独立的函数中以实现最大程度的复用和解耦聊天核心逻辑聊天核心逻辑处理消息发送流式接收状态管理等状态管理会话和输入消息使用处理流式数据计算属性处理累积的流式数据检查是否是对象且包含属性只有当不为空时才添加空的直接跳过不打印警告未知的格式解析流数据时出错监听流式数据更新实时追加到消息中获取新增的内容部分监听错误信息流式请求失败抱歉处理您的请求时遇到了问题处理用户提交消息使用处理流式接收验证输入添加用户消息到对话历史清空输入框创建回复占位获取流式响应使用处理流式数据发起流式请求失败抱歉发起请求时遇到了问题清空对话历史重新生成会话状态使用的状态方法流式处理相关暴露取消功能消息动态状态处理消息格式化现在消息已经按格式存储只需要处理动态状态添加动态状态到消息列表只有最后一条消息在生成时显示打字效果视图层现在我们的视图层变得极其简洁它只负责组合的能力和的组件左侧会话管理会话管理右侧聊天区域聊天标题全栈聊天机器人聊天内容区消息列表发送器请输入您的问题会话管理相关第一个会话第二个会话选中了确保组件铺满全屏主程序入口最后确保正确初始化并注册了所有模块后端配置跨域请求现在我们启动前端服务器并在输入框上与大模型对话就能看到大模型给我们的所有响应格式对话记忆让拥有上下文查阅大型语言模型天生是无状态的它们不会保留任何关于先前交互的记忆这意味着每一次调用都是一次全新的独立的对话如果我们希望构建一个能够进行多轮对话理解上下文的智能应用就必须引入记忆机制提供的功能正是为了解决这个问题而生它允许我们在与的多次交互中有效地存储和检索对话上下文核心概念策略与存储的分离在深入研究之前我们必须清晰地理解在记忆功能上的核心设计思想将记忆的策略如何记住与记忆的存储记在哪里相分离这一思想通过两个核心接口得以实现策略定义了记忆的策略和行为它决定了应该保留哪些消息何时删除旧消息例如只保留最近条消息就是一个策略存储定义了记忆的存储和检索它的唯一职责是在后端如内存数据库存取消息数据我们可以这样理解是一个仓库而则是高效率的仓库管理员管理员根据自己的一套规则策略来管理仓库中的货物消息同时我们必须辨别另一个重要概念术语定义在中的作用聊天记忆为了让理解下文而提供的一个相关的有限的对话历史子集用于构建抽象负责管理这个短期记忆决定哪些历史消息应该被包含在下一次发给的请求中聊天记录一段会话中全部完整的消息交换历史用于审计或长期存储的不负责存储完整的聊天记录如需此功能应使用等持久化方案自行实现记忆策略默认并最常用的记忆策略是即消息窗口记忆工作原理它像一个滑动窗口始终只保留最近的条消息当新的消息进入时最老的消息就会被挤出窗口系统消息通常会被特殊保留不受窗口大小影响核心优势这是在实际应用中性价比最高的策略它能有效防止上下文无限增长从而避免超出模型限制而报错同时也能节省大量的费用记忆存储从内存到持久化查阅是一个负责物理存储和检索消息的抽象接口提供了多种内置实现让我们可以轻松地将对话记忆从易失的内存切换到可靠的持久化数据库中内存存储库这是最基础最简单的实现它使用内置的来存储消息特点无需任何额外配置和依赖开箱即用非常适合快速原型开发和测试缺点数据随应用程序的重启而丢失不适用于生产环境自动配置默认情况下如果项目中没有配置其他任何的会自动配置一个实例存储库这是一个通用的实现用于将聊天消息存储在任何支持的关系型数据库中如等是生产环境的首选引入依赖配置属性属性描述默认值控制何时初始化数据库表结构可选值用于初始化表结构的脚本位置会被自动替换手动指定数据库平台如自动检测初始化最佳实践开发时可以设置为让自动创建表非常方便生产时强烈推荐设置为在生产环境中数据库的表结构应该由专业的数据库迁移工具如或来管理或者由手动执行脚本创建以确保版本控制和安全性表结构定义如果选择手动创建以下是所需的表结构存储消息类型如为未来的多模态消息预留存储额外信息集成与配置将记忆注入查阅我们已经有了策略和仓库现在需要将它们组装起来并让使用它们最佳实践是使用顾问将记忆功能自动织入到的调用流程中记忆顾问工作原理适用场景将历史记录作为标准的对象列表加入到中最常用最标准的多轮对话能完整保留角色和上下文信息将历史记录格式化为纯文本字符串并附加到中简单的上下文附加或当某个特定模型对纯文本上下文处理得更好时从向量数据库中搜索与当前输入最相关的历史片段作为记忆实现长期记忆或式的对话让能回忆起很久以前的相关信息组合配置现在我们将所有部分组合在一个文件中展示一个完整的基于持久化的记忆配置文件路径会根据我们的配置自动为我们配置好一个因此我们可以直接注入它定义我们的记忆策略这里我们创建了一个使用持久化存储的最大容量为条消息的窗口记忆实例指定记忆的仓库指定记忆的策略只保留最近条消息定义我们最终的我们将日志和记忆功能通过顾问模式织入自动配置好的实例我们上面定义的实例一个配置好日志和持久化记忆功能的实例添加日志顾问用于调试添加记忆顾问并传入我们的记忆策略实际调用传递会话配置完成后我们还需要在调用时告诉它当前这次对话属于哪个会话以便它能从数据库中加载正确的历史记录这是通过传递一个会话来实现的层改造我们的需要能够接收并将其传递给方法带聊天记忆的流式对话用户输入消息会话用于维护聊天记忆回复的文本内容流用户输入消息关键通过方法的参数将会话传递给记忆顾问是官方提供的标准推荐使用层改造相应地的接口也需要增加一个参数以从前端请求中接收这个构造函数注入关键从请求参数中获取会话至此我们的后端就拥有了完整的可持久化的多会话记忆能力每个唯一的都会在表中拥有自己独立的聊天记录前端适配核心代码实现后端具备记忆能力后前端的核心任务是管理并发送以下是实现此功能的几个关键文件的核心代码与直接说明层目的让调用能携带以流式方式获取回答用户消息新增当前会话的唯一状态管理层目的重构状态管理从单一对话升级为支持多会话的完整系统这是前端实现多会话记忆的核心这是一个使用状态管理库创建的对话存储模块导出一个名为的状态存储用于管理多会话聊天对话的状态定义存储的状态数据所有会话的数据按会话分组存储会话标题格式的消息数组用于分组显示当前活跃的会话消息计数器计算属性获取当前会话的消息列表获取当前会话信息获取会话列表用于组件定义可以修改状态的操作方法创建新会话新的会话自动切换到新会话切换会话删除会话如果删除的是当前会话切换到其他会话或创建新会话重命名会话添加一条新消息到当前会话确保有当前会话创建符合组件要求的消息对象唯一标识角色定义气泡位置消息内容流式接收时只需要改这个值即可当前气泡的加载状态气泡的形状气泡的样式是否渲染为是否开启打字器效果该属性不会和流式接收冲突是否开启打字雾化效果该效果新增且在为时生效该效果会覆盖的属性头像头像占位大小头像与气泡之间的距离智能更新会话标题基于用户的第一条消息新的会话向当前会话的最后一条消息追加内容用于流式接收回复确保有当前会话如果没有消息则直接返回获取最后一条消息只有当最后一条消息是助手的回复时才追加内容清空当前会话历史清空所有会话历史初始化默认会话如果没有任何会话默认会话如果没有当前会话选择最近更新的会话逻辑层目的将复杂的交互逻辑与核心的聊天功能逻辑解耦使代码更清晰聊天核心逻辑聊天核心逻辑处理消息发送流式接收状态管理等状态管理使用新的会话管理系统输入消息使用处理流式数据计算属性处理累积的流式数据检查是否是对象且包含属性处理非空空块通常表示换行符未知的格式解析流数据时出错监听流式数据更新实时追加到消息中获取新增的内容部分监听错误信息流式请求失败抱歉处理您的请求时遇到了问题处理用户提交消息使用处理流式接收验证输入确保有当前会话添加用户消息到对话历史清空输入框创建回复占位获取流式响应传递当前会话发送请求会话使用处理流式数据发起流式请求失败抱歉发起请求时遇到了问题组件挂载时初始化状态返回当前会话的消息使用的状态方法流式处理相关暴露取消功能会话管理逻辑会话管理处理会话相关的交互逻辑当前选中的会话用于组件当前会话标题全栈聊天机器人会话切换处理会话切换切换到新建会话新建会话成功新建会话清空当前会话历史确定要清空当前会话的所有消息吗确认清空确定取消已清空当前会话历史用户取消操作处理会话菜单命令重命名删除菜单命令未知的菜单命令重命名会话请输入新的会话名称重命名会话确定取消会话名称长度必须在个字符之间重命名成功用户取消操作删除会话确定要删除会话吗此操作不可撤销确认删除确定取消删除成功用户取消操作状态方法视图层目的整合所有状态和逻辑构建最终的用户交互界面左侧会话管理会话管理新建会话右侧聊天区域聊天标题清空当前会话清空聊天内容区消息列表发送器请输入您的问题聊天功能会话管理功能确保组件铺满全屏会话历史从数据库加载与管理在上一章我们配置了它会默默地将所有对话记录保存到数据库表中这解决了的短期记忆问题但对于一个完整的应用而言我们还需要让用户能够看到并管理自己的历史会话列表就像所有主流聊天应用一样本章我们将使用这个强大的框架直接操作表为其创建一套完整的和从而实现真正的会话持久化和管理功能后端建设构建历史记录服务我们的第一步是在后端搭建一套完整的用于查询和管理聊天历史的服务引入依赖与配置在中添加依赖在主启动类上添加注解扫描接口所在的包在中添加配置配置开启驼峰命名转换打印日志到控制台方便调试逻辑删除配置如果你的表设计中有逻辑删除字段指定文件的位置如果使用数据访问层实体类这个实体类直接映射到数据库表让我们能以对象的方式操作数据精确指定表名或接口通过继承我们无需编写任何语句即可拥有强大的单表能力继承后所有基础的数据库操作都已具备我们将使用来处理复杂的查询以获得更好的类型安全和灵活性业务逻辑层服务接口定义了我们对外提供的所有历史记录管理功能根据会话获取该会话的完整聊天记录获取所有会话的列表信息用于前端展示会话列表删除指定会话的所有记录获取单个会话的统计信息服务实现这里是所有业务逻辑的具体实现按时间升序查询指定会话的所有消息这个方法相对复杂它需要为前端聚合每个会话的必要信息使用去重得到所有唯一的会话并保持时间倒序遍历每个唯一的会话查询其详细信息获取该会话的最后一条消息作为更新时间统计该会话的消息总数获取该会话的第一条用户消息作为默认标题新的会话此处省略了与中类似的单个会话信息查询逻辑查询逻辑接口层创建一个全新的将我们的方法暴露为供前端调用为历史记录管理设置统一前缀删除成功删除失败前端集成实现真正的持久化会话后端准备就绪后前端需要进行相应的升级从完全依赖本地状态转变为与后端深度集成实现真正的持久化新增前端文件创建一个新的文件专门用于调用我们刚刚创建的后端历史记录管理接口获取所有会话列表获取指定会话的聊天历史记录删除指定会话的聊天记录获取会话统计信息状态与逻辑层核心升级升级版这是前端改动的核心不再只是一个简单的本地状态容器它现在需要负责与后端进行异步通信加载和管理会话数据新增在应用启动时调用从后端获取所有会话的列表当用户切换到一个会话时如果该会话的消息尚未加载则调用此方法从后端拉取完整的聊天记录删除会话时先调用后端的删除成功后再更新本地状态修改现有切换会话时增加一步检查如果历史记录未加载则触发会话管理处理会话相关的交互逻辑当前选中的会话用于组件切换会话失败切换会话失败当前会话标题全栈聊天机器人会话切换处理会话切换切换到切换会话失败切换会话失败新建会话新建会话成功新建会话清空当前会话历史确定要清空当前会话的所有消息吗确认清空确定取消已清空当前会话历史用户取消操作处理会话菜单命令重命名删除菜单命令未知的菜单命令重命名会话请输入新的会话名称重命名会话确定取消会话名称长度必须在个字符之间重命名成功用户取消操作删除会话确定要删除会话吗此操作不可撤销确认删除确定取消删除成功删除失败删除会话失败删除会话失败用户取消操作状态方法和升级版新增生命周期钩子在组件挂载时调用中的或实现应用启动时自动加载历史会话中的删除切换等方法现在会调用中对应的异步并处理的成功或失败状态向用户显示如的提示信息聊天核心逻辑处理消息发送流式接收状态管理等状态管理使用新的会话管理系统输入消息使用处理流式数据计算属性处理累积的流式数据检查是否是对象且包含属性处理非空空块通常表示换行符未知的格式解析流数据时出错监听流式数据更新实时追加到消息中获取新增的内容部分监听错误信息流式请求失败抱歉处理您的请求时遇到了问题处理用户提交消息使用处理流式接收验证输入确保有当前会话添加用户消息到对话历史清空输入框创建回复占位获取流式响应传递当前会话发送请求会话使用处理流式数据发起流式请求失败抱歉发起请求时遇到了问题组件挂载时初始化会话初始化完成会话初始化失败状态返回当前会话的消息使用的状态方法流式处理相关暴露取消功能会话管理处理会话相关的交互逻辑当前选中的会话用于组件切换会话失败切换会话失败当前会话标题全栈聊天机器人会话切换处理会话切换切换到切换会话失败切换会话失败新建会话新建会话成功新建会话清空当前会话历史确定要清空当前会话的所有消息吗确认清空确定取消已清空当前会话历史用户取消操作处理会话菜单命令重命名删除菜单命令未知的菜单命令重命名会话请输入新的会话名称重命名会话确定取消会话名称长度必须在个字符之间重命名成功用户取消操作删除会话确定要删除会话吗此操作不可撤销确认删除确定取消删除成功删除失败删除会话失败删除会话失败用户取消操作状态方法通过以上改造我们的应用流程变为应用启动触发调用后端接口获取所有会话的概要信息并展示在左侧列表切换会话用户点击会话列表项检查该会话的详细消息是否已加载若未加载则调用接口获取数据然后更新界面删除会话用户点击删除调用后端接口成功后从本地中移除该会话至此我们的聊天应用不再是一个健忘的工具而是一个功能完备数据持久体验流畅的全栈应用",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-06-21 17:51:53",postMainColor:""}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0F1C2E')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#cee8ff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/index_media.css" media="(max-width:0),screen and (prefers-reduced-motion:reduce)" onload="this.media=`screen`"><link rel="stylesheet" href="/css/post-ui.css"><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://bu.dusays.com/2025/06/16/684f747174bc3.webp"><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async="" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="博客"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="博客"><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="后续项目..."><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="后续项目..."><span class="back-menu-item-text">后续项目...</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">格物致知</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)" rel="external nofollow noreferrer">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>个人</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="fas fa-check-double faa-tada"></i><span> 代办清单</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/awesome-links/"><i class="fas fa-link faa-tada"></i><span> 实用网站</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>预览</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?server=netease&amp;id=3117791189"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/messages/"><i class="fas fa-comments faa-tada"></i><span> 评论总览</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 即刻短文</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="background-change-button"><a class="site-page" onclick="toggleWinbox()" title="切换背景" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-palette"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/bYMH/418X445/ef9a3f68-d36a-441a-95fe-8179b1a25992.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/bYMH/418X445/ef9a3f68-d36a-441a-95fe-8179b1a25992.png"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/cYu3/347X390/zfb.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/cYu3/347X390/zfb.png"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">音乐</div><span class="author-content-item-title">灵魂的碰撞💥</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li></ul></div></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);" rel="external nofollow noreferrer"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/" itemprop="url">后端技术</a><i class="anzhiyufont anzhiyu-icon-angle-right post-meta-separator"></i><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/" itemprop="url">Java</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Java%E5%BE%AE%E6%9C%8D%E5%8A%A1-AI%E7%AF%87/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>Java微服务-AI篇</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Java微服务（三）：3. 核心抽象 API 深度解析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-06-21T02:44:31.269Z" title="发表于 2025-06-21 10:44:31">2025-06-21</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-06-21T09:51:53.399Z" title="更新于 2025-06-21 17:51:53">2025-06-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span data-flag-title="Java微服务（三）：3. 核心抽象 API 深度解析"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为广东"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>广东</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%89-%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F-api-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://bu.dusays.com/2025/06/19/68535b23089d0.webp"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">Tianli GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax="" src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope="" itemtype="https://prorise-cool.github.io/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%89-%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F-api-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"><header><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/" itemprop="url">后端技术</a><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/" itemprop="url">Java</a><a href="/tags/Java%E5%BE%AE%E6%9C%8D%E5%8A%A1-AI%E7%AF%87/" tabindex="-1" itemprop="url">Java微服务-AI篇</a><h1 id="CrawlerTitle" itemprop="name headline">Java微服务（三）：3. 核心抽象 API 深度解析</h1><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">Prorise</span><time itemprop="dateCreated datePublished" datetime="2025-06-21T02:44:31.269Z" title="发表于 2025-06-21 10:44:31">2025-06-21</time><time itemprop="dateCreated datePublished" datetime="2025-06-21T09:51:53.399Z" title="更新于 2025-06-21 17:51:53">2025-06-21</time></header><div id="postchat_postcontent"><h2 id="3-对话核心-API-深度解析"><a href="#3-对话核心-API-深度解析" class="headerlink" title="3. 对话核心 API 深度解析"></a>3. 对话核心 API 深度解析</h2><blockquote><p>**重点说明：**该教程前端部分无需细扣，真正的前端实战会在后面，目前的前端功能直接复制过去，没有必要去读源码，明白后端如何调用前端即可，因为目前的前端还不够规范！仅为示例！！</p></blockquote><p>在快速入门章节中，我们已经初步体验了 <code>ChatClient</code> 的便捷。现在，是时候深入水面之下，探索 Spring AI 设计的基石——核心抽象 API。Spring AI 的“可移植性”设计哲学，正是通过这层优雅的抽象实现的。无论你面对的是 OpenAI、Azure、Ollama 还是未来的任何新模型，你的业务代码始终与一套稳定、统一的接口对话。本章，我将带你逐一解构这些核心接口：<code>ChatClient</code>, <code>ImageClient</code>, 和 <code>EmbeddingClient</code>。</p><h3 id="3-1-ChatClient-对话的核心枢纽"><a href="#3-1-ChatClient-对话的核心枢纽" class="headerlink" title="3.1 ChatClient: 对话的核心枢纽"></a>3.1 <code>ChatClient</code>: 对话的核心枢纽</h3><p><code>ChatClient</code> 是你与大语言模型（LLM）进行对话交互的唯一入口。它将底层不同厂商 API 的复杂性（如不同的认证方式、请求/响应格式、错误处理）完全封装，为你提供了一个极其简洁和统一的编程模型。</p><p>它的核心职责是：发送一个包含上下文和指令的 <code>Prompt</code>，并接收模型生成的 <code>ChatResponse</code>。这个过程可以通过两种方式完成：同步 (<code>call</code>) 和流式 (<code>stream</code>)。</p><h4 id="3-1-1-call-vs-stream-同步与流式的抉择"><a href="#3-1-1-call-vs-stream-同步与流式的抉择" class="headerlink" title="3.1.1 call() vs. stream(): 同步与流式的抉择"></a>3.1.1 <code>call()</code> vs. <code>stream()</code>: 同步与流式的抉择</h4><p><code>call()</code> 和 <code>stream()</code> 方法是 <code>ChatClient</code> 的两个主要动作，它们服务于不同的交互场景。</p><ul><li><strong><code>call()</code> (同步调用)</strong>: 这是最直接的方式。你的应用发送请求后会一直等待，直到模型生成完整的响应后一次性返回。它简单、易于处理，适用于那些不需要实时反馈、可以接受短暂等待的场景。</li><li><strong><code>stream()</code> (流式调用)</strong>: 这种方式会立即返回一个 <code>Flux&lt;ChatResponse&gt;</code>（来自 Project Reactor 的响应式流）。模型会像打字机一样，逐个 Token（可以理解为单词或字符块）地将内容推送回来。你的应用可以实时接收并处理这些数据片段。这极大地提升了用户体验，尤其是在构建交互式聊天机器人时。</li></ul><p>下表清晰地对比了两种方法的差异：</p><table><thead><tr><th align="left">特性</th><th align="left"><code>.call()</code> 方法</th><th align="left"><code>.stream()</code> 方法</th></tr></thead><tbody><tr><td align="left"><strong>方法签名</strong></td><td align="left"><code>ChatResponse call(Prompt prompt)</code></td><td align="left"><code>Flux&lt;ChatResponse&gt; stream(Prompt prompt)</code></td></tr><tr><td align="left"><strong>返回类型</strong></td><td align="left"><code>ChatResponse</code> (单个响应对象)</td><td align="left"><code>Flux&lt;ChatResponse&gt;</code> (响应式数据流)</td></tr><tr><td align="left"><strong>执行模式</strong></td><td align="left">同步阻塞</td><td align="left">异步非阻塞</td></tr><tr><td align="left"><strong>数据返回</strong></td><td align="left">一次性返回完整内容</td><td align="left">逐步、分块返回内容</td></tr><tr><td align="left"><strong>典型用例</strong></td><td align="left">- 后台任务处理（如生成报告、总结邮件）<br>- API 中简单的问答<br>- 数据提取与转换</td><td align="left">- 交互式聊天机器人界面（打字机效果）<br>- 需要处理长文本响应的应用<br>- 对实时性要求高的场景</td></tr><tr><td align="left"><strong>编程模型</strong></td><td align="left">传统命令式编程</td><td align="left">响应式编程 (Reactive)</td></tr></tbody></table><h4 id="3-1-2-ChatClient-实战代码"><a href="#3-1-2-ChatClient-实战代码" class="headerlink" title="3.1.2 ChatClient 实战代码"></a>3.1.2 <code>ChatClient</code> 实战代码</h4><p>让我们通过一个简单的例子，看看如何在代码中使用 <code>ChatClient</code>。我们定义一个新的包<code>service</code>，通过Controller来调用<code>ChatService</code>，它既能提供一次性的答案，也能提供流式输出，在这之前我们有必要说明一下我们接下来会用到的两个方法，分别是<code>chatResponse()</code>和<code>content()</code>的区别</p><p>我用一个表格来清晰地展示它们的区别：</p><table><thead><tr><th align="left">特性 (Feature)</th><th align="left"><code>.stream().content()</code></th><th align="left"><code>.stream().chatResponse()</code></th></tr></thead><tbody><tr><td align="left"><strong>返回类型</strong></td><td align="left"><code>Flux&lt;String&gt;</code></td><td align="left"><code>Flux&lt;ChatResponse&gt;</code></td></tr><tr><td align="left"><strong>流中内容</strong></td><td align="left">纯文本字符串片段 (<code>String</code>)。例如：<code>"今天"</code>、<code>"天气"</code>、<code>"不错"</code>。</td><td align="left">完整的响应对象 (<code>ChatResponse</code>)。</td></tr><tr><td align="left"><strong>信息丰富度</strong></td><td align="left"><strong>基础</strong>：只包含AI生成的文字。</td><td align="left"><strong>丰富</strong>：每个 <code>ChatResponse</code> 对象都包含：1.AI生成的文本片段 2.Token消耗信息 (实时或最终)3.对话结束原因 (<code>finishReason</code>) 4.模型ID等其他元数据</td></tr><tr><td align="left"><strong>性能开销</strong></td><td align="left"><strong>极低</strong>：网络传输和内存占用都最小，只传递最必要的信息。</td><td align="left"><strong>略高</strong>：传输的数据包更大，因为包含了元数据，需要创建更多Java对象。</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left"><strong>绝大多数场景</strong>。例如，在前端像打字机一样流式显示AI的回答。</td><td align="left"><strong>高级或需要监控的场景</strong>。例如：&lt;br&gt; - 你需要实时计算和显示Token消耗。&lt;br&gt; - 你需要根据<code>finishReason</code>判断对话是因为内容生成完毕(<code>stop</code>)还是因为达到了长度限制(<code>length</code>)而结束。</td></tr></tbody></table><ul><li>如果你<strong>只关心AI说了什么</strong>，那么使用 <strong><code>.content()</code></strong>。它最简单、最高效，能满足90%的需求。</li><li>如果你不仅关心AI说了什么，还<strong>关心它“是怎么说的”</strong>（比如消耗了多少资源、为什么停止等），那么使用 <strong><code>.chatResponse()</code></strong>。</li></ul><p>对于前端流式打字机效果，<code>.content()</code> 是完美的选择。对于需要精细控制或监控的后端服务，<code>.chatResponse()</code> 则提供了更强大的能力。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellospringai.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatClient chatClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过构造函数注入由 Spring Boot 自动配置好的 ChatClient.Builder</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatService</span><span class="params">(ChatClient.Builder chatClientBuilder)</span> {</span><br><span class="line">        <span class="built_in">this</span>.chatClient = chatClientBuilder.build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步调用示例：一次性获取 AI 的完整回答</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 用户的提问</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> AI 生成的完整文本内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSimpleResponse</span><span class="params">(String message)</span> {</span><br><span class="line">        <span class="comment">// .prompt() 是一个便捷的流式 API 入口，用于快速构建和发送请求</span></span><br><span class="line">        <span class="comment">// .user() 指定了用户角色的消息</span></span><br><span class="line">        <span class="comment">// .call() 发起同步调用</span></span><br><span class="line">        <span class="comment">// .content() 是一个快捷方法，用于直接从 ChatResponse 中提取文本内容</span></span><br><span class="line">        <span class="keyword">return</span> chatClient.prompt()</span><br><span class="line">                .user(message)</span><br><span class="line">                .call()</span><br><span class="line">                .content();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 流式调用示例：返回一个可以逐块消费的响应流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 用户的提问</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 一个包含 ChatResponse 片段的 Flux 流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;ChatResponse&gt; <span class="title function_">getStreamResponse</span><span class="params">(String message)</span> {</span><br><span class="line">        <span class="comment">// .stream() 发起流式调用，它会立即返回一个 Flux 对象</span></span><br><span class="line">        <span class="comment">// 调用者可以订阅这个 Flux 来处理陆续到达的数据</span></span><br><span class="line">        <span class="keyword">return</span> chatClient.prompt()</span><br><span class="line">                .user(message)</span><br><span class="line">                .stream()</span><br><span class="line">                .chatResponse();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 流式内容调用：返回纯文本内容的响应流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 用户的提问</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 一个包含文本内容片段的 Flux 流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">getStreamContent</span><span class="params">(String message)</span> {</span><br><span class="line">        <span class="keyword">return</span> chatClient.prompt()</span><br><span class="line">                .user(message)</span><br><span class="line">                .stream()</span><br><span class="line">                .content();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>对于**<code>ChatController.java</code>**我们进行如下的改变</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellospringai.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.hellospringai.service.ChatService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/ai")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatService chatService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatController</span><span class="params">(ChatService chatService)</span> {</span><br><span class="line">        <span class="built_in">this</span>.chatService = chatService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义一个 GET 请求接口，以现代、响应式的方式流式输出 AI 回答</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 接收来自 URL 的查询参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 一个包含 AI 回答文本块的响应式数据流 (Flux)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(value = "/chat", produces = "text/html;charset=utf-8")</span> <span class="comment">// 这里必须指定编码，否则中文将无法正确编码</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">streamChat</span><span class="params">(<span class="meta">@RequestParam(value = "message", defaultValue = "你是谁？")</span> String message)</span> {</span><br><span class="line">        <span class="comment">// 通过 ChatService 处理流式聊天请求</span></span><br><span class="line">        <span class="keyword">return</span> chatService.getStreamContent(message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步聊天接口，一次性返回完整的 AI 回答</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 接收来自 URL 的查询参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> AI 生成的完整文本内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(value = "/chat-sync", produces = "text/html;charset=utf-8")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">syncChat</span><span class="params">(<span class="meta">@RequestParam(value = "message", defaultValue = "你是谁？")</span> String message)</span> {</span><br><span class="line">        <span class="comment">// 通过 ChatService 处理同步聊天请求</span></span><br><span class="line">        <span class="keyword">return</span> chatService.getSimpleResponse(message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 流式聊天接口，返回包含更多元数据的 ChatResponse 流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 接收来自 URL 的查询参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 一个包含 ChatResponse 对象的响应式数据流 (Flux)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(value = "/chat-response", produces = "application/json;charset=utf-8")</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;ChatResponse&gt; <span class="title function_">streamChatResponse</span><span class="params">(<span class="meta">@RequestParam(value = "message", defaultValue = "你是谁？")</span> String message)</span> {</span><br><span class="line">        <span class="comment">// 通过 ChatService 处理流式 ChatResponse 请求</span></span><br><span class="line">        <span class="keyword">return</span> chatService.getStreamResponse(message);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="3-1-3-小结：如何访问和测试API"><a href="#3-1-3-小结：如何访问和测试API" class="headerlink" title="3.1.3 小结：如何访问和测试API"></a>3.1.3 小结：如何访问和测试API</h4><p>现在我们已经定义好了 <code>ChatService</code> 业务类和 <code>ChatController</code> 控制器，一个功能完备的AI聊天后端服务就绪了。启动你的 <code>HelloSpringAiApplication</code> 主应用类，接下来，我将指导你如何通过常见的工具访问我们创建的三个API接口。</p><p>测试这些接口最便捷的工具是你的<strong>网页浏览器</strong>和命令行工具 <strong><code>curl</code></strong>。</p><p>下表总结了每个接口的访问方式和预期效果：</p><table><thead><tr><th align="left">接口功能</th><th align="left">访问 URL 示例</th><th align="left">推荐测试方法</th><th align="left">预期输出</th></tr></thead><tbody><tr><td align="left"><strong>流式返回纯文本</strong>&lt;br&gt;(打字机效果)</td><td align="left"><code>http://localhost:8080/ai/chat?message=你好世界</code></td><td align="left"><strong>浏览器</strong>或 <strong><code>curl -N</code></strong></td><td align="left">纯文本的流式输出，文字会像打字机一样逐个出现。</td></tr><tr><td align="left"><strong>同步返回完整文本</strong></td><td align="left"><code>http://localhost:8080/ai/chat-sync?message=你好世界</code></td><td align="left"><strong>浏览器</strong>或 <strong><code>curl</code></strong></td><td align="left">等待片刻后，浏览器页面上一次性显示完整的AI回复文本。</td></tr><tr><td align="left"><strong>流式返回JSON对象</strong></td><td align="left"><code>http://localhost:8080/ai/chat-response?message=你好世界</code></td><td align="left"><strong><code>curl -N</code></strong></td><td align="left">连续的JSON对象流。每个对象都是一个<code>ChatResponse</code>的内容。</td></tr></tbody></table><ol><li><p><strong>测试流式文本接口 (<code>/ai/chat</code>)</strong></p><ul><li><strong>浏览器</strong>：这是最直观的方式。直接在浏览器地址栏输入 <code>http://localhost:8080/ai/chat?message=请介绍一下长城</code> 并回车。你会看到浏览器的加载动画会持续旋转，同时页面上的文字会不断地动态增加，直到AI回答完毕。</li><li><strong>curl</strong>：在你的命令行终端中输入以下命令：<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -N <span class="string">"http://localhost:8080/ai/chat?message=请介绍一下长城"</span></span><br></pre></td></tr></tbody></table></figure><code>-N</code> 参数告诉 <code>curl</code> 不要使用缓冲，立刻将接收到的数据显示在终端上，你将看到文字逐行或逐块打印出来。</li></ul></li><li><p><strong>测试同步文本接口 (<code>/ai/chat-sync</code>)</strong></p><ul><li><strong>浏览器</strong>：在地址栏输入 <code>http://localhost:8080/ai/chat-sync?message=中国的首都是哪里</code>。页面会加载一小会儿，然后一次性显示出完整答案，例如“中国的首都是北京。”。</li><li><strong>curl</strong>：<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">"http://localhost:8080/ai/chat-sync?message=中国的首都是哪里"</span></span><br></pre></td></tr></tbody></table></figure>终端会等待几秒，然后直接打印出完整的回复。</li></ul></li><li><p><strong>测试流式JSON接口 (<code>/ai/chat-response</code>)</strong></p><ul><li><strong>浏览器</strong>：不推荐使用浏览器直接访问这个接口。由于返回的是 <code>application/json</code> 的事件流，大多数浏览器会尝试下载一个文件，或者无法正确地渲染持续到来的JSON对象。</li><li><strong>curl</strong>：这是观察其原始输出的最佳方式。<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -N <span class="string">"http://localhost:8080/ai/chat-response?message=你好"</span></span><br></pre></td></tr></tbody></table></figure>你会在终端看到一系列连续输出的JSON对象，每个对象之间可能有换行。每一个对象都是一个独立的 <code>ChatResponse</code> 序列化后的结果，格式可能如下所示：<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span><span class="attr">"generation"</span><span class="punctuation">:</span><span class="punctuation">{</span><span class="attr">"content"</span><span class="punctuation">:</span><span class="string">"你"</span><span class="punctuation">}</span><span class="punctuation">,</span><span class="attr">"metadata"</span><span class="punctuation">:</span><span class="punctuation">{</span><span class="attr">"finishReason"</span><span class="punctuation">:</span><span class="string">"STOP"</span><span class="punctuation">,</span><span class="attr">"usage"</span><span class="punctuation">:</span><span class="punctuation">{</span><span class="attr">"promptTokens"</span><span class="punctuation">:</span><span class="number">11</span><span class="punctuation">,</span><span class="attr">"completionTokens"</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">"totalTokens"</span><span class="punctuation">:</span><span class="number">12</span><span class="punctuation">}</span><span class="punctuation">}</span><span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">{</span><span class="attr">"generation"</span><span class="punctuation">:</span><span class="punctuation">{</span><span class="attr">"content"</span><span class="punctuation">:</span><span class="string">"好"</span><span class="punctuation">}</span><span class="punctuation">,</span><span class="attr">"metadata"</span><span class="punctuation">:</span><span class="punctuation">{</span><span class="attr">"finishReason"</span><span class="punctuation">:</span><span class="string">"STOP"</span><span class="punctuation">,</span><span class="attr">"usage"</span><span class="punctuation">:</span><span class="punctuation">{</span><span class="attr">"promptTokens"</span><span class="punctuation">:</span><span class="number">11</span><span class="punctuation">,</span><span class="attr">"completionTokens"</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">"totalTokens"</span><span class="punctuation">:</span><span class="number">13</span><span class="punctuation">}</span><span class="punctuation">}</span><span class="punctuation">}</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure></li></ul></li></ol><p>通过以上方法，你可以清晰地观察到同步与流式、返回纯文本与返回完整响应对象之间的差异。建议你亲自尝试，并使用浏览器的开发者工具（F12 -&gt; Network标签页）来观察不同请求的响应头（Headers）和响应体（Response），这会让你对HTTP协议和API设计有更深刻的理解。</p><hr><h3 id="3-2-调试与洞察：Advisor-与日志"><a href="#3-2-调试与洞察：Advisor-与日志" class="headerlink" title="3.2 调试与洞察：Advisor 与日志"></a><strong>3.2 调试与洞察：<code>Advisor</code> 与日志</strong></h3><p>到目前为止，我们已经构建了功能强大的 <code>ChatClient</code>。但当AI的回答不符合预期时，我们如何知道发送给模型的完整提示（Prompt）到底是什么样的？例如，我们通过 <code>.defaultSystem()</code> 配置的全局指令，是如何与我们当前的用户问题组合在一起的？</p><p>为了解决这个“黑盒”问题，Spring AI 提供了 **<code>Advisor</code>（顾问）**机制。</p><p><code>Advisor</code> 就像是安装在 <code>ChatClient</code> 请求/响应链路上的“拦截器”或“中间件”。它允许我们在请求发送给AI之前对其进行修改或审查，并在收到AI响应后进行处理。Spring AI 提供了一些非常有用的内置顾问，本节我们将学习其中用于调试的：<strong><code>SimpleLoggerAdvisor</code></strong>。</p><p><code>SimpleLoggerAdvisor</code> 是一个专门用于<strong>调试</strong>的工具。它的唯一职责就是将发送给大语言模型的<strong>最终请求（完整Prompt）<strong>和从模型那里收到的</strong>原始响应</strong>，以<code>DEBUG</code>或<code>TRACE</code>级别打印到控制台日志中。</p><p>这为我们提供了一个强大的“窥镜”，可以清晰地看到每一次交互的全部细节。</p><p><strong>1. 在项目中引入日志顾问</strong></p><p>要使用 <code>SimpleLoggerAdvisor</code>，我们需要完成两步配置。</p><p><strong>第一步：启用 DEBUG 日志</strong></p><p>我们需要告诉 Spring Boot 的日志系统，我们希望看到来自 <code>advisor</code> 的详细调试信息。</p><p>在 <code>application.yml</code> 文件中添加 <code>logging.level</code> 配置：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># src/main/resources/application.yml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">ai:</span></span><br><span class="line">    <span class="attr">openai:</span></span><br><span class="line">      <span class="attr">base-url:</span> <span class="string">https://api.deepseek.com</span></span><br><span class="line">      <span class="attr">api-key:</span> <span class="string">"sk-xxxx"</span></span><br><span class="line">      <span class="attr">chat:</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">model:</span> <span class="string">deepseek-chat</span></span><br><span class="line">          <span class="attr">temperature:</span> <span class="number">0.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增：配置日志级别</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="comment"># 将 advisor 包的日志级别设为 DEBUG，以激活 SimpleLoggerAdvisor 的输出</span></span><br><span class="line">    <span class="attr">org.springframework.ai.chat.client.advisor:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="comment"># 同时将我们自己应用的包也设为 DEBUG，方便观察</span></span><br><span class="line">    <span class="attr">com.example.hellospringai:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></tbody></table></figure><p><strong>第二步：在 <code>ChatClient</code> 中配置日志顾问</strong></p><p>接下来，我们修改 <code>CommonConfiguration.java</code>，在构建 <code>ChatClient</code> 时，将 <code>SimpleLoggerAdvisor</code> 作为默认顾问添加进去。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件路径: src/main/java/com/example/hellospringai/config/CommonConfiguration.java</span></span><br><span class="line"><span class="keyword">package</span> com.example.hellospringai.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonConfiguration</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient <span class="title function_">chatClient</span><span class="params">(ChatModel chatModel)</span> {</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(chatModel)</span><br><span class="line">                .defaultSystem(<span class="string">"你是一个由Prorise创作出来的AI大模型，名字叫做小P，请你在以后的回复中以新的身份和语气回复我"</span>)</span><br><span class="line">                <span class="comment">// 关键：将 SimpleLoggerAdvisor 添加为默认顾问</span></span><br><span class="line">                .defaultAdvisors(<span class="keyword">new</span> <span class="title class_">SimpleLoggerAdvisor</span>())</span><br><span class="line">                .build();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>2. 观察日志输出</strong></p><p>完成以上配置并重启应用后，调用任一聊天接口，例如访问 <code>http://localhost:8080/ai/chat?message=你好</code>。</p><p>现在，请观察您的IDE控制台，您会看到类似下面这样的详细 <code>DEBUG</code> 日志输出：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DEBUG --- [nio-8080-exec-1] o.s.a.c.c.a.SimpleLoggerAdvisor        : </span><br><span class="line">--- Request:</span><br><span class="line">[</span><br><span class="line">  {</span><br><span class="line">    "messageType": "SYSTEM",</span><br><span class="line">    "content": "你是一个由Prorise创作出来的AI大模型，名字叫做小P，请你在以后的回复中以新的身份和语气回复我"</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    "messageType": "USER",</span><br><span class="line">    "content": "你好"</span><br><span class="line">  }</span><br><span class="line">]</span><br><span class="line">--- Response:</span><br><span class="line">{</span><br><span class="line">  "messageType": "ASSISTANT",</span><br><span class="line">  "content": "你好！我是小P，很高兴能为您服务。有什么可以帮助您的吗？"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>日志解读：</strong></p><ul><li><strong><code>--- Request:</code></strong>: 这部分清晰地展示了最终发送给大语言模型的完整消息列表。我们可以清楚地看到，我们配置的 <code>defaultSystem</code> 系统提示和用户的 <code>你好</code> 被正确地组合在了一起。</li><li><strong><code>--- Response:</code></strong>: 这部分展示了AI模型返回的原始<code>Assistant</code>消息内容。</li></ul><p>通过 <code>SimpleLoggerAdvisor</code>，我们获得了对 <code>ChatClient</code> 内部通信的完全可见性，这在进行 Prompt Engineering（提示词工程）和问题排查时是不可或缺的利器。</p><hr><h3 id="3-3-前端环境搭建"><a href="#3-3-前端环境搭建" class="headerlink" title="3.3 前端环境搭建"></a>3.3 前端环境搭建</h3><p>本节将快速搭建一个基于 <strong>Vue 3 + Vite + Tailwind CSS + DaisyUI + Element Plus</strong> 的前端开发环境。</p><h4 id="3-3-1-初始化-Vue-3-项目"><a href="#3-3-1-初始化-Vue-3-项目" class="headerlink" title="3.3.1 初始化 Vue 3 项目"></a>3.3.1 初始化 Vue 3 项目</h4><p>首先，使用 Vite 和 pnpm 创建并初始化项目。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 使用 Vite 创建项目</span></span><br><span class="line">pnpm create vite spring-app --template vue</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 进入目录并安装基础依赖</span></span><br><span class="line"><span class="built_in">cd</span> spring-app</span><br><span class="line">pnpm install</span><br></pre></td></tr></tbody></table></figure><h4 id="3-3-2-集成-Tailwind-CSS"><a href="#3-3-2-集成-Tailwind-CSS" class="headerlink" title="3.3.2 集成 Tailwind CSS"></a>3.3.2 集成 Tailwind CSS</h4><p>接下来，为项目添加 Tailwind CSS 并完成基础配置。</p><p><strong>1. 安装依赖</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install -D tailwindcss@3.4.1 postcss autoprefixer</span><br></pre></td></tr></tbody></table></figure><p><strong>2. 生成配置文件</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx tailwindcss init -p</span><br></pre></td></tr></tbody></table></figure><p><strong>3. 更新配置与样式文件</strong></p><ul><li><strong><code>tailwind.config.js</code></strong>:<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@type</span> {<span class="type">import('tailwindcss').Config</span>} */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">content</span>: [</span><br><span class="line">    <span class="string">"./index.html"</span>,</span><br><span class="line">    <span class="string">"./src/**/*.{vue,js,ts,jsx,tsx}"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">theme</span>: {</span><br><span class="line">    <span class="attr">extend</span>: {},</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">plugins</span>: [],</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li><li><strong><code>src/assets/style/main.css</code></strong> (如果目录不存在请创建):<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@tailwind</span> base;</span><br><span class="line"><span class="keyword">@tailwind</span> components;</span><br><span class="line"><span class="keyword">@tailwind</span> utilities;</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="3-3-3-集成-UI-组件库-DaisyUI-Element-Plus"><a href="#3-3-3-集成-UI-组件库-DaisyUI-Element-Plus" class="headerlink" title="3.3.3 集成 UI 组件库 (DaisyUI &amp; Element Plus)"></a>3.3.3 集成 UI 组件库 (DaisyUI &amp; Element Plus)</h4><p><strong>1. 安装依赖</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 DaisyUI 作为开发依赖</span></span><br><span class="line">pnpm add -D daisyui</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Element Plus 作为生产依赖</span></span><br><span class="line">pnpm add element-plus</span><br></pre></td></tr></tbody></table></figure><p><strong>2. 在 <code>tailwind.config.js</code> 中启用 DaisyUI</strong></p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tailwind.config.js</span></span><br><span class="line"><span class="comment">/** <span class="doctag">@type</span> {<span class="type">import('tailwindcss').Config</span>} */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">content</span>: [</span><br><span class="line">    <span class="string">"./index.html"</span>,</span><br><span class="line">    <span class="string">"./src/**/*.{vue,js,ts,jsx,tsx}"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">theme</span>: {</span><br><span class="line">    <span class="attr">extend</span>: {},</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'daisyui'</span>), <span class="comment">// 添加 DaisyUI 插件</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// (可选) DaisyUI 主题等配置</span></span><br><span class="line">  <span class="attr">daisyui</span>: {</span><br><span class="line">    <span class="attr">themes</span>: [<span class="string">"light"</span>, <span class="string">"dark"</span>, <span class="string">"cupcake"</span>], <span class="comment">// 启用的主题列表，可按需选择</span></span><br><span class="line">    <span class="comment">// styled: true,         // DaisyUI 组件类是否默认应用 (默认为 true)</span></span><br><span class="line">    <span class="comment">// base: true,           // 是否应用 DaisyUI 基础样式 (默认为 true)</span></span><br><span class="line">    <span class="comment">// utils: true,          // 是否应用 DaisyUI 工具类 (默认为 true)</span></span><br><span class="line">    <span class="comment">// logs: true,           // 是否在控制台显示 DaisyUI 日志 (默认为 true)</span></span><br><span class="line">  },</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="3-3-4-主程序入口配置-main-js"><a href="#3-3-4-主程序入口配置-main-js" class="headerlink" title="3.3.4 主程序入口配置 (main.js)"></a>3.3.4 主程序入口配置 (<code>main.js</code>)</h4><p>这是非常关键的一步。我们将更新 <code>src/main.js</code> 文件，它会<strong>同时引入 Tailwind CSS 的基础样式</strong>并<strong>全局注册 Element Plus 插件</strong>，确保所有功能都准备就绪。</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"><span class="keyword">import</span> { createApp } <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./assets/style/main.css'</span> <span class="comment">// 引入 tailwindcss 样式</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ElementPlus</span> <span class="keyword">from</span> <span class="string">'element-plus'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'element-plus/dist/index.css'</span> <span class="comment">// 引入 Element Plus 的 CSS</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title class_">ElementPlus</span>) <span class="comment">// 注册 Element Plus 插件</span></span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">'#app'</span>)</span><br></pre></td></tr></tbody></table></figure><h3 id="3-4-阶段小实战：构建企业级AI对话界面"><a href="#3-4-阶段小实战：构建企业级AI对话界面" class="headerlink" title="3.4 阶段小实战：构建企业级AI对话界面"></a>3.4 阶段小实战：构建企业级AI对话界面</h3><p>在 <code>3.3</code> 的基础上，本节将通过安装专业级组件库、创建标准化的目录结构，并填充模块化的核心代码，一步步完整实现一个功能强大、结构清晰的聊天机器人前端应用，我们保持后端的代码简洁，如下</p><p><strong><code>ChatController.java</code></strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellospringai.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.hellospringai.service.ChatService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/ai")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatService chatService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatController</span><span class="params">(ChatService chatService)</span> {</span><br><span class="line">        <span class="built_in">this</span>.chatService = chatService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义一个 GET 请求接口，以现代、响应式的方式流式输出 AI 回答</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 接收来自 URL 的查询参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 一个包含 AI 回答文本块的响应式数据流 (Flux)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(value = "/chat", produces = "text/event-stream;charset=utf-8")</span> <span class="comment">// 修改为流式响应格式</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">streamChat</span><span class="params">(<span class="meta">@RequestParam(value = "message", defaultValue = "你是谁？")</span> String message)</span> {</span><br><span class="line">        <span class="comment">// 通过 ChatService 处理流式聊天请求</span></span><br><span class="line">        <span class="keyword">return</span> chatService.getStreamContent(message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong><code>ChatService.java</code></strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellospringai.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatClient chatClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatService</span><span class="params">(ChatClient chatClient)</span> {</span><br><span class="line">        <span class="built_in">this</span>.chatClient = chatClient;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 流式内容调用：返回纯文本内容的响应流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 用户的提问</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 一个包含文本内容片段的 Flux 流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">getStreamContent</span><span class="params">(String message)</span> {</span><br><span class="line">        <span class="keyword">return</span> chatClient.prompt()</span><br><span class="line">                .user(message)</span><br><span class="line">                .stream()</span><br><span class="line">                .content();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="3-4-1-核心依赖补全"><a href="#3-4-1-核心依赖补全" class="headerlink" title="3.4.1 核心依赖补全"></a>3.4.1 核心依赖补全</h4><p><code>3.2</code> 节中我们安装了基础UI库，现在我们需要补全应用逻辑所必需的核心库，包括状态管理、路由、工具函数以及本次实战的主角——专业的AI对话组件库。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 Pinia (状态管理), Axios (网络请求)</span></span><br><span class="line">pnpm install pinia axios</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Vue Router 和 VueUse (组合式函数工具库)</span></span><br><span class="line">pnpm add vue-router @vueuse/core</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 vue-element-plus-x (提供高级AI对话组件)</span></span><br><span class="line">pnpm install vue-element-plus-x</span><br></pre></td></tr></tbody></table></figure><h4 id="3-3-2-项目目录结构创建"><a href="#3-3-2-项目目录结构创建" class="headerlink" title="3.3.2 项目目录结构创建"></a>3.3.2 项目目录结构创建</h4><p>一个良好、清晰的目录结构是大型项目的基石。在 <code>src</code> 目录下，执行以下命令创建我们规划好的所有子目录。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 src 目录下一次性创建所有规划好的文件夹</span></span><br><span class="line"><span class="built_in">mkdir</span> src/api, src/assets/style, src/components/common, src/composables, src/router, src/stores, src/utils, src/views</span><br></pre></td></tr></tbody></table></figure><p>执行后，你的 <code>src</code> 目录结构应如下所示：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">├── api/</span><br><span class="line">├── assets/</span><br><span class="line">│   └── style/</span><br><span class="line">├── components/</span><br><span class="line">│   └── common/</span><br><span class="line">├── composables/</span><br><span class="line">├── router/</span><br><span class="line">├── stores/</span><br><span class="line">├── utils/</span><br><span class="line">└── views/</span><br></pre></td></tr></tbody></table></figure><h4 id="3-4-3-核心代码实现"><a href="#3-4-3-核心代码实现" class="headerlink" title="3.4.3 核心代码实现"></a>3.4.3 核心代码实现</h4><p>现在，我们按照从底层数据、逻辑到上层视图的顺序，依次填充每个文件。</p><h5 id="0-处理API请求（Axios）"><a href="#0-处理API请求（Axios）" class="headerlink" title="0.处理API请求（Axios）"></a>0.处理API请求（Axios）</h5><p><strong><code>/utils/request.js</code></strong></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> service = axios.<span class="title function_">create</span>({</span><br><span class="line">  <span class="attr">baseURL</span>: <span class="string">'http://localhost:8080'</span>, </span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">30000</span>,</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> service;</span><br></pre></td></tr></tbody></table></figure><p><strong><code>/api/chat.js</code></strong></p><p>核心API接口</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'../utils/request'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 以流式方式获取AI回答</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">string</span>} <span class="variable">message</span> - 用户消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">Promise&lt;Response&gt;</span>} 返回一个支持流式读取的 Response 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">streamChat</span>(<span class="params">message</span>) {</span><br><span class="line">  <span class="comment">// 使用封装好的 axios 发送请求，通过 fetch 处理流式响应</span></span><br><span class="line">  <span class="comment">// 保持项目中请求方式的统一性</span></span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">`<span class="subst">${request.defaults.baseURL}</span>/ai/chat?message=<span class="subst">${<span class="built_in">encodeURIComponent</span>(message)}</span>`</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(url, {</span><br><span class="line">    <span class="attr">method</span>: <span class="string">'GET'</span>,</span><br><span class="line">    <span class="attr">headers</span>: {</span><br><span class="line">      <span class="string">'Accept'</span>: <span class="string">'text/event-stream'</span>,</span><br><span class="line">      <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span></span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="1-状态管理层-Pinia"><a href="#1-状态管理层-Pinia" class="headerlink" title="1. 状态管理层 (Pinia)"></a><strong>1. 状态管理层 (Pinia)</strong></h5><p><code>src/stores/conversationStore.js</code> 文件负责以UI组件库（<code>vue-element-plus-x</code>）所需的标准格式来存储和管理对话数据。</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这是一个使用 Pinia 状态管理库创建的对话存储模块</span></span><br><span class="line"><span class="keyword">import</span> { defineStore } <span class="keyword">from</span> <span class="string">'pinia'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出一个名为 'conversation' 的状态存储，用于管理聊天对话的状态</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useConversationStore = <span class="title function_">defineStore</span>(<span class="string">'conversation'</span>, {</span><br><span class="line">  <span class="comment">// 定义存储的状态数据</span></span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> ({</span><br><span class="line">    <span class="attr">messages</span>: [],       <span class="comment">// 存储BubbleList格式的消息数组</span></span><br><span class="line">    <span class="attr">nextMessageId</span>: <span class="number">0</span>,   <span class="comment">// 消息ID计数器</span></span><br><span class="line">  }),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义可以修改状态的操作方法</span></span><br><span class="line">  <span class="attr">actions</span>: {</span><br><span class="line">    <span class="comment">// 添加一条新消息到对话历史中</span></span><br><span class="line">    <span class="title function_">addMessage</span>(<span class="params">{ role, content = <span class="string">''</span> }</span>) {</span><br><span class="line">      <span class="keyword">const</span> messageRole = role === <span class="string">'user'</span> ? <span class="string">'user'</span> : <span class="string">'ai'</span>;</span><br><span class="line">      <span class="keyword">const</span> placement = messageRole === <span class="string">'ai'</span> ? <span class="string">'start'</span> : <span class="string">'end'</span>;</span><br><span class="line">      <span class="keyword">const</span> variant = messageRole === <span class="string">'ai'</span> ? <span class="string">'filled'</span> : <span class="string">'outlined'</span>;</span><br><span class="line">      <span class="keyword">const</span> avatar = messageRole === <span class="string">'ai'</span></span><br><span class="line">        ? <span class="string">'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png'</span></span><br><span class="line">        : <span class="string">'https://avatars.githubusercontent.com/u/76239030?v=4'</span>;</span><br><span class="line">      <span class="comment">// 创建符合 BubbleList 组件要求的消息对象</span></span><br><span class="line">      <span class="keyword">const</span> bubbleMessage = {</span><br><span class="line">        <span class="attr">key</span>: <span class="variable language_">this</span>.<span class="property">nextMessageId</span>++,         <span class="comment">// 唯一标识</span></span><br><span class="line">        <span class="attr">role</span>: messageRole,                 <span class="comment">// user | ai 角色定义</span></span><br><span class="line">        placement,                         <span class="comment">// start | end 气泡位置</span></span><br><span class="line">        content,                          <span class="comment">// 消息内容，流式接收时只需要改这个值即可</span></span><br><span class="line">        <span class="attr">loading</span>: <span class="literal">false</span>,                   <span class="comment">// 当前气泡的加载状态</span></span><br><span class="line">        <span class="attr">shape</span>: <span class="string">'corner'</span>,                  <span class="comment">// 气泡的形状</span></span><br><span class="line">        variant,                          <span class="comment">// 气泡的样式</span></span><br><span class="line">        <span class="attr">isMarkdown</span>: <span class="literal">true</span>,                 <span class="comment">// 是否渲染为 markdown</span></span><br><span class="line">        <span class="attr">typing</span>: <span class="literal">false</span>,                    <span class="comment">// 是否开启打字器效果，该属性不会和流式接收冲突</span></span><br><span class="line">        <span class="attr">isFog</span>: messageRole === <span class="string">'ai'</span>,      <span class="comment">// 是否开启打字雾化效果，该效果 v1.1.6 新增，且在 typing 为 true 时生效，该效果会覆盖 typing 的 suffix 属性</span></span><br><span class="line">        avatar,                           <span class="comment">// 头像</span></span><br><span class="line">        <span class="attr">avatarSize</span>: <span class="string">'36px'</span>,               <span class="comment">// 头像占位大小</span></span><br><span class="line">        <span class="attr">avatarGap</span>: <span class="string">'12px'</span>,                <span class="comment">// 头像与气泡之间的距离</span></span><br><span class="line">      };</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">messages</span>.<span class="title function_">push</span>(bubbleMessage);</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向最后一条消息追加内容（用于流式接收AI回复）</span></span><br><span class="line">    <span class="title function_">appendToLastMessage</span>(<span class="params">contentChunk</span>) {</span><br><span class="line">      <span class="comment">// 如果没有消息则直接返回</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">messages</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取最后一条消息</span></span><br><span class="line">      <span class="keyword">const</span> lastMessage = <span class="variable language_">this</span>.<span class="property">messages</span>[<span class="variable language_">this</span>.<span class="property">messages</span>.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 只有当最后一条消息是AI助手的回复时才追加内容</span></span><br><span class="line">      <span class="keyword">if</span> (lastMessage.<span class="property">role</span> === <span class="string">'ai'</span>) {</span><br><span class="line">        lastMessage.<span class="property">content</span> += contentChunk;</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清空对话历史</span></span><br><span class="line">    <span class="title function_">clearHistory</span>(<span class="params"></span>) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">messages</span> = [];</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h5 id="2-可组合函数-Composables"><a href="#2-可组合函数-Composables" class="headerlink" title="2. 可组合函数 (Composables)"></a><strong>2. 可组合函数 (Composables)</strong></h5><p>我们将不同的逻辑关注点分离到独立的 <code>composable</code> 函数中，以实现最大程度的复用和解耦。</p><ul><li><p><strong><code>src/composables/useChat.js</code></strong> (聊天核心逻辑)</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">import</span> { ref, watch, computed } <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line">    <span class="keyword">import</span> { useConversationStore } <span class="keyword">from</span> <span class="string">'../stores/conversationStore'</span>;</span><br><span class="line">    <span class="keyword">import</span> { storeToRefs } <span class="keyword">from</span> <span class="string">'pinia'</span>;</span><br><span class="line">    <span class="keyword">import</span> { streamChat } <span class="keyword">from</span> <span class="string">'../api/chat'</span>;</span><br><span class="line"><span class="keyword">import</span> { useXStream } <span class="keyword">from</span> <span class="string">'vue-element-plus-x'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 聊天核心逻辑 composable</span></span><br><span class="line"><span class="comment">     * 处理消息发送、流式接收、状态管理等</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useChat</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="comment">// 状态管理</span></span><br><span class="line">        <span class="keyword">const</span> store = <span class="title function_">useConversationStore</span>();</span><br><span class="line">        <span class="keyword">const</span> { messages } = <span class="title function_">storeToRefs</span>(store);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 会话ID和输入消息</span></span><br><span class="line">        <span class="keyword">const</span> sessionId = <span class="title function_">ref</span>(<span class="string">`session_<span class="subst">${<span class="built_in">Date</span>.now()}</span>`</span>);</span><br><span class="line">        <span class="keyword">const</span> inputMessage = <span class="title function_">ref</span>(<span class="string">''</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 使用 useXStream 处理流式数据</span></span><br><span class="line">        <span class="keyword">const</span> { startStream, cancel, isLoading, data, error } = <span class="title function_">useXStream</span>();</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 计算属性处理累积的流式数据</span></span><br><span class="line">        <span class="keyword">const</span> streamContent = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="keyword">if</span> (!data.<span class="property">value</span>.<span class="property">length</span>) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">let</span> text = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; data.<span class="property">value</span>.<span class="property">length</span>; index++) {</span><br><span class="line">                <span class="keyword">const</span> chunk = data.<span class="property">value</span>[index];</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="comment">// 检查chunk是否是对象且包含data属性</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">typeof</span> chunk === <span class="string">'object'</span> &amp;&amp; chunk !== <span class="literal">null</span> &amp;&amp; <span class="string">'data'</span> <span class="keyword">in</span> chunk) {</span><br><span class="line">                        <span class="comment">// 只有当data不为空时才添加</span></span><br><span class="line">                        <span class="keyword">if</span> (chunk.<span class="property">data</span>) {</span><br><span class="line">                            text += chunk.<span class="property">data</span>;</span><br><span class="line">                        }</span><br><span class="line">                        <span class="comment">// 空data的chunk直接跳过，不打印警告</span></span><br><span class="line">                    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> chunk === <span class="string">'string'</span>) {</span><br><span class="line">                        text += chunk;</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">'未知的chunk格式:'</span>, chunk);</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (error) {</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'解析流数据时出错:'</span>, error);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> text;</span><br><span class="line">        });</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 监听流式数据更新，实时追加到消息中</span></span><br><span class="line">        <span class="title function_">watch</span>(streamContent, <span class="function">(<span class="params">newContent, oldContent</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">if</span> (newContent &amp;&amp; newContent !== oldContent) {</span><br><span class="line">                <span class="comment">// 获取新增的内容部分</span></span><br><span class="line">                <span class="keyword">const</span> newChunk = newContent.<span class="title function_">slice</span>(oldContent?.<span class="property">length</span> || <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (newChunk) {</span><br><span class="line">                    store.<span class="title function_">appendToLastMessage</span>(newChunk);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 监听错误信息</span></span><br><span class="line">        <span class="title function_">watch</span>(error, <span class="function">(<span class="params">errorInfo</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">if</span> (errorInfo) {</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"流式请求失败:"</span>, errorInfo);</span><br><span class="line">                store.<span class="title function_">appendToLastMessage</span>(<span class="string">"\n\n抱歉，处理您的请求时遇到了问题。"</span>);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 处理用户提交消息</span></span><br><span class="line"><span class="comment">         * 使用 useXStream 处理流式接收</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">handleUserSubmit</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; {</span><br><span class="line">            <span class="keyword">const</span> messageContent = inputMessage.<span class="property">value</span>.<span class="title function_">trim</span>();</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 验证输入</span></span><br><span class="line">            <span class="keyword">if</span> (!messageContent || isLoading.<span class="property">value</span>) {</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 1. 添加用户消息到对话历史</span></span><br><span class="line">                store.<span class="title function_">addMessage</span>({</span><br><span class="line">                    <span class="attr">role</span>: <span class="string">'user'</span>,</span><br><span class="line">                    <span class="attr">content</span>: messageContent</span><br><span class="line">                });</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 2. 清空输入框</span></span><br><span class="line">                inputMessage.<span class="property">value</span> = <span class="string">''</span>;</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 3. 创建AI回复占位</span></span><br><span class="line">                store.<span class="title function_">addMessage</span>({</span><br><span class="line">                    <span class="attr">role</span>: <span class="string">'assistant'</span>,</span><br><span class="line">                    <span class="attr">content</span>: <span class="string">''</span></span><br><span class="line">                });</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 4. 获取流式响应</span></span><br><span class="line">                <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">streamChat</span>(messageContent);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 5. 使用 useXStream 处理流式数据</span></span><br><span class="line">                <span class="keyword">await</span> <span class="title function_">startStream</span>({</span><br><span class="line">                    <span class="attr">readableStream</span>: response.<span class="property">body</span></span><br><span class="line">                });</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">            } <span class="keyword">catch</span> (err) {</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"发起流式请求失败:"</span>, err);</span><br><span class="line">                store.<span class="title function_">appendToLastMessage</span>(<span class="string">"\n\n抱歉，发起请求时遇到了问题。"</span>);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 清空对话历史</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">clearHistory</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">            store.<span class="title function_">clearHistory</span>();</span><br><span class="line">        };</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 重新生成会话ID</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">regenerateSessionId</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">            sessionId.<span class="property">value</span> = <span class="string">`session_<span class="subst">${<span class="built_in">Date</span>.now()}</span>`</span>;</span><br><span class="line">        };</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> {</span><br><span class="line">            <span class="comment">// 状态</span></span><br><span class="line">            messages,</span><br><span class="line">            <span class="attr">isGenerating</span>: isLoading, <span class="comment">// 使用 useXStream 的 isLoading 状态</span></span><br><span class="line">            inputMessage,</span><br><span class="line">            sessionId,</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 方法</span></span><br><span class="line">            handleUserSubmit,</span><br><span class="line">            clearHistory,</span><br><span class="line">            regenerateSessionId,</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 流式处理相关</span></span><br><span class="line">            cancel <span class="comment">// 暴露取消功能</span></span><br><span class="line">        };</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></li><li><p><strong><code>src/composables/useMessageFormatter.js</code></strong> (消息动态状态处理)</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { computed } <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息格式化 composable</span></span><br><span class="line"><span class="comment"> * 现在消息已经按 BubbleList 格式存储，只需要处理动态状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useMessageFormatter</span>(<span class="params">messages, isGenerating</span>) {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加动态状态到消息列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> formattedMessages = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="keyword">return</span> messages.<span class="property">value</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">message, index</span>) =&gt;</span> ({</span><br><span class="line">        ...message,</span><br><span class="line">            <span class="comment">// 只有最后一条AI消息在生成时显示打字效果</span></span><br><span class="line">            <span class="attr">typing</span>: message.<span class="property">role</span> === <span class="string">'ai'</span> &amp;&amp;</span><br><span class="line">                index === messages.<span class="property">value</span>.<span class="property">length</span> - <span class="number">1</span> &amp;&amp;</span><br><span class="line">                isGenerating.<span class="property">value</span></span><br><span class="line">        }));</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        formattedMessages</span><br><span class="line">    };</span><br><span class="line">} </span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="3-视图层-ChatView-vue"><a href="#3-视图层-ChatView-vue" class="headerlink" title="3. 视图层 (ChatView.vue)"></a><strong>3. 视图层 (<code>ChatView.vue</code>)</strong></h5><p>现在，我们的视图层变得极其简洁，它只负责组合 <code>composable</code> 的能力和 <code>vue-element-plus-x</code> 的UI组件。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="h-screen w-screen flex"&gt;</span><br><span class="line">    &lt;!-- 左侧会话管理 --&gt;</span><br><span class="line">    &lt;div class="w-64 border-r bg-gray-50 flex flex-col"&gt;</span><br><span class="line">      &lt;div class="p-4 border-b bg-gray-100"&gt;</span><br><span class="line">        &lt;h3 class="font-bold text-lg"&gt;会话管理&lt;/h3&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class="flex-1 overflow-auto"&gt;</span><br><span class="line">        &lt;Conversations v-model:active="activeConversationKey" :items="conversationItems" :label-max-width="200"</span><br><span class="line">          :show-tooltip="true" row-key="id" @change="handleConversationChange" /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 右侧聊天区域 --&gt;</span><br><span class="line">    &lt;div class="flex-1 flex flex-col"&gt;</span><br><span class="line">      &lt;!-- 聊天标题 --&gt;</span><br><span class="line">      &lt;div class="p-4 bg-blue-500 text-white text-xl font-bold"&gt;</span><br><span class="line">        Spring AI 全栈聊天机器人</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- 聊天内容区 --&gt;</span><br><span class="line">      &lt;div class="flex-1 flex flex-col"&gt;</span><br><span class="line">        &lt;!-- 消息列表 --&gt;</span><br><span class="line">        &lt;div class="flex-1 overflow-auto"&gt;</span><br><span class="line">          &lt;BubbleList :list="formattedMessages" /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 发送器 --&gt;</span><br><span class="line">        &lt;div class="border-t"&gt;</span><br><span class="line">          &lt;Sender v-model="inputMessage" :loading="isGenerating" :submitBtnDisabled="isGenerating"</span><br><span class="line">            placeholder="请输入您的问题..." :clearable="true" submitType="enter" @submit="handleUserSubmit" /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import { ref } from 'vue';</span><br><span class="line">import { BubbleList, Sender, Conversations } from 'vue-element-plus-x';</span><br><span class="line">import { ElMessage } from 'element-plus';</span><br><span class="line">import { useChat } from '../composables/useChat';</span><br><span class="line">import { useMessageFormatter } from '../composables/useMessageFormatter';</span><br><span class="line"></span><br><span class="line">// --- Composables ---</span><br><span class="line">const {</span><br><span class="line">  messages,</span><br><span class="line">  isGenerating,</span><br><span class="line">  inputMessage,</span><br><span class="line">  handleUserSubmit</span><br><span class="line">} = useChat();</span><br><span class="line"></span><br><span class="line">const { formattedMessages } = useMessageFormatter(messages, isGenerating);</span><br><span class="line"></span><br><span class="line">// --- 会话管理相关 ---</span><br><span class="line">const conversationItems = ref([</span><br><span class="line">  {</span><br><span class="line">    id: '1',</span><br><span class="line">    label: '第一个会话',</span><br><span class="line">    group: 'today',</span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    id: '2',</span><br><span class="line">    label: '第二个会话',</span><br><span class="line">    group: 'today',</span><br><span class="line">  },</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">const activeConversationKey = ref('1');</span><br><span class="line"></span><br><span class="line">function handleConversationChange(item) {</span><br><span class="line">  ElMessage.success(`选中了: ${item.label}`);</span><br><span class="line">}</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">/* 确保组件铺满全屏 */</span><br><span class="line">html,</span><br><span class="line">body,</span><br><span class="line">#app {</span><br><span class="line">  height: 100%;</span><br><span class="line">  width: 100%;</span><br><span class="line">  margin: 0;</span><br><span class="line">  padding: 0;</span><br><span class="line">  overflow: hidden;</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><h5 id="4-主程序入口-src-main-js"><a href="#4-主程序入口-src-main-js" class="headerlink" title="4. 主程序入口 (src/main.js)"></a><strong>4. 主程序入口 (<code>src/main.js</code>)</strong></h5><p>最后，确保 <code>main.js</code> 正确初始化并注册了所有模块。</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"><span class="keyword">import</span> { createApp } <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./assets/style/main.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ElementPlus</span> <span class="keyword">from</span> <span class="string">'element-plus'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'element-plus/dist/index.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ElementPlusX</span> <span class="keyword">from</span> <span class="string">'element-plus-x'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'element-plus-x/dist/index.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> { createPinia } <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line"><span class="keyword">const</span> pinia = <span class="title function_">createPinia</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(pinia)</span><br><span class="line">app.<span class="title function_">use</span>(router)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title class_">ElementPlus</span>)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title class_">ElementPlusX</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">'#app'</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="5-后端配置跨域请求"><a href="#5-后端配置跨域请求" class="headerlink" title="5.后端配置跨域请求"></a>5.后端配置跨域请求</h5><p><strong><code>com.example.hellospringai.config.MvcConfiguration</code></strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellospringai.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.CorsRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfiguration</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> {</span><br><span class="line">        registry.addMapping(<span class="string">"/**"</span>)</span><br><span class="line">                .allowedOrigins(<span class="string">"*"</span>)</span><br><span class="line">                .allowedMethods(<span class="string">"GET"</span>, <span class="string">"POST"</span>, <span class="string">"PUT"</span>, <span class="string">"DELETE"</span>, <span class="string">"OPTIONS"</span>)</span><br><span class="line">                .allowedHeaders(<span class="string">"*"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>现在我们启动前端服务器，并在输入框上与AI大模型对话，就能看到大模型给我们的所有响应格式！</p><hr><h3 id="3-5-对话记忆-Chat-Memory-：让-AI-拥有上下文-查阅"><a href="#3-5-对话记忆-Chat-Memory-：让-AI-拥有上下文-查阅" class="headerlink" title="3.5 对话记忆 (Chat Memory)：让 AI 拥有上下文 (查阅)"></a>3.5 对话记忆 (Chat Memory)：让 AI 拥有上下文 (查阅)</h3><p>大型语言模型（LLM）天生是<strong>无状态的</strong>，它们不会保留任何关于先前交互的记忆。这意味着每一次API调用都是一次全新的、独立的对话。如果我们希望构建一个能够进行多轮对话、理解上下文的智能应用，就必须引入“记忆”机制。</p><p>Spring AI 提供的 <code>ChatMemory</code> 功能，正是为了解决这个问题而生，它允许我们在与LLM的多次交互中，有效地存储和检索对话上下文。</p><h4 id="3-5-1-核心概念：策略与存储的分离"><a href="#3-5-1-核心概念：策略与存储的分离" class="headerlink" title="3.5.1 核心概念：策略与存储的分离"></a>3.5.1 核心概念：策略与存储的分离</h4><p>在深入研究之前，我们必须清晰地理解 Spring AI 在记忆功能上的核心设计思想：<strong>将记忆的策略（如何记住）与记忆的存储（记在哪里）相分离</strong>。</p><p>这一思想通过两个核心接口得以实现：</p><ol><li><strong><code>ChatMemory</code> (策略)</strong>: 定义了记忆的<strong>策略和行为</strong>。它决定了应该保留哪些消息、何时删除旧消息。例如，“只保留最近10条消息”就是一个策略。</li><li><strong><code>ChatMemoryRepository</code> (存储)</strong>: 定义了记忆的<strong>存储和检索</strong>。它的唯一职责是在后端（如内存、数据库、Redis）存取消息数据。</li></ol><p>我们可以这样理解：<code>ChatMemoryRepository</code> 是一个“<strong>仓库</strong>”，而 <code>ChatMemory</code> 则是高效率的“<strong>仓库管理员</strong>”。管理员根据自己的一套规则（策略）来管理仓库中的货物（消息）。</p><p>同时，我们必须辨别另一个重要概念：</p><table><thead><tr><th align="left">术语 (Term)</th><th align="left">定义</th><th align="left">在 Spring AI 中的作用</th></tr></thead><tbody><tr><td align="left"><strong>聊天记忆 (Chat Memory)</strong></td><td align="left">为了让AI理解下文而提供的一个<strong>相关的、有限的</strong>对话历史子集。</td><td align="left"><strong>用于构建 Prompt</strong>。<code>ChatMemory</code> 抽象负责管理这个“短期记忆”，决定哪些历史消息应该被包含在下一次发给AI的请求中。</td></tr><tr><td align="left"><strong>聊天记录 (Chat History)</strong></td><td align="left">一段会话中<strong>全部、完整的</strong>消息交换历史。</td><td align="left"><strong>用于审计或长期存储</strong>。Spring AI 的 <code>ChatMemory</code> <strong>不负责</strong>存储完整的聊天记录。如需此功能，应使用 Spring Data 等持久化方案自行实现。</td></tr></tbody></table><h4 id="3-5-2-记忆策略：MessageWindowChatMemory"><a href="#3-5-2-记忆策略：MessageWindowChatMemory" class="headerlink" title="3.5.2 记忆策略：MessageWindowChatMemory"></a>3.5.2 记忆策略：<code>MessageWindowChatMemory</code></h4><p>Spring AI 默认并最常用的记忆策略是 <code>MessageWindowChatMemory</code>，即<strong>消息窗口记忆</strong>。</p><ul><li><strong>工作原理</strong>：它像一个“滑动窗口”，始终只保留最近的 N 条消息。当新的消息进入时，最老的消息就会被挤出窗口（系统消息 <code>SystemMessage</code> 通常会被特殊保留，不受窗口大小影响）。</li><li><strong>核心优势</strong>：这是在实际应用中<strong>性价比最高</strong>的策略。它能有效防止上下文无限增长，从而避免超出模型 Token 限制而报错，同时也能节省大量的 Token 费用。</li></ul><h4 id="3-5-3-记忆存储：从内存到持久化-ChatMemoryRepository-查阅"><a href="#3-5-3-记忆存储：从内存到持久化-ChatMemoryRepository-查阅" class="headerlink" title="3.5.3 记忆存储：从内存到持久化 (ChatMemoryRepository) (查阅)"></a>3.5.3 记忆存储：从内存到持久化 (<code>ChatMemoryRepository</code>) (查阅)</h4><p><code>ChatMemoryRepository</code> 是一个负责物理存储和检索消息的抽象接口。Spring AI 提供了多种内置实现，让我们可以轻松地将对话记忆从易失的内存，切换到可靠的持久化数据库中。</p><h5 id="1-内存存储库-InMemoryChatMemoryRepository"><a href="#1-内存存储库-InMemoryChatMemoryRepository" class="headerlink" title="1. 内存存储库 (InMemoryChatMemoryRepository)"></a>1. 内存存储库 (<code>InMemoryChatMemoryRepository</code>)</h5><p>这是最基础、最简单的实现，它使用 Java 内置的 <code>ConcurrentHashMap</code> 来存储消息。</p><ul><li><strong>特点</strong>：无需任何额外配置和依赖，开箱即用。非常适合快速原型开发和测试。</li><li><strong>缺点</strong>：数据随应用程序的重启而丢失，不适用于生产环境。</li><li><strong>自动配置</strong>：默认情况下，如果项目中没有配置其他任何 <code>ChatMemoryRepository</code> 的 Bean，Spring AI 会自动配置一个 <code>InMemoryChatMemoryRepository</code> 实例。</li></ul><h5 id="2-JDBC-存储库-JdbcChatMemoryRepository"><a href="#2-JDBC-存储库-JdbcChatMemoryRepository" class="headerlink" title="2. JDBC 存储库 (JdbcChatMemoryRepository)"></a>2. JDBC 存储库 (<code>JdbcChatMemoryRepository</code>)</h5><p>这是一个通用的实现，用于将聊天消息存储在任何支持 JDBC 的关系型数据库中（如 MySQL, PostgreSQL, H2 等），是<strong>生产环境的首选</strong>。</p><ul><li><p><strong>引入依赖</strong>：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-jdbc-store-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>配置属性 (<code>application.yml</code>)</strong>:</p><table><thead><tr><th align="left">属性</th><th align="left">描述</th><th align="left">默认值</th></tr></thead><tbody><tr><td align="left"><code>spring.ai.chat.memory.repository.jdbc.initialize-schema</code></td><td align="left">控制何时初始化数据库表结构。可选值: <code>embedded</code>, <code>always</code>, <code>never</code>。</td><td align="left"><code>embedded</code></td></tr><tr><td align="left"><code>spring.ai.chat.memory.repository.jdbc.schema</code></td><td align="left">用于初始化表结构的 SQL 脚本位置。<code>@@platform@@</code> 会被自动替换。</td><td align="left"><code>classpath:org/.../schema-@@platform@@.sql</code></td></tr><tr><td align="left"><code>spring.ai.chat.memory.repository.jdbc.platform</code></td><td align="left">手动指定数据库平台（如 <code>mysql</code>, <code>postgresql</code>）。</td><td align="left">(自动检测)</td></tr></tbody></table></li><li><p><strong>Schema 初始化最佳实践</strong>:</p><ul><li><strong>开发时</strong>：可以设置为 <code>always</code>，让 Spring AI 自动创建表，非常方便。</li><li><strong>生产时</strong>：<strong>强烈推荐</strong>设置为 <code>never</code>。在生产环境中，数据库的表结构（Schema）应该由专业的数据库迁移工具（如 Flyway 或 Liquibase）来管理，或者由 DBA 手动执行脚本创建，以确保版本控制和安全性。</li></ul></li><li><p><strong>MySQL 表结构定义</strong>:<br>如果选择手动创建，以下是 <code>JdbcChatMemoryRepository</code> 所需的表结构。</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> `spring_ai_chat_memory` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `conversation_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">NOT NULL</span>,</span><br><span class="line">  `content` text <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">NOT NULL</span>,</span><br><span class="line">  `type` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">NOT NULL</span>, <span class="comment">-- 存储消息类型，如 USER, ASSISTANT</span></span><br><span class="line">  `<span class="type">timestamp</span>` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `media` json <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, <span class="comment">-- 为未来的多模态消息预留</span></span><br><span class="line">  `metadata` json <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, <span class="comment">-- 存储额外信息</span></span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`id`),</span><br><span class="line">  KEY `idx_conversation_id` (`conversation_id`),</span><br><span class="line">  KEY `idx_conversation_timestamp` (`conversation_id`,`<span class="type">timestamp</span>`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_unicode_ci;</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="3-5-4-集成与配置：将记忆注入-ChatClient-查阅"><a href="#3-5-4-集成与配置：将记忆注入-ChatClient-查阅" class="headerlink" title="3.5.4 集成与配置：将记忆注入 ChatClient (查阅)"></a>3.5.4 集成与配置：将记忆注入 <code>ChatClient</code> (查阅)</h4><p>我们已经有了“策略”和“仓库”，现在需要将它们组装起来，并让 <code>ChatClient</code> 使用它们。最佳实践是使用 <strong><code>Advisor</code> (顾问)</strong> 将记忆功能自动织入到 <code>ChatClient</code> 的调用流程中。</p><table><thead><tr><th align="left">记忆顾问 (Advisor)</th><th align="left">工作原理</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left"><strong><code>MessageChatMemoryAdvisor</code></strong></td><td align="left">将历史记录作为标准的 <strong><code>Message</code> 对象列表</strong>加入到 Prompt 中。</td><td align="left"><strong>最常用、最标准</strong>的多轮对话，能完整保留角色和上下文信息。</td></tr><tr><td align="left"><strong><code>PromptChatMemoryAdvisor</code></strong></td><td align="left">将历史记录格式化为<strong>纯文本字符串</strong>，并附加到 <code>SystemMessage</code> 中。</td><td align="left">简单的上下文附加，或当某个特定模型对纯文本上下文处理得更好时。</td></tr><tr><td align="left"><strong><code>VectorStoreChatMemoryAdvisor</code></strong></td><td align="left">从<strong>向量数据库</strong>中搜索与当前输入最相关的历史片段作为记忆。</td><td align="left">实现“长期记忆”或 RAG 式的对话，让AI能回忆起很久以前的相关信息。</td></tr></tbody></table><h5 id="组合配置-CommonConfiguration-java"><a href="#组合配置-CommonConfiguration-java" class="headerlink" title="组合配置 CommonConfiguration.java"></a>组合配置 <code>CommonConfiguration.java</code></h5><p>现在，我们将所有部分组合在一个 <code>@Configuration</code> 文件中，展示一个完整的、基于 JDBC 持久化的记忆配置。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件路径: src/main/java/com/example/hellospringai/config/CommonConfiguration.java</span></span><br><span class="line"><span class="keyword">package</span> com.example.hellospringai.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.memory.ChatMemory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.memory.MessageWindowChatMemory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.memory.repository.jdbc.JdbcChatMemoryRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonConfiguration</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. Spring Boot会根据我们的yml配置，自动为我们配置好一个JdbcChatMemoryRepository</span></span><br><span class="line">    <span class="comment">//    因此我们可以直接注入它。</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcChatMemoryRepository chatMemoryRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2. 定义我们的“记忆策略”Bean。</span></span><br><span class="line"><span class="comment">     * 这里我们创建了一个使用JDBC持久化存储的、最大容量为50条消息的窗口记忆。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> MessageWindowChatMemory 实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatMemory <span class="title function_">chatMemory</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> MessageWindowChatMemory.builder()</span><br><span class="line">                .chatMemoryRepository(chatMemoryRepository) <span class="comment">// 指定记忆的“仓库”</span></span><br><span class="line">                .maxMessages(<span class="number">50</span>) <span class="comment">// 指定记忆的“策略”：只保留最近50条消息</span></span><br><span class="line">                .build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3. 定义我们最终的 ChatClient Bean。</span></span><br><span class="line"><span class="comment">     * 我们将日志和记忆功能通过“顾问”模式织入。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chatModel Spring Boot 自动配置好的 ChatModel 实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chatMemory 我们上面定义的 ChatMemory Bean 实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 一个配置好日志和持久化记忆功能的 ChatClient 实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient <span class="title function_">chatClient</span><span class="params">(ChatModel chatModel, ChatMemory chatMemory)</span> {</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(chatModel)</span><br><span class="line">                .defaultAdvisors(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">SimpleLoggerAdvisor</span>(),                                  <span class="comment">// 添加日志顾问，用于调试</span></span><br><span class="line">                        MessageChatMemoryAdvisor.builder(chatMemory).build()      <span class="comment">// 添加记忆顾问，并传入我们的记忆策略Bean</span></span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="3-5-5-实际调用：传递会话-ID"><a href="#3-5-5-实际调用：传递会话-ID" class="headerlink" title="3.5.5 实际调用：传递会话 ID"></a>3.5.5 实际调用：传递会话 ID</h4><p>配置完成后，我们还需要在调用 <code>ChatClient</code> 时，告诉它当前这次对话属于哪个“会话 (Conversation)”，以便它能从数据库中加载正确的历史记录。</p><p>这是通过传递一个<strong>会话ID (<code>conversationId</code>)</strong> 来实现的。</p><h5 id="1-Service-层改造"><a href="#1-Service-层改造" class="headerlink" title="1. Service 层改造"></a>1. Service 层改造</h5><p>我们的 <code>ChatService</code> 需要能够接收 <code>conversationId</code>，并将其传递给 <code>ChatClient</code>。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 【方法】带聊天记忆的流式对话</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> prompt 用户输入消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> conversationId 会话ID，用于维护聊天记忆</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> AI回复的文本内容流</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">getChatStreamWithMemory</span><span class="params">(String prompt, String conversationId)</span> {</span><br><span class="line">    <span class="keyword">return</span> chatClient.prompt()</span><br><span class="line">            .user(prompt) <span class="comment">// 用户输入消息</span></span><br><span class="line">            <span class="comment">// 关键：通过 .advisors() 方法的参数，将会话ID传递给记忆顾问</span></span><br><span class="line">            <span class="comment">// ChatMemory.CONVERSATION_ID 是官方提供的标准Key，推荐使用</span></span><br><span class="line">            .advisors(a -&gt; a.param(ChatMemory.CONVERSATION_ID, conversationId)) </span><br><span class="line">            .stream()</span><br><span class="line">            .content();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="2-Controller-层改造"><a href="#2-Controller-层改造" class="headerlink" title="2. Controller 层改造"></a>2. Controller 层改造</h5><p>相应地，<code>ChatController</code> 的接口也需要增加一个 <code>chatId</code> 参数，以从前端请求中接收这个ID。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/ai")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatController</span> {</span><br><span class="line">    <span class="comment">// ... 构造函数注入 ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(value = "/chat", produces = "text/event-stream;charset=utf-8")</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">streamChat</span><span class="params">(<span class="meta">@RequestParam(value = "message")</span> String message,</span></span><br><span class="line"><span class="params">                                   // 关键: 从请求参数中获取会话ID</span></span><br><span class="line"><span class="params">                                   <span class="meta">@RequestParam(value = "chatId")</span> String chatId)</span> {</span><br><span class="line">        <span class="keyword">return</span> chatService.getChatStreamWithMemory(message, chatId);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>至此，我们的后端就拥有了完整的、可持久化的多会话记忆能力。每个唯一的 <code>chatId</code> 都会在 <code>spring_ai_chat_memory</code> 表中拥有自己独立的聊天记录。</p><hr><h4 id="3-5-6-前端适配：核心代码实现"><a href="#3-5-6-前端适配：核心代码实现" class="headerlink" title="3.5.6 前端适配：核心代码实现"></a>3.5.6 前端适配：核心代码实现</h4><p>后端具备记忆能力后，前端的核心任务是<strong>管理并发送 <code>chatId</code></strong>。以下是实现此功能的几个关键文件的核心代码与直接说明。</p><h5 id="1-API-层-src-api-chat-js"><a href="#1-API-层-src-api-chat-js" class="headerlink" title="1. API 层: src/api/chat.js"></a>1. API 层: <code>src/api/chat.js</code></h5><ul><li><strong>目的</strong>: 让 API 调用能携带 <code>chatId</code>。</li></ul><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'../utils/request'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 以流式方式获取AI回答</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">string</span>} <span class="variable">message</span> - 用户消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">string</span>} <span class="variable">chatId</span> - 【新增】当前会话的唯一ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">Promise&lt;Response&gt;</span>}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">streamChat</span>(<span class="params">message, chatId = <span class="string">'default'</span></span>) {</span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">`<span class="subst">${request.defaults.baseURL}</span>/ai/chat?message=<span class="subst">${<span class="built_in">encodeURIComponent</span>(message)}</span>&amp;chatId=<span class="subst">${<span class="built_in">encodeURIComponent</span>(chatId)}</span>`</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(url, {</span><br><span class="line">    <span class="attr">method</span>: <span class="string">'GET'</span>,</span><br><span class="line">    <span class="attr">headers</span>: {</span><br><span class="line">      <span class="string">'Accept'</span>: <span class="string">'text/event-stream'</span>,</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h5 id="2-状态管理层-src-stores-conversationStore-js"><a href="#2-状态管理层-src-stores-conversationStore-js" class="headerlink" title="2. 状态管理层: src/stores/conversationStore.js"></a>2. 状态管理层: <code>src/stores/conversationStore.js</code></h5><ul><li><strong>目的</strong>: 重构状态管理，从单一对话升级为支持多会话的完整系统。这是前端实现多会话记忆的核心。</li></ul><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这是一个使用 Pinia 状态管理库创建的对话存储模块</span></span><br><span class="line"><span class="keyword">import</span> { defineStore } <span class="keyword">from</span> <span class="string">'pinia'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出一个名为 'conversation' 的状态存储，用于管理多会话聊天对话的状态</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useConversationStore = <span class="title function_">defineStore</span>(<span class="string">'conversation'</span>, {</span><br><span class="line">  <span class="comment">// 定义存储的状态数据</span></span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> ({</span><br><span class="line">    <span class="comment">// 所有会话的数据，按会话ID分组存储</span></span><br><span class="line">    <span class="attr">conversations</span>: {</span><br><span class="line">      <span class="comment">// 'conversation-id': {</span></span><br><span class="line">      <span class="comment">//   id: 'conversation-id',</span></span><br><span class="line">      <span class="comment">//   title: '会话标题',</span></span><br><span class="line">      <span class="comment">//   messages: [], // BubbleList格式的消息数组</span></span><br><span class="line">      <span class="comment">//   createdAt: Date,</span></span><br><span class="line">      <span class="comment">//   updatedAt: Date,</span></span><br><span class="line">      <span class="comment">//   group: 'today' // 用于分组显示</span></span><br><span class="line">      <span class="comment">// }</span></span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 当前活跃的会话ID</span></span><br><span class="line">    <span class="attr">currentConversationId</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// 消息ID计数器</span></span><br><span class="line">    <span class="attr">nextMessageId</span>: <span class="number">0</span>,</span><br><span class="line">  }),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算属性</span></span><br><span class="line">  <span class="attr">getters</span>: {</span><br><span class="line">    <span class="comment">// 获取当前会话的消息列表</span></span><br><span class="line">    <span class="attr">currentMessages</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (!state.<span class="property">currentConversationId</span> || !state.<span class="property">conversations</span>[state.<span class="property">currentConversationId</span>]) {</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">conversations</span>[state.<span class="property">currentConversationId</span>].<span class="property">messages</span>;</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前会话信息</span></span><br><span class="line">    <span class="attr">currentConversation</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (!state.<span class="property">currentConversationId</span> || !state.<span class="property">conversations</span>[state.<span class="property">currentConversationId</span>]) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">conversations</span>[state.<span class="property">currentConversationId</span>];</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取会话列表（用于 Conversations 组件）</span></span><br><span class="line">    <span class="attr">conversationItems</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">      <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>(now.<span class="title function_">getFullYear</span>(), now.<span class="title function_">getMonth</span>(), now.<span class="title function_">getDate</span>());</span><br><span class="line">      <span class="keyword">const</span> yesterday = <span class="keyword">new</span> <span class="title class_">Date</span>(today.<span class="title function_">getTime</span>() - <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">      <span class="keyword">const</span> weekAgo = <span class="keyword">new</span> <span class="title class_">Date</span>(today.<span class="title function_">getTime</span>() - <span class="number">7</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">values</span>(state.<span class="property">conversations</span>).<span class="title function_">map</span>(<span class="function"><span class="params">conv</span> =&gt;</span> {</span><br><span class="line">        <span class="keyword">const</span> updatedAt = <span class="keyword">new</span> <span class="title class_">Date</span>(conv.<span class="property">updatedAt</span>);</span><br><span class="line">        <span class="keyword">let</span> group = <span class="string">'older'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (updatedAt &gt;= today) {</span><br><span class="line">          group = <span class="string">'today'</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (updatedAt &gt;= yesterday) {</span><br><span class="line">          group = <span class="string">'yesterday'</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (updatedAt &gt;= weekAgo) {</span><br><span class="line">          group = <span class="string">'week'</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> {</span><br><span class="line">          <span class="attr">id</span>: conv.<span class="property">id</span>,</span><br><span class="line">          <span class="attr">label</span>: conv.<span class="property">title</span>,</span><br><span class="line">          group,</span><br><span class="line">          <span class="attr">updatedAt</span>: conv.<span class="property">updatedAt</span></span><br><span class="line">        };</span><br><span class="line">      }).<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="keyword">new</span> <span class="title class_">Date</span>(b.<span class="property">updatedAt</span>) - <span class="keyword">new</span> <span class="title class_">Date</span>(a.<span class="property">updatedAt</span>));</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义可以修改状态的操作方法</span></span><br><span class="line">  <span class="attr">actions</span>: {</span><br><span class="line">    <span class="comment">// 创建新会话</span></span><br><span class="line">    <span class="title function_">createConversation</span>(<span class="params">title = <span class="literal">null</span></span>) {</span><br><span class="line">      <span class="keyword">const</span> conversationId = <span class="string">`conv_<span class="subst">${<span class="built_in">Date</span>.now()}</span>_<span class="subst">${<span class="built_in">Math</span>.random().toString(<span class="number">36</span>).substr(<span class="number">2</span>, <span class="number">9</span>)}</span>`</span>;</span><br><span class="line">      <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">conversations</span>[conversationId] = {</span><br><span class="line">        <span class="attr">id</span>: conversationId,</span><br><span class="line">        <span class="attr">title</span>: title || <span class="string">'新的会话'</span>,</span><br><span class="line">        <span class="attr">messages</span>: [],</span><br><span class="line">        <span class="attr">createdAt</span>: now,</span><br><span class="line">        <span class="attr">updatedAt</span>: now</span><br><span class="line">      };</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 自动切换到新会话</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentConversationId</span> = conversationId;</span><br><span class="line">      <span class="keyword">return</span> conversationId;</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 切换会话</span></span><br><span class="line">    <span class="title function_">switchConversation</span>(<span class="params">conversationId</span>) {</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">conversations</span>[conversationId]) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentConversationId</span> = conversationId;</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除会话</span></span><br><span class="line">    <span class="title function_">deleteConversation</span>(<span class="params">conversationId</span>) {</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">conversations</span>[conversationId]) {</span><br><span class="line">        <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">conversations</span>[conversationId];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果删除的是当前会话，切换到其他会话或创建新会话</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentConversationId</span> === conversationId) {</span><br><span class="line">          <span class="keyword">const</span> remainingConversations = <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">conversations</span>);</span><br><span class="line">          <span class="keyword">if</span> (remainingConversations.<span class="property">length</span> &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">currentConversationId</span> = remainingConversations[<span class="number">0</span>];</span><br><span class="line">          } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">createConversation</span>();</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重命名会话</span></span><br><span class="line">    <span class="title function_">renameConversation</span>(<span class="params">conversationId, newTitle</span>) {</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">conversations</span>[conversationId]) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">conversations</span>[conversationId].<span class="property">title</span> = newTitle;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">conversations</span>[conversationId].<span class="property">updatedAt</span> = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加一条新消息到当前会话</span></span><br><span class="line">    <span class="title function_">addMessage</span>(<span class="params">{ role, content = <span class="string">''</span> }</span>) {</span><br><span class="line">      <span class="comment">// 确保有当前会话</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">currentConversationId</span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">createConversation</span>();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> messageRole = role === <span class="string">'user'</span> ? <span class="string">'user'</span> : <span class="string">'ai'</span>;</span><br><span class="line">      <span class="keyword">const</span> placement = messageRole === <span class="string">'ai'</span> ? <span class="string">'start'</span> : <span class="string">'end'</span>;</span><br><span class="line">      <span class="keyword">const</span> variant = messageRole === <span class="string">'ai'</span> ? <span class="string">'filled'</span> : <span class="string">'outlined'</span>;</span><br><span class="line">      <span class="keyword">const</span> avatar = messageRole === <span class="string">'ai'</span></span><br><span class="line">        ? <span class="string">'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png'</span></span><br><span class="line">        : <span class="string">'https://avatars.githubusercontent.com/u/76239030?v=4'</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建符合 BubbleList 组件要求的消息对象</span></span><br><span class="line">      <span class="keyword">const</span> bubbleMessage = {</span><br><span class="line">        <span class="attr">key</span>: <span class="variable language_">this</span>.<span class="property">nextMessageId</span>++,         <span class="comment">// 唯一标识</span></span><br><span class="line">        <span class="attr">role</span>: messageRole,                 <span class="comment">// user | ai 角色定义</span></span><br><span class="line">        placement,                         <span class="comment">// start | end 气泡位置</span></span><br><span class="line">        content,                          <span class="comment">// 消息内容，流式接收时只需要改这个值即可</span></span><br><span class="line">        <span class="attr">loading</span>: <span class="literal">false</span>,                   <span class="comment">// 当前气泡的加载状态</span></span><br><span class="line">        <span class="attr">shape</span>: <span class="string">'corner'</span>,                  <span class="comment">// 气泡的形状</span></span><br><span class="line">        variant,                          <span class="comment">// 气泡的样式</span></span><br><span class="line">        <span class="attr">isMarkdown</span>: <span class="literal">true</span>,                 <span class="comment">// 是否渲染为 markdown</span></span><br><span class="line">        <span class="attr">typing</span>: <span class="literal">false</span>,                    <span class="comment">// 是否开启打字器效果，该属性不会和流式接收冲突</span></span><br><span class="line">        <span class="attr">isFog</span>: messageRole === <span class="string">'ai'</span>,      <span class="comment">// 是否开启打字雾化效果，该效果 v1.1.6 新增，且在 typing 为 true 时生效，该效果会覆盖 typing 的 suffix 属性</span></span><br><span class="line">        avatar,                           <span class="comment">// 头像</span></span><br><span class="line">        <span class="attr">avatarSize</span>: <span class="string">'36px'</span>,               <span class="comment">// 头像占位大小</span></span><br><span class="line">        <span class="attr">avatarGap</span>: <span class="string">'12px'</span>,                <span class="comment">// 头像与气泡之间的距离</span></span><br><span class="line">      };</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">conversations</span>[<span class="variable language_">this</span>.<span class="property">currentConversationId</span>].<span class="property">messages</span>.<span class="title function_">push</span>(bubbleMessage);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">conversations</span>[<span class="variable language_">this</span>.<span class="property">currentConversationId</span>].<span class="property">updatedAt</span> = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 智能更新会话标题（基于用户的第一条消息）</span></span><br><span class="line">      <span class="keyword">if</span> (messageRole === <span class="string">'user'</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">conversations</span>[<span class="variable language_">this</span>.<span class="property">currentConversationId</span>].<span class="property">messages</span>.<span class="property">length</span> === <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">const</span> title = content.<span class="property">length</span> &gt; <span class="number">20</span> ? content.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">20</span>) + <span class="string">'...'</span> : content;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">conversations</span>[<span class="variable language_">this</span>.<span class="property">currentConversationId</span>].<span class="property">title</span> = title || <span class="string">'新的会话'</span>;</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向当前会话的最后一条消息追加内容（用于流式接收AI回复）</span></span><br><span class="line">    <span class="title function_">appendToLastMessage</span>(<span class="params">contentChunk</span>) {</span><br><span class="line">      <span class="comment">// 确保有当前会话f</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">currentConversationId</span> || !<span class="variable language_">this</span>.<span class="property">conversations</span>[<span class="variable language_">this</span>.<span class="property">currentConversationId</span>]) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> messages = <span class="variable language_">this</span>.<span class="property">conversations</span>[<span class="variable language_">this</span>.<span class="property">currentConversationId</span>].<span class="property">messages</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果没有消息则直接返回</span></span><br><span class="line">      <span class="keyword">if</span> (messages.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取最后一条消息</span></span><br><span class="line">      <span class="keyword">const</span> lastMessage = messages[messages.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 只有当最后一条消息是AI助手的回复时才追加内容</span></span><br><span class="line">      <span class="keyword">if</span> (lastMessage.<span class="property">role</span> === <span class="string">'ai'</span>) {</span><br><span class="line">        lastMessage.<span class="property">content</span> += contentChunk;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">conversations</span>[<span class="variable language_">this</span>.<span class="property">currentConversationId</span>].<span class="property">updatedAt</span> = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清空当前会话历史</span></span><br><span class="line">    <span class="title function_">clearCurrentHistory</span>(<span class="params"></span>) {</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentConversationId</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">conversations</span>[<span class="variable language_">this</span>.<span class="property">currentConversationId</span>]) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">conversations</span>[<span class="variable language_">this</span>.<span class="property">currentConversationId</span>].<span class="property">messages</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">conversations</span>[<span class="variable language_">this</span>.<span class="property">currentConversationId</span>].<span class="property">updatedAt</span> = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清空所有会话历史</span></span><br><span class="line">    <span class="title function_">clearAllHistory</span>(<span class="params"></span>) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">conversations</span> = {};</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentConversationId</span> = <span class="literal">null</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">createConversation</span>();</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化默认会话（如果没有任何会话）</span></span><br><span class="line">    <span class="title function_">initializeDefaultConversation</span>(<span class="params"></span>) {</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">conversations</span>).<span class="property">length</span> === <span class="number">0</span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">createConversation</span>(<span class="string">'默认会话'</span>);</span><br><span class="line">      } <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">currentConversationId</span>) {</span><br><span class="line">        <span class="comment">// 如果没有当前会话，选择最近更新的会话</span></span><br><span class="line">        <span class="keyword">const</span> conversationIds = <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">conversations</span>);</span><br><span class="line">        <span class="keyword">const</span> latestConversation = conversationIds.<span class="title function_">reduce</span>(<span class="function">(<span class="params">latest, id</span>) =&gt;</span> {</span><br><span class="line">          <span class="keyword">const</span> conv = <span class="variable language_">this</span>.<span class="property">conversations</span>[id];</span><br><span class="line">          <span class="keyword">return</span> (!latest || conv.<span class="property">updatedAt</span> &gt; <span class="variable language_">this</span>.<span class="property">conversations</span>[latest].<span class="property">updatedAt</span>) ? id : latest;</span><br><span class="line">        }, <span class="literal">null</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentConversationId</span> = latestConversation;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h5 id="3-逻辑层-Composables"><a href="#3-逻辑层-Composables" class="headerlink" title="3. 逻辑层: Composables"></a>3. 逻辑层: Composables</h5><ul><li><p><strong>目的</strong>: 将复杂的UI交互逻辑与核心的聊天功能逻辑解耦，使代码更清晰。</p></li><li><p><strong><code>src/composables/useChat.js</code></strong> (聊天核心逻辑)</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { ref, watch, computed, onMounted } <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> { useConversationStore } <span class="keyword">from</span> <span class="string">'../stores/conversationStore'</span>;</span><br><span class="line"><span class="keyword">import</span> { storeToRefs } <span class="keyword">from</span> <span class="string">'pinia'</span>;</span><br><span class="line"><span class="keyword">import</span> { streamChat } <span class="keyword">from</span> <span class="string">'../api/chat'</span>;</span><br><span class="line"><span class="keyword">import</span> { useXStream } <span class="keyword">from</span> <span class="string">'vue-element-plus-x'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聊天核心逻辑 composable</span></span><br><span class="line"><span class="comment"> * 处理消息发送、流式接收、状态管理等</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useChat</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 状态管理 - 使用新的会话管理系统</span></span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useConversationStore</span>();</span><br><span class="line">    <span class="keyword">const</span> { currentMessages, currentConversationId } = <span class="title function_">storeToRefs</span>(store);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输入消息</span></span><br><span class="line">    <span class="keyword">const</span> inputMessage = <span class="title function_">ref</span>(<span class="string">''</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 useXStream 处理流式数据</span></span><br><span class="line">    <span class="keyword">const</span> { startStream, cancel, isLoading, data, error } = <span class="title function_">useXStream</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算属性处理累积的流式数据</span></span><br><span class="line">    <span class="keyword">const</span> streamContent = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (!data.<span class="property">value</span>.<span class="property">length</span>) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> text = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; data.<span class="property">value</span>.<span class="property">length</span>; index++) {</span><br><span class="line">            <span class="keyword">const</span> chunk = data.<span class="property">value</span>[index];</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 检查chunk是否是对象且包含data属性</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> chunk === <span class="string">'object'</span> &amp;&amp; chunk !== <span class="literal">null</span> &amp;&amp; <span class="string">'data'</span> <span class="keyword">in</span> chunk) {</span><br><span class="line">                    <span class="comment">// 处理非空data</span></span><br><span class="line">                    <span class="keyword">if</span> (chunk.<span class="property">data</span>) {</span><br><span class="line">                        text += chunk.<span class="property">data</span>;</span><br><span class="line">                    } <span class="keyword">else</span> <span class="keyword">if</span> (chunk.<span class="property">data</span> === <span class="string">''</span>) {</span><br><span class="line">                        <span class="comment">// 空data块通常表示换行符</span></span><br><span class="line">                        text += <span class="string">'\n'</span>;</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> chunk === <span class="string">'string'</span>) {</span><br><span class="line">                    text += chunk;</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">'未知的chunk格式:'</span>, chunk);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">catch</span> (error) {</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'解析流数据时出错:'</span>, error);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> text;</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听流式数据更新，实时追加到消息中</span></span><br><span class="line">    <span class="title function_">watch</span>(streamContent, <span class="function">(<span class="params">newContent, oldContent</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (newContent &amp;&amp; newContent !== oldContent) {</span><br><span class="line">            <span class="comment">// 获取新增的内容部分</span></span><br><span class="line">            <span class="keyword">const</span> newChunk = newContent.<span class="title function_">slice</span>(oldContent?.<span class="property">length</span> || <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (newChunk) {</span><br><span class="line">                store.<span class="title function_">appendToLastMessage</span>(newChunk);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听错误信息</span></span><br><span class="line">    <span class="title function_">watch</span>(error, <span class="function">(<span class="params">errorInfo</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (errorInfo) {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"流式请求失败:"</span>, errorInfo);</span><br><span class="line">            store.<span class="title function_">appendToLastMessage</span>(<span class="string">"\n\n抱歉，处理您的请求时遇到了问题。"</span>);</span><br><span class="line">        }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理用户提交消息</span></span><br><span class="line"><span class="comment">     * 使用 useXStream 处理流式接收</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleUserSubmit</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; {</span><br><span class="line">    <span class="keyword">const</span> messageContent = inputMessage.<span class="property">value</span>.<span class="title function_">trim</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证输入</span></span><br><span class="line">        <span class="keyword">if</span> (!messageContent || isLoading.<span class="property">value</span>) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 确保有当前会话ID</span></span><br><span class="line">        <span class="keyword">if</span> (!currentConversationId.<span class="property">value</span>) {</span><br><span class="line">            store.<span class="title function_">initializeDefaultConversation</span>();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 1. 添加用户消息到对话历史</span></span><br><span class="line">            store.<span class="title function_">addMessage</span>({</span><br><span class="line">            <span class="attr">role</span>: <span class="string">'user'</span>,</span><br><span class="line">                <span class="attr">content</span>: messageContent</span><br><span class="line">            });</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 清空输入框</span></span><br><span class="line">            inputMessage.<span class="property">value</span> = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 创建AI回复占位</span></span><br><span class="line">            store.<span class="title function_">addMessage</span>({</span><br><span class="line">                <span class="attr">role</span>: <span class="string">'assistant'</span>,</span><br><span class="line">            <span class="attr">content</span>: <span class="string">''</span></span><br><span class="line">            });</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 获取流式响应，传递当前会话ID</span></span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">streamChat</span>(messageContent, currentConversationId.<span class="property">value</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'发送请求，会话ID:'</span>, currentConversationId.<span class="property">value</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5. 使用 useXStream 处理流式数据</span></span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">startStream</span>({</span><br><span class="line">                <span class="attr">readableStream</span>: response.<span class="property">body</span></span><br><span class="line">            });</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">catch</span> (err) {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"发起流式请求失败:"</span>, err);</span><br><span class="line">            store.<span class="title function_">appendToLastMessage</span>(<span class="string">"\n\n抱歉，发起请求时遇到了问题。"</span>);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 组件挂载时初始化</span></span><br><span class="line">    <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        store.<span class="title function_">initializeDefaultConversation</span>();</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="comment">// 状态</span></span><br><span class="line">        <span class="attr">messages</span>: currentMessages, <span class="comment">// 返回当前会话的消息</span></span><br><span class="line">        <span class="attr">isGenerating</span>: isLoading, <span class="comment">// 使用 useXStream 的 isLoading 状态</span></span><br><span class="line">        inputMessage,</span><br><span class="line">        currentConversationId,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法</span></span><br><span class="line">        handleUserSubmit,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 流式处理相关</span></span><br><span class="line">        cancel <span class="comment">// 暴露取消功能</span></span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li><li><p><strong><code>src/composables/useConversationManager.js</code></strong> (会话管理逻辑)</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">import</span> { computed } <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> { <span class="title class_">ElMessage</span>, <span class="title class_">ElMessageBox</span> } <span class="keyword">from</span> <span class="string">'element-plus'</span>;</span><br><span class="line">    <span class="keyword">import</span> { useConversationStore } <span class="keyword">from</span> <span class="string">'../stores/conversationStore'</span>;</span><br><span class="line">    <span class="keyword">import</span> { storeToRefs } <span class="keyword">from</span> <span class="string">'pinia'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 会话管理 composable</span></span><br><span class="line"><span class="comment">     * 处理会话相关的UI交互逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useConversationManager</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">const</span> store = <span class="title function_">useConversationStore</span>();</span><br><span class="line">        <span class="keyword">const</span> { conversationItems, currentConversation, currentConversationId } = <span class="title function_">storeToRefs</span>(store);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 当前选中的会话KEY（用于 Conversations 组件）</span></span><br><span class="line">        <span class="keyword">const</span> activeConversationKey = <span class="title function_">computed</span>({</span><br><span class="line">            <span class="attr">get</span>: <span class="function">() =&gt;</span> currentConversationId.<span class="property">value</span>,</span><br><span class="line">            <span class="attr">set</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> {</span><br><span class="line">                <span class="keyword">if</span> (value &amp;&amp; value !== currentConversationId.<span class="property">value</span>) {</span><br><span class="line">                    store.<span class="title function_">switchConversation</span>(value);</span><br><span class="line">            }</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 当前会话标题</span></span><br><span class="line">        <span class="keyword">const</span> currentConversationTitle = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="keyword">return</span> currentConversation.<span class="property">value</span>?.<span class="property">title</span> || <span class="string">'Spring AI 全栈聊天机器人'</span>;</span><br><span class="line">        });</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 会话切换处理</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">handleConversationChange</span> = (<span class="params">item</span>) =&gt; {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'会话切换:'</span>, item);</span><br><span class="line">            store.<span class="title function_">switchConversation</span>(item.<span class="property">id</span>);</span><br><span class="line">            <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">`切换到: <span class="subst">${item.label}</span>`</span>);</span><br><span class="line">        };</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 新建会话</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">handleCreateNewConversation</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">            <span class="keyword">const</span> conversationId = store.<span class="title function_">createConversation</span>();</span><br><span class="line">            <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">'新建会话成功'</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'新建会话:'</span>, conversationId);</span><br><span class="line">            <span class="keyword">return</span> conversationId;</span><br><span class="line">        };</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 清空当前会话历史</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">handleClearCurrentHistory</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">ElMessageBox</span>.<span class="title function_">confirm</span>(</span><br><span class="line">                <span class="string">'确定要清空当前会话的所有消息吗？'</span>,</span><br><span class="line">                <span class="string">'确认清空'</span>,</span><br><span class="line">                {</span><br><span class="line">                    <span class="attr">confirmButtonText</span>: <span class="string">'确定'</span>,</span><br><span class="line">                    <span class="attr">cancelButtonText</span>: <span class="string">'取消'</span>,</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">'warning'</span>,</span><br><span class="line">                }</span><br><span class="line">            ).<span class="title function_">then</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">                store.<span class="title function_">clearCurrentHistory</span>();</span><br><span class="line">                <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">'已清空当前会话历史'</span>);</span><br><span class="line">            }).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">                <span class="comment">// 用户取消操作</span></span><br><span class="line">            });</span><br><span class="line">        };</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 处理会话菜单命令（重命名、删除）</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">handleMenuCommand</span> = (<span class="params">command, item</span>) =&gt; {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'菜单命令:'</span>, command, item);</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">switch</span> (command) {</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'rename'</span>:</span><br><span class="line">                    <span class="title function_">handleRenameConversation</span>(item);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'delete'</span>:</span><br><span class="line">                    <span class="title function_">handleDeleteConversation</span>(item);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="attr">default</span>:</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">'未知的菜单命令:'</span>, command);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 重命名会话</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">handleRenameConversation</span> = (<span class="params">item</span>) =&gt; {</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">ElMessageBox</span>.<span class="title function_">prompt</span>(<span class="string">'请输入新的会话名称'</span>, <span class="string">'重命名会话'</span>, {</span><br><span class="line">                <span class="attr">confirmButtonText</span>: <span class="string">'确定'</span>,</span><br><span class="line">                <span class="attr">cancelButtonText</span>: <span class="string">'取消'</span>,</span><br><span class="line">                <span class="attr">inputValue</span>: item.<span class="property">label</span>,</span><br><span class="line">                <span class="attr">inputPattern</span>: <span class="regexp">/^.{1,50}$/</span>,</span><br><span class="line">                <span class="attr">inputErrorMessage</span>: <span class="string">'会话名称长度必须在1-50个字符之间'</span></span><br><span class="line">            }).<span class="title function_">then</span>(<span class="function">(<span class="params">{ value }</span>) =&gt;</span> {</span><br><span class="line">                store.<span class="title function_">renameConversation</span>(item.<span class="property">id</span>, value);</span><br><span class="line">                <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">'重命名成功'</span>);</span><br><span class="line">            }).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">                <span class="comment">// 用户取消操作</span></span><br><span class="line">            });</span><br><span class="line">        };</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 删除会话</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">handleDeleteConversation</span> = (<span class="params">item</span>) =&gt; {</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">ElMessageBox</span>.<span class="title function_">confirm</span>(</span><br><span class="line">                <span class="string">`确定要删除会话 "<span class="subst">${item.label}</span>" 吗？此操作不可撤销。`</span>,</span><br><span class="line">                <span class="string">'确认删除'</span>,</span><br><span class="line">                {</span><br><span class="line">                    <span class="attr">confirmButtonText</span>: <span class="string">'确定'</span>,</span><br><span class="line">                    <span class="attr">cancelButtonText</span>: <span class="string">'取消'</span>,</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">'warning'</span>,</span><br><span class="line">                }</span><br><span class="line">            ).<span class="title function_">then</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">                store.<span class="title function_">deleteConversation</span>(item.<span class="property">id</span>);</span><br><span class="line">                <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">'删除成功'</span>);</span><br><span class="line">            }).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">                <span class="comment">// 用户取消操作</span></span><br><span class="line">            });</span><br><span class="line">        };</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> {</span><br><span class="line">            <span class="comment">// 状态</span></span><br><span class="line">            conversationItems,</span><br><span class="line">            currentConversation,</span><br><span class="line">            currentConversationId,</span><br><span class="line">            activeConversationKey,</span><br><span class="line">            currentConversationTitle,</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 方法</span></span><br><span class="line">            handleConversationChange,</span><br><span class="line">            handleCreateNewConversation,</span><br><span class="line">            handleClearCurrentHistory,</span><br><span class="line">            handleMenuCommand,</span><br><span class="line">            handleRenameConversation,</span><br><span class="line">            handleDeleteConversation</span><br><span class="line">        };</span><br><span class="line">    } </span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="4-视图层-src-views-ChatView-vue"><a href="#4-视图层-src-views-ChatView-vue" class="headerlink" title="4. 视图层: src/views/ChatView.vue"></a>4. 视图层: <code>src/views/ChatView.vue</code></h5><ul><li><strong>目的</strong>: 整合所有状态和逻辑，构建最终的用户交互界面。</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="h-screen w-screen flex"&gt;</span><br><span class="line">    &lt;!-- 左侧会话管理 --&gt;</span><br><span class="line">    &lt;div class="w-64 border-r bg-gray-50 flex flex-col"&gt;</span><br><span class="line">      &lt;div class="p-4 border-b bg-gray-100 flex justify-between items-center"&gt;</span><br><span class="line">        &lt;h3 class="font-bold text-lg"&gt;会话管理&lt;/h3&gt;</span><br><span class="line">        &lt;button @click="handleCreateNewConversation" class="btn btn-ghost btn-sm" title="新建会话"&gt;</span><br><span class="line">          ＋</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class="flex-1 overflow-auto"&gt;</span><br><span class="line">        &lt;Conversations :active="activeConversationKey" @update:active="(value) =&gt; activeConversationKey = value"</span><br><span class="line">          :items="conversationItems" :label-max-width="200" :show-tooltip="true" row-key="id" show-built-in-menu</span><br><span class="line">          groupable @change="handleConversationChange" @menu-command="handleMenuCommand" /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 右侧聊天区域 --&gt;</span><br><span class="line">    &lt;div class="flex-1 flex flex-col"&gt;</span><br><span class="line">      &lt;!-- 聊天标题 --&gt;</span><br><span class="line">      &lt;div class="p-4 bg-blue-500 text-white text-xl font-bold flex justify-between items-center"&gt;</span><br><span class="line">        &lt;span&gt;{{ currentConversationTitle }}&lt;/span&gt;</span><br><span class="line">        &lt;button @click="handleClearCurrentHistory"</span><br><span class="line">          class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors" title="清空当前会话"&gt;</span><br><span class="line">          清空</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- 聊天内容区 --&gt;</span><br><span class="line">      &lt;div class="flex-1 flex flex-col"&gt;</span><br><span class="line">        &lt;!-- 消息列表 --&gt;</span><br><span class="line">        &lt;div class="flex-1 overflow-auto"&gt;</span><br><span class="line">          &lt;BubbleList :list="formattedMessages" is-markdown /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 发送器 --&gt;</span><br><span class="line">        &lt;div class="border-t"&gt;</span><br><span class="line">          &lt;Sender v-model="inputMessage" :loading="isGenerating" :submitBtnDisabled="isGenerating"</span><br><span class="line">            placeholder="请输入您的问题..." :clearable="true" submitType="enter" @submit="handleUserSubmit" /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import { BubbleList, Sender, Conversations } from 'vue-element-plus-x';</span><br><span class="line">import { useChat } from '../composables/useChat';</span><br><span class="line">import { useMessageFormatter } from '../composables/useMessageFormatter';</span><br><span class="line">import { useConversationManager } from '../composables/useConversationManager';</span><br><span class="line"></span><br><span class="line">// --- 聊天功能 ---</span><br><span class="line">const {</span><br><span class="line">  messages,</span><br><span class="line">  isGenerating,</span><br><span class="line">  inputMessage,</span><br><span class="line">  handleUserSubmit</span><br><span class="line">} = useChat();</span><br><span class="line"></span><br><span class="line">const { formattedMessages } = useMessageFormatter(messages, isGenerating);</span><br><span class="line"></span><br><span class="line">// --- 会话管理功能 ---</span><br><span class="line">const {</span><br><span class="line">  conversationItems,</span><br><span class="line">  activeConversationKey,</span><br><span class="line">  currentConversationTitle,</span><br><span class="line">  handleConversationChange,</span><br><span class="line">  handleCreateNewConversation,</span><br><span class="line">  handleClearCurrentHistory,</span><br><span class="line">  handleMenuCommand</span><br><span class="line">} = useConversationManager();</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">/* 确保组件铺满全屏 */</span><br><span class="line">html,</span><br><span class="line">body,</span><br><span class="line">#app {</span><br><span class="line">  height: 100%;</span><br><span class="line">  width: 100%;</span><br><span class="line">  margin: 0;</span><br><span class="line">  padding: 0;</span><br><span class="line">  overflow: hidden;</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><hr><h3 id="3-6-会话历史：从数据库加载与管理"><a href="#3-6-会话历史：从数据库加载与管理" class="headerlink" title="3.6 会话历史：从数据库加载与管理"></a>3.6 会话历史：从数据库加载与管理</h3><p>在上一章，我们配置了 <code>JdbcChatMemoryRepository</code>，它会默默地将所有对话记录保存到 <code>spring_ai_chat_memory</code> 数据库表中。这解决了AI的“短期记忆”问题。但对于一个完整的应用而言，我们还需要让用户能够看到并管理自己的历史会话列表，就像所有主流聊天应用一样。</p><p>本章，我们将使用 <strong>MyBatis-Plus</strong> 这个强大的 ORM 框架，直接操作 <code>spring_ai_chat_memory</code> 表，为其创建一套完整的 <code>Service</code> 和 <code>Controller</code>，从而实现真正的会话持久化和管理功能。</p><h4 id="3-6-1-后端建设：构建历史记录服务"><a href="#3-6-1-后端建设：构建历史记录服务" class="headerlink" title="3.6.1 后端建设：构建历史记录服务"></a>3.6.1 后端建设：构建历史记录服务</h4><p>我们的第一步是在后端搭建一套完整的、用于查询和管理聊天历史的 CRUD 服务。</p><h5 id="1-引入依赖与配置"><a href="#1-引入依赖与配置" class="headerlink" title="1. 引入依赖与配置"></a>1. 引入依赖与配置</h5><ul><li><p><strong>在 <code>pom.xml</code> 中添加 MyBatis-Plus 依赖</strong>：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-spring-boot3-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>在主启动类上添加 <code>@MapperScan</code> 注解</strong>：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellospringai;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan("com.example.hellospringai.mapper")</span> <span class="comment">// 扫描Mapper接口所在的包</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloSpringAiApplication</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(HelloSpringAiApplication.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>在 <code>application.yml</code> 中添加 MyBatis-Plus 配置</strong>：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MyBatis-Plus 配置</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment"># 开启驼峰命名转换, e.g., conversation_id -&gt; conversationId</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 打印SQL日志到控制台，方便调试</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="comment"># 逻辑删除配置 (如果你的表设计中有逻辑删除字段)</span></span><br><span class="line">      <span class="attr">logic-delete-field:</span> <span class="string">deleted</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># 指定Mapper XML文件的位置 (如果使用XML)</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:/mapper/**/*.xml</span></span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="2-数据访问层-Entity-Mapper"><a href="#2-数据访问层-Entity-Mapper" class="headerlink" title="2. 数据访问层 (Entity &amp; Mapper)"></a>2. 数据访问层 (Entity &amp; Mapper)</h5><ul><li><p><strong>实体类 <code>ChatMemory.java</code></strong>：<br>这个实体类直接映射到 <code>spring_ai_chat_memory</code> 数据库表，让我们能以对象的方式操作数据。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellospringai.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.*;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName("SPRING_AI_CHAT_MEMORY")</span> <span class="comment">// 精确指定表名</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatMemory</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@TableId(value = "id", type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@TableField("conversation_id")</span></span><br><span class="line">    <span class="keyword">private</span> String conversationId;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@TableField("content")</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@TableField("type")</span></span><br><span class="line">    <span class="keyword">private</span> String type; <span class="comment">// USER 或 ASSISTANT</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@TableField("timestamp")</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime timestamp;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@TableField("media")</span></span><br><span class="line">    <span class="keyword">private</span> String media; <span class="comment">// JSON</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@TableField("metadata")</span></span><br><span class="line">    <span class="keyword">private</span> String metadata; <span class="comment">// JSON</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>Mapper 接口 <code>ChatMemoryMapper.java</code></strong>:<br>通过继承 <code>BaseMapper</code>，我们无需编写任何 SQL 语句，即可拥有强大的单表 CRUD 能力。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellospringai.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.hellospringai.entity.ChatMemory;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatMemoryMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;ChatMemory&gt; {</span><br><span class="line">    <span class="comment">// 继承 BaseMapper 后，所有基础的数据库操作都已具备</span></span><br><span class="line">    <span class="comment">// 我们将使用 QueryWrapper 来处理复杂的查询，以获得更好的类型安全和灵活性</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="3-业务逻辑层-Service-ServiceImpl"><a href="#3-业务逻辑层-Service-ServiceImpl" class="headerlink" title="3. 业务逻辑层 (Service &amp; ServiceImpl)"></a>3. 业务逻辑层 (Service &amp; ServiceImpl)</h5><ul><li><p><strong>服务接口 <code>IChatHistoryService.java</code></strong>:<br>定义了我们对外提供的所有历史记录管理功能。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellospringai.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.hellospringai.entity.ChatMemory;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IChatHistoryService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;ChatMemory&gt; {</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据会话ID获取该会话的完整聊天记录</span></span><br><span class="line">    List&lt;ChatMemory&gt; <span class="title function_">getChatHistory</span><span class="params">(String conversationId)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取所有会话的列表信息（用于前端展示会话列表）</span></span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">getAllConversations</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 删除指定会话的所有记录</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">deleteChatHistory</span><span class="params">(String conversationId)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取单个会话的统计信息</span></span><br><span class="line">    Map&lt;String, Object&gt; <span class="title function_">getConversationStats</span><span class="params">(String conversationId)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>服务实现 <code>ChatHistoryServiceImpl.java</code></strong>:<br>这里是所有业务逻辑的具体实现。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellospringai.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.hellospringai.entity.ChatMemory;</span><br><span class="line"><span class="keyword">import</span> com.example.hellospringai.mapper.ChatMemoryMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.hellospringai.service.IChatHistoryService;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatHistoryServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;ChatMemoryMapper, ChatMemory&gt; <span class="keyword">implements</span> <span class="title class_">IChatHistoryService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ChatMemory&gt; <span class="title function_">getChatHistory</span><span class="params">(String conversationId)</span> {</span><br><span class="line">        <span class="comment">// 按时间升序查询指定会话的所有消息</span></span><br><span class="line">        QueryWrapper&lt;ChatMemory&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(<span class="string">"conversation_id"</span>, conversationId)</span><br><span class="line">                    .orderByAsc(<span class="string">"timestamp"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.list(queryWrapper);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">getAllConversations</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 这个方法相对复杂，它需要为前端聚合每个会话的必要信息</span></span><br><span class="line">        QueryWrapper&lt;ChatMemory&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.select(<span class="string">"conversation_id"</span>, <span class="string">"timestamp"</span>)</span><br><span class="line">                    .orderByDesc(<span class="string">"timestamp"</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;ChatMemory&gt; allRecords = <span class="built_in">this</span>.list(queryWrapper);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 使用 Java Stream 去重，得到所有唯一的会话ID，并保持时间倒序</span></span><br><span class="line">        List&lt;String&gt; conversationIds = allRecords.stream()</span><br><span class="line">                .map(ChatMemory::getConversationId)</span><br><span class="line">                .distinct()</span><br><span class="line">                .toList();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 遍历每个唯一的会话ID，查询其详细信息</span></span><br><span class="line">        <span class="keyword">return</span> conversationIds.stream().map(id -&gt; {</span><br><span class="line">            Map&lt;String, Object&gt; conversation = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            conversation.put(<span class="string">"conversationId"</span>, id);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.1 获取该会话的最后一条消息作为更新时间</span></span><br><span class="line">            <span class="type">ChatMemory</span> <span class="variable">lastMessage</span> <span class="operator">=</span> <span class="built_in">this</span>.query()</span><br><span class="line">                    .eq(<span class="string">"conversation_id"</span>, id).orderByDesc(<span class="string">"timestamp"</span>).last(<span class="string">"LIMIT 1"</span>).one();</span><br><span class="line">            conversation.put(<span class="string">"lastMessageTime"</span>, lastMessage != <span class="literal">null</span> ? lastMessage.getTimestamp() : <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.2 统计该会话的消息总数</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">messageCount</span> <span class="operator">=</span> <span class="built_in">this</span>.query().eq(<span class="string">"conversation_id"</span>, id).count();</span><br><span class="line">            conversation.put(<span class="string">"messageCount"</span>, messageCount);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.3 获取该会话的第一条用户消息作为默认标题</span></span><br><span class="line">            <span class="type">ChatMemory</span> <span class="variable">firstUserMessage</span> <span class="operator">=</span> <span class="built_in">this</span>.query()</span><br><span class="line">                    .eq(<span class="string">"conversation_id"</span>, id).eq(<span class="string">"type"</span>, <span class="string">"USER"</span>).orderByAsc(<span class="string">"timestamp"</span>).last(<span class="string">"LIMIT 1"</span>).one();</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> <span class="string">"新的会话"</span>;</span><br><span class="line">            <span class="keyword">if</span> (firstUserMessage != <span class="literal">null</span> &amp;&amp; firstUserMessage.getContent() != <span class="literal">null</span>) {</span><br><span class="line">                <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> firstUserMessage.getContent().trim();</span><br><span class="line">                title = content.length() &gt; <span class="number">20</span> ? content.substring(<span class="number">0</span>, <span class="number">20</span>) + <span class="string">"..."</span> : content;</span><br><span class="line">            }</span><br><span class="line">            conversation.put(<span class="string">"title"</span>, title);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> conversation;</span><br><span class="line">        }).toList();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteChatHistory</span><span class="params">(String conversationId)</span> {</span><br><span class="line">        QueryWrapper&lt;ChatMemory&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(<span class="string">"conversation_id"</span>, conversationId);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.remove(queryWrapper);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getConversationStats</span><span class="params">(String conversationId)</span> {</span><br><span class="line">        <span class="comment">// 此处省略了与getAllConversations中类似的单个会话信息查询逻辑</span></span><br><span class="line">        Map&lt;String, Object&gt; stats = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// ... 查询逻辑 ...</span></span><br><span class="line">        <span class="keyword">return</span> stats;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="4-API-接口层-Controller"><a href="#4-API-接口层-Controller" class="headerlink" title="4. API 接口层 (Controller)"></a>4. API 接口层 (Controller)</h5><ul><li><strong><code>ChatHistoryController.java</code></strong>:<br>创建一个全新的 Controller，将我们的 Service 方法暴露为 RESTful API，供前端调用。<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellospringai.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.hellospringai.entity.ChatMemory;</span><br><span class="line"><span class="keyword">import</span> com.example.hellospringai.service.IChatHistoryService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/api/chat-history")</span> <span class="comment">// 为历史记录管理API设置统一前缀</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatHistoryController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IChatHistoryService chatHistoryService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatHistoryController</span><span class="params">(IChatHistoryService chatHistoryService)</span> {</span><br><span class="line">        <span class="built_in">this</span>.chatHistoryService = chatHistoryService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/conversations")</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">getAllConversations</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> chatHistoryService.getAllConversations();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/conversation/{conversationId}")</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ChatMemory&gt; <span class="title function_">getChatHistory</span><span class="params">(<span class="meta">@PathVariable</span> String conversationId)</span> {</span><br><span class="line">        <span class="keyword">return</span> chatHistoryService.getChatHistory(conversationId);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping("/conversation/{conversationId}")</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">deleteChatHistory</span><span class="params">(<span class="meta">@PathVariable</span> String conversationId)</span> {</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> chatHistoryService.deleteChatHistory(conversationId);</span><br><span class="line">        <span class="keyword">return</span> Map.of(<span class="string">"success"</span>, success, <span class="string">"message"</span>, success ? <span class="string">"删除成功"</span> : <span class="string">"删除失败"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/conversation/{conversationId}/stats")</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getConversationStats</span><span class="params">(<span class="meta">@PathVariable</span> String conversationId)</span> {</span><br><span class="line">        <span class="keyword">return</span> chatHistoryService.getConversationStats(conversationId);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li></ul><h4 id="3-6-2-前端集成：实现真正的持久化会话"><a href="#3-6-2-前端集成：实现真正的持久化会话" class="headerlink" title="3.6.2 前端集成：实现真正的持久化会话"></a>3.6.2 前端集成：实现真正的持久化会话</h4><p>后端 API 准备就绪后，前端需要进行相应的升级，从完全依赖本地状态，转变为与后端 API 深度集成，实现真正的持久化。</p><h5 id="1-新增前端-API-文件"><a href="#1-新增前端-API-文件" class="headerlink" title="1. 新增前端 API 文件"></a>1. 新增前端 API 文件</h5><ul><li><strong><code>src/api/chatHistory.js</code></strong>:<br>创建一个新的 API 文件，专门用于调用我们刚刚创建的后端历史记录管理接口。<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'../utils/request'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取所有会话列表</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAllConversations</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>({</span><br><span class="line">        <span class="attr">url</span>: <span class="string">'/api/chat-history/conversations'</span>,</span><br><span class="line">        <span class="attr">method</span>: <span class="string">'get'</span></span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取指定会话的聊天历史记录</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getChatHistory</span>(<span class="params">conversationId</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>({</span><br><span class="line">        <span class="attr">url</span>: <span class="string">`/api/chat-history/conversation/<span class="subst">${conversationId}</span>`</span>,</span><br><span class="line">        <span class="attr">method</span>: <span class="string">'get'</span></span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除指定会话的聊天记录</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">deleteChatHistory</span>(<span class="params">conversationId</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>({</span><br><span class="line">        <span class="attr">url</span>: <span class="string">`/api/chat-history/conversation/<span class="subst">${conversationId}</span>`</span>,</span><br><span class="line">        <span class="attr">method</span>: <span class="string">'delete'</span></span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取会话统计信息</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getConversationStats</span>(<span class="params">conversationId</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>({</span><br><span class="line">        <span class="attr">url</span>: <span class="string">`/api/chat-history/conversation/<span class="subst">${conversationId}</span>/stats`</span>,</span><br><span class="line">        <span class="attr">method</span>: <span class="string">'get'</span></span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="2-状态与逻辑层核心升级"><a href="#2-状态与逻辑层核心升级" class="headerlink" title="2. 状态与逻辑层核心升级"></a>2. 状态与逻辑层核心升级</h5><ul><li><p><strong><code>src/stores/conversationStore.js</code> (升级版)</strong>:<br>这是前端改动的核心。<code>store</code> 不再只是一个简单的本地状态容器，它现在需要负责与后端进行异步通信，加载和管理会话数据。</p><ul><li><strong>新增 Actions</strong>:<ul><li><code>loadConversationsFromBackend()</code>: 在应用启动时调用，从后端获取所有会话的列表。</li><li><code>loadConversationHistory(conversationId)</code>: 当用户切换到一个会话时，如果该会话的消息尚未加载，则调用此方法从后端拉取完整的聊天记录。</li><li><code>deleteConversation(conversationId)</code>: 删除会话时，先调用后端的删除 API，成功后再更新本地状态。</li></ul></li><li><strong>修改现有 Actions</strong>:<ul><li><code>switchConversation(conversationId)</code>: 切换会话时，增加一步检查，如果历史记录未加载，则触发 <code>loadConversationHistory</code>。</li></ul></li></ul></li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { computed } <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> { <span class="title class_">ElMessage</span>, <span class="title class_">ElMessageBox</span> } <span class="keyword">from</span> <span class="string">'element-plus'</span>;</span><br><span class="line"><span class="keyword">import</span> { useConversationStore } <span class="keyword">from</span> <span class="string">'../stores/conversationStore'</span>;</span><br><span class="line"><span class="keyword">import</span> { storeToRefs } <span class="keyword">from</span> <span class="string">'pinia'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 会话管理 composable</span></span><br><span class="line"><span class="comment"> * 处理会话相关的UI交互逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useConversationManager</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useConversationStore</span>();</span><br><span class="line">    <span class="keyword">const</span> { conversationItems, currentConversation, currentConversationId } = <span class="title function_">storeToRefs</span>(store);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前选中的会话KEY（用于 Conversations 组件）</span></span><br><span class="line">    <span class="keyword">const</span> activeConversationKey = <span class="title function_">computed</span>({</span><br><span class="line">        <span class="attr">get</span>: <span class="function">() =&gt;</span> currentConversationId.<span class="property">value</span>,</span><br><span class="line">        <span class="attr">set</span>: <span class="title function_">async</span> (value) =&gt; {</span><br><span class="line">            <span class="keyword">if</span> (value &amp;&amp; value !== currentConversationId.<span class="property">value</span>) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="keyword">await</span> store.<span class="title function_">switchConversation</span>(value);</span><br><span class="line">                } <span class="keyword">catch</span> (error) {</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'切换会话失败:'</span>, error);</span><br><span class="line">                    <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">'切换会话失败'</span>);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前会话标题</span></span><br><span class="line">    <span class="keyword">const</span> currentConversationTitle = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="keyword">return</span> currentConversation.<span class="property">value</span>?.<span class="property">title</span> || <span class="string">'Spring AI 全栈聊天机器人'</span>;</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 会话切换处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleConversationChange</span> = <span class="keyword">async</span> (<span class="params">item</span>) =&gt; {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'会话切换:'</span>, item);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">await</span> store.<span class="title function_">switchConversation</span>(item.<span class="property">id</span>);</span><br><span class="line">            <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">`切换到: <span class="subst">${item.label}</span>`</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (error) {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'切换会话失败:'</span>, error);</span><br><span class="line">            <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">'切换会话失败'</span>);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新建会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleCreateNewConversation</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">        <span class="keyword">const</span> conversationId = store.<span class="title function_">createConversation</span>();</span><br><span class="line">        <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">'新建会话成功'</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'新建会话:'</span>, conversationId);</span><br><span class="line">        <span class="keyword">return</span> conversationId;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空当前会话历史</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClearCurrentHistory</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">ElMessageBox</span>.<span class="title function_">confirm</span>(</span><br><span class="line">            <span class="string">'确定要清空当前会话的所有消息吗？'</span>,</span><br><span class="line">            <span class="string">'确认清空'</span>,</span><br><span class="line">            {</span><br><span class="line">                <span class="attr">confirmButtonText</span>: <span class="string">'确定'</span>,</span><br><span class="line">                <span class="attr">cancelButtonText</span>: <span class="string">'取消'</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">'warning'</span>,</span><br><span class="line">            }</span><br><span class="line">        ).<span class="title function_">then</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            store.<span class="title function_">clearCurrentHistory</span>();</span><br><span class="line">            <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">'已清空当前会话历史'</span>);</span><br><span class="line">        }).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="comment">// 用户取消操作</span></span><br><span class="line">        });</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理会话菜单命令（重命名、删除）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleMenuCommand</span> = (<span class="params">command, item</span>) =&gt; {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'菜单命令:'</span>, command, item);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (command) {</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'rename'</span>:</span><br><span class="line">                <span class="title function_">handleRenameConversation</span>(item);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'delete'</span>:</span><br><span class="line">                <span class="title function_">handleDeleteConversation</span>(item);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">'未知的菜单命令:'</span>, command);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重命名会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleRenameConversation</span> = (<span class="params">item</span>) =&gt; {</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">ElMessageBox</span>.<span class="title function_">prompt</span>(<span class="string">'请输入新的会话名称'</span>, <span class="string">'重命名会话'</span>, {</span><br><span class="line">            <span class="attr">confirmButtonText</span>: <span class="string">'确定'</span>,</span><br><span class="line">            <span class="attr">cancelButtonText</span>: <span class="string">'取消'</span>,</span><br><span class="line">            <span class="attr">inputValue</span>: item.<span class="property">label</span>,</span><br><span class="line">            <span class="attr">inputPattern</span>: <span class="regexp">/^.{1,50}$/</span>,</span><br><span class="line">            <span class="attr">inputErrorMessage</span>: <span class="string">'会话名称长度必须在1-50个字符之间'</span></span><br><span class="line">        }).<span class="title function_">then</span>(<span class="function">(<span class="params">{ value }</span>) =&gt;</span> {</span><br><span class="line">            store.<span class="title function_">renameConversation</span>(item.<span class="property">id</span>, value);</span><br><span class="line">            <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">'重命名成功'</span>);</span><br><span class="line">        }).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="comment">// 用户取消操作</span></span><br><span class="line">        });</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleDeleteConversation</span> = (<span class="params">item</span>) =&gt; {</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">ElMessageBox</span>.<span class="title function_">confirm</span>(</span><br><span class="line">            <span class="string">`确定要删除会话 "<span class="subst">${item.label}</span>" 吗？此操作不可撤销。`</span>,</span><br><span class="line">            <span class="string">'确认删除'</span>,</span><br><span class="line">            {</span><br><span class="line">                <span class="attr">confirmButtonText</span>: <span class="string">'确定'</span>,</span><br><span class="line">                <span class="attr">cancelButtonText</span>: <span class="string">'取消'</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">'warning'</span>,</span><br><span class="line">            }</span><br><span class="line">        ).<span class="title function_">then</span>(<span class="title function_">async</span> () =&gt; {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">const</span> result = <span class="keyword">await</span> store.<span class="title function_">deleteConversation</span>(item.<span class="property">id</span>);</span><br><span class="line">                <span class="keyword">if</span> (result.<span class="property">success</span>) {</span><br><span class="line">                    <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(result.<span class="property">message</span> || <span class="string">'删除成功'</span>);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(result.<span class="property">message</span> || <span class="string">'删除失败'</span>);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">catch</span> (error) {</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'删除会话失败:'</span>, error);</span><br><span class="line">                <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">'删除会话失败: '</span> + error.<span class="property">message</span>);</span><br><span class="line">            }</span><br><span class="line">        }).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="comment">// 用户取消操作</span></span><br><span class="line">        });</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="comment">// 状态</span></span><br><span class="line">        conversationItems,</span><br><span class="line">        currentConversation,</span><br><span class="line">        currentConversationId,</span><br><span class="line">        activeConversationKey,</span><br><span class="line">        currentConversationTitle,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法</span></span><br><span class="line">        handleConversationChange,</span><br><span class="line">        handleCreateNewConversation,</span><br><span class="line">        handleClearCurrentHistory,</span><br><span class="line">        handleMenuCommand,</span><br><span class="line">        handleRenameConversation,</span><br><span class="line">        handleDeleteConversation</span><br><span class="line">    };</span><br><span class="line">} </span><br></pre></td></tr></tbody></table></figure><ul><li><strong><code>src/composables/useChat.js</code> 和 <code>useConversationManager.js</code> (升级版)</strong>:</li><li><strong><code>useChat.js</code></strong> 新增 <code>onMounted</code>生命周期钩子，在组件挂载时调用 <code>store</code> 中的 <code>initializeDefaultConversation</code>（或 <code>loadConversationsFromBackend</code>），实现应用启动时自动加载历史会话。<br>* <strong><code>useConversationManager.js</code></strong> 中的删除、切换等方法现在会调用 <code>store</code> 中对应的<strong>异步 action</strong>，并处理 <code>Promise</code> 的成功或失败状态，向用户显示如 <code>ElMessage</code> 的提示信息。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { ref, watch, computed, onMounted } <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> { useConversationStore } <span class="keyword">from</span> <span class="string">'../stores/conversationStore'</span>;</span><br><span class="line"><span class="keyword">import</span> { storeToRefs } <span class="keyword">from</span> <span class="string">'pinia'</span>;</span><br><span class="line"><span class="keyword">import</span> { streamChat } <span class="keyword">from</span> <span class="string">'../api/chat'</span>;</span><br><span class="line"><span class="keyword">import</span> { useXStream } <span class="keyword">from</span> <span class="string">'vue-element-plus-x'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聊天核心逻辑 composable</span></span><br><span class="line"><span class="comment"> * 处理消息发送、流式接收、状态管理等</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useChat</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 状态管理 - 使用新的会话管理系统</span></span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useConversationStore</span>();</span><br><span class="line">    <span class="keyword">const</span> { currentMessages, currentConversationId } = <span class="title function_">storeToRefs</span>(store);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输入消息</span></span><br><span class="line">    <span class="keyword">const</span> inputMessage = <span class="title function_">ref</span>(<span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 useXStream 处理流式数据</span></span><br><span class="line">    <span class="keyword">const</span> { startStream, cancel, isLoading, data, error } = <span class="title function_">useXStream</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算属性处理累积的流式数据</span></span><br><span class="line">    <span class="keyword">const</span> streamContent = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (!data.<span class="property">value</span>.<span class="property">length</span>) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> text = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; data.<span class="property">value</span>.<span class="property">length</span>; index++) {</span><br><span class="line">            <span class="keyword">const</span> chunk = data.<span class="property">value</span>[index];</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 检查chunk是否是对象且包含data属性</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> chunk === <span class="string">'object'</span> &amp;&amp; chunk !== <span class="literal">null</span> &amp;&amp; <span class="string">'data'</span> <span class="keyword">in</span> chunk) {</span><br><span class="line">                    <span class="comment">// 处理非空data</span></span><br><span class="line">                    <span class="keyword">if</span> (chunk.<span class="property">data</span>) {</span><br><span class="line">                        text += chunk.<span class="property">data</span>;</span><br><span class="line">                    } <span class="keyword">else</span> <span class="keyword">if</span> (chunk.<span class="property">data</span> === <span class="string">''</span>) {</span><br><span class="line">                        <span class="comment">// 空data块通常表示换行符</span></span><br><span class="line">                        text += <span class="string">'\n'</span>;</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> chunk === <span class="string">'string'</span>) {</span><br><span class="line">                    text += chunk;</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">'未知的chunk格式:'</span>, chunk);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">catch</span> (error) {</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'解析流数据时出错:'</span>, error);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> text;</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听流式数据更新，实时追加到消息中</span></span><br><span class="line">    <span class="title function_">watch</span>(streamContent, <span class="function">(<span class="params">newContent, oldContent</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (newContent &amp;&amp; newContent !== oldContent) {</span><br><span class="line">            <span class="comment">// 获取新增的内容部分</span></span><br><span class="line">            <span class="keyword">const</span> newChunk = newContent.<span class="title function_">slice</span>(oldContent?.<span class="property">length</span> || <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (newChunk) {</span><br><span class="line">                store.<span class="title function_">appendToLastMessage</span>(newChunk);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听错误信息</span></span><br><span class="line">    <span class="title function_">watch</span>(error, <span class="function">(<span class="params">errorInfo</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (errorInfo) {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"流式请求失败:"</span>, errorInfo);</span><br><span class="line">            store.<span class="title function_">appendToLastMessage</span>(<span class="string">"\n\n抱歉，处理您的请求时遇到了问题。"</span>);</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理用户提交消息</span></span><br><span class="line"><span class="comment">     * 使用 useXStream 处理流式接收</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleUserSubmit</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; {</span><br><span class="line">        <span class="keyword">const</span> messageContent = inputMessage.<span class="property">value</span>.<span class="title function_">trim</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证输入</span></span><br><span class="line">        <span class="keyword">if</span> (!messageContent || isLoading.<span class="property">value</span>) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 确保有当前会话ID</span></span><br><span class="line">        <span class="keyword">if</span> (!currentConversationId.<span class="property">value</span>) {</span><br><span class="line">            <span class="keyword">await</span> store.<span class="title function_">initializeDefaultConversation</span>();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 1. 添加用户消息到对话历史</span></span><br><span class="line">            store.<span class="title function_">addMessage</span>({</span><br><span class="line">                <span class="attr">role</span>: <span class="string">'user'</span>,</span><br><span class="line">                <span class="attr">content</span>: messageContent</span><br><span class="line">            });</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 清空输入框</span></span><br><span class="line">            inputMessage.<span class="property">value</span> = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 创建AI回复占位</span></span><br><span class="line">            store.<span class="title function_">addMessage</span>({</span><br><span class="line">                <span class="attr">role</span>: <span class="string">'assistant'</span>,</span><br><span class="line">                <span class="attr">content</span>: <span class="string">''</span></span><br><span class="line">            });</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 获取流式响应，传递当前会话ID</span></span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">streamChat</span>(messageContent, currentConversationId.<span class="property">value</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'发送请求，会话ID:'</span>, currentConversationId.<span class="property">value</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5. 使用 useXStream 处理流式数据</span></span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">startStream</span>({</span><br><span class="line">                <span class="attr">readableStream</span>: response.<span class="property">body</span></span><br><span class="line">            });</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">catch</span> (err) {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"发起流式请求失败:"</span>, err);</span><br><span class="line">            store.<span class="title function_">appendToLastMessage</span>(<span class="string">"\n\n抱歉，发起请求时遇到了问题。"</span>);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 组件挂载时初始化</span></span><br><span class="line">    <span class="title function_">onMounted</span>(<span class="title function_">async</span> () =&gt; {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">await</span> store.<span class="title function_">initializeDefaultConversation</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'会话初始化完成'</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (error) {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'会话初始化失败:'</span>, error);</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="comment">// 状态</span></span><br><span class="line">        <span class="attr">messages</span>: currentMessages, <span class="comment">// 返回当前会话的消息</span></span><br><span class="line">        <span class="attr">isGenerating</span>: isLoading, <span class="comment">// 使用 useXStream 的 isLoading 状态</span></span><br><span class="line">        inputMessage,</span><br><span class="line">        currentConversationId,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法</span></span><br><span class="line">        handleUserSubmit,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 流式处理相关</span></span><br><span class="line">        cancel <span class="comment">// 暴露取消功能</span></span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong><code>useConversationManager</code></strong></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { computed } <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> { <span class="title class_">ElMessage</span>, <span class="title class_">ElMessageBox</span> } <span class="keyword">from</span> <span class="string">'element-plus'</span>;</span><br><span class="line"><span class="keyword">import</span> { useConversationStore } <span class="keyword">from</span> <span class="string">'../stores/conversationStore'</span>;</span><br><span class="line"><span class="keyword">import</span> { storeToRefs } <span class="keyword">from</span> <span class="string">'pinia'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 会话管理 composable</span></span><br><span class="line"><span class="comment"> * 处理会话相关的UI交互逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useConversationManager</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useConversationStore</span>();</span><br><span class="line">    <span class="keyword">const</span> { conversationItems, currentConversation, currentConversationId } = <span class="title function_">storeToRefs</span>(store);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前选中的会话KEY（用于 Conversations 组件）</span></span><br><span class="line">    <span class="keyword">const</span> activeConversationKey = <span class="title function_">computed</span>({</span><br><span class="line">        <span class="attr">get</span>: <span class="function">() =&gt;</span> currentConversationId.<span class="property">value</span>,</span><br><span class="line">        <span class="attr">set</span>: <span class="title function_">async</span> (value) =&gt; {</span><br><span class="line">            <span class="keyword">if</span> (value &amp;&amp; value !== currentConversationId.<span class="property">value</span>) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="keyword">await</span> store.<span class="title function_">switchConversation</span>(value);</span><br><span class="line">                } <span class="keyword">catch</span> (error) {</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'切换会话失败:'</span>, error);</span><br><span class="line">                    <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">'切换会话失败'</span>);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前会话标题</span></span><br><span class="line">    <span class="keyword">const</span> currentConversationTitle = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="keyword">return</span> currentConversation.<span class="property">value</span>?.<span class="property">title</span> || <span class="string">'Spring AI 全栈聊天机器人'</span>;</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 会话切换处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleConversationChange</span> = <span class="keyword">async</span> (<span class="params">item</span>) =&gt; {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'会话切换:'</span>, item);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">await</span> store.<span class="title function_">switchConversation</span>(item.<span class="property">id</span>);</span><br><span class="line">            <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">`切换到: <span class="subst">${item.label}</span>`</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (error) {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'切换会话失败:'</span>, error);</span><br><span class="line">            <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">'切换会话失败'</span>);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新建会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleCreateNewConversation</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">        <span class="keyword">const</span> conversationId = store.<span class="title function_">createConversation</span>();</span><br><span class="line">        <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">'新建会话成功'</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'新建会话:'</span>, conversationId);</span><br><span class="line">        <span class="keyword">return</span> conversationId;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空当前会话历史</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClearCurrentHistory</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">ElMessageBox</span>.<span class="title function_">confirm</span>(</span><br><span class="line">            <span class="string">'确定要清空当前会话的所有消息吗？'</span>,</span><br><span class="line">            <span class="string">'确认清空'</span>,</span><br><span class="line">            {</span><br><span class="line">                <span class="attr">confirmButtonText</span>: <span class="string">'确定'</span>,</span><br><span class="line">                <span class="attr">cancelButtonText</span>: <span class="string">'取消'</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">'warning'</span>,</span><br><span class="line">            }</span><br><span class="line">        ).<span class="title function_">then</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            store.<span class="title function_">clearCurrentHistory</span>();</span><br><span class="line">            <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">'已清空当前会话历史'</span>);</span><br><span class="line">        }).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="comment">// 用户取消操作</span></span><br><span class="line">        });</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理会话菜单命令（重命名、删除）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleMenuCommand</span> = (<span class="params">command, item</span>) =&gt; {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'菜单命令:'</span>, command, item);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (command) {</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'rename'</span>:</span><br><span class="line">                <span class="title function_">handleRenameConversation</span>(item);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'delete'</span>:</span><br><span class="line">                <span class="title function_">handleDeleteConversation</span>(item);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">'未知的菜单命令:'</span>, command);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重命名会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleRenameConversation</span> = (<span class="params">item</span>) =&gt; {</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">ElMessageBox</span>.<span class="title function_">prompt</span>(<span class="string">'请输入新的会话名称'</span>, <span class="string">'重命名会话'</span>, {</span><br><span class="line">            <span class="attr">confirmButtonText</span>: <span class="string">'确定'</span>,</span><br><span class="line">            <span class="attr">cancelButtonText</span>: <span class="string">'取消'</span>,</span><br><span class="line">            <span class="attr">inputValue</span>: item.<span class="property">label</span>,</span><br><span class="line">            <span class="attr">inputPattern</span>: <span class="regexp">/^.{1,50}$/</span>,</span><br><span class="line">            <span class="attr">inputErrorMessage</span>: <span class="string">'会话名称长度必须在1-50个字符之间'</span></span><br><span class="line">        }).<span class="title function_">then</span>(<span class="function">(<span class="params">{ value }</span>) =&gt;</span> {</span><br><span class="line">            store.<span class="title function_">renameConversation</span>(item.<span class="property">id</span>, value);</span><br><span class="line">            <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">'重命名成功'</span>);</span><br><span class="line">        }).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="comment">// 用户取消操作</span></span><br><span class="line">        });</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除会话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleDeleteConversation</span> = (<span class="params">item</span>) =&gt; {</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">ElMessageBox</span>.<span class="title function_">confirm</span>(</span><br><span class="line">            <span class="string">`确定要删除会话 "<span class="subst">${item.label}</span>" 吗？此操作不可撤销。`</span>,</span><br><span class="line">            <span class="string">'确认删除'</span>,</span><br><span class="line">            {</span><br><span class="line">                <span class="attr">confirmButtonText</span>: <span class="string">'确定'</span>,</span><br><span class="line">                <span class="attr">cancelButtonText</span>: <span class="string">'取消'</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">'warning'</span>,</span><br><span class="line">            }</span><br><span class="line">        ).<span class="title function_">then</span>(<span class="title function_">async</span> () =&gt; {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">const</span> result = <span class="keyword">await</span> store.<span class="title function_">deleteConversation</span>(item.<span class="property">id</span>);</span><br><span class="line">                <span class="keyword">if</span> (result.<span class="property">success</span>) {</span><br><span class="line">                    <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(result.<span class="property">message</span> || <span class="string">'删除成功'</span>);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(result.<span class="property">message</span> || <span class="string">'删除失败'</span>);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">catch</span> (error) {</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'删除会话失败:'</span>, error);</span><br><span class="line">                <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">'删除会话失败: '</span> + error.<span class="property">message</span>);</span><br><span class="line">            }</span><br><span class="line">        }).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="comment">// 用户取消操作</span></span><br><span class="line">        });</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="comment">// 状态</span></span><br><span class="line">        conversationItems,</span><br><span class="line">        currentConversation,</span><br><span class="line">        currentConversationId,</span><br><span class="line">        activeConversationKey,</span><br><span class="line">        currentConversationTitle,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法</span></span><br><span class="line">        handleConversationChange,</span><br><span class="line">        handleCreateNewConversation,</span><br><span class="line">        handleClearCurrentHistory,</span><br><span class="line">        handleMenuCommand,</span><br><span class="line">        handleRenameConversation,</span><br><span class="line">        handleDeleteConversation</span><br><span class="line">    };</span><br><span class="line">} </span><br></pre></td></tr></tbody></table></figure><p>通过以上改造，我们的应用流程变为：</p><ol><li><strong>应用启动</strong>: <code>onMounted</code> 触发，<code>store</code> 调用后端 <code>/api/chat-history/conversations</code> 接口，获取所有会话的概要信息并展示在左侧列表。</li><li><strong>切换会话</strong>: 用户点击会话列表项，<code>store</code> 检查该会话的详细消息是否已加载。若未加载，则调用 <code>/api/chat-history/conversation/{id}</code> 接口获取数据，然后更新界面。</li><li><strong>删除会话</strong>: 用户点击删除，<code>store</code> 调用后端 <code>DELETE</code> 接口，成功后从本地 <code>state</code> 中移除该会话。</li></ol><p>至此，我们的聊天应用不再是一个“健忘”的工具，而是一个功能完备、数据持久、体验流畅的全栈应用。</p></div></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/16/684f747174bc3.webp" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/16/684f747174bc3.webp" title="头像" alt="头像"></a><div class="post-copyright__author_name">Prorise</div><div class="post-copyright__author_desc">这聒噪的世界让沉默的人显得另类</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://prorise-cool.github.io/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%89-%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F-api-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl(&quot;https://prorise-cool.github.io/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%89-%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F-api-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/&quot;)">Java微服务（三）：3. 核心抽象 API 深度解析</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/bYMH/418X445/ef9a3f68-d36a-441a-95fe-8179b1a25992.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/bYMH/418X445/ef9a3f68-d36a-441a-95fe-8179b1a25992.png" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/cYu3/347X390/zfb.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/cYu3/347X390/zfb.png" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display:none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://prorise-cool.github.io/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%89-%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F-api-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Java微服务（三）：3. 核心抽象 API 深度解析&amp;url=https://prorise-cool.github.io/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%89-%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F-api-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/&amp;pic=https://bu.dusays.com/2025/06/19/68535b23089d0.webp" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Prorise-cool.github.io" target="_blank">格物致知</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Java%E5%BE%AE%E6%9C%8D%E5%8A%A1-AI%E7%AF%87/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>Java微服务-AI篇<span class="tagsPageCount">4</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2025/06/19/68535b23089d0.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%9B%9B-%E6%B7%B1%E5%85%A5-prompt-%E5%B7%A5%E7%A8%8B/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/19/68535b23089d0.webp" onerror="onerror=null,src=&quot;/img/404.jpg&quot;" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Java微服务（四）：4. 深入 Prompt 工程</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%80%E5%BA%8F%E7%AB%A0%E8%BF%8E%E6%8E%A5-java-ai-%E5%BC%80%E5%8F%91%E6%96%B0%E7%BA%AA%E5%85%83/" title="Java微服务（一）：1. 序章：迎接 Java AI 开发新纪元"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/19/68535b23089d0.webp" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-06-17</div><div class="title">Java微服务（一）：1. 序章：迎接 Java AI 开发新纪元</div></div></a></div><div><a href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BA%8C-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%9E%84%E5%BB%BA%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-ai-%E5%BA%94%E7%94%A8/" title="Java微服务（二）：2. 快速入门：构建你的第一个 AI 应用"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/19/68535b23089d0.webp" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-06-18</div><div class="title">Java微服务（二）：2. 快速入门：构建你的第一个 AI 应用</div></div></a></div><div><a href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%9B%9B-%E6%B7%B1%E5%85%A5-prompt-%E5%B7%A5%E7%A8%8B/" title="Java微服务（四）：4. 深入 Prompt 工程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/19/68535b23089d0.webp" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-06-20</div><div class="title">Java微服务（四）：4. 深入 Prompt 工程</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" rel="external nofollow noreferrer">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Waline</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div><script>window.postData = {
  title: "Java微服务（三）：3. 核心抽象 API 深度解析",
  date: "2025-06-21 10:44:31",
  updated: "2025-06-21 17:51:53",
  tags: ["Java微服务-AI篇"],
  categories: ["后端技术","Java"],
  content: "\n## 3. 对话核心 API 深度解析\n\n> **重点说明：**该教程前端部分无需细扣，真正的前端实战会在后面，目前的前端功能直接复制过去，没有必要去读源码，明白后端如何调用前端即可，因为目前的前端还不够规范！仅为示例！！\n\n在快速入门章节中，我们已经初步体验了 `ChatClient` 的便捷。现在，是时候深入水面之下，探索 Spring AI 设计的基石——核心抽象 API。Spring AI 的“可移植性”设计哲学，正是通过这层优雅的抽象实现的。无论你面对的是 OpenAI、Azure、Ollama 还是未来的任何新模型，你的业务代码始终与一套稳定、统一的接口对话。本章，我将带你逐一解构这些核心接口：`ChatClient`, `ImageClient`, 和 `EmbeddingClient`。\n\n### 3.1 `ChatClient`: 对话的核心枢纽\n\n`ChatClient` 是你与大语言模型（LLM）进行对话交互的唯一入口。它将底层不同厂商 API 的复杂性（如不同的认证方式、请求/响应格式、错误处理）完全封装，为你提供了一个极其简洁和统一的编程模型。\n\n它的核心职责是：发送一个包含上下文和指令的 `Prompt`，并接收模型生成的 `ChatResponse`。这个过程可以通过两种方式完成：同步 (`call`) 和流式 (`stream`)。\n\n#### 3.1.1 `call()` vs. `stream()`: 同步与流式的抉择\n\n`call()` 和 `stream()` 方法是 `ChatClient` 的两个主要动作，它们服务于不同的交互场景。\n\n*   **`call()` (同步调用)**: 这是最直接的方式。你的应用发送请求后会一直等待，直到模型生成完整的响应后一次性返回。它简单、易于处理，适用于那些不需要实时反馈、可以接受短暂等待的场景。\n*   **`stream()` (流式调用)**: 这种方式会立即返回一个 `Flux<ChatResponse>`（来自 Project Reactor 的响应式流）。模型会像打字机一样，逐个 Token（可以理解为单词或字符块）地将内容推送回来。你的应用可以实时接收并处理这些数据片段。这极大地提升了用户体验，尤其是在构建交互式聊天机器人时。\n\n下表清晰地对比了两种方法的差异：\n\n| 特性 | `.call()` 方法 | `.stream()` 方法 |\n| :--- | :--- | :--- |\n| **方法签名** | `ChatResponse call(Prompt prompt)` | `Flux<ChatResponse> stream(Prompt prompt)` |\n| **返回类型** | `ChatResponse` (单个响应对象) | `Flux<ChatResponse>` (响应式数据流) |\n| **执行模式** | 同步阻塞 | 异步非阻塞 |\n| **数据返回** | 一次性返回完整内容 | 逐步、分块返回内容 |\n| **典型用例** | - 后台任务处理（如生成报告、总结邮件）<br>- API 中简单的问答<br>- 数据提取与转换 | - 交互式聊天机器人界面（打字机效果）<br>- 需要处理长文本响应的应用<br>- 对实时性要求高的场景 |\n| **编程模型** | 传统命令式编程 | 响应式编程 (Reactive) |\n\n#### 3.1.2 `ChatClient` 实战代码\n\n让我们通过一个简单的例子，看看如何在代码中使用 `ChatClient`。我们定义一个新的包`service`，通过Controller来调用`ChatService`，它既能提供一次性的答案，也能提供流式输出，在这之前我们有必要说明一下我们接下来会用到的两个方法，分别是`chatResponse()`和`content()`的区别\n\n我用一个表格来清晰地展示它们的区别：\n\n| 特性 (Feature) | `.stream().content()`                                        | `.stream().chatResponse()`                                   |\n| :------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |\n| **返回类型**   | `Flux<String>`                                               | `Flux<ChatResponse>`                                         |\n| **流中内容**   | 纯文本字符串片段 (`String`)。例如：`\"今天\"`、`\"天气\"`、`\"不错\"`。 | 完整的响应对象 (`ChatResponse`)。                            |\n| **信息丰富度** | **基础**：只包含AI生成的文字。                               | **丰富**：每个 `ChatResponse` 对象都包含：1.AI生成的文本片段 2.Token消耗信息 (实时或最终)3.对话结束原因 (`finishReason`) 4.模型ID等其他元数据 |\n| **性能开销**   | **极低**：网络传输和内存占用都最小，只传递最必要的信息。     | **略高**：传输的数据包更大，因为包含了元数据，需要创建更多Java对象。 |\n| **适用场景**   | **绝大多数场景**。例如，在前端像打字机一样流式显示AI的回答。 | **高级或需要监控的场景**。例如：\\<br\\> - 你需要实时计算和显示Token消耗。\\<br\\> - 你需要根据`finishReason`判断对话是因为内容生成完毕(`stop`)还是因为达到了长度限制(`length`)而结束。 |\n\n  * 如果你**只关心AI说了什么**，那么使用 **`.content()`**。它最简单、最高效，能满足90%的需求。\n  * 如果你不仅关心AI说了什么，还**关心它“是怎么说的”**（比如消耗了多少资源、为什么停止等），那么使用 **`.chatResponse()`**。\n\n对于前端流式打字机效果，`.content()` 是完美的选择。对于需要精细控制或监控的后端服务，`.chatResponse()` 则提供了更强大的能力。\n\n```java\npackage com.example.hellospringai.service;\n\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\nimport reactor.core.publisher.Flux;\n\n@Service\npublic class ChatService {\n\n    private final ChatClient chatClient;\n\n    // 通过构造函数注入由 Spring Boot 自动配置好的 ChatClient.Builder\n    @Autowired\n    public ChatService(ChatClient.Builder chatClientBuilder) {\n        this.chatClient = chatClientBuilder.build();\n    }\n\n    /**\n     * 同步调用示例：一次性获取 AI 的完整回答\n     * @param message 用户的提问\n     * @return AI 生成的完整文本内容\n     */\n    public String getSimpleResponse(String message) {\n        // .prompt() 是一个便捷的流式 API 入口，用于快速构建和发送请求\n        // .user() 指定了用户角色的消息\n        // .call() 发起同步调用\n        // .content() 是一个快捷方法，用于直接从 ChatResponse 中提取文本内容\n        return chatClient.prompt()\n                .user(message)\n                .call()\n                .content();\n    }\n\n    /**\n     * 流式调用示例：返回一个可以逐块消费的响应流\n     * @param message 用户的提问\n     * @return 一个包含 ChatResponse 片段的 Flux 流\n     */\n    public Flux<ChatResponse> getStreamResponse(String message) {\n        // .stream() 发起流式调用，它会立即返回一个 Flux 对象\n        // 调用者可以订阅这个 Flux 来处理陆续到达的数据\n        return chatClient.prompt()\n                .user(message)\n                .stream()\n                .chatResponse();\n    }\n\n    /**\n     * 流式内容调用：返回纯文本内容的响应流\n     * @param message 用户的提问\n     * @return 一个包含文本内容片段的 Flux 流\n     */\n    public Flux<String> getStreamContent(String message) {\n        return chatClient.prompt()\n                .user(message)\n                .stream()\n                .content();\n    }\n}\n```\n\n对于**`ChatController.java`**我们进行如下的改变\n\n```java\npackage com.example.hellospringai.controller;\n\nimport com.example.hellospringai.service.ChatService;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport reactor.core.publisher.Flux;\n\n@RestController\n@RequestMapping(\"/ai\")\npublic class ChatController {\n\n    private final ChatService chatService;\n\n    public ChatController(ChatService chatService) {\n        this.chatService = chatService;\n    }\n\n    /**\n     * 定义一个 GET 请求接口，以现代、响应式的方式流式输出 AI 回答\n     * @param message 接收来自 URL 的查询参数\n     * @return 一个包含 AI 回答文本块的响应式数据流 (Flux)\n     */\n    @GetMapping(value = \"/chat\", produces = \"text/html;charset=utf-8\") // 这里必须指定编码，否则中文将无法正确编码\n    public Flux<String> streamChat(@RequestParam(value = \"message\", defaultValue = \"你是谁？\") String message) {\n        // 通过 ChatService 处理流式聊天请求\n        return chatService.getStreamContent(message);\n    }\n\n    /**\n     * 同步聊天接口，一次性返回完整的 AI 回答\n     * @param message 接收来自 URL 的查询参数\n     * @return AI 生成的完整文本内容\n     */\n    @GetMapping(value = \"/chat-sync\", produces = \"text/html;charset=utf-8\")\n    public String syncChat(@RequestParam(value = \"message\", defaultValue = \"你是谁？\") String message) {\n        // 通过 ChatService 处理同步聊天请求\n        return chatService.getSimpleResponse(message);\n    }\n\n    /**\n     * 流式聊天接口，返回包含更多元数据的 ChatResponse 流\n     * @param message 接收来自 URL 的查询参数\n     * @return 一个包含 ChatResponse 对象的响应式数据流 (Flux)\n     */\n    @GetMapping(value = \"/chat-response\", produces = \"application/json;charset=utf-8\")\n    public Flux<ChatResponse> streamChatResponse(@RequestParam(value = \"message\", defaultValue = \"你是谁？\") String message) {\n        // 通过 ChatService 处理流式 ChatResponse 请求\n        return chatService.getStreamResponse(message);\n    }\n}\n```\n\n#### 3.1.3 小结：如何访问和测试API\n\n现在我们已经定义好了 `ChatService` 业务类和 `ChatController` 控制器，一个功能完备的AI聊天后端服务就绪了。启动你的 `HelloSpringAiApplication` 主应用类，接下来，我将指导你如何通过常见的工具访问我们创建的三个API接口。\n\n测试这些接口最便捷的工具是你的**网页浏览器**和命令行工具 **`curl`**。\n\n下表总结了每个接口的访问方式和预期效果：\n\n| 接口功能 | 访问 URL 示例 | 推荐测试方法 | 预期输出 |\n| :--- | :--- | :--- | :--- |\n| **流式返回纯文本**\\<br\\>(打字机效果) | `http://localhost:8080/ai/chat?message=你好世界` | **浏览器**或 **`curl -N`** | 纯文本的流式输出，文字会像打字机一样逐个出现。 |\n| **同步返回完整文本** | `http://localhost:8080/ai/chat-sync?message=你好世界` | **浏览器**或 **`curl`** | 等待片刻后，浏览器页面上一次性显示完整的AI回复文本。 |\n| **流式返回JSON对象** | `http://localhost:8080/ai/chat-response?message=你好世界` | **`curl -N`** | 连续的JSON对象流。每个对象都是一个`ChatResponse`的内容。 |\n\n1.  **测试流式文本接口 (`/ai/chat`)**\n\n      * **浏览器**：这是最直观的方式。直接在浏览器地址栏输入 `http://localhost:8080/ai/chat?message=请介绍一下长城` 并回车。你会看到浏览器的加载动画会持续旋转，同时页面上的文字会不断地动态增加，直到AI回答完毕。\n      * **curl**：在你的命令行终端中输入以下命令：\n        ```bash\n        curl -N \"http://localhost:8080/ai/chat?message=请介绍一下长城\"\n        ```\n        `  -N ` 参数告诉 `curl` 不要使用缓冲，立刻将接收到的数据显示在终端上，你将看到文字逐行或逐块打印出来。\n\n2.  **测试同步文本接口 (`/ai/chat-sync`)**\n\n      * **浏览器**：在地址栏输入 `http://localhost:8080/ai/chat-sync?message=中国的首都是哪里`。页面会加载一小会儿，然后一次性显示出完整答案，例如“中国的首都是北京。”。\n      * **curl**：\n        ```bash\n        curl \"http://localhost:8080/ai/chat-sync?message=中国的首都是哪里\"\n        ```\n        终端会等待几秒，然后直接打印出完整的回复。\n\n3.  **测试流式JSON接口 (`/ai/chat-response`)**\n\n      * **浏览器**：不推荐使用浏览器直接访问这个接口。由于返回的是 `application/json` 的事件流，大多数浏览器会尝试下载一个文件，或者无法正确地渲染持续到来的JSON对象。\n      * **curl**：这是观察其原始输出的最佳方式。\n        ```bash\n        curl -N \"http://localhost:8080/ai/chat-response?message=你好\"\n        ```\n        你会在终端看到一系列连续输出的JSON对象，每个对象之间可能有换行。每一个对象都是一个独立的 `ChatResponse` 序列化后的结果，格式可能如下所示：\n        ```json\n        {\"generation\":{\"content\":\"你\"},\"metadata\":{\"finishReason\":\"STOP\",\"usage\":{\"promptTokens\":11,\"completionTokens\":1,\"totalTokens\":12}}}\n        {\"generation\":{\"content\":\"好\"},\"metadata\":{\"finishReason\":\"STOP\",\"usage\":{\"promptTokens\":11,\"completionTokens\":2,\"totalTokens\":13}}}\n        ...\n        ```\n\n通过以上方法，你可以清晰地观察到同步与流式、返回纯文本与返回完整响应对象之间的差异。建议你亲自尝试，并使用浏览器的开发者工具（F12 -\\> Network标签页）来观察不同请求的响应头（Headers）和响应体（Response），这会让你对HTTP协议和API设计有更深刻的理解。\n\n-----\n\n### **3.2 调试与洞察：`Advisor` 与日志**\n\n到目前为止，我们已经构建了功能强大的 `ChatClient`。但当AI的回答不符合预期时，我们如何知道发送给模型的完整提示（Prompt）到底是什么样的？例如，我们通过 `.defaultSystem()` 配置的全局指令，是如何与我们当前的用户问题组合在一起的？\n\n为了解决这个“黑盒”问题，Spring AI 提供了 **`Advisor`（顾问）**机制。\n\n`Advisor` 就像是安装在 `ChatClient` 请求/响应链路上的“拦截器”或“中间件”。它允许我们在请求发送给AI之前对其进行修改或审查，并在收到AI响应后进行处理。Spring AI 提供了一些非常有用的内置顾问，本节我们将学习其中用于调试的：**`SimpleLoggerAdvisor`**。\n\n`SimpleLoggerAdvisor` 是一个专门用于**调试**的工具。它的唯一职责就是将发送给大语言模型的**最终请求（完整Prompt）**和从模型那里收到的**原始响应**，以`DEBUG`或`TRACE`级别打印到控制台日志中。\n\n这为我们提供了一个强大的“窥镜”，可以清晰地看到每一次交互的全部细节。\n\n**1. 在项目中引入日志顾问**\n\n要使用 `SimpleLoggerAdvisor`，我们需要完成两步配置。\n\n**第一步：启用 DEBUG 日志**\n\n我们需要告诉 Spring Boot 的日志系统，我们希望看到来自 `advisor` 的详细调试信息。\n\n在 `application.yml` 文件中添加 `logging.level` 配置：\n\n```yaml\n# src/main/resources/application.yml\nspring:\n  ai:\n    openai:\n      base-url: https://api.deepseek.com\n      api-key: \"sk-xxxx\"\n      chat:\n        options:\n          model: deepseek-chat\n          temperature: 0.7\n\n# 新增：配置日志级别\nlogging:\n  level:\n    # 将 advisor 包的日志级别设为 DEBUG，以激活 SimpleLoggerAdvisor 的输出\n    org.springframework.ai.chat.client.advisor: DEBUG\n    # 同时将我们自己应用的包也设为 DEBUG，方便观察\n    com.example.hellospringai: DEBUG\n```\n\n**第二步：在 `ChatClient` 中配置日志顾问**\n\n接下来，我们修改 `CommonConfiguration.java`，在构建 `ChatClient` 时，将 `SimpleLoggerAdvisor` 作为默认顾问添加进去。\n\n```java\n// 文件路径: src/main/java/com/example/hellospringai/config/CommonConfiguration.java\npackage com.example.hellospringai.config;\n\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\n@Configuration\npublic class CommonConfiguration {\n\n    @Bean\n    public ChatClient chatClient(ChatModel chatModel) {\n        return ChatClient.builder(chatModel)\n                .defaultSystem(\"你是一个由Prorise创作出来的AI大模型，名字叫做小P，请你在以后的回复中以新的身份和语气回复我\")\n                // 关键：将 SimpleLoggerAdvisor 添加为默认顾问\n                .defaultAdvisors(new SimpleLoggerAdvisor())\n                .build();\n    }\n}\n```\n\n**2. 观察日志输出**\n\n完成以上配置并重启应用后，调用任一聊天接口，例如访问 `http://localhost:8080/ai/chat?message=你好`。\n\n现在，请观察您的IDE控制台，您会看到类似下面这样的详细 `DEBUG` 日志输出：\n\n```log\nDEBUG --- [nio-8080-exec-1] o.s.a.c.c.a.SimpleLoggerAdvisor        : \n--- Request:\n[\n  {\n    \"messageType\": \"SYSTEM\",\n    \"content\": \"你是一个由Prorise创作出来的AI大模型，名字叫做小P，请你在以后的回复中以新的身份和语气回复我\"\n  },\n  {\n    \"messageType\": \"USER\",\n    \"content\": \"你好\"\n  }\n]\n--- Response:\n{\n  \"messageType\": \"ASSISTANT\",\n  \"content\": \"你好！我是小P，很高兴能为您服务。有什么可以帮助您的吗？\"\n}\n```\n\n**日志解读：**\n* **`--- Request:`**: 这部分清晰地展示了最终发送给大语言模型的完整消息列表。我们可以清楚地看到，我们配置的 `defaultSystem` 系统提示和用户的 `你好` 被正确地组合在了一起。\n* **`--- Response:`**: 这部分展示了AI模型返回的原始`Assistant`消息内容。\n\n通过 `SimpleLoggerAdvisor`，我们获得了对 `ChatClient` 内部通信的完全可见性，这在进行 Prompt Engineering（提示词工程）和问题排查时是不可或缺的利器。\n\n\n\n---\n\n### 3.3 前端环境搭建\n\n本节将快速搭建一个基于 **Vue 3 + Vite + Tailwind CSS + DaisyUI + Element Plus** 的前端开发环境。\n\n#### 3.3.1 初始化 Vue 3 项目\n\n首先，使用 Vite 和 pnpm 创建并初始化项目。\n\n```bash\n# 1. 使用 Vite 创建项目\npnpm create vite spring-app --template vue\n\n# 2. 进入目录并安装基础依赖\ncd spring-app\npnpm install\n```\n\n#### 3.3.2 集成 Tailwind CSS\n\n接下来，为项目添加 Tailwind CSS 并完成基础配置。\n\n**1. 安装依赖**\n```bash\npnpm install -D tailwindcss@3.4.1 postcss autoprefixer\n```\n\n**2. 生成配置文件**\n```bash\nnpx tailwindcss init -p\n```\n\n**3. 更新配置与样式文件**\n\n* **`tailwind.config.js`**:\n    ```javascript\n    /** @type {import('tailwindcss').Config} */\n    export default {\n      content: [\n        \"./index.html\",\n        \"./src/**/*.{vue,js,ts,jsx,tsx}\",\n      ],\n      theme: {\n        extend: {},\n      },\n      plugins: [],\n    }\n    ```\n* **`src/assets/style/main.css`** (如果目录不存在请创建):\n    ```css\n    @tailwind base;\n    @tailwind components;\n    @tailwind utilities;\n    ```\n\n#### 3.3.3 集成 UI 组件库 (DaisyUI & Element Plus)\n\n**1. 安装依赖**\n\n```bash\n# 安装 DaisyUI 作为开发依赖\npnpm add -D daisyui\n\n# 安装 Element Plus 作为生产依赖\npnpm add element-plus\n```\n\n**2. 在 `tailwind.config.js` 中启用 DaisyUI**\n\n```javascript\n// tailwind.config.js\n/** @type {import('tailwindcss').Config} */\nexport default {\n  content: [\n    \"./index.html\",\n    \"./src/**/*.{vue,js,ts,jsx,tsx}\",\n  ],\n  theme: {\n    extend: {},\n  },\n  plugins: [\n    require('daisyui'), // 添加 DaisyUI 插件\n  ],\n  // (可选) DaisyUI 主题等配置\n  daisyui: {\n    themes: [\"light\", \"dark\", \"cupcake\"], // 启用的主题列表，可按需选择\n    // styled: true,         // DaisyUI 组件类是否默认应用 (默认为 true)\n    // base: true,           // 是否应用 DaisyUI 基础样式 (默认为 true)\n    // utils: true,          // 是否应用 DaisyUI 工具类 (默认为 true)\n    // logs: true,           // 是否在控制台显示 DaisyUI 日志 (默认为 true)\n  },\n}\n```\n\n#### 3.3.4 主程序入口配置 (`main.js`)\n\n这是非常关键的一步。我们将更新 `src/main.js` 文件，它会**同时引入 Tailwind CSS 的基础样式**并**全局注册 Element Plus 插件**，确保所有功能都准备就绪。\n\n```javascript\n// src/main.js\nimport { createApp } from 'vue'\nimport './assets/style/main.css' // 引入 tailwindcss 样式\n\nimport ElementPlus from 'element-plus'\nimport 'element-plus/dist/index.css' // 引入 Element Plus 的 CSS\n\nimport App from './App.vue'\n\nconst app = createApp(App)\n\napp.use(ElementPlus) // 注册 Element Plus 插件\napp.mount('#app')\n```\n\n\n\n### 3.4 阶段小实战：构建企业级AI对话界面\n\n在 `3.3` 的基础上，本节将通过安装专业级组件库、创建标准化的目录结构，并填充模块化的核心代码，一步步完整实现一个功能强大、结构清晰的聊天机器人前端应用，我们保持后端的代码简洁，如下\n\n**`ChatController.java`**\n\n```java\npackage com.example.hellospringai.controller;\n\nimport com.example.hellospringai.service.ChatService;\nimport org.springframework.ai.chat.model.ChatResponse;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport reactor.core.publisher.Flux;\n\n@RestController\n@RequestMapping(\"/ai\")\npublic class ChatController {\n\n    private final ChatService chatService;\n\n    public ChatController(ChatService chatService) {\n        this.chatService = chatService;\n    }\n\n    /**\n     * 定义一个 GET 请求接口，以现代、响应式的方式流式输出 AI 回答\n     * @param message 接收来自 URL 的查询参数\n     * @return 一个包含 AI 回答文本块的响应式数据流 (Flux)\n     */\n    @GetMapping(value = \"/chat\", produces = \"text/event-stream;charset=utf-8\") // 修改为流式响应格式\n    public Flux<String> streamChat(@RequestParam(value = \"message\", defaultValue = \"你是谁？\") String message) {\n        // 通过 ChatService 处理流式聊天请求\n        return chatService.getStreamContent(message);\n    }\n\n}\n```\n\n**`ChatService.java`**\n\n```java\npackage com.example.hellospringai.service;\n\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.stereotype.Service;\nimport reactor.core.publisher.Flux;\n\n@Service\npublic class ChatService {\n\n    private final ChatClient chatClient;\n\n    public ChatService(ChatClient chatClient) {\n        this.chatClient = chatClient;\n    }\n\n    /**\n     * 流式内容调用：返回纯文本内容的响应流\n     * @param message 用户的提问\n     * @return 一个包含文本内容片段的 Flux 流\n     */\n    public Flux<String> getStreamContent(String message) {\n        return chatClient.prompt()\n                .user(message)\n                .stream()\n                .content();\n    }\n\n\n}\n```\n\n\n\n#### 3.4.1 核心依赖补全\n\n`3.2` 节中我们安装了基础UI库，现在我们需要补全应用逻辑所必需的核心库，包括状态管理、路由、工具函数以及本次实战的主角——专业的AI对话组件库。\n\n```bash\n# 安装 Pinia (状态管理), Axios (网络请求)\npnpm install pinia axios\n\n# 安装 Vue Router 和 VueUse (组合式函数工具库)\npnpm add vue-router @vueuse/core\n\n# 安装 vue-element-plus-x (提供高级AI对话组件)\npnpm install vue-element-plus-x\n```\n\n#### 3.3.2 项目目录结构创建\n\n一个良好、清晰的目录结构是大型项目的基石。在 `src` 目录下，执行以下命令创建我们规划好的所有子目录。\n\n```bash\n# 在 src 目录下一次性创建所有规划好的文件夹\nmkdir src/api, src/assets/style, src/components/common, src/composables, src/router, src/stores, src/utils, src/views\n```\n执行后，你的 `src` 目录结构应如下所示：\n```\nsrc/\n├── api/\n├── assets/\n│   └── style/\n├── components/\n│   └── common/\n├── composables/\n├── router/\n├── stores/\n├── utils/\n└── views/\n```\n\n#### 3.4.3 核心代码实现\n\n现在，我们按照从底层数据、逻辑到上层视图的顺序，依次填充每个文件。\n\n##### 0.处理API请求（Axios）\n\n**`/utils/request.js`**\n\n```js\nimport axios from 'axios';\n\nconst service = axios.create({\n  baseURL: 'http://localhost:8080', \n  timeout: 30000,\n});\n\nexport default service;\n```\n\n**`/api/chat.js`**\n\n核心API接口\n\n```js\nimport request from '../utils/request';\n\n/**\n * 以流式方式获取AI回答\n * @param {string} message - 用户消息\n * @returns {Promise<Response>} 返回一个支持流式读取的 Response 对象\n */\nexport function streamChat(message) {\n  // 使用封装好的 axios 发送请求，通过 fetch 处理流式响应\n  // 保持项目中请求方式的统一性\n  const url = `${request.defaults.baseURL}/ai/chat?message=${encodeURIComponent(message)}`;\n  return fetch(url, {\n    method: 'GET',\n    headers: {\n      'Accept': 'text/event-stream',\n      'Content-Type': 'application/json'\n    }\n  });\n}\n```\n\n\n\n##### **1. 状态管理层 (Pinia)**\n\n`src/stores/conversationStore.js` 文件负责以UI组件库（`vue-element-plus-x`）所需的标准格式来存储和管理对话数据。\n\n```javascript\n// 这是一个使用 Pinia 状态管理库创建的对话存储模块\nimport { defineStore } from 'pinia';\n\n// 导出一个名为 'conversation' 的状态存储，用于管理聊天对话的状态\nexport const useConversationStore = defineStore('conversation', {\n  // 定义存储的状态数据\n  state: () => ({\n    messages: [],       // 存储BubbleList格式的消息数组\n    nextMessageId: 0,   // 消息ID计数器\n  }),\n\n  // 定义可以修改状态的操作方法\n  actions: {\n    // 添加一条新消息到对话历史中\n    addMessage({ role, content = '' }) {\n      const messageRole = role === 'user' ? 'user' : 'ai';\n      const placement = messageRole === 'ai' ? 'start' : 'end';\n      const variant = messageRole === 'ai' ? 'filled' : 'outlined';\n      const avatar = messageRole === 'ai'\n        ? 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png'\n        : 'https://avatars.githubusercontent.com/u/76239030?v=4';\n      // 创建符合 BubbleList 组件要求的消息对象\n      const bubbleMessage = {\n        key: this.nextMessageId++,         // 唯一标识\n        role: messageRole,                 // user | ai 角色定义\n        placement,                         // start | end 气泡位置\n        content,                          // 消息内容，流式接收时只需要改这个值即可\n        loading: false,                   // 当前气泡的加载状态\n        shape: 'corner',                  // 气泡的形状\n        variant,                          // 气泡的样式\n        isMarkdown: true,                 // 是否渲染为 markdown\n        typing: false,                    // 是否开启打字器效果，该属性不会和流式接收冲突\n        isFog: messageRole === 'ai',      // 是否开启打字雾化效果，该效果 v1.1.6 新增，且在 typing 为 true 时生效，该效果会覆盖 typing 的 suffix 属性\n        avatar,                           // 头像\n        avatarSize: '36px',               // 头像占位大小\n        avatarGap: '12px',                // 头像与气泡之间的距离\n      };\n\n      this.messages.push(bubbleMessage);\n    },\n\n    // 向最后一条消息追加内容（用于流式接收AI回复）\n    appendToLastMessage(contentChunk) {\n      // 如果没有消息则直接返回\n      if (this.messages.length === 0) return;\n\n      // 获取最后一条消息\n      const lastMessage = this.messages[this.messages.length - 1];\n\n      // 只有当最后一条消息是AI助手的回复时才追加内容\n      if (lastMessage.role === 'ai') {\n        lastMessage.content += contentChunk;\n      }\n    },\n\n\n\n    // 清空对话历史\n    clearHistory() {\n      this.messages = [];\n    }\n  },\n});\n```\n\n##### **2. 可组合函数 (Composables)**\n\n我们将不同的逻辑关注点分离到独立的 `composable` 函数中，以实现最大程度的复用和解耦。\n\n* **`src/composables/useChat.js`** (聊天核心逻辑)\n    ```javascript\n    import { ref, watch, computed } from 'vue';\n    import { useConversationStore } from '../stores/conversationStore';\n    import { storeToRefs } from 'pinia';\n    import { streamChat } from '../api/chat';\nimport { useXStream } from 'vue-element-plus-x';\n    \n    /**\n     * 聊天核心逻辑 composable\n     * 处理消息发送、流式接收、状态管理等\n     */\n    export function useChat() {\n        // 状态管理\n        const store = useConversationStore();\n        const { messages } = storeToRefs(store);\n    \n        // 会话ID和输入消息\n        const sessionId = ref(`session_${Date.now()}`);\n        const inputMessage = ref('');\n    \n        // 使用 useXStream 处理流式数据\n        const { startStream, cancel, isLoading, data, error } = useXStream();\n    \n        // 计算属性处理累积的流式数据\n        const streamContent = computed(() => {\n            if (!data.value.length) return '';\n    \n            let text = '';\n            for (let index = 0; index < data.value.length; index++) {\n                const chunk = data.value[index];\n                try {\n                    // 检查chunk是否是对象且包含data属性\n                    if (typeof chunk === 'object' && chunk !== null && 'data' in chunk) {\n                        // 只有当data不为空时才添加\n                        if (chunk.data) {\n                            text += chunk.data;\n                        }\n                        // 空data的chunk直接跳过，不打印警告\n                    } else if (typeof chunk === 'string') {\n                        text += chunk;\n                } else {\n                        console.warn('未知的chunk格式:', chunk);\n                    }\n                } catch (error) {\n                    console.error('解析流数据时出错:', error);\n                }\n            }\n            return text;\n        });\n    \n        // 监听流式数据更新，实时追加到消息中\n        watch(streamContent, (newContent, oldContent) => {\n            if (newContent && newContent !== oldContent) {\n                // 获取新增的内容部分\n                const newChunk = newContent.slice(oldContent?.length || 0);\n                if (newChunk) {\n                    store.appendToLastMessage(newChunk);\n                }\n            }\n        });\n    \n        // 监听错误信息\n        watch(error, (errorInfo) => {\n            if (errorInfo) {\n                console.error(\"流式请求失败:\", errorInfo);\n                store.appendToLastMessage(\"\\n\\n抱歉，处理您的请求时遇到了问题。\");\n            }\n        });\n    \n        /**\n         * 处理用户提交消息\n         * 使用 useXStream 处理流式接收\n         */\n        const handleUserSubmit = async () => {\n            const messageContent = inputMessage.value.trim();\n    \n            // 验证输入\n            if (!messageContent || isLoading.value) {\n                return;\n            }\n    \n            try {\n                // 1. 添加用户消息到对话历史\n                store.addMessage({\n                    role: 'user',\n                    content: messageContent\n                });\n    \n                // 2. 清空输入框\n                inputMessage.value = '';\n    \n                // 3. 创建AI回复占位\n                store.addMessage({\n                    role: 'assistant',\n                    content: ''\n                });\n    \n                // 4. 获取流式响应\n                const response = await streamChat(messageContent);\n                console.log(response);\n    \n                // 5. 使用 useXStream 处理流式数据\n                await startStream({\n                    readableStream: response.body\n                });\n    \n    \n            } catch (err) {\n                console.error(\"发起流式请求失败:\", err);\n                store.appendToLastMessage(\"\\n\\n抱歉，发起请求时遇到了问题。\");\n            }\n        };\n    \n        /**\n         * 清空对话历史\n         */\n        const clearHistory = () => {\n            store.clearHistory();\n        };\n    \n        /**\n         * 重新生成会话ID\n         */\n        const regenerateSessionId = () => {\n            sessionId.value = `session_${Date.now()}`;\n        };\n    \n        return {\n            // 状态\n            messages,\n            isGenerating: isLoading, // 使用 useXStream 的 isLoading 状态\n            inputMessage,\n            sessionId,\n    \n            // 方法\n            handleUserSubmit,\n            clearHistory,\n            regenerateSessionId,\n    \n            // 流式处理相关\n            cancel // 暴露取消功能\n        };\n    }\n    ```\n    \n    \n    \n* **`src/composables/useMessageFormatter.js`** (消息动态状态处理)\n    ```javascript\n    import { computed } from 'vue';\n\n    /**\n     * 消息格式化 composable\n     * 现在消息已经按 BubbleList 格式存储，只需要处理动态状态\n     */\n    export function useMessageFormatter(messages, isGenerating) {\n        /**\n         * 添加动态状态到消息列表\n         */\n        const formattedMessages = computed(() => {\n            return messages.value.map((message, index) => ({\n            ...message,\n                // 只有最后一条AI消息在生成时显示打字效果\n                typing: message.role === 'ai' &&\n                    index === messages.value.length - 1 &&\n                    isGenerating.value\n            }));\n        });\n    \n        return {\n            formattedMessages\n        };\n    } \n    ```\n\n##### **3. 视图层 (`ChatView.vue`)**\n\n现在，我们的视图层变得极其简洁，它只负责组合 `composable` 的能力和 `vue-element-plus-x` 的UI组件。\n\n```vue\n<template>\n  <div class=\"h-screen w-screen flex\">\n    <!-- 左侧会话管理 -->\n    <div class=\"w-64 border-r bg-gray-50 flex flex-col\">\n      <div class=\"p-4 border-b bg-gray-100\">\n        <h3 class=\"font-bold text-lg\">会话管理</h3>\n      </div>\n      <div class=\"flex-1 overflow-auto\">\n        <Conversations v-model:active=\"activeConversationKey\" :items=\"conversationItems\" :label-max-width=\"200\"\n          :show-tooltip=\"true\" row-key=\"id\" @change=\"handleConversationChange\" />\n      </div>\n    </div>\n\n    <!-- 右侧聊天区域 -->\n    <div class=\"flex-1 flex flex-col\">\n      <!-- 聊天标题 -->\n      <div class=\"p-4 bg-blue-500 text-white text-xl font-bold\">\n        Spring AI 全栈聊天机器人\n      </div>\n\n      <!-- 聊天内容区 -->\n      <div class=\"flex-1 flex flex-col\">\n        <!-- 消息列表 -->\n        <div class=\"flex-1 overflow-auto\">\n          <BubbleList :list=\"formattedMessages\" />\n        </div>\n\n        <!-- 发送器 -->\n        <div class=\"border-t\">\n          <Sender v-model=\"inputMessage\" :loading=\"isGenerating\" :submitBtnDisabled=\"isGenerating\"\n            placeholder=\"请输入您的问题...\" :clearable=\"true\" submitType=\"enter\" @submit=\"handleUserSubmit\" />\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script setup>\nimport { ref } from 'vue';\nimport { BubbleList, Sender, Conversations } from 'vue-element-plus-x';\nimport { ElMessage } from 'element-plus';\nimport { useChat } from '../composables/useChat';\nimport { useMessageFormatter } from '../composables/useMessageFormatter';\n\n// --- Composables ---\nconst {\n  messages,\n  isGenerating,\n  inputMessage,\n  handleUserSubmit\n} = useChat();\n\nconst { formattedMessages } = useMessageFormatter(messages, isGenerating);\n\n// --- 会话管理相关 ---\nconst conversationItems = ref([\n  {\n    id: '1',\n    label: '第一个会话',\n    group: 'today',\n  },\n  {\n    id: '2',\n    label: '第二个会话',\n    group: 'today',\n  },\n]);\n\nconst activeConversationKey = ref('1');\n\nfunction handleConversationChange(item) {\n  ElMessage.success(`选中了: ${item.label}`);\n}\n</script>\n\n<style></style>\n```\n\n##### **4. 主程序入口 (`src/main.js`)**\n\n最后，确保 `main.js` 正确初始化并注册了所有模块。\n\n```javascript\n// src/main.js\nimport { createApp } from 'vue'\nimport './assets/style/main.css'\n\nimport ElementPlus from 'element-plus'\nimport 'element-plus/dist/index.css'\n\nimport ElementPlusX from 'element-plus-x'\nimport 'element-plus-x/dist/index.css'\n\nimport { createPinia } from 'pinia'\nimport router from './router'\n\nimport App from './App.vue'\n\nconst app = createApp(App)\nconst pinia = createPinia()\n\napp.use(pinia)\napp.use(router)\napp.use(ElementPlus)\napp.use(ElementPlusX)\n\napp.mount('#app')\n```\n\n##### 5.后端配置跨域请求\n\n**`com.example.hellospringai.config.MvcConfiguration`**\n\n```java\npackage com.example.hellospringai.config;\n\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.web.servlet.config.annotation.CorsRegistry;\nimport org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n\n@Configuration\npublic class MvcConfiguration implements WebMvcConfigurer {\n @Override\n public void addCorsMappings(CorsRegistry registry) {\n registry.addMapping(\"/**\")\n .allowedOrigins(\"*\")\n .allowedMethods(\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\")\n .allowedHeaders(\"*\");\n }\n}\n```\n\n现在我们启动前端服务器，并在输入框上与AI大模型对话，就能看到大模型给我们的所有响应格式！\n\n\n\n-----\n\n### 3.5 对话记忆 (Chat Memory)：让 AI 拥有上下文 (查阅)\n\n大型语言模型（LLM）天生是**无状态的**，它们不会保留任何关于先前交互的记忆。这意味着每一次API调用都是一次全新的、独立的对话。如果我们希望构建一个能够进行多轮对话、理解上下文的智能应用，就必须引入“记忆”机制。\n\nSpring AI 提供的 `ChatMemory` 功能，正是为了解决这个问题而生，它允许我们在与LLM的多次交互中，有效地存储和检索对话上下文。\n\n#### 3.5.1 核心概念：策略与存储的分离\n\n在深入研究之前，我们必须清晰地理解 Spring AI 在记忆功能上的核心设计思想：**将记忆的策略（如何记住）与记忆的存储（记在哪里）相分离**。\n\n这一思想通过两个核心接口得以实现：\n\n1. **`ChatMemory` (策略)**: 定义了记忆的**策略和行为**。它决定了应该保留哪些消息、何时删除旧消息。例如，“只保留最近10条消息”就是一个策略。\n2. **`ChatMemoryRepository` (存储)**: 定义了记忆的**存储和检索**。它的唯一职责是在后端（如内存、数据库、Redis）存取消息数据。\n\n我们可以这样理解：`ChatMemoryRepository` 是一个“**仓库**”，而 `ChatMemory` 则是高效率的“**仓库管理员**”。管理员根据自己的一套规则（策略）来管理仓库中的货物（消息）。\n\n同时，我们必须辨别另一个重要概念：\n\n| 术语 (Term) | 定义 | 在 Spring AI 中的作用 |\n| :--- | :--- | :--- |\n| **聊天记忆 (Chat Memory)** | 为了让AI理解下文而提供的一个**相关的、有限的**对话历史子集。 | **用于构建 Prompt**。`ChatMemory` 抽象负责管理这个“短期记忆”，决定哪些历史消息应该被包含在下一次发给AI的请求中。 |\n| **聊天记录 (Chat History)**| 一段会话中**全部、完整的**消息交换历史。 | **用于审计或长期存储**。Spring AI 的 `ChatMemory` **不负责**存储完整的聊天记录。如需此功能，应使用 Spring Data 等持久化方案自行实现。 |\n\n#### 3.5.2 记忆策略：`MessageWindowChatMemory`\n\nSpring AI 默认并最常用的记忆策略是 `MessageWindowChatMemory`，即**消息窗口记忆**。\n\n * **工作原理**：它像一个“滑动窗口”，始终只保留最近的 N 条消息。当新的消息进入时，最老的消息就会被挤出窗口（系统消息 `SystemMessage` 通常会被特殊保留，不受窗口大小影响）。\n * **核心优势**：这是在实际应用中**性价比最高**的策略。它能有效防止上下文无限增长，从而避免超出模型 Token 限制而报错，同时也能节省大量的 Token 费用。\n\n#### 3.5.3 记忆存储：从内存到持久化 (`ChatMemoryRepository`) (查阅)\n\n`ChatMemoryRepository` 是一个负责物理存储和检索消息的抽象接口。Spring AI 提供了多种内置实现，让我们可以轻松地将对话记忆从易失的内存，切换到可靠的持久化数据库中。\n\n##### 1\\. 内存存储库 (`InMemoryChatMemoryRepository`)\n\n这是最基础、最简单的实现，它使用 Java 内置的 `ConcurrentHashMap` 来存储消息。\n\n * **特点**：无需任何额外配置和依赖，开箱即用。非常适合快速原型开发和测试。\n * **缺点**：数据随应用程序的重启而丢失，不适用于生产环境。\n * **自动配置**：默认情况下，如果项目中没有配置其他任何 `ChatMemoryRepository` 的 Bean，Spring AI 会自动配置一个 `InMemoryChatMemoryRepository` 实例。\n\n##### 2\\. JDBC 存储库 (`JdbcChatMemoryRepository`)\n\n这是一个通用的实现，用于将聊天消息存储在任何支持 JDBC 的关系型数据库中（如 MySQL, PostgreSQL, H2 等），是**生产环境的首选**。\n\n * **引入依赖**：\n\n ```xml\n<dependency>\n<groupid>org.springframework.ai</groupid>\n<artifactid>spring-ai-jdbc-store-spring-boot-starter</artifactid>\n</dependency>\n<dependency>\n<groupid>com.mysql</groupid>\n<artifactid>mysql-connector-j</artifactid>\n<scope>runtime</scope>\n</dependency>\n ```\n\n * **配置属性 (`application.yml`)**:\n\n | 属性 | 描述 | 默认值 |\n | :--- | :--- | :--- |\n | `spring.ai.chat.memory.repository.jdbc.initialize-schema` | 控制何时初始化数据库表结构。可选值: `embedded`, `always`, `never`。 | `embedded` |\n | `spring.ai.chat.memory.repository.jdbc.schema` | 用于初始化表结构的 SQL 脚本位置。`@@platform@@` 会被自动替换。| `classpath:org/.../schema-@@platform@@.sql` |\n | `spring.ai.chat.memory.repository.jdbc.platform` | 手动指定数据库平台（如 `mysql`, `postgresql`）。 | (自动检测) |\n\n * **Schema 初始化最佳实践**:\n\n * **开发时**：可以设置为 `always`，让 Spring AI 自动创建表，非常方便。\n * **生产时**：**强烈推荐**设置为 `never`。在生产环境中，数据库的表结构（Schema）应该由专业的数据库迁移工具（如 Flyway 或 Liquibase）来管理，或者由 DBA 手动执行脚本创建，以确保版本控制和安全性。\n\n * **MySQL 表结构定义**:\n 如果选择手动创建，以下是 `JdbcChatMemoryRepository` 所需的表结构。\n\n ```sql\n CREATE TABLE `spring_ai_chat_memory` (\n `id` bigint NOT NULL AUTO_INCREMENT,\n `conversation_id` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,\n `content` text COLLATE utf8mb4_unicode_ci NOT NULL,\n `type` varchar(50) COLLATE utf8mb4_unicode_ci NOT NULL, -- 存储消息类型，如 USER, ASSISTANT\n `timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP,\n `media` json DEFAULT NULL, -- 为未来的多模态消息预留\n `metadata` json DEFAULT NULL, -- 存储额外信息\n PRIMARY KEY (`id`),\n KEY `idx_conversation_id` (`conversation_id`),\n KEY `idx_conversation_timestamp` (`conversation_id`,`timestamp`)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n ```\n\n#### 3.5.4 集成与配置：将记忆注入 `ChatClient` (查阅)\n\n我们已经有了“策略”和“仓库”，现在需要将它们组装起来，并让 `ChatClient` 使用它们。最佳实践是使用 **`Advisor` (顾问)** 将记忆功能自动织入到 `ChatClient` 的调用流程中。\n\n| 记忆顾问 (Advisor) | 工作原理 | 适用场景 |\n| :--- | :--- | :--- |\n| **`MessageChatMemoryAdvisor`**| 将历史记录作为标准的 **`Message` 对象列表**加入到 Prompt 中。 | **最常用、最标准**的多轮对话，能完整保留角色和上下文信息。 |\n| **`PromptChatMemoryAdvisor`** | 将历史记录格式化为**纯文本字符串**，并附加到 `SystemMessage` 中。 | 简单的上下文附加，或当某个特定模型对纯文本上下文处理得更好时。 |\n| **`VectorStoreChatMemoryAdvisor`**| 从**向量数据库**中搜索与当前输入最相关的历史片段作为记忆。 | 实现“长期记忆”或 RAG 式的对话，让AI能回忆起很久以前的相关信息。 |\n\n##### 组合配置 `CommonConfiguration.java`\n\n现在，我们将所有部分组合在一个 `@Configuration` 文件中，展示一个完整的、基于 JDBC 持久化的记忆配置。\n\n```java\n// 文件路径: src/main/java/com/example/hellospringai/config/CommonConfiguration.java\npackage com.example.hellospringai.config;\n\nimport org.springframework.ai.chat.client.ChatClient;\nimport org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;\nimport org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor;\nimport org.springframework.ai.chat.memory.ChatMemory;\nimport org.springframework.ai.chat.memory.MessageWindowChatMemory;\nimport org.springframework.ai.chat.memory.repository.jdbc.JdbcChatMemoryRepository;\nimport org.springframework.ai.chat.model.ChatModel;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\n@Configuration\npublic class CommonConfiguration {\n\n // 1. Spring Boot会根据我们的yml配置，自动为我们配置好一个JdbcChatMemoryRepository\n // 因此我们可以直接注入它。\n @Autowired\n JdbcChatMemoryRepository chatMemoryRepository;\n\n /**\n * 2. 定义我们的“记忆策略”Bean。\n * 这里我们创建了一个使用JDBC持久化存储的、最大容量为50条消息的窗口记忆。\n * @return MessageWindowChatMemory 实例\n */\n @Bean\n public ChatMemory chatMemory() {\n return MessageWindowChatMemory.builder()\n .chatMemoryRepository(chatMemoryRepository) // 指定记忆的“仓库”\n .maxMessages(50) // 指定记忆的“策略”：只保留最近50条消息\n .build();\n }\n\n /**\n * 3. 定义我们最终的 ChatClient Bean。\n * 我们将日志和记忆功能通过“顾问”模式织入。\n * @param chatModel Spring Boot 自动配置好的 ChatModel 实例\n * @param chatMemory 我们上面定义的 ChatMemory Bean 实例\n * @return 一个配置好日志和持久化记忆功能的 ChatClient 实例\n */\n @Bean\n public ChatClient chatClient(ChatModel chatModel, ChatMemory chatMemory) {\n return ChatClient.builder(chatModel)\n .defaultAdvisors(\n new SimpleLoggerAdvisor(), // 添加日志顾问，用于调试\n MessageChatMemoryAdvisor.builder(chatMemory).build() // 添加记忆顾问，并传入我们的记忆策略Bean\n )\n .build();\n }\n}\n```\n\n#### 3.5.5 实际调用：传递会话 ID\n\n配置完成后，我们还需要在调用 `ChatClient` 时，告诉它当前这次对话属于哪个“会话 (Conversation)”，以便它能从数据库中加载正确的历史记录。\n\n这是通过传递一个**会话ID (`conversationId`)** 来实现的。\n\n##### 1\\. Service 层改造\n\n我们的 `ChatService` 需要能够接收 `conversationId`，并将其传递给 `ChatClient`。\n\n```java\n/**\n * 【方法】带聊天记忆的流式对话\n * @param prompt 用户输入消息\n * @param conversationId 会话ID，用于维护聊天记忆\n * @return AI回复的文本内容流\n */\npublic Flux<string>getChatStreamWithMemory(String prompt, String conversationId) {\n return chatClient.prompt()\n .user(prompt) // 用户输入消息\n // 关键：通过 .advisors() 方法的参数，将会话ID传递给记忆顾问\n // ChatMemory.CONVERSATION_ID 是官方提供的标准Key，推荐使用\n .advisors(a -&gt; a.param(ChatMemory.CONVERSATION_ID, conversationId)) \n .stream()\n .content();\n}\n```\n\n##### 2\\. Controller 层改造\n\n相应地，`ChatController` 的接口也需要增加一个 `chatId` 参数，以从前端请求中接收这个ID。\n\n```java\n@RestController\n@RequestMapping(\"/ai\")\npublic class ChatController {\n // ... 构造函数注入 ...\n \n @GetMapping(value = \"/chat\", produces = \"text/event-stream;charset=utf-8\")\n public Flux<string>streamChat(@RequestParam(value = \"message\") String message,\n // 关键: 从请求参数中获取会话ID\n @RequestParam(value = \"chatId\") String chatId) {\n return chatService.getChatStreamWithMemory(message, chatId);\n }\n}\n```\n\n至此，我们的后端就拥有了完整的、可持久化的多会话记忆能力。每个唯一的 `chatId` 都会在 `spring_ai_chat_memory` 表中拥有自己独立的聊天记录。 \n\n\n\n-----\n\n#### 3.5.6 前端适配：核心代码实现\n\n后端具备记忆能力后，前端的核心任务是**管理并发送 `chatId`**。以下是实现此功能的几个关键文件的核心代码与直接说明。\n\n##### 1\\. API 层: `src/api/chat.js`\n\n * **目的**: 让 API 调用能携带 `chatId`。\n\n```javascript\nimport request from '../utils/request';\n\n/**\n * 以流式方式获取AI回答\n * @param {string} message - 用户消息\n * @param {string} chatId - 【新增】当前会话的唯一ID\n * @returns {Promise<response>}\n */\nexport function streamChat(message, chatId = 'default') {\n const url = `${request.defaults.baseURL}/ai/chat?message=${encodeURIComponent(message)}&amp;chatId=${encodeURIComponent(chatId)}`;\n return fetch(url, {\n method: 'GET',\n headers: {\n 'Accept': 'text/event-stream',\n }\n });\n}\n```\n\n##### 2\\. 状态管理层: `src/stores/conversationStore.js`\n\n * **目的**: 重构状态管理，从单一对话升级为支持多会话的完整系统。这是前端实现多会话记忆的核心。\n\n```javascript\n// 这是一个使用 Pinia 状态管理库创建的对话存储模块\nimport { defineStore } from 'pinia';\n\n// 导出一个名为 'conversation' 的状态存储，用于管理多会话聊天对话的状态\nexport const useConversationStore = defineStore('conversation', {\n // 定义存储的状态数据\n state: () =&gt; ({\n // 所有会话的数据，按会话ID分组存储\n conversations: {\n // 'conversation-id': {\n // id: 'conversation-id',\n // title: '会话标题',\n // messages: [], // BubbleList格式的消息数组\n // createdAt: Date,\n // updatedAt: Date,\n // group: 'today' // 用于分组显示\n // }\n },\n // 当前活跃的会话ID\n currentConversationId: null,\n // 消息ID计数器\n nextMessageId: 0,\n }),\n\n // 计算属性\n getters: {\n // 获取当前会话的消息列表\n currentMessages: (state) =&gt; {\n if (!state.currentConversationId || !state.conversations[state.currentConversationId]) {\n return [];\n }\n return state.conversations[state.currentConversationId].messages;\n },\n\n // 获取当前会话信息\n currentConversation: (state) =&gt; {\n if (!state.currentConversationId || !state.conversations[state.currentConversationId]) {\n return null;\n }\n return state.conversations[state.currentConversationId];\n },\n\n // 获取会话列表（用于 Conversations 组件）\n conversationItems: (state) =&gt; {\n const now = new Date();\n const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);\n const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);\n\n return Object.values(state.conversations).map(conv =&gt; {\n const updatedAt = new Date(conv.updatedAt);\n let group = 'older';\n\n if (updatedAt &gt;= today) {\n group = 'today';\n } else if (updatedAt &gt;= yesterday) {\n group = 'yesterday';\n } else if (updatedAt &gt;= weekAgo) {\n group = 'week';\n }\n\n return {\n id: conv.id,\n label: conv.title,\n group,\n updatedAt: conv.updatedAt\n };\n }).sort((a, b) =&gt; new Date(b.updatedAt) - new Date(a.updatedAt));\n }\n },\n\n // 定义可以修改状态的操作方法\n actions: {\n // 创建新会话\n createConversation(title = null) {\n const conversationId = `conv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n const now = new Date();\n\n this.conversations[conversationId] = {\n id: conversationId,\n title: title || '新的会话',\n messages: [],\n createdAt: now,\n updatedAt: now\n };\n\n // 自动切换到新会话\n this.currentConversationId = conversationId;\n return conversationId;\n },\n\n // 切换会话\n switchConversation(conversationId) {\n if (this.conversations[conversationId]) {\n this.currentConversationId = conversationId;\n }\n },\n\n // 删除会话\n deleteConversation(conversationId) {\n if (this.conversations[conversationId]) {\n delete this.conversations[conversationId];\n\n // 如果删除的是当前会话，切换到其他会话或创建新会话\n if (this.currentConversationId === conversationId) {\n const remainingConversations = Object.keys(this.conversations);\n if (remainingConversations.length &gt; 0) {\n this.currentConversationId = remainingConversations[0];\n } else {\n this.createConversation();\n }\n }\n }\n },\n\n // 重命名会话\n renameConversation(conversationId, newTitle) {\n if (this.conversations[conversationId]) {\n this.conversations[conversationId].title = newTitle;\n this.conversations[conversationId].updatedAt = new Date();\n }\n },\n\n // 添加一条新消息到当前会话\n addMessage({ role, content = '' }) {\n // 确保有当前会话\n if (!this.currentConversationId) {\n this.createConversation();\n }\n\n const messageRole = role === 'user' ? 'user' : 'ai';\n const placement = messageRole === 'ai' ? 'start' : 'end';\n const variant = messageRole === 'ai' ? 'filled' : 'outlined';\n const avatar = messageRole === 'ai'\n ? 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png'\n : 'https://avatars.githubusercontent.com/u/76239030?v=4';\n\n // 创建符合 BubbleList 组件要求的消息对象\n const bubbleMessage = {\n key: this.nextMessageId++, // 唯一标识\n role: messageRole, // user | ai 角色定义\n placement, // start | end 气泡位置\n content, // 消息内容，流式接收时只需要改这个值即可\n loading: false, // 当前气泡的加载状态\n shape: 'corner', // 气泡的形状\n variant, // 气泡的样式\n isMarkdown: true, // 是否渲染为 markdown\n typing: false, // 是否开启打字器效果，该属性不会和流式接收冲突\n isFog: messageRole === 'ai', // 是否开启打字雾化效果，该效果 v1.1.6 新增，且在 typing 为 true 时生效，该效果会覆盖 typing 的 suffix 属性\n avatar, // 头像\n avatarSize: '36px', // 头像占位大小\n avatarGap: '12px', // 头像与气泡之间的距离\n };\n\n this.conversations[this.currentConversationId].messages.push(bubbleMessage);\n this.conversations[this.currentConversationId].updatedAt = new Date();\n\n // 智能更新会话标题（基于用户的第一条消息）\n if (messageRole === 'user' &amp;&amp; this.conversations[this.currentConversationId].messages.length === 1) {\n const title = content.length &gt; 20 ? content.substring(0, 20) + '...' : content;\n this.conversations[this.currentConversationId].title = title || '新的会话';\n }\n },\n\n // 向当前会话的最后一条消息追加内容（用于流式接收AI回复）\n appendToLastMessage(contentChunk) {\n // 确保有当前会话f\n if (!this.currentConversationId || !this.conversations[this.currentConversationId]) {\n return;\n }\n\n const messages = this.conversations[this.currentConversationId].messages;\n\n // 如果没有消息则直接返回\n if (messages.length === 0) return;\n\n // 获取最后一条消息\n const lastMessage = messages[messages.length - 1];\n\n // 只有当最后一条消息是AI助手的回复时才追加内容\n if (lastMessage.role === 'ai') {\n lastMessage.content += contentChunk;\n this.conversations[this.currentConversationId].updatedAt = new Date();\n }\n },\n\n // 清空当前会话历史\n clearCurrentHistory() {\n if (this.currentConversationId &amp;&amp; this.conversations[this.currentConversationId]) {\n this.conversations[this.currentConversationId].messages = [];\n this.conversations[this.currentConversationId].updatedAt = new Date();\n }\n },\n\n // 清空所有会话历史\n clearAllHistory() {\n this.conversations = {};\n this.currentConversationId = null;\n this.createConversation();\n },\n\n // 初始化默认会话（如果没有任何会话）\n initializeDefaultConversation() {\n if (Object.keys(this.conversations).length === 0) {\n this.createConversation('默认会话');\n } else if (!this.currentConversationId) {\n // 如果没有当前会话，选择最近更新的会话\n const conversationIds = Object.keys(this.conversations);\n const latestConversation = conversationIds.reduce((latest, id) =&gt; {\n const conv = this.conversations[id];\n return (!latest || conv.updatedAt &gt; this.conversations[latest].updatedAt) ? id : latest;\n }, null);\n this.currentConversationId = latestConversation;\n }\n }\n },\n});\n```\n\n##### 3\\. 逻辑层: Composables\n\n * **目的**: 将复杂的UI交互逻辑与核心的聊天功能逻辑解耦，使代码更清晰。\n\n * **`src/composables/useChat.js`** (聊天核心逻辑)\n\n ```javascript\n import { ref, watch, computed, onMounted } from 'vue';\n import { useConversationStore } from '../stores/conversationStore';\n import { storeToRefs } from 'pinia';\n import { streamChat } from '../api/chat';\n import { useXStream } from 'vue-element-plus-x';\n\n /**\n * 聊天核心逻辑 composable\n * 处理消息发送、流式接收、状态管理等\n */\n export function useChat() {\n // 状态管理 - 使用新的会话管理系统\n const store = useConversationStore();\n const { currentMessages, currentConversationId } = storeToRefs(store);\n\n // 输入消息\n const inputMessage = ref('');\n \n // 使用 useXStream 处理流式数据\n const { startStream, cancel, isLoading, data, error } = useXStream();\n \n // 计算属性处理累积的流式数据\n const streamContent = computed(() =&gt; {\n if (!data.value.length) return '';\n \n let text = '';\n for (let index = 0; index &lt; data.value.length; index++) {\n const chunk = data.value[index];\n try {\n // 检查chunk是否是对象且包含data属性\n if (typeof chunk === 'object' &amp;&amp; chunk !== null &amp;&amp; 'data' in chunk) {\n // 处理非空data\n if (chunk.data) {\n text += chunk.data;\n } else if (chunk.data === '') {\n // 空data块通常表示换行符\n text += '\\n';\n }\n } else if (typeof chunk === 'string') {\n text += chunk;\n } else {\n console.warn('未知的chunk格式:', chunk);\n }\n } catch (error) {\n console.error('解析流数据时出错:', error);\n }\n }\n return text;\n });\n \n // 监听流式数据更新，实时追加到消息中\n watch(streamContent, (newContent, oldContent) =&gt; {\n if (newContent &amp;&amp; newContent !== oldContent) {\n // 获取新增的内容部分\n const newChunk = newContent.slice(oldContent?.length || 0);\n if (newChunk) {\n store.appendToLastMessage(newChunk);\n }\n }\n });\n \n // 监听错误信息\n watch(error, (errorInfo) =&gt; {\n if (errorInfo) {\n console.error(\"流式请求失败:\", errorInfo);\n store.appendToLastMessage(\"\\n\\n抱歉，处理您的请求时遇到了问题。\");\n }\n });\n \n /**\n * 处理用户提交消息\n * 使用 useXStream 处理流式接收\n */\n const handleUserSubmit = async () =&gt; {\n const messageContent = inputMessage.value.trim();\n \n // 验证输入\n if (!messageContent || isLoading.value) {\n return;\n }\n \n // 确保有当前会话ID\n if (!currentConversationId.value) {\n store.initializeDefaultConversation();\n }\n \n try {\n // 1. 添加用户消息到对话历史\n store.addMessage({\n role: 'user',\n content: messageContent\n });\n \n // 2. 清空输入框\n inputMessage.value = '';\n\n // 3. 创建AI回复占位\n store.addMessage({\n role: 'assistant',\n content: ''\n });\n \n // 4. 获取流式响应，传递当前会话ID\n const response = await streamChat(messageContent, currentConversationId.value);\n console.log('发送请求，会话ID:', currentConversationId.value);\n console.log(response);\n \n // 5. 使用 useXStream 处理流式数据\n await startStream({\n readableStream: response.body\n });\n \n } catch (err) {\n console.error(\"发起流式请求失败:\", err);\n store.appendToLastMessage(\"\\n\\n抱歉，发起请求时遇到了问题。\");\n }\n };\n \n // 组件挂载时初始化\n onMounted(() =&gt; {\n store.initializeDefaultConversation();\n });\n \n return {\n // 状态\n messages: currentMessages, // 返回当前会话的消息\n isGenerating: isLoading, // 使用 useXStream 的 isLoading 状态\n inputMessage,\n currentConversationId,\n \n // 方法\n handleUserSubmit,\n \n // 流式处理相关\n cancel // 暴露取消功能\n };\n }\n ```\n\n * **`src/composables/useConversationManager.js`** (会话管理逻辑)\n\n ```javascript\n import { computed } from 'vue';\nimport { ElMessage, ElMessageBox } from 'element-plus';\n import { useConversationStore } from '../stores/conversationStore';\n import { storeToRefs } from 'pinia';\n \n /**\n * 会话管理 composable\n * 处理会话相关的UI交互逻辑\n */\n export function useConversationManager() {\n const store = useConversationStore();\n const { conversationItems, currentConversation, currentConversationId } = storeToRefs(store);\n \n // 当前选中的会话KEY（用于 Conversations 组件）\n const activeConversationKey = computed({\n get: () =&gt; currentConversationId.value,\n set: (value) =&gt; {\n if (value &amp;&amp; value !== currentConversationId.value) {\n store.switchConversation(value);\n }\n }\n });\n \n // 当前会话标题\n const currentConversationTitle = computed(() =&gt; {\n return currentConversation.value?.title || 'Spring AI 全栈聊天机器人';\n });\n \n /**\n * 会话切换处理\n */\n const handleConversationChange = (item) =&gt; {\n console.log('会话切换:', item);\n store.switchConversation(item.id);\n ElMessage.success(`切换到: ${item.label}`);\n };\n \n /**\n * 新建会话\n */\n const handleCreateNewConversation = () =&gt; {\n const conversationId = store.createConversation();\n ElMessage.success('新建会话成功');\n console.log('新建会话:', conversationId);\n return conversationId;\n };\n \n /**\n * 清空当前会话历史\n */\n const handleClearCurrentHistory = () =&gt; {\n return ElMessageBox.confirm(\n '确定要清空当前会话的所有消息吗？',\n '确认清空',\n {\n confirmButtonText: '确定',\n cancelButtonText: '取消',\n type: 'warning',\n }\n ).then(() =&gt; {\n store.clearCurrentHistory();\n ElMessage.success('已清空当前会话历史');\n }).catch(() =&gt; {\n // 用户取消操作\n });\n };\n \n /**\n * 处理会话菜单命令（重命名、删除）\n */\n const handleMenuCommand = (command, item) =&gt; {\n console.log('菜单命令:', command, item);\n \n switch (command) {\n case 'rename':\n handleRenameConversation(item);\n break;\n case 'delete':\n handleDeleteConversation(item);\n break;\n default:\n console.warn('未知的菜单命令:', command);\n }\n };\n \n /**\n * 重命名会话\n */\n const handleRenameConversation = (item) =&gt; {\n return ElMessageBox.prompt('请输入新的会话名称', '重命名会话', {\n confirmButtonText: '确定',\n cancelButtonText: '取消',\n inputValue: item.label,\n inputPattern: /^.{1,50}$/,\n inputErrorMessage: '会话名称长度必须在1-50个字符之间'\n }).then(({ value }) =&gt; {\n store.renameConversation(item.id, value);\n ElMessage.success('重命名成功');\n }).catch(() =&gt; {\n // 用户取消操作\n });\n };\n \n /**\n * 删除会话\n */\n const handleDeleteConversation = (item) =&gt; {\n return ElMessageBox.confirm(\n `确定要删除会话 \"${item.label}\" 吗？此操作不可撤销。`,\n '确认删除',\n {\n confirmButtonText: '确定',\n cancelButtonText: '取消',\n type: 'warning',\n }\n ).then(() =&gt; {\n store.deleteConversation(item.id);\n ElMessage.success('删除成功');\n }).catch(() =&gt; {\n // 用户取消操作\n });\n };\n \n return {\n // 状态\n conversationItems,\n currentConversation,\n currentConversationId,\n activeConversationKey,\n currentConversationTitle,\n \n // 方法\n handleConversationChange,\n handleCreateNewConversation,\n handleClearCurrentHistory,\n handleMenuCommand,\n handleRenameConversation,\n handleDeleteConversation\n };\n } \n ```\n\n##### 4\\. 视图层: `src/views/ChatView.vue`\n\n * **目的**: 整合所有状态和逻辑，构建最终的用户交互界面。\n\n```vue\n<template>\n <div class="\&quot;h-screen" w-screen="" flex\"="">\n \n<div class="\&quot;w-64" border-r="" bg-gray-50="" flex="" flex-col\"="">\n <div class="\&quot;p-4" border-b="" bg-gray-100="" flex="" justify-between="" items-center\"="">\n  <h3 class="\&quot;font-bold" text-lg\"="">会话管理\n <button @click="\&quot;handleCreateNewConversation\&quot;" class="\&quot;btn" btn-ghost="" btn-sm\"="" title="\&quot;新建会话\&quot;">\n ＋\n\n</button></h3></div></div></div></template></response></string></string></div>\n<div class="\&quot;flex-1" overflow-auto\"="">\n  <conversations :active="\&quot;activeConversationKey\&quot;" @update:active="\&quot;(value)" ==""> activeConversationKey = value\"\n :items=\"conversationItems\" :label-max-width=\"200\" :show-tooltip=\"true\" row-key=\"id\" show-built-in-menu\n groupable @change=\"handleConversationChange\" @menu-command=\"handleMenuCommand\" /&gt;\n</conversations></div>\n</div></main></div>\n\n \n <div class="\&quot;flex-1" flex="" flex-col\"="">\n \n <div class="\&quot;p-4" bg-blue-500="" text-white="" text-xl="" font-bold="" flex="" justify-between="" items-center\"="">\n <span>{{ currentConversationTitle }}</span>\n <button @click="\&quot;handleClearCurrentHistory\&quot;\n" class="\&quot;px-3" py-1="" bg-blue-600="" text-white="" rounded="" text-sm="" hover:bg-blue-700="" transition-colors\"="" title="\&quot;清空当前会话\&quot;">\n 清空\n\n\n\n \n <div class="\&quot;flex-1" flex="" flex-col\"="">\n \n<div class="\&quot;flex-1" overflow-auto\"="">\n  <bubblelist :list="\&quot;formattedMessages\&quot;" is-markdown="">\n\n\n \n<div class="\&quot;border-t\&quot;">\n  <sender v-model="\&quot;inputMessage\&quot;" :loading="\&quot;isGenerating\&quot;" :submitbtndisabled="\&quot;isGenerating\&quot;\n" placeholder="\&quot;请输入您的问题...\&quot;" :clearable="\&quot;true\&quot;" submittype="\&quot;enter\&quot;" @submit="\&quot;handleUserSubmit\&quot;">\n\n\n\n\n\n\n<script setup="">\nimport { BubbleList, Sender, Conversations } from 'vue-element-plus-x';\nimport { useChat } from '../composables/useChat';\nimport { useMessageFormatter } from '../composables/useMessageFormatter';\nimport { useConversationManager } from '../composables/useConversationManager';\n\n// --- 聊天功能 ---\nconst {\n  messages,\n  isGenerating,\n  inputMessage,\n  handleUserSubmit\n} = useChat();\n\nconst { formattedMessages } = useMessageFormatter(messages, isGenerating);\n\n// --- 会话管理功能 ---\nconst {\n  conversationItems,\n  activeConversationKey,\n  currentConversationTitle,\n  handleConversationChange,\n  handleCreateNewConversation,\n  handleClearCurrentHistory,\n  handleMenuCommand\n} = useConversationManager();\n</script>\n\n<style></style>\n```\n\n\n-----\n\n### 3.6 会话历史：从数据库加载与管理\n\n在上一章，我们配置了 `JdbcChatMemoryRepository`，它会默默地将所有对话记录保存到 `spring_ai_chat_memory` 数据库表中。这解决了AI的“短期记忆”问题。但对于一个完整的应用而言，我们还需要让用户能够看到并管理自己的历史会话列表，就像所有主流聊天应用一样。\n\n本章，我们将使用 **MyBatis-Plus** 这个强大的 ORM 框架，直接操作 `spring_ai_chat_memory` 表，为其创建一套完整的 `Service` 和 `Controller`，从而实现真正的会话持久化和管理功能。\n\n#### 3.6.1 后端建设：构建历史记录服务\n\n我们的第一步是在后端搭建一套完整的、用于查询和管理聊天历史的 CRUD 服务。\n\n##### 1\\. 引入依赖与配置\n\n * **在 `pom.xml` 中添加 MyBatis-Plus 依赖**：\n\n ```xml\n<dependency>\n<groupid>com.baomidou</groupid>\n<artifactid>mybatis-plus-spring-boot3-starter</artifactid>\n<version>3.5.5</version>\n</dependency>\n ```\n\n * **在主启动类上添加 `@MapperScan` 注解**：\n\n ```java\n package com.example.hellospringai;\n\n import org.mybatis.spring.annotation.MapperScan;\n import org.springframework.boot.SpringApplication;\n import org.springframework.boot.autoconfigure.SpringBootApplication;\n\n @SpringBootApplication\n @MapperScan(\"com.example.hellospringai.mapper\") // 扫描Mapper接口所在的包\n public class HelloSpringAiApplication {\n\n public static void main(String[] args) {\n SpringApplication.run(HelloSpringAiApplication.class, args);\n }\n\n }\n ```\n\n * **在 `application.yml` 中添加 MyBatis-Plus 配置**：\n\n ```yaml\n # MyBatis-Plus 配置\n mybatis-plus:\n configuration:\n # 开启驼峰命名转换, e.g., conversation_id -&gt; conversationId\n map-underscore-to-camel-case: true\n # 打印SQL日志到控制台，方便调试\n log-impl: org.apache.ibatis.logging.stdout.StdOutImpl\n global-config:\n db-config:\n # 逻辑删除配置 (如果你的表设计中有逻辑删除字段)\n logic-delete-field: deleted\n logic-delete-value: 1\n logic-not-delete-value: 0\n # 指定Mapper XML文件的位置 (如果使用XML)\n mapper-locations: classpath*:/mapper/**/*.xml\n ```\n\n##### 2\\. 数据访问层 (Entity &amp; Mapper)\n\n * **实体类 `ChatMemory.java`**：\n 这个实体类直接映射到 `spring_ai_chat_memory` 数据库表，让我们能以对象的方式操作数据。\n\n ```java\n package com.example.hellospringai.entity;\n\n import com.baomidou.mybatisplus.annotation.*;\n import lombok.Data;\n import java.time.LocalDateTime;\n\n @Data\n @TableName(\"SPRING_AI_CHAT_MEMORY\") // 精确指定表名\n public class ChatMemory {\n \n @TableId(value = \"id\", type = IdType.AUTO)\n private Long id;\n \n @TableField(\"conversation_id\")\n private String conversationId;\n \n @TableField(\"content\")\n private String content;\n \n @TableField(\"type\")\n private String type; // USER 或 ASSISTANT\n \n @TableField(\"timestamp\")\n private LocalDateTime timestamp;\n \n @TableField(\"media\")\n private String media; // JSON\n \n @TableField(\"metadata\")\n private String metadata; // JSON\n }\n ```\n\n * **Mapper 接口 `ChatMemoryMapper.java`**:\n 通过继承 `BaseMapper`，我们无需编写任何 SQL 语句，即可拥有强大的单表 CRUD 能力。\n\n ```java\n package com.example.hellospringai.mapper;\n\n import com.example.hellospringai.entity.ChatMemory;\n import com.baomidou.mybatisplus.core.mapper.BaseMapper;\n import org.apache.ibatis.annotations.Mapper;\n\n @Mapper\n public interface ChatMemoryMapper extends BaseMapper<chatmemory>{\n // 继承 BaseMapper 后，所有基础的数据库操作都已具备\n // 我们将使用 QueryWrapper 来处理复杂的查询，以获得更好的类型安全和灵活性\n }\n ```\n\n##### 3\\. 业务逻辑层 (Service &amp; ServiceImpl)\n\n * **服务接口 `IChatHistoryService.java`**:\n 定义了我们对外提供的所有历史记录管理功能。\n\n ```java\n package com.example.hellospringai.service;\n\n import com.example.hellospringai.entity.ChatMemory;\n import com.baomidou.mybatisplus.extension.service.IService;\n import java.util.List;\n import java.util.Map;\n\n public interface IChatHistoryService extends IService<chatmemory>{\n \n // 根据会话ID获取该会话的完整聊天记录\n List<chatmemory>getChatHistory(String conversationId);\n \n // 获取所有会话的列表信息（用于前端展示会话列表）\n List<map<string ,="" object="">&gt; getAllConversations();\n \n // 删除指定会话的所有记录\n boolean deleteChatHistory(String conversationId);\n \n // 获取单个会话的统计信息\n Map<string ,="" object="">getConversationStats(String conversationId);\n }\n ```\n\n * **服务实现 `ChatHistoryServiceImpl.java`**:\n 这里是所有业务逻辑的具体实现。\n\n ```java\n package com.example.hellospringai.service.impl;\n\n import com.example.hellospringai.entity.ChatMemory;\n import com.example.hellospringai.mapper.ChatMemoryMapper;\n import com.example.hellospringai.service.IChatHistoryService;\n import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;\n import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;\n import org.springframework.stereotype.Service;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n\n @Service\n public class ChatHistoryServiceImpl extends ServiceImpl<chatmemorymapper ,="" chatmemory="">implements IChatHistoryService {\n\n @Override\n public List<chatmemory>getChatHistory(String conversationId) {\n // 按时间升序查询指定会话的所有消息\n QueryWrapper<chatmemory>queryWrapper = new QueryWrapper&lt;&gt;();\n queryWrapper.eq(\"conversation_id\", conversationId)\n .orderByAsc(\"timestamp\");\n return this.list(queryWrapper);\n }\n\n @Override\n public List<map<string ,="" object="">&gt; getAllConversations() {\n // 这个方法相对复杂，它需要为前端聚合每个会话的必要信息\n QueryWrapper<chatmemory>queryWrapper = new QueryWrapper&lt;&gt;();\n queryWrapper.select(\"conversation_id\", \"timestamp\")\n .orderByDesc(\"timestamp\");\n\n List<chatmemory>allRecords = this.list(queryWrapper);\n\n // 1. 使用 Java Stream 去重，得到所有唯一的会话ID，并保持时间倒序\n List<string>conversationIds = allRecords.stream()\n .map(ChatMemory::getConversationId)\n .distinct()\n .toList();\n \n // 2. 遍历每个唯一的会话ID，查询其详细信息\n return conversationIds.stream().map(id -&gt; {\n Map<string ,="" object="">conversation = new HashMap&lt;&gt;();\n conversation.put(\"conversationId\", id);\n\n // 2.1 获取该会话的最后一条消息作为更新时间\n ChatMemory lastMessage = this.query()\n .eq(\"conversation_id\", id).orderByDesc(\"timestamp\").last(\"LIMIT 1\").one();\n conversation.put(\"lastMessageTime\", lastMessage != null ? lastMessage.getTimestamp() : null);\n\n // 2.2 统计该会话的消息总数\n long messageCount = this.query().eq(\"conversation_id\", id).count();\n conversation.put(\"messageCount\", messageCount);\n\n // 2.3 获取该会话的第一条用户消息作为默认标题\n ChatMemory firstUserMessage = this.query()\n .eq(\"conversation_id\", id).eq(\"type\", \"USER\").orderByAsc(\"timestamp\").last(\"LIMIT 1\").one();\n \n String title = \"新的会话\";\n if (firstUserMessage != null &amp;&amp; firstUserMessage.getContent() != null) {\n String content = firstUserMessage.getContent().trim();\n title = content.length() &gt; 20 ? content.substring(0, 20) + \"...\" : content;\n }\n conversation.put(\"title\", title);\n\n return conversation;\n }).toList();\n }\n\n @Override\n public boolean deleteChatHistory(String conversationId) {\n QueryWrapper<chatmemory>queryWrapper = new QueryWrapper&lt;&gt;();\n queryWrapper.eq(\"conversation_id\", conversationId);\n return this.remove(queryWrapper);\n }\n\n @Override\n public Map<string ,="" object="">getConversationStats(String conversationId) {\n // 此处省略了与getAllConversations中类似的单个会话信息查询逻辑\n Map<string ,="" object="">stats = new HashMap&lt;&gt;();\n // ... 查询逻辑 ...\n return stats;\n }\n }\n ```\n\n##### 4\\. API 接口层 (Controller)\n\n * **`ChatHistoryController.java`**:\n 创建一个全新的 Controller，将我们的 Service 方法暴露为 RESTful API，供前端调用。\n ```java\n package com.example.hellospringai.controller;\n\n import com.example.hellospringai.entity.ChatMemory;\n import com.example.hellospringai.service.IChatHistoryService;\n import org.springframework.web.bind.annotation.*;\n import java.util.List;\n import java.util.Map;\n\n @RestController\n @RequestMapping(\"/api/chat-history\") // 为历史记录管理API设置统一前缀\n public class ChatHistoryController {\n\n private final IChatHistoryService chatHistoryService;\n\n public ChatHistoryController(IChatHistoryService chatHistoryService) {\n this.chatHistoryService = chatHistoryService;\n }\n\n @GetMapping(\"/conversations\")\n public List<map<string ,="" object="">&gt; getAllConversations() {\n return chatHistoryService.getAllConversations();\n }\n\n @GetMapping(\"/conversation/{conversationId}\")\n public List<chatmemory>getChatHistory(@PathVariable String conversationId) {\n return chatHistoryService.getChatHistory(conversationId);\n }\n\n @DeleteMapping(\"/conversation/{conversationId}\")\n public Map<string ,="" object="">deleteChatHistory(@PathVariable String conversationId) {\n boolean success = chatHistoryService.deleteChatHistory(conversationId);\n return Map.of(\"success\", success, \"message\", success ? \"删除成功\" : \"删除失败\");\n }\n\n @GetMapping(\"/conversation/{conversationId}/stats\")\n public Map<string ,="" object="">getConversationStats(@PathVariable String conversationId) {\n return chatHistoryService.getConversationStats(conversationId);\n }\n }\n ```\n\n#### 3.6.2 前端集成：实现真正的持久化会话\n\n后端 API 准备就绪后，前端需要进行相应的升级，从完全依赖本地状态，转变为与后端 API 深度集成，实现真正的持久化。\n\n##### 1\\. 新增前端 API 文件\n\n * **`src/api/chatHistory.js`**:\n 创建一个新的 API 文件，专门用于调用我们刚刚创建的后端历史记录管理接口。\n ```javascript\n import request from '../utils/request';\n\n // 获取所有会话列表\n export function getAllConversations() {\n return request({\n url: '/api/chat-history/conversations',\n method: 'get'\n });\n }\n\n // 获取指定会话的聊天历史记录\n export function getChatHistory(conversationId) {\n return request({\n url: `/api/chat-history/conversation/${conversationId}`,\n method: 'get'\n });\n }\n\n // 删除指定会话的聊天记录\n export function deleteChatHistory(conversationId) {\n return request({\n url: `/api/chat-history/conversation/${conversationId}`,\n method: 'delete'\n });\n }\n\n // 获取会话统计信息\n export function getConversationStats(conversationId) {\n return request({\n url: `/api/chat-history/conversation/${conversationId}/stats`,\n method: 'get'\n });\n }\n ```\n\n##### 2\\. 状态与逻辑层核心升级\n\n * **`src/stores/conversationStore.js` (升级版)**:\n 这是前端改动的核心。`store` 不再只是一个简单的本地状态容器，它现在需要负责与后端进行异步通信，加载和管理会话数据。\n\n * **新增 Actions**:\n * `loadConversationsFromBackend()`: 在应用启动时调用，从后端获取所有会话的列表。\n * `loadConversationHistory(conversationId)`: 当用户切换到一个会话时，如果该会话的消息尚未加载，则调用此方法从后端拉取完整的聊天记录。\n * `deleteConversation(conversationId)`: 删除会话时，先调用后端的删除 API，成功后再更新本地状态。\n * **修改现有 Actions**:\n * `switchConversation(conversationId)`: 切换会话时，增加一步检查，如果历史记录未加载，则触发 `loadConversationHistory`。\n\n\n```js\nimport { computed } from 'vue';\nimport { ElMessage, ElMessageBox } from 'element-plus';\nimport { useConversationStore } from '../stores/conversationStore';\nimport { storeToRefs } from 'pinia';\n\n/**\n * 会话管理 composable\n * 处理会话相关的UI交互逻辑\n */\nexport function useConversationManager() {\n const store = useConversationStore();\n const { conversationItems, currentConversation, currentConversationId } = storeToRefs(store);\n\n // 当前选中的会话KEY（用于 Conversations 组件）\n const activeConversationKey = computed({\n get: () =&gt; currentConversationId.value,\n set: async (value) =&gt; {\n if (value &amp;&amp; value !== currentConversationId.value) {\n try {\n await store.switchConversation(value);\n } catch (error) {\n console.error('切换会话失败:', error);\n ElMessage.error('切换会话失败');\n }\n }\n }\n });\n\n // 当前会话标题\n const currentConversationTitle = computed(() =&gt; {\n return currentConversation.value?.title || 'Spring AI 全栈聊天机器人';\n });\n\n /**\n * 会话切换处理\n */\n const handleConversationChange = async (item) =&gt; {\n console.log('会话切换:', item);\n try {\n await store.switchConversation(item.id);\n ElMessage.success(`切换到: ${item.label}`);\n } catch (error) {\n console.error('切换会话失败:', error);\n ElMessage.error('切换会话失败');\n }\n };\n\n /**\n * 新建会话\n */\n const handleCreateNewConversation = () =&gt; {\n const conversationId = store.createConversation();\n ElMessage.success('新建会话成功');\n console.log('新建会话:', conversationId);\n return conversationId;\n };\n\n /**\n * 清空当前会话历史\n */\n const handleClearCurrentHistory = () =&gt; {\n return ElMessageBox.confirm(\n '确定要清空当前会话的所有消息吗？',\n '确认清空',\n {\n confirmButtonText: '确定',\n cancelButtonText: '取消',\n type: 'warning',\n }\n ).then(() =&gt; {\n store.clearCurrentHistory();\n ElMessage.success('已清空当前会话历史');\n }).catch(() =&gt; {\n // 用户取消操作\n });\n };\n\n /**\n * 处理会话菜单命令（重命名、删除）\n */\n const handleMenuCommand = (command, item) =&gt; {\n console.log('菜单命令:', command, item);\n\n switch (command) {\n case 'rename':\n handleRenameConversation(item);\n break;\n case 'delete':\n handleDeleteConversation(item);\n break;\n default:\n console.warn('未知的菜单命令:', command);\n }\n };\n\n /**\n * 重命名会话\n */\n const handleRenameConversation = (item) =&gt; {\n return ElMessageBox.prompt('请输入新的会话名称', '重命名会话', {\n confirmButtonText: '确定',\n cancelButtonText: '取消',\n inputValue: item.label,\n inputPattern: /^.{1,50}$/,\n inputErrorMessage: '会话名称长度必须在1-50个字符之间'\n }).then(({ value }) =&gt; {\n store.renameConversation(item.id, value);\n ElMessage.success('重命名成功');\n }).catch(() =&gt; {\n // 用户取消操作\n });\n };\n\n /**\n * 删除会话\n */\n const handleDeleteConversation = (item) =&gt; {\n return ElMessageBox.confirm(\n `确定要删除会话 \"${item.label}\" 吗？此操作不可撤销。`,\n '确认删除',\n {\n confirmButtonText: '确定',\n cancelButtonText: '取消',\n type: 'warning',\n }\n ).then(async () =&gt; {\n try {\n const result = await store.deleteConversation(item.id);\n if (result.success) {\n ElMessage.success(result.message || '删除成功');\n } else {\n ElMessage.error(result.message || '删除失败');\n }\n } catch (error) {\n console.error('删除会话失败:', error);\n ElMessage.error('删除会话失败: ' + error.message);\n }\n }).catch(() =&gt; {\n // 用户取消操作\n });\n };\n\n return {\n // 状态\n conversationItems,\n currentConversation,\n currentConversationId,\n activeConversationKey,\n currentConversationTitle,\n\n // 方法\n handleConversationChange,\n handleCreateNewConversation,\n handleClearCurrentHistory,\n handleMenuCommand,\n handleRenameConversation,\n handleDeleteConversation\n };\n} \n```\n\n\n\n * **`src/composables/useChat.js` 和 `useConversationManager.js` (升级版)**:\n* **`useChat.js`** 新增 `onMounted`生命周期钩子，在组件挂载时调用 `store` 中的 `initializeDefaultConversation`（或 `loadConversationsFromBackend`），实现应用启动时自动加载历史会话。\n * **`useConversationManager.js`** 中的删除、切换等方法现在会调用 `store` 中对应的**异步 action**，并处理 `Promise` 的成功或失败状态，向用户显示如 `ElMessage` 的提示信息。\n\n```js\nimport { ref, watch, computed, onMounted } from 'vue';\nimport { useConversationStore } from '../stores/conversationStore';\nimport { storeToRefs } from 'pinia';\nimport { streamChat } from '../api/chat';\nimport { useXStream } from 'vue-element-plus-x';\n\n/**\n * 聊天核心逻辑 composable\n * 处理消息发送、流式接收、状态管理等\n */\nexport function useChat() {\n // 状态管理 - 使用新的会话管理系统\n const store = useConversationStore();\n const { currentMessages, currentConversationId } = storeToRefs(store);\n\n // 输入消息\n const inputMessage = ref('');\n\n // 使用 useXStream 处理流式数据\n const { startStream, cancel, isLoading, data, error } = useXStream();\n\n // 计算属性处理累积的流式数据\n const streamContent = computed(() =&gt; {\n if (!data.value.length) return '';\n\n let text = '';\n for (let index = 0; index &lt; data.value.length; index++) {\n const chunk = data.value[index];\n try {\n // 检查chunk是否是对象且包含data属性\n if (typeof chunk === 'object' &amp;&amp; chunk !== null &amp;&amp; 'data' in chunk) {\n // 处理非空data\n if (chunk.data) {\n text += chunk.data;\n } else if (chunk.data === '') {\n // 空data块通常表示换行符\n text += '\\n';\n }\n } else if (typeof chunk === 'string') {\n text += chunk;\n } else {\n console.warn('未知的chunk格式:', chunk);\n }\n } catch (error) {\n console.error('解析流数据时出错:', error);\n }\n }\n return text;\n });\n\n // 监听流式数据更新，实时追加到消息中\n watch(streamContent, (newContent, oldContent) =&gt; {\n if (newContent &amp;&amp; newContent !== oldContent) {\n // 获取新增的内容部分\n const newChunk = newContent.slice(oldContent?.length || 0);\n if (newChunk) {\n store.appendToLastMessage(newChunk);\n }\n }\n });\n\n // 监听错误信息\n watch(error, (errorInfo) =&gt; {\n if (errorInfo) {\n console.error(\"流式请求失败:\", errorInfo);\n store.appendToLastMessage(\"\\n\\n抱歉，处理您的请求时遇到了问题。\");\n }\n });\n\n /**\n * 处理用户提交消息\n * 使用 useXStream 处理流式接收\n */\n const handleUserSubmit = async () =&gt; {\n const messageContent = inputMessage.value.trim();\n\n // 验证输入\n if (!messageContent || isLoading.value) {\n return;\n }\n\n // 确保有当前会话ID\n if (!currentConversationId.value) {\n await store.initializeDefaultConversation();\n }\n\n try {\n // 1. 添加用户消息到对话历史\n store.addMessage({\n role: 'user',\n content: messageContent\n });\n\n // 2. 清空输入框\n inputMessage.value = '';\n\n // 3. 创建AI回复占位\n store.addMessage({\n role: 'assistant',\n content: ''\n });\n\n // 4. 获取流式响应，传递当前会话ID\n const response = await streamChat(messageContent, currentConversationId.value);\n console.log('发送请求，会话ID:', currentConversationId.value);\n console.log(response);\n\n // 5. 使用 useXStream 处理流式数据\n await startStream({\n readableStream: response.body\n });\n\n } catch (err) {\n console.error(\"发起流式请求失败:\", err);\n store.appendToLastMessage(\"\\n\\n抱歉，发起请求时遇到了问题。\");\n }\n };\n\n // 组件挂载时初始化\n onMounted(async () =&gt; {\n try {\n await store.initializeDefaultConversation();\n console.log('会话初始化完成');\n } catch (error) {\n console.error('会话初始化失败:', error);\n }\n });\n\n return {\n // 状态\n messages: currentMessages, // 返回当前会话的消息\n isGenerating: isLoading, // 使用 useXStream 的 isLoading 状态\n inputMessage,\n currentConversationId,\n\n // 方法\n handleUserSubmit,\n\n // 流式处理相关\n cancel // 暴露取消功能\n };\n}\n```\n\n**`useConversationManager`**\n\n```js\nimport { computed } from 'vue';\nimport { ElMessage, ElMessageBox } from 'element-plus';\nimport { useConversationStore } from '../stores/conversationStore';\nimport { storeToRefs } from 'pinia';\n\n/**\n * 会话管理 composable\n * 处理会话相关的UI交互逻辑\n */\nexport function useConversationManager() {\n const store = useConversationStore();\n const { conversationItems, currentConversation, currentConversationId } = storeToRefs(store);\n\n // 当前选中的会话KEY（用于 Conversations 组件）\n const activeConversationKey = computed({\n get: () =&gt; currentConversationId.value,\n set: async (value) =&gt; {\n if (value &amp;&amp; value !== currentConversationId.value) {\n try {\n await store.switchConversation(value);\n } catch (error) {\n console.error('切换会话失败:', error);\n ElMessage.error('切换会话失败');\n }\n }\n }\n });\n\n // 当前会话标题\n const currentConversationTitle = computed(() =&gt; {\n return currentConversation.value?.title || 'Spring AI 全栈聊天机器人';\n });\n\n /**\n * 会话切换处理\n */\n const handleConversationChange = async (item) =&gt; {\n console.log('会话切换:', item);\n try {\n await store.switchConversation(item.id);\n ElMessage.success(`切换到: ${item.label}`);\n } catch (error) {\n console.error('切换会话失败:', error);\n ElMessage.error('切换会话失败');\n }\n };\n\n /**\n * 新建会话\n */\n const handleCreateNewConversation = () =&gt; {\n const conversationId = store.createConversation();\n ElMessage.success('新建会话成功');\n console.log('新建会话:', conversationId);\n return conversationId;\n };\n\n /**\n * 清空当前会话历史\n */\n const handleClearCurrentHistory = () =&gt; {\n return ElMessageBox.confirm(\n '确定要清空当前会话的所有消息吗？',\n '确认清空',\n {\n confirmButtonText: '确定',\n cancelButtonText: '取消',\n type: 'warning',\n }\n ).then(() =&gt; {\n store.clearCurrentHistory();\n ElMessage.success('已清空当前会话历史');\n }).catch(() =&gt; {\n // 用户取消操作\n });\n };\n\n /**\n * 处理会话菜单命令（重命名、删除）\n */\n const handleMenuCommand = (command, item) =&gt; {\n console.log('菜单命令:', command, item);\n\n switch (command) {\n case 'rename':\n handleRenameConversation(item);\n break;\n case 'delete':\n handleDeleteConversation(item);\n break;\n default:\n console.warn('未知的菜单命令:', command);\n }\n };\n\n /**\n * 重命名会话\n */\n const handleRenameConversation = (item) =&gt; {\n return ElMessageBox.prompt('请输入新的会话名称', '重命名会话', {\n confirmButtonText: '确定',\n cancelButtonText: '取消',\n inputValue: item.label,\n inputPattern: /^.{1,50}$/,\n inputErrorMessage: '会话名称长度必须在1-50个字符之间'\n }).then(({ value }) =&gt; {\n store.renameConversation(item.id, value);\n ElMessage.success('重命名成功');\n }).catch(() =&gt; {\n // 用户取消操作\n });\n };\n\n /**\n * 删除会话\n */\n const handleDeleteConversation = (item) =&gt; {\n return ElMessageBox.confirm(\n `确定要删除会话 \"${item.label}\" 吗？此操作不可撤销。`,\n '确认删除',\n {\n confirmButtonText: '确定',\n cancelButtonText: '取消',\n type: 'warning',\n }\n ).then(async () =&gt; {\n try {\n const result = await store.deleteConversation(item.id);\n if (result.success) {\n ElMessage.success(result.message || '删除成功');\n } else {\n ElMessage.error(result.message || '删除失败');\n }\n } catch (error) {\n console.error('删除会话失败:', error);\n ElMessage.error('删除会话失败: ' + error.message);\n }\n }).catch(() =&gt; {\n // 用户取消操作\n });\n };\n\n return {\n // 状态\n conversationItems,\n currentConversation,\n currentConversationId,\n activeConversationKey,\n currentConversationTitle,\n\n // 方法\n handleConversationChange,\n handleCreateNewConversation,\n handleClearCurrentHistory,\n handleMenuCommand,\n handleRenameConversation,\n handleDeleteConversation\n };\n} \n```\n\n通过以上改造，我们的应用流程变为：\n\n1. **应用启动**: `onMounted` 触发，`store` 调用后端 `/api/chat-history/conversations` 接口，获取所有会话的概要信息并展示在左侧列表。\n2. **切换会话**: 用户点击会话列表项，`store` 检查该会话的详细消息是否已加载。若未加载，则调用 `/api/chat-history/conversation/{id}` 接口获取数据，然后更新界面。\n3. **删除会话**: 用户点击删除，`store` 调用后端 `DELETE` 接口，成功后从本地 `state` 中移除该会话。\n\n至此，我们的聊天应用不再是一个“健忘”的工具，而是一个功能完备、数据持久、体验流畅的全栈应用。\n\n\n\n\n\n" };<div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/16/684f747174bc3.webp" onerror="this.onerror=null,this.src=&quot;/img/friend_404.gif&quot;" alt="avatar"><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/user/status.png" alt="status"></div></div><div class="author-info__description"><div style="line-height:1.4;color:rgba(255,255,255,.9);text-align:center">🚀 全栈开发者，专注于构建优雅高效的数字解决方案<br><span style="color:#fff;font-weight:700">前端 · 后端 · 架构 · 优化</span><br>📚 分享实战经验，一起探索技术边界</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Prorise</h1><div class="author-info__desc">这聒噪的世界让沉默的人显得另类</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/361040115?spm_id_from=333.1387.0.0" rel="external nofollow noreferrer" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background:url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center/100% no-repeat"></div><div class="back face" style="background:url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center/100% no-repeat"></div></div></div></div><div class="card-widget card-latest-comments"><div class="item-headline"><i class="fas fa-comments"></i><span>最新评论</span></div><div class="item-content"><a href="/messages/" class="headline-right" title="查看更多"><i class="fas fa-angle-right"></i></a><div class="aside-list" id="latest-comments"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AF%B9%E8%AF%9D%E6%A0%B8%E5%BF%83-API-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">3. 对话核心 API 深度解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-ChatClient-%E5%AF%B9%E8%AF%9D%E7%9A%84%E6%A0%B8%E5%BF%83%E6%9E%A2%E7%BA%BD"><span class="toc-number">1.1.</span> <span class="toc-text">3.1 ChatClient: 对话的核心枢纽</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-call-vs-stream-%E5%90%8C%E6%AD%A5%E4%B8%8E%E6%B5%81%E5%BC%8F%E7%9A%84%E6%8A%89%E6%8B%A9"><span class="toc-number">1.1.1.</span> <span class="toc-text">3.1.1 call() vs. stream(): 同步与流式的抉择</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-ChatClient-%E5%AE%9E%E6%88%98%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.2.</span> <span class="toc-text">3.1.2 ChatClient 实战代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-%E5%B0%8F%E7%BB%93%EF%BC%9A%E5%A6%82%E4%BD%95%E8%AE%BF%E9%97%AE%E5%92%8C%E6%B5%8B%E8%AF%95API"><span class="toc-number">1.1.3.</span> <span class="toc-text">3.1.3 小结：如何访问和测试API</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E8%B0%83%E8%AF%95%E4%B8%8E%E6%B4%9E%E5%AF%9F%EF%BC%9AAdvisor-%E4%B8%8E%E6%97%A5%E5%BF%97"><span class="toc-number">1.2.</span> <span class="toc-text">3.2 调试与洞察：Advisor 与日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">3.3 前端环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-%E5%88%9D%E5%A7%8B%E5%8C%96-Vue-3-%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.3.1 初始化 Vue 3 项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-%E9%9B%86%E6%88%90-Tailwind-CSS"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.3.2 集成 Tailwind CSS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-%E9%9B%86%E6%88%90-UI-%E7%BB%84%E4%BB%B6%E5%BA%93-DaisyUI-Element-Plus"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3.3 集成 UI 组件库 (DaisyUI &amp; Element Plus)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-4-%E4%B8%BB%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3%E9%85%8D%E7%BD%AE-main-js"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.3.4 主程序入口配置 (main.js)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E9%98%B6%E6%AE%B5%E5%B0%8F%E5%AE%9E%E6%88%98%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7AI%E5%AF%B9%E8%AF%9D%E7%95%8C%E9%9D%A2"><span class="toc-number">1.4.</span> <span class="toc-text">3.4 阶段小实战：构建企业级AI对话界面</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-1-%E6%A0%B8%E5%BF%83%E4%BE%9D%E8%B5%96%E8%A1%A5%E5%85%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.4.1 核心依赖补全</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E5%88%9B%E5%BB%BA"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.3.2 项目目录结构创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-3-%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.4.3 核心代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#0-%E5%A4%84%E7%90%86API%E8%AF%B7%E6%B1%82%EF%BC%88Axios%EF%BC%89"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">0.处理API请求（Axios）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E5%B1%82-Pinia"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">1. 状态管理层 (Pinia)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%8F%AF%E7%BB%84%E5%90%88%E5%87%BD%E6%95%B0-Composables"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">2. 可组合函数 (Composables)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E8%A7%86%E5%9B%BE%E5%B1%82-ChatView-vue"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">3. 视图层 (ChatView.vue)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E4%B8%BB%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3-src-main-js"><span class="toc-number">1.4.3.5.</span> <span class="toc-text">4. 主程序入口 (src/main.js)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.3.6.</span> <span class="toc-text">5.后端配置跨域请求</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E5%AF%B9%E8%AF%9D%E8%AE%B0%E5%BF%86-Chat-Memory-%EF%BC%9A%E8%AE%A9-AI-%E6%8B%A5%E6%9C%89%E4%B8%8A%E4%B8%8B%E6%96%87-%E6%9F%A5%E9%98%85"><span class="toc-number">1.5.</span> <span class="toc-text">3.5 对话记忆 (Chat Memory)：让 AI 拥有上下文 (查阅)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-1-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%EF%BC%9A%E7%AD%96%E7%95%A5%E4%B8%8E%E5%AD%98%E5%82%A8%E7%9A%84%E5%88%86%E7%A6%BB"><span class="toc-number">1.5.1.</span> <span class="toc-text">3.5.1 核心概念：策略与存储的分离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-2-%E8%AE%B0%E5%BF%86%E7%AD%96%E7%95%A5%EF%BC%9AMessageWindowChatMemory"><span class="toc-number">1.5.2.</span> <span class="toc-text">3.5.2 记忆策略：MessageWindowChatMemory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-3-%E8%AE%B0%E5%BF%86%E5%AD%98%E5%82%A8%EF%BC%9A%E4%BB%8E%E5%86%85%E5%AD%98%E5%88%B0%E6%8C%81%E4%B9%85%E5%8C%96-ChatMemoryRepository-%E6%9F%A5%E9%98%85"><span class="toc-number">1.5.3.</span> <span class="toc-text">3.5.3 记忆存储：从内存到持久化 (ChatMemoryRepository) (查阅)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%86%85%E5%AD%98%E5%AD%98%E5%82%A8%E5%BA%93-InMemoryChatMemoryRepository"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">1. 内存存储库 (InMemoryChatMemoryRepository)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-JDBC-%E5%AD%98%E5%82%A8%E5%BA%93-JdbcChatMemoryRepository"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">2. JDBC 存储库 (JdbcChatMemoryRepository)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-4-%E9%9B%86%E6%88%90%E4%B8%8E%E9%85%8D%E7%BD%AE%EF%BC%9A%E5%B0%86%E8%AE%B0%E5%BF%86%E6%B3%A8%E5%85%A5-ChatClient-%E6%9F%A5%E9%98%85"><span class="toc-number">1.5.4.</span> <span class="toc-text">3.5.4 集成与配置：将记忆注入 ChatClient (查阅)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%84%E5%90%88%E9%85%8D%E7%BD%AE-CommonConfiguration-java"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">组合配置 CommonConfiguration.java</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-5-%E5%AE%9E%E9%99%85%E8%B0%83%E7%94%A8%EF%BC%9A%E4%BC%A0%E9%80%92%E4%BC%9A%E8%AF%9D-ID"><span class="toc-number">1.5.5.</span> <span class="toc-text">3.5.5 实际调用：传递会话 ID</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Service-%E5%B1%82%E6%94%B9%E9%80%A0"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">1. Service 层改造</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Controller-%E5%B1%82%E6%94%B9%E9%80%A0"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">2. Controller 层改造</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-6-%E5%89%8D%E7%AB%AF%E9%80%82%E9%85%8D%EF%BC%9A%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.6.</span> <span class="toc-text">3.5.6 前端适配：核心代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-API-%E5%B1%82-src-api-chat-js"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">1. API 层: src/api/chat.js</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E5%B1%82-src-stores-conversationStore-js"><span class="toc-number">1.5.6.2.</span> <span class="toc-text">2. 状态管理层: src/stores/conversationStore.js</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E9%80%BB%E8%BE%91%E5%B1%82-Composables"><span class="toc-number">1.5.6.3.</span> <span class="toc-text">3. 逻辑层: Composables</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E8%A7%86%E5%9B%BE%E5%B1%82-src-views-ChatView-vue"><span class="toc-number">1.5.6.4.</span> <span class="toc-text">4. 视图层: src/views/ChatView.vue</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E4%BC%9A%E8%AF%9D%E5%8E%86%E5%8F%B2%EF%BC%9A%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8A%A0%E8%BD%BD%E4%B8%8E%E7%AE%A1%E7%90%86"><span class="toc-number">1.6.</span> <span class="toc-text">3.6 会话历史：从数据库加载与管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-1-%E5%90%8E%E7%AB%AF%E5%BB%BA%E8%AE%BE%EF%BC%9A%E6%9E%84%E5%BB%BA%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.6.1.</span> <span class="toc-text">3.6.1 后端建设：构建历史记录服务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">1. 引入依赖与配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82-Entity-Mapper"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">2. 数据访问层 (Entity &amp; Mapper)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%B1%82-Service-ServiceImpl"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">3. 业务逻辑层 (Service &amp; ServiceImpl)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-API-%E6%8E%A5%E5%8F%A3%E5%B1%82-Controller"><span class="toc-number">1.6.1.4.</span> <span class="toc-text">4. API 接口层 (Controller)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-2-%E5%89%8D%E7%AB%AF%E9%9B%86%E6%88%90%EF%BC%9A%E5%AE%9E%E7%8E%B0%E7%9C%9F%E6%AD%A3%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E4%BC%9A%E8%AF%9D"><span class="toc-number">1.6.2.</span> <span class="toc-text">3.6.2 前端集成：实现真正的持久化会话</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%96%B0%E5%A2%9E%E5%89%8D%E7%AB%AF-API-%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">1. 新增前端 API 文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%8A%B6%E6%80%81%E4%B8%8E%E9%80%BB%E8%BE%91%E5%B1%82%E6%A0%B8%E5%BF%83%E5%8D%87%E7%BA%A7"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">2. 状态与逻辑层核心升级</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%89-%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F-api-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/" title="Java微服务（三）：3. 核心抽象 API 深度解析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/19/68535b23089d0.webp" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" alt="Java微服务（三）：3. 核心抽象 API 深度解析"></a><div class="content"><a class="title" href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%89-%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F-api-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/" title="Java微服务（三）：3. 核心抽象 API 深度解析">Java微服务（三）：3. 核心抽象 API 深度解析</a><time datetime="2025-06-21T02:44:31.269Z" title="发表于 2025-06-21 10:44:31">2025-06-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%9B%9B-%E6%B7%B1%E5%85%A5-prompt-%E5%B7%A5%E7%A8%8B/" title="Java微服务（四）：4. 深入 Prompt 工程"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/19/68535b23089d0.webp" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" alt="Java微服务（四）：4. 深入 Prompt 工程"></a><div class="content"><a class="title" href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%9B%9B-%E6%B7%B1%E5%85%A5-prompt-%E5%B7%A5%E7%A8%8B/" title="Java微服务（四）：4. 深入 Prompt 工程">Java微服务（四）：4. 深入 Prompt 工程</a><time datetime="2025-06-20T08:13:45.000Z" title="发表于 2025-06-20 16:13:45">2025-06-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BA%8C-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%9E%84%E5%BB%BA%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-ai-%E5%BA%94%E7%94%A8/" title="Java微服务（二）：2. 快速入门：构建你的第一个 AI 应用"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/19/68535b23089d0.webp" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" alt="Java微服务（二）：2. 快速入门：构建你的第一个 AI 应用"></a><div class="content"><a class="title" href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BA%8C-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%9E%84%E5%BB%BA%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-ai-%E5%BA%94%E7%94%A8/" title="Java微服务（二）：2. 快速入门：构建你的第一个 AI 应用">Java微服务（二）：2. 快速入门：构建你的第一个 AI 应用</a><time datetime="2025-06-18T08:13:45.000Z" title="发表于 2025-06-18 16:13:45">2025-06-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%80%E5%BA%8F%E7%AB%A0%E8%BF%8E%E6%8E%A5-java-ai-%E5%BC%80%E5%8F%91%E6%96%B0%E7%BA%AA%E5%85%83/" title="Java微服务（一）：1. 序章：迎接 Java AI 开发新纪元"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/19/68535b23089d0.webp" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" alt="Java微服务（一）：1. 序章：迎接 Java AI 开发新纪元"></a><div class="content"><a class="title" href="/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Java/java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%80%E5%BA%8F%E7%AB%A0%E8%BF%8E%E6%8E%A5-java-ai-%E5%BC%80%E5%8F%91%E6%96%B0%E7%BA%AA%E5%85%83/" title="Java微服务（一）：1. 序章：迎接 Java AI 开发新纪元">Java微服务（一）：1. 序章：迎接 Java AI 开发新纪元</a><time datetime="2025-06-17T08:13:45.000Z" title="发表于 2025-06-17 16:13:45">2025-06-17</time></div></div></div></div></div></div><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:3381292732@qq.com" rel="external nofollow noreferrer" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://weibo.com/u/7484736298?tabtype=home" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/16/684f745b722d7.webp" size="50px"><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Prorise-cool" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://space.bilibili.com/361040115?spm_id_from=333.788.0.0" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div id="workboard"><div id="runtimeTextTip"></div></div><div class="footer_custom_text">这是我的个人博客，分享技术与生活点滴。</div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener external nofollow noreferrer" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.foreverblog.cn/">十年之约</a></div></div><div class="footer-group"><div class="footer-title">主题</div><div class="footer-links"><a class="footer-item" title="文档" href="/docs/">文档</a><a class="footer-item" title="源码" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu">源码</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" rel="external nofollow noreferrer" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="博客框架为Hexo7.0" title="博客框架为Hexo7.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo7.0"></a><a class="github-badge" target="_blank" href="https://www.dogecloud.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站使用多吉云为静态资源提供CDN加速" title="本站使用多吉云为静态资源提供CDN加速"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/CDN-多吉云-3693F3.svg" alt="本站使用多吉云为静态资源提供CDN加速"></a><a class="github-badge" target="_blank" href="https://github.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站采用CC BY-NC-SA 4.0协议" title="本站采用CC BY-NC-SA 4.0协议"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用CC BY-NC-SA 4.0协议"></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">©2025 By <a class="footer-bar-link" href="/about/" title="Prorise" target="_blank">Prorise</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = ["生活明朗, 万物可爱, 人间值得, 未来可期.","愿你眼里的星星，永远亮晶晶。","愿我们每个人都能被世界温柔以待。"]
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/typed.js/2.0.12/typed.min.js').then(subtitleType)
  }
} else {
  subtitleType()
}</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Prorise-cool?tab=repositories" title="网站源码">网站源码</a><a class="footer-bar-link" target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn/" title="湘ICP备23041-302号">湘ICP备23041-302号</a><a class="footer-bar-link cc" href="/copyright" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">4</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">2</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" rel="external nofollow noreferrer" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="后续项目..."><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="后续项目..."><span class="back-menu-item-text">后续项目...</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>个人</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="fas fa-check-double faa-tada"></i><span> 代办清单</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/awesome-links/"><i class="fas fa-link faa-tada"></i><span> 实用网站</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>预览</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?server=netease&amp;id=3117791189"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/messages/"><i class="fas fa-comments faa-tada"></i><span> 评论总览</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 即刻短文</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Java%E5%BE%AE%E6%9C%8D%E5%8A%A1-AI%E7%AF%87/" style="font-size:.88rem">Java微服务-AI篇<sup>4</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"></div></div></string></string></chatmemory></map<string></string></string></chatmemory></string></string></chatmemory></chatmemory></map<string></chatmemory></chatmemory></chatmemorymapper></string></map<string></chatmemory></chatmemory></chatmemory></sender></div></bubblelist></div></div></button><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight,500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="anzhiyufont anzhiyu-icon-comment-sms"></i></button><button id="to_comment" type="button" title="直达评论" onclick="FixedCommentBtn()"><i class="anzhiyufont anzhiyu-icon-comments"></i></button><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" rel="external nofollow noreferrer" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="download-md-btn" type="button" title="下载文章源文件"><i class="anzhiyufont anzhiyu-icon-download"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="3117791189" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=3117791189&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async="" src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>//- 从这里开始的所有JS代码，都必须有缩进（例如2个空格）
// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("06/10/2025 00:00:00"); // 此处读取您配置中的建站时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  
  // --- 已将您的专属LOGO和个人信息集成到这里 ---
  const ascll = [
    `欢迎访问 Prorise 的数字空间!`,
    `代码构建世界，思想驱动未来`,
    // 这里的反引号和所有ASCII art行，都必须有正确的缩进
    `
     ____                      _             
    |  _ \\  _ __   ___   _ __  (_) ___   ___  
    | |_) || '__| / _ \\ | '__| | |/ __| / _ \\ 
    |  __/ | |   | (_) || |    | |\\__ \\|  __/ 
    |_|    |_|    \\___/ |_|    |_||___/ \\___| 
                                             
    `,
    "已稳定运行",
    dnum,
    "天",
    `©2025 By Prorise 1.0.0`,
  ];
  
  const ascll2 = [`SYS-INFO`, `前置摄像头拍照成功`, `您的帅气脸庞为：`, `😎`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c${ascll[2]} \n%c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF; font-family:monospace;",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );

  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，朋友.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Created by Prorise %c 你正在访问 Prorise 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 注意，你的所有操作已被记录.", "color:white; background-color:#d9534f", "")
  );
});</script><script async="" src="/anzhiyu/random.js"></script><script async="">(function () {
  var grt = new Date("06/10/2025 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "";
        img.title = "下班了就该开开心心的玩耍，嘿嘿~";
        img.alt = "下班了就该开开心心的玩耍，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js').then(runMermaid)
  }

  anzhiyu.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.prorise666.site/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.prorise666.site/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  let initFn = window.walineFn || null

  const initWaline = (Fn) => {
    const waline = Fn(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://waline.prorise666.site',
      pageview: true,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: true,
      imageUploader: true,
    }, null))

    const destroyWaline = () => {
      waline.destroy()
    }

    anzhiyu.addGlobalFn('pjax', destroyWaline, 'destroyWaline')
  }

  const loadWaline = async () => {
    if (initFn) initWaline(initFn)
    else {
      await getCSS('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline.css')
      if (true) await getCSS('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline-meta.css')
      const { init } = await import('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline.js')
      initFn = init || Waline.init
      initWaline(initFn)
      window.walineFn = initFn
    }
  }

  if ('Twikoo' === 'Waline' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async="" src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.prorise666.site/',
        region: 'ap-shanghai',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async="" data-pjax="" src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail=""</script><script async="" data-pjax="" src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="/js/load-on-demand.js"></script><script src="/custom/js/markdown-download.js"></script><script defer="" id="fluttering_ribbon" mobile="false" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="" color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script src="//code.tidio.co//tk571vck0ua2wjoalfbp8wyrlsdaunmz.js" async=""></script><script>(() => {
  const isChatBtn = true
  const isChatHideShow = true

  if (isChatBtn) {
    let isShow = false
    const close = () => {
      window.tidioChatApi.hide()
      isShow = false
      document.body.style.position = 'relative';
      document.documentElement.style.overflow = 'auto'
    }
    
    const open = () => {
      window.tidioChatApi.open()
      window.tidioChatApi.show()
      isShow = true
    }

    const onTidioChatApiReady = () => {
      window.tidioChatApi.hide()
      window.tidioChatApi.on("close", close)
    }
    if (window.tidioChatApi) {
      window.tidioChatApi.on("ready", onTidioChatApiReady)
    } else {
      document.addEventListener("tidioChat-ready", onTidioChatApiReady)
    }

    window.chatBtnFn = () => {
      if (!window.tidioChatApi) return
      isShow ? close() : open()
    }
  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => {
        window.tidioChatApi && window.tidioChatApi.hide()
      },
      show: () => {
        window.tidioChatApi && window.tidioChatApi.show()
      }
    }
  }
})()</script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://npm.elemecdn.com/meting@2.0.1/dist/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '[object Object]', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div>
    <link rel="stylesheet" href="https://ai.tianli0.top/static/public/postChatUser_summary.min.css">
    <script>
        let tianliGPT_key = '';
        let tianliGPT_postSelector = '#post-container .post-content';
        let tianliGPT_Title = '✨ AI 文章摘要';
        let tianliGPT_postURL = '/^https?:\/\/[^\/]+\/[0-9]{4}\/[0-9]{2}\/[0-9]{2}\/';
        let tianliGPT_blacklist = '';
        let tianliGPT_wordLimit = '1000';
        let tianliGPT_typingAnimate = true;
        let tianliGPT_theme = 'default';
        var postChatConfig = {
          backgroundColor: "#4d648d",
          bottom: "76px",
          left: "16px",
          fill: "#FFFFFF",
          width: "50px",
          frameWidth: "380px",
          frameHeight: "600px",
          defaultInput: true,
          upLoadWeb: true,
          showInviteLink: true,
          userTitle: "💬 智能助手",
          userDesc: "我是 Prorise 博客的 AI 助手，有任何关于网站内容的问题都可以问我哦～",
          addButton: true,
          beginningText: "这篇文章介绍了",
          userIcon: "https://ai.tianli0.top/static/img/PostChat.webp",
          userMode: "magic",
          defaultChatQuestions: ["你好","你是谁"],
          defaultSearchQuestions: ["视频压缩","设计"]
        };
    </script>
    <script data-postchat_key="" src="https://ai.tianli0.top/static/public/tianli_gpt.min.js"></script>
  </body></html>