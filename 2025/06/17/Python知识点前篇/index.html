<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Python教程：Python知识点前篇速览 | 格物致知</title><meta name="keywords" content="Python入门, Python基础, 变量, 数据类型, 循环"><meta name="author" content="Prorise"><meta name="copyright" content="Prorise"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#cee8ff"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Python教程：Python知识点前篇速览"><meta name="application-name" content="Python教程：Python知识点前篇速览"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#cee8ff"><meta property="og:type" content="article"><meta property="og:title" content="Python教程：Python知识点前篇速览"><meta property="og:url" content="https://prorise-cool.github.io/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/index.html"><meta property="og:site_name" content="格物致知"><meta property="og:description" content="Python系列教程开篇之作：本篇将以更高的阶级开始，带您了解Pytthon更进阶的语法特性与使用价值"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2025/06/17/685113b7c39b1.webp"><meta property="article:author" content="Prorise"><meta property="article:tag" content="全栈, Full Stack, 前端, 后端, Node.js, Vue, React, 数据库, Linux, Docker, 个人博客, 技术分享"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2025/06/17/685113b7c39b1.webp"><meta name="description" content="Python系列教程开篇之作：本篇将以更高的阶级开始，带您了解Pytthon更进阶的语法特性与使用价值"><link rel="shortcut icon" href="/img/icons/favicon.ico"><link rel="canonical" href="https://prorise-cool.github.io/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="code-xxx"><meta name="msvalidate.01" content="xxx"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media=&quot;all&quot;"><script async="" src="https://www.googletagmanager.com/gtag/js?id=[object Object]"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","[object Object]")</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"与数百名博主无限进步","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"Prorise","mode":"tianli","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"S-DNA1JM95BX2F9L0N","Referer":"https://xx.xx/"},
  diytitle: undefined,
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo.prorise666.site/',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":4000,"accessToken":"b39753735ed0ed5ffeb771bc108e3158","mailMd5":"ec3291d59a8d7d3675df8a0537fcbc979f0fa611c8df55841fb7f4fd162bd07a"},
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"both","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["🤣 全栈开发工程师","🙂 前端架构设计师","🙃 后端服务构建者","🤩 移动端应用开发","🤯 数据库设计专家","🥳 DevOps运维实践者","🤭 技术栈多面手","😎 性能优化达人"]},
  algolia: {"appId":"K8Y7M0RMXQ","apiKey":"11fa7380e2694483a44b143044e69e6e","indexName":"prorise_blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":3,"position":"top","messagePrev":"距离上次更新已经过了","messageNext":"天，文章内容可能已经过时。"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Prorise","link":"链接: ","source":"来源: 格物致知","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"格物致知",title:"Python教程：Python知识点前篇速览",postAI:"true",pageFillDescription:"Python 语言特性, 编译型 vs 解释型, 强类型 vs 弱类型, 动态型 vs 静态型, 类型提示, 第一章：字符串打印格式化与PyCharm模板变量, 字符串打印格式化 (ANSI 转义序列), 基本语法, ANSI 转义码表, 实用示例, 基本颜色设置, 组合使用, 实际应用场景 (封装为 print_utils.py 工具模块), PyCharm Live Templates 提升编码效率, 1. 基本循环, a. for...in 循环 (遍历序列), b. for...in enumerate 循环 (带索引遍历), c. for...in range 循环 (按次数), 2. 条件判断, a. if 语句, b. if-else 语句, c. if-elif-else 语句, 3. 打印与日志, a. print(f...) (f-string 打印), b. logger.info (快速日志记录 - 假设 logger 对象已配置), 4. Python 结构与定义, c. 类定义 (基本结构), d. @dataclass 类定义, 5. 异常处理, a. try-except 基本块, b. try-except-else-finally 完整块, 6. 文件操作, a. with open(...) 上下文管理器, 7. 推导式, a. 列表推导式 (List Comprehension), b. 字典推导式 (Dictionary Comprehension), 8. 其他, a. lambda 匿名函数, b. 注释标记, 第二章：转义字符, 第三章：运算符, 运算符优先级, 运算符表, 赋值技巧, 第四章：类型转换详解, 4.1 基本数据类型转换, 整型转换 int(), 浮点型转换 float(), 字符串转换 str(), 布尔值转换 bool(), 4.2 集合类型转换, 列表转换 list(), 元组转换 tuple(), 集合转换 set(), 字典转换 dict(), 4.3 进阶类型转换, 字节转换 bytes() 和 bytearray(), 4.4 实用转换场景与技巧, 数字和字符串之间的转换, 数据类型检测与安全转换, 类型转换与数据验证, 4.5 类型转换陷阱与最佳实践, 常见陷阱, 第五章：数据类型, 5.1 字符串类型(str), 字符串输出方式, 字符串常用方法, 5.2 列表类型(list), 添加元素, 删除元素, 查找元素, 排序, 访问嵌套列表, 5.3 元组类型(tuple), 元组的创建方式, 元组的特性与操作, 不可变性, 访问与切片, 元组解包, 元组方法和内置函数, 元组的应用场景, 作为函数的返回值, 作为不可变集合, 确保数据不被修改, , 5.4 字典类型(dict), 字典常用方法, 5.5 集合类型(set), 集合操作, 第六章：条件循环分支, 条件语句的高级用法, 链式比较, 短路逻辑评估, 条件表达式的嵌套, 模式匹配（Python 3.10+）, 循环的高级技巧, 循环与迭代器协议, 生成器表达式代替列表推导式, 使用 enumerate 获取索引, 并行迭代多个序列, 流程控制的高级模式, 嵌套循环的优化, 递归与循环, 第七章： 文件操作, 7.1 文件打开模式, 7.2 基本文件操作, 7.2.1 文件读取操作, 7.2.2 文件写入操作, 7.2.3 多文件操作, 7.2.4 文件修改示例, 7.3 文件指针控制, 7.3.1 seek() 和 tell() 函数, 7.3.2 实际应用场景, 7.4 缓冲区管理, 7.4.1 缓冲设置与刷新, 7.4.2 缓冲区触发条件, 7.5 文件路径操作, 7.5.1 使用 os.path 模块, 7.5.2 使用 pathlib 模块 (Python 3.4+), 7.6 高级文件操作, 7.6.1 二进制文件操作, 7.6.2 临时文件操作, 7.7 目录操作, 7.7.1 基本目录操作, 7.7.2 使用 pathlib 进行目录操作, 7.7.3 递归遍历目录树, 7.7.4 文件复制、移动和删除操作, 7.8 文件监控与变更检测, 7.8.1 基础文件监控, 7.8.2 使用 watchdog 库进行高级文件监控, 7.9 实际应用场景示例, 7.9.1 文件备份工具, 7.9.2 日志分析工具, 7.9.3 文件同步工具, 第八章： 函数知识总结, 8.1 内置函数, 数学和数值计算, 进制转换, 字符编码, 反射函数, 其他常用内置函数, 8.2 函数定义与调用, 8.3 函数参数, 位置参数, 关键字参数, 默认参数, 可变参数, 8.4 作用域与命名空间, 名称空间, LEGB 规则, 作用域修饰, 8.5 高阶函数特性, 函数作为参数传递, 函数作为返回值, 函数存储在数据结构中, 高阶函数设计模式, 函数组合模式, 部分应用, 8.6 匿名函数(lambda), 8.7 闭包函数, 8.8 递归函数, 递归的关键要素, 递归深度限制, 递归案例：列表扁平化, , 8.9 装饰器, 基本装饰器, 带参数的装饰器, 保留原函数元数据, 装饰器叠加, 装饰器工厂, 第九章：迭代器、生成器与推导式, 9.1 迭代器, 自定义迭代器, for 循环的工作原理, 9.2 生成器, 生成器表达式(推导式), 生成器的优势, 生成器应用场景, 9.3 推导式, 列表推导式, 字典推导式, 集合推导式, 生成器表达式, 三元表达式, 第十章： 模块与包, 10.1 模块分类, 10.2 模块导入方式, 10.2.1 导入整个模块, 10.2.2 从模块导入特定内容, 10.2.3 导入时重命名, 10.2.4 导入所有内容（不推荐）, 10.3 控制模块导入, 10.4 模块的特殊属性, 10.4.1 __name__ 属性, 10.4.2 From 模块无法识别问题, 10.5 包的概念与使用, 10.5.1 包的结构示例, 10.5.2 __init__.py 文件的作用, 10.5.3 包的导入方式, 10.5.3.1 导入包中的模块, 10.5.3.2 导入包中特定内容, 10.5.4 相对导入与绝对导入, 10.5.4.1 绝对导入, 10.5.4.2 相对导入, 10.6 高级应用技巧, 10.6.1 动态导入, 10.6.2 延迟导入, 10.6.3 使用 __slots__ 优化内存, 10.7 包的发布与安装, 10.7.1 创建 setup.py 文件, 10.7.2 打包与上传, 10.7.3 安装包, 10.8 PyCharm 中的包管理, 10.8.1 使用 Python Packages 工具, 10.8.2 更改 PyCharm 的 pip 源, 10.8.3 使用 Project Interpreter 管理包, 10.8.4 导出和导入项目依赖, 10.8.4.1 导出依赖, 10.8.4.2 导入依赖, 10.8.5 使用虚拟环境, 10.8.5.1 虚拟环境工具对比, 10.9 模块开发最佳实践, 10.9.1 模块组织, 10.9.2 导入顺序, 10.9.3 文档化模块和包, 第十一章：面向对象编程, 对象的本质, 为什么需要对象, __init__ 方法, 面向对象的三大特性, 1. 封装, 属性隐藏, 属性访问控制, 使用@property 装饰器, 2. 继承, 单继承和多继承, 方法重写和调用父类方法, 继承的属性查找顺序 (MRO), 菱形继承问题, MixIn 设计模式, 3. 多态, 鸭子类型, 抽象基类, 类方法与静态方法, 方法类型比较, 2. 类方法（@classmethod）, 3. 静态方法（@staticmethod）, 反射机制, 常用反射函数, 1. hasattr() — 检查对象是否有指定属性, 2. getattr() — 获取对象的属性, 3. setattr() — 设置对象的属性, 4. delattr() — 删除对象的属性, 5. dir() — 列出对象的所有属性, 6. type() — 获取对象的类型, 7. isinstance() — 检查对象是否为类的实例, 8. issubclass() — 检查类是否为另一个类的子类, 9. callable() — 检查对象是否可调用, 10. vars() — 获取对象的 __dict__, 反射示例, 通用枚举以及抽象接口定义, enum 模块：实现枚举类型, enum 常用功能, enum 模块代码示例, abc 模块：定义抽象基类 (Abstract Base Classes), abc 常用功能, abc 模块代码示例, 元类编程, 元类的核心方法, 使用 type 动态创建类, 自定义元类, 元类的 __new__ 方法, 元类的 __call__ 方法实例, 元类链和类创建过程, 内置的元类属性和方法表, Python 特殊方法（魔术方法）, 1. 对象创建与销毁, 实际应用场景：, 2. 对象表示, 实际应用场景：, 3. 集合类操作, 实际应用场景：自定义商品购物车, 4. 调用与比较操作, 实际应用场景：数据分析器, 5. 算术运算操作, 实际应用场景：向量运算, 6. 属性访问控制, 实际应用场景：属性验证与保护, 7. 上下文管理（with 语句）, 实际应用场景：数据库连接管理, 8. 描述符与属性装饰器, 描述符协议方法, 实际应用场景：数据验证描述符, 属性装饰器(@property)实际应用, 10. 常见特殊方法使用陷阱与最佳实践, 陷阱与注意事项, 11. 总结：特殊方法的选择指南, 对象与类的高级概念, 深入理解实例、类和元类关系, 属性查找的复杂情况, 内存管理与对象生命周期, 对象创建和销毁的完整过程, 引用计数和循环引用, 高级常用设计模式, 单例模式, 懒汉式单例模式的使用场景, 饿汉式单例模式的使用场景, 工厂模式, 观察者模式, 代理模式, 1.静态代理实现, 2.动态代理实现, 3.保护代理实现, 4.虚拟代理实现, SOLID 原则, SOLID 原则概述, 1. 单一职责原则 (SRP), 1.1 原则解析, 1.2 电商系统中的应用, 1.3 遵循 SRP 的实现, 2. 开放封闭原则 (OCP), 2.1 原则解析, 2.2 电商系统中的应用, 2.3 遵循 OCP 的实现, 3. 里氏替换原则 (LSP), 3.1 原则解析, 3.2 电商系统中的应用, 3.3 遵循 LSP 的实现, 4. 接口隔离原则 (ISP), 4.1 原则解析, 4.2 电商系统中的应用, 4.3 遵循 ISP 的实现, 5. 依赖倒置原则 (DIP), 5.1 原则解析, 5.2 电商系统中的应用, 5.3 遵循 DIP 的实现, Python 中的 __slots__, __slots__ 的工作原理与性能优势, __slots__ 的限制和继承行为, 第十二章： 异常处理, 12.1 基本异常处理, 12.1.1 异常的概念与意义, 12.1.2 基础 try-except 结构, 12.2 完整的异常处理结构, 12.2.1 try-except-else-finally 完整结构, 12.2.2 各代码块执行条件总结, 12.3 自定义异常, 12.3.1 创建自定义异常类, 12.3.2 使用自定义异常, 12.4 异常的传播与重新抛出, 12.4.1 异常传播机制, 12.4.2 重新抛出异常, 12.5 使用上下文管理器, 12.5.1 with 语句和资源管理, 12.5.2 自定义上下文管理器, 12.5.3 实际应用场景, 12.5.4 使用 contextlib 简化上下文管理器创建, 12.6 异常处理最佳实践, 12.6.1 不良实践与改进, 12.6.2 实际开发中的异常处理策略, 12.7 高级异常处理技术, 12.7.1 使用装饰器简化异常处理, 12.7.2 异常链与异常组, 12.7.3 EAFP vs LBYL 编程风格, 第十三章： 高级数据处理, 13.1 JSON 处理, 13.1.1 基本操作, 13.1.2 重要参数说明, 13.1.3 自定义对象序列化, 13.1.4 JSON 解码为自定义对象, 13.1.5 处理复杂 JSON 数据, 13.1.6 性能优化, 13.1.7 JSON Schema 验证, 13.2 CSV 处理, 13.2.1 基本读写操作, 13.2.2 使用字典处理 CSV 文件, 13.2.3 CSV 方言与格式化选项, 13.2.4 处理特殊情况, 13.2.5 CSV 文件的高级操作, 13.3 XML 处理, 13.3.1 创建和写入 XML, 13.3.2 解析和读取 XML, 13.3.3 修改 XML, 13.3.4 命名空间处理, 13.4 配置文件处理, 13.4.1 INI 配置文件处理, 13.4.2 YAML 配置文件处理, 13.4.3 使用环境变量作为配置, 13.4.4 JSON 作为配置文件, 13.5 正则表达式, 13.5.1 常用元字符和语法, 13.5.2 特殊序列 (预定义字符集), 13.5.3 贪婪模式 vs. 非贪婪模式, 13.5.4 分组与捕获, 13.5.5 re 模块核心函数, 13.5.6 Match 对象详解, 13.5.7 正则表达式标志 (Flags), 13.5.8 实际应用场景示例, 第十四章：深入解析并发编程, 14. 并发编程基本概念, 进程调度机制解析, 进程的三大状态与生命周期, 14.1 同步与异步编程模型, 同步和异步, 阻塞和非阻塞, 14.2 多进程编程技术, 进程基础, 进程创建方法, 方法一：使用 Process 类创建进程, 方法二：继承 Process 类创建进程, 多进程常用方法表, 进程号与进程信息获取, 进程间通信示例, 复杂进程通信示例, 进程池详解, 进程池的主要方法, ProcessPoolExecutor 示例, 进程号与进程信息获取, 进程状态特殊情况, 僵尸进程, 孤儿进程, 14.3 多线程编程深入解析, 线程基础, 线程创建方法, 方法一：使用 Thread 类创建线程, 方法二：继承 Thread 类创建线程, 线程常用方法表, 线程使用实例, 基本线程示例, 守护线程示例, 线程池详解, ThreadPoolExecutor 主要方法, 完整示例, Event 事件同步机制, Event 主要方法, 定时器(Timer), 14.4 多进程 VS 多线程性能分析, 不同场景的最优选择, 计算密集型任务测试, IO 密集型任务测试, 14.5 协程技术详解, 协程基础概念, 协程效率对比, 串行执行, 使用 yield 实现协程切换, greenlet 模块（了解）, greenlet 核心方法与属性, gevent 模块（了解）, gevent 基础操作, gevent 常用 API 详解, 实际应用场景示例, greenlet 与 gevent 的区别与选择, asyncio 协程技术, asyncio 与原生协程, asyncio 常用 API, Task 对象, Future 对象, 异步上下文管理器, 14.6 GIL 锁与 Python 并发性能, GIL 的本质与工作原理, 并发与并行的区别, 线程安全与并发控制, 线程安全问题示例, 使用线程锁解决安全问题, Python 中的锁机制全面解析, Python 锁类型及其特性, 互斥锁(Lock), 可重入锁(RLock), 条件变量(Condition) - 根据条件控制锁, 信号量(Semaphore) - 控制并发数量, 有界信号量(BoundedSemaphore)详解, 事件对象(Event), 栅栏对象(Barrier), 线程安全队列(Queue), 死锁问题分析与解决, 死锁示例, 死锁解决方案, 原子操作与锁优化, threading.local 对象 - 线程本地存储, functools.lru_cache 带锁的缓存, 锁的高级应用模式, 读写锁模式, 使用 readerwriterlock 库实现读写锁, 锁排序（解决死锁）, 两阶段锁定, 超时重试模式, 多进程与多线程结合的混合模型, 细粒度锁与粗粒度锁, 14.7 消息队列与进程通信, 队列基础知识, 队列使用示例, 优先级队列示例语言特性是一门解释型的弱类型动态语言编译型解释型编译型语言先编译后运行速度快适合大型项目解释型语言边解释边运行灵活易改适合快速开发强类型弱类型强类型类型检查严格变量需声明类型弱类型类型检查宽松变量隐式转换动态型静态型动态型语言运行时确定数据类型灵活但效率较低静态型语言编译时确定数据类型高效但灵活性较差类型提示说我今年张三查看函数的类型注解注意的类型提示不会强制执行类型检查仅作为开发辅助和文档第一章字符串打印格式化与模板变量本章将分为两个主要部分首先介绍如何在控制台中使用转义序列来实现文本的彩色和格式化输出并提供一个实用的封装示例其次我们将探讨如何利用特别是但概念也适用于其他中的实时模板代码片段功能通过预设的模板变量和缩写来大幅提升的编码效率字符串打印格式化转义序列允许在控制台中输出彩色文本和特殊格式这在创建命令行界面或需要突出显示特定输出时非常有用可以显著增强用户体验和信息的可读性这种效果通常是通过转义序列来实现的基本语法转义序列的基本格式如下参数内容或者在字符串中通常写作参数你的文本内容其中或这是字符的八进制或十六进制表示标志着转义序列的开始控制序列引导符参数一个或多个用分号分隔的数字这些数字代码控制着文本的显示方式前景色文字颜色和背景色表示设置图形再现参数的结束标志你的文本内容你希望应用这些格式的实际文本这是一个特殊的重置序列它会清除之前设置的所有格式属性使后续的文本恢复到终端的默认显示状态每次使用完特殊格式后都强烈建议使用此序列来重置以避免格式污染后续的输出转义码表下表列出了一些常用的参数代码显示方式代码前景色代码背景色代码默认黑色黑色高亮粗体红色红色通常不使用绿色绿色下划线黄色黄色闪烁蓝色蓝色反白紫红色紫红色不可见青蓝色青蓝色白色白色注意除了上述标准颜色现代终端通常还支持高强度颜色例如高亮红色使用或者单独的亮色代码色模式以及真彩色模式例如设置前景色为但这些高级模式的兼容性可能因终端模拟器而异闪烁代码和不可见代码的支持程度也取决于终端实用示例基本颜色设置红色文字这是红色文字绿色文字这是绿色文字黄色文字通常与高亮粗体结合使用效果更明显这是高亮黄色文字表示高亮粗体表示黄色蓝色文字这是蓝色文字组合使用可以同时设置显示方式前景色和背景色用分号分隔参数红色文字黄色背景红字黄底高亮绿色文字高亮绿色文字下划线蓝色文字带下划线的蓝色文字高亮紫红色文字白色背景高亮紫红色文字白色背景实际应用场景封装为工具模块为了在项目中更方便更一致地使用彩色打印通常我们会将这些转义序列封装成常量或函数以下是您之前提供的模块内容它是一个很好的实践示例打印工具模块提供彩色和结构化的打印函数彩色打印工具存储颜色和样式代码的常量亮紫色常用于标题亮蓝色亮青色亮绿色亮黄色亮红色粗体高亮下划线重置所有格式打印带特殊格式的标题打印带下划线的青色子标题打印普通信息默认颜色打印成功信息绿色打印警告信息黄色打印错误信息红色打印语句蓝色以结构化方式打印结果项特别是字典彩色打印工具如何使用这个模块将上述代码保存为文件在您的其他脚本中通过或来使用这些函数示例在另一个脚本中使用假设已导入应用程序任务调用封装好的函数任务已成功完成任务执行失败错误代码仅为结构示例提升编码效率实时模板或代码片段是现代集成开发环境如等提供的一项核心功能它允许开发者定义常用的代码结构并通过输入一个简短的缩写后按下特定按键通常是来快速插入这些代码块这些模板通常还支持占位符变量如或在模板展开后会引导用户快速填充这些变量或将光标定位到预设位置使用可以显著减少重复的样板代码输入提高编码速度和效率帮助保持代码风格和结构的一致性减少因手动输入而出错的可能性我们需要根据如下步骤去键入模板基本循环循环遍历序列模板用途快速生成一个遍历可迭代对象的循环建议缩写或您截图中的描述循环模板文本主要占位符说明循环中每次迭代的元素变量名要遍历的序列或可迭代对象模板展开后光标的初始位置循环带索引遍历模板用途快速生成一个同时遍历索引和元素的循环建议缩写或您截图中的描述循环模板文本主要占位符说明循环中每次迭代的索引变量名循环中每次迭代的元素变量名要遍历的序列或可迭代对象循环按次数模板用途快速生成一个按指定次数执行的循环建议缩写描述循环模板文本主要占位符说明循环计数变量名通常是循环的次数条件判断语句模板用途快速生成一个基本的条件判断语句建议缩写描述语句模板文本主要占位符说明语句的条件表达式光标位于代码块内部语句模板用途快速生成条件判断结构建议缩写描述语句模板文本主要占位符说明语句模板用途快速生成多条件判断结构建议缩写描述语句模板文本主要占位符说明打印与日志打印模板用途快速生成一个使用格式化的语句建议缩写描述语句模板文本主要占位符说明光标直接定位在的引号内快速日志记录假设对象已配置模板用途快速插入一条日志记录建议缩写描述模板文本主要占位符说明类似地可以为创建模板结构与定义模板用途快速生成一个带类型注解和文档字符串的函数定义建议缩写描述带类型注解和文档字符串的函数定义模板文本主要占位符说明可默认为可默认为类定义基本结构模板用途快速生成一个带方法的类定义建议缩写描述基本类定义含模板文本初始化对象主要占位符说明类定义模板用途快速生成一个使用模块定义的类建议缩写描述类定义模板文本表示的数据类主要占位符说明异常处理基本块模板用途快速生成一个基本的异常处理块建议缩写描述块模板文本如果使用日志简单打印主要占位符说明可默认为完整块模板用途快速生成包含和子句的块建议缩写描述块模板文本主要占位符说明文件操作上下文管理器模板用途快速生成使用语句安全打开和操作文件的代码建议缩写描述安全文件操作模板文本主要占位符说明可默认为可默认为推导式列表推导式模板用途快速生成列表推导式建议缩写或您截图中的描述模板文本带模板文本不带主要占位符说明可选字典推导式模板用途快速生成字典推导式建议缩写或您截图中的描述模板文本带模板文本不带主要占位符说明可选其他匿名函数模板用途快速创建一个简单的函数建议缩写描述模板文本主要占位符说明注释标记模板用途快速插入标准的注释建议缩写描述模板文本以为例主要占位符说明或可配置或可配置第二章转义字符常用转义字符示例续行符用于多行字符串反斜杠符号单引号双引号响铃符号某些终端会发声退格符删除前一个字符空字符码为换行符水平制表符回车符将光标移到行首换页符八进制和十六进制表示八进制表示十六进制表示第三章运算符运算符优先级加减乘除比较运算符表类型运算符描述算术运算符加减乘除整除取模幂比较运算符等于不等于大于小于大于等于小于等于逻辑运算符逻辑与逻辑或逻辑非位运算符按位与按位或按位异或按位取反左移右移赋值运算符等简单赋值复合赋值身份运算符判断对象标识成员运算符判断成员关系赋值技巧不换行输出增量赋值等价于链式赋值同值多变量交叉赋值交换变量值交换值第四章类型转换详解基本数据类型转换整型转换最常用的一种转换类型通过可以实现进制之间的快速转换而无需调用函数基本转换截断小数部分不是四舍五入向零截断字符串必须表示有效的数字可以指定进制默认为进制二进制转十进制转换失败的情况浮点型转换基本转换支持科学计数法无穷大负无穷大非数值转换失败的情况字符串转换基本转换几乎任何对象都可以转为字符串布尔值转换基本转换规则空值或零值转为其他为集合类型转换列表转换从其他可迭代对象创建列表集合转列表顺序不确定字典转列表获取所有键元组转换从其他可迭代对象创建元组集合转元组顺序不确定字典转元组获取所有键特殊情况创建空元组和单元素元组注意逗号是必需的集合转换从其他可迭代对象创建集合自动去重字典转集合获取所有键应用列表去重顺序可能变化创建空集合不能用那会创建空字典字典转换从键值对创建字典从两个等长序列创建字典使用关键字参数创建字典合并两个字典进阶类型转换字节转换和字符串转字节你好整数列表转字节创建指定长度的空字节序列是可变版本的修改第一个字节为字节转回字符串实用转换场景与技巧数字和字符串之间的转换格式化数字为字符串添加千位分隔符保留位小数科学计数法解析数字字符串处理货币字符串数据类型检测与安全转换安全地转换为整数类型转换与数据验证验证并转换输入数据尝试将字符串转换为整数验证年龄是否在到之间若年龄有效则返回年龄年龄必须在到之间若年龄无效则抛出异常无效的年龄格式若输入的年龄不是整数则抛出异常适用于表单验证验证和转换名称请输入姓名验证和转换年龄把异常信息转换为字符串如果为空则返回否则返回测试张三输出无效的年龄格式类型转换陷阱与最佳实践常见陷阱精度损失信息丢失截断而非四舍五入很多新手误以为会四舍五入不安全的安全防止手残危险可以执行任意代码执行会导致整个系统被删除大数字字符串转换性能问题会很慢并占用大量内存浮点数精度问题因为浮点精度问题第五章数据类型字符串类型字符串输出方式占位符类型说明字符串使用方法转换任何对象十进制整数十进制浮点数小数自动保留六位小数占位符方式我的名字是我的年龄是岁小明我的名字是我的年龄是岁小明带索引我的名字是我的年龄是岁小明方式推荐小明我的名字是我的年龄是岁字符串常用方法方法描述示例判断是否以指定内容开头判断是否以指定内容结尾判断是否为数字组成判断是否为文字组成统计元素出现次数查找子串位置未找到返回转为大写转为小写替换字符串分割字符串为列表拼接列表为字符串去除两端空格或指定字符去除左侧空格或指定字符去除右侧空格或指定字符将字符串标题化字符串方法示例判断是否以指定内容开头是否以开头是否以开头判断是否以指定内容结尾是否以结尾是否以结尾判断是否为数字组成是否全为数字是否全为数字判断是否为文字组成是否全为字母是否全为字母统计元素出现次数中出现的次数中出现的次数查找子串位置未找到返回中的位置中的位置转为大写转大写转为小写转小写替换字符串替换为替换所有为分割字符串为列表按逗号分割按空格分割拼接列表为字符串用逗号连接用空格连接去除两端空格或指定字符去除两端空格去除两端的去除左侧空格或指定字符去除左侧空格去除左侧的去除右侧空格或指定字符去除右侧空格去除右侧的将字符串标题化每个单词首字母大写标题化列表类型添加元素在列表末尾添加元素批量添加元素逐一添加在指定位置插入元素删除元素删除指定元素第一个匹配项删除指定索引元素返回被删除的元素不指定索引默认删除最后一个清空列表删除指定元素或切片删除单个元素删除切片范围的元素查找元素查找元素索引返回第一个匹配元素的索引运算符判断元素是否存在元素存在同时获取索引和元素索引值统计元素出现次数返回元素出现次数排序原地排序降序返回新列表原列表不变原列表不变自定义排序按字符串长度可以编写一个匿名函数作为条件使用函数结合函数进行复杂排序创建一个包含学生信息的列表姓名年龄成绩是否参加课外活动张三李四王五赵六钱七基本排序按照学生成绩从高到低排序定义一个匿名函数接收一个参数列表中的每个元素返回的值表示降序排序从高到低按照学生成绩从高到低排序姓名年龄学生成绩访问嵌套列表访问嵌套列表的元素元组类型元组的创建方式使用小括号创建省略小括号创建单元素元组必须加逗号否则只是普通值不是元组正确这是一个元组错误这是一个整数不是元组正确这也是一个元组使用函数从其他可迭代对象创建从列表创建从字符串创建从字典创建只保留键创建空元组嵌套元组不同类型的元素元组的特性与操作不可变性但可以通过连接创建新元组新元组重复元组元组的不可变性让它可以作为字典的键元组中可变对象的行为元组中的可变对象如列表的内容可以修改正确修改元组中列表的内容重要说明元组的不可变性只适用于元组本身的结构元素的标识符不能改变而不适用于元组中所包含的可变对象的内容访问与切片索引访问从开始负索引从末尾开始切片步长为逆序元组解包基本解包使用星号收集多余的元素忽略某些值使用下划线作为惯例交换变量值使用元组解包交换值元组方法和内置函数元组的方法比列表少因为它是不可变的主要方法有计算元素出现的次数返回元素首次出现的索引使用内置函数元组长度最小元素最大元素元素和返回排序后的列表非元组元组的应用场景作为函数的返回值返回多个值调用函数并解包返回值判断返回值是否为一个元组姓名年龄邮箱输出姓名年龄邮箱返回值不是一个元组作为不可变集合使用元组作为字典键更新字典不更改元组确保数据不被修改是一个元组确保处理过程中不被修改处理配置安全的操作使用字典类型创建字典张三北京访问值张三设置修改值添加新键值对删除键值对字典常用方法方法描述示例获取值键不存在时返回默认值默认值获取所有键获取所有值获取所有键值对获取值键不存在则设置默认值默认值更新字典移除指定键值对并返回值集合类型创建集合结果添加元素删除元素元素不存在不会报错元素不存在会报错集合操作操作描述示例交集共同元素并集去重合并差集属于不属于对称差集不同时属于和求两个集合的交集共同元素求两个集合的并集去重后在合并求两个集合的差集中有而中没有的元素求两个集合的对称差集和中不同时存在的元素第六章条件循环分支条件语句的高级用法链式比较支持数学风格的链式比较使得条件表达式更简洁明了传统方式在到之间链式比较在到之间多重链式比较在到之间且在到之间短路逻辑评估使用短路逻辑评估条件表达式即一旦表达式的真假已经确定后续部分不再执行短路与如果返回不会执行短路或如果返回不会执行条件表达式的嵌套可以在条件表达式内部嵌套其他条件表达式创建复杂的决策树复杂嵌套的三元表达式高分良好及格不及格更复杂的嵌套条件儿童青少年成人老年人模式匹配引入了结构化模式匹配类似于其他语言的语句但功能更强大基本模式匹配整数浮点数字符串列表字典其他类型结构匹配和变量绑定原点轴上的点轴上的点对角线上的点普通点匹配对象属性原点轴上的点轴上的点对角线上的点普通点循环的高级技巧循环与迭代器协议理解迭代器协议有助于更高效地编写循环代码返回迭代器对象这个方法使类的实例成为一个可迭代对象当使用循环遍历该对象时会自动调用这个方法获取迭代器返回返回自身作为迭代器获取迭代器中的下一个值这个方法定义了迭代过程中如何获取下一个元素每次调用时计数器减并返回减前的值当计数器减到时抛出异常表示迭代结束如果当前值小于等于表示迭代已结束保存当前值计数器减返回减前的值测试代码生成器表达式代替列表推导式生成器表达式在处理大量数据时更节省内存列表推导式一次性创建所有元素占用大量内存占用内存占用内存生成器表达式按需生成元素内存效率高占用内存占用内存使用获取索引传统方式使用更优雅并可指定起始索引从开始计数并行迭代多个序列使用并行迭代岁来自流程控制的高级模式嵌套循环的优化嵌套循环的替代方案传统嵌套循环使用代替嵌套循环递归与循环有些问题使用递归比循环更直观通过下列的代码处理思想对于常见的树结构都能以递归的思想去解决问题递归处理嵌套结构递归处理子列表处理叶节点递归执行逻辑解析函数接收一个嵌套列表和当前深度默认为遍历列表中的每个元素如果元素是列表递归调用自身处理该子列表深度如果元素不是列表将深度元素值添加到结果中最终返回包含所有元素及其深度信息的扁平列表例如处理不是列表添加是列表递归处理不是列表添加是列表递归处理不是列表添加不是列表添加不是列表添加不是列表添加最终结果使用示例第七章文件操作提供了强大而灵活的文件操作接口从基础的读写能力到高级的路径操作和目录管理本章将由浅入深地介绍文件操作的全面知识文件打开模式文件操作的第一步是打开文件提供了多种打开模式以满足不同需求模式描述文件不存在时文件存在时常见应用场景只读模式报错从头读取读取配置文件日志文件只写模式创建新文件清空内容生成报告写入日志追加模式创建新文件在末尾追加日志记录数据收集读写模式报错可读可写需要同时读写的场景读写模式创建新文件清空内容需要先写后读的场景追加读写创建新文件追加且可读数据分析日志分析二进制模式与其他模式组合处理二进制图片视频压缩文件文本模式默认与其他模式组合处理文本文本文件处理实用提示选择合适的文件模式可以避免数据丢失例如使用模式时要格外小心因为它会清空现有文件当不确定时使用模式追加内容会更安全基本文件操作文件读取操作使用语句自动处理文件关闭推荐方式方法一次性读取整个文件读取全部内容到内存注意后文件指针已经到达文件末尾需要重新打开文件或使用重置指针重置文件指针到文件开头方法读取一行读取第一行包含换行符方法读取所有行到列表重置文件指针返回包含所有行的列表第一行第二行方法逐行读取内存效率最高推荐用于大文件重置文件指针文件对象本身是可迭代的包含换行符通常需要移除去除行首行尾的空白字符文件写入操作写入文件覆盖模式方法写入字符串第一行内容注意需手动添加换行符第二行内容方法写入多行第三行内容第四行内容注意不会自动添加换行符追加内容到文件追加的内容读写模式示例读取前个字符插入的内容在当前位置第个字符后写入多文件操作同时操作多个文件例如文件复制按块读取和写入适用于大文件的块大小到达文件末尾或者简单地复制所有内容先重置到文件开头或者逐行复制适合文本处理可以在此添加行处理逻辑文件修改示例在实际应用中我们经常需要读取修改并写回文件示例为文件的所有标题增加一个符号读取并修改处理每一行如果行以开头表示标题则增加一个将修改后的内容写入新文件文件已修改并保存为最佳实践对于文件修改操作始终先写入临时文件然后在确认写入成功后才替换原文件这样可以防止文件损坏文件指针控制文件指针或文件位置决定了读写操作的起始位置掌握指针控制对于高级文件操作至关重要和函数写入一些测试内容你好世界英文部分占用个字符中文部分你好世界占用个字符剩余的空格符号占据了个字符总共个字符获取当前文件指针位置写入内容后的位置写入内容后的位置将指针移回文件开头回到文件开头位置回到文件开头位置读取全部内容文件全部内容文件全部内容你好世界读取后的位置读取后的位置再次回到文件开头读取前个字符前个字符前个字符读取个字符后的位置读取个字符后的位置回到文件开头一次性定位到第个字符位置从文件开头算起直接定位到第个位置从第个位置开始读取的内容从第个位置开始读取的内容你好世界注意在文本模式下由于字符编码原因可能无法精确定位到任意字节位置对于需要精确控制的场景应使用二进制模式等实际应用场景场景在大日志文件中读取最后行读取文件最后行类似于的命令移动到文件末尾文件总大小初始化变量从文件末尾向前读取移动到倒数第个块读取数据块处理可能被截断的行丢弃第一行不完整数据计算行数合并行返回最后行使用示例缓冲区管理理解缓冲区对于优化文件操作性能至关重要特别是在处理大量小块写入时缓冲设置与刷新设置不同的缓冲策略无缓冲仅在二进制模式可用行缓冲仅在文本模式可用指定缓冲区大小字节使用默认缓冲区大小无缓冲每次写入都直接写入磁盘行缓冲遇到换行符时刷新遇到会刷新保留在缓冲区指定缓冲区大小缓冲区适合频繁小写入数据会积累到才写入磁盘手动刷新缓冲区立即刷新缓冲区确保数据写入磁盘进一步确保数据写入物理存储设备缓冲区触发条件缓冲区会在以下条件下自动刷新缓冲区满时文件关闭时如块结束调用方法时程序正常退出时行缓冲模式下遇到换行符时性能提示对于大量小写操作使用适当的缓冲区大小可以显著提高性能但对于关键数据应及时调用确保数据安全文件路径操作有效管理文件路径是文件操作的基础提供了两种主要方式传统的模块和现代的库使用模块方法属性描述获取当前工作目录改变当前工作目录创建目录递归创建多级目录删除空目录删除文件列出指定目录的文件和目录重命名文件或目录执行系统命令环境变量字典检查路径是否存在检查路径是否为文件检查路径是否为目录连接路径根据最后一个路径分隔符分割路径为目录文件名根据最后一个点号分割路径为文件名拓展名获取路径的目录部分获取路径的文件名部分获取文件大小字节获取当前脚本所在目录在当前目录下创建首先创建一个测试文件这是测试内容文件路径处理演示文件路径信息目录文件名纯名称扩展名路径检查文件是否存在是否是文件是否是目录文件信息获取修改时间获取创建时间获取访问时间转换时间戳为可读时间文件大小字节创建时间修改时间访问时间文件内容文件内容获取文件信息时发生错误使用模块获取当前脚本所在目录并创建的路径创建并写入测试文件这是测试内容基本路径信息完整路径父目录文件名纯名称扩展名所有路径组件路径解析绝对路径解析路径相对路径无法计算相对路径文件可能在不同驱动器或目录文件状态检查文件是否存在是否是文件是否是目录是否是符号链接文件信息文件大小字节创建时间修改时间访问时间文件内容文件内容路径修改示例修改整个文件名修改扩展名仅修改文件名不含扩展名功能方式方式推荐路径连接更直观获取目录属性访问更清晰获取文件名属性访问更清晰分离扩展名更简洁检查存在两者类似面向对象获取绝对路径两者相当最佳实践在新项目中优先使用它提供了更现代更直观的面向对象接口在维护旧代码时可能需要继续使用高级文件操作二进制文件操作读取整个二进制文件读取并返回整个二进制文件的内容分块读取大型二进制文件分块处理大型二进制文件避免内存溢出每次读取到达文件末尾处理当前数据块假设的处理函数处理数据块的函数处理二进制数据块的函数这里可以根据需要实现具体的数据处理逻辑例如计算校验和搜索特定字节模式转换数据格式等处理数据块字节示例计算数据块的哈希值数据块哈希值示例检查数据块中的特定字节序列在数据块中发现特定字节序列返回处理结果可选读取文件特定部分读取文件中从位置开始的个字节移动文件指针到指定位置读取指定长度字节检测文件类型通过文件头部特征识别文件类型常见文件格式的魔数读取文件前个字节用于检测未知文件类型实际演示处理图像文件演示二进制文件操作的实际应用定义两个图形的基础文件路径检测图像类型检测文件类型是检测文件类型是检测文件类型是检测文件类型是读取文件头部信息文件头部字节文件头部字节获取文件大小小技巧在函数中使用即可以将数字以千分位分隔符展示文件大小字节文件大小字节文件大小字节文件大小字节处理大型二进制文件临时文件操作临时文件对于需要中间处理结果但不想留下永久文件的操作非常有用示例使用临时目录处理多个文件在临时目录中创建多个文件并进行批处理创建临时工作区创建多个数据文件获取到临时目录下的文件路径处理所有的文件模拟处理计算字符数并添加到结果集中文件包含个字符列出处理的文件处理文件为退出块后会自动删除临时目录暂停秒等待用户查看结果处理开始大约需要秒请稍候处理完成演示临时目录的批处理使用这是第一个文件的测试内容这是第二个文件包含更多的信息以及携带数字这是第三个文件包含中文你好世界处理结果为目录操作目录操作是文件系统操作的重要组成部分提供了多种目录操作方法基本目录操作获取当前工作目录当前工作目录更改当前工作目录更改后的工作目录列出目录内容目录内容过滤目录内容文件目录创建目录切换回原目录创建单个目录创建多级目录忽略已存在的目录删除目录只能删除空目录删除目录以及所有内容谨慎使用使用进行目录操作创建目录创建多层目录递归创建父目录列出目录内容文件大小目录过滤特定类型的文件列出当前目录下所有文件递归搜索所有子目录当前目录下文件递归搜索所有文件所有文件删除目录只能删除空目录删除目录及其所有内容操作方法方法优势比较获取当前目录返回对象便于后续操作切换工作目录无直接等效方法更适合改变全局工作目录列出目录内容直接返回对象无需再拼接路径创建单个目录功能相同更面向对象创建多级目录语义更明确参数名更具描述性删除空目录功能相同更面向对象递归删除目录无直接等效方法需循环删除提供单一高效操作文件路径拼接使用运算符更直观简洁检查路径是否存在功能相同更面向对象检查是否为文件功能相同更面向对象检查是否为目录功能相同更面向对象递归遍历目录树递归遍历是处理目录层次结构的强大工具在很多需要列举文件目录树的场景都可以采用该思路去打印输出使用遍历目录树示例输出学习用电子商务系统实现笔记目录大小递归扫描目录显示结构和文件大小其中当前目录路径子目录列表文件列表计算当前的目录深度用于缩进计算目录深度将当前路径中的起始目录部分替换为空字符串得到相对路径统计相对路径中目录分隔符如或的数量每一个分隔符代表一层目录深度因此分隔符的数量就等于目录的嵌套层级打印当前目录缩进子文件统计当前目录下的文件大小累加总大小目录大小返回总大小单位学习用总大小文件复制移动和删除操作文件复制操作复制文件到目标路径不保留元数据如文件的创建时间修改时间等参数说明源文件路径目标路径可以是目录或文件名返回值目标文件路径复制文件到目标路径保留所有元数据如修改时间访问时间权限等参数说明同函数返回值目标文件路径目录复制操作递归复制整个目录树目标目录不能已存在参数说明源目录目标目录必须不存在返回值目标目录路径高级用法使用参数忽略特定文件创建一个忽略函数用于过滤不需要复制的文件参数说明可变参数接受多个风格的模式字符串文件移动操作移动文件或目录到目标路径参数说明源路径目标路径返回值目标路径用法重命名文件用法移动文件到其他目录文件删除操作删除指定路径的文件不能删除目录参数说明要删除的文件路径注意如果文件不存在会抛出异常文件监控与变更检测在某些应用场景中需要监控文件变化并作出响应基础文件监控监控文件变化并输出新增内容文件不存在获取初始状态文件大小最后修改时间戳开始监控文件文件大小最后修改时间检查文件是否被修改文件在被修改如果文件增大了读取新增内容尝试不同的编码方式读取文件移动文件指针到上次读取位置新增内容更新当前使用的编码如果所有编码都失败尝试以二进制方式读取并显示无法解码文件内容显示二进制内容读取文件失败文件缩小了可能是被清空了文件大小减小了可能被截断或重写更新状态休眠一段时间再检查文件监控已停止使用库进行高级文件监控对于更复杂的文件系统监控需求的第三方库提供了更强大的功能文件被创建文件被删除文件被修改文件被移动确保监控的是目录而不是文件如果是文件则监控其所在的目录如果是当前目录下的文件开始监控目录按停止监控监控当前目录或者指定一个确实存在的目录路径实际应用场景示例文件备份工具创建目录的备份参数要备份的源目录备份文件存放目录默认在源目录的父目录是否创建压缩备份返回备份文件的路径确保源目录存在源目录不存在或不是一个目录设置默认备份目录创建备份文件名包含时间戳创建备份创建备份遍历源目录中的所有文件计算文件在中的相对路径添加创建目录备份复制创建目录备份使用示例备份已创建日志分析工具分析日志文件并生成报告参数日志文件路径用于匹配日志行的正则表达式模式默认为表示所有行返回包含分析结果的字典日志文件不存在初始化结果编译正则表达式地址模式状态码模式时间戳模式假设格式为模式错误和警告模式读取和分析日志文件应用模式匹配过滤如果提供提取地址提取状态码提取提取时间并按小时汇总检查错误和警告生成日志分析报告文本和图表创建文本报告日志分析报告总行数匹配行数错误数警告数按小时分布时行前个地址次状态码统计次前个次生成图表报告按小时分布图小时日志条目数日志按小时分布状态码分布饼图状态码分布前个地址条形图请求次数地址前个地址使用示例报告已生成文件同步工具配置日志计算文件的哈希值同步两个目录的内容参数源目录目标目录是否删除目标目录中源目录没有的文件要排除的文件目录列表返回操作统计信息确保目录存在源目录不存在创建目标目录初始化统计获取源文件清单从中移除要排除的目录修改原地同步文件到目标目录确保目标目录存在检查文件是否需要更新复制新文件比较修改时间和哈希值秒容差进一步比较内容哈希更新文件处理需要删除的文件删除多余文件删除空目录从下向上遍历检查目录是否为空删除空目录定期同步功能定期同步两个目录参数源目录目标目录同步间隔秒是否删除目标目录中多余文件要排除的文件目录列表启动定期同步从到间隔秒开始同步同步完成复制更新删除跳过同步出错计算实际等待时间等待秒后进行下次同步同步服务已停止使用示例定期同步每小时第八章函数知识总结内置函数数学和数值计算绝对值商和余数四舍五入幂运算幂运算后取余求和最小值最大值进制转换转二进制转八进制转十六进制字符编码你好字符串转字节可变字节数组字符码位码位对应字符反射函数查看对象的所有属性检查对象是否有属性获取对象属性设置对象属性删除对象属性其他常用内置函数获取长度类型检查检查类继承关系获取对象内存地址获取对象类型函数定义与调用基本函数定义文档字符串描述函数功能函数体可选调用函数函数参数位置参数必须按顺序提供所有参数关键字参数通过参数名指定顺序可变默认参数使用默认值覆盖默认值可变参数接收多余的位置参数形成元组接收多余的关键字参数形成字典混合使用作用域与命名空间名称空间有三层名称空间内置名称空间解释器启动时创建包含内置函数全局名称空间模块级别创建包含模块中定义的变量局部名称空间函数调用时创建包含函数内部变量规则变量查找顺序局部作用域外部嵌套函数作用域全局作用域内置作用域作用域修饰声明变量为全局变量输出访问外层函数变量输出高阶函数特性函数作为参数传递结果函数作为返回值结果结果函数存储在数据结构中查询账户余额转账服务存款服务取款服务更新个人信息存储在列表中通过数字选择功能存储在字典中通过命令选择功能欢迎使用银行服务系统您可以通过数字或命令使用服务银行服务菜单查询账户余额转账服务存款服务取款服务更新个人信息退出系统或者输入命令请输入您的选择数字或命令感谢使用银行服务系统再见通过数字调用列表中的函数无效的数字选择请重新输入通过命令调用字典中的函数无效的命令请重新输入启动银行系统高阶函数设计模式高阶函数是函数式编程的核心概念它们接受其他函数作为参数或返回函数作为结果函数组合模式将多个函数组合成一个函数等价于定义一个内部函数接收一个参数初始化结果为输入值反转函数列表确保执行顺序是从右到左例如会按然后结果最后结果的顺序执行将上一步的结果作为当前函数的输入返回最终结果返回内部函数形成闭包示例文本处理管道去除标点符号创建一个转换表将所有标点符号映射为空包含所有标点符号将文本转换为小写先用将文本按空白字符分割成列表然后用重新连接确保单词之间只有一个空格组合函数这里创建了一个处理管道按照从右到左的顺序执行首先去除标点然后转小写最后规范化空白使用函数管道执行过程部分应用部分应用是预先指定一个函数的部分参数创建一个新的函数创建一个计算平方的函数创建一个计算立方的函数创建一个计算的幂的函数匿名函数基本语法参数表达式示例结果在高阶函数中使用结果在排序中使用闭包函数闭包是指内部函数引用了外部函数的变量并且外部函数返回了内部函数递归函数递归是一种函数在执行过程中调用自身的编程技巧阶乘递归实现基本情况递归终止条件递归调用递归的关键要素基本情况终止条件必须定义何时停止递归递归关系将问题分解为更小的子问题递归深度限制默认递归深度通常为调整递归深度限制递归案例列表扁平化递归扁平化嵌套列表递归处理子列表基本情况添加非列表元素测试装饰器装饰器是一种特殊的函数用于修改其他函数的功能基本装饰器总共耗时在这里装饰器相当于带参数的装饰器第次执行完成总共耗时重复执行次保留原函数元数据保留原函数的元数据包装函数函数执行前函数执行后打招呼函数属性为函数的名称但默认情况下被装饰器装饰了的函数的名称会变成可以通过装饰器保留原函数的元数据来解决这个问题而不是同理属性为函数的文档字符串可以通过装饰器保留原函数的元数据来解决这个问题打招呼函数装饰器叠加等价于执行顺序示例装饰器开始装饰器结束装饰器开始装饰器结束问候函数执行输出装饰器开始装饰器开始问候函数执行装饰器结束装饰器结束装饰器工厂创建能够接受多种配置的通用装饰器可配置的重试装饰器要捕获的异常类或异常类元组最大尝试次数初始延迟时间秒重试间隔的增长因子用于记录警告的日志对象重试失败延迟后重试所有尝试都失败使用示例获取内容失败时自动重试调用示例获取内容失败第九章迭代器生成器与推导式迭代器迭代器是一种可以被遍历的对象它实现了和方法获取迭代器的两种方式方法一使用函数将字符串转换为迭代器使用函数获取迭代器的元素输出输出输出输出输出输出也可以通过循环获取迭代器的元素在这里不会输出了因为迭代器的元素已经被上方取完了方法二使用方法在中所有的元素都会有一个默认的方法该方法返回一个迭代器对象该对象可以用来获取元素因此如果一个对象实现了方法那么它就可以被转换为迭代器调用字符串的方法将字符串转换为迭代器输出迭代完成后会抛出异常迭代完成自定义迭代器使用自定义迭代器输出循环的工作原理循环实际上是这样工作的是可迭代对象是一个回调函数每一次迭代都会调用这个函数通过函数将转换成一个迭代器无限循环直到迭代器结束调用回调函数例如等价于生成器生成器是一种特殊的迭代器使用语句而不是语句返回值每次调用时生成器函数从上次离开的地方继续执行相比较关键字在于属于等一下再离开每次调用都会返回不同的值也就是每一次循环便利都会返回下一个直到没有在这里我们简单的了解一下关键字到了并发编程中还会有一些常见的用途如形成生成器协程上下文管理器简单的生成器函数抛出生成器表达式推导式生成器表达式使用生成器输出生成器的优势内存效率生成器不会一次性生成所有值而是按需生成降低内存使用延迟计算只有在请求下一个值时才执行计算无限序列可以表示理论上无限的数据流内存效率示例传统列表方式生成器方式生成器应用场景批量处理示例将大列表分成小批次处理处理最后不满的批次使用处理批次大小推导式推导式是创建数据集合的简洁方法列表推导式基本语法表达式变量可迭代对象条件示例带条件过滤多层推导式字典推导式基本语法键表达式值表达式变量可迭代对象条件示例键值互换集合推导式基本语法表达式变量可迭代对象条件示例去除重复元素生成器表达式基本语法表达式变量可迭代对象条件示例在函数调用中使用不需要额外括号三元表达式基本语法值条件值示例在推导式中使用第十章模块与包模块是中组织代码的基本单位本质上是一个包含定义和语句的文件本文将深入探讨模块与包的概念使用方法以及高级应用技巧结合中的包管理最佳实践模块分类在生态系统中模块可以分为三大类模块类型说明示例内置模块解释器自带的标准库模块第三方模块社区开发者创建的模块自定义模块开发者自己创建的模块项目中自定义的文件重要提示首次导入自定义模块时会执行该模块中的所有顶层代码每个模块都有自己的名称空间模块中定义的变量属于该模块的名称空间模块导入方式导入整个模块使用模块中的内容从模块导入特定内容直接使用无需模块名前缀工作原理使用方式导入时被导入的对象会直接引用模块中对应变量的内存地址可以直接使用而无需模块前缀导入时重命名模块重命名函数重命名导入所有内容不推荐注意这种方式可能导致命名冲突不利于代码可读性和维护性在大型项目中应避免使用控制模块导入我们可以在每一个模块的文件中使用如下的操作可以使用列表来控制语句导入的内容在模块文件中定义不在中的变量和函数使用时不会被导入这个变量不会被导入模块的特殊属性属性每个文件都有一个属性当直接运行该文件时的值为当作为模块被导入时的值为模块名这个特性可用于编写既可作为模块导入又可独立运行的代码模块内的代码执行主函数逻辑辅助函数这部分代码只在直接运行文件时执行作为模块导入时不会执行运行模块自测试模块无法识别问题在导入模块时会按照一定顺序搜索模块文件在有些情况下我们自己定义的模块不一定会被检测到如下列图片例如当我们的模型层期望用到另外一个包的代码时往往会这样引入但这样是无法被识别到的我们应该是需要这样做标记外层的包为根包去掉前缀这样就会检测到我们是在这个包下进行操作的即可识别到从我们的根包出发也就是图片中蓝色的包这个是需要在手动标注的包的概念与使用包是一种特殊的模块它是一个包含文件的目录用于组织相关模块包可以包含子包和模块形成层次结构包的结构示例使目录成为包的文件模块模块子包文件的作用标识目录为包将包含的目录视为包初始化包在导入包时执行初始化代码定义包的公共接口通过列表指定时导入的内容自动导入子模块可以在中导入子模块使它们在导入包时可用示例从子模块导入主要函数使它们在导入包时可用定义包导出的符号包初始化代码已加载包的导入方式导入包中的模块完整路径导入导入特定模块导入子包中的模块导入包中特定内容相对导入与绝对导入绝对导入从项目的顶级包开始导入相对导入使用点号表示相对位置当前包中的模块父包中的模块祖父包中的模块在中导入同级模块导入同级模块导入父包中的模块导入父包中的模块导入父包中模块的特定函数注意相对导入只能在包内使用不能在顶级模块中使用相对导入基于当前模块的属性而直接运行的脚本的总是高级应用技巧动态导入在运行时根据条件动态导入模块方法使用方法使用推荐根据名称动态导入模块无法导入模块示例根据条件选择不同的模块根据数据库类型动态选择数据库模块延迟导入推迟导入耗时模块直到真正需要时才导入可以加快程序启动速度只在函数被调用时导入图像处理函数仅在需要时导入只在需要处理图像时才导入处理图像使用优化内存在模块级别的类中使用限制属性提高内存效率使用优化内存的数据点类只允许这些属性计算到原点的距离包的发布与安装创建自己的包并发布到创建文件打包与上传安装打包工具构建分发包上传到安装包中的包管理提供了强大的图形界面来管理包让包的安装和管理变得简单高效使用工具在中管理包的最简单方法是使用内置的工具点击底部的标签打开包管理器在搜索框中输入要安装的包名称点击包右侧的按钮安装包已安装的包会显示在标签下可以查看版本并进行升级或卸载操作更改的源默认的源在国内访问可能较慢可以更换为国内镜像以提高下载速度在界面点击左上角的齿轮图标点击按钮添加新的软件源输入国内镜像源地址例如阿里云清华中国科技大学豆瓣使用管理包除了工具外还可以通过设置管理包进入点击按钮添加新包在弹出窗口中搜索并安装需要的包导出和导入项目依赖在团队开发中共享项目依赖非常重要提供了方便的方式来管理文件导出依赖推荐使用工具导出仅项目使用的依赖包安装在项目根目录执行提示参数会强制覆盖已存在的文件确保使用编码处理文件导入依赖在的中执行或者指定国内镜像源使用虚拟环境支持多种虚拟环境管理工具如和创建新项目时选择虚拟环境类型对于现有项目可以在中配置点击齿轮图标选择然后选择合适的虚拟环境类型虚拟环境工具对比工具优点缺点适用场景轻量级易于使用需要手动维护简单项目自动管理依赖有锁文件比慢中型团队项目同时管理版本和包占用空间大数据科学项目模块开发最佳实践模块组织相关功能放在同一个模块中单个模块不要过大保持在行以内使用子模块和子包组织复杂功能使用清晰的命名约定避免与标准库和流行第三方库冲突导入顺序遵循建议的导入顺序标准库导入相关第三方库导入本地应用库特定导入文档化模块和包为模块类和函数编写清晰的文档字符串模块名称这个模块提供了处理数据的实用函数主要功能数据清洗特征工程数据转换清洗输入的参数需要清洗的数据帧返回清洗后的数据帧示例函数实现第十一章面向对象编程对象的本质对象本质上是一个容器用来存放数据和功能的集合体面向对象编程的核心思想是将数据和操作数据的方法封装在一起形成独立的实体为什么需要对象以开发游戏为例每个英雄都有自己的属性如攻击力移动速度和功能如技能如果不使用对象代码会变得非常冗余不使用对象的方式盖伦我的名字是职业是攻击力是移动速度是第二个英雄后裔我的名字是职业是攻击力是移动速度是使用字典可以改进一些如下但这样还是有一些瑕疵因为函数是暴露在外面的最理想的状态是函数也存在在这个对象里我的名字是职业是攻击力是移动速度是盖伦在对象中还有类的这么一个概念比如说又新创建了一个艾希英雄他与后裔的差别无非就是与是不一致的但他们都同属于这个职业所以他们就可以存在在一个类里面在面向对象编程里面是先创建一个类再将对象创建出来所以类也算是一种容器他也可以被称作是对象我的名字是职业是攻击力是移动速度是在程序运行时类的子代码会被运行也就代表类在定义阶段就已经创建好了名称空间在里面类的名称空间中会默认创建一个的字典属性所以想要拿到类的属性实际上访问的是类名称空间中的字典属性提供了一个更简便的语法也就是通过类名属性名来访问的每次调用一个类就会产生一个对象此时这个对象里面的是空的需要添加值给对象添加属性亚瑟可是通过这种方式过于复杂也提供了简便的语法妲己后裔亚瑟妲己后裔方法为了减少代码冗余我们可以定义一个初始化方法在创建对象时自动设置属性我的名字是职业是攻击力是移动速度是在程序运行时类的子代码会被运行也就代表类在定义阶段就已经创建好了名称空间后裔程咬金妲己后裔程咬金妲己这还不够完美面向对象的核心思想就是整合两个字现在定义的这个函数和类是完全独立开的那有没有什么办法能把这个函数和前面定义的类进一步整合到一起呢最好是产生对象的时候就自动调用这个功能完成对象属性的初始化操作这时候拿到的对象就是有自己独有属性的对象我的名字是职业是攻击力是移动速度是在程序运行时类的子代码会被运行也就代表类在定义阶段就已经创建好了名称空间在我们调用类自动创建对象的时候内部会自动调用类下面的方法并传入一个空对象所以在实际传值时仅需要传入四个参数即可后裔空对象程咬金妲己后裔程咬金妲己我的名字是后裔职业是攻击力是移动速度是我的名字是程咬金职业是攻击力是移动速度是我的名字是妲己职业是攻击力是移动速度是进一步修改代码通过拿属性过于繁杂所以也可以用到类名属性名的方式来传值给函数并且在代码最后在打印函数的内存地址的时候会发现打印类里的函数是一个正常的函数而打印对象的函数方法则是一个绑定方法也就是说类的函数属性绑定给对象使用了之后就不再是一个普通函数我的名字是职业是攻击力是移动速度是在程序运行时类的子代码会被运行也就代表类在定义阶段就已经创建好了名称空间在我们调用类自动创建对象的时候内部会自动调用类下面的方法并传入一个空对象所以在实际传值时仅需要传入四个参数即可后裔空对象程咬金妲己绑定方法三个内存地址不一样并不代表代码就存了三份代码本身只存了一份因为类的作用就是为了减少计算机资源的浪费可以理解为类的属性绑定给对象之后这个函数的内存地址就会被包装成一个绑定方法或者也可以理解为是一个装饰器当通过对象访问这些函数的时候访问的也是这个绑定方法的内存地址而他在给函数传入值时也会像方法一样自动传入一个对象进去所以就能明白在我们实例化对象传入参数时他默认的第一个参数是一个对象这个对象就是对象他仅仅只是一个变量名在代码的规范角度来讲类里面的函数的第一个对象就是仅此而已通过这种方式只需要在方法下增添需要的绑定方法添加对应的函数功能就能够实现谁调用这个对象的函数方法就给谁增添对应的数据我的名字是职业是攻击力是移动速度是购买了后裔程咬金妲己屠龙宝刀屠龙宝刀面向对象的三大特性封装封装是将数据和方法包装在对象内部并向外界提供必要的接口同时隐藏实现细节的过程属性隐藏使用名称修饰实现属性隐藏即在属性名前加上双下划线私有属性私有方法购买了后裔无尽战刃但这只是名称修饰仍然可以通过修饰后的名称访问无尽战刃后裔购买了无尽战刃属性访问控制为了更好地控制属性访问可以使用和方法年龄必须为整数相当于的方法设置年龄为使用装饰器的装饰器提供了更优雅的属性访问方式这段代码展示了中的属性装饰器的使用它有以下意义封装性通过私有变量和属性装饰器实现了对数据的封装和保护数据验证在方法中可以对输入数据进行验证确保数据的有效性接口一致性虽然内部使用了方法但对外提供了类似直接访问属性的简洁接口控制访问可以分别控制属性的读取修改和删除行为获取年龄设置年龄年龄必须为整数删除年龄属性使用使用使用继承继承允许一个类子类继承另一个类父类的属性和方法单继承和多继承吃单继承汪汪叫飞翔多继承吃继承自汪汪叫吃继承自汪汪叫继承自飞翔继承自查看继承关系方法重写和调用父类方法子类可以重写父类的方法也可以通过调用父类方法我是今年岁了这里调用父类的方法我是我今年岁了我是属于品种的狗旺财哈士奇输出我是旺财今年岁了调用了父类的方法我是旺财我今年岁了我是属于哈士奇品种的狗重写了父类的方法继承的属性查找顺序使用算法计算方法解析顺序基类的方法第一个子类的方法第二个子类的方法输出先是自己再是第一个传入的类第二个传入的类最后是基类最后是按顺序查找菱形继承问题菱形继承钻石继承是指一个子类通过不同的路径继承了同一个基类菱形继承结构输出在中无论继承路径如何复杂每个类在中只会出现一次设计模式是一种设计模式用于为类添加功能而不使用传统继承关系多态多态是一种编程思想在中是没有多态这么一个技术的比如汽车这种事物他就有很多种形态奔驰宝马奥拓这就叫多态多态只是在继承下演化出来的一种概念而已而我们要知道的是为什么要有多态这个概念奔驰宝马奥拓这都是可以跑的对吧也就是说跑这个功能是汽车共有的功能那我就在他们的共同的父类里面定义一个方法开始跑奔驰跑起来好快哦宝马跑起来好稳哦奥拓跑起来好省油哦多态性示例同一方法调用不同行为鸭子类型多态性带来的好处统一了使用标准以不变应万变无论对象千变万化使用者都是使用同一种方式去调用需要注意的是不一定要继承父类的方法才算是一种多态引入推崇的一个鸭子模型的概念只要你长得像鸭子走路像鸭子那么你就是一只鸭子所以类只要内部定义的方法一样那么他们就同属于一种类别这也是一种解耦合的方法呱呱呱鸭子游泳人类模仿鸭叫人类游泳人类没有继承类但可以表现得像鸭子抽象基类如果你不想使用鸭子模型就想用父类来达到规范子类的效果可以引入一个抽象基类概念而这并不是推崇的推崇的永远是简洁至上这样限制只会让程序变得臃肿奔驰开始跑奔驰停止如果没有实现所有抽象方法会抛出类方法与静态方法方法类型比较方法类型装饰器第一参数使用场景实例方法无操作实例状态类方法操作类状态替代构造函数静态方法无特殊参数工具函数示例场景在实际的开发中实例方法通常用于操作与当前对象状态相关的行为比如我们定义一个类该类实例方法可以访问每个对象的名称和年龄并提供修改获取这些属性的功能创建实例并调用实例方法输出类方法常见示例场景替代构造函数类方法通常用于定义一个替代构造函数根据不同的输入创建对象比如可以根据不同的配置文件或环境变量来初始化对象操作类状态类方法通常用于修改与类相关的共享数据比如修改所有实例的共享配置连接数据库成功地址端口号从配置文件如模块或环境变量中读取和并实例化对象使用类方法来创建实例输出输出连接数据库成功地址端口号应用场景你可以在配置或环境变化时灵活地调整类的构造逻辑不需要每次都显式地提供参数这使得代码更加简洁并且易于扩展静态方法第一参数无特殊参数静态方法与类或实例无关不需要或参数访问实例变量静态方法无法访问实例或类的属性访问类变量静态方法只能做独立于实例和类的操作它通常用于工具函数或者处理与对象本身无关的逻辑常见示例场景静态方法通常用来封装一些独立的工具函数这些函数与类或实例的状态无关例如数学计算字符串处理等功能调用静态方法无需实例化类输出输出反射机制反射是指在程序运行时能够检查访问修改对象的属性和方法的能力在中反射允许我们在运行时动态地操作类和对象特别是在无法事先确定对象类型或者对象的属性和方法时反射提供了极大的灵活性常用反射函数函数描述示例检查对象是否有属性获取对象的属性设置对象的属性删除对象的属性列出对象的所有属性获取对象的类型检查对象是否为类的实例检查类是否为另一个类的子类检查对象是否可调用获取对象的检查对象是否有指定属性用于检查一个对象是否有指定名称的属性返回或示例检查对象是否有属性输出获取对象的属性用于获取对象的属性如果该属性存在返回其值如果不存在则返回指定的值如果没有提供当属性不存在时会抛出示例获取属性的值输出如果属性不存在使用默认值属性存在返回输出设置对象的属性用于给对象的指定属性设置新值如果该属性不存在则会动态创建一个新的属性示例动态设置新的属性输出删除对象的属性用于删除对象的指定属性删除属性后访问该属性会抛出示例删除属性会抛出列出对象的所有属性返回一个列表包含对象的所有属性和方法包括其继承的属性示例列出对象的所有属性获取对象的类型返回对象的类型即类示例输出检查对象是否为类的实例用于检查对象是否为类的实例或其子类的实例示例检查是否是类的实例是类的实例输出是类的实例检查类是否为另一个类的子类用于检查类是否是类的子类示例输出检查对象是否可调用用于检查对象是否可以调用即它是否是一个函数或具有方法的对象示例输出输出因为对象不可调用获取对象的返回一个字典包含对象的所有属性和对应的值这是访问对象的实例变量的一种方式示例输出反射示例检查和获取属性检查对象是否有属性获取属性的值输出设置新属性动态为对象设置属性输出删除属性删除属性如果取消注释会抛出动态调用方法检查方法是否可调用获取方法输出获取所有属性输出列出所有属性和方法通过字符串获取类检查类是否在全局命名空间中动态获取类使用动态获取的类实例化对象输出通用枚举以及抽象接口定义模块实现枚举类型模块引入提供了一种创建枚举的方法枚举是一组绑定的符号名称成员这些名称是常量并且具有唯一的通常是整数值使用枚举可以使代码更具可读性更易于维护并能有效防止因使用魔法数字或字符串而导致的错误常用功能类函数装饰器描述创建基本枚举类型的基类的子类其成员也是整数可以和整数直接比较的子类其成员可以使用位运算符的子类其成员也是整数并支持位运算在定义枚举成员时自动为其分配合适的值通常是递增的整数一个类装饰器确保枚举中没有重复值的成员访问枚举成员通过字符串名称访问枚举成员通过值获取枚举成员枚举成员属性获取成员的名称字符串枚举成员属性获取成员的值批注核心记忆功能模块继承或来定义自己的枚举使用自动分配值非常方便通过或来引用和获取枚举成员和是最常用的成员属性装饰器有助于保证值的唯一性模块代码示例用于类型注解模块演示准备模块功能演示基本枚举基本枚举如果没有这不会报错但可能不是期望的行为枚举成员的名称的值通过值获取成员通过名称获取成员遍历枚举使用自动分配值和确保值唯一使用和确保枚举成员的值是唯一的值通常从开始递增使用和的枚举整数枚举整数枚举成员可以直接与整数比较标志枚举和支持位运算标志枚举和成员的值通常是的幂通常定义一个无或空标志组合标志权限值为是否有权限是否有权限是否只有权限权限值为是否包含所有权限类似但其成员也是整数使用模块的常量通常是通常是通常是模式值为文件是否可读坑点与建议模块可读性与维护性使用枚举可以替代代码中散落的魔法数字或字符串常量使得代码意图更清晰更易于维护当需要修改某个状态的含义或值时只需在枚举定义处修改一处即可成员的唯一性默认情况下允许不同的成员名称指向相同的值别名使用类装饰器可以强制枚举中的所有成员值必须唯一如果存在重复值则会在定义时抛出成员的比较枚举成员是单例你可以使用或来比较两个枚举成员是否相同和的成员还可以直接与整数进行比较迭代与访问可以迭代枚举类的所有成员可以通过成员名方括号加成员名字符串或成员值来访问特定的枚举成员的行为会自动为枚举成员分配一个值默认情况下对于它从开始递增对于它会分配的幂你可以通过重写特殊方法来自定义的行为与位运算和类型的枚举成员支持位运算符非常适合表示权限状态组合等场景可以使用操作符来检查一个组合标志是否包含某个特定标志序列化默认情况下枚举成员在序列化时可能不会直接变成期望的字符串或整数你可能需要自定义序列化逻辑或者在序列化前获取成员的或属性模块定义抽象基类模块用于帮助定义和使用抽象基类抽象基类是一种不能被直接实例化的类它存在的目的是作为其他类的模板或接口约定子类如果继承了抽象基类就必须实现抽象基类中声明的所有抽象方法和抽象属性否则子类本身也会成为抽象类无法实例化这有助于强制执行接口规范实现多态并构建更健壮更松耦合的系统常用功能类装饰器描述一个辅助类用于通过继承来创建抽象基类一个装饰器用于声明一个抽象方法子类必须实现它一个装饰器用于声明一个抽象属性子类必须实现在旧版本中通常通过组合和实现声明抽象类方法声明抽象静态方法可以检查一个对象是否是某个抽象基类的实例即使是通过虚拟子类注册的类方法将注册为的虚拟子类即使没有显式继承批注核心记忆功能模块继承来定义抽象基类使用来标记那些必须在具体子类中被重写的方法抽象基类不能直接实例化它的主要目的是定义一个清晰的接口或契约供子类遵循模块代码示例假设可用用于类型注解模块演示准备模块抽象基类功能演示定义一个抽象基类定义抽象基类继承自表明这是一个抽象基类一个表示几何形状的抽象基类标记为抽象方法计算并返回形状的面积子类必须实现此方法抽象方法通常只有或标记为抽象方法计算并返回形状的周长子类必须实现此方法子类必须实现方法旧版本用返回形状的类型名称例如子类必须实现此属性这是一个具体方法子类可以直接继承或重写返回对形状的描述这是一个面积为周长为抽象基类已定义尝试实例化抽象基类会失败错误抽象基类被实例化了不应发生尝试实例化时捕获到预期的创建具体子类和创建具体子类和表示圆形的具体类半径必须为正数实现抽象方法实现抽象方法实现抽象属性圆形表示矩形的具体类宽度和高度必须为正数矩形具体子类和已定义实例化具体子类圆的描述矩形的描述演示未完全实现抽象方法的子类演示未完全实现抽象方法的子类应该也实现和故意不实现和不完整的正方形定义了一个未完全实现抽象方法的类错误不完整的抽象子类被实例化了不应发生如果能实例化这里调用会出错尝试实例化时捕获到预期的演示已在各节内进行模块演示结束坑点与建议模块强制接口实现模块的主要目的是强制子类实现特定的方法和属性从而确保它们都遵循一个共同的契约或接口这在大型项目或框架设计中非常有用可以提高代码的稳定性和可维护性实例化错误如果一个类继承了并有未被实现的抽象方法属性通过或标记那么尝试实例化这个类或其同样未完全实现的子类会在运行时抛出从开始可以直接使用在此之前定义抽象属性通常需要组合使用和虚拟子类除了通过继承你还可以使用将一个完全不相关的类注册为抽象基类的虚拟子类这意味着会返回但并不会真正从继承任何方法或属性也不会被强制实现抽象方法这种方式主要用于在不修改现有类继承关系的情况下将其归类到某个抽象接口下不仅仅是接口虽然抽象基类的作用与某些语言中的接口概念相似但的抽象基类可以包含具体的方法实现如示例中的方法子类可以直接继承这些实现何时使用当你希望定义一组类应该共同拥有的行为但具体实现方式因类而异时抽象基类是一个很好的选择例如定义一个通用的接口然后有等具体实现元类编程元类是创建类的类是的内置元类元类的核心方法方法描述调用时机创建类对象定义类时初始化类对象类创建后创建类的实例实例化类时使用动态创建类在我们使用定义关键字时其实是底层执行了以下四步操作为我们定义了一个类分别是定义类名定义基类执行类子代码产生名称空间调用元素定义类名定义基类执行子类代码产生名称空间你好我是今年岁函数语法要执行的代码字符串或代码对象可选参数指定代码执行时的全局命名空间默认为当前全局命名空间可选参数指定代码执行时的局部命名空间默认与相同这里传入三个参数包含类方法定义的代码字符串空字典作为全局命名空间避免访问外部全局变量作为局部命名空间执行后中定义的方法会存储在这个字典中这样做的目的是隔离执行环境并将执行结果类的方法定义收集到字典中之后可以将这个字典传给函数来动态创建类调用原类创建实例对象张三调用实例方法你好我是张三今年岁自定义元类对于元类来说最关键的步骤也就是在第四步在我们调用原类之前可以对这个类做一些自定义化操作如类名不能带特殊符号类必须写文档注释我们通过一个自定义类来实现这个功能类名不能包含下划线类必须有文档注释检查类属性名是否符合规范属性名必须全部小写检查是否有必要的方法类必须实现方法检查类的基类类必须继承至少一个父类人类的基本信息类如果没有这个注释会报错元类的方法在我们调用类产生一个空对象的时候在执行方法之前一定执行了其他方法我们都知道在中所有的类都默认继承自基类但在下述的例子当我们没有给自定义元类传入他报错了这是为什么呢本质上我们的也就指的是这个类对于来说他只是一个形参而已真正为我们继承父类的方法是方法检查类的基类类必须继承至少一个父类我们可以通过进一步剖析方法检查类的基类类必须继承至少一个父类通过调用父类的方法他会在底层帮我们继承对象存放属性等元类的方法实例当调用类如创建实例时实际上是调用元类的方法自定义此方法可以控制实例化过程控制类实例化过程创建的新实例正常的实例化过程创建实例并初始化返回的现有实例第一次调用创建新实例第二次调用返回现有实例参数被忽略仍然是验证是同一个实例元类链和类创建过程步骤描述涉及方法收集类定义信息解释器执行类体调用元类的创建类对象调用元类的初始化类对象返回创建的类类可以使用了元类创建类元类初始化类元类调用类创建实例调用类的初始化实例调用类的元类初始化实例类创建实例类初始化实例定义完成开始创建实例内置的元类属性和方法表属性方法描述示例指定类的元类方法解析顺序直接父类元组直接子类列表对象的类返回方法解析顺序特殊方法魔术方法的特殊方法也称为魔术方法或双下方法是面向对象编程中的核心概念它们允许自定义类行为以适应的语言特性这些方法以双下划线开始和结束如当特定操作发生时会被自动调用对象创建与销毁方法名描述触发方式使用场景初始化对象创建实例后调用设置实例属性创建对象实例化时调用比先自定义实例创建过程实现单例模式析构方法对象被销毁时调用释放资源关闭文件或连接实际应用场景类变量用于存储单例实例这里的也就是我们当前的类实现单例模式确保只创建一个数据库连接实例若我们的类里面的变量没有被初始化则创建一个新的实例调用父类的方法创建实例创建新的数据库连接实例打印日志返回单例实例如果类对象身上初始化完成数据库连接对象模拟数据库连接连接到数据库成功用户名密码连接成功对象销毁时关闭连接关闭数据库连接使用示例不会创建新实例判断两者是否为同一个实例连接到数据库对象表示方法名描述触发方式使用场景可读字符串表示在直接输出类时标准化的输出类上面的所有属性正式字符串表示为开发者提供详细信息理想情况下应返回可重新创建对象的代码实际应用场景返回用户友好的描述返回可重新创建此对象的代码使用示例苹果输出苹果输出苹果在调试中的价值苹果香蕉会显示完整的信息有助于调试输出的是一个友好易读的字符串适合用户查看输出的是一个更正式的字符串通常能够通过来重建该对象示例交互式环境中的在的交互式环境中比如直接在命令行输入当你打印一个对象时如果对象有方法通常会看到的返回值而不是在交互式环境中自动调用的目标的设计目标是让对象的字符串表示能够作为一种明确无歧义的代码表达式最好能够让开发者通过来重新构建该对象例如返回的字符串应该是如果你运行它应该能够重新创建出一个与相同的实例集合类操作方法名描述触发方式使用场景获取对象长度自定义集合的大小索引访问使对象可通过索引或键访问索引赋值允许通过索引设置值删除索引项允许通过索引删除项返回迭代器使对象可迭代返回下一个值实现迭代器协议成员检查自定义成员检查逻辑实际应用场景自定义商品购物车返回用户友好的描述返回可重新创建此对象的代码购物车类管理用户选择的商品及其数量初始化空购物车商品商品数量的映射增加商品到购物车参数要添加的商品添加的数量默认为如果商品已经在购物车中更新数量如果商品不在购物车中直接添加支持通过索引访问返回商品和数量的元组商品不在购物车中支持通过索引设置数量商品不在购物车中支持通过删除商品商品不在购物车中返回购物车中的商品种类数量使购物车可迭代返回商品和数量支持成员检查被调用计算购物车中所有商品的总价用户友好的购物车展示购物车为空购物车内容总计测试代码创建商品苹果香蕉橙子商品商品商品商品购物车基本操作空购物车添加商品测试添加商品添加已有商品测试添加已有商品现在应该有个苹果通过索引访问测试通过索引访问获取为的商品信息为的商品信息数量通过索引修改数量测试通过索引修改数量将香蕉的数量改为删除商品测试删除商品删除苹果长度测试购物车商品种类迭代购物车测试迭代购物车中的商品个成员检查测试成员检查香蕉在购物车中苹果在购物车中橙子在购物车中添加新商品测试添加新商品计算总价测试购物车总价错误处理测试错误处理测试尝试访问不存在的商品预期的错误调用与比较操作我们这里主要讲这个方法有利于我们理解为什么方法可以在对象实例化的时候调用当我们调用一个对象也就相当于被调用了张三被调用了张三那么就会自动调用中的方法同样的内的返回值也会传递给那么也就是说如果想把一个对象变成一个可以加括号调用的对象就在对象的类里面增添一个方法方法名描述触发方式使用场景使对象可调用创建可调用对象函数式编程相等比较自定义对象相等性小于比较自定义对象排序大于比较自定义对象排序小于等于自定义对象排序大于等于自定义对象排序计算哈希值允许对象作为字典键或集合元素实际应用场景数据分析器添加数据点数据必须是数字类型调用对象时可以添加新数据并返回分析结果比较两个分析器的数据是否相同根据数据平均值比较分析器只能与另一个比较无法比较空数据集允许对象作为字典键基于名称和数据的散列使用示例温度分析器通过调用对象获取分析结果输出分析结果函数式用法添加新数据并获取结果更新后的分析结果创建另一个分析器用于比较湿度分析器比较分析器的平均值低于的平均值高于或等于使用分析器作为字典键温度数据湿度数据字典中的分析器算术运算操作在我们通过内置的运算符需要频繁实现一些非常规四则运算时可以重写四则运算方法通过这样来快速的进行数学运算分析方法名描述触发方式使用场景加法自定义对象相加减法自定义对象相减乘法自定义对象相乘除法自定义对象相除实际应用场景向量运算向量加法支持向量与标量相加不支持的操作数类型向量减法不支持的操作数类型向量乘法点积或标量乘法向量点积向量与标量相乘不支持的操作数类型向量除法仅支持标量除法除数不能为零向量只能被标量除向量长度单位向量使用示例向量加法向量减法向量点积向量缩放向量除法向量长度和归一化的长度的单位向量单位向量的长度属性访问控制方法名描述触发方式使用场景获取不存在的属性不存在处理不存在的属性访问设置属性拦截所有属性赋值删除属性拦截属性删除实际应用场景属性验证与保护存储实际数据保护的属性列表当访问不存在的属性时调用记录未知属性访问并返回警告尝试访问不存在的属性拦截所有属性赋值允许设置内部属性是受保护的属性不能直接赋值验证并存储数据年龄必须是整数年龄必须在之间无效的电子邮件格式存储验证后的数据属性设置为拦截属性删除是受保护的属性不能删除已删除属性属性不存在无法删除使用示例设置属性经过验证通过验证通过验证三十类型错误错误尝试访问不存在的属性返回并显示警告尝试删除属性正常删除尝试删除受保护属性错误显示当前属性上下文管理语句方法名描述触发方式使用场景进入上下文资源获取连接建立等退出上下文块结束资源释放异常处理等实际应用场景数据库连接管理进入上下文时建立连接连接到数据库退出上下文时处理异常并关闭连接发生异常时回滚事务发生异常回滚事务异常信息没有异常时提交事务提交事务关闭数据库连接返回表示不抑制异常让异常继续传播返回表示抑制异常异常不会传播到语句之外不抑制异常数据库未连接开始事务数据库未连接执行模拟错误语法错误语法错误执行结果数据库未连接提交事务数据库未连接回滚事务使用示例正常情况正常执行自动提交事务并关闭连接使用示例异常情况有异常情况这会触发异常这一行不会执行由于异常这行不会执行捕获到异常描述符与属性装饰器描述符协议方法方法描述触发条件使用场景获取属性值访问属性时触发自定义属性访问行为设置属性值属性赋值时触发验证或转换属性值删除属性删除属性时触发自定义属性删除行为实际应用场景数据验证描述符使用示例创建有效的对象张三尝试设置无效的值李名字太短验证错误三十类型错误类型错误无效的邮箱格式验证错误设置有效值李四更新后属性装饰器实际应用属性装饰器是中实现属性的更简洁方式它允许我们用方法行为来定义属性以下是一个成绩管理系统的示例课程分数的映射日期出勤状态的映射学生姓名只读属性学生只读属性获取成绩副本防止外部直接修改添加或更新课程成绩成绩必须是数字成绩必须在到之间计算平均成绩计算绩点成绩到绩点的映射计算每门课的绩点记录出勤状态出勤状态必须是或计算出勤率默认迟到计为次出勤学生平均分使用示例王小明添加课程成绩数学物理化学语文记录出勤访问属性学生姓名学生课程成绩平均分出勤率尝试修改只读属性张三这会失败因为是只读属性错误显示所有课程及分数所有课程成绩常见特殊方法使用陷阱与最佳实践陷阱与注意事项陷阱混淆这两个方法的用途和调用顺序最佳实践除非实现元类或单例模式一般只需重写错误示例错误返回元组而非同类型的对象正确示例正确返回同类型对象和陷阱实现而不实现导致对象无法用作字典键最佳实践如果重写也应该重写或设置使对象不可哈希如果不实现对象将不可哈希选项使对象不可哈希选项实现兼容的哈希方法递归问题陷阱在特殊方法中无限递归调用自身最佳实践避免在特殊方法中使用可能触发同一方法的操作错误这会导致无限递归递归调用正确使用原始值和陷阱不了解这两个方法的优先级和用途最佳实践优先于对于集合类实现对于真假逻辑实现返回集合长度特殊逻辑即使长度为如果有特定标记也认为是反向方法失效陷阱忽略实现反向操作方法如最佳实践为算术操作同时实现普通方法和反向方法普通加法告诉尝试反向操作反向加法测试触发总结特殊方法的选择指南需求推荐实现的特殊方法注意事项初始化和配置对象保持简单仅做必要设置自定义对象创建谨慎使用主要用于元类和单例字符串表示应提供准确代表对象的信息集合或容器行为保持与内置类型一致的行为对象比较和哈希注意和的兼容性算术运算以及对应的反向方法对不兼容类型返回属性访问控制注意避免递归调用资源管理确保资源正确释放处理异常描述符协议用于创建可重用的属性行为对象与类的高级概念深入理解实例类和元类关系定义一个普通类创建类的实例打印并验证三个层次的关系三个层次的关系实例的类是类的类是元类是自己的元类打印并验证继承关系继承关系所有类都继承自也继承自打印并验证元类关系元类关系实例的类型是类的类型是的类型也是展示类型检查类型检查是的实例是的实例是自己的实例属性查找的复杂情况实现自定义元类并定义元类方法元类属性调用元方法父类属性调用父类方法子类属性调用子类方法对象属性查找子类属性首先在实例中查找然后是类然后是父类类属性查找子类属性首先在类中查找然后是父类然后是元类方法查找调用子类方法调用父类方法从父类继承元类方法调用元方法从元类获取删除子类属性回退到父类父类属性删除父类属性回退到元类元类属性内存管理与对象生命周期对象创建和销毁的完整过程阶段触发方法描述创建分配内存并创建实例初始化初始化实例属性表示定义对象的字符串表示使用各种操作符和方法对象的正常使用期销毁对象不再被引用时的清理分配内存初始化对象清理资源在销毁时仍未释放创建和使用对象调用调用使用资源使用资源两种清理方式显式释放推荐依赖垃圾回收不推荐删除引用触发垃圾回收引用计数和循环引用的内存管理主要依靠引用计数每个对象都有一个引用计数器记录有多少个引用指向该对象当引用计数降为时对象会被自动销毁内存被释放函数可以查看对象的引用计数创建节点删除节点创建节点创建循环引用循环引用创建弱引用或保存以便后续检查删除外部引用删除对节点的外部引用垃圾回收前检查对象是否还存在节点仍然存在于内存中手动触发垃圾回收强制运行垃圾回收垃圾回收后再次检查对象是否存在节点已被回收不可能进这个判断因为存在计数引用和循环引用问题高级常用设计模式单例模式或使用元类实现若没有实例化过则新建一个实例返回的实例或使用装饰器实现单例模式装饰器参数是被装饰的类当使用语法时解释器会自动将被装饰的类作为第一个参数传递给装饰器函数装饰器工作原理当使用装饰时实际上执行了函数接收作为参数返回函数该函数替代了原始的当我们调用时实际上调用的是函数内部可以访问因为它是一个闭包能够访问外部函数的变量用于存储每个类的单例实例如果该类的实例不存在则创建一个新实例返回该类的单例实例这里相当于懒汉式单例模式的使用场景我是单例的在模块级别创建实例其他文件中使用输出我是单例的懒汉式单例模式在以下情况特别适用资源密集型对象当创建实例需要消耗大量资源如数据库连接文件系统操作等懒汉式可以推迟实例化直到真正需要时才创建创建新的数据库连接初始化只在首次创建时执行连接到配置管理器应用程序的配置管理器通常是单例的且配置加载可能很耗时从文件加载配置模拟加载配置文件的耗时操作应用程序状态管理当需要全局访问应用状态但又不希望在程序启动时立即初始化时元类实现方式适合需要更灵活控制实例化过程的场景特别是需要根据参数动态决定实例化行为的情况日志管理器单例可以根据不同的日志级别创建不同配置的单例组合键针对每个日志级别创建唯一实例创建级别的日志记录器装饰器实现方式适合需要将现有类转换为单例而不修改其内部代码的场景第三方库类转换为单例将外部库中的类转换为单例饿汉式单例模式的使用场景饿汉式单例模式最适合以下场景必然会使用的核心服务如应用程序中必定会使用的服务组件初始化事件总线模块级别立即创建实例在其他文件中使用应用程序设置和常量包含应用配置的单例对象加载应用程序设置立即创建全局设置对象线程安全要求高的场景饿汉式单例天然线程安全适合多线程环境初始化线程池线程池初始化代码提交任务到线程池任务提交逻辑程序启动时即创建线程池工厂模式抽象产品具体产品工厂类使用工厂工厂模式在以下场景中特别有用插件架构当系统需要动态加载和使用不同的插件或扩展时主应用程序演示如何使用插件定义插件接口工厂方法模式的实现插件目录插件包初始化文件图片处理插件文本分析插件首先我们定义一个插件接口插件必须实现方法插件必须实现方法依照插件接口新建目录文件夹使目录成为一个包这允许我们使用的导入方式列出所有可用的插件模块名方便外部遍历图片处理插件处理图片数据实际项目中这里会有图片处理逻辑例如调整大小滤镜裁剪等已处理的图片图片处理插件文本处理插件分析文本共个单词实际项目中这里会有更复杂的文本分析逻辑例如情感分析关键词提取语法检查等文本分析插件重点在我们的插件创建者的抽象基类工厂方法模式的核心动态导入插件模块获取插件类约定插件类名为模块名首字母大写创建并返回插件实例这里直接导入具体类不再使用动态导入这里直接导入具体类不再使用动态导入工厂注册表用于根据名称获取对应的工厂插件工厂注册表如果没有具体工厂则使用动态加载工厂使用我们的插件工厂与插件主应用程序演示如何使用插件系统插件系统演示工厂方法模式存储已加载的插件列出所有可用插件可用插件列表使用工厂方法模式加载所有可用插件获取插件创建者获取插件信息创建插件实例已加载插件类型加载插件失败使用图片处理插件使用图片处理插件模拟图片数据处理结果图片处理插件未加载使用文本分析插件使用文本分析插件要分析的文本分析结果文本分析插件未加载演示自定义插件创建演示自定义插件创建直接使用特定的创建者通过具体工厂直接创建插件动态注册一个新工厂注册自定义工厂自定义工厂信息自定义插件创建失败演示完成跨平台应用程序根据不同操作系统创建适当的组件使用场景根据当前操作系统渲染适当的按钮数据库访问层根据配置选择不同的数据库实现使用场景从配置创建适当的数据库连接测试替身创建在测试环境中替换真实依赖项测试场景观察者模式观察者列表当前状态注册观察者注册成功注销观察者注销成功不在观察者列表中通知观察者定义和方法名称为的观察者收到的更新使用观察者模式观察者观察者注册观察者注册观察者状态通知观察者状态通知观察者观察者模式在以下场景中非常有效事件驱动的系统如应用程序响应用户操作主题被观察者添加观察者移除观察者通知所有观察者观察者接口观察者接收通知后执行的方法具体观察者登录处理器模拟用户数据库登录请输入用户名和密码登录成功欢迎登录成功欢迎回来用户名或密码错误登录失败用户名或密码错误创建应用程序登录示例创建中央部件和布局创建用户名和密码输入框用户名请输入用户名密码请输入密码创建状态标签请登录创建按钮登录创建主题创建观察者注册观察者连接按钮点击事件添加部件到布局设置中央部件显示窗口发布订阅系统多个组件需要对特定事件做出响应收到新闻使用场景新闻分发系统用户用户今天是个好日子所有订阅者都会收到通知数据变更监控当对象状态变化需要通知其他对象时图表更新为新值表格更新为新值使用场景架构中的数据更新自动通知所有视图更新系统监控监控系统状态变化并触发警报正常发送邮件警报服务器状态变为发送短信警报服务器状态变为使用场景服务器监控系统严重错误触发所有警报代理模式代理模式是一种结构型设计模式它为其他对象提供了一种代理以控制对这些对象的访问可以把代理模式理解为一个守门员在客户和真实对象之间充当中介控制请求的传递和处理就像你想看一部付费电影时需要先通过一个守门员确认你是否支付了费用这名守门员就是代理他会在你访问电影资源之前先做一些检查确保你有权利观看接下来我们通过代码展示如何在中实现一些常用的代理模式静态代理动态代理保护代理虚拟代理静态代理实现静态代理在编译时确定代理行为非常适合结构固定的场景真实对象请求被调用代理在真实对象之前检查权限代理控制访问代理在真实对象之后记录日志使用代理动态代理实现动态代理可以在运行时动态地为对象添加功能而不需要在编译时确定定义一个装饰器打印函数执行时间执行时间秒正在执行任务使用动态代理保护代理实现保护代理是一种常见的应用场景用于控制对对象的访问权限下面的例子展示了如何实现一个简单的保护代理访问执行敏感操作权限不足使用保护代理权限不足虚拟代理实现虚拟代理用于控制昂贵资源的延迟加载只有在真正需要时才创建对象加载大量数据资源已加载执行操作使用虚拟代理首次调用会加载数据第二次调用不会再次加载数据原则原则概述是面向对象设计的五个核心原则的首字母缩写由罗伯特马丁在世纪早期提出这些原则旨在帮助开发者创建易于维护和扩展的软件系统原则包括原则全称简述单一职责原则一个类应该只有一个引起它变化的原因开放封闭原则软件实体应该对扩展开放对修改关闭里氏替换原则子类必须能够替换其基类使用接口隔离原则不应强制客户依赖于它们不使用的接口依赖倒置原则依赖抽象而不是具体实现遵循这些原则可以创建出更加灵活可维护可扩展的代码减少系统的脆弱性和紧耦合性提高代码的复用性和可测试性接下来我们将通过电商系统的实例逐一深入解析这些原则单一职责原则原则解析定义一个类应该只有一个引起它变化的原因核心思想每个类或模块只负责一项职责将不同的职责分离到不同的类中优势提高代码的内聚性降低类的复杂度增强代码的可维护性降低变更引起的风险电商系统中的应用让我们看看电商系统中如何应用单一职责原则在许多不遵循的系统中我们可能会看到一个超级类包含了所有与订单相关的功能违反单一职责原则的示例添加商品移除商品计算总价处理支付发送确认邮件处理配送保存到数据库这个类违反了单一职责原则它同时承担了多项职责处理订单项目计算金额处理支付发送通知处理配送数据存储等遵循的实现按照单一职责原则我们应该将不同职责分离到不同的类中订单模型类只负责订单的基本属性和状态仅负责添加商品到订单仅负责从订单中移除商品仅负责计算订单总价支付处理类专门负责支付相关功能专门处理信用卡支付处理的信用卡支付专门处理支付宝支付处理的支付宝支付专门处理微信支付处理的微信支付通知服务类专门负责通知功能通知订单创建向发送订单创建通知通知订单发货向发送订单发货通知通知订单取消向发送订单取消通知订单仓储类专门负责数据存储专门负责订单持久化将订单保存到数据库专门负责查询订单从数据库查询订单通过这样的设计我们将不同的职责分离到不同的类中每个类只负责一个特定的功能符合单一职责原则开放封闭原则原则解析定义软件实体类模块函数等应该对扩展开放对修改封闭核心思想当需要添加新功能时应该通过扩展现有代码如添加新类新方法而不是修改现有代码优势提高系统稳定性减少现有代码的改动和破坏提高代码的可复用性降低维护成本电商系统中的应用考虑支付处理的场景如果没有遵循开放封闭原则我们可能会这样实现违反开放封闭原则的示例处理信用卡支付处理的信用卡支付处理支付宝支付处理的支付宝支付处理微信支付处理的微信支付不支持的支付方式这个设计违反了开放封闭原则因为每当我们想添加新的支付方式如都需要修改这个类的代码添加新的条件分支遵循的实现按照开放封闭原则我们应该通过抽象接口和多态来实现支付处理定义支付处理接口处理支付获取支付方式名称实现具体支付处理器处理的信用卡支付信用卡支付处理的支付宝支付支付宝支付处理的微信支付微信支付创建支付处理器工厂不支持的支付方式现在如果我们想添加新的支付方式如只需要创建一个新的类实现接口将其添加到的映射中无需修改现有代码只需扩展新功能完全符合开放封闭原则里氏替换原则原则解析定义子类型必须能够替换其基类型使用核心思想继承类应当能够替代其父类使用而不改变程序的正确性子类应当保持父类的行为约定优势确保类的层次结构设计合理增强代码的可复用性提高系统的健壮性保证面向对象设计的正确性电商系统中的应用考虑配送方式的实现如果违反里氏替换原则我们可能会遇到这样的情况违反里氏替换原则的示例计算标准运费获取估计送达天数快递费用比标准运费高快递比标准配送快免费配送不提供送达时间估计返回而不是整数违反了父类的行为约定在上面的例子中类违反了里氏替换原则因为它的方法返回了而不是整数这与父类的行为约定不一致如果有代码依赖于的返回值是整数那么使用时可能会导致错误遵循的实现以下是遵循里氏替换原则的配送方式实现计算运费获取预计配送天数标准配送快速配送免费配送仍然返回整数保持与父类一致的行为约定免费配送较慢免费配送现在所有的配送方式类都符合里氏替换原则它们都保持了父类的行为约定返回数值返回整数接口隔离原则原则解析定义客户端不应该被迫依赖于它们不使用的接口核心思想一个类不应该依赖于它不需要的接口接口应该是小而精的一个大而全的接口应该被拆分为多个小接口优势提高接口的聚合度减少冗余的接口实现提高系统的灵活性和可扩展性降低接口之间的耦合度电商系统中的应用考虑订单通知的场景违反接口隔离原则的设计可能如下违反接口隔离原则的示例通知订单创建通知订单配送通知订单取消发送短信通知发送邮件通知发送推送通知这个接口违反了接口隔离原则因为它强制所有实现类都必须实现所有方法例如一个邮件通知实现类可能不需要实现或推送通知的方法遵循的实现按照接口隔离原则我们应该将大接口拆分为多个小接口通知订单创建通知订单配送通知订单取消发送邮件发送短信发送推送通知然后实现类可以选择性地实现它们需要的接口向发送订单创建通知订单已创建您的订单已创建向发送订单配送通知订单已发货您的订单已发货向发送订单取消通知订单已取消您的订单已取消发送邮件到主题向手机号发送订单创建短信通知您的订单已创建向手机号发送订单配送短信通知您的订单已发货向手机号发送订单取消短信通知您的订单已取消发送短信到实际应用中应该从订单中获取电话号码通过这种方式每个实现类只需要实现它关心的接口符合接口隔离原则依赖倒置原则原则解析定义高层模块不应该依赖于低层模块两者都应该依赖于抽象抽象不应该依赖于细节细节应该依赖于抽象核心思想通过引入抽象层如接口抽象类来解耦高层和低层模块实现可扩展性和可维护性优势降低模块间的耦合度提高代码的可重用性方便系统的单元测试提高系统的可扩展性电商系统中的应用考虑订单服务与数据持久化的关系违反依赖倒置原则的设计可能如下违反依赖倒置原则的示例直接依赖具体的实现插入订单数据查询订单数据这个设计违反了依赖倒置原则高层模块直接依赖于低层模块如果我们想切换到其他数据库需要修改类的代码遵循的实现按照依赖倒置原则我们应该让高层和低层模块都依赖于抽象定义订单仓储接口抽象保存订单根据查找订单列出所有订单实现具体的订单仓储类具体的实现保存订单到将订单保存到数据库实际的操作从数据库查询订单实际的查询从数据库查询所有订单实际的查询修改订单服务依赖抽象接口依赖抽象接口而不是具体实现通过这种设计依赖于抽象接口和而不是具体实现这样我们可以轻松地替换具体实现例如从切换到只需要提供一个新的实现类而不需要修改的代码中的是一个特殊的类变量它可以限制类的实例能拥有的属性节省内存并提高性能的工作原理与性能优势不使用的普通类使用的类创建实例检查内存使用实例大小字节实例大小字节检查属性字典有有属性访问性能比较测量访问性能访问属性时间秒访问属性时间秒的限制和继承行为行为测试实例可以访问实例可以访问尝试设置未在中定义的属性无法设置属性检查实例字典有第十二章异常处理异常处理是编程中的重要环节它允许程序在遇到错误时优雅地恢复或退出而不是直接崩溃基本异常处理异常处理的核心是结构它允许程序捕获并处理运行时错误异常的概念与意义异常是程序运行时发生的错误会打断正常的程序执行流程提供了强大的异常处理机制使程序能够预测可能的错误并妥善处理提供用户友好的错误信息防止程序意外终止实现优雅的错误恢复策略基础结构可能引发异常的代码请输入一个数字可能引发可能引发结果是处理特定异常输入必须是数字处理另一种特定异常不能除以零捕获所有其他异常不推荐这种写法发生了其他错误常见内置异常触发场景示例传入无效值类型不匹配除数为零索引超出范围字典中不存在的键文件不存在不存在导入模块失败不存在模块对象没有特定属性完整的异常处理结构完整的异常处理结构包括和四个部分每个部分负责不同的功能完整结构可能引发异常的代码请输入一个数字结果是处理特定异常包含异常的详细信息输入错误可能显示处理另一种特定异常除零错误可能显示处理所有其他异常这种方式比空更好其他错误只有当块中的代码执行成功且没有异常发生时执行计算成功完成无论是否有异常都会执行的代码块异常处理结束各代码块执行条件总结代码块执行条件典型用途必定执行放置可能出错的代码对应类型异常发生时处理特定类型错误块无异常发生时执行成功后的操作无论有无异常均执行资源清理释放自定义异常虽然提供了丰富的内置异常但在开发特定应用时创建自定义异常可以使代码更具可读性和针对性创建自定义异常类自定义异常类继承自当账户余额不足时引发的异常创建有意义的错误消息余额不足当前余额元尝试提取元使用自定义异常在业务逻辑中使用自定义异常在适当的条件下抛出自定义异常处理自定义异常的实际场景尝试提取超过余额的金额针对性地处理特定业务异常操作失败您需要再存入至少元可以在这里提供补救措施比如自动转入资金或提供贷款选项自定义异常命名惯例示例适用场景以结尾程序错误需纠正以结尾警告级别的问题以具体领域开头特定领域的异常异常的传播与重新抛出了解异常如何在调用栈中传播以及如何重新抛出异常对于构建稳健的错误处理系统至关重要异常传播机制当异常发生时会沿着调用栈向上查找直到找到相应的子句处理该异常如果没有处理程序程序将终止异常传播示例这里的异常会向上传播引发没有处理异常所以异常继续传播在这里捕获来自更深层次函数的异常捕获了除零错误调用最外层函数输出捕获了除零错误重新抛出异常重新抛出异常有两种方式直接使用语句不带参数使用结构表明异常的因果关系尝试处理数据记录错误并重新抛出当前异常除数不能为零直接重新抛出当前捕获的异常捕获后转换为更具体的应用级异常并保留原始错误信息数据格式不正确需要至少两个元素调用函数并处理异常尝试处理带有问题的数据数组只有一个元素会引发处理转换后的异常发生错误访问原始异常原始错误重新抛出方式语法适用场景简单重抛仅记录错误后继续传播转换异常将低级异常转换为应用级异常清除上下文隐藏原始异常不推荐使用上下文管理器上下文管理器是的一种强大机制通过语句实现自动资源管理特别适合处理需要显式打开和关闭的资源语句和资源管理文件操作最常见的上下文管理器应用场景可能发生异常的代码演示异常即使发生异常文件也会自动关闭自定义上下文管理器进入上下文时调用返回值被赋给后的变量连接到数据库在实际应用中这里会创建真正的数据库连接已连接离开上下文时调用无论是正常退出还是异常退出参数异常类型异常值异常回溯信息关闭数据库连接释放资源返回值决定异常处理表示异常已处理不再传播表示需要继续传播异常让异常继续传播实际应用场景使用自定义上下文管理器进行数据库操作使用连接数据库操作代码模拟操作失败数据插入失败捕获到异常处理数据库操作异常可能的恢复策略重试记录日志发送报警等常见上下文管理器示例自动管理的资源文件句柄线程锁忽略特定异常临时文件会话使用简化上下文管理器创建一个使用生成器函数创建的上下文管理器设置阶段获取资源文件已打开语句将控制权传递给块内的代码清理阶段释放资源文件已关闭使用自定义上下文管理器这是一个使用创建的上下文管理器示例异常处理最佳实践掌握异常处理的模式和反模式对于编写健壮的代码至关重要不良实践与改进不好的做法过于宽泛的异常捕获大量不同类型的操作混在一起捕获所有异常无法区分不同错误出错了无法提供有价值的错误信息无法针对性恢复好的做法精确捕获和处理异常只包含读取配置文件的代码针对性处理配置文件缺失配置文件不存在将使用默认配置针对性处理权限问题没有读取配置文件的权限可以请求提升权限或使用备用方案确保文件被关闭解析配置的代码单独放在块中处理配置格式错误配置格式错误后续操作实际开发中的异常处理策略分层异常处理示例应用请求处理底层数据访问层转换为应用层可理解的异常数据库操作转换为应用级异常访问被拒绝数据库访问被拒绝连接失败无法连接到数据库数据库错误资源清理业务逻辑层处理应用级异常应用逻辑异常用户不存在日志记录并决定是否传播获取用户数据失败可能的重试策略传播异常供上层处理接口层向用户展示友好错误返回适当的状态码用户不存在返回服务暂时不可用服务暂时不可用意外错误记录并返回通用错误未处理的错误服务器内部错误高级异常处理技术使用装饰器简化异常处理一个用于自动重试的装饰器参数最大尝试次数重试之间的延迟秒达到最大尝试次数重新抛出异常操作失败秒后重试不会执行到这里使用重试装饰器连接到远程服务器可能会失败模拟的失败率连接服务器失败连接成功调用带重试功能的函数结果连接服务器最终失败异常链与异常组引入了异常组和语法用于处理多个异常同时存在的情况特性异常组用于收集任务处理过程中的错误尝试处理任务处理任务输入值为任务处理结果为如果有错误以异常组的形式抛出处理任务过程中发生错误任务处理失败使用处理异常组处理所有除零错误除零错误这里就可以抓到的异常处理所有类型错误类型错误这里就可以抓到的异常处理其他所有错误其他错误编程风格通常推崇而非风格先检查后操作风格先操作后处理异常第十三章高级数据处理提供了多种处理不同类型数据的工具和库能够轻松处理结构化和非结构化数据本章将深入探讨中常用的数据格式处理技术包括和配置文件等处理是一种轻量级的数据交换格式易于人阅读和编写也易于机器解析和生成通过内置的模块提供了的序列化和反序列化功能方法描述将对象编码为格式并写入文件将对象编码为格式并返回字符串从文件读取数据并解码为对象将字符串解码为对象基本操作对象转张三数据分析机器学习数据分析转换为字符串写入文件从字符串解析张三从文件读取重要参数说明参数说明用法示例是否转义非字符时保留原始字符缩进格式美化输出指定分隔符用于紧凑输出是否按键排序指定序列化函数处理不可序列化对象自定义对象序列化的模块默认无法直接序列化自定义类对象但提供了多种方式解决方法一提供参数将对象转换为字典示例使用参数序列化自定义对象李四李四方法二通过自定义编码器自定义编码器处理类示例使用自定义编码器序列化对象李四方法三添加方法返回可序列化的字典示例使用对象的方法序列化小明小红小明小红解码为自定义对象使用的参数将字符串直接转换为自定义对象的用途自动将解析出的字典转换为自定义类的实例在解析时进行数据转换和验证简化从到对象模型的映射过程避免手动创建对象的繁琐步骤工作原理首先将字符串解析为字典然后对每个解析出的字典调用函数函数返回的对象将替代原始字典实际应用场景响应数据转换为应用程序对象模型配置文件解析为配置对象数据导入时的格式转换处理复杂数据处理嵌套结构张三技术李四市场营销策划北京上海广州深圳访问嵌套数据张三广州修改嵌套数据成都保存修改后的数据性能优化处理大型文件时可以使用流式解析来提高性能需安装流式解析大型文件只提取特定字段处理一项后继续不必载入整个文件验证验证数据是否符合预期格式需安装定义验证数据张三李四有效数据验证失败有效数据验证失败会因小于而失败处理是一种常见的表格数据格式的模块提供了读写文件的功能适用于处理电子表格和数据库导出数据在我们写入中文数据时尽量将编码更换为否则写入会导致一些乱码问题基本读写操作写入文件姓名年龄城市张三北京李四上海王五广州一次写入多行逐行写入一次写入一行读取文件使用字典处理文件使用字典写入姓名张三年龄城市北京姓名李四年龄城市上海姓名王五年龄城市广州姓名年龄城市写入表头写入多行数据使用字典读取姓名年龄岁来自城市方言与格式化选项自定义方言使用制表符作为分隔符引号字符转义字符不使用双引号转义最小引用策略使用自定义方言常见格式化选项分隔符引号字符为非数值字段添加引号转义字符行终止符处理特殊情况处理含有引号和逗号的数据产品描述价格笔记本高配处理器手机屏幕双卡双待所有字段加引号跳过特定行跳过表头处理缺失值将空字符串转换为文件的高级操作过滤行筛选年龄大于的记录年龄计算统计值计算平均分分数平均分合并多个文件获取所有匹配的文件假设所有文件结构相同第一个文件保留表头跳过后续文件的表头使用示例处理是一种用于存储和传输数据的标记语言提供多种处理的方法最常用的是模块创建和写入创建根元素添加子元素添加多个项目设置属性第项设置文本内容添加嵌套元素项目的详情创建用户信息部分添加用户张三北京李四上海生成字符串写入文件解析和读取从文件解析从字符串解析测试获取元素标签和属性根元素标签遍历子元素子元素属性查找特定元素查找第一个匹配元素使用查找所有匹配的子元素项目内容获取嵌套元素详情使用查询查找所有用户名称用户年龄城市更复杂的查询查找北京的用户北京北京用户修改修改元素属性张三添加新属性修改子元素文本修改年龄添加新元素删除元素李四保存修改命名空间处理创建带命名空间的添加带命名空间前缀的元素带命名空间的元素生成字符串解析带命名空间的使用带命名空间的查询找到命名空间元素类型属性配置文件处理配置文件是应用程序保存设置和首选项的常用方式提供了多种处理不同格式配置文件的方法配置文件处理文件是一种结构简单的配置文件格式通过模块提供支持是标准库中用于处理配置文件的模块它可以读取写入和修改类似格式的配置文件配置文件通常包含节如和每个节下的键值对如中文默认创建一个新的配置解析器添加默认节和配置项中文默认添加应用设置节应用设置应用设置添加用户信息节用户信息用户信息创建一个引用方便添加多个配置项张三修改为标准布尔值字符串添加数据库连接节数据库数据库数据库数据库数据库将配置写入文件读取配置文件获取所有节名称所有配置节应用设置用户信息数据库获取节中的所有键用户信息节中的所有键用户信息获取特定配置值用户名用户信息张三获取默认节中的值默认语言应用设置使用中的值类型转换方法应用设置将转换为字体大小类型字体大小类型自动保存类型自动保存类型修改配置用户信息李四添加新配置日志设置日志设置日志设置日志设置日志设置保存修改后的配置配置文件处理是一种人类友好的数据序列化格式需要安装库需要安装创建数据张三李四写入文件读取文件访问配置服务器地址第一个用户张三修改配置王五保存修改使用环境变量作为配置环境变量是一种灵活的配置方式尤其适用于容器化应用需安装从文件加载环境变量默认加载当前目录下的文件读取环境变量提供默认值数据库调试模式端口创建文件示例数据库设置应用设置作为配置文件也是一种常用的配置文件格式尤其适合需要与应用共享配置的场景默认配置配置文件路径加载配置如果配置文件存在则加载它否则使用默认配置并创建配置文件保存配置更新配置处理嵌套键如使用示例应用名称数据库主机更新配置重新加载配置更新后的数据库主机更新后的缓存正则表达式正则表达式通常缩写为或是一种强大的文本处理工具它使用一种专门的语法来定义搜索模式然后可以用这个模式在文本中进行查找匹配提取或替换操作正则表达式在各种编程任务中都极为有用例如数据验证检查用户输入是否符合特定格式如邮箱手机号日期数据提取从大量非结构化文本如日志文件网页内容中精确地抽取所需信息如地址错误代码特定标签内容文本替换对文本进行复杂的查找和替换操作例如格式化代码屏蔽敏感信息文本分割根据复杂的模式分割字符串通过内置的模块提供了对正则表达式的全面支持核心概念正则表达式的核心在于使用元字符和普通字符组合来定义模式元字符是具有特殊含义的字符而普通字符则匹配它们自身常用元字符和语法以下是一些最常用的正则表达式元字符及其含义元字符描述示例模式示例匹配匹配除换行符之外的任何单个字符使用标志可匹配换行符但不匹配匹配字符串的开头在多行模式下也匹配每行的开头但不匹配匹配字符串的结尾在多行模式下也匹配每行的结尾但不匹配匹配前面的元素零次或多次贪婪模式匹配前面的元素一次或多次贪婪模式但不匹配匹配前面的元素零次或一次贪婪模式也用于将贪婪量词变为非贪婪见后文匹配前面的元素恰好次但不匹配或匹配前面的元素至少次贪婪模式匹配前面的元素至少次但不超过次贪婪模式但不匹配或字符集匹配方括号中包含的任意一个字符或或否定字符集匹配不在方括号中包含的任何字符任何非数字字符转义符用于转义元字符使其匹配其字面含义如匹配句点或用于引入特殊序列如字符本身或运算符匹配左边或右边的表达式分组将括号内的表达式视为一个整体用于应用量词限制的范围或捕获匹配的子字符串踩坑提示转义当需要匹配元字符本身时如必须在前面加上反斜杠进行转义例如要匹配地址中的点应使用原始字符串在中定义正则表达式模式时强烈建议使用原始字符串在字符串前加如这可以避免解释器对反斜杠进行自身的转义从而简化正则表达式的书写尤其是包含很多的模式特殊序列预定义字符集模块提供了一些方便的特殊序列来代表常见的字符集特殊序列描述等价于示例匹配任何数字字符包括和其他语言的数字匹配任何非数字字符匹配任何空白字符包括等匹配任何非空白字符匹配任何词语字符字母数字和下划线匹配任何非词语字符匹配词语边界这是一个零宽度断言匹配词语字符和非词语字符之间或词语字符和字符串开头结尾之间的位置匹配非词语边界贪婪模式非贪婪模式默认情况下量词都是贪婪的它们会尽可能多地匹配字符场景从标签中提取贪婪模式默认匹配任何字符匹配零次或多次会一直匹配到字符串的最后一个贪婪匹配结果输出贪婪匹配结果非贪婪模式在量词后加匹配零次或多次但尽可能少地匹配遇到第一个就停止匹配非贪婪匹配结果输出非贪婪匹配结果查找所有非贪婪匹配所有非贪婪匹配输出所有非贪婪匹配何时使用非贪婪模式当需要匹配从某个开始标记到最近的结束标记之间的内容时通常需要使用非贪婪量词分组与捕获使用圆括号可以将模式的一部分组合起来形成一个分组分组有几个重要作用应用量词将量词作用于整个分组如匹配等限制范围如匹配或捕获内容默认情况下每个分组会捕获其匹配到的子字符串以便后续引用或提取场景从中提取姓名和年龄定义带有捕获组的模式第一个组捕获姓名第二个组捕获年龄使用查找所有匹配项返回一个列表如果模式中有捕获组列表元素是包含所有捕获组内容的元组使用提取分组输出使用获取对象可以更灵活地访问分组使用访问分组或获取整个匹配整个匹配获取第一个捕获组的内容姓名姓名组获取第二个捕获组的内容年龄年龄组获取所有捕获组组成的元组所有分组非捕获组如果只想分组而不捕获内容可以使用非捕获组第一个组不捕获使用非捕获组的输出只包含捕获组的内容反向引用可以在模式内部或替换字符串中使用来引用前面捕获组匹配到的文本场景查找重复的单词如确保是完整的单词捕获第一个单词匹配中间的空白引用第一个捕获组匹配的内容查找重复单词找到的重复单词输出使用进行替换将重复的单词替换为单个单词使用引用捕获组修正后的文本输出模块核心函数的模块提供了以下核心函数来执行正则表达式操作函数描述返回值主要用途从字符串的开头尝试匹配模式匹配成功返回对象失败返回验证字符串是否以特定模式开始在整个字符串中搜索模式的第一个匹配项匹配成功返回对象失败返回在字符串中查找模式是否存在并获取第一个匹配项的信息在字符串中查找模式的所有非重叠匹配项返回一个列表如果模式无捕获组列表元素是匹配的字符串如果有捕获组列表元素是包含各捕获组内容的元组提取字符串中所有符合模式的子串或捕获组内容与类似但返回一个迭代器迭代器中的每个元素都是一个对象返回一个迭代器每个元素是对象处理大量匹配结果时更内存高效因为不需要一次性存储所有结果可以方便地访问每个匹配的详细信息如位置在字符串中查找模式的所有匹配项并用替换它们可以是字符串支持或等反向引用或函数指定最大替换次数返回替换后的新字符串执行查找和替换操作可以是函数实现更复杂的替换逻辑使用模式作为分隔符来分割字符串指定最大分割次数返回一个列表包含分割后的子字符串如果模式中有捕获组捕获的内容也会包含在列表中根据复杂的模式分割字符串编译正则表达式模式为一个模式对象返回一个对象当一个模式需要被多次使用时预先编译可以提高性能模式对象拥有与模块函数同名的方法如代码示例检查开头字符串以开头匹配内容字符串不以开头不从开头匹配所以失败失败示例查找第一个匹配找到单词起始位置结束位置未找到单词查找所有匹配查找所有数字序列找到的所有数字序列查找邮箱并捕获用户名和域名捕获组迭代查找匹配对象查找所有包含字母的单词查找包含的单词使用标志找到替换将电话号码替换为替换电话号码使用函数进行替换用户名只显示第一个字符使用函数替换邮箱分割按标点符号和后面的空格分割按标点分割编译模式编译查找以开头结尾的词多次使用编译后的模式找到找到对象详解当或中的一项成功匹配时它们会返回一个对象这个对象包含了关于匹配结果的详细信息对象方法属性描述示例假设或返回整个匹配的字符串返回第个捕获组匹配的字符串从开始计数返回返回返回一个包含所有捕获组匹配内容的元组如果模式中使用了命名捕获组返回一个包含组名和匹配内容的字典需要命名组如下例返回整个匹配或指定的起始索引包含返回返回返回返回整个匹配或指定的结束索引不包含返回返回返回返回一个包含索引的元组返回返回传递给或的原始字符串匹配时使用的已编译的模式对象命名捕获组示例使用定义命名捕获组使用命名捕获组通过组名访问捕获的内容产品数量返回包含所有命名组的字典捕获字典正则表达式标志标志可以修改正则表达式的匹配行为可以在函数的参数中指定或在编译时指定多个标志可以使用按位或组合标志简写描述进行不区分大小写的匹配使和匹配每行的开头和结尾而不仅仅是整个字符串的开头和结尾使元字符能够匹配包括换行符在内的任何字符详细模式允许在模式字符串中添加空白和注释以提高可读性此时模式中的空白会被忽略后到行尾的内容视为注释使只匹配字符而不是完整的字符集默认匹配默认使匹配完整的字符集这是的默认行为示例忽略大小写示例多行模式匹配成功匹配失败一个复杂的邮箱模式使用模式添加注释和空格匹配字符串开头用户名部分字母数字下划线点连字符符号域名部分允许子域名如顶级域名如匹配字符串结尾匹配成功匹配失败匹配成功实际应用场景示例场景验证中国大陆手机号简单示例简单验证中国大陆手机号码位数字常见号段模式解释匹配字符串开头非捕获组第一位是第二位是到后面跟位数字匹配字符串结尾手机号验证号段不对位数不够位数太多注意实际手机号验证可能需要更复杂的规则或查询号段数据库场景从日志中提取地址和请求路径模式解释捕获开头的地址数字和点的组合匹配中间的部分匹配并忽略方括号内的时间戳非贪婪匹配时间戳后的空格和双引号捕获请求方法等和空格捕获请求路径非空格非双引号的字符捕获版本部分匹配剩余部分日志解析地址请求方法请求路径日志格式不匹配场景将样式的链接转换为标签这是一个链接和另一个官网的例子模式解释匹配字面量捕获链接文本不是的任意字符一次或多次匹配字面量匹配字面量捕获不是的任意字符一次或多次匹配字面量使用和反向引用进行替换转链接原始转换后输出这是一个链接和另一个官网的例子第十四章深入解析并发编程并发编程基本概念并发编程是指程序设计中允许多个任务同时执行的编程模式它的核心目标是提升执行效率通过并发编程原本需要分钟执行的代码可能只需要分钟就能完成进程调度机制解析在执行程序时会涉及进程调度主要有两种切换情况操作触发切换当程序遇到操作时操作系统会剥夺该程序对的执行权限时间片用尽触发切换当一个程序长时间占用时操作系统也会剥夺程序对的执行权限所谓操作指的为阻断程序的操作类似于函数会将程序暂停运行达到某一个条件后才会接触阻塞状态时间片即分配给各个程序的时间每个线程被分配一个时间段称作它的时间片即该进程允许运行的时间使各个程序从表面上看是同时进行的如果在时间片结束时进程还在运行则将被剥夺并分配给另一个进程如果进程在时间片结束前阻塞或结束则当即进行切换而不会造成资源浪费在宏观上我们可以同时打开多个应用程序每个程序并行不悖同时运行但在微观上由于只有一个一次只能处理程序要求的一部分如何处理公平一种方法就是引入时间片每个程序轮流执行进程的三大状态与生命周期进程在其生命周期中会经历三种基本状态首先一个程序想要被运行当用户双击图标后此时程序就会从硬盘加载到内存所有的程序想要被执行就必须经历就绪态然后等待执行就绪态之后会进入进程调度然后运行运行时会出现以下几种情况时间片运行完毕程序也执行完毕释放资源后退出程序运行过程遇到操作读写发送网络请求它是不需要工作的只要运行遇到了操作系统就会把拿走执行其他的时间片程序就会进入阻塞态当请求完成后它就会结束阻塞态回到就绪态里排队同步与异步编程模型同步和异步同步任务提交之后原地等待任务的返回结果等待的过程中不做任何事情异步任务提交之后不再等待任务的返回结果而是去做一些其他的事情这两个概念主要描述任务的提交方式实际应用在开发中同步请求会阻塞页面渲染而异步请求则可以在后台处理数据不影响用户体验阻塞和非阻塞这两个概念主要描述进程的运行状态阻塞对应进程的阻塞态非阻塞对应进程的就绪态运行态结合同步异步和阻塞非阻塞可以形成四种组合同步阻塞同步非阻塞异步阻塞异步非阻塞利用率最高的一种模式在实际开发中异步非阻塞模式是高并发系统的首选模式因为它允许程序在等待操作时继续执行其他任务多进程编程技术进程基础进程是程序在计算机中的一次执行过程程序是静态的可执行文件占用磁盘空间进程是动态的执行过程占用计算机运行资源类比一个工厂有三个车间每个车间一个工人共人并行处理任务相当于一个程序创建三个进程每个进程一个线程共人并行处理任务进程创建方法功能创建进程对象参数绑定要执行的目标函数进程名默认是整数元组用于给函数位置传参字典给函数键值传参方法一使用类创建进程创建进程的标准方法子进程执行过程中触发的函数子进程父进程子进程正在执行参数模拟耗时操作子进程执行完毕密集型任务进程计算完成结果为父进程创建多个进程体现并行处理能力创建四个检测执行不同人物张三李四将进程添加到列表中启动进程等待所有进程结束所有进程执行完毕总耗时秒如果使用单进程顺序执行耗时会更长因为是两个任务在执行多进程可以充分利用多核并行处理任务重要提示在系统中必须在条件下创建进程这是因为使用方式创建进程会重新导入模块可能导致递归创建进程方法二继承类创建进程通过继承类创建进程继承类的自定义进程重写方法进程启动后会执行该方法子进程父进程子进程正在执行参数模拟耗时操作子进程执行完毕密集型任务进程重写方法执行密集型计算进程计算完成结果为父进程创建多个进程体现并行处理能力创建四个进程实例张三李四将进程添加到列表中启动进程等待所有进程结束所有进程执行完毕总耗时秒多进程常用方法表方法名说明实际应用场景创建进程对象指定新进程要执行的函数启动进程开始执行进程的任务等待进程结束协调多个进程的执行顺序检查进程是否存活监控进程状态强制终止进程中断异常或超时的进程创建进程安全的队列进程间数据传递添加元素到队列向队列中放入数据从队列获取元素从队列获取数据创建管道对象进程间双向通信进程号与进程信息获取在多进程编程中获取进程信息对于调试和管理至关重要的模块提供了方法来获取当前进程的信息打印当前进程的信息获取当前进程对象进程名称进程父进程进程授权键进程是否活跃自定义进程名进程间通信示例子进程执行的函数子进程函数想往父进程发送消息就往这个队列里放子进程启动向队列中添加数据我是一个队列数据模拟任务执行子进程结束父进程创建队列创建一个子进程对象启动子进程主进程从队列中获取数据主进程等待子进程数据阻塞等待数据主进程收到来自于子进程的消息等待子进程结束主进程结束复杂进程通信示例子进程执行的函数带有共享资源的工作函数队列锁值数组休眠时间获取进程进程开始执行使用锁来保证数据安全相当于和的组合安全的修改数组元素进程修改数组元素为向队列中添加数据这是一条来自于进程的信息休眠模拟工作进程执行完毕解释输出逻辑创建了个进程它们共享同一个数组初始值为每个进程获取锁后会将数组中的每个元素进行平方操作由于进程是按顺序启动的但执行顺序不确定所以第一个获得锁的进程将平方为第二个获得锁的进程将平方为第三个获得锁的进程将平方为第四个获得锁的进程将平方但由于整数溢出导致最后两个元素变成了和负数进程完成的顺序取决于参数所以最先完成的是第一个进程创建队列创建锁创建一个共享值表示类型创建一个共享数组创建多个子进程进程池详解进程池是一种管理多个进程的方式可以简化并行计算的编程的模块中的类和模块的类都提供了进程池功能进程池的主要方法方法描述使用场景创建进程池进程数默认为核数初始化进程池阻塞执行任务需要顺序执行且等待结果的场景非阻塞执行任务需要异步执行的场景并行执行映射任务对列表元素并行处理关闭进程池不再接受新任务完成任务提交后立即终止所有工作进程需要强制停止时等待所有工作进程退出在后使用示例进程池工作函数进程岁我的父进程是我结束进程了方法提交任务到进程池返回一个对象参数这里的作为函数的第二个参数传入小明等待对象返回结果对象示例工作进程函数进程岁我的父进程是我结束进程了准备参数列表张三号方法将函数应用于参数列表并返回结果列表的工作原理它接收两个参数要执行的函数和可迭代的参数列表它会自动将参数列表中的每个元素分配给不同的进程来执行每个进程会调用并传入中的一个元素作为参数所有进程执行完毕后会收集所有进程的返回值并按原始参数的顺序返回结果列表这样实现了并行处理提高了计算效率打印每个进程的返回结果进程号与进程信息获取在多进程编程中获取进程信息对于调试和管理至关重要的模块提供了方法来获取当前进程的信息打印当前进程的信息获取当前进程对象进程名称进程父进程进程授权键授权键用于在进程间通信时进行身份验证进程是否活跃自定义进程名进程状态特殊情况僵尸进程子进程死后还会有一些资源占用进程号进程的运行状态运行时间等待父进程通过系统调用进行资源回收相当于子进程死了之后需要父进程来给他收尸除了进程之外所有的进程最后都会步入僵尸进程在一种情况下是会带来危害的子进程退出之后父进程没有及时处理僵尸进程就会一直占用资源如果产生了大量僵尸进程资源过度使用系统没有可用的进程号导致系统不能产生新的进程注意在中子进程退出后会立即被系统回收不会产生真正的僵尸进程在系统中不需要显式调用来回收子进程资源孤儿进程子进程处于存活状态父进程意外死亡操作系统就会开设一个孤儿院进程用来管理孤儿进程回收孤儿进程相关资源知识点操作系统会自动处理孤儿进程将它们的父进程更改为进程为所以孤儿进程不会造成资源泄漏问题多线程编程深入解析线程基础线程是轻量级的进程也是多任务编程的一种方式一个进程中可以包含多个线程线程也是一个运行行为消耗计算机资源一个进程中的所有线程共享这个进程的资源线程的创建和销毁消耗资源远小于进程一个工厂至少有一个车间一个车间中至少有一个工人工人去利用车间的设备工作一个程序至少有一个进程一个进程中至少有一个线程线程去利用进程的资源工作线程创建方法方法一使用类创建线程线程开始工作线程结束工作线程线程启动线程等待线程结束主线程结束方法二继承类创建线程线程开始执行线程执行完毕消息线程子进程操作完毕线程子进程操作完毕主进程执行完毕线程常用方法表方法名说明实际应用场景启动线程开始执行线程任务定义线程执行的任务重写该方法自定义线程行为等待线程结束协调线程执行顺序等待线程结束有超时时间防止无限等待检查线程是否活动监控线程状态获取线程名称调试和日志记录设置线程名称便于识别不同线程设置为守护线程随主线程结束而结束的后台任务检查是否为守护线程确认线程类型获取线程唯一标识线程获取当前线程对象在函数中获取当前执行线程线程使用实例基本线程示例访问网站下载文件读取长度为单线程下载所有网站多线程下载网站多线程下载所有网站等待所有线程结束准备一些网站用于演示单线程下载单线程下载开始单线程下载结束耗时秒多线程下载开始多线程下载结束耗时秒密集型任务如网络请求适合使用多线程可以显著提高性能这是因为当一个线程等待操作完成时其他线程可以继续执行守护线程示例线程启动线程结束设置为守护线程主线程结束时线程也会结束已经被废弃的现在使用参数代替启动普通线程启动守护线程这里需要启动线程否则不会执行等待普通线程完成等待线程完成检测线程状态线程是否存活线程是否存活线程是否存活主线程休眠一段时间以便守护线程有机会执行主线程结束守护线程特性守护线程会随着主线程的结束而结束不管它是否执行完成适用于需要在后台运行但不要求必须完成的任务如监控日志记录等守护线程系统资源监控器持续监控使用率和内存使用情况并记录到日志中系统监控守护线程启动使用率内存使用率系统资源占用过高请及时处理系统监控线程异常系统监控守护线程结束创建并启动系统监控守护线程主线程继续执行一段时间守护线程在后台运行主线程运行中监控守护线程在后台运行运行秒后结束主线程结束守护线程将自动终止监控守护线程是否存活主线程结束守护线程将自动终止线程池详解线程池是一种管理线程资源的方式它预先创建一定数量的线程然后复用这些线程来执行任务避免了频繁创建和销毁线程的开销定义一个耗时函数使用方法提交任务给线程池执行返回对象列表任务已提交主线程继续执行等待所有任务完成并获取结果任务执行完毕结果为总共耗时秒线程池在语句结束时自动关闭主要方法方法名简洁解释适用场景异步执行函数返回对象单独提交任务并获取结果对每个输入并行执行函数批量处理类似任务关闭执行器资源释放获取任务执行结果获取异步任务的返回值添加任务完成回调函数任务完成后的后续处理返回已完成任务的迭代器先处理先完成的任务等待任务完成任务同步点深入理解线程池最大的好处是控制并发数量防止系统资源被耗尽在实际开发中建议将线程数设置为核心数的倍具体取决于任务是密集型还是密集型完整示例耗时任务不同的值耗时不同任务完成后触发的回调函数任务完成结果为方法示例提交任务完成等待结果获取任务执行结果会阻塞直到所有任务完成返回已完成任务的迭代器任务完成总耗时秒方法示例对每一个输入并行执行函数返回结果迭代器与不同会自动收集结果并按输入顺序返回不需要手动调用任务提交完成直接获取有序结果转换为列表时会按照输入顺序返回结果如果任务未完成会在这里阻塞等待结果总耗时秒示例添加任务完成回调函数添加回调函数任务完成后自动调用已添加回调函数主线程继续执行等待所有任务完成耗时秒适用场景任务完成后的后续处理适合需要在任务完成时执行额外操作而不阻塞主线程示例等待任务完成任务已提交等待所有任务完成等待所有任务完成完成的任务数未完成的任务数所有任务执行完毕结果为耗时秒适用场景任务同步点适合需要等待一组任务全部或部分完成后再继续执行的情况事件同步机制是一种线程同步机制用于协调多个线程的执行顺序它本质上是一个内部的标志位线程可以等待这个标志位被设置也可以设置或清除这个标志位创建一个事件对象模拟公交车到站的函数模拟公交车到站过程公交车即将到站模拟行驶时间公交车已到站设置事件通知等待的乘客发射信号让等车的人上车模拟乘客等车乘客名称等待公交车到站等车中阻塞等待信号出发创建公交车线程创建多个乘客线程乘客模拟乘客陆续到站主要方法方法名描述使用场景设置事件标志为通知等待的线程继续执行清除事件标志为重置事件状态使线程再次等待检查事件状态判断事件是否已被设置等待事件被设置阻塞线程直到事件被设置或超时应用场景适合实现一次性通知多个线程的场景比如多个工作线程等待初始化完成多个消费者等待数据准备就绪等在开发中可用于协调多个后台任务的启动时机定时器定时器是线程的一个特殊应用用于在指定时间后执行某个操作的模块提供了类来实现这一功能延迟执行的问候函数要问候的对象名称说哈哈我是延迟秒后才执行的创建一个定时器秒后执行函数参数为小明小明启动定时器定时器已启动但函数还未执行主线程继续执行不会被阻塞实用技巧可用于实现超时处理延迟重试定时清理等场景例如在网络编程中可以用设置请求超时机制在数据同步中可以用定期执行同步任务多进程多线程性能分析在中由于全局解释器锁的存在多线程并不能真正实现并行计算因此根据任务特性选择合适的并发模型十分重要不同场景的最优选择任务类型多进程多线程推荐选择计算密集型效率高可利用多核受限制效率相对较低多进程密集型资源占用大资源占用小效率与多进程相当多线程实际应用建议现代开发中约以上的程序属于密集型适合使用多线程对于数据分析图像处理等计算密集型任务则推荐使用多进程也可以考虑混合使用多进程下每个进程内再使用多线程计算密集型任务测试计算密集型任务对比测试计算密集型任务执行大量计算使用多进程或多线程取消相应的注释来测试多进程结果大概是秒多线程结果大概是秒花费时间密集型任务测试密集型任务对比测试密集型任务使用模拟操作模拟等待创建个任务使用多进程或多线程取消相应的注释来测试多进程结果约秒多线程结果约秒花费时间性能陷阱多线程在密集型任务中表现出色但过多的线程可能导致线程切换开销增大反而降低效率经验值是控制线程数为核心数的倍协程技术详解协程基础概念协程也称为微线程是一种用户态内的上下文切换技术可以在单线程下实现并发效果协程通过巧妙的编程技巧实现了程序主动让出和恢复执行的能力使得单线程内可以模拟出并发的效果进程资源单位系统分配资源的基本单位拥有独立的内存空间线程执行单位调度和执行的最小单位共享所属进程的内存空间协程根本不存在它是程序员人为创造出来的切换保存状态当程序遇到的时候通过我们的代码让我们的程序自动完成切换也就是通过代码监听一旦程序遇到就在代码层面自动切换给的感觉就是我们的程序没有换句话说也就是我们欺骗了协程的核心原理是切换保存状态即在多个任务之间来回切换每次切换都保存当前任务的执行状态下次切换回来继续执行在中可以通过关键字模块或库实现协程深入理解协程不是提升计算效率而是提升效率在密集型应用中协程可以让在等待的同时执行其他任务从而提高资源利用率协程的切换不需要操作系统参与开销远小于线程切换概念资源占用切换开销实现方式适用场景进程高独立内存空间高涉及内存映射操作系统调度密集型需要隔离的任务线程中共享内存但有独立栈中上下文切换操作系统调度混合型任务兼顾计算与协程低共享线程内全部资源低用户态切换程序自行控制密集型高并发网络应用协程效率对比对于计算密集型任务时使用协程反而会降低效率串行执行计算密集型函数执行简单累加计算计算密集型函数执行简单累加计算顺序执行然后执行保留两位小数串行执行总共用时秒串行执行总共用时秒使用实现协程切换带的计算密集型函数主动让出执行权保存当前执行状态使用的生成器进行交替执行创建生成器对象切换到执行一步会执行到下一个后暂停执行内部会与交替执行保留两位小数协程用时秒约秒注意事项对于计算密集型任务协程切换反而会增加开销降低效率但对于密集型任务协程切换可以显著提高效率这是因为在等待期间协程可以切换到其他任务继续执行避免了空闲模块了解是一个轻量级的协程库提供了基本的协程实现它允许在不使用回调函数的情况下在不同函数间来回切换执行实现了所谓的确定性切换协程函数函数正在运行模拟某些操作主动切换到函数执行协程函数函数正在运行模拟某些操作切换回函数执行创建两个对象将函数封装为对象将函数封装为对象从函数开始执行启动协程核心方法与属性方法属性名描述使用场景示例获取当前正在执行的对象在函数内获取当前协程将控制权切换到另一个协程间的主动切换传递参数获取当前的父协程层级管理向对象中抛出异常协程异常处理错误信息判断是否已经执行完毕协程状态检查已执行完毕获取当前的帧对象调试和检查协程状态绑定到的可调用对象查看协程的目标函数使用技巧适合实现简单的协程切换但不支持自动在操作时切换因此常与事件循环结合使用如库的优势在于它的轻量和灵活性可以构建复杂的协程调度系统模块了解是基于的协程库增加了事件循环和自动切换功能它通过猴子补丁将标准库中的阻塞操作替换为非阻塞版本使普通的同步代码能够以异步方式执行是一个基于协程的网络库它使用在或等事件循环之上提供高级同步实现了标准库里面大部分的阻塞式系统调用包括和等模块可以使用猴子补丁将这些阻塞式调用变为协作式运行猴子补丁的功能很强大但是也带来了很多的风险尤其是像这种直接进行替换的补丁整个进程所使用的模块都会被替换可能自己的代码能住但是其它第三方库有时候问题并不好排查即使排查出来也是很棘手所以就像松本建议的那样如果要使用猴子补丁那么只是做功能追加尽量避免大规模的覆盖虽然猴子补丁仍然是邪恶的但在这种情况下它是有用的邪恶基础操作应用猴子补丁将标准库的阻塞操作替换为非阻塞版本必须在导入其他模块前调用确保所有操作都被替换替换所有可能的阻塞调用协程函数模拟操作主动让出控制权协程函数模拟操作主动让出控制权协程函数模拟操作主动让出控制权创建三个协程创建协程但不立即执行创建协程但不立即执行创建协程但不立即执行等待所有协程完成类似于多线程中的方法常用详解方法类名描述使用场景实际应用示例创建并运行协程启动异步任务启动多个请求并行处理等待多个协程完成同步点等待所有任务完成批量处理多个数据源协程休眠并让出控制权模拟操作主动让出控制权测试协程调度防止密集任务阻塞等待对象协程完成等待部分任务完成等待最快完成的结果终止协程取消不需要的任务实现任务超时取消应用猴子补丁将同步库变为异步兼容使用前替换标准库函数协程安全的队列协程间通信和数据传递生产者消费者模式实现事件通知机制协程间同步和通知完成信号传递协程池限制并发数量控制网络请求并发数多路复用监控多个文件描述符自定义事件循环使用注意事项所有协程运行在同一线程中不能跨线程同步数据是协程安全的可以用于协程间通信不能有长时间阻塞的密集型操作会阻塞整个事件循环最好使用自身的非阻塞库或已打补丁的标准库猴子补丁会修改全局状态可能影响第三方库的行为应在所有导入前应用调试协程比调试线程更困难错误追踪可能会更复杂实际应用场景示例替换标准库获取内容的函数要获取的网址响应状态码内容长度开始请求进行请求操作会自动切换完成请求耗时秒请求出错要获取的列表创建协程任务等待所有任务完成获取结果打印结果结果汇总状态码内容长度字节总耗时秒与的区别与选择特性实际应用建议基本原理轻量级上下文切换基于增加事件循环简单任务用复杂系统用处理不提供操作支持提供自动切换机制网络应用选择自定义调度选择切换方式需要显式调用在操作时自动切换手动控制流程用自动化处理用复杂度简单仅提供基本切换复杂提供完整生态系统小型项目用大型项目用适用场景简单协程调度高并发网络应用爬虫服务代理服务器首选性能轻量开销小比略重但实用性强极致性能用平衡性能和开发效率用学习曲线简单容易理解较复杂概念较多入门协程从开始再过渡到社区支持基础库更新较少活跃有完整生态长期项目建议使用选择建议如果只需要轻量级的上下文切换可以使用如果需要处理密集型应用特别是网络编程建议使用大多数实际项目中是更好的选择因为它提供了更完整的功能和自动化的处理协程技术随着的发展协程技术已经有了显著进步从引入的库开始对协程的原生支持不断增强到年已经拥有更成熟更高效的协程生态系统与原生协程引入的语法使得协程编程变得更加直观和强大这是目前最推荐的协程实现方式模拟从网络获取数据的异步函数开始获取数据延迟秒成功获取数据长度数据异步操作的主函数程序开始时间串行执行示例串行执行请求两个数据串行执行结果程序结束时间程序耗时秒并行执行请求两个数据并行执行示例批量等待所有任务完成并行执行结果程序结束时间程序耗时秒在中可以直接使用运行主协程常用方法函数描述使用场景示例运行协程程序入口点创建任务并行执行协程并行运行多个协程批量并发任务带超时的等待实现超时控制非阻塞睡眠模拟延迟协程安全的队列协程间数据传递低级异步原语自定义异步操作防止取消传播保护关键协程按完成顺序返回结果处理最先完成的任务对象是中用于封装协程的对象可以用于并发执行多个任务可以通过对象等待协程完成进入模拟操作离开创建任务等待任务完成返回值对象是的基类表示一个未完成的结果在底层异步操作中常常用来表示某些未决的操作结果定义一个异步函数用于设置的结果异步等待秒模拟耗时操作设置的结果为定义主异步函数获取当前正在运行的事件循环创建对象它代表一个尚未完成的异步操作创建对象创建一个任务来执行函数不等待其完成立即返回等待完成并获取其结果等待完成打印的结果的结果运行主异步函数异步上下文管理器异步上下文管理器允许在进入和退出时执行异步操作常用于异步资源管理资源获取资源释放执行任务中锁与并发性能全局解释器锁是解释器的一个特性它确保同一时刻只有一个线程可以执行字节码这个特性对多线程编程有着深远影响也是导致速度慢的两大原因之一其另外一个原因是因为是解释形语言但后续可通过技术实现的预编译但唯独这个原因没有解决在早期开发时为解决垃圾回收机制内部问题采用了锁所以程序无法直接利用多核的优势全局解释器锁是特有的一个物件作用是让一个进程中同一时刻只能有一个线程可以被调用如果程序想利用计算机的多核优势让同时处理一些任务适合用多进程开发即使资源开销大如果程序不想利用计算机的多核优势适合用多线程开发的本质与工作原理本质上是一把互斥锁用于保护解释器的内部状态主要解决了对象的内存管理问题特性描述实现方式互斥锁作用对象解释器进程控制范围字节码执行释放时机操作执行固定字节码数量后影响范围仅影响不受影响深入理解并非语言本身的特性而是实现的产物它解决了简单引用计数式内存管理的线程安全问题但也限制了多线程程序利用多核性能的能力工作示意伪代码获取锁执行一定数量的字节码释放锁以允许其他线程运行等待再次获取这也就导致了每一个线程都需要在执行获取字节码时都要经历拿锁解锁的过程并发与并行的区别并发和并行是两个在计算机科学中经常出现的概念虽然常被混用但有着本质区别特性并发并行定义多个任务在同一时间间隔内发生多个任务在同一时刻发生重点任务切换与调度任务的同时执行资源需求可以在单处理器上通过时间片轮转实现需要多个处理器或核心执行方式任务交替执行共享处理器时间每个任务有独立的处理器同时执行适用场景密集型任务如网络请求文件读写计算密集型任务如图像处理科学计算实现难度相对简单关注任务调度相对复杂需考虑数据分割同步和合并实现多线程协程多进程关键理解由于的存在的多线程实际上只能实现并发而不能实现真正的并行要实现并行需要使用多进程或依赖不受限制的扩展库如使用扩展的线程安全与并发控制线程安全指在多线程环境下程序能够正确地处理共享资源不会因为多线程同时访问而导致数据不一致尽管的能减轻一些并发问题但并不能完全保证线程安全线程安全问题示例共享的全局变量增加计数器但使用了非原子操作的方式模拟线程安全问题读取修改写入过程中可能被中断读取当前值模拟线程在读取后被切换的情况随机休眠一个很小的时间增加线程切换的可能性在本地修改写回全局变量运行多个线程同时增加计数器理论上应该等于预期结果实际结果丢失的增量完成的迭代次数开始时间为运行个线程每个线程增加计数器次理论上最终结果应该是但由于线程安全问题实际结果会小于这个值累计用时秒使用线程锁解决安全问题共享的全局变量创建一个线程锁增加计数器使用线程锁确保线程安全使用线程锁保护临界区在锁的保护下直接修改全局变量运行多个线程同时增加计数器理论上应该等于预期结果实际结果丢失的增量完成的迭代次数开始时间为运行个线程每个线程增加计数器次使用线程锁后最终结果应该正确等于累计用时秒线程锁作用与注意事项锁确保同一时刻只有一个线程能访问共享资源锁会影响性能特别是在竞争激烈的情况下锁的粒度需要权衡粒度太细会增加锁操作开销太粗会降低并发度锁可能引发死锁问题需谨慎设计锁的获取顺序中的锁机制全面解析的模块提供了多种锁和同步原语用于不同并发控制场景深入理解这些锁的特性和适用场景对于开发可靠的并发程序至关重要锁类型及其特性锁类型描述独占性可重入性公平性注意事项基本互斥锁是否非公平最简单的锁同一线程不能重复获取可重入锁是是非公平同一线程可多次获取必须对应释放相同次数条件变量非公平基于锁实现提供机制信号量否非公平限制资源访问线程数量有界信号量否非公平限制资源数量防止过度释放事件对象用于线程间通知而非资源控制栅栏对象使多个线程同步到达某点再继续线程安全队列先进先出内部带锁用于线程间数据传递进程锁是否非公平用于进程间同步的锁异步锁是否用于协程间的同步互斥锁互斥锁是最基本的锁类型它确保同一时刻只有一个线程可以访问受保护的资源访问共享资源的函数线程用于标识不同线程尝试获取锁添加超时参数防止无限等待线程获取锁读取修改写入操作需要原子性保护模拟处理延时增加竞争概率线程修改共享数据当前值为释放锁线程释放锁线程获取锁失败访问共享资源的函数使用语句自动释放锁简化代码线程获取锁读取修改写入操作需要原子性保护模拟处理延时增加竞争概率线程修改共享数据当前值为线程释放锁使用线程池创建多个线程等待所有线程完成最终共享数据值为方法描述参数返回值获取锁是否阻塞超时时间秒布尔值表示是否获取成功释放锁无无如果当前线程未持有锁则抛出检查锁状态无布尔值表示锁是否被某个线程持有支持语句无锁对象自身语句退出时调用异常信息无自动释放锁可重入锁可重入锁允许同一个线程多次获取该锁而不会导致自我死锁这在递归调用或者嵌套加锁场景中特别有用创建可重入锁嵌套列表数据结构递归处理数据要处理的数据项可以是列表或单个元素当前递归深度用于缩进显示获取锁创建缩进效果增强可读性增加缩进量使层次更明显打印当前处理的数据项和深度线程处理深度递归处理逻辑列表节点处理继续向下递归发现列表开始遍历子元素显示子项的索引增强结构可视化处理子项递归调用这里会再次获取同一个锁叶子节点处理递归终止条件发现元素进行处理处理结果释放锁创建多个线程访问嵌套数据每个线程处理完整的数据结构错开线程启动时间等待所有线程结束所有线程都结束了方法描述与的区别获取锁记录获取线程和次数释放锁计数器减只有为时才真正释放检查当前线程是否持有锁没有此方法使用建议一般推荐使用而非因为它更安全更灵活即使在不需要重入功能的场景下也不会有明显性能损失条件变量根据条件控制锁条件变量是一种高级的同步原语同步原语就是让多个线程能够和谐相处的机制它允许线程等待特定条件满足后再继续执行条件变量内部包含一个锁用于控制对共享状态的访问线程安全的缓冲区使用条件变量控制生产者消费者模型初始化缓冲区共享数据缓冲区最大容量创建条件变量基于生产者方法向缓冲区添加数据使用条件变量的语句自动获取和释放锁当缓冲区已满时等待消费者处理生产者缓冲区已满等待消费者等待唤醒通知自动释放锁让其他线程能访问缓冲区添加数据到缓冲区生产者添加到缓冲区当前大小通知所有等待的消费者有新数据可用消费者方法从缓冲区获取数据当缓冲区为空时等待生产者添加数据消费者缓冲区为空等待生产者从缓冲区取出数据消费者从缓冲区取出当前大小通知所有等待的生产者缓冲区有空间生产者任务生产个产品产品模拟生产时间消费者任务每个消费者消费个产品模拟消费时间消费者处理主函数创建并启动生产者和消费者线程创建共享缓冲区创建生产者和消费者线程个生产者个消费者启动所有线程等待所有线程完成所有生产和消费任务已完成方法描述参数注意事项初始化条件变量可选的或不指定则创建获取底层锁同底层锁的方法一般通过语句使用释放底层锁无一般通过语句自动释放等待条件超时时间秒调用前必须已获得锁等待直到条件为真条件函数超时时间简化循环等待模式唤醒个等待的线程要唤醒的线程数不会立即释放锁唤醒所有等待的线程无适用于广播通知使用注意调用会释放锁允许其他线程修改条件状态使用可以避免虚假唤醒问题调用后锁不会立即释放需要当前线程退出块使用而非可以避免信号丢失问题信号量控制并发数量信号量是一种计数器用于控制同时访问特定资源的线程数量常用于限制并发访问数创建信号量限制最多三个线程同时访问资源模拟优先的资源池资源资源资源跟踪资源使用情况保护资源分配的锁工作线程函数模拟使用受限资源尝试获取信号量工作线程等待获取资源等同于和中工作线程获取资源信号量检查中的每个资源如果该资源不在字典的值中则认为是可用的工作线程没有找到可用资源理论上不应该发生记录资源使用情况工作线程分配到资源当前使用情况模拟使用资源工作线程使用资源时间秒释放资源工作线程释放资源当前使用情况创建线程池并启动三个线程方法描述参数返回值初始化信号量初始计数器值无获取信号量是否阻塞超时时间布尔值表示是否获取成功释放信号量释放的数量无支持语句无信号量对象自身语句退出时调用异常信息无自动释放信号量有界信号量详解有界信号量是信号量的一个变种它会检查释放操作是否会导致计数器超过初始值如果超过则抛出异常这可以帮助检测程序中的信号量使用错误创建有界信号量初始值为演示有界信号量与普通信号量的区别获取信号量次获取信号量次获取信号量次信号量已用完再获取将阻塞释放全部信号量释放信号量次释放信号量次释放信号量次超出初始值的释放将抛出异常尝试额外释放一次这一行不会执行捕获预期异常意外错误允许无限制地调用即使计数器超过初始值在计数器超过初始值时会抛出异常生产环境推荐使用或安全的使用语句保证程序安全事件对象事件对象是最简单的线程通信机制之一它允许一个线程发送信号给其他线程适合简单的一次性通知场景创建事件对象工作线程函数等待开始信号工作线程准备完毕等待开始信号等待开始信号收到信号开始工作工作线程开始工作记录结果工作线程完成工作工作线程完成工作用时秒创建线程池等待所有线程准备完毕发送开始信号发送开始信号等待所有线程完成工作所有工作线程完成方法描述参数返回值设置事件唤醒所有等待的线程无无清除事件标志无无判断事件是否已设置无布尔值等待事件被设置超时时间如果超时返回否则返回使用场景启动信号所有线程等待统一开始停止信号通知所有线程停止工作一次性通知当某条件满足时通知等待线程栅栏对象栅栏是一种同步原语它要求固定数量的线程都到达栅栏点后才允许所有线程继续执行这对于分阶段任务的同步特别有用定义参与方数量创建栅栏对象当个线程都到达时才继续工作线程函数模拟多阶段工作工作线程工作线程开始第一阶段工作模拟第一阶段工作工作线程完成第一阶段用时秒等待其他线程等待所有线程完成第一阶段工作线程通过第一个栅栏开始第二阶段模拟第二阶段工作工作线程完成第二阶段用时秒等待其他线程等待所有线程完成第二阶段工作线程通过第二个栅栏工作全部完成工作线程检测到栅栏被破坏创建工作线程等待所有线程完成所有工作阶段已完成方法描述参数返回值初始化栅栏参与方数量所有线程到达时执行的回调等待超时无等待所有参与方到达覆盖默认超时时间线程的到达序号将栅栏重置到初始状态无无正在等待的线程会抛出将栅栏置于损坏状态无无所有等待线程会抛出参与方数量属性无整数当前等待的线程数属性无整数栅栏是否处于损坏状态属性无布尔值注意事项如果等待超时栅栏会进入损坏状态如果等待时的线程被中断栅栏也会损坏可以通过方法重新使用已损坏的栅栏线程安全队列模块提供的类是一个线程安全的队列实现通常用于线程间的数据传递和任务分发创建线程安全队列最多容纳个任务结果队列无大小限制用于通知工作线程结束的标志生产者线程产生任务任务将任务放入队列生产者添加到队列当前队列大小随机延迟添加结束标记生产者所有任务已产生设置退出标志消费者线程处理任务直到所有任务都处理完毕或有新任务到来从队列获取任务最多等待秒模拟处理任务消费者开始处理将处理结果放入结果队列结果耗时秒标记任务完成消费者完成处理队列为空且设置了退出标志时结束循环消费者队列暂时为空等待任务消费者退出创建生产者线程和消费者线程创建生产者线程创建消费者线程等待所有线程结束打印结果队列中的所有结果处理结果消费者的结果方法属性描述参数返回值特性初始化队列队列最大大小表示无限无放入元素元素是否阻塞超时时间无队列满时可能阻塞或抛出异常获取元素是否阻塞超时时间队列元素队列空时可能阻塞或抛出异常标记任务完成无无等待队列中所有任务处理完成无无返回队列大小无整数检查队列是否为空无布尔值检查队列是否已满无布尔值非阻塞版本的元素无队列满时抛出异常非阻塞版本的无队列元素队列空时抛出异常变种后进先出队列栈优先级队列元素为优先级数据元组简单的无界队列不支持和死锁问题分析与解决死锁是指两个或多个线程互相等待对方释放资源导致程序无法继续执行的情况死锁示例创建两个锁第一个任务先获取再获取任务开始尝试获取锁获取号锁任务获取到等待一会让任务有机会获取任务尝试获取尝试获取号锁但可能永远阻塞于此任务同时获取了两把锁使用两把锁保护的代码释放锁任务释放了任务释放了第二个任务先获取再获取任务开始尝试获取锁获取号锁任务获取到等待一会任务尝试获取尝试获取号锁但可能永远阻塞于此任务同时获取了两把锁使用两把锁保护的代码释放锁任务释放了任务释放了创建两个线程启动线程等待一段时间后检查是否发生死锁检查线程是否还活着线程状态活跃已结束线程状态活跃已结束检测到可能的死锁情况死锁的四个必要条件互斥条件资源不能被共享一次只能被一个线程使用请求与保持条件线程已获得资源但又提出新的资源请求不剥夺条件线程已获得的资源不能强制被剥夺循环等待条件线程之间形成头尾相接的循环等待资源关系死锁解决方案创建两个锁安全地获取两个锁使用超时机制避免死锁第一个锁第二个锁线程名称是否成功获取两个锁尝试获取第一个锁获取到第一个锁尝试获取第二个锁获取到第二个锁成功获取两个锁获取第二个锁失败释放第一个锁避免死锁获取第二个锁失败释放第一个锁并重试短暂休眠减少活锁可能性获取第一个锁失败重试短暂休眠避免忙等修复死锁的任务使用安全获取锁函数任务开始执行任务任务同时持有两把锁执行关键代码模拟工作释放锁任务释放任务释放任务无法获取所需的锁任务取消修复死锁的任务使用一致的锁获取顺序任务开始执行按与任务相同的顺序获取锁避免死锁任务任务同时持有两把锁执行关键代码模拟工作释放锁任务释放任务释放任务无法获取所需的锁任务取消创建两个线程启动线程等待线程结束所有线程执行完毕没有死锁死锁预防方法按顺序获取锁使所有线程按相同顺序获取锁超时机制使用设置获取锁的超时时间一次性获取所有锁创建更高级别的锁来同时获取多个锁使用显式资源分级为资源分配层级只允许按层级顺序获取避免嵌套锁设计简化的锁策略减少同时持有多个锁的情况使用语句确保锁在异常情况下也能被释放原子操作与锁优化在并发编程中原子操作是指不可被中断的操作它们要么完全执行要么完全不执行提供了一些原子操作工具可以减少对锁的依赖对象线程本地存储线程本地存储提供了一种每个线程拥有自己独立数据副本的机制避免了共享状态带来的并发问题我们可以往上挂载对象这样我们的每一个线程就会有属于自己的独立数据创建线程本地存储对象处理请求的工作函数为当前线程设置上下文信息模拟处理请求的各个阶段请求开始处理线程用户验证处理响应计算总处理时间请求完成处理总耗时秒线程处理请求的某个阶段访问线程本地变量无需传递参数模拟阶段处理请求阶段完成用户所有请求处理完成带锁的缓存装饰器提供了一个线程安全的缓存机制当一个函数的计算逻辑十分复杂我们就可以采用缓存来优化这一点缓存演示计算斐波那契数列的第个数使用缓存优化性能演示缓存的效果不使用缓存的计算时间测试无缓存版本无缓存计算耗时秒测试有缓存版本首次使用缓存计算耗时秒再次调用应该直接从缓存获取结果再次使用缓存计算耗时秒显示缓存信息缓存信息锁的高级应用模式读写锁模式中的读写锁主要用于在多线程环境中控制对共享资源的访问它允许多个线程同时读取共享数据但在写操作时其他线程不能进行读或写操作具体的应用场景包括数据共享与并发读取当多个线程需要读取同一份数据时使用读锁可以提高并发性允许多个线程同时访问数据而不需要每次访问都加锁写操作的独占性当有线程进行写操作时需要获取写锁这样可以确保写操作的独占性避免数据竞争和不一致性性能优化在读多写少的场景下读写锁能提高性能因为它允许多个线程并行读取数据而只有在写入时才会阻塞其他线程我们先从原生实现读写锁来作为演示掌握了原生的方式我们可以使用第三方库来帮我们快速实现读写锁读写锁实现允许多个读取者同时访问或单个写入者独占访问初始化读写锁当前读取者数量当前写入者数量等待写入的线程数当前持有写锁的线程获取读锁当有写入者或正在等待的写入者时读取者需要等待释放读锁最后一个读取者通知所有等待的线程获取写锁获取当前线程增加等待写入计数等待没有读取者和写入者减少等待写入计数释放写锁释放未持有的写锁通知所有等待的线程支持语句的上下文管理器获取读锁和写锁的方法获取读锁上下文管理器获取写锁上下文管理器共享数据和读写锁读取者线程读取者获取读锁读取共享数据模拟读取操作读取者读取到读取者之间的休息写入者线程写入者准备新数据获取写锁修改共享数据模拟写入操作写入者更新为写入者之间的休息创建读取者和写入者线程启动所有线程等待所有线程完成最终数据使用库实现读写锁读写锁实现示例库提供了三种读写锁实现读者优先第一读者写者问题写者优先第二读者写者问题公平优先第三读者写者问题每种锁都有对应的可降级版本带后缀允许将锁从写模式降级到读模式创建一个公平优先的读写锁共享数据用于演示的读取函数读取者获得读锁模拟读取操作读取者完成读取读取者释放读锁用于演示的写入函数写入者获得写锁模拟写入操作写入者完成写入写入者释放写锁演示读读不互斥演示读读不互斥演示读写互斥演示读写互斥先启动一个长时间的读取线程给读取线程一点时间获取锁尝试启动写入线程应该被阻塞直到读取完成演示写写互斥演示写写互斥先启动一个长时间的写入线程给第一个写入线程一点时间获取锁尝试启动另一个写入线程应该被阻塞直到第一个写入完成演示锁获取超时演示锁获取超时先启动一个长时间的写入线程给写入线程一点时间获取锁尝试获取读锁但设置较短的超时时间读取者成功获得读锁不应该发生读取者获取读锁超时预期行为演示读读不互斥演示读写互斥演示写写互斥演示锁获取超时读写锁特性描述优势适用场景读共享写独占多个读取可并发写入需独占提高读多写少场景的并发性配置数据缓存系统数据集读写优先级可以设置读优先或写优先根据应用需求调整性能特性根据读写比例调整策略升级降级支持锁的升级读写或降级写读灵活处理复杂访问模式先检查后修改的操作使用建议读多写少的场景推荐使用读写锁注意防止写饥饿即读取者太多导致写入者长时间等待锁排序解决死锁为避免死锁一个常用的技术是确保所有线程按照相同的顺序获取多个锁模拟银行账户初始化账户用于账户排序的唯一账户余额在账户间转账使用账户排序策略避免死锁转出账户转入账户转账金额线程名称按照账户从小到大的顺序获取锁确保所有线程获取锁的顺序一致尝试锁定账户已锁定账户模拟网络延迟尝试锁定账户已锁定账户执行转账操作已从转账元到创建两个账户初始状态创建两个线程同时进行相反方向的转账转账线程转账线程启动线程等待线程结束最终状态两阶段锁定两阶段锁定是一种事务并发控制协议分为获取阶段和释放阶段可以保证事务的可串行化演示两阶段锁定协议的简单数据库初始化数据库简单的数据项每个数据项的锁执行两阶段锁定事务需要读取的数据项列表需要写入的数据项列表事务操作函数事务是否成功按字母顺序排序所有需要锁定的项避免死锁阶段获取锁阶段增长阶段事务开始获取锁对于读取项获取共享锁对于写入项获取排他锁这里简化为都使用排他锁事务已锁定获取的锁超时执行事务操作事务操作完成事务错误阶段释放锁阶段收缩阶段事务已释放转账事务账户余额不足模拟操作耗时执行转账已从转账到执行事务的线程函数线程尝试转账从到成功失败线程转账耗时秒创建数据库实例初始账户状态创建并启动多个线程从转到从转到从转到等待所有线程完成最终账户状态总金额总金额应该不变超时重试模式在并发环境中有时获取锁可能会失败超时重试模式可以增加获取锁的成功概率同时避免永久阻塞共享资源更新共享资源使用超时重试模式工作线程最大重试次数是否成功更新随机生成操作标识用于跟踪工作线程操作尝试更新资源初始回退时间尝试获取锁设置超时时间工作线程操作获取到锁当前值模拟资源更新操作随机决定操作时间有时可能很长更新资源工作线程操作更新成功新值耗时秒释放锁工作线程操作释放锁工作线程操作获取锁超时重试使用指数退避策略每次重试间隔加长指数增长工作线程操作达到最大重试次数放弃操作工作线程函数工作线程要执行的操作次数尝试更新资源线程之间的间隔工作线程完成次成功更新创建多个工作线程等待所有线程完成最终资源值多进程与多线程结合的混合模型对于复杂应用常常需要结合多进程和多线程的优势多进程跨越限制利用多核心每个进程内使用多线程处理任务模拟密集型任务发送请求并处理响应线程完成请求状态码线程请求失败模拟密集型任务处理数据模拟密集型计算解析数据进程处理了行数据每个进程的工作函数使用线程池处理任务进程启动创建线程池处理任务提交所有请求任务到线程池收集结果处理时出错模拟一些数据处理密集型任务进程完成所有任务测试列表将分成组每个进程处理个创建进程池提交任务到进程池收集所有进程的结果进程返回结果个请求任务处理了行数据进程执行出错总执行时间秒这种混合模型充分利用了的并发性能多进程并行跨越限制在多个核心上同时执行代码每进程多线程处理进程内的密集型任务提高并发性任务队列有效分配和管理工作负载平衡资源利用细粒度锁与粗粒度锁锁的粒度指锁保护资源的范围大小细粒度锁保护小范围资源提高并发度粗粒度锁保护大范围资源简化编程但可能降低并发度共享资源粗粒度锁用于整个账户操作细粒度锁分别用于读取和写入操作粗粒度锁示例锁定整个账户操作模拟读取余额操作模拟网络延迟或处理时间模拟更新余额操作粗粒度锁转账当前余额细粒度锁示例分别锁定读取和写入操作锁定读取操作模拟处理时间这里可以执行一些不需要锁定的计算锁定写入操作细粒度锁转账当前余额测试函数创建共享账户测试粗粒度锁创建个使用粗粒度锁的线程等待所有线程完成粗粒度锁总耗时秒重置账户和线程列表测试细粒度锁创建个使用细粒度锁的线程等待所有线程完成细粒度锁总耗时秒性能比较细粒度锁比粗粒度锁快倍锁粒度优点缺点适用场景粗粒度锁简单易维护不易死锁并发性能低可能导致线程等待简单应用对性能要求不高的场景细粒度锁并发性能高资源利用率高实现复杂可能造成死锁高性能要求资源访问模式明确的场景消息队列与进程通信在并发编程中队列是一种常用的数据结构它遵循先进先出的原则适合用于线程或进程间的通信而堆栈则遵循后进先出的原则中的和模块提供了多种类型的队列每种队列适用于不同的场景队列基础知识的模块和模块提供了多种队列类型主要包括队列类型模块特点适用场景线程安全的队列线程间通信线程安全的队列堆栈需要后进先出的场景优先级队列任务具有优先级的场景进程安全的队列进程间通信带有任务完成通知机制的队列生产者消费者模型队列使用示例生产者进程函数生产者函数负责生产数据并放入队列小吃生产者生产了放入队列模拟耗时操作生产结束信号生产者结束消费者进程函数消费者函数负责从队列中获取数据并消费从队列中获取项目若获取到结束信号则退出循环消费者消费了消费者结束创建一个队列对象启动生产者进程启动消费者进程优先级队列示例优先级队列按任务的优先级顺序处理任务数字越小优先级越高以下是如何使用的示例创建优先级队列优先级队列的元素是元组第一个元素是优先级第二个元素是任务按照优先级处理任务处理任务优先级队列为空任务处理完毕添加任务到优先级队列普通任务紧急任务中等优先级任务另一个紧急任务低优先级任务创建任务处理线程等待所有任务处理完毕所有任务处理完毕",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-06-17 18:00:00",postMainColor:"#5B5462"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0F1C2E')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#cee8ff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/index_media.css" media="(max-width:0),screen and (prefers-reduced-motion:reduce)" onload="this.media=`screen`"><link rel="stylesheet" href="/css/post-ui.css"><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://bu.dusays.com/2025/06/16/684f747174bc3.webp"><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async="" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="博客"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="博客"><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="后续项目..."><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="后续项目..."><span class="back-menu-item-text">后续项目...</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">格物致知</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)" rel="external nofollow noreferrer">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>个人</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="fas fa-check-double faa-tada"></i><span> 代办清单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>预览</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?server=netease&amp;id=3117791189"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/messages/"><i class="fas fa-comments faa-tada"></i><span> 评论总览</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 即刻短文</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="background-change-button"><a class="site-page" onclick="toggleWinbox()" title="切换背景" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-palette"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/bYMH/418X445/ef9a3f68-d36a-441a-95fe-8179b1a25992.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/bYMH/418X445/ef9a3f68-d36a-441a-95fe-8179b1a25992.png"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/cYu3/347X390/zfb.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/cYu3/347X390/zfb.png"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">音乐</div><span class="author-content-item-title">灵魂的碰撞💥</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li></ul></div></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);" rel="external nofollow noreferrer"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/" itemprop="url">后端技术</a><i class="anzhiyufont anzhiyu-icon-angle-right post-meta-separator"></i><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Python/" itemprop="url">Python</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Python/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>Python</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Python教程：Python知识点前篇速览</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-06-17T07:05:54.000Z" title="发表于 2025-06-17 15:05:54">2025-06-17</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-06-17T10:00:00.000Z" title="更新于 2025-06-17 18:00:00">2025-06-17</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span data-flag-title="Python教程：Python知识点前篇速览"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为广东"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>广东</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://bu.dusays.com/2025/06/17/685113b7c39b1.webp"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">Tianli GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax="" src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope="" itemtype="https://prorise-cool.github.io/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/"><header><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/" itemprop="url">后端技术</a><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Python/" itemprop="url">Python</a><a href="/tags/Python/" tabindex="-1" itemprop="url">Python</a><h1 id="CrawlerTitle" itemprop="name headline">Python教程：Python知识点前篇速览</h1><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">Prorise</span><time itemprop="dateCreated datePublished" datetime="2025-06-17T07:05:54.000Z" title="发表于 2025-06-17 15:05:54">2025-06-17</time><time itemprop="dateCreated datePublished" datetime="2025-06-17T10:00:00.000Z" title="更新于 2025-06-17 18:00:00">2025-06-17</time></header><div id="postchat_postcontent"><h2 id="Python-语言特性"><a href="#Python-语言特性" class="headerlink" title="Python 语言特性"></a>Python 语言特性</h2><p>Python 是一门 <strong>解释型</strong> 的 <strong>弱类型动态</strong> 语言</p><h3 id="编译型-vs-解释型"><a href="#编译型-vs-解释型" class="headerlink" title="编译型 vs 解释型"></a>编译型 vs 解释型</h3><ul><li><strong>编译型语言</strong>：先编译后运行，速度快，适合大型项目</li><li><strong>解释型语言</strong>：边解释边运行，灵活易改，适合快速开发</li></ul><h3 id="强类型-vs-弱类型"><a href="#强类型-vs-弱类型" class="headerlink" title="强类型 vs 弱类型"></a>强类型 vs 弱类型</h3><ul><li><strong>强类型</strong>：类型检查严格，变量需声明类型</li><li><strong>弱类型</strong>：类型检查宽松，变量隐式转换</li></ul><h3 id="动态型-vs-静态型"><a href="#动态型-vs-静态型" class="headerlink" title="动态型 vs 静态型"></a>动态型 vs 静态型</h3><ul><li><strong>动态型语言</strong>：运行时确定数据类型，灵活但效率较低</li><li><strong>静态型语言</strong>：编译时确定数据类型，高效但灵活性较差</li></ul><h3 id="类型提示"><a href="#类型提示" class="headerlink" title="类型提示"></a>类型提示</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">name: <span class="built_in">str</span>, age: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f"<span class="subst">{name}</span>说，我今年<span class="subst">{age}</span>years old."</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(func(<span class="string">'张三'</span>, <span class="number">25</span>))</span><br><span class="line"><span class="built_in">print</span>(func.__annotations__)  <span class="comment"># 查看函数的类型注解</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>注意：Python 的类型提示不会强制执行类型检查，仅作为开发辅助和文档。</p></blockquote><hr><h2 id="第一章：字符串打印格式化与PyCharm模板变量"><a href="#第一章：字符串打印格式化与PyCharm模板变量" class="headerlink" title="第一章：字符串打印格式化与PyCharm模板变量"></a>第一章：字符串打印格式化与PyCharm模板变量</h2><p>本章将分为两个主要部分：首先介绍如何在 Python 控制台中使用 ANSI 转义序列来实现文本的彩色和格式化输出，并提供一个实用的封装示例；其次，我们将探讨如何利用 IDE（特别是 PyCharm，但概念也适用于其他IDE）中的 Live Template (实时模板/代码片段) 功能，通过预设的模板变量和缩写来大幅提升 Python 的编码效率。</p><h3 id="字符串打印格式化-ANSI-转义序列"><a href="#字符串打印格式化-ANSI-转义序列" class="headerlink" title="字符串打印格式化 (ANSI 转义序列)"></a>字符串打印格式化 (ANSI 转义序列)</h3><p>Python 允许在控制台中输出彩色文本和特殊格式，这在创建命令行界面 (CLI) 或需要突出显示特定输出时非常有用，可以显著增强用户体验和信息的可读性。这种效果通常是通过 <strong>ANSI 转义序列 (ANSI escape sequences)</strong> 来实现的。</p><h4 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h4><p>ANSI 转义序列的基本格式如下：</p><figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\033[参数m内容\033[0m</span><br></pre></td></tr></tbody></table></figure><p>或者在 Python 字符串中，通常写作：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'\033[&lt;参数&gt;m&lt;你的文本内容&gt;\033[0m'</span></span><br></pre></td></tr></tbody></table></figure><p>其中：</p><ul><li><code>\033</code> (或 <code>\x1b</code>)：这是 ESC 字符的八进制（或十六进制）表示，标志着转义序列的开始。</li><li><code>[</code>：控制序列引导符 (Control Sequence Introducer, CSI)。</li><li><code>&lt;参数&gt;</code>：一个或多个用分号 <code>;</code> 分隔的数字。这些数字代码控制着文本的显示方式、前景色（文字颜色）和背景色。</li><li><code>m</code>：表示设置图形再现参数 (Select Graphic Rendition, SGR) 的结束标志。</li><li><code>&lt;你的文本内容&gt;</code>：你希望应用这些格式的实际文本。</li><li><code>\033[0m</code>：这是一个特殊的重置序列，它会清除之前设置的所有格式属性，使后续的文本恢复到终端的默认显示状态。<strong>每次使用完特殊格式后，都强烈建议使用此序列来重置，以避免格式污染后续的输出。</strong></li></ul><h4 id="ANSI-转义码表"><a href="#ANSI-转义码表" class="headerlink" title="ANSI 转义码表"></a>ANSI 转义码表</h4><p>下表列出了一些常用的 ANSI SGR 参数代码：</p><table><thead><tr><th align="left">显示方式</th><th align="left">代码</th><th align="left">前景色</th><th align="left">代码</th><th align="left">背景色</th><th align="left">代码</th></tr></thead><tbody><tr><td align="left">默认</td><td align="left">0</td><td align="left">黑色</td><td align="left">30</td><td align="left">黑色</td><td align="left">40</td></tr><tr><td align="left">高亮/粗体</td><td align="left">1</td><td align="left">红色</td><td align="left">31</td><td align="left">红色</td><td align="left">41</td></tr><tr><td align="left">(通常不使用)</td><td align="left">2</td><td align="left">绿色</td><td align="left">32</td><td align="left">绿色</td><td align="left">42</td></tr><tr><td align="left">下划线</td><td align="left">4</td><td align="left">黄色</td><td align="left">33</td><td align="left">黄色</td><td align="left">43</td></tr><tr><td align="left">闪烁</td><td align="left">5</td><td align="left">蓝色</td><td align="left">34</td><td align="left">蓝色</td><td align="left">44</td></tr><tr><td align="left">反白</td><td align="left">7</td><td align="left">紫红色</td><td align="left">35</td><td align="left">紫红色</td><td align="left">45</td></tr><tr><td align="left">不可见</td><td align="left">8</td><td align="left">青蓝色</td><td align="left">36</td><td align="left">青蓝色</td><td align="left">46</td></tr><tr><td align="left"></td><td align="left"></td><td align="left">白色</td><td align="left">37</td><td align="left">白色</td><td align="left">47</td></tr></tbody></table><p><strong>注意</strong>：</p><ul><li>除了上述标准颜色 (30-37, 40-47)，现代终端通常还支持高强度颜色 (例如，高亮红色使用 <code>\033[1;31m</code> 或者单独的亮色代码 <code>\033[91m</code>)、256色模式以及 RGB 真彩色模式 (例如 <code>\033[38;2;r;g;bm</code> 设置前景色为 RGB(r,g,b))。但这些高级模式的兼容性可能因终端模拟器而异。</li><li>“闪烁”(代码5) 和 “不可见”(代码8) 的支持程度也取决于终端。</li></ul><h4 id="实用示例"><a href="#实用示例" class="headerlink" title="实用示例"></a>实用示例</h4><h5 id="基本颜色设置"><a href="#基本颜色设置" class="headerlink" title="基本颜色设置"></a>基本颜色设置</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 红色文字</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'\033[31m这是红色文字\033[0m'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绿色文字</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'\033[32m这是绿色文字\033[0m'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 黄色文字 (通常与高亮/粗体结合使用效果更明显)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'\033[1;33m这是高亮黄色文字\033[0m'</span>) <span class="comment"># 1表示高亮/粗体，33表示黄色</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 蓝色文字</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'\033[34m这是蓝色文字\033[0m'</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="组合使用"><a href="#组合使用" class="headerlink" title="组合使用"></a>组合使用</h5><p>可以同时设置显示方式、前景色和背景色，用分号分隔参数。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 红色文字 + 黄色背景</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'\033[31;43m红字黄底\033[0m'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 高亮 + 绿色文字</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'\033[1;32m高亮绿色文字\033[0m'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下划线 + 蓝色文字</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'\033[4;34m带下划线的蓝色文字\033[0m'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 高亮 + 紫红色文字 + 白色背景</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'\033[1;35;47m高亮紫红色文字白色背景\033[0m'</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="实际应用场景-封装为-print-utils-py-工具模块"><a href="#实际应用场景-封装为-print-utils-py-工具模块" class="headerlink" title="实际应用场景 (封装为 print_utils.py 工具模块)"></a>实际应用场景 (封装为 <code>print_utils.py</code> 工具模块)</h4><p>为了在项目中更方便、更一致地使用彩色打印，通常我们会将这些 ANSI 转义序列封装成常量或函数。以下是您之前提供的 <code>print_utils.py</code> 模块内容，它是一个很好的实践示例：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">打印工具模块，提供彩色和结构化的打印函数。</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======== 彩色打印工具 ========</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Colors</span>:</span><br><span class="line">    <span class="string">"""存储 ANSI 颜色和样式代码的常量。"""</span></span><br><span class="line">    HEADER = <span class="string">'\033[95m'</span>    <span class="comment"># 亮紫色 (常用于标题)</span></span><br><span class="line">    BLUE = <span class="string">'\033[94m'</span>      <span class="comment"># 亮蓝色</span></span><br><span class="line">    CYAN = <span class="string">'\033[96m'</span>      <span class="comment"># 亮青色</span></span><br><span class="line">    GREEN = <span class="string">'\033[92m'</span>     <span class="comment"># 亮绿色</span></span><br><span class="line">    WARNING = <span class="string">'\033[93m'</span>   <span class="comment"># 亮黄色</span></span><br><span class="line">    FAIL = <span class="string">'\033[91m'</span>      <span class="comment"># 亮红色</span></span><br><span class="line">    BOLD = <span class="string">'\033[1m'</span>       <span class="comment"># 粗体/高亮</span></span><br><span class="line">    UNDERLINE = <span class="string">'\033[4m'</span>  <span class="comment"># 下划线</span></span><br><span class="line">    END = <span class="string">'\033[0m'</span>        <span class="comment"># 重置所有格式</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_header</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""打印带特殊格式的标题。"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n<span class="subst">{Colors.HEADER}</span><span class="subst">{Colors.BOLD}</span>--- <span class="subst">{text}</span> ---<span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_subheader</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""打印带下划线的青色子标题。"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n<span class="subst">{Colors.CYAN}</span><span class="subst">{Colors.UNDERLINE}</span>  <span class="subst">{text}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_info</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""打印普通信息 (默认颜色)。"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f" INFO: <span class="subst">{text}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_success</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""打印成功信息 (绿色)。"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Colors.GREEN}</span>  ✔ <span class="subst">{text}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_warning</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""打印警告信息 (黄色)。"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Colors.WARNING}</span>  ⚠️ [Warning] <span class="subst">{text}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_error</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""打印错误信息 (红色)。"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Colors.FAIL}</span>  ❌ [Error] <span class="subst">{text}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_sql</span>(<span class="params">sql: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""打印SQL语句 (蓝色)。"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Colors.BLUE}</span>    SQL: <span class="subst">{sql.strip()}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_result_item</span>(<span class="params">item: <span class="built_in">any</span>, indent: <span class="built_in">int</span> = <span class="number">4</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""以结构化方式打印结果项，特别是字典。"""</span></span><br><span class="line">    prefix = <span class="string">" "</span> * indent</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">dict</span>):</span><br><span class="line">        details = <span class="string">", "</span>.join([</span><br><span class="line">            <span class="string">f"<span class="subst">{Colors.BOLD}</span><span class="subst">{key}</span><span class="subst">{Colors.END}</span>: <span class="subst">{<span class="built_in">repr</span>(value)}</span>"</span> <span class="keyword">for</span> key, value <span class="keyword">in</span> item.items()</span><br><span class="line">        ])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{prefix}</span>Row(<span class="subst">{details}</span>)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{prefix}</span><span class="subst">{<span class="built_in">repr</span>(item)}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======== END 彩色打印工具 ========</span></span><br></pre></td></tr></tbody></table></figure><p><strong>如何使用这个 <code>print_utils</code> 模块：</strong></p><ol><li>将上述代码保存为 <code>print_utils.py</code> 文件。</li><li>在您的其他 Python 脚本中，通过 <code>from print_utils import *</code> 或 <code>import print_utils</code> 来使用这些函数。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例：在另一个脚本中使用 print_utils.py</span></span><br><span class="line"><span class="comment"># from print_utils import print_header, print_success, print_error # 假设已导入</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># print_header("应用程序任务") # 调用封装好的函数</span></span><br><span class="line">    <span class="comment"># print_success("任务A已成功完成！")</span></span><br><span class="line">    <span class="comment"># print_error("任务B执行失败，错误代码：1024")</span></span><br><span class="line">    <span class="keyword">pass</span> <span class="comment"># 仅为结构示例</span></span><br></pre></td></tr></tbody></table></figure><h3 id="PyCharm-Live-Templates-提升编码效率"><a href="#PyCharm-Live-Templates-提升编码效率" class="headerlink" title="PyCharm Live Templates 提升编码效率"></a>PyCharm Live Templates 提升编码效率</h3><p>Live Templates（实时模板或代码片段）是现代集成开发环境 (IDE) 如 PyCharm、VS Code 等提供的一项核心功能。它允许开发者定义常用的代码结构，并通过输入一个简短的<strong>缩写 (Abbreviation)</strong> 后按下特定按键（通常是 <code>Tab</code>）来快速插入这些<strong>代码块 (Template text)</strong>。这些模板通常还支持<strong>占位符变量</strong>，如 <code>$VAR$</code> 或 <code>$CURSOR$</code>，在模板展开后，IDE 会引导用户快速填充这些变量或将光标定位到预设位置。</p><p>使用 Live Templates 可以：</p><ul><li><strong>显著减少重复的样板代码输入</strong>。</li><li><strong>提高编码速度和效率</strong>。</li><li><strong>帮助保持代码风格和结构的一致性</strong>。</li><li><strong>减少因手动输入而出错的可能性</strong>。</li></ul><p>我们需要根据如下步骤去键入模板</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250518133509693.png" alt="image-20250518133509693"></p><h4 id="1-基本循环"><a href="#1-基本循环" class="headerlink" title="1. 基本循环"></a>1. 基本循环</h4><h5 id="a-for-in-循环-遍历序列"><a href="#a-for-in-循环-遍历序列" class="headerlink" title="a. for...in 循环 (遍历序列)"></a>a. <code>for...in</code> 循环 (遍历序列)</h5><ul><li><strong>模板用途</strong>: 快速生成一个遍历可迭代对象的 <code>for</code> 循环。</li><li><strong>建议缩写</strong>: <code>fori</code> (或您截图中的 <code>iter</code>)</li><li><strong>描述</strong>: <code>for item in iterable:</code> 循环</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> $ITEM$ <span class="keyword">in</span> $ITERABLE$:</span><br><span class="line">    $CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>:<ul><li><code>$ITEM$</code>: 循环中每次迭代的元素变量名。</li><li><code>$ITERABLE$</code>: 要遍历的序列或可迭代对象。</li><li><code>$CURSOR$</code>: 模板展开后光标的初始位置。</li></ul></li></ul><h5 id="b-for-in-enumerate-循环-带索引遍历"><a href="#b-for-in-enumerate-循环-带索引遍历" class="headerlink" title="b. for...in enumerate 循环 (带索引遍历)"></a>b. <code>for...in enumerate</code> 循环 (带索引遍历)</h5><ul><li><strong>模板用途</strong>: 快速生成一个同时遍历索引和元素的 <code>for</code> 循环。</li><li><strong>建议缩写</strong>: <code>forenum</code> (或您截图中的 <code>itere</code>)</li><li><strong>描述</strong>: <code>for index, item in enumerate(iterable):</code> 循环</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> $INDEX$, $ITEM$ <span class="keyword">in</span> <span class="built_in">enumerate</span>($ITERABLE$):</span><br><span class="line">    $CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>:<ul><li><code>$INDEX$</code>: 循环中每次迭代的索引变量名。</li><li><code>$ITEM$</code>: 循环中每次迭代的元素变量名。</li><li><code>$ITERABLE$</code>: 要遍历的序列或可迭代对象。</li></ul></li></ul><h5 id="c-for-in-range-循环-按次数"><a href="#c-for-in-range-循环-按次数" class="headerlink" title="c. for...in range 循环 (按次数)"></a>c. <code>for...in range</code> 循环 (按次数)</h5><ul><li><strong>模板用途</strong>: 快速生成一个按指定次数执行的 <code>for</code> 循环。</li><li><strong>建议缩写</strong>: <code>forr</code></li><li><strong>描述</strong>: <code>for i in range(count):</code> 循环</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> $VAR$ <span class="keyword">in</span> <span class="built_in">range</span>($COUNT$):</span><br><span class="line">    $CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>:<ul><li><code>$VAR$</code>: 循环计数变量名 (通常是 <code>i</code>)。</li><li><code>$COUNT$</code>: 循环的次数。</li></ul></li></ul><h4 id="2-条件判断"><a href="#2-条件判断" class="headerlink" title="2. 条件判断"></a>2. 条件判断</h4><h5 id="a-if-语句"><a href="#a-if-语句" class="headerlink" title="a. if 语句"></a>a. <code>if</code> 语句</h5><ul><li><strong>模板用途</strong>: 快速生成一个基本的 <code>if</code> 条件判断语句。</li><li><strong>建议缩写</strong>: <code>ifc</code></li><li><strong>描述</strong>: <code>if condition:</code> 语句</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> $CONDITION$:</span><br><span class="line">    $CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>:<ul><li><code>$CONDITION$</code>: <code>if</code> 语句的条件表达式。</li><li><code>$CURSOR$</code>: 光标位于 <code>if</code> 代码块内部。</li></ul></li></ul><h5 id="b-if-else-语句"><a href="#b-if-else-语句" class="headerlink" title="b. if-else 语句"></a>b. <code>if-else</code> 语句</h5><ul><li><strong>模板用途</strong>: 快速生成 <code>if-else</code> 条件判断结构。</li><li><strong>建议缩写</strong>: <code>ifel</code></li><li><strong>描述</strong>: <code>if condition: ... else: ...</code> 语句</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> $CONDITION$:</span><br><span class="line">    $ACTION_IF_TRUE$</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    $ACTION_IF_FALSE$</span><br><span class="line">$CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$CONDITION$</code>, <code>$ACTION_IF_TRUE$</code>, <code>$ACTION_IF_FALSE$</code>, <code>$CURSOR$</code>。</li></ul><h5 id="c-if-elif-else-语句"><a href="#c-if-elif-else-语句" class="headerlink" title="c. if-elif-else 语句"></a>c. <code>if-elif-else</code> 语句</h5><ul><li><strong>模板用途</strong>: 快速生成 <code>if-elif-else</code> 多条件判断结构。</li><li><strong>建议缩写</strong>: <code>ifelifel</code></li><li><strong>描述</strong>: <code>if cond1: ... elif cond2: ... else: ...</code> 语句</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> $CONDITION1$:</span><br><span class="line">    $ACTION1$</span><br><span class="line"><span class="keyword">elif</span> $CONDITION2$:</span><br><span class="line">    $ACTION2$</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    $ACTION_ELSE$</span><br><span class="line">$CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$CONDITION1$</code>, <code>$ACTION1$</code>, <code>$CONDITION2$</code>, <code>$ACTION2$</code>, <code>$ACTION_ELSE$</code>, <code>$CURSOR$</code>。</li></ul><h4 id="3-打印与日志"><a href="#3-打印与日志" class="headerlink" title="3. 打印与日志"></a>3. 打印与日志</h4><h5 id="a-print-f-f-string-打印"><a href="#a-print-f-f-string-打印" class="headerlink" title="a. print(f&quot;...&quot;) (f-string 打印)"></a>a. <code>print(f"...")</code> (f-string 打印)</h5><ul><li><strong>模板用途</strong>: 快速生成一个使用 f-string 格式化的 <code>print</code> 语句。</li><li><strong>建议缩写</strong>: <code>prf</code></li><li><strong>描述</strong>: <code>print(f"...")</code> 语句</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">f"$CURSOR$"</span>)</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$CURSOR$</code>: 光标直接定位在 f-string 的引号内。</li></ul><h5 id="b-logger-info-快速日志记录-假设-logger-对象已配置"><a href="#b-logger-info-快速日志记录-假设-logger-对象已配置" class="headerlink" title="b. logger.info (快速日志记录 - 假设 logger 对象已配置)"></a>b. <code>logger.info</code> (快速日志记录 - 假设 <code>logger</code> 对象已配置)</h5><ul><li><strong>模板用途</strong>: 快速插入一条 <code>logger.info</code> 日志记录。</li><li><strong>建议缩写</strong>: <code>logi</code></li><li><strong>描述</strong>: <code>logger.info(f"...")</code></li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logger.info(<span class="string">f"$MESSAGE$"</span>)</span><br><span class="line">$CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$MESSAGE$</code>, <code>$CURSOR$</code>。 (类似地，可以为 <code>debug</code>, <code>warning</code>, <code>error</code>, <code>exception</code> 创建模板)</li></ul><h4 id="4-Python-结构与定义"><a href="#4-Python-结构与定义" class="headerlink" title="4. Python 结构与定义"></a>4. Python 结构与定义</h4><ul><li><strong>模板用途</strong>: 快速生成一个带类型注解和文档字符串的函数定义。</li><li><strong>建议缩写</strong>: <code>defn</code></li><li><strong>描述</strong>: 带类型注解和文档字符串的函数定义</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> $FUNCTION_NAME$($PARAMS$) -&gt; $RETURN_TYPE$:</span><br><span class="line">    <span class="string">"""$DOCSTRING$"""</span></span><br><span class="line">    $CURSOR$</span><br><span class="line">    <span class="keyword">return</span> $RETURN_VALUE$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$FUNCTION_NAME$</code>, <code>$PARAMS$</code>, <code>$RETURN_TYPE$</code> (可默认为 <code>None</code>), <code>$DOCSTRING$</code>, <code>$CURSOR$</code>, <code>$RETURN_VALUE$</code> (可默认为 <code>None</code>)。</li></ul><h5 id="c-类定义-基本结构"><a href="#c-类定义-基本结构" class="headerlink" title="c. 类定义 (基本结构)"></a>c. 类定义 (基本结构)</h5><ul><li><strong>模板用途</strong>: 快速生成一个带 <code>__init__</code> 方法的类定义。</li><li><strong>建议缩写</strong>: <code>cls</code></li><li><strong>描述</strong>: 基本类定义 (含 <code>__init__</code>)</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> $ClassName$:</span><br><span class="line">    <span class="string">"""$CLASS_DOCSTRING$"""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, $ARGS$</span>):</span><br><span class="line">        <span class="string">"""初始化 $ClassName$ 对象。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            $ARGS_DOC$</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        $INIT_BODY$</span><br><span class="line">        $CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$ClassName$</code>, <code>$CLASS_DOCSTRING$</code>, <code>$ARGS$</code>, <code>$ARGS_DOC$</code>, <code>$INIT_BODY$</code>, <code>$CURSOR$</code>.</li></ul><h5 id="d-dataclass-类定义"><a href="#d-dataclass-类定义" class="headerlink" title="d. @dataclass 类定义"></a>d. <code>@dataclass</code> 类定义</h5><ul><li><strong>模板用途</strong>: 快速生成一个使用 <code>dataclasses</code> 模块定义的类。</li><li><strong>建议缩写</strong>: <code>dtcls</code></li><li><strong>描述</strong>: <code>@dataclass</code> 类定义</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> $ClassName$:</span><br><span class="line">    <span class="string">"""表示 $ENTITY_DESCRIPTION$ 的数据类。"""</span></span><br><span class="line">    $FIELD_NAME$: $FIELD_TYPE$</span><br><span class="line">    $CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$ClassName$</code>, <code>$ENTITY_DESCRIPTION$</code>, <code>$FIELD_NAME$</code>, <code>$FIELD_TYPE$</code>, <code>$CURSOR$</code>.</li></ul><h4 id="5-异常处理"><a href="#5-异常处理" class="headerlink" title="5. 异常处理"></a>5. 异常处理</h4><h5 id="a-try-except-基本块"><a href="#a-try-except-基本块" class="headerlink" title="a. try-except 基本块"></a>a. <code>try-except</code> 基本块</h5><ul><li><strong>模板用途</strong>: 快速生成一个基本的 <code>try-except</code> 异常处理块。</li><li><strong>建议缩写</strong>: <code>tryex</code></li><li><strong>描述</strong>: <code>try...except Exception as e:</code> 块</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    $TRY_BODY$</span><br><span class="line"><span class="keyword">except</span> $EXCEPTION_TYPE$ <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># logger.exception(f"An error occurred: {e}") # 如果使用日志</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"An error occurred ($EXCEPTION_TYPE$): <span class="subst">{e}</span>"</span>) <span class="comment"># 简单打印</span></span><br><span class="line">    $CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$TRY_BODY$</code>, <code>$EXCEPTION_TYPE$</code> (可默认为 <code>Exception</code>), <code>$CURSOR$</code>.</li></ul><h5 id="b-try-except-else-finally-完整块"><a href="#b-try-except-else-finally-完整块" class="headerlink" title="b. try-except-else-finally 完整块"></a>b. <code>try-except-else-finally</code> 完整块</h5><ul><li><strong>模板用途</strong>: 快速生成包含 <code>else</code> 和 <code>finally</code> 子句的 <code>try-except</code> 块。</li><li><strong>建议缩写</strong>: <code>tryexelfi</code></li><li><strong>描述</strong>: <code>try...except...else...finally:</code> 块</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    $TRY_BODY$</span><br><span class="line"><span class="keyword">except</span> $EXCEPTION_TYPE$ <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"An error occurred ($EXCEPTION_TYPE$): <span class="subst">{e}</span>"</span>)</span><br><span class="line">    $EXCEPT_BODY$</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Operation successful, no exceptions."</span>)</span><br><span class="line">    $ELSE_BODY$</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Executing finally block."</span>)</span><br><span class="line">    $FINALLY_BODY$</span><br><span class="line">$CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$TRY_BODY$</code>, <code>$EXCEPTION_TYPE$</code>, <code>$EXCEPT_BODY$</code>, <code>$ELSE_BODY$</code>, <code>$FINALLY_BODY$</code>, <code>$CURSOR$</code>.</li></ul><h4 id="6-文件操作"><a href="#6-文件操作" class="headerlink" title="6. 文件操作"></a>6. 文件操作</h4><h5 id="a-with-open-上下文管理器"><a href="#a-with-open-上下文管理器" class="headerlink" title="a. with open(...) 上下文管理器"></a>a. <code>with open(...)</code> 上下文管理器</h5><ul><li><strong>模板用途</strong>: 快速生成使用 <code>with</code> 语句安全打开和操作文件的代码。</li><li><strong>建议缩写</strong>: <code>fwith</code></li><li><strong>描述</strong>: <code>with open(...) as f:</code> (安全文件操作)</li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"$FILEPATH$"</span>, mode=<span class="string">"$MODE$"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> $VARNAME$:</span><br><span class="line">        $CURSOR$</span><br><span class="line">        <span class="comment"># content = $VARNAME$.read()</span></span><br><span class="line"><span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Error: File '$FILEPATH$' not found."</span>)</span><br><span class="line"><span class="keyword">except</span> IOError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Error reading/writing file '$FILEPATH$': <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$FILEPATH$</code>, <code>$MODE$</code> (可默认为 <code>'r'</code>), <code>$VARNAME$</code> (可默认为 <code>f</code>), <code>$CURSOR$</code>.</li></ul><h4 id="7-推导式"><a href="#7-推导式" class="headerlink" title="7. 推导式"></a>7. 推导式</h4><h5 id="a-列表推导式-List-Comprehension"><a href="#a-列表推导式-List-Comprehension" class="headerlink" title="a. 列表推导式 (List Comprehension)"></a>a. 列表推导式 (List Comprehension)</h5><ul><li><p><strong>模板用途</strong>: 快速生成列表推导式。</p></li><li><p><strong>建议缩写</strong>: <code>lc</code> (或您截图中的 <code>compl</code> / <code>compli</code> for with if)</p></li><li><p><strong>描述</strong>: <code>[expr for item in iterable if condition]</code></p></li><li><p><strong>模板文本 (带if)</strong>:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[$EXPRESSION$ <span class="keyword">for</span> $ITEM$ <span class="keyword">in</span> $ITERABLE$ <span class="keyword">if</span> $CONDITION$]</span><br><span class="line">$CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>模板文本 (不带if)</strong>:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[$EXPRESSION$ <span class="keyword">for</span> $ITEM$ <span class="keyword">in</span> $ITERABLE$]</span><br><span class="line">$CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>主要占位符说明</strong>: <code>$EXPRESSION$</code>, <code>$ITEM$</code>, <code>$ITERABLE$</code>, <code>$CONDITION$</code> (可选)。</p></li></ul><h5 id="b-字典推导式-Dictionary-Comprehension"><a href="#b-字典推导式-Dictionary-Comprehension" class="headerlink" title="b. 字典推导式 (Dictionary Comprehension)"></a>b. 字典推导式 (Dictionary Comprehension)</h5><ul><li><strong>模板用途</strong>: 快速生成字典推导式。</li><li><strong>建议缩写</strong>: <code>dc</code> (或您截图中的 <code>compd</code> / <code>compdi</code> for with if)</li><li><strong>描述</strong>: <code>{key_expr: val_expr for item in iterable if condition}</code></li><li><strong>模板文本 (带if)</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">{$KEY_EXPRESSION$: $VALUE_EXPRESSION$ <span class="keyword">for</span> $ITEM$ <span class="keyword">in</span> $ITERABLE$ <span class="keyword">if</span> $CONDITION$}</span><br><span class="line">$CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>模板文本 (不带if)</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">{$KEY_EXPRESSION$: $VALUE_EXPRESSION$ <span class="keyword">for</span> $ITEM$ <span class="keyword">in</span> $ITERABLE$}</span><br><span class="line">$CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$KEY_EXPRESSION$</code>, <code>$VALUE_EXPRESSION$</code>, <code>$ITEM$</code>, <code>$ITERABLE$</code>, <code>$CONDITION$</code> (可选)。</li></ul><h4 id="8-其他"><a href="#8-其他" class="headerlink" title="8. 其他"></a>8. 其他</h4><h5 id="a-lambda-匿名函数"><a href="#a-lambda-匿名函数" class="headerlink" title="a. lambda 匿名函数"></a>a. <code>lambda</code> 匿名函数</h5><ul><li><strong>模板用途</strong>: 快速创建一个简单的 <code>lambda</code> 函数。</li><li><strong>建议缩写</strong>: <code>lam</code></li><li><strong>描述</strong>: <code>lambda arguments: expression</code></li><li><strong>模板文本</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$LAMBDA_VAR$ = <span class="keyword">lambda</span> $ARGUMENTS$: $EXPRESSION$</span><br><span class="line">$CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$LAMBDA_VAR$</code>, <code>$ARGUMENTS$</code>, <code>$EXPRESSION$</code>.</li></ul><h5 id="b-注释标记"><a href="#b-注释标记" class="headerlink" title="b. 注释标记"></a>b. 注释标记</h5><ul><li><strong>模板用途</strong>: 快速插入标准的 TODO, FIXME, NOTE 注释。</li><li><strong>建议缩写</strong>: <code>todo</code> / <code>fixme</code> / <code>note</code></li><li><strong>描述</strong>: <code># TODO: ...</code> / <code># FIXME: ...</code> / <code># NOTE: ...</code></li><li><strong>模板文本 (以 <code>todo</code> 为例)</strong>:<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TODO ($USER$ @ $DATE$): $MESSAGE$</span></span><br><span class="line">$CURSOR$</span><br></pre></td></tr></tbody></table></figure></li><li><strong>主要占位符说明</strong>: <code>$USER$</code> (IDE或可配置), <code>$DATE$</code> (IDE或可配置), <code>$MESSAGE$</code>.</li></ul><hr><h2 id="第二章：转义字符"><a href="#第二章：转义字符" class="headerlink" title="第二章：转义字符"></a>第二章：转义字符</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 常用转义字符示例</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"line1 \</span></span><br><span class="line"><span class="string">line2 \</span></span><br><span class="line"><span class="string">line3"</span>)  <span class="comment"># 续行符，用于多行字符串</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\\"</span>)  <span class="comment"># 反斜杠符号 </span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'\''</span>)  <span class="comment"># 单引号</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\""</span>)  <span class="comment"># 双引号</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\a"</span>)  <span class="comment"># 响铃符号（某些终端会发声）</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Hello \b World!"</span>)  <span class="comment"># 退格符（删除前一个字符）</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\000"</span>)  <span class="comment"># 空字符（ASCII码为0）</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Hello\nWorld"</span>)  <span class="comment"># 换行符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Hello\tWorld"</span>)  <span class="comment"># 水平制表符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Hello\rWorld"</span>)  <span class="comment"># 回车符（将光标移到行首）</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\f"</span>)  <span class="comment"># 换页符</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 八进制和十六进制表示</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\110\145\154\154\157"</span>)  <span class="comment"># 八进制表示"Hello"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\x48\x65\x6c\x6c\x6f"</span>)  <span class="comment"># 十六进制表示"Hello"</span></span><br></pre></td></tr></tbody></table></figure><h2 id="第三章：运算符"><a href="#第三章：运算符" class="headerlink" title="第三章：运算符"></a>第三章：运算符</h2><h3 id="运算符优先级"><a href="#运算符优先级" class="headerlink" title="运算符优先级"></a>运算符优先级</h3><p>加减乘除 &gt; 比较 &gt; not &gt; and &gt; or</p><h3 id="运算符表"><a href="#运算符表" class="headerlink" title="运算符表"></a>运算符表</h3><table><thead><tr><th>类型</th><th>运算符</th><th>描述</th></tr></thead><tbody><tr><td>算术运算符</td><td>+, -, *, /, //, %, **</td><td>加、减、乘、除、整除、取模、幂</td></tr><tr><td>比较运算符</td><td>==, !=, &gt;, &lt;, &gt; =, &lt;=</td><td>等于、不等于、大于、小于、大于等于、小于等于</td></tr><tr><td>逻辑运算符</td><td>and, or, not</td><td>逻辑与、逻辑或、逻辑非</td></tr><tr><td>位运算符</td><td>&amp;, |, ^, ~, &lt;&lt;, &gt; &gt;</td><td>按位与、按位或、按位异或、按位取反、左移、右移</td></tr><tr><td>赋值运算符</td><td>=, +=, -=, *=, /=, //=, %= 等</td><td>简单赋值、复合赋值</td></tr><tr><td>身份运算符</td><td>is, is not</td><td>判断对象标识</td></tr><tr><td>成员运算符</td><td>in, not in</td><td>判断成员关系</td></tr></tbody></table><h3 id="赋值技巧"><a href="#赋值技巧" class="headerlink" title="赋值技巧"></a>赋值技巧</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不换行输出</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span>, end=<span class="string">' '</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">2</span>, end=<span class="string">' '</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">3</span>, end=<span class="string">' '</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增量赋值</span></span><br><span class="line">n += <span class="number">1</span>  <span class="comment"># 等价于 n = n + 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 链式赋值（同值多变量）</span></span><br><span class="line">x = y = z = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 交叉赋值（交换变量值）</span></span><br><span class="line">m, n = <span class="number">10</span>, <span class="number">20</span></span><br><span class="line">m, n = n, m  <span class="comment"># 交换值</span></span><br></pre></td></tr></tbody></table></figure><h2 id="第四章：类型转换详解"><a href="#第四章：类型转换详解" class="headerlink" title="第四章：类型转换详解"></a>第四章：类型转换详解</h2><h3 id="4-1-基本数据类型转换"><a href="#4-1-基本数据类型转换" class="headerlink" title="4.1 基本数据类型转换"></a>4.1 基本数据类型转换</h3><h4 id="整型转换-int"><a href="#整型转换-int" class="headerlink" title="整型转换 int()"></a>整型转换 <code>int()</code></h4><blockquote><p>最常用的一种转换类型，通过 <code>int（）</code> 可以实现进制之间的快速转换，而无需调用函数</p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本转换</span></span><br><span class="line"><span class="built_in">int</span>(<span class="number">3.14</span>)       <span class="comment"># 3 (截断小数部分，不是四舍五入)</span></span><br><span class="line"><span class="built_in">int</span>(-<span class="number">3.9</span>)       <span class="comment"># -3 (向零截断)</span></span><br><span class="line"><span class="built_in">int</span>(<span class="string">"42"</span>)       <span class="comment"># 42 (字符串必须表示有效的数字)</span></span><br><span class="line"><span class="built_in">int</span>(<span class="string">"0xFF"</span>, <span class="number">16</span>) <span class="comment"># 255 (可以指定进制，默认为10进制)</span></span><br><span class="line"><span class="built_in">int</span>(<span class="string">"101"</span>, <span class="number">2</span>)   <span class="comment"># 5 (二进制转十进制)</span></span><br><span class="line"><span class="built_in">int</span>(<span class="literal">True</span>)       <span class="comment"># 1</span></span><br><span class="line"><span class="built_in">int</span>(<span class="literal">False</span>)      <span class="comment"># 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换失败的情况</span></span><br><span class="line"><span class="comment"># int("3.14")   # ValueError: invalid literal for int() with base 10</span></span><br><span class="line"><span class="comment"># int("hello")  # ValueError: invalid literal for int() with base 10</span></span><br><span class="line"><span class="comment"># int([1, 2])   # TypeError: int() argument must be a string, a bytes-like object or a real number</span></span><br></pre></td></tr></tbody></table></figure><h4 id="浮点型转换-float"><a href="#浮点型转换-float" class="headerlink" title="浮点型转换 float()"></a>浮点型转换 <code>float()</code></h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本转换</span></span><br><span class="line"><span class="built_in">float</span>(<span class="number">42</span>)       <span class="comment"># 42.0</span></span><br><span class="line"><span class="built_in">float</span>(<span class="string">"3.14"</span>)   <span class="comment"># 3.14</span></span><br><span class="line"><span class="built_in">float</span>(<span class="string">"42"</span>)     <span class="comment"># 42.0</span></span><br><span class="line"><span class="built_in">float</span>(<span class="string">"-3.14e2"</span>)<span class="comment"># -314.0 (支持科学计数法)</span></span><br><span class="line"><span class="built_in">float</span>(<span class="string">"inf"</span>)    <span class="comment"># inf (无穷大)</span></span><br><span class="line"><span class="built_in">float</span>(<span class="string">"-inf"</span>)   <span class="comment"># -inf (负无穷大)</span></span><br><span class="line"><span class="built_in">float</span>(<span class="string">"nan"</span>)    <span class="comment"># nan (非数值)</span></span><br><span class="line"><span class="built_in">float</span>(<span class="literal">True</span>)     <span class="comment"># 1.0</span></span><br><span class="line"><span class="built_in">float</span>(<span class="literal">False</span>)    <span class="comment"># 0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换失败的情况</span></span><br><span class="line"><span class="comment"># float("hello") # ValueError: could not convert string to float: 'hello'</span></span><br><span class="line"><span class="comment"># float([1, 2])  # TypeError: float() argument must be a string or a real number</span></span><br></pre></td></tr></tbody></table></figure><h4 id="字符串转换-str"><a href="#字符串转换-str" class="headerlink" title="字符串转换 str()"></a>字符串转换 <code>str()</code></h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本转换 - 几乎任何Python对象都可以转为字符串</span></span><br><span class="line"><span class="built_in">str</span>(<span class="number">42</span>)  <span class="comment"># '42'</span></span><br><span class="line"><span class="built_in">str</span>(<span class="number">3.14</span>)  <span class="comment"># '3.14'</span></span><br><span class="line"><span class="built_in">str</span>(<span class="literal">True</span>)  <span class="comment"># 'True'</span></span><br><span class="line"><span class="built_in">str</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])  <span class="comment"># '[1, 2, 3]'</span></span><br><span class="line"><span class="built_in">str</span>({<span class="string">'name'</span>: <span class="string">'John'</span>})  <span class="comment"># "{'name': 'John'}"</span></span><br><span class="line"><span class="built_in">str</span>(<span class="literal">None</span>)  <span class="comment"># 'None'</span></span><br></pre></td></tr></tbody></table></figure><h4 id="布尔值转换-bool"><a href="#布尔值转换-bool" class="headerlink" title="布尔值转换 bool()"></a>布尔值转换 <code>bool()</code></h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本转换规则：空值或零值转为False，其他为True</span></span><br><span class="line"><span class="built_in">bool</span>(<span class="number">0</span>)          <span class="comment"># False</span></span><br><span class="line"><span class="built_in">bool</span>(<span class="number">0.0</span>)        <span class="comment"># False</span></span><br><span class="line"><span class="built_in">bool</span>(<span class="string">""</span>)         <span class="comment"># False</span></span><br><span class="line"><span class="built_in">bool</span>([])         <span class="comment"># False</span></span><br><span class="line"><span class="built_in">bool</span>({})         <span class="comment"># False</span></span><br><span class="line"><span class="built_in">bool</span>(<span class="built_in">set</span>())      <span class="comment"># False</span></span><br><span class="line"><span class="built_in">bool</span>(())         <span class="comment"># False</span></span><br><span class="line"><span class="built_in">bool</span>(<span class="literal">None</span>)       <span class="comment"># False</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">bool</span>(<span class="number">1</span>)          <span class="comment"># True</span></span><br><span class="line"><span class="built_in">bool</span>(-<span class="number">1</span>)         <span class="comment"># True</span></span><br><span class="line"><span class="built_in">bool</span>(<span class="number">0.1</span>)        <span class="comment"># True</span></span><br><span class="line"><span class="built_in">bool</span>(<span class="string">"hello"</span>)    <span class="comment"># True</span></span><br><span class="line"><span class="built_in">bool</span>([<span class="number">0</span>])        <span class="comment"># True</span></span><br><span class="line"><span class="built_in">bool</span>({<span class="number">0</span>: <span class="number">0</span>})     <span class="comment"># True</span></span><br></pre></td></tr></tbody></table></figure><h3 id="4-2-集合类型转换"><a href="#4-2-集合类型转换" class="headerlink" title="4.2 集合类型转换"></a>4.2 集合类型转换</h3><h4 id="列表转换-list"><a href="#列表转换-list" class="headerlink" title="列表转换 list()"></a>列表转换 <code>list()</code></h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从其他可迭代对象创建列表</span></span><br><span class="line"><span class="built_in">list</span>(<span class="string">"hello"</span>)           <span class="comment"># ['h', 'e', 'l', 'l', 'o']</span></span><br><span class="line"><span class="built_in">list</span>((<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))         <span class="comment"># [1, 2, 3]</span></span><br><span class="line"><span class="built_in">list</span>({<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>})         <span class="comment"># [1, 2, 3] (集合转列表，顺序不确定)</span></span><br><span class="line"><span class="built_in">list</span>({<span class="string">"a"</span>: <span class="number">1</span>, <span class="string">"b"</span>: <span class="number">2</span>})  <span class="comment"># ['a', 'b'] (字典转列表，获取所有键)</span></span><br><span class="line"><span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">5</span>))          <span class="comment"># [0, 1, 2, 3, 4]</span></span><br></pre></td></tr></tbody></table></figure><h4 id="元组转换-tuple"><a href="#元组转换-tuple" class="headerlink" title="元组转换 tuple()"></a>元组转换 <code>tuple()</code></h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从其他可迭代对象创建元组</span></span><br><span class="line"><span class="built_in">tuple</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])        <span class="comment"># (1, 2, 3)</span></span><br><span class="line"><span class="built_in">tuple</span>(<span class="string">"hello"</span>)          <span class="comment"># ('h', 'e', 'l', 'l', 'o')</span></span><br><span class="line"><span class="built_in">tuple</span>({<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>})        <span class="comment"># (1, 2, 3) (集合转元组，顺序不确定)</span></span><br><span class="line"><span class="built_in">tuple</span>({<span class="string">"a"</span>: <span class="number">1</span>, <span class="string">"b"</span>: <span class="number">2</span>}) <span class="comment"># ('a', 'b') (字典转元组，获取所有键)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 特殊情况：创建空元组和单元素元组</span></span><br><span class="line">empty_tuple = ()</span><br><span class="line">single_element_tuple = (<span class="number">42</span>,)  <span class="comment"># 注意逗号是必需的</span></span><br></pre></td></tr></tbody></table></figure><h4 id="集合转换-set"><a href="#集合转换-set" class="headerlink" title="集合转换 set()"></a>集合转换 <code>set()</code></h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从其他可迭代对象创建集合（自动去重）</span></span><br><span class="line"><span class="built_in">set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>]) <span class="comment"># {1, 2, 3}</span></span><br><span class="line"><span class="built_in">set</span>(<span class="string">"hello"</span>)            <span class="comment"># {'h', 'e', 'l', 'o'}</span></span><br><span class="line"><span class="built_in">set</span>((<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>))       <span class="comment"># {1, 2, 3}</span></span><br><span class="line"><span class="built_in">set</span>({<span class="string">"a"</span>: <span class="number">1</span>, <span class="string">"b"</span>: <span class="number">2</span>})   <span class="comment"># {'a', 'b'} (字典转集合，获取所有键)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用：列表去重</span></span><br><span class="line">unique_items = <span class="built_in">list</span>(<span class="built_in">set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>]))  <span class="comment"># [1, 2, 3] (顺序可能变化)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建空集合</span></span><br><span class="line">empty_set = <span class="built_in">set</span>()  <span class="comment"># 不能用{}，那会创建空字典</span></span><br></pre></td></tr></tbody></table></figure><h4 id="字典转换-dict"><a href="#字典转换-dict" class="headerlink" title="字典转换 dict()"></a>字典转换 <code>dict()</code></h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从键值对创建字典</span></span><br><span class="line"><span class="built_in">dict</span>([(<span class="string">'a'</span>, <span class="number">1</span>), (<span class="string">'b'</span>, <span class="number">2</span>)])  <span class="comment"># {'a': 1, 'b': 2}</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从两个等长序列创建字典</span></span><br><span class="line">keys = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line">values = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="built_in">dict</span>(<span class="built_in">zip</span>(keys, values))     <span class="comment"># {'a': 1, 'b': 2, 'c': 3}</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用关键字参数创建字典</span></span><br><span class="line"><span class="built_in">dict</span>(a=<span class="number">1</span>, b=<span class="number">2</span>, c=<span class="number">3</span>)        <span class="comment"># {'a': 1, 'b': 2, 'c': 3}</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并两个字典 (Python 3.9+)</span></span><br><span class="line">dict1 = {<span class="string">'a'</span>: <span class="number">1</span>, <span class="string">'b'</span>: <span class="number">2</span>}</span><br><span class="line">dict2 = {<span class="string">'c'</span>: <span class="number">3</span>, <span class="string">'d'</span>: <span class="number">4</span>}</span><br><span class="line">dict1 | dict2              <span class="comment"># {'a': 1, 'b': 2, 'c': 3, 'd': 4}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="4-3-进阶类型转换"><a href="#4-3-进阶类型转换" class="headerlink" title="4.3 进阶类型转换"></a>4.3 进阶类型转换</h3><h4 id="字节转换-bytes-和-bytearray"><a href="#字节转换-bytes-和-bytearray" class="headerlink" title="字节转换 bytes() 和 bytearray()"></a>字节转换 <code>bytes()</code> 和 <code>bytearray()</code></h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 字符串转字节</span></span><br><span class="line"><span class="built_in">bytes</span>(<span class="string">"hello"</span>, <span class="string">"utf-8"</span>)    <span class="comment"># b'hello'</span></span><br><span class="line"><span class="built_in">bytes</span>(<span class="string">"你好"</span>, <span class="string">"utf-8"</span>)     <span class="comment"># b'\xe4\xbd\xa0\xe5\xa5\xbd'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 整数列表转字节</span></span><br><span class="line"><span class="built_in">bytes</span>([<span class="number">65</span>, <span class="number">66</span>, <span class="number">67</span>])        <span class="comment"># b'ABC'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建指定长度的空字节序列</span></span><br><span class="line"><span class="built_in">bytes</span>(<span class="number">5</span>)                   <span class="comment"># b'\x00\x00\x00\x00\x00'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bytearray是可变版本的bytes</span></span><br><span class="line">ba = <span class="built_in">bytearray</span>(<span class="string">"hello"</span>, <span class="string">"utf-8"</span>)  <span class="comment"># bytearray(b'hello')</span></span><br><span class="line">ba[<span class="number">0</span>] = <span class="number">72</span>                        <span class="comment"># 修改第一个字节为'H'</span></span><br><span class="line"><span class="built_in">print</span>(ba)                         <span class="comment"># bytearray(b'Hello')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字节转回字符串</span></span><br><span class="line"><span class="string">b"hello"</span>.decode(<span class="string">"utf-8"</span>)          <span class="comment"># 'hello'</span></span><br><span class="line"><span class="built_in">bytearray</span>(<span class="string">b"hello"</span>).decode(<span class="string">"utf-8"</span>) <span class="comment"># 'hello'</span></span><br></pre></td></tr></tbody></table></figure><h3 id="4-4-实用转换场景与技巧"><a href="#4-4-实用转换场景与技巧" class="headerlink" title="4.4 实用转换场景与技巧"></a>4.4 实用转换场景与技巧</h3><h4 id="数字和字符串之间的转换"><a href="#数字和字符串之间的转换" class="headerlink" title="数字和字符串之间的转换"></a>数字和字符串之间的转换</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 格式化数字为字符串</span></span><br><span class="line"><span class="built_in">str</span>(<span class="number">1234</span>)                  <span class="comment"># '1234'</span></span><br><span class="line"><span class="string">"{:,}"</span>.<span class="built_in">format</span>(<span class="number">1234567.89</span>)  <span class="comment"># '1,234,567.89' (添加千位分隔符)</span></span><br><span class="line"><span class="string">"{:.2f}"</span>.<span class="built_in">format</span>(<span class="number">3.14159</span>)   <span class="comment"># '3.14' (保留2位小数)</span></span><br><span class="line"><span class="string">f"<span class="subst">{<span class="number">123.456</span>:<span class="number">.2</span>e}</span>"</span>           <span class="comment"># '1.23e+02' (科学计数法)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析数字字符串</span></span><br><span class="line"><span class="built_in">int</span>(<span class="string">"1234"</span>)                <span class="comment"># 1234</span></span><br><span class="line"><span class="built_in">float</span>(<span class="string">"3.14"</span>)              <span class="comment"># 3.14</span></span><br><span class="line"><span class="built_in">float</span>(<span class="string">"1.23e45"</span>)           <span class="comment"># 1.23e+45</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理货币字符串</span></span><br><span class="line">price = <span class="string">"$1,234.56"</span></span><br><span class="line"><span class="built_in">float</span>(price.replace(<span class="string">"$"</span>, <span class="string">""</span>).replace(<span class="string">","</span>, <span class="string">""</span>))  <span class="comment"># 1234.56</span></span><br></pre></td></tr></tbody></table></figure><h4 id="数据类型检测与安全转换"><a href="#数据类型检测与安全转换" class="headerlink" title="数据类型检测与安全转换"></a>数据类型检测与安全转换</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安全地转换为整数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_int</span>(<span class="params">value,default=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(value)</span><br><span class="line">    <span class="keyword">except</span> (ValueError,TypeError):</span><br><span class="line">        <span class="keyword">return</span> default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(safe_int(<span class="string">"123"</span>))  <span class="comment"># 123</span></span><br><span class="line"><span class="built_in">print</span>(safe_int(<span class="string">"abc"</span>))   <span class="comment"># 0</span></span><br><span class="line"><span class="built_in">print</span>(safe_int(<span class="literal">None</span>))   <span class="comment"># 0</span></span><br><span class="line"><span class="built_in">print</span>(safe_int(<span class="string">"456"</span>, <span class="number">100</span>))   <span class="comment"># 456</span></span><br><span class="line"><span class="built_in">print</span>(safe_int(<span class="string">"xyz"</span>, <span class="number">100</span>))   <span class="comment"># 100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================================================================================</span></span><br></pre></td></tr></tbody></table></figure><h4 id="类型转换与数据验证"><a href="#类型转换与数据验证" class="headerlink" title="类型转换与数据验证"></a>类型转换与数据验证</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证并转换输入数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_age</span>(<span class="params">age_str</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        age = <span class="built_in">int</span>(age_str) <span class="comment"># 尝试将字符串转换为整数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt;= age &lt;= <span class="number">120</span>: <span class="comment"># 验证年龄是否在0到120之间</span></span><br><span class="line">            <span class="keyword">return</span> age <span class="comment"># 若年龄有效，则返回年龄</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"年龄必须在0到120之间"</span>) <span class="comment"># 若年龄无效，则抛出异常</span></span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"无效的年龄格式"</span>) <span class="comment"># 若输入的年龄不是整数，则抛出异常</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 适用于表单验证</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_form</span>(<span class="params">form_data</span>):</span><br><span class="line">    errors = {}</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 验证和转换名称</span></span><br><span class="line">    name = form_data.get(<span class="string">"name"</span>,<span class="string">""</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> name:</span><br><span class="line">        errors[<span class="string">"name"</span>] = <span class="string">"请输入姓名"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#验证和转换年龄</span></span><br><span class="line">    age_str = form_data.get(<span class="string">"age"</span>,<span class="string">""</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        age = validate_age(age_str)</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        errors[<span class="string">"age"</span>] = <span class="built_in">str</span>(e) <span class="comment"># 把异常信息转换为字符串</span></span><br><span class="line">    <span class="keyword">return</span> errors <span class="keyword">or</span> <span class="literal">None</span> <span class="comment"># 如果errors为空，则返回None，否则返回errors</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">form_data = {</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"张三"</span>,</span><br><span class="line">    <span class="string">"age"</span>: <span class="string">""</span></span><br><span class="line">}</span><br><span class="line"><span class="built_in">print</span>(validate_form(form_data)) <span class="comment"># 输出：{'age': '无效的年龄格式'}</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="4-5-类型转换陷阱与最佳实践"><a href="#4-5-类型转换陷阱与最佳实践" class="headerlink" title="4.5 类型转换陷阱与最佳实践"></a>4.5 类型转换陷阱与最佳实践</h3><h4 id="常见陷阱"><a href="#常见陷阱" class="headerlink" title="常见陷阱"></a>常见陷阱</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 精度损失</span></span><br><span class="line"><span class="built_in">int</span>(<span class="number">3.99999</span>)  <span class="comment"># 3 (信息丢失)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 截断而非四舍五入</span></span><br><span class="line"><span class="built_in">int</span>(<span class="number">3.6</span>)  <span class="comment"># 3 (很多新手误以为会四舍五入)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 不安全的eval</span></span><br><span class="line">user_input = <span class="string">"1 + 1"</span></span><br><span class="line"><span class="built_in">eval</span>(user_input)  <span class="comment"># 2 (安全)</span></span><br><span class="line"></span><br><span class="line">user_input = <span class="string">"__import__('os').system('rm -rf 防止手残')"</span> </span><br><span class="line"><span class="comment"># eval(user_input)  # 危险！可以执行任意代码，执行rm -rf / 会导致整个系统被删除</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 大数字字符串转换性能问题</span></span><br><span class="line">very_large_num = <span class="string">"9"</span> * <span class="number">1000000</span></span><br><span class="line"><span class="comment"># int(very_large_num)  # 会很慢并占用大量内存</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 浮点数精度问题</span></span><br><span class="line"><span class="built_in">float</span>(<span class="string">"0.1"</span>) + <span class="built_in">float</span>(<span class="string">"0.2"</span>) != <span class="built_in">float</span>(<span class="string">"0.3"</span>)  <span class="comment"># True，因为浮点精度问题</span></span><br></pre></td></tr></tbody></table></figure><h2 id="第五章：数据类型"><a href="#第五章：数据类型" class="headerlink" title="第五章：数据类型"></a>第五章：数据类型</h2><h3 id="5-1-字符串类型-str"><a href="#5-1-字符串类型-str" class="headerlink" title="5.1 字符串类型(str)"></a>5.1 字符串类型(str)</h3><h4 id="字符串输出方式"><a href="#字符串输出方式" class="headerlink" title="字符串输出方式"></a>字符串输出方式</h4><table><thead><tr><th><code>占位符类型</code></th><th>说明</th></tr></thead><tbody><tr><td><code>%s</code></td><td>字符串（使用 <code>str()</code> 方法转换任何 Python 对象）</td></tr><tr><td><code>%d</code></td><td>十进制整数</td></tr><tr><td><code>%f</code></td><td>十进制浮点数(小数), 自动保留六位小数。</td></tr></tbody></table><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 占位符方式</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'我的名字是 %s, 我的年龄是 %d岁'</span> % (<span class="string">'小明'</span>, <span class="number">28</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#    </span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'我的名字是 {}, 我的年龄是 {}岁'</span>.<span class="built_in">format</span>(<span class="string">'小明'</span>, <span class="number">28</span>))</span><br><span class="line"><span class="comment"># format带索引</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'我的名字是 {1}, 我的年龄是 {0}岁'</span>.<span class="built_in">format</span>(<span class="number">28</span>, <span class="string">'小明'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># f-string方式(推荐)</span></span><br><span class="line">name = <span class="string">'小明'</span></span><br><span class="line">age = <span class="number">28</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f'我的名字是 <span class="subst">{name}</span>, 我的年龄是 <span class="subst">{age}</span>岁'</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="字符串常用方法"><a href="#字符串常用方法" class="headerlink" title="字符串常用方法"></a>字符串常用方法</h4><table><thead><tr><th>方法</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>startswith()</td><td>判断是否以指定内容开头</td><td><code>str.startswith('hello')</code></td></tr><tr><td>endswith()</td><td>判断是否以指定内容结尾</td><td><code>str.endswith('world')</code></td></tr><tr><td>isdigit()</td><td>判断是否为数字组成</td><td><code>'12345'.isdigit()</code></td></tr><tr><td>isalpha()</td><td>判断是否为文字组成</td><td><code>'hello'.isalpha()</code></td></tr><tr><td>count()</td><td>统计元素出现次数</td><td><code>'hello'.count('l')</code></td></tr><tr><td>find()</td><td>查找子串位置，未找到返回-1</td><td><code>'hello world'.find('world')</code></td></tr><tr><td>upper()</td><td>转为大写</td><td><code>'hello'.upper()</code></td></tr><tr><td>lower()</td><td>转为小写</td><td><code>'HELLO'.lower()</code></td></tr><tr><td>replace()</td><td>替换字符串</td><td><code>'hello'.replace('h', 'H')</code></td></tr><tr><td>split()</td><td>分割字符串为列表</td><td><code>'a,b,c'.split(',')</code></td></tr><tr><td>join()</td><td>拼接列表为字符串</td><td><code>','.join(['a', 'b', 'c'])</code></td></tr><tr><td>strip()</td><td>去除两端空格或指定字符</td><td><code>' hello '.strip()</code></td></tr><tr><td>lstrip()</td><td>去除左侧空格或指定字符</td><td><code>' hello'.lstrip()</code></td></tr><tr><td>rstrip()</td><td>去除右侧空格或指定字符</td><td><code>'hello '.rstrip()</code></td></tr><tr><td>title()</td><td>将字符串标题化</td><td><code>'hello world'.title()</code></td></tr></tbody></table><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ======== 字符串方法示例 ========</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># startswith() - 判断是否以指定内容开头</span></span><br><span class="line">text = <span class="string">"Hello, World!"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'Hello, World!' 是否以'Hello'开头: <span class="subst">{text.startswith(<span class="string">'Hello'</span>)}</span>"</span>)  <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'Hello, World!' 是否以'World'开头: <span class="subst">{text.startswith(<span class="string">'World'</span>)}</span>"</span>)  <span class="comment"># False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># endswith() - 判断是否以指定内容结尾</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'Hello, World!' 是否以'!'结尾: <span class="subst">{text.endswith(<span class="string">'!'</span>)}</span>"</span>)  <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'Hello, World!' 是否以'Hello'结尾: <span class="subst">{text.endswith(<span class="string">'Hello'</span>)}</span>"</span>)  <span class="comment"># False</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># isdigit() - 判断是否为数字组成</span></span><br><span class="line">num_str = <span class="string">"12345"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'12345' 是否全为数字: <span class="subst">{num_str.isdigit()}</span>"</span>)  <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'Hello' 是否全为数字: <span class="subst">{<span class="string">'Hello'</span>.isdigit()}</span>"</span>)  <span class="comment"># False</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># isalpha() - 判断是否为文字组成</span></span><br><span class="line">alpha_str = <span class="string">"hello"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'hello' 是否全为字母: <span class="subst">{alpha_str.isalpha()}</span>"</span>)  <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'hello123' 是否全为字母: <span class="subst">{<span class="string">'hello123'</span>.isalpha()}</span>"</span>)  <span class="comment"># False</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># count() - 统计元素出现次数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'hello' 中 'l' 出现的次数: <span class="subst">{<span class="string">'hello'</span>.count(<span class="string">'l'</span>)}</span>"</span>)  <span class="comment"># 2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'Mississippi' 中 's' 出现的次数: <span class="subst">{<span class="string">'Mississippi'</span>.count(<span class="string">'s'</span>)}</span>"</span>)  <span class="comment"># 4</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># find() - 查找子串位置，未找到返回-1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'hello world' 中 'world' 的位置: <span class="subst">{<span class="string">'hello world'</span>.find(<span class="string">'world'</span>)}</span>"</span>)  <span class="comment"># 6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'hello world' 中 'python' 的位置: <span class="subst">{<span class="string">'hello world'</span>.find(<span class="string">'python'</span>)}</span>"</span>)  <span class="comment"># -1</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># upper() - 转为大写</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'hello' 转大写: <span class="subst">{<span class="string">'hello'</span>.upper()}</span>"</span>)  <span class="comment"># HELLO</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># lower() - 转为小写</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'HELLO' 转小写: <span class="subst">{<span class="string">'HELLO'</span>.lower()}</span>"</span>)  <span class="comment"># hello</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># replace() - 替换字符串</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'hello' 替换 'h' 为 'H': <span class="subst">{<span class="string">'hello'</span>.replace(<span class="string">'h'</span>, <span class="string">'H'</span>)}</span>"</span>)  <span class="comment"># Hello</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'hello hello' 替换所有 'l' 为 'L': <span class="subst">{<span class="string">'hello hello'</span>.replace(<span class="string">'l'</span>, <span class="string">'L'</span>)}</span>"</span>)  <span class="comment"># heLLo heLLo</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># split() - 分割字符串为列表</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'a,b,c' 按逗号分割: <span class="subst">{<span class="string">'a,b,c'</span>.split(<span class="string">','</span>)}</span>"</span>)  <span class="comment"># ['a', 'b', 'c']</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'hello world' 按空格分割: <span class="subst">{<span class="string">'hello world'</span>.split()}</span>"</span>)  <span class="comment"># ['hello', 'world']</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># join() - 拼接列表为字符串</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"用逗号连接 ['a', 'b', 'c']: <span class="subst">{<span class="string">','</span>.join([<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>])}</span>"</span>)  <span class="comment"># a,b,c</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"用空格连接 ['hello', 'world']: <span class="subst">{<span class="string">' '</span>.join([<span class="string">'hello'</span>, <span class="string">'world'</span>])}</span>"</span>)  <span class="comment"># hello world</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># strip() - 去除两端空格或指定字符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"' hello ' 去除两端空格: <span class="subst">{<span class="string">' hello '</span>.strip()}</span>"</span>)  <span class="comment"># hello</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'xxxhelloxxx' 去除两端的x: <span class="subst">{<span class="string">'xxxhelloxxx'</span>.strip(<span class="string">'x'</span>)}</span>"</span>)  <span class="comment"># hello</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># lstrip() - 去除左侧空格或指定字符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"' hello' 去除左侧空格: <span class="subst">{<span class="string">' hello'</span>.lstrip()}</span>"</span>)  <span class="comment"># hello</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'xxxhello' 去除左侧的x: <span class="subst">{<span class="string">'xxxhello'</span>.lstrip(<span class="string">'x'</span>)}</span>"</span>)  <span class="comment"># hello</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># rstrip() - 去除右侧空格或指定字符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'hello ' 去除右侧空格: <span class="subst">{<span class="string">'hello '</span>.rstrip()}</span>"</span>)  <span class="comment"># hello</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'helloxxx' 去除右侧的x: <span class="subst">{<span class="string">'helloxxx'</span>.rstrip(<span class="string">'x'</span>)}</span>"</span>)  <span class="comment"># hello</span></span><br><span class="line"><span class="comment"># ======== ======== ======== ======== ======== ======== ======== ======== ======== ========</span></span><br><span class="line"><span class="comment"># title() - 将字符串标题化（每个单词首字母大写）</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"'hello world' 标题化: <span class="subst">{<span class="string">'hello world'</span>.title()}</span>"</span>)  <span class="comment"># Hello World</span></span><br></pre></td></tr></tbody></table></figure><h3 id="5-2-列表类型-list"><a href="#5-2-列表类型-list" class="headerlink" title="5.2 列表类型(list)"></a>5.2 列表类型(list)</h3><h4 id="添加元素"><a href="#添加元素" class="headerlink" title="添加元素"></a>添加元素</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># append()：在列表末尾添加元素</span></span><br><span class="line">l = [<span class="string">'Python'</span>, <span class="string">'C++'</span>, <span class="string">'Java'</span>]</span><br><span class="line">l.append(<span class="string">'PHP'</span>)  <span class="comment"># ['Python', 'C++', 'Java', 'PHP']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># extend()：批量添加元素，逐一添加</span></span><br><span class="line">l = [<span class="string">'Python'</span>, <span class="string">'C++'</span>, <span class="string">'Java'</span>]</span><br><span class="line">l.extend([<span class="string">'C#'</span>, <span class="string">'C'</span>, <span class="string">'JavaScript'</span>])  <span class="comment"># ['Python', 'C++', 'Java', 'C#', 'C', 'JavaScript']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># insert()：在指定位置插入元素</span></span><br><span class="line">l = [<span class="string">'Python'</span>, <span class="string">'C++'</span>, <span class="string">'Java'</span>]</span><br><span class="line">l.insert(<span class="number">1</span>, <span class="string">'C'</span>)  <span class="comment"># ['Python', 'C', 'C++', 'Java']</span></span><br></pre></td></tr></tbody></table></figure><h4 id="删除元素"><a href="#删除元素" class="headerlink" title="删除元素"></a>删除元素</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># remove()：删除指定元素（第一个匹配项）</span></span><br><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line">nums.remove(<span class="number">36</span>)  <span class="comment"># [40, 89, 2, 36, 100, 7]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pop()：删除指定索引元素，返回被删除的元素</span></span><br><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line">nums.pop(<span class="number">3</span>)  <span class="comment"># [40, 36, 89, 36, 100, 7]</span></span><br><span class="line">nums.pop()   <span class="comment"># 不指定索引，默认删除最后一个</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># clear()：清空列表</span></span><br><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line">nums.clear()  <span class="comment"># []</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># del：删除指定元素或切片</span></span><br><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line"><span class="keyword">del</span> nums[<span class="number">2</span>]    <span class="comment"># 删除单个元素</span></span><br><span class="line"><span class="keyword">del</span> nums[:<span class="number">2</span>]   <span class="comment"># 删除切片范围的元素</span></span><br></pre></td></tr></tbody></table></figure><h4 id="查找元素"><a href="#查找元素" class="headerlink" title="查找元素"></a>查找元素</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># index()：查找元素索引</span></span><br><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>]</span><br><span class="line"><span class="built_in">print</span>(nums.index(<span class="number">36</span>))  <span class="comment"># 返回第一个匹配元素的索引：1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># in 运算符：判断元素是否存在</span></span><br><span class="line"><span class="keyword">if</span> <span class="number">89</span> <span class="keyword">in</span> nums:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"元素存在"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># enumerate()：同时获取索引和元素</span></span><br><span class="line"><span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">enumerate</span>(nums):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"索引 <span class="subst">{index}</span>: 值 <span class="subst">{value}</span>"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># count()：统计元素出现次数</span></span><br><span class="line"><span class="built_in">print</span>(nums.count(<span class="number">36</span>))  <span class="comment"># 返回元素出现次数：2</span></span><br></pre></td></tr></tbody></table></figure><h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sort()：原地排序</span></span><br><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line">nums.sort()  <span class="comment"># [2, 7, 36, 40, 89, 100]</span></span><br><span class="line">nums.sort(reverse=<span class="literal">True</span>)  <span class="comment"># 降序：[100, 89, 40, 36, 7, 2]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sorted()：返回新列表，原列表不变</span></span><br><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line">sorted_nums = <span class="built_in">sorted</span>(nums)  <span class="comment"># [2, 7, 36, 40, 89, 100]</span></span><br><span class="line"><span class="built_in">print</span>(nums)  <span class="comment"># 原列表不变：[40, 36, 89, 2, 100, 7]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义排序（按字符串长度）,key可以编写一个匿名函数作为条件</span></span><br><span class="line">words = [<span class="string">'apple'</span>, <span class="string">'banana'</span>, <span class="string">'cherry'</span>, <span class="string">'date'</span>]</span><br><span class="line">sorted_words = <span class="built_in">sorted</span>(words, key=<span class="built_in">len</span>)  <span class="comment"># ['date', 'apple', 'cherry', 'banana']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用sorted函数结合lambda函数进行复杂排序</span></span><br><span class="line"><span class="comment"># 创建一个包含学生信息的列表（姓名、年龄、成绩、是否参加课外活动）</span></span><br><span class="line">students = [</span><br><span class="line">    {<span class="string">"name"</span>: <span class="string">"张三"</span>, <span class="string">"age"</span>: <span class="number">18</span>, <span class="string">"score"</span>: <span class="number">85</span>, <span class="string">"extracurricular"</span>: <span class="literal">True</span>},</span><br><span class="line">    {<span class="string">"name"</span>: <span class="string">"李四"</span>, <span class="string">"age"</span>: <span class="number">17</span>, <span class="string">"score"</span>: <span class="number">92</span>, <span class="string">"extracurricular"</span>: <span class="literal">False</span>},</span><br><span class="line">    {<span class="string">"name"</span>: <span class="string">"王五"</span>, <span class="string">"age"</span>: <span class="number">19</span>, <span class="string">"score"</span>: <span class="number">78</span>, <span class="string">"extracurricular"</span>: <span class="literal">True</span>},</span><br><span class="line">    {<span class="string">"name"</span>: <span class="string">"赵六"</span>, <span class="string">"age"</span>: <span class="number">18</span>, <span class="string">"score"</span>: <span class="number">85</span>, <span class="string">"extracurricular"</span>: <span class="literal">False</span>},</span><br><span class="line">    {<span class="string">"name"</span>: <span class="string">"钱七"</span>, <span class="string">"age"</span>: <span class="number">20</span>, <span class="string">"score"</span>: <span class="number">90</span>, <span class="string">"extracurricular"</span>: <span class="literal">True</span>}</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基本排序：按照学生成绩从高到低排序</span></span><br><span class="line"><span class="comment"># lambda x: x["score"] - 定义一个匿名函数，接收一个参数x（列表中的每个元素），返回x的score值</span></span><br><span class="line"><span class="comment"># reverse=True - 表示降序排序（从高到低）</span></span><br><span class="line">sorted_by_score = <span class="built_in">sorted</span>(students, key=<span class="keyword">lambda</span> x: x[<span class="string">"score"</span>], reverse=<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"按照学生成绩从高到低排序："</span>)</span><br><span class="line"><span class="keyword">for</span> student <span class="keyword">in</span> sorted_by_score:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"姓名：<span class="subst">{student[<span class="string">'name'</span>]}</span>，年龄：<span class="subst">{student[<span class="string">'age'</span>]}</span>，学生成绩：<span class="subst">{student[<span class="string">'score'</span>]}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="访问嵌套列表"><a href="#访问嵌套列表" class="headerlink" title="访问嵌套列表"></a>访问嵌套列表</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nested_list = [<span class="string">'prorise'</span>, <span class="number">185</span>, <span class="literal">True</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]]</span><br><span class="line"><span class="built_in">print</span>(nested_list[<span class="number">3</span>][<span class="number">1</span>])  <span class="comment"># 访问嵌套列表的元素：2</span></span><br></pre></td></tr></tbody></table></figure><h3 id="5-3-元组类型-tuple"><a href="#5-3-元组类型-tuple" class="headerlink" title="5.3 元组类型(tuple)"></a>5.3 元组类型(tuple)</h3><h4 id="元组的创建方式"><a href="#元组的创建方式" class="headerlink" title="元组的创建方式"></a>元组的创建方式</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 使用小括号创建</span></span><br><span class="line">t1 = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 省略小括号创建</span></span><br><span class="line">t2 = <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 单元素元组（必须加逗号，否则只是普通值，不是元组）</span></span><br><span class="line">t3 = (<span class="number">42</span>,)   <span class="comment"># 正确：这是一个元组</span></span><br><span class="line">t4 = (<span class="number">42</span>)    <span class="comment"># 错误：这是一个整数，不是元组</span></span><br><span class="line">t5 = <span class="number">42</span>,     <span class="comment"># 正确：这也是一个元组</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 使用tuple()函数从其他可迭代对象创建</span></span><br><span class="line">t6 = <span class="built_in">tuple</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])        <span class="comment"># 从列表创建</span></span><br><span class="line">t7 = <span class="built_in">tuple</span>(<span class="string">"hello"</span>)          <span class="comment"># 从字符串创建: ('h', 'e', 'l', 'l', 'o')</span></span><br><span class="line">t8 = <span class="built_in">tuple</span>({<span class="number">1</span>: <span class="string">'a'</span>, <span class="number">2</span>: <span class="string">'b'</span>}) <span class="comment"># 从字典创建: (1, 2) - 只保留键</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 创建空元组</span></span><br><span class="line">empty_tuple = ()</span><br><span class="line">also_empty = <span class="built_in">tuple</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 嵌套元组</span></span><br><span class="line">nested = (<span class="number">1</span>, (<span class="number">2</span>, <span class="number">3</span>), (<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 不同类型的元素</span></span><br><span class="line">mixed = (<span class="number">1</span>, <span class="string">"hello"</span>, <span class="literal">True</span>, <span class="literal">None</span>, <span class="number">3.14</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="元组的特性与操作"><a href="#元组的特性与操作" class="headerlink" title="元组的特性与操作"></a>元组的特性与操作</h4><h5 id="不可变性"><a href="#不可变性" class="headerlink" title="不可变性"></a>不可变性</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="comment"># t[0] = 5  # TypeError: 'tuple' object does not support item assignment</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 但可以通过连接创建新元组</span></span><br><span class="line">t = t + (<span class="number">4</span>, <span class="number">5</span>)  <span class="comment"># 新元组: (1, 2, 3, 4, 5)</span></span><br><span class="line">t = t * <span class="number">2</span>       <span class="comment"># 重复元组: (1, 2, 3, 4, 5, 1, 2, 3, 4, 5)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 元组的不可变性让它可以作为字典的键</span></span><br><span class="line">d = {(<span class="number">1</span>, <span class="number">2</span>): <span class="string">"tuple as key"</span>}</span><br><span class="line"><span class="comment"># d[[1, 2]] = "list as key"  # TypeError: unhashable type: 'list'</span></span><br></pre></td></tr></tbody></table></figure><p>元组中可变对象的行为</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 元组中的可变对象（如列表）的内容可以修改</span></span><br><span class="line">t = (<span class="number">1</span>, [<span class="number">2</span>, <span class="number">3</span>], <span class="number">4</span>)</span><br><span class="line">t[<span class="number">1</span>].append(<span class="number">5</span>)  <span class="comment"># 正确：修改元组中列表的内容</span></span><br><span class="line"><span class="built_in">print</span>(t)        <span class="comment"># (1, [2, 3, 5], 4)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># t[1] = [6, 7]  # TypeError: 'tuple' object does not support item assignment</span></span><br></pre></td></tr></tbody></table></figure><p><strong>重要说明</strong>：元组的不可变性只适用于元组本身的结构（元素的标识符不能改变），而不适用于元组中所包含的可变对象的内容。</p><h4 id="访问与切片"><a href="#访问与切片" class="headerlink" title="访问与切片"></a>访问与切片</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">t = (<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 索引访问（从0开始）</span></span><br><span class="line"><span class="built_in">print</span>(t[<span class="number">0</span>])    <span class="comment"># 0</span></span><br><span class="line"><span class="built_in">print</span>(t[-<span class="number">1</span>])   <span class="comment"># 5 (负索引从末尾开始)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切片</span></span><br><span class="line"><span class="built_in">print</span>(t[<span class="number">1</span>:<span class="number">4</span>])  <span class="comment"># (1, 2, 3)</span></span><br><span class="line"><span class="built_in">print</span>(t[:<span class="number">3</span>])   <span class="comment"># (0, 1, 2)</span></span><br><span class="line"><span class="built_in">print</span>(t[<span class="number">3</span>:])   <span class="comment"># (3, 4, 5)</span></span><br><span class="line"><span class="built_in">print</span>(t[::<span class="number">2</span>])  <span class="comment"># (0, 2, 4) - 步长为2</span></span><br><span class="line"><span class="built_in">print</span>(t[::-<span class="number">1</span>]) <span class="comment"># (5, 4, 3, 2, 1, 0) - 逆序</span></span><br></pre></td></tr></tbody></table></figure><h4 id="元组解包"><a href="#元组解包" class="headerlink" title="元组解包"></a>元组解包</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本解包</span></span><br><span class="line">t = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">a, b, c = t</span><br><span class="line"><span class="built_in">print</span>(a, b, c)  <span class="comment"># 1 2 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用星号（*）收集多余的元素（Python 3.x）</span></span><br><span class="line">t = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">a, b, *rest = t</span><br><span class="line"><span class="built_in">print</span>(a, b, rest)  <span class="comment"># 1 2 [3, 4, 5]</span></span><br><span class="line"></span><br><span class="line">first, *middle, last = t</span><br><span class="line"><span class="built_in">print</span>(first, middle, last)  <span class="comment"># 1 [2, 3, 4] 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 忽略某些值（使用下划线作为惯例）</span></span><br><span class="line">a, _, c = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(a, c)  <span class="comment"># 1 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 交换变量值</span></span><br><span class="line">a, b = <span class="number">10</span>, <span class="number">20</span></span><br><span class="line">a, b = b, a  <span class="comment"># 使用元组解包交换值</span></span><br><span class="line"><span class="built_in">print</span>(a, b)  <span class="comment"># 20 10</span></span><br></pre></td></tr></tbody></table></figure><h4 id="元组方法和内置函数"><a href="#元组方法和内置函数" class="headerlink" title="元组方法和内置函数"></a>元组方法和内置函数</h4><p>元组的方法比列表少，因为它是不可变的。主要方法有：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">t = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. count() - 计算元素出现的次数</span></span><br><span class="line"><span class="built_in">print</span>(t.count(<span class="number">2</span>))  <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. index() - 返回元素首次出现的索引</span></span><br><span class="line"><span class="built_in">print</span>(t.index(<span class="number">3</span>))  <span class="comment"># 2</span></span><br><span class="line"><span class="comment"># print(t.index(5))  # ValueError: tuple.index(x): x not in tuple</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 使用内置函数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(t))      <span class="comment"># 6 - 元组长度</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">min</span>(t))      <span class="comment"># 1 - 最小元素</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">max</span>(t))      <span class="comment"># 4 - 最大元素</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>(t))      <span class="comment"># 14 - 元素和</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(t))   <span class="comment"># [1, 2, 2, 2, 3, 4] - 返回排序后的列表（非元组）</span></span><br></pre></td></tr></tbody></table></figure><h4 id="元组的应用场景"><a href="#元组的应用场景" class="headerlink" title="元组的应用场景"></a>元组的应用场景</h4><h5 id="作为函数的返回值"><a href="#作为函数的返回值" class="headerlink" title="作为函数的返回值"></a>作为函数的返回值</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_info</span>():</span><br><span class="line">    <span class="comment"># 返回多个值</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Alice"</span>, <span class="number">30</span>, <span class="string">"alice@example.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用函数并解包返回值</span></span><br><span class="line"><span class="comment"># 判断返回值是否为一个元组</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">isinstance</span>(get_user_info(), <span class="built_in">tuple</span>):</span><br><span class="line">    name, age, email = get_user_info()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"姓名: <span class="subst">{name}</span>, 年龄: <span class="subst">{age}</span>, 邮箱: <span class="subst">{email}</span>"</span>) <span class="comment"># 输出姓名: Alice, 年龄: 30, 邮箱: alice@example.com</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"返回值不是一个元组"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="作为不可变集合"><a href="#作为不可变集合" class="headerlink" title="作为不可变集合"></a>作为不可变集合</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用元组作为字典键</span></span><br><span class="line">locations = {</span><br><span class="line">    (<span class="number">40.730610</span>, -<span class="number">73.935242</span>): <span class="string">"New York"</span>,</span><br><span class="line">    (<span class="number">34.052235</span>, -<span class="number">118.243683</span>): <span class="string">"Los Angeles"</span>,</span><br><span class="line">    (<span class="number">41.878113</span>, -<span class="number">87.629799</span>): <span class="string">"Chicago"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新字典，不更改元组</span></span><br><span class="line">locations[(<span class="number">51.507351</span>, -<span class="number">0.127758</span>)] = <span class="string">"London"</span></span><br></pre></td></tr></tbody></table></figure><h5 id="确保数据不被修改"><a href="#确保数据不被修改" class="headerlink" title="确保数据不被修改"></a>确保数据不被修改</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_config</span>(<span class="params">config</span>):</span><br><span class="line">    <span class="comment"># config是一个元组，确保处理过程中不被修改</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"处理配置:"</span>, config)</span><br><span class="line">    <span class="comment"># 安全的操作...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">settings = (<span class="string">"debug"</span>, <span class="string">"verbose"</span>, <span class="string">"log_level=info"</span>)</span><br><span class="line">process_config(settings)</span><br></pre></td></tr></tbody></table></figure><h5><a href="#" class="headerlink"></a></h5><h3 id="5-4-字典类型-dict"><a href="#5-4-字典类型-dict" class="headerlink" title="5.4 字典类型(dict)"></a>5.4 字典类型(dict)</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建字典</span></span><br><span class="line">person = {<span class="string">"name"</span>: <span class="string">"张三"</span>, <span class="string">"age"</span>: <span class="number">25</span>, <span class="string">"city"</span>: <span class="string">"北京"</span>}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问值</span></span><br><span class="line"><span class="built_in">print</span>(person[<span class="string">"name"</span>])  <span class="comment"># 张三</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置/修改值</span></span><br><span class="line">person[<span class="string">"age"</span>] = <span class="number">26</span></span><br><span class="line">person[<span class="string">"email"</span>] = <span class="string">"zhangsan@example.com"</span>  <span class="comment"># 添加新键值对</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除键值对</span></span><br><span class="line"><span class="keyword">del</span> person[<span class="string">"city"</span>]</span><br></pre></td></tr></tbody></table></figure><h4 id="字典常用方法"><a href="#字典常用方法" class="headerlink" title="字典常用方法"></a>字典常用方法</h4><table><thead><tr><th>方法</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>get()</td><td>获取值，键不存在时返回默认值</td><td><code>dict.get('key', 默认值)</code></td></tr><tr><td>keys()</td><td>获取所有键</td><td><code>dict.keys()</code></td></tr><tr><td>values()</td><td>获取所有值</td><td><code>dict.values()</code></td></tr><tr><td>items()</td><td>获取所有键值对</td><td><code>dict.items()</code></td></tr><tr><td>setdefault()</td><td>获取值，键不存在则设置默认值</td><td><code>dict.setdefault('key', 默认值)</code></td></tr><tr><td>update()</td><td>更新字典</td><td><code>dict1.update(dict2)</code></td></tr><tr><td>pop()</td><td>移除指定键值对并返回值</td><td><code>dict.pop('key')</code></td></tr></tbody></table><h3 id="5-5-集合类型-set"><a href="#5-5-集合类型-set" class="headerlink" title="5.5 集合类型(set)"></a>5.5 集合类型(set)</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建集合</span></span><br><span class="line">s1 = {<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>}</span><br><span class="line">s2 = <span class="built_in">set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>])  <span class="comment"># 结果：{1, 2, 3}</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加元素</span></span><br><span class="line">s1.add(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除元素</span></span><br><span class="line">s1.discard(<span class="number">3</span>)  <span class="comment"># 元素不存在不会报错</span></span><br><span class="line">s1.remove(<span class="number">2</span>)   <span class="comment"># 元素不存在会报错</span></span><br></pre></td></tr></tbody></table></figure><h4 id="集合操作"><a href="#集合操作" class="headerlink" title="集合操作"></a>集合操作</h4><table><thead><tr><th>操作</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>&amp;</td><td>交集（共同元素）</td><td><code>s1 &amp; s2</code></td></tr><tr><td>|</td><td>并集（去重合并）</td><td><code>s1 | s2</code></td></tr><tr><td>-</td><td>差集（属于 s1 不属于 s2）</td><td><code>s1 - s2</code></td></tr><tr><td>^</td><td>对称差集（不同时属于 s1 和 s2）</td><td><code>s1 ^ s2</code></td></tr></tbody></table><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 求两个集合的交集(共同元素)</span></span><br><span class="line">s1 = {<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>}</span><br><span class="line">s2 = {<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>}</span><br><span class="line"><span class="built_in">print</span>(s1 &amp; s2)  <span class="comment"># {1, 3, 5}</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 求两个集合的并集（去重后在合并）</span></span><br><span class="line"><span class="built_in">print</span>(s1 | s2)  <span class="comment"># {1, 2, 3, 4, 5, 7, 9}</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 求两个集合的差集（s1中有而s2中没有的元素）</span></span><br><span class="line"><span class="built_in">print</span>(s1 - s2)  <span class="comment"># {2, 4}</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 求两个集合的对称差集（s1和s2中不同时存在的元素）</span></span><br><span class="line"><span class="built_in">print</span>(s1 ^ s2)  <span class="comment"># {2, 4, 7, 9}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="第六章：条件循环分支"><a href="#第六章：条件循环分支" class="headerlink" title="第六章：条件循环分支"></a>第六章：条件循环分支</h2><h3 id="条件语句的高级用法"><a href="#条件语句的高级用法" class="headerlink" title="条件语句的高级用法"></a>条件语句的高级用法</h3><h4 id="链式比较"><a href="#链式比较" class="headerlink" title="链式比较"></a>链式比较</h4><p>Python 支持数学风格的链式比较，使得条件表达式更简洁明了。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 传统方式</span></span><br><span class="line"><span class="keyword">if</span> x &gt; <span class="number">0</span> <span class="keyword">and</span> x &lt; <span class="number">10</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"x在0到10之间"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链式比较</span></span><br><span class="line"><span class="keyword">if</span> <span class="number">0</span> &lt; x &lt; <span class="number">10</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"x在0到10之间"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 多重链式比较</span></span><br><span class="line"><span class="keyword">if</span> <span class="number">10</span> &lt;= x &lt; <span class="number">20</span> &lt;= y &lt; <span class="number">30</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"x在10到20之间且y在20到30之间"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="短路逻辑评估"><a href="#短路逻辑评估" class="headerlink" title="短路逻辑评估"></a>短路逻辑评估</h4><p>Python 使用短路逻辑评估条件表达式，即一旦表达式的真假已经确定，后续部分不再执行。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 短路与(and)</span></span><br><span class="line"><span class="keyword">if</span> expensive_function() <span class="keyword">and</span> rare_condition():</span><br><span class="line">    <span class="comment"># 如果expensive_function()返回False，不会执行rare_condition()</span></span><br><span class="line">    do_something()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 短路或(or)</span></span><br><span class="line"><span class="keyword">if</span> quick_check() <span class="keyword">or</span> expensive_operation():</span><br><span class="line">    <span class="comment"># 如果quick_check()返回True，不会执行expensive_operation()</span></span><br><span class="line">    do_something()</span><br></pre></td></tr></tbody></table></figure><h4 id="条件表达式的嵌套"><a href="#条件表达式的嵌套" class="headerlink" title="条件表达式的嵌套"></a>条件表达式的嵌套</h4><p>可以在条件表达式内部嵌套其他条件表达式，创建复杂的决策树。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂嵌套的三元表达式</span></span><br><span class="line">result = (</span><br><span class="line">    <span class="string">"高分"</span> <span class="keyword">if</span> score &gt;= <span class="number">90</span> <span class="keyword">else</span> </span><br><span class="line">    <span class="string">"良好"</span> <span class="keyword">if</span> score &gt;= <span class="number">80</span> <span class="keyword">else</span> </span><br><span class="line">    <span class="string">"及格"</span> <span class="keyword">if</span> score &gt;= <span class="number">60</span> <span class="keyword">else</span> </span><br><span class="line">    <span class="string">"不及格"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更复杂的嵌套条件</span></span><br><span class="line">category = (</span><br><span class="line">    <span class="string">"儿童"</span> <span class="keyword">if</span> age &lt; <span class="number">12</span> <span class="keyword">else</span></span><br><span class="line">    <span class="string">"青少年"</span> <span class="keyword">if</span> age &lt; <span class="number">18</span> <span class="keyword">else</span></span><br><span class="line">    <span class="string">"成人"</span> <span class="keyword">if</span> age &lt; <span class="number">65</span> <span class="keyword">else</span></span><br><span class="line">    <span class="string">"老年人"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><h4 id="模式匹配（Python-3-10-）"><a href="#模式匹配（Python-3-10-）" class="headerlink" title="模式匹配（Python 3.10+）"></a>模式匹配（Python 3.10+）</h4><p>Python 3.10 引入了结构化模式匹配，类似于其他语言的 switch/case 语句，但功能更强大。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本模式匹配</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_type</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">match</span> data:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">int</span>():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"整数"</span></span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">float</span>():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"浮点数"</span></span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">str</span>():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"字符串"</span></span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">list</span>():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"列表"</span></span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">dict</span>():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"字典"</span></span><br><span class="line">        <span class="keyword">case</span> _:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"其他类型"</span></span><br><span class="line"><span class="comment">#===========#===========#===========#===========#===========#===========#===========#===========</span></span><br><span class="line"><span class="comment"># 结构匹配和变量绑定</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_point</span>(<span class="params">point</span>):</span><br><span class="line">    <span class="keyword">match</span> point:</span><br><span class="line">        <span class="keyword">case</span> (<span class="number">0</span>, <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"原点"</span></span><br><span class="line">        <span class="keyword">case</span> (<span class="number">0</span>, y):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f"Y轴上的点 y=<span class="subst">{y}</span>"</span></span><br><span class="line">        <span class="keyword">case</span> (x, <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f"X轴上的点 x=<span class="subst">{x}</span>"</span></span><br><span class="line">        <span class="keyword">case</span> (x, y) <span class="keyword">if</span> x == y:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f"对角线上的点 (<span class="subst">{x}</span>, <span class="subst">{y}</span>)"</span></span><br><span class="line">        <span class="keyword">case</span> (x, y):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f"普通点 (<span class="subst">{x}</span>, <span class="subst">{y}</span>)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配对象属性</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        <span class="variable language_">self</span>.x = x</span><br><span class="line">        <span class="variable language_">self</span>.y = y</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_point</span>(<span class="params">point</span>):</span><br><span class="line">    <span class="keyword">match</span> point:</span><br><span class="line">        <span class="keyword">case</span> Point(x=<span class="number">0</span>, y=<span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"原点"</span></span><br><span class="line">        <span class="keyword">case</span> Point(x=<span class="number">0</span>, y=y):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f"Y轴上的点 y=<span class="subst">{y}</span>"</span></span><br><span class="line">        <span class="keyword">case</span> Point(x=x, y=<span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f"X轴上的点 x=<span class="subst">{x}</span>"</span></span><br><span class="line">        <span class="keyword">case</span> Point(x=x, y=y) <span class="keyword">if</span> x == y:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f"对角线上的点 (<span class="subst">{x}</span>, <span class="subst">{y}</span>)"</span></span><br><span class="line">        <span class="keyword">case</span> Point():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f"普通点 (<span class="subst">{point.x}</span>, <span class="subst">{point.y}</span>)"</span></span><br></pre></td></tr></tbody></table></figure><h3 id="循环的高级技巧"><a href="#循环的高级技巧" class="headerlink" title="循环的高级技巧"></a>循环的高级技巧</h3><h4 id="循环与迭代器协议"><a href="#循环与迭代器协议" class="headerlink" title="循环与迭代器协议"></a>循环与迭代器协议</h4><p>理解迭代器协议有助于更高效地编写循环代码：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CountDown</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, start</span>):</span><br><span class="line">        <span class="variable language_">self</span>.start = start</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        返回迭代器对象</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        这个方法使CountDown类的实例成为一个可迭代对象。</span></span><br><span class="line"><span class="string">        当使用for循环遍历该对象时，Python会自动调用这个方法获取迭代器。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        返回:</span></span><br><span class="line"><span class="string">            self: 返回自身作为迭代器</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取迭代器中的下一个值</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        这个方法定义了迭代过程中如何获取下一个元素。</span></span><br><span class="line"><span class="string">        每次调用时，计数器减1并返回减1前的值。</span></span><br><span class="line"><span class="string">        当计数器减到0时，抛出StopIteration异常表示迭代结束。</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.start &lt;= <span class="number">0</span>:  <span class="comment"># 如果当前值小于等于0，表示迭代已结束</span></span><br><span class="line">            <span class="keyword">raise</span> StopIteration</span><br><span class="line">        current = <span class="variable language_">self</span>.start  <span class="comment"># 保存当前值</span></span><br><span class="line">        <span class="variable language_">self</span>.start -= <span class="number">1</span>       <span class="comment"># 计数器减1</span></span><br><span class="line">        <span class="keyword">return</span> current        <span class="comment"># 返回减1前的值</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 测试代码</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> CountDown(<span class="number">5</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></tbody></table></figure><h4 id="生成器表达式代替列表推导式"><a href="#生成器表达式代替列表推导式" class="headerlink" title="生成器表达式代替列表推导式"></a>生成器表达式代替列表推导式</h4><p>生成器表达式在处理大量数据时更节省内存：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="comment"># 列表推导式 - 一次性创建所有元素</span></span><br><span class="line">sum_of_squares = sys.getsizeof(<span class="built_in">sum</span>([x*x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>)]))  <span class="comment"># 占用大量内存</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"占用内存: <span class="subst">{sum_of_squares}</span> bytes"</span>) <span class="comment"># 占用内存: 32 bytes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成器表达式 - 按需生成元素</span></span><br><span class="line">sum_of_squares = sys.getsizeof(<span class="built_in">sum</span>(x*x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>)))    <span class="comment"># 内存效率高</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"占用内存: <span class="subst">{sys.getsizeof(sum_of_squares)}</span> bytes"</span>) <span class="comment"># 占用内存: 28 bytes</span></span><br></pre></td></tr></tbody></table></figure><h4 id="使用-enumerate-获取索引"><a href="#使用-enumerate-获取索引" class="headerlink" title="使用 enumerate 获取索引"></a>使用 enumerate 获取索引</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 传统方式</span></span><br><span class="line">fruits = [<span class="string">'apple'</span>, <span class="string">'banana'</span>, <span class="string">'cherry'</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(fruits)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{i + <span class="number">1</span>}</span>. <span class="subst">{fruits[i]}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用enumerate更优雅（并可指定起始索引）</span></span><br><span class="line"><span class="keyword">for</span> i, fruit <span class="keyword">in</span> <span class="built_in">enumerate</span>(fruits, <span class="number">1</span>):  <span class="comment"># 从1开始计数</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{i}</span>. <span class="subst">{fruit}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="并行迭代多个序列"><a href="#并行迭代多个序列" class="headerlink" title="并行迭代多个序列"></a>并行迭代多个序列</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用zip()并行迭代</span></span><br><span class="line">names = [<span class="string">'Alice'</span>, <span class="string">'Bob'</span>, <span class="string">'Charlie'</span>]</span><br><span class="line">ages = [<span class="number">24</span>, <span class="number">32</span>, <span class="number">28</span>]</span><br><span class="line">cities = [<span class="string">'New York'</span>, <span class="string">'Boston'</span>, <span class="string">'Chicago'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> name, age, city <span class="keyword">in</span> <span class="built_in">zip</span>(names, ages, cities):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{name}</span>, <span class="subst">{age}</span>岁, 来自<span class="subst">{city}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h3 id="流程控制的高级模式"><a href="#流程控制的高级模式" class="headerlink" title="流程控制的高级模式"></a>流程控制的高级模式</h3><h4 id="嵌套循环的优化"><a href="#嵌套循环的优化" class="headerlink" title="嵌套循环的优化"></a>嵌套循环的优化</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 嵌套循环的替代方案</span></span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 传统嵌套循环</span></span><br><span class="line">results = []</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">for</span> z <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">            results.append((x, y, z))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用product代替嵌套循环</span></span><br><span class="line">results = <span class="built_in">list</span>(itertools.product(<span class="built_in">range</span>(<span class="number">3</span>), <span class="built_in">range</span>(<span class="number">3</span>), <span class="built_in">range</span>(<span class="number">3</span>)))</span><br></pre></td></tr></tbody></table></figure><h4 id="递归与循环"><a href="#递归与循环" class="headerlink" title="递归与循环"></a>递归与循环</h4><p>有些问题使用递归比循环更直观：</p><blockquote><p>通过下列的代码处理思想，对于常见的树结构都能以递归的思想去解决问题</p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 递归处理嵌套结构</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_nested_list</span>(<span class="params">nested_list, depth=<span class="number">0</span></span>):</span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> nested_list:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">list</span>):</span><br><span class="line">            <span class="comment"># 递归处理子列表</span></span><br><span class="line">            sub_result = process_nested_list(item, depth + <span class="number">1</span>)</span><br><span class="line">            result.extend(sub_result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 处理叶节点</span></span><br><span class="line">            result.append((depth, item))</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 递归执行逻辑解析:</span></span><br><span class="line"><span class="comment"># 1. 函数接收一个嵌套列表和当前深度(默认为0)</span></span><br><span class="line"><span class="comment"># 2. 遍历列表中的每个元素:</span></span><br><span class="line"><span class="comment">#    - 如果元素是列表，递归调用自身处理该子列表，深度+1</span></span><br><span class="line"><span class="comment">#    - 如果元素不是列表，将(深度,元素值)添加到结果中</span></span><br><span class="line"><span class="comment"># 3. 最终返回包含所有元素及其深度信息的扁平列表</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 例如处理 [1, [2, [3, 4], 5], 6]:</span></span><br><span class="line"><span class="comment"># - 1不是列表，添加(0,1)</span></span><br><span class="line"><span class="comment"># - [2,[3,4],5]是列表，递归处理:</span></span><br><span class="line"><span class="comment">#   - 2不是列表，添加(1,2)</span></span><br><span class="line"><span class="comment">#   - [3,4]是列表，递归处理:</span></span><br><span class="line"><span class="comment">#     - 3不是列表，添加(2,3)</span></span><br><span class="line"><span class="comment">#     - 4不是列表，添加(2,4)</span></span><br><span class="line"><span class="comment">#   - 5不是列表，添加(1,5)</span></span><br><span class="line"><span class="comment"># - 6不是列表，添加(0,6)</span></span><br><span class="line"><span class="comment"># 最终结果: [(0,1), (1,2), (2,3), (2,4), (1,5), (0,6)]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">data = [<span class="number">1</span>, [<span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>], <span class="number">5</span>], <span class="number">6</span>]</span><br><span class="line"><span class="built_in">print</span>(process_nested_list(data))  <span class="comment"># [(0, 1), (1, 2), (2, 3), (2, 4), (1, 5), (0, 6)]</span></span><br></pre></td></tr></tbody></table></figure><h2 id="第七章：-文件操作"><a href="#第七章：-文件操作" class="headerlink" title="第七章： 文件操作"></a>第七章： 文件操作</h2><p>Python 提供了强大而灵活的文件操作接口，从基础的读写能力到高级的路径操作和目录管理。本章将由浅入深地介绍 Python 文件操作的全面知识。</p><h3 id="7-1-文件打开模式"><a href="#7-1-文件打开模式" class="headerlink" title="7.1 文件打开模式"></a>7.1 文件打开模式</h3><p>文件操作的第一步是打开文件，Python 提供了多种打开模式以满足不同需求。</p><table><thead><tr><th>模式</th><th>描述</th><th>文件不存在时</th><th>文件存在时</th><th>常见应用场景</th></tr></thead><tbody><tr><td><code>r</code></td><td>只读模式</td><td>报错</td><td>从头读取</td><td>读取配置文件、日志文件</td></tr><tr><td><code>w</code></td><td>只写模式</td><td>创建新文件</td><td>清空内容</td><td>生成报告、写入日志</td></tr><tr><td><code>a</code></td><td>追加模式</td><td>创建新文件</td><td>在末尾追加</td><td>日志记录、数据收集</td></tr><tr><td><code>r+</code></td><td>读写模式</td><td>报错</td><td>可读可写</td><td>需要同时读写的场景</td></tr><tr><td><code>w+</code></td><td>读写模式</td><td>创建新文件</td><td>清空内容</td><td>需要先写后读的场景</td></tr><tr><td><code>a+</code></td><td>追加读写</td><td>创建新文件</td><td>追加且可读</td><td>数据分析、日志分析</td></tr><tr><td><code>b</code></td><td>二进制模式</td><td>与其他模式组合</td><td>处理二进制</td><td>图片、视频、压缩文件</td></tr><tr><td><code>t</code></td><td>文本模式(默认)</td><td>与其他模式组合</td><td>处理文本</td><td>文本文件处理</td></tr></tbody></table><blockquote><p><strong>实用提示</strong>：选择合适的文件模式可以避免数据丢失。例如，使用 <code>w</code> 模式时要格外小心，因为它会清空现有文件。当不确定时，使用 <code>a</code> 模式追加内容会更安全。</p></blockquote><h3 id="7-2-基本文件操作"><a href="#7-2-基本文件操作" class="headerlink" title="7.2 基本文件操作"></a>7.2 基本文件操作</h3><h4 id="7-2-1-文件读取操作"><a href="#7-2-1-文件读取操作" class="headerlink" title="7.2.1 文件读取操作"></a>7.2.1 文件读取操作</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 with 语句自动处理文件关闭（推荐方式）</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'example.txt'</span>, mode=<span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</span><br><span class="line">    <span class="comment"># 方法1：一次性读取整个文件</span></span><br><span class="line">    content = file.read()  <span class="comment"># 读取全部内容到内存</span></span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 注意：read()后文件指针已经到达文件末尾</span></span><br><span class="line">    <span class="comment"># 需要重新打开文件或使用seek(0)重置指针</span></span><br><span class="line">    file.seek(<span class="number">0</span>)  <span class="comment"># 重置文件指针到文件开头</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 方法2：读取一行</span></span><br><span class="line">    line = file.readline()  <span class="comment"># 读取第一行（包含换行符）</span></span><br><span class="line">    <span class="built_in">print</span>(line)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 方法3：读取所有行到列表</span></span><br><span class="line">    file.seek(<span class="number">0</span>)  <span class="comment"># 重置文件指针</span></span><br><span class="line">    lines = file.readlines()  <span class="comment"># 返回包含所有行的列表</span></span><br><span class="line">    <span class="built_in">print</span>(lines)  <span class="comment"># ['第一行\n', '第二行\n', ...]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 方法4：逐行读取（内存效率最高，推荐用于大文件）</span></span><br><span class="line">    file.seek(<span class="number">0</span>)  <span class="comment"># 重置文件指针</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> file:  <span class="comment"># 文件对象本身是可迭代的</span></span><br><span class="line">        <span class="comment"># line包含换行符，通常需要移除</span></span><br><span class="line">        <span class="built_in">print</span>(line.strip())  <span class="comment"># 去除行首行尾的空白字符</span></span><br></pre></td></tr></tbody></table></figure><h4 id="7-2-2-文件写入操作"><a href="#7-2-2-文件写入操作" class="headerlink" title="7.2.2 文件写入操作"></a>7.2.2 文件写入操作</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入文件（覆盖模式）</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'example.txt'</span>, mode=<span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</span><br><span class="line">    <span class="comment"># 方法1：写入字符串</span></span><br><span class="line">    file.write(<span class="string">'第一行内容\n'</span>)  <span class="comment"># 注意需手动添加换行符</span></span><br><span class="line">    file.write(<span class="string">'第二行内容\n'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 方法2：写入多行</span></span><br><span class="line">    lines = [<span class="string">'第三行内容\n'</span>, <span class="string">'第四行内容\n'</span>]</span><br><span class="line">    file.writelines(lines)  <span class="comment"># 注意writelines不会自动添加换行符</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 追加内容到文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'example.txt'</span>, mode=<span class="string">'a'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(<span class="string">'追加的内容\n'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 读写模式示例</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'example.txt'</span>, mode=<span class="string">'r+'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</span><br><span class="line">    content = file.read(<span class="number">10</span>)  <span class="comment"># 读取前10个字符</span></span><br><span class="line">    file.write(<span class="string">'插入的内容'</span>)  <span class="comment"># 在当前位置（第10个字符后）写入</span></span><br></pre></td></tr></tbody></table></figure><h4 id="7-2-3-多文件操作"><a href="#7-2-3-多文件操作" class="headerlink" title="7.2.3 多文件操作"></a>7.2.3 多文件操作</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 同时操作多个文件（例如：文件复制）</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'source.txt'</span>, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> source, \</span><br><span class="line">     <span class="built_in">open</span>(<span class="string">'destination.txt'</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> destination:</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 按块读取和写入（适用于大文件）</span></span><br><span class="line">    chunk_size = <span class="number">4096</span>  <span class="comment"># 4KB 的块大小</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        chunk = source.read(chunk_size)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> chunk:  <span class="comment"># 到达文件末尾</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        destination.write(chunk)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 或者简单地复制所有内容</span></span><br><span class="line">    <span class="comment"># source.seek(0)  # 先重置到文件开头</span></span><br><span class="line">    <span class="comment"># destination.write(source.read())</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 或者逐行复制（适合文本处理）</span></span><br><span class="line">    <span class="comment"># source.seek(0)</span></span><br><span class="line">    <span class="comment"># for line in source:</span></span><br><span class="line">    <span class="comment">#     # 可以在此添加行处理逻辑</span></span><br><span class="line">    <span class="comment">#     destination.write(line)</span></span><br></pre></td></tr></tbody></table></figure><h4 id="7-2-4-文件修改示例"><a href="#7-2-4-文件修改示例" class="headerlink" title="7.2.4 文件修改示例"></a>7.2.4 文件修改示例</h4><p>在实际应用中，我们经常需要读取、修改并写回文件：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例：为Markdown文件的所有标题增加一个#符号</span></span><br><span class="line">file_name = <span class="string">'document.md'</span></span><br><span class="line">output_file = <span class="string">'document_modified.md'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取并修改</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(file_name, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> input_file:</span><br><span class="line">    lines = input_file.readlines()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 处理每一行</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(lines)):</span><br><span class="line">        <span class="comment"># 如果行以#开头（表示标题），则增加一个#</span></span><br><span class="line">        <span class="keyword">if</span> lines[i].strip().startswith(<span class="string">'#'</span>):</span><br><span class="line">            lines[i] = <span class="string">'#'</span> + lines[i]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将修改后的内容写入新文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> output_file:</span><br><span class="line">    output_file.writelines(lines)</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"文件已修改并保存为 <span class="subst">{output_file}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>最佳实践</strong>：对于文件修改操作，始终先写入临时文件，然后在确认写入成功后才替换原文件，这样可以防止文件损坏。</p></blockquote><h3 id="7-3-文件指针控制"><a href="#7-3-文件指针控制" class="headerlink" title="7.3 文件指针控制"></a>7.3 文件指针控制</h3><p>文件指针（或文件位置）决定了读写操作的起始位置。掌握指针控制对于高级文件操作至关重要。</p><h4 id="7-3-1-seek-和-tell-函数"><a href="#7-3-1-seek-和-tell-函数" class="headerlink" title="7.3.1 seek() 和 tell() 函数"></a>7.3.1 seek() 和 tell() 函数</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'example.txt'</span>, <span class="string">'w+'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</span><br><span class="line">    <span class="comment"># 写入一些测试内容</span></span><br><span class="line">    file.write(<span class="string">"Hello World! 你好世界！"</span>) <span class="comment"># 英文部分 "Hello World " 占用 12 个字符，中文部分 "你好世界！" 占用 12 个字符，剩余的空格+符号占据了 4 个字符 总共 28 个字符</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># tell() 获取当前文件指针位置</span></span><br><span class="line">    position = file.tell()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"写入内容后的位置: <span class="subst">{position}</span>"</span>)  <span class="comment"># 写入内容后的位置: 28</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将指针移回文件开头</span></span><br><span class="line">    file.seek(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"回到文件开头位置: <span class="subst">{file.tell()}</span>"</span>)   <span class="comment"># 回到文件开头位置: 0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 读取全部内容</span></span><br><span class="line">    content = file.read()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"文件全部内容: <span class="subst">{content}</span>"</span>) <span class="comment"># 文件全部内容: Hello World! 你好世界！</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"读取后的位置: <span class="subst">{file.tell()}</span>"</span>)  <span class="comment"># 读取后的位置: 28</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 再次回到文件开头</span></span><br><span class="line">    file.seek(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 读取前5个字符</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"前5个字符: <span class="subst">{file.read(<span class="number">5</span>)}</span>"</span>) <span class="comment"># 前5个字符: Hello</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"读取5个字符后的位置: <span class="subst">{file.tell()}</span>"</span>) <span class="comment"># 读取5个字符后的位置: 5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 回到文件开头</span></span><br><span class="line">    file.seek(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 一次性定位到第13个字符位置（从文件开头算起）</span></span><br><span class="line">    file.seek(<span class="number">13</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"直接定位到第10个位置: <span class="subst">{file.tell()}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"从第13个位置开始读取的内容: <span class="subst">{file.read()}</span>"</span>) <span class="comment"># 从第13个位置开始读取的内容: 你好世界！</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>注意</strong>：在文本模式下，由于字符编码原因，seek() 可能无法精确定位到任意字节位置。对于需要精确控制的场景，应使用二进制模式 (‘rb’, ‘wb’ 等)。</p></blockquote><h4 id="7-3-2-实际应用场景"><a href="#7-3-2-实际应用场景" class="headerlink" title="7.3.2 实际应用场景"></a>7.3.2 实际应用场景</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 场景：在大日志文件中读取最后100行</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tail</span>(<span class="params">file_path, n=<span class="number">10</span></span>):</span><br><span class="line">    <span class="string">"""读取文件最后n行，类似于Unix的tail命令"""</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="comment"># 移动到文件末尾</span></span><br><span class="line">        f.seek(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="comment"># 文件总大小</span></span><br><span class="line">        total_size = f.tell()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化变量</span></span><br><span class="line">        block_size = <span class="number">1024</span></span><br><span class="line">        block = -<span class="number">1</span></span><br><span class="line">        lines = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 从文件末尾向前读取</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(lines) &lt; n <span class="keyword">and</span> -block * block_size &lt; total_size:</span><br><span class="line">            <span class="comment"># 移动到倒数第block个块</span></span><br><span class="line">            position = <span class="built_in">max</span>(<span class="number">0</span>, total_size + block * block_size)</span><br><span class="line">            f.seek(position)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 读取数据块</span></span><br><span class="line">            data = f.read(<span class="built_in">min</span>(block_size, total_size - position))</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 处理可能被截断的行</span></span><br><span class="line">            <span class="keyword">if</span> position &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># 丢弃第一行不完整数据</span></span><br><span class="line">                data = data.split(<span class="string">b'\n'</span>, <span class="number">1</span>)[<span class="number">1</span>] <span class="keyword">if</span> <span class="string">b'\n'</span> <span class="keyword">in</span> data <span class="keyword">else</span> <span class="string">b''</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 计算行数</span></span><br><span class="line">            lines_in_block = data.split(<span class="string">b'\n'</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 合并行</span></span><br><span class="line">            lines = lines_in_block + lines</span><br><span class="line">            block -= <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回最后n行</span></span><br><span class="line">        <span class="keyword">return</span> [line.decode(<span class="string">'utf-8'</span>) <span class="keyword">for</span> line <span class="keyword">in</span> lines[-n:]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">last_lines = tail(<span class="string">'large_log_file.txt'</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> last_lines:</span><br><span class="line">    <span class="built_in">print</span>(line)</span><br></pre></td></tr></tbody></table></figure><h3 id="7-4-缓冲区管理"><a href="#7-4-缓冲区管理" class="headerlink" title="7.4 缓冲区管理"></a>7.4 缓冲区管理</h3><p>理解缓冲区对于优化文件操作性能至关重要，特别是在处理大量小块写入时。</p><h4 id="7-4-1-缓冲设置与刷新"><a href="#7-4-1-缓冲设置与刷新" class="headerlink" title="7.4.1 缓冲设置与刷新"></a>7.4.1 缓冲设置与刷新</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置不同的缓冲策略</span></span><br><span class="line"><span class="comment"># buffering=0: 无缓冲 (仅在二进制模式可用)</span></span><br><span class="line"><span class="comment"># buffering=1: 行缓冲 (仅在文本模式可用)</span></span><br><span class="line"><span class="comment"># buffering&gt;1: 指定缓冲区大小(字节)</span></span><br><span class="line"><span class="comment"># buffering=-1: 使用默认缓冲区大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 无缓冲 (每次写入都直接写入磁盘)</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'binary_file.bin'</span>, <span class="string">'wb'</span>, buffering=<span class="number">0</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">b'Data will be written immediately'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 行缓冲 (遇到换行符时刷新)</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'log.txt'</span>, <span class="string">'w'</span>, buffering=<span class="number">1</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">'This line will be buffered\n'</span>)  <span class="comment"># 遇到\n会刷新</span></span><br><span class="line">    f.write(<span class="string">'Until a newline is encountered'</span>)  <span class="comment"># 保留在缓冲区</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定缓冲区大小</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'large_file.txt'</span>, <span class="string">'w'</span>, buffering=<span class="number">4096</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># 4KB缓冲区，适合频繁小写入</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">        f.write(<span class="string">f'Line <span class="subst">{i}</span>\n'</span>)  <span class="comment"># 数据会积累到4KB才写入磁盘</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动刷新缓冲区</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'important.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">'Critical data'</span>)</span><br><span class="line">    f.flush()  <span class="comment"># 立即刷新缓冲区，确保数据写入磁盘</span></span><br><span class="line">    os.fsync(f.fileno())  <span class="comment"># 进一步确保数据写入物理存储设备</span></span><br></pre></td></tr></tbody></table></figure><h4 id="7-4-2-缓冲区触发条件"><a href="#7-4-2-缓冲区触发条件" class="headerlink" title="7.4.2 缓冲区触发条件"></a>7.4.2 缓冲区触发条件</h4><p>缓冲区会在以下条件下自动刷新：</p><ol><li>缓冲区满时</li><li>文件关闭时（如 with 块结束）</li><li>调用 flush() 方法时</li><li>程序正常退出时</li><li>行缓冲模式下遇到换行符时</li></ol><blockquote><p><strong>性能提示</strong>：对于大量小写操作，使用适当的缓冲区大小可以显著提高性能。但对于关键数据，应及时调用 flush() 确保数据安全。</p></blockquote><h3 id="7-5-文件路径操作"><a href="#7-5-文件路径操作" class="headerlink" title="7.5 文件路径操作"></a>7.5 文件路径操作</h3><p>有效管理文件路径是文件操作的基础，Python 提供了两种主要方式：传统的 <code>os.path</code> 模块和现代的 <code>pathlib</code> 库。</p><h4 id="7-5-1-使用-os-path-模块"><a href="#7-5-1-使用-os-path-模块" class="headerlink" title="7.5.1 使用 os.path 模块"></a>7.5.1 使用 os.path 模块</h4><table><thead><tr><th>方法/属性</th><th>描述</th></tr></thead><tbody><tr><td><code>os.getcwd()</code></td><td>获取当前工作目录</td></tr><tr><td><code>os.chdir(path)</code></td><td>改变当前工作目录</td></tr><tr><td><code>os.mkdir(name)</code></td><td>创建目录</td></tr><tr><td><code>os.makedirs(path)</code></td><td>递归创建多级目录</td></tr><tr><td><code>os.rmdir(name)</code></td><td>删除空目录</td></tr><tr><td><code>os.remove(path)</code></td><td>删除文件</td></tr><tr><td><code>os.listdir(path)</code></td><td>列出指定目录的文件和目录</td></tr><tr><td><code>os.rename(src, dst)</code></td><td>重命名文件或目录</td></tr><tr><td><code>os.system(command)</code></td><td>执行系统命令</td></tr><tr><td><code>os.environ</code></td><td>环境变量字典</td></tr><tr><td><code>os.path.exists(path)</code></td><td>检查路径是否存在</td></tr><tr><td><code>os.path.isfile(path)</code></td><td>检查路径是否为文件</td></tr><tr><td><code>os.path.isdir(path)</code></td><td>检查路径是否为目录</td></tr><tr><td><code>os.path.join(path1, path2)</code></td><td>连接路径</td></tr><tr><td><code>os.path.split(path)</code></td><td>根据最后一个路径分隔符分割路径为(目录, 文件名)</td></tr><tr><td><code>os.path.splitext(path)</code></td><td>根据最后一个点号分割路径为(文件名，拓展名)</td></tr><tr><td><code>os.path.dirname(path)</code></td><td>获取路径的目录部分</td></tr><tr><td><code>os.path.basename(path)</code></td><td>获取路径的文件名部分</td></tr><tr><td><code>os.path.getsize(path)</code></td><td>获取文件大小(字节)</td></tr></tbody></table><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前脚本所在目录</span></span><br><span class="line">current_dir = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在当前目录下创建data.txt</span></span><br><span class="line">data_path = os.path.join(current_dir, <span class="string">"data.txt"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 首先创建一个测试文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(data_path, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(<span class="string">"这是测试内容！\nHello World!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件路径处理演示</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"=== 文件路径信息 ==="</span>)</span><br><span class="line">directory = os.path.dirname(data_path)</span><br><span class="line">filename = os.path.basename(data_path)</span><br><span class="line">name, extension = os.path.splitext(filename)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"目录: <span class="subst">{directory}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"文件名: <span class="subst">{filename}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"纯名称: <span class="subst">{name}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"扩展名: <span class="subst">{extension}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"\n=== 路径检查 ==="</span>)</span><br><span class="line">exists = os.path.exists(data_path)</span><br><span class="line">is_file = os.path.isfile(data_path)</span><br><span class="line">is_dir = os.path.isdir(data_path)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"文件是否存在: <span class="subst">{exists}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"是否是文件: <span class="subst">{is_file}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"是否是目录: <span class="subst">{is_dir}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"\n=== 文件信息 ==="</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    size = os.path.getsize(data_path)</span><br><span class="line">    mod_time = os.path.getmtime(data_path) <span class="comment"># 获取修改时间</span></span><br><span class="line">    create_time = os.path.getctime(data_path) <span class="comment"># 获取创建时间</span></span><br><span class="line">    access_time = os.path.getatime(data_path) <span class="comment"># 获取访问时间</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 转换时间戳为可读时间</span></span><br><span class="line">    mod_datetime = datetime.datetime.fromtimestamp(mod_time)</span><br><span class="line">    create_datetime = datetime.datetime.fromtimestamp(create_time)</span><br><span class="line">    access_datetime = datetime.datetime.fromtimestamp(access_time)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"文件大小: <span class="subst">{size}</span> 字节"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"创建时间: <span class="subst">{create_datetime}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"修改时间: <span class="subst">{mod_datetime}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"访问时间: <span class="subst">{access_datetime}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n=== 文件内容 ==="</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(data_path, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</span><br><span class="line">        content = file.read()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"文件内容:\n<span class="subst">{content}</span>"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"获取文件信息时发生错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="7-5-2-使用-pathlib-模块-Python-3-4"><a href="#7-5-2-使用-pathlib-模块-Python-3-4" class="headerlink" title="7.5.2 使用 pathlib 模块 (Python 3.4+)"></a>7.5.2 使用 pathlib 模块 (Python 3.4+)</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前脚本所在目录并创建data.txt的路径</span></span><br><span class="line">current_file = Path(__file__)</span><br><span class="line">data_path = current_file.parent / <span class="string">"data.txt"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建并写入测试文件</span></span><br><span class="line">data_path.write_text(<span class="string">"这是测试内容！\nHello World!"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"=== 基本路径信息 ==="</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"完整路径: <span class="subst">{data_path}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"父目录: <span class="subst">{data_path.parent}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"文件名: <span class="subst">{data_path.name}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"纯名称: <span class="subst">{data_path.stem}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"扩展名: <span class="subst">{data_path.suffix}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"所有路径组件: <span class="subst">{data_path.parts}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n=== 路径解析 ==="</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"绝对路径: <span class="subst">{data_path.absolute()}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"解析路径: <span class="subst">{data_path.resolve()}</span>"</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"相对路径: <span class="subst">{data_path.relative_to(Path.cwd())}</span>"</span>)</span><br><span class="line"><span class="keyword">except</span> ValueError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"无法计算相对路径（文件可能在不同驱动器或目录）"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n=== 文件状态检查 ==="</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"文件是否存在: <span class="subst">{data_path.exists()}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"是否是文件: <span class="subst">{data_path.is_file()}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"是否是目录: <span class="subst">{data_path.is_dir()}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"是否是符号链接: <span class="subst">{data_path.is_symlink()}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n=== 文件信息 ==="</span>)</span><br><span class="line"><span class="keyword">if</span> data_path.exists() <span class="keyword">and</span> data_path.is_file():</span><br><span class="line">    stat = data_path.stat()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"文件大小: <span class="subst">{stat.st_size}</span> 字节"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"创建时间: <span class="subst">{datetime.datetime.fromtimestamp(stat.st_ctime)}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"修改时间: <span class="subst">{datetime.datetime.fromtimestamp(stat.st_mtime)}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"访问时间: <span class="subst">{datetime.datetime.fromtimestamp(stat.st_atime)}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n=== 文件内容 ==="</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"文件内容:\n<span class="subst">{data_path.read_text(encoding=<span class="string">'utf-8'</span>)}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n=== 路径修改示例 ==="</span>)</span><br><span class="line">new_name = data_path.with_name(<span class="string">"newdata.txt"</span>)</span><br><span class="line">new_ext = data_path.with_suffix(<span class="string">".csv"</span>)</span><br><span class="line">new_stem = data_path.with_stem(<span class="string">"newdata"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"修改整个文件名: <span class="subst">{new_name}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"修改扩展名: <span class="subst">{new_ext}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"仅修改文件名(不含扩展名): <span class="subst">{new_stem}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>功能</th><th>os.path 方式</th><th>pathlib 方式</th><th>推荐</th></tr></thead><tbody><tr><td>路径连接</td><td><code>os.path.join(dir, file)</code></td><td><code>Path(dir) / file</code></td><td>pathlib 更直观</td></tr><tr><td>获取目录</td><td><code>os.path.dirname(path)</code></td><td><code>path.parent</code></td><td>pathlib 属性访问更清晰</td></tr><tr><td>获取文件名</td><td><code>os.path.basename(path)</code></td><td><code>path.name</code></td><td>pathlib 属性访问更清晰</td></tr><tr><td>分离扩展名</td><td><code>os.path.splitext(path)[1]</code></td><td><code>path.suffix</code></td><td>pathlib 更简洁</td></tr><tr><td>检查存在</td><td><code>os.path.exists(path)</code></td><td><code>path.exists()</code></td><td>两者类似，pathlib 面向对象</td></tr><tr><td>获取绝对路径</td><td><code>os.path.abspath(path)</code></td><td><code>path.absolute()</code></td><td>两者相当</td></tr></tbody></table><blockquote><p><strong>最佳实践</strong>：在新项目中优先使用 pathlib，它提供了更现代、更直观的面向对象接口。在维护旧代码时可能需要继续使用 os.path。</p></blockquote><h3 id="7-6-高级文件操作"><a href="#7-6-高级文件操作" class="headerlink" title="7.6 高级文件操作"></a>7.6 高级文件操作</h3><h4 id="7-6-1-二进制文件操作"><a href="#7-6-1-二进制文件操作" class="headerlink" title="7.6.1 二进制文件操作"></a>7.6.1 二进制文件操作</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取整个二进制文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_binary_file</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="string">"""读取并返回整个二进制文件的内容"""</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分块读取大型二进制文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_large_binary_file</span>(<span class="params">file_path, chunk_size=<span class="number">1024</span> * <span class="number">1024</span></span>):</span><br><span class="line">    <span class="string">"""分块处理大型二进制文件，避免内存溢出"""</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            chunk = f.read(chunk_size)  <span class="comment"># 每次读取1MB</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chunk:  <span class="comment"># 到达文件末尾</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 处理当前数据块</span></span><br><span class="line">            process_chunk(chunk)  <span class="comment"># 假设的处理函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理数据块的函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_chunk</span>(<span class="params">chunk</span>):</span><br><span class="line">    <span class="string">"""处理二进制数据块的函数"""</span></span><br><span class="line">    <span class="comment"># 这里可以根据需要实现具体的数据处理逻辑</span></span><br><span class="line">    <span class="comment"># 例如：计算校验和、搜索特定字节模式、转换数据格式等</span></span><br><span class="line">    chunk_size = <span class="built_in">len</span>(chunk)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"处理数据块: <span class="subst">{chunk_size}</span> 字节"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 示例：计算数据块的哈希值</span></span><br><span class="line">    <span class="keyword">import</span> hashlib</span><br><span class="line">    chunk_hash = hashlib.md5(chunk).hexdigest()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"数据块MD5哈希值: <span class="subst">{chunk_hash}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 示例：检查数据块中的特定字节序列</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">b'\x00\x00\xff\xff'</span> <span class="keyword">in</span> chunk:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"在数据块中发现特定字节序列"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回处理结果（可选）</span></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="string">'size'</span>: chunk_size,</span><br><span class="line">        <span class="string">'hash'</span>: chunk_hash</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取文件特定部分</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file_section</span>(<span class="params">file_path, start, length</span>):</span><br><span class="line">    <span class="string">"""读取文件中从start位置开始的length个字节"""</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.seek(start)  <span class="comment"># 移动文件指针到指定位置</span></span><br><span class="line">        <span class="keyword">return</span> f.read(length)  <span class="comment"># 读取指定长度字节</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检测文件类型</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_file_type</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="string">"""通过文件头部特征识别文件类型"""</span></span><br><span class="line">    <span class="comment"># 常见文件格式的魔数（Magic Numbers）</span></span><br><span class="line">    file_signatures = {</span><br><span class="line">        <span class="string">b'\x89PNG\r\n\x1a\n'</span>: <span class="string">'PNG image'</span>,</span><br><span class="line">        <span class="string">b'\xff\xd8\xff'</span>: <span class="string">'JPEG image'</span>,</span><br><span class="line">        <span class="string">b'GIF87a'</span>: <span class="string">'GIF image (87a)'</span>,</span><br><span class="line">        <span class="string">b'GIF89a'</span>: <span class="string">'GIF image (89a)'</span>,</span><br><span class="line">        <span class="string">b'%PDF'</span>: <span class="string">'PDF document'</span>,</span><br><span class="line">        <span class="string">b'PK\x03\x04'</span>: <span class="string">'ZIP archive'</span>,</span><br><span class="line">        <span class="string">b'\x50\x4b\x03\x04'</span>: <span class="string">'ZIP archive'</span>,  <span class="comment"># PK..</span></span><br><span class="line">        <span class="string">b'\x1f\x8b\x08'</span>: <span class="string">'GZIP compressed file'</span>,</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="comment"># 读取文件前16个字节用于检测</span></span><br><span class="line">        header = f.read(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> signature, file_type <span class="keyword">in</span> file_signatures.items():</span><br><span class="line">        <span class="keyword">if</span> header.startswith(signature):</span><br><span class="line">            <span class="keyword">return</span> file_type</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"未知文件类型"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 实际演示：处理图像文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">image_file_demo</span>():</span><br><span class="line">    <span class="string">"""演示二进制文件操作的实际应用"""</span></span><br><span class="line">    <span class="comment"># 定义两个图形的基础文件路径</span></span><br><span class="line">    png_path = <span class="string">"example.png"</span></span><br><span class="line">    jpg_path = <span class="string">"example.jpg"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检测图像类型</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"检测文件类型: <span class="subst">{png_path}</span> 是 <span class="subst">{detect_file_type(png_path)}</span>"</span>) <span class="comment"># 检测文件类型: example.png 是 JPEG image</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"检测文件类型: <span class="subst">{jpg_path}</span> 是 <span class="subst">{detect_file_type(jpg_path)}</span>"</span>) <span class="comment"># 检测文件类型: example.jpg 是 JPEG image</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 读取PNG文件头部信息</span></span><br><span class="line">    png_header = read_file_section(png_path, <span class="number">0</span>, <span class="number">24</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\nPNG文件头部字节: <span class="subst">{png_header.<span class="built_in">hex</span>(<span class="string">' '</span>, <span class="number">4</span>)}</span>"</span>)  <span class="comment"># PNG文件头部字节: ffd8ffe0 00104a46 49460001 01000001 00010000 ffdb0043</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取文件大小</span></span><br><span class="line">    png_data = read_binary_file(png_path)</span><br><span class="line">    jpg_data = read_binary_file(jpg_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 小技巧：在len函数中使用:, 即可以将数字以千分位分隔符展示</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n<span class="subst">{png_path}</span> 文件大小: <span class="subst">{<span class="built_in">len</span>(png_data):,}</span> 字节"</span>) <span class="comment"># example.png 文件大小: 7,189 字节</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{jpg_path}</span> 文件大小: <span class="subst">{<span class="built_in">len</span>(jpg_data):,}</span> 字节"</span>) <span class="comment"># example.jpg 文件大小: 7,189 字节</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 处理大型二进制文件</span></span><br><span class="line">    process_large_binary_file(png_path)</span><br><span class="line">    process_large_binary_file(jpg_path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    image_file_demo()</span><br></pre></td></tr></tbody></table></figure><h4 id="7-6-2-临时文件操作"><a href="#7-6-2-临时文件操作" class="headerlink" title="7.6.2 临时文件操作"></a>7.6.2 临时文件操作</h4><p>临时文件对于需要中间处理结果但不想留下永久文件的操作非常有用。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例2: 使用临时目录处理多个文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_batch_files</span>(<span class="params">data_items</span>):</span><br><span class="line">    <span class="string">"""在临时目录中创建多个文件并进行批处理"""</span></span><br><span class="line">    results = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tempfile.TemporaryDirectory(prefix=<span class="string">"batch_"</span>) <span class="keyword">as</span> temp_dir:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"创建临时工作区 <span class="subst">{temp_dir}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建多个数据文件</span></span><br><span class="line">        file_paths = []</span><br><span class="line">        <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_items):</span><br><span class="line">            <span class="comment"># 获取到临时目录下的文件路径</span></span><br><span class="line">            file_path = os.path.join(temp_dir, <span class="string">f"data_<span class="subst">{i}</span>.txt"</span>)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(data)</span><br><span class="line">            file_paths.append(file_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理所有的文件</span></span><br><span class="line">        <span class="keyword">for</span> file_path <span class="keyword">in</span> file_paths:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                content = f.read()</span><br><span class="line">                <span class="comment"># 模拟处理：计算字符数并添加到结果集中</span></span><br><span class="line">                results.append(<span class="string">f"文件<span class="subst">{os.path.basename(file_path)}</span> 包含 <span class="subst">{<span class="built_in">len</span>(content)}</span> 个字符"</span>)</span><br><span class="line">        <span class="comment"># 列出处理的文件</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"处理文件为<span class="subst">{<span class="string">','</span>.join(os.path.basename(p) <span class="keyword">for</span> p <span class="keyword">in</span> file_paths)}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 退出with块后，tempfile会自动删除临时目录</span></span><br><span class="line">        <span class="comment"># 暂停30秒，等待用户查看结果</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"处理开始，大约需要30秒，请稍候..."</span>)</span><br><span class="line">        time.sleep(random.randint(<span class="number">10</span>, <span class="number">30</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"处理完成"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 演示临时目录的批处理使用</span></span><br><span class="line">data_to_process = [</span><br><span class="line">    <span class="string">"这是第一个文件的测试内容！"</span>,</span><br><span class="line">    <span class="string">"这是第二个文件包含更多的信息以及携带数字13123123123132"</span>,</span><br><span class="line">    <span class="string">"这是第三个文件包含中文，你好，世界！"</span>]</span><br><span class="line"></span><br><span class="line">results = process_batch_files(data_to_process)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n处理结果为:"</span>)</span><br><span class="line"><span class="keyword">for</span> r <span class="keyword">in</span> results:</span><br><span class="line">    <span class="built_in">print</span>(results)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="7-7-目录操作"><a href="#7-7-目录操作" class="headerlink" title="7.7 目录操作"></a>7.7 目录操作</h3><p>目录操作是文件系统操作的重要组成部分，Python 提供了多种目录操作方法。</p><h4 id="7-7-1-基本目录操作"><a href="#7-7-1-基本目录操作" class="headerlink" title="7.7.1 基本目录操作"></a>7.7.1 基本目录操作</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前工作目录</span></span><br><span class="line">current_dir = os.getcwd()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"当前工作目录: <span class="subst">{current_dir}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更改当前工作目录</span></span><br><span class="line">os.chdir(<span class="string">"../"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"更改后的工作目录: <span class="subst">{os.getcwd()}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出目录内容</span></span><br><span class="line">entries = os.listdir(<span class="string">"."</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"目录内容: <span class="subst">{entries}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 过滤目录内容</span></span><br><span class="line">files_only = [f <span class="keyword">for</span> f <span class="keyword">in</span> entries <span class="keyword">if</span> os.path.isfile(f)]</span><br><span class="line">dirs_only = [d <span class="keyword">for</span> d <span class="keyword">in</span> entries <span class="keyword">if</span> os.path.isdir(d)]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"文件: <span class="subst">{files_only}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"目录: <span class="subst">{dirs_only}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line">os.chdir(current_dir) <span class="comment"># 切换回原目录</span></span><br><span class="line">os.mkdir(<span class="string">"new_dir"</span>) <span class="comment"># 创建单个目录</span></span><br><span class="line">os.makedirs(<span class="string">"new_dir2/sub_dir/sub_sub_dir"</span>,exist_ok=<span class="literal">True</span>) <span class="comment"># 创建多级目录 (exist_ok=True 忽略已存在的目录)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除目录</span></span><br><span class="line">os.rmdir(<span class="string">"new_dir"</span>) <span class="comment"># 只能删除空目录</span></span><br><span class="line">shutil.rmtree(<span class="string">"new_dir2"</span>) <span class="comment"># 删除目录以及所有内容(谨慎使用！！！)</span></span><br></pre></td></tr></tbody></table></figure><h4 id="7-7-2-使用-pathlib-进行目录操作"><a href="#7-7-2-使用-pathlib-进行目录操作" class="headerlink" title="7.7.2 使用 pathlib 进行目录操作"></a>7.7.2 使用 pathlib 进行目录操作</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line">Path(<span class="string">"new_dir"</span>).mkdir(exist_ok=<span class="literal">True</span>)</span><br><span class="line">Path(<span class="string">"parent/child/grandchild"</span>).mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>) <span class="comment"># 创建多层目录 parents=True 递归创建父目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出目录内容</span></span><br><span class="line">p = Path(<span class="string">"."</span>)</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> p.iterdir():</span><br><span class="line">    <span class="keyword">if</span> item.is_file():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"文件: <span class="subst">{item}</span>，大小: <span class="subst">{item.stat().st_size}</span> bytes"</span>)</span><br><span class="line">    <span class="keyword">elif</span> item.is_dir():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"目录: <span class="subst">{item}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 过滤特定类型的文件</span></span><br><span class="line">python_files = <span class="built_in">list</span>(p.glob(<span class="string">"*.py"</span>)) <span class="comment"># 列出当前目录下所有.py 文件</span></span><br><span class="line">all_python_files = <span class="built_in">list</span>(p.rglob(<span class="string">"*.py"</span>)) <span class="comment"># 递归搜索所有子目录</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"当前目录下Python文件: <span class="subst">{[f.name <span class="keyword">for</span> f <span class="keyword">in</span> python_files]}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"递归搜索所有Python文件: <span class="subst">{[f.name <span class="keyword">for</span> f <span class="keyword">in</span> all_python_files]}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"所有Python文件: <span class="subst">{<span class="built_in">len</span>(all_python_files)}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除目录</span></span><br><span class="line">Path(<span class="string">'new_dir'</span>).rmdir()  <span class="comment"># 只能删除空目录</span></span><br><span class="line">shutil.rmtree(<span class="string">'parent'</span>) <span class="comment"># 删除目录及其所有内容</span></span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th align="left">操作</th><th align="left">os/shutil 方法</th><th align="left">pathlib 方法</th><th align="left">优势比较</th></tr></thead><tbody><tr><td align="left"><strong>获取当前目录</strong></td><td align="left"><code>os.getcwd()</code></td><td align="left"><code>Path.cwd()</code></td><td align="left">pathlib 返回 Path 对象，便于后续操作</td></tr><tr><td align="left"><strong>切换工作目录</strong></td><td align="left"><code>os.chdir(path)</code></td><td align="left"><em>(无直接等效方法)</em></td><td align="left">os 更适合改变全局工作目录</td></tr><tr><td align="left"><strong>列出目录内容</strong></td><td align="left"><code>os.listdir(path)</code></td><td align="left"><code>Path(path).iterdir()</code></td><td align="left">pathlib 直接返回 Path 对象，无需再拼接路径</td></tr><tr><td align="left"><strong>创建单个目录</strong></td><td align="left"><code>os.mkdir(path)</code></td><td align="left"><code>Path(path).mkdir()</code></td><td align="left">功能相同，pathlib 更面向对象</td></tr><tr><td align="left"><strong>创建多级目录</strong></td><td align="left"><code>os.makedirs(path, exist_ok=True)</code></td><td align="left"><code>Path(path).mkdir(parents=True, exist_ok=True)</code></td><td align="left">语义更明确，参数名更具描述性</td></tr><tr><td align="left"><strong>删除空目录</strong></td><td align="left"><code>os.rmdir(path)</code></td><td align="left"><code>Path(path).rmdir()</code></td><td align="left">功能相同，pathlib 更面向对象</td></tr><tr><td align="left"><strong>递归删除目录</strong></td><td align="left"><code>shutil.rmtree(path)</code></td><td align="left"><em>(无直接等效方法，需循环删除)</em></td><td align="left">os/shutil 提供单一高效操作</td></tr><tr><td align="left"><strong>文件路径拼接</strong></td><td align="left"><code>os.path.join(dir, file)</code></td><td align="left"><code>Path(dir) / file</code></td><td align="left">pathlib 使用/运算符更直观简洁</td></tr><tr><td align="left"><strong>检查路径是否存在</strong></td><td align="left"><code>os.path.exists(path)</code></td><td align="left"><code>Path(path).exists()</code></td><td align="left">功能相同，pathlib 更面向对象</td></tr><tr><td align="left"><strong>检查是否为文件</strong></td><td align="left"><code>os.path.isfile(path)</code></td><td align="left"><code>Path(path).is_file()</code></td><td align="left">功能相同，pathlib 更面向对象</td></tr><tr><td align="left"><strong>检查是否为目录</strong></td><td align="left"><code>os.path.isdir(path)</code></td><td align="left"><code>Path(path).is_dir()</code></td><td align="left">功能相同，pathlib 更面向对象</td></tr></tbody></table><h4 id="7-7-3-递归遍历目录树"><a href="#7-7-3-递归遍历目录树" class="headerlink" title="7.7.3 递归遍历目录树"></a>7.7.3 递归遍历目录树</h4><p>递归遍历是处理目录层次结构的强大工具，在很多需要列举文件目录树的场景都可以采用该思路去打印输出</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用os.walk遍历目录树</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment">#示例输出：</span></span><br><span class="line"><span class="comment"># 学习用/</span></span><br><span class="line"><span class="comment">#     data.txt - 0.04 KB</span></span><br><span class="line"><span class="comment">#     example.jpg - 7.02 KB</span></span><br><span class="line"><span class="comment">#     example.png - 7.02 KB</span></span><br><span class="line"><span class="comment">#     example.py - 4.34 KB</span></span><br><span class="line"><span class="comment">#     example.txt - 0.03 KB</span></span><br><span class="line"><span class="comment">#     main.py - 4.54 KB</span></span><br><span class="line"><span class="comment">#     requirements.txt - 0.01 KB</span></span><br><span class="line"><span class="comment">#     study.py - 1.40 KB</span></span><br><span class="line"><span class="comment">#     电子商务系统实现笔记.md - 24.60 KB</span></span><br><span class="line"><span class="comment">#     (目录大小: 49.00 KB)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan_directory</span>(<span class="params">directory</span>):</span><br><span class="line">    <span class="string">"""递归扫描目录，显示结构和文件大小"""</span></span><br><span class="line">    total_size = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(directory):  <span class="comment"># 其中root：当前目录路径，dirs：子目录列表，files：文件列表</span></span><br><span class="line">        <span class="comment"># 计算当前的目录深度(用于缩进)</span></span><br><span class="line">        <span class="comment"># 计算目录深度：</span></span><br><span class="line">        <span class="comment"># 1. root.replace(directory, "") - 将当前路径中的起始目录部分替换为空字符串，得到相对路径</span></span><br><span class="line">        <span class="comment"># 2. .count(os.sep) - 统计相对路径中目录分隔符(如'/'或'\')的数量</span></span><br><span class="line">        <span class="comment"># 每一个分隔符代表一层目录深度，因此分隔符的数量就等于目录的嵌套层级</span></span><br><span class="line">        level = root.replace(directory, <span class="string">""</span>).count(os.sep)</span><br><span class="line">        indent = <span class="string">' '</span> * <span class="number">4</span> * level</span><br><span class="line">        <span class="comment"># 打印当前目录</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{indent}</span><span class="subst">{os.path.basename(root)}</span>/"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 缩进子文件</span></span><br><span class="line">        sub_indent = <span class="string">' '</span> * <span class="number">4</span> * (level + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 统计当前目录下的文件大小</span></span><br><span class="line">        dir_size = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            file_path = os.path.join(root, file)</span><br><span class="line">            file_size = os.path.getsize(file_path)</span><br><span class="line">            dir_size += file_size</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"<span class="subst">{sub_indent}</span><span class="subst">{file}</span> - <span class="subst">{file_size / <span class="number">1024</span>:<span class="number">.2</span>f}</span> KB"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 累加总大小</span></span><br><span class="line">        total_size += dir_size</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{sub_indent}</span>(目录大小: <span class="subst">{dir_size / <span class="number">1024</span>:<span class="number">.2</span>f}</span> KB)"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> total_size / <span class="number">1024</span>  <span class="comment"># 返回总大小(单位：KB)</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    total_size = scan_directory(<span class="string">'D:/python/学习用'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"总大小: <span class="subst">{total_size:<span class="number">.2</span>f}</span> KB"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="7-7-4-文件复制、移动和删除操作"><a href="#7-7-4-文件复制、移动和删除操作" class="headerlink" title="7.7.4 文件复制、移动和删除操作"></a>7.7.4 文件复制、移动和删除操作</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 文件复制操作 ==========</span></span><br><span class="line"><span class="comment"># shutil.copy(src, dst): 复制文件到目标路径，不保留元数据（如文件的创建时间、修改时间等）</span></span><br><span class="line"><span class="comment"># 参数说明：src - 源文件路径，dst - 目标路径（可以是目录或文件名）</span></span><br><span class="line"><span class="comment"># 返回值：目标文件路径</span></span><br><span class="line">shutil.copy(<span class="string">'source.txt'</span>, <span class="string">'destination.txt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># shutil.copy2(src, dst): 复制文件到目标路径，保留所有元数据（如修改时间、访问时间、权限等）</span></span><br><span class="line"><span class="comment"># 参数说明：同copy函数</span></span><br><span class="line"><span class="comment"># 返回值：目标文件路径</span></span><br><span class="line">shutil.copy2(<span class="string">'source.txt'</span>, <span class="string">'destination.txt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 目录复制操作 ==========</span></span><br><span class="line"><span class="comment"># shutil.copytree(src, dst): 递归复制整个目录树，目标目录不能已存在</span></span><br><span class="line"><span class="comment"># 参数说明：src - 源目录，dst - 目标目录（必须不存在）</span></span><br><span class="line"><span class="comment"># 返回值：目标目录路径</span></span><br><span class="line">shutil.copytree(<span class="string">'source_dir'</span>, <span class="string">'destination_dir'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># shutil.copytree 高级用法：使用ignore参数忽略特定文件</span></span><br><span class="line"><span class="comment"># shutil.ignore_patterns(): 创建一个忽略函数，用于过滤不需要复制的文件</span></span><br><span class="line"><span class="comment"># 参数说明：可变参数，接受多个glob风格的模式字符串</span></span><br><span class="line">shutil.copytree(<span class="string">'source_dir'</span>, <span class="string">'destination_dir'</span>,</span><br><span class="line">                ignore=shutil.ignore_patterns(<span class="string">'*.pyc'</span>, <span class="string">'*.git'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 文件移动操作 ==========</span></span><br><span class="line"><span class="comment"># shutil.move(src, dst): 移动文件或目录到目标路径</span></span><br><span class="line"><span class="comment"># 参数说明：src - 源路径，dst - 目标路径</span></span><br><span class="line"><span class="comment"># 返回值：目标路径</span></span><br><span class="line"><span class="comment"># 用法1：重命名文件</span></span><br><span class="line">shutil.move(<span class="string">'old_name.txt'</span>, <span class="string">'new_name.txt'</span>)</span><br><span class="line"><span class="comment"># 用法2：移动文件到其他目录</span></span><br><span class="line">shutil.move(<span class="string">'file.txt'</span>, <span class="string">'directory/'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 文件删除操作 ==========</span></span><br><span class="line"><span class="comment"># os.remove(path): 删除指定路径的文件（不能删除目录）</span></span><br><span class="line"><span class="comment"># 参数说明：path - 要删除的文件路径</span></span><br><span class="line"><span class="comment"># 注意：如果文件不存在会抛出FileNotFoundError异常</span></span><br><span class="line">os.remove(<span class="string">'file.txt'</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="7-8-文件监控与变更检测"><a href="#7-8-文件监控与变更检测" class="headerlink" title="7.8 文件监控与变更检测"></a>7.8 文件监控与变更检测</h3><p>在某些应用场景中，需要监控文件变化并作出响应。</p><h4 id="7-8-1-基础文件监控"><a href="#7-8-1-基础文件监控" class="headerlink" title="7.8.1 基础文件监控"></a>7.8.1 基础文件监控</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">monitor_file</span>(<span class="params">file_path, interval=<span class="number">1</span>, encoding=<span class="string">'utf-8'</span></span>):</span><br><span class="line">    <span class="string">"""监控文件变化，并输出新增内容"""</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"文件 <span class="subst">{file_path}</span> 不存在"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取初始状态</span></span><br><span class="line">    last_size = os.path.getsize(file_path) <span class="comment"># 文件大小</span></span><br><span class="line">    last_modified = os.path.getmtime(file_path) <span class="comment"># 最后修改时间戳</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"开始监控文件:<span class="subst">{file_path}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"文件大小:<span class="subst">{last_size}</span> 最后修改时间:<span class="subst">{time.ctime(last_modified)}</span>"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># 检查文件是否被修改</span></span><br><span class="line">            current_modified = os.path.getmtime(file_path)</span><br><span class="line">            current_size = os.path.getsize(file_path)</span><br><span class="line">            <span class="keyword">if</span> current_modified != last_modified:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"文件在<span class="subst">{time.ctime(current_modified)}</span>被修改"</span>)</span><br><span class="line">            <span class="comment"># 如果文件增大了，读取新增内容</span></span><br><span class="line">            <span class="keyword">if</span> current_size &gt; last_size:</span><br><span class="line">                <span class="comment"># 尝试不同的编码方式读取文件</span></span><br><span class="line">                encodings_to_try = [<span class="string">'utf-8'</span>, <span class="string">'gbk'</span>, <span class="string">'gb2312'</span>, <span class="string">'gb18030'</span>]</span><br><span class="line">                content_read = <span class="literal">False</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> enc <span class="keyword">in</span> encodings_to_try:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">"r"</span>, encoding=enc) <span class="keyword">as</span> f:</span><br><span class="line">                            f.seek(last_size) <span class="comment"># 移动文件指针到上次读取位置</span></span><br><span class="line">                            new_content = f.read()</span><br><span class="line">                            <span class="built_in">print</span>(<span class="string">f"新增内容:\n<span class="subst">{new_content}</span>"</span>)</span><br><span class="line">                            <span class="comment"># 更新当前使用的编码</span></span><br><span class="line">                            encoding = enc</span><br><span class="line">                            content_read = <span class="literal">True</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> content_read:</span><br><span class="line">                    <span class="comment"># 如果所有编码都失败，尝试以二进制方式读取并显示</span></span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                            f.seek(last_size)</span><br><span class="line">                            binary_content = f.read()</span><br><span class="line">                            <span class="built_in">print</span>(<span class="string">f"无法解码文件内容，显示二进制内容: <span class="subst">{binary_content}</span>"</span>)</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f"读取文件失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                        </span><br><span class="line">            <span class="keyword">elif</span> current_size &lt; last_size: <span class="comment"># 文件缩小了，可能是被清空了</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"文件大小减小了，可能被截断或重写"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 更新状态</span></span><br><span class="line">            last_modified = current_modified</span><br><span class="line">            last_size = current_size</span><br><span class="line"></span><br><span class="line">            time.sleep(interval) <span class="comment"># 休眠一段时间再检查文件</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"监控已停止"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    monitor_file(<span class="string">"destination.txt"</span>, interval=<span class="number">1</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="7-8-2-使用-watchdog-库进行高级文件监控"><a href="#7-8-2-使用-watchdog-库进行高级文件监控" class="headerlink" title="7.8.2 使用 watchdog 库进行高级文件监控"></a>7.8.2 使用 watchdog 库进行高级文件监控</h4><p>对于更复杂的文件系统监控需求，Python 的第三方库 <code>watchdog</code> 提供了更强大的功能：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> watchdog.observers <span class="keyword">import</span> Observer</span><br><span class="line"><span class="keyword">from</span> watchdog.events <span class="keyword">import</span> FileSystemEventHandler, DirCreatedEvent, FileCreatedEvent, DirDeletedEvent, \</span><br><span class="line">    FileDeletedEvent, DirModifiedEvent, FileModifiedEvent, DirMovedEvent, FileMovedEvent</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyHandler</span>(<span class="title class_ inherited__">FileSystemEventHandler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_created</span>(<span class="params">self, event: DirCreatedEvent | FileCreatedEvent</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> event.is_directory:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"文件被创建: <span class="subst">{event.src_path}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_deleted</span>(<span class="params">self, event: DirDeletedEvent | FileDeletedEvent</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> event.is_directory:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"文件被删除: <span class="subst">{event.src_path}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_modified</span>(<span class="params">self, event: DirModifiedEvent | FileModifiedEvent</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> event.is_directory:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"文件被修改: <span class="subst">{event.src_path}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_moved</span>(<span class="params">self, event: DirMovedEvent | FileMovedEvent</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> event.is_directory:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"文件被移动: <span class="subst">{event.src_path}</span> -&gt; <span class="subst">{event.dest_path}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">watch_directory</span>(<span class="params">path: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="comment"># 确保监控的是目录而不是文件</span></span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(path):</span><br><span class="line">        <span class="comment"># 如果是文件，则监控其所在的目录</span></span><br><span class="line">        directory = os.path.dirname(path)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> directory:  <span class="comment"># 如果是当前目录下的文件</span></span><br><span class="line">            directory = <span class="string">'.'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        directory = path</span><br><span class="line">    </span><br><span class="line">    event_handler = MyHandler()</span><br><span class="line">    observer = Observer()</span><br><span class="line">    observer.schedule(event_handler, directory, recursive=<span class="literal">True</span>)</span><br><span class="line">    observer.start()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"开始监控目录: <span class="subst">{directory}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"按Ctrl+C停止监控..."</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        observer.stop()</span><br><span class="line">    observer.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    watch_directory(<span class="string">"."</span>)  <span class="comment"># 监控当前目录，或者指定一个确实存在的目录路径</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="7-9-实际应用场景示例"><a href="#7-9-实际应用场景示例" class="headerlink" title="7.9 实际应用场景示例"></a>7.9 实际应用场景示例</h3><h4 id="7-9-1-文件备份工具"><a href="#7-9-1-文件备份工具" class="headerlink" title="7.9.1 文件备份工具"></a>7.9.1 文件备份工具</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backup_directory</span>(<span class="params">source_dir, backup_dir=<span class="literal">None</span>, zip_backup=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    创建目录的备份</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">        source_dir: 要备份的源目录</span></span><br><span class="line"><span class="string">        backup_dir: 备份文件存放目录(默认在源目录的父目录)</span></span><br><span class="line"><span class="string">        zip_backup: 是否创建zip压缩备份</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">        备份文件的路径</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 确保源目录存在</span></span><br><span class="line">    source_path = Path(source_dir)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> source_path.exists() <span class="keyword">or</span> <span class="keyword">not</span> source_path.is_dir():</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f"源目录 '<span class="subst">{source_dir}</span>' 不存在或不是一个目录"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设置默认备份目录</span></span><br><span class="line">    <span class="keyword">if</span> backup_dir <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        backup_dir = source_path.parent</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        backup_dir = Path(backup_dir)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> backup_dir.exists():</span><br><span class="line">            backup_dir.mkdir(parents=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建备份文件名(包含时间戳)</span></span><br><span class="line">    timestamp = datetime.datetime.now().strftime(<span class="string">"%Y%m%d_%H%M%S"</span>)</span><br><span class="line">    backup_name = <span class="string">f"<span class="subst">{source_path.name}</span>_backup_<span class="subst">{timestamp}</span>"</span></span><br><span class="line">    backup_path = backup_dir / backup_name</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> zip_backup:</span><br><span class="line">        <span class="comment"># 创建ZIP备份</span></span><br><span class="line">        zip_path = <span class="built_in">str</span>(backup_path) + <span class="string">'.zip'</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"创建ZIP备份: <span class="subst">{zip_path}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> zipfile.ZipFile(zip_path, <span class="string">'w'</span>, zipfile.ZIP_DEFLATED) <span class="keyword">as</span> zipf:</span><br><span class="line">            <span class="comment"># 遍历源目录中的所有文件</span></span><br><span class="line">            <span class="keyword">for</span> root, _, files <span class="keyword">in</span> os.walk(source_dir):</span><br><span class="line">                <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">                    file_path = os.path.join(root, file)</span><br><span class="line">                    <span class="comment"># 计算文件在ZIP中的相对路径</span></span><br><span class="line">                    rel_path = os.path.relpath(file_path, source_dir)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f"添加: <span class="subst">{rel_path}</span>"</span>)</span><br><span class="line">                    zipf.write(file_path, rel_path)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> zip_path</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 创建目录备份(复制)</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"创建目录备份: <span class="subst">{backup_path}</span>"</span>)</span><br><span class="line">        shutil.copytree(source_path, backup_path)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(backup_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="comment"># source = "/path/to/important_data"</span></span><br><span class="line"><span class="comment"># backup = backup_directory(source, zip_backup=True)</span></span><br><span class="line"><span class="comment"># print(f"备份已创建: {backup}")</span></span><br></pre></td></tr></tbody></table></figure><h4 id="7-9-2-日志分析工具"><a href="#7-9-2-日志分析工具" class="headerlink" title="7.9.2 日志分析工具"></a>7.9.2 日志分析工具</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_log_file</span>(<span class="params">log_path, pattern=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分析日志文件并生成报告</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">        log_path: 日志文件路径</span></span><br><span class="line"><span class="string">        pattern: 用于匹配日志行的正则表达式模式(默认为None，表示所有行)</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">        包含分析结果的字典</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    log_path = Path(log_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> log_path.exists():</span><br><span class="line">        <span class="keyword">raise</span> FileNotFoundError(<span class="string">f"日志文件不存在: <span class="subst">{log_path}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 初始化结果</span></span><br><span class="line">    results = {</span><br><span class="line">        <span class="string">'total_lines'</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">'matched_lines'</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">'errors'</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">'warnings'</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">'by_hour'</span>: Counter(),</span><br><span class="line">        <span class="string">'ip_addresses'</span>: Counter(),</span><br><span class="line">        <span class="string">'status_codes'</span>: Counter(),</span><br><span class="line">        <span class="string">'top_urls'</span>: Counter()</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 编译正则表达式</span></span><br><span class="line">    <span class="keyword">if</span> pattern:</span><br><span class="line">        regex = re.<span class="built_in">compile</span>(pattern)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># IP地址模式</span></span><br><span class="line">    ip_pattern = re.<span class="built_in">compile</span>(<span class="string">r'\b(?:\d{1,3}\.){3}\d{1,3}\b'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># HTTP状态码模式</span></span><br><span class="line">    status_pattern = re.<span class="built_in">compile</span>(<span class="string">r'\s(\d{3})\s'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 时间戳模式(假设格式为[DD/Mon/YYYY:HH:MM:SS +ZZZZ])</span></span><br><span class="line">    timestamp_pattern = re.<span class="built_in">compile</span>(<span class="string">r'\[(\d{2}/\w{3}/\d{4}):(\d{2}):\d{2}:\d{2}\s[+\-]\d{4}\]'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># URL模式</span></span><br><span class="line">    url_pattern = re.<span class="built_in">compile</span>(<span class="string">r'"(?:GET|POST|PUT|DELETE)\s+([^\s"]+)'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 错误和警告模式</span></span><br><span class="line">    error_pattern = re.<span class="built_in">compile</span>(<span class="string">r'ERROR|CRITICAL|FATAL'</span>, re.IGNORECASE)</span><br><span class="line">    warning_pattern = re.<span class="built_in">compile</span>(<span class="string">r'WARNING|WARN'</span>, re.IGNORECASE)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 读取和分析日志文件</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(log_path, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>, errors=<span class="string">'ignore'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            results[<span class="string">'total_lines'</span>] += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 应用模式匹配过滤(如果提供)</span></span><br><span class="line">            <span class="keyword">if</span> pattern <span class="keyword">and</span> <span class="keyword">not</span> regex.search(line):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            results[<span class="string">'matched_lines'</span>] += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 提取IP地址</span></span><br><span class="line">            ip_matches = ip_pattern.findall(line)</span><br><span class="line">            <span class="keyword">if</span> ip_matches:</span><br><span class="line">                results[<span class="string">'ip_addresses'</span>].update([ip_matches[<span class="number">0</span>]])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 提取HTTP状态码</span></span><br><span class="line">            status_match = status_pattern.search(line)</span><br><span class="line">            <span class="keyword">if</span> status_match:</span><br><span class="line">                results[<span class="string">'status_codes'</span>].update([status_match.group(<span class="number">1</span>)])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 提取URL</span></span><br><span class="line">            url_match = url_pattern.search(line)</span><br><span class="line">            <span class="keyword">if</span> url_match:</span><br><span class="line">                results[<span class="string">'top_urls'</span>].update([url_match.group(<span class="number">1</span>)])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 提取时间并按小时汇总</span></span><br><span class="line">            time_match = timestamp_pattern.search(line)</span><br><span class="line">            <span class="keyword">if</span> time_match:</span><br><span class="line">                date_str, hour = time_match.groups()</span><br><span class="line">                results[<span class="string">'by_hour'</span>].update([<span class="built_in">int</span>(hour)])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查错误和警告</span></span><br><span class="line">            <span class="keyword">if</span> error_pattern.search(line):</span><br><span class="line">                results[<span class="string">'errors'</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> warning_pattern.search(line):</span><br><span class="line">                results[<span class="string">'warnings'</span>] += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_log_report</span>(<span class="params">results, output_dir=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""生成日志分析报告(文本和图表)"""</span></span><br><span class="line">    output_dir = Path(output_dir) <span class="keyword">if</span> output_dir <span class="keyword">else</span> Path.cwd()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> output_dir.exists():</span><br><span class="line">        output_dir.mkdir(parents=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建文本报告</span></span><br><span class="line">    report_path = output_dir / <span class="string">"log_analysis_report.txt"</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(report_path, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">"=== 日志分析报告 ===\n"</span>)</span><br><span class="line">        f.write(<span class="string">f"总行数: <span class="subst">{results[<span class="string">'total_lines'</span>]}</span>\n"</span>)</span><br><span class="line">        f.write(<span class="string">f"匹配行数: <span class="subst">{results[<span class="string">'matched_lines'</span>]}</span>\n"</span>)</span><br><span class="line">        f.write(<span class="string">f"错误数: <span class="subst">{results[<span class="string">'errors'</span>]}</span>\n"</span>)</span><br><span class="line">        f.write(<span class="string">f"警告数: <span class="subst">{results[<span class="string">'warnings'</span>]}</span>\n\n"</span>)</span><br><span class="line">        </span><br><span class="line">        f.write(<span class="string">"=== 按小时分布 ===\n"</span>)</span><br><span class="line">        <span class="keyword">for</span> hour <span class="keyword">in</span> <span class="built_in">sorted</span>(results[<span class="string">'by_hour'</span>]):</span><br><span class="line">            f.write(<span class="string">f"<span class="subst">{hour}</span>时: <span class="subst">{results[<span class="string">'by_hour'</span>][hour]}</span>行\n"</span>)</span><br><span class="line">        </span><br><span class="line">        f.write(<span class="string">"\n=== 前10个IP地址 ===\n"</span>)</span><br><span class="line">        <span class="keyword">for</span> ip, count <span class="keyword">in</span> results[<span class="string">'ip_addresses'</span>].most_common(<span class="number">10</span>):</span><br><span class="line">            f.write(<span class="string">f"<span class="subst">{ip}</span>: <span class="subst">{count}</span>次\n"</span>)</span><br><span class="line">        </span><br><span class="line">        f.write(<span class="string">"\n=== HTTP状态码统计 ===\n"</span>)</span><br><span class="line">        <span class="keyword">for</span> status, count <span class="keyword">in</span> results[<span class="string">'status_codes'</span>].most_common():</span><br><span class="line">            f.write(<span class="string">f"<span class="subst">{status}</span>: <span class="subst">{count}</span>次\n"</span>)</span><br><span class="line">        </span><br><span class="line">        f.write(<span class="string">"\n=== 前10个URL ===\n"</span>)</span><br><span class="line">        <span class="keyword">for</span> url, count <span class="keyword">in</span> results[<span class="string">'top_urls'</span>].most_common(<span class="number">10</span>):</span><br><span class="line">            f.write(<span class="string">f"<span class="subst">{url}</span>: <span class="subst">{count}</span>次\n"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成图表报告</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 1. 按小时分布图</span></span><br><span class="line">    plt.figure(figsize=(<span class="number">10</span>, <span class="number">6</span>))</span><br><span class="line">    hours = <span class="built_in">range</span>(<span class="number">24</span>)</span><br><span class="line">    counts = [results[<span class="string">'by_hour'</span>].get(hour, <span class="number">0</span>) <span class="keyword">for</span> hour <span class="keyword">in</span> hours]</span><br><span class="line">    plt.bar(hours, counts)</span><br><span class="line">    plt.xlabel(<span class="string">'小时'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'日志条目数'</span>)</span><br><span class="line">    plt.title(<span class="string">'日志按小时分布'</span>)</span><br><span class="line">    plt.xticks(hours)</span><br><span class="line">    plt.grid(<span class="literal">True</span>, axis=<span class="string">'y'</span>, alpha=<span class="number">0.3</span>)</span><br><span class="line">    plt.savefig(output_dir / <span class="string">'hourly_distribution.png'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. HTTP状态码分布饼图</span></span><br><span class="line">    plt.figure(figsize=(<span class="number">8</span>, <span class="number">8</span>))</span><br><span class="line">    status_codes = <span class="built_in">list</span>(results[<span class="string">'status_codes'</span>].keys())</span><br><span class="line">    counts = <span class="built_in">list</span>(results[<span class="string">'status_codes'</span>].values())</span><br><span class="line">    plt.pie(counts, labels=status_codes, autopct=<span class="string">'%1.1f%%'</span>, startangle=<span class="number">140</span>)</span><br><span class="line">    plt.axis(<span class="string">'equal'</span>)</span><br><span class="line">    plt.title(<span class="string">'HTTP状态码分布'</span>)</span><br><span class="line">    plt.savefig(output_dir / <span class="string">'status_codes_pie.png'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. 前5个IP地址条形图</span></span><br><span class="line">    plt.figure(figsize=(<span class="number">10</span>, <span class="number">6</span>))</span><br><span class="line">    top_ips = results[<span class="string">'ip_addresses'</span>].most_common(<span class="number">5</span>)</span><br><span class="line">    ips = [ip <span class="keyword">for</span> ip, _ <span class="keyword">in</span> top_ips]</span><br><span class="line">    counts = [count <span class="keyword">for</span> _, count <span class="keyword">in</span> top_ips]</span><br><span class="line">    plt.barh(ips, counts)</span><br><span class="line">    plt.xlabel(<span class="string">'请求次数'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'IP地址'</span>)</span><br><span class="line">    plt.title(<span class="string">'前5个IP地址'</span>)</span><br><span class="line">    plt.grid(<span class="literal">True</span>, axis=<span class="string">'x'</span>, alpha=<span class="number">0.3</span>)</span><br><span class="line">    plt.tight_layout()</span><br><span class="line">    plt.savefig(output_dir / <span class="string">'top_ips.png'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> report_path</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="comment"># log_file = "access.log"</span></span><br><span class="line"><span class="comment"># results = analyze_log_file(log_file)</span></span><br><span class="line"><span class="comment"># report_path = generate_log_report(results, "reports")</span></span><br><span class="line"><span class="comment"># print(f"报告已生成: {report_path}")</span></span><br></pre></td></tr></tbody></table></figure><h4 id="7-9-3-文件同步工具"><a href="#7-9-3-文件同步工具" class="headerlink" title="7.9.3 文件同步工具"></a>7.9.3 文件同步工具</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">'%(asctime)s - %(levelname)s - %(message)s'</span>,</span><br><span class="line">    handlers=[</span><br><span class="line">        logging.FileHandler(<span class="string">"file_sync.log"</span>),</span><br><span class="line">        logging.StreamHandler()</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_file_hash</span>(<span class="params">filepath</span>):</span><br><span class="line">    <span class="string">"""计算文件的MD5哈希值"""</span></span><br><span class="line">    hash_md5 = hashlib.md5()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> <span class="built_in">iter</span>(<span class="keyword">lambda</span>: f.read(<span class="number">4096</span>), <span class="string">b""</span>):</span><br><span class="line">            hash_md5.update(chunk)</span><br><span class="line">    <span class="keyword">return</span> hash_md5.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sync_directories</span>(<span class="params">source_dir, target_dir, delete=<span class="literal">False</span>, exclude=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    同步两个目录的内容</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">        source_dir: 源目录</span></span><br><span class="line"><span class="string">        target_dir: 目标目录</span></span><br><span class="line"><span class="string">        delete: 是否删除目标目录中源目录没有的文件</span></span><br><span class="line"><span class="string">        exclude: 要排除的文件/目录列表</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">        操作统计信息</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    source_dir = Path(source_dir)</span><br><span class="line">    target_dir = Path(target_dir)</span><br><span class="line">    exclude = exclude <span class="keyword">or</span> []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 确保目录存在</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> source_dir.exists():</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f"源目录不存在: <span class="subst">{source_dir}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> target_dir.exists():</span><br><span class="line">        logging.info(<span class="string">f"创建目标目录: <span class="subst">{target_dir}</span>"</span>)</span><br><span class="line">        target_dir.mkdir(parents=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 初始化统计</span></span><br><span class="line">    stats = {</span><br><span class="line">        <span class="string">"copied"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">"updated"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">"deleted"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">"skipped"</span>: <span class="number">0</span></span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取源文件清单</span></span><br><span class="line">    source_files = {}</span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(source_dir):</span><br><span class="line">        <span class="comment"># 从dirs中移除要排除的目录(修改原地)</span></span><br><span class="line">        dirs[:] = [d <span class="keyword">for</span> d <span class="keyword">in</span> dirs <span class="keyword">if</span> d <span class="keyword">not</span> <span class="keyword">in</span> exclude]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            <span class="keyword">if</span> file <span class="keyword">in</span> exclude:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">            file_path = Path(root) / file</span><br><span class="line">            rel_path = file_path.relative_to(source_dir)</span><br><span class="line">            source_files[rel_path] = file_path</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 同步文件到目标目录</span></span><br><span class="line">    <span class="keyword">for</span> rel_path, source_path <span class="keyword">in</span> source_files.items():</span><br><span class="line">        target_path = target_dir / rel_path</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 确保目标目录存在</span></span><br><span class="line">        target_path.parent.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查文件是否需要更新</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> target_path.exists():</span><br><span class="line">            logging.info(<span class="string">f"复制新文件: <span class="subst">{rel_path}</span>"</span>)</span><br><span class="line">            shutil.copy2(source_path, target_path)</span><br><span class="line">            stats[<span class="string">"copied"</span>] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 比较修改时间和哈希值</span></span><br><span class="line">            source_mtime = os.path.getmtime(source_path)</span><br><span class="line">            target_mtime = os.path.getmtime(target_path)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">abs</span>(source_mtime - target_mtime) &gt; <span class="number">1</span>:  <span class="comment"># 1秒容差</span></span><br><span class="line">                <span class="comment"># 进一步比较内容哈希</span></span><br><span class="line">                source_hash = calculate_file_hash(source_path)</span><br><span class="line">                target_hash = calculate_file_hash(target_path)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> source_hash != target_hash:</span><br><span class="line">                    logging.info(<span class="string">f"更新文件: <span class="subst">{rel_path}</span>"</span>)</span><br><span class="line">                    shutil.copy2(source_path, target_path)</span><br><span class="line">                    stats[<span class="string">"updated"</span>] += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    stats[<span class="string">"skipped"</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                stats[<span class="string">"skipped"</span>] += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 处理需要删除的文件</span></span><br><span class="line">    <span class="keyword">if</span> delete:</span><br><span class="line">        <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(target_dir):</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">                file_path = Path(root) / file</span><br><span class="line">                rel_path = file_path.relative_to(target_dir)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> rel_path <span class="keyword">not</span> <span class="keyword">in</span> source_files <span class="keyword">and</span> file <span class="keyword">not</span> <span class="keyword">in</span> exclude:</span><br><span class="line">                    logging.info(<span class="string">f"删除多余文件: <span class="subst">{rel_path}</span>"</span>)</span><br><span class="line">                    file_path.unlink()</span><br><span class="line">                    stats[<span class="string">"deleted"</span>] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 删除空目录(从下向上遍历)</span></span><br><span class="line">        <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(target_dir, topdown=<span class="literal">False</span>):</span><br><span class="line">            <span class="keyword">for</span> dir_name <span class="keyword">in</span> dirs:</span><br><span class="line">                dir_path = Path(root) / dir_name</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">any</span>(dir_path.iterdir()):  <span class="comment"># 检查目录是否为空</span></span><br><span class="line">                    logging.info(<span class="string">f"删除空目录: <span class="subst">{dir_path.relative_to(target_dir)}</span>"</span>)</span><br><span class="line">                    dir_path.rmdir()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> stats</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定期同步功能</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">periodic_sync</span>(<span class="params">source_dir, target_dir, interval=<span class="number">3600</span>, delete=<span class="literal">False</span>, exclude=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    定期同步两个目录</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">        source_dir: 源目录</span></span><br><span class="line"><span class="string">        target_dir: 目标目录</span></span><br><span class="line"><span class="string">        interval: 同步间隔(秒)</span></span><br><span class="line"><span class="string">        delete: 是否删除目标目录中多余文件</span></span><br><span class="line"><span class="string">        exclude: 要排除的文件/目录列表</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    logging.info(<span class="string">f"启动定期同步: 从 <span class="subst">{source_dir}</span> 到 <span class="subst">{target_dir}</span>, 间隔 <span class="subst">{interval}</span>秒"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            logging.info(<span class="string">"开始同步..."</span>)</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                stats = sync_directories(source_dir, target_dir, delete, exclude)</span><br><span class="line">                logging.info(<span class="string">f"同步完成: 复制=<span class="subst">{stats[<span class="string">'copied'</span>]}</span>, 更新=<span class="subst">{stats[<span class="string">'updated'</span>]}</span>, "</span></span><br><span class="line">                            <span class="string">f"删除=<span class="subst">{stats[<span class="string">'deleted'</span>]}</span>, 跳过=<span class="subst">{stats[<span class="string">'skipped'</span>]}</span>"</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logging.error(<span class="string">f"同步出错: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 计算实际等待时间</span></span><br><span class="line">            elapsed = time.time() - start_time</span><br><span class="line">            wait_time = <span class="built_in">max</span>(<span class="number">0</span>, interval - elapsed)</span><br><span class="line">            </span><br><span class="line">            logging.info(<span class="string">f"等待<span class="subst">{wait_time:<span class="number">.1</span>f}</span>秒后进行下次同步..."</span>)</span><br><span class="line">            time.sleep(wait_time)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        logging.info(<span class="string">"同步服务已停止"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="comment"># sync_directories("/path/to/source", "/path/to/backup", delete=True, exclude=[".git", "node_modules"])</span></span><br><span class="line"><span class="comment"># 定期同步(每小时)</span></span><br><span class="line"><span class="comment"># periodic_sync("/path/to/source", "/path/to/backup", interval=3600, delete=True)</span></span><br></pre></td></tr></tbody></table></figure><h2 id="第八章：-函数知识总结"><a href="#第八章：-函数知识总结" class="headerlink" title="第八章： 函数知识总结"></a>第八章： 函数知识总结</h2><h3 id="8-1-内置函数"><a href="#8-1-内置函数" class="headerlink" title="8.1 内置函数"></a>8.1 内置函数</h3><h4 id="数学和数值计算"><a href="#数学和数值计算" class="headerlink" title="数学和数值计算"></a>数学和数值计算</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">abs</span>(-<span class="number">2</span>)           <span class="comment"># 绝对值：2</span></span><br><span class="line"><span class="built_in">divmod</span>(<span class="number">20</span>, <span class="number">3</span>)     <span class="comment"># 商和余数：(6, 2)</span></span><br><span class="line"><span class="built_in">round</span>(<span class="number">4.51</span>)       <span class="comment"># 四舍五入：5</span></span><br><span class="line"><span class="built_in">pow</span>(<span class="number">10</span>, <span class="number">2</span>)        <span class="comment"># 幂运算：100</span></span><br><span class="line"><span class="built_in">pow</span>(<span class="number">10</span>, <span class="number">2</span>, <span class="number">3</span>)     <span class="comment"># 幂运算后取余：1</span></span><br><span class="line"><span class="built_in">sum</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])    <span class="comment"># 求和：6</span></span><br><span class="line"><span class="built_in">min</span>(<span class="number">5</span>, <span class="number">3</span>, <span class="number">9</span>)      <span class="comment"># 最小值：3</span></span><br><span class="line"><span class="built_in">max</span>(<span class="number">7</span>, <span class="number">3</span>, <span class="number">15</span>)     <span class="comment"># 最大值：15</span></span><br></pre></td></tr></tbody></table></figure><h4 id="进制转换"><a href="#进制转换" class="headerlink" title="进制转换"></a>进制转换</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bin</span>(<span class="number">10</span>)           <span class="comment"># 转二进制：'0b1010'</span></span><br><span class="line"><span class="built_in">oct</span>(<span class="number">10</span>)           <span class="comment"># 转八进制：'0o12'</span></span><br><span class="line"><span class="built_in">hex</span>(<span class="number">10</span>)           <span class="comment"># 转十六进制：'0xa'</span></span><br></pre></td></tr></tbody></table></figure><h4 id="字符编码"><a href="#字符编码" class="headerlink" title="字符编码"></a>字符编码</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bytes</span>(<span class="string">"你好"</span>, encoding=<span class="string">"utf-8"</span>)  <span class="comment"># 字符串转字节：b'\xe4\xbd\xa0\xe5\xa5\xbd'</span></span><br><span class="line"><span class="built_in">bytearray</span>(<span class="string">"hi"</span>, encoding=<span class="string">'utf-8'</span>)  <span class="comment"># 可变字节数组</span></span><br><span class="line"><span class="built_in">ord</span>(<span class="string">'a'</span>)          <span class="comment"># 字符码位：97</span></span><br><span class="line"><span class="built_in">chr</span>(<span class="number">65</span>)           <span class="comment"># 码位对应字符：'A'</span></span><br></pre></td></tr></tbody></table></figure><h4 id="反射函数"><a href="#反射函数" class="headerlink" title="反射函数"></a>反射函数</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span>(obj)          <span class="comment"># 查看对象的所有属性</span></span><br><span class="line"><span class="built_in">hasattr</span>(obj, <span class="string">'attr'</span>)  <span class="comment"># 检查对象是否有属性</span></span><br><span class="line"><span class="built_in">getattr</span>(obj, <span class="string">'attr'</span>)  <span class="comment"># 获取对象属性</span></span><br><span class="line"><span class="built_in">setattr</span>(obj, <span class="string">'attr'</span>, value)  <span class="comment"># 设置对象属性</span></span><br><span class="line"><span class="built_in">delattr</span>(obj, <span class="string">'attr'</span>)  <span class="comment"># 删除对象属性</span></span><br></pre></td></tr></tbody></table></figure><h4 id="其他常用内置函数"><a href="#其他常用内置函数" class="headerlink" title="其他常用内置函数"></a>其他常用内置函数</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">len</span>(<span class="string">"hello"</span>)      <span class="comment"># 获取长度：5</span></span><br><span class="line"><span class="built_in">isinstance</span>(obj, <span class="built_in">type</span>)  <span class="comment"># 类型检查</span></span><br><span class="line"><span class="built_in">issubclass</span>(cls1, cls2)  <span class="comment"># 检查类继承关系</span></span><br><span class="line"><span class="built_in">id</span>(obj)           <span class="comment"># 获取对象内存地址</span></span><br><span class="line"><span class="built_in">type</span>(obj)         <span class="comment"># 获取对象类型</span></span><br></pre></td></tr></tbody></table></figure><h3 id="8-2-函数定义与调用"><a href="#8-2-函数定义与调用" class="headerlink" title="8.2 函数定义与调用"></a>8.2 函数定义与调用</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本函数定义</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">function_name</span>(<span class="params">parameters</span>):</span><br><span class="line">    <span class="string">"""文档字符串：描述函数功能"""</span></span><br><span class="line">    <span class="comment"># 函数体</span></span><br><span class="line">    <span class="keyword">return</span> value  <span class="comment"># 可选</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用函数</span></span><br><span class="line">result = function_name(arguments)</span><br></pre></td></tr></tbody></table></figure><h3 id="8-3-函数参数"><a href="#8-3-函数参数" class="headerlink" title="8.3 函数参数"></a>8.3 函数参数</h3><h4 id="位置参数"><a href="#位置参数" class="headerlink" title="位置参数"></a>位置参数</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">x, y, z</span>):</span><br><span class="line">    <span class="built_in">print</span>(x, y, z)</span><br><span class="line">    </span><br><span class="line">test(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)  <span class="comment"># 必须按顺序提供所有参数</span></span><br></pre></td></tr></tbody></table></figure><h4 id="关键字参数"><a href="#关键字参数" class="headerlink" title="关键字参数"></a>关键字参数</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">x, y, z</span>):</span><br><span class="line">    <span class="built_in">print</span>(x, y, z)</span><br><span class="line">    </span><br><span class="line">test(y=<span class="number">1</span>, x=<span class="number">2</span>, z=<span class="number">3</span>)  <span class="comment"># 通过参数名指定，顺序可变</span></span><br></pre></td></tr></tbody></table></figure><h4 id="默认参数"><a href="#默认参数" class="headerlink" title="默认参数"></a>默认参数</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">x, y, z=<span class="number">2</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(x, y, z)</span><br><span class="line">    </span><br><span class="line">test(<span class="number">1</span>, <span class="number">2</span>)      <span class="comment"># z使用默认值2</span></span><br><span class="line">test(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)   <span class="comment"># 覆盖默认值</span></span><br></pre></td></tr></tbody></table></figure><h4 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># *args：接收多余的位置参数，形成元组</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">x, *args</span>):</span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line">    <span class="built_in">print</span>(args)</span><br><span class="line">    </span><br><span class="line">test(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)  <span class="comment"># x=1, args=(2, 3, 4)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># **kwargs：接收多余的关键字参数，形成字典</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">x, **kwargs</span>):</span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line">    <span class="built_in">print</span>(kwargs)</span><br><span class="line">    </span><br><span class="line">test(x=<span class="number">1</span>, y=<span class="number">2</span>, z=<span class="number">3</span>)  <span class="comment"># x=1, kwargs={'y': 2, 'z': 3}</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 混合使用</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">x, *args, **kwargs</span>):</span><br><span class="line">    <span class="built_in">print</span>(x, args, kwargs)</span><br><span class="line">    </span><br><span class="line">test(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, y=<span class="number">4</span>, z=<span class="number">5</span>)  <span class="comment"># x=1, args=(2, 3), kwargs={'y': 4, 'z': 5}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="8-4-作用域与命名空间"><a href="#8-4-作用域与命名空间" class="headerlink" title="8.4 作用域与命名空间"></a>8.4 作用域与命名空间</h3><h4 id="名称空间"><a href="#名称空间" class="headerlink" title="名称空间"></a>名称空间</h4><p>Python 有三层名称空间：</p><ol><li><strong>内置名称空间</strong>：Python 解释器启动时创建，包含内置函数</li><li><strong>全局名称空间</strong>：模块级别创建，包含模块中定义的变量</li><li><strong>局部名称空间</strong>：函数调用时创建，包含函数内部变量</li></ol><h4 id="LEGB-规则"><a href="#LEGB-规则" class="headerlink" title="LEGB 规则"></a>LEGB 规则</h4><p>变量查找顺序：</p><ol><li><strong>Local</strong>：局部作用域</li><li><strong>Enclosing</strong>：外部嵌套函数作用域</li><li><strong>Global</strong>：全局作用域</li><li><strong>Built-in</strong>：内置作用域</li></ol><h4 id="作用域修饰"><a href="#作用域修饰" class="headerlink" title="作用域修饰"></a>作用域修饰</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># global：声明变量为全局变量</span></span><br><span class="line">x = <span class="number">10</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">modify_global</span>():</span><br><span class="line">    <span class="keyword">global</span> x</span><br><span class="line">    x = <span class="number">20</span></span><br><span class="line">    </span><br><span class="line">modify_global()</span><br><span class="line"><span class="built_in">print</span>(x)  <span class="comment"># 输出：20</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nonlocal：访问外层函数变量</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">outer</span>():</span><br><span class="line">    x = <span class="number">10</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inner</span>():</span><br><span class="line">        <span class="keyword">nonlocal</span> x</span><br><span class="line">        x = <span class="number">20</span></span><br><span class="line">    inner()</span><br><span class="line">    <span class="built_in">print</span>(x)  <span class="comment"># 输出：20</span></span><br><span class="line">    </span><br><span class="line">outer()</span><br></pre></td></tr></tbody></table></figure><h3 id="8-5-高阶函数特性"><a href="#8-5-高阶函数特性" class="headerlink" title="8.5 高阶函数特性"></a>8.5 高阶函数特性</h3><h4 id="函数作为参数传递"><a href="#函数作为参数传递" class="headerlink" title="函数作为参数传递"></a>函数作为参数传递</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">apply_function</span>(<span class="params">func, value</span>):</span><br><span class="line">    <span class="keyword">return</span> func(value)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">square</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> x ** <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">result = apply_function(square, <span class="number">5</span>)  <span class="comment"># 结果：25</span></span><br></pre></td></tr></tbody></table></figure><h4 id="函数作为返回值"><a href="#函数作为返回值" class="headerlink" title="函数作为返回值"></a>函数作为返回值</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_multiplier</span>(<span class="params">factor</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">multiplier</span>(<span class="params">x</span>):</span><br><span class="line">        <span class="keyword">return</span> x * factor</span><br><span class="line">    <span class="keyword">return</span> multiplier</span><br><span class="line">    </span><br><span class="line">double = get_multiplier(<span class="number">2</span>)</span><br><span class="line">triple = get_multiplier(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(double(<span class="number">5</span>))  <span class="comment"># 结果：10</span></span><br><span class="line"><span class="built_in">print</span>(triple(<span class="number">5</span>))  <span class="comment"># 结果：15</span></span><br></pre></td></tr></tbody></table></figure><h4 id="函数存储在数据结构中"><a href="#函数存储在数据结构中" class="headerlink" title="函数存储在数据结构中"></a>函数存储在数据结构中</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_balance</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"查询账户余额"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transfer_money</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"转账服务"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deposit</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"存款服务"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">withdraw</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"取款服务"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_info</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"更新个人信息"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 存储在列表中 - 通过数字选择功能</span></span><br><span class="line">function_list = [check_balance, transfer_money, deposit, withdraw, update_info]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存储在字典中 - 通过命令选择功能</span></span><br><span class="line">function_dict = {</span><br><span class="line">    <span class="string">'balance'</span>: check_balance, </span><br><span class="line">    <span class="string">'transfer'</span>: transfer_money, </span><br><span class="line">    <span class="string">'deposit'</span>: deposit, </span><br><span class="line">    <span class="string">'withdraw'</span>: withdraw, </span><br><span class="line">    <span class="string">'update'</span>: update_info</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bank_system</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n欢迎使用银行服务系统"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"您可以通过数字或命令使用服务"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n=== 银行服务菜单 ==="</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"1. 查询账户余额"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"2. 转账服务"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"3. 存款服务"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"4. 取款服务"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"5. 更新个人信息"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"0. 退出系统"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n或者输入命令：balance, transfer, deposit, withdraw, update, exit"</span>)</span><br><span class="line">        </span><br><span class="line">        choice = <span class="built_in">input</span>(<span class="string">"\n请输入您的选择（数字或命令）: "</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> choice == <span class="string">"0"</span> <span class="keyword">or</span> choice.lower() == <span class="string">"exit"</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"感谢使用银行服务系统，再见！"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 通过数字调用列表中的函数</span></span><br><span class="line">        <span class="keyword">if</span> choice.isdigit():</span><br><span class="line">            index = <span class="built_in">int</span>(choice) - <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt;= index &lt; <span class="built_in">len</span>(function_list):</span><br><span class="line">                function_list[index]()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"无效的数字选择，请重新输入"</span>)</span><br><span class="line">                </span><br><span class="line">        <span class="comment"># 通过命令调用字典中的函数</span></span><br><span class="line">        <span class="keyword">elif</span> choice.lower() <span class="keyword">in</span> function_dict:</span><br><span class="line">            function_dict[choice.lower()]()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"无效的命令，请重新输入"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动银行系统</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    bank_system()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="高阶函数设计模式"><a href="#高阶函数设计模式" class="headerlink" title="高阶函数设计模式"></a>高阶函数设计模式</h4><p>高阶函数是函数式编程的核心概念，它们接受其他函数作为参数或返回函数作为结果。</p><h4 id="函数组合模式"><a href="#函数组合模式" class="headerlink" title="函数组合模式"></a>函数组合模式</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">compose</span>(<span class="params">*functions</span>):</span><br><span class="line">    <span class="string">"""将多个函数组合成一个函数</span></span><br><span class="line"><span class="string">    compose(f, g, h)(x) 等价于 f(g(h(x)))</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 定义一个内部函数，接收一个参数x</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inner</span>(<span class="params">x</span>):</span><br><span class="line">        <span class="comment"># 初始化结果为输入值x</span></span><br><span class="line">        result = x</span><br><span class="line">        <span class="comment"># 反转函数列表，确保执行顺序是从右到左</span></span><br><span class="line">        <span class="comment"># 例如compose(f, g, h)(x)会按h(x)，然后g(结果)，最后f(结果)的顺序执行</span></span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> <span class="built_in">reversed</span>(functions):</span><br><span class="line">            <span class="comment"># 将上一步的结果作为当前函数的输入</span></span><br><span class="line">            result = f(result)</span><br><span class="line">        <span class="comment"># 返回最终结果</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="comment"># 返回内部函数，形成闭包</span></span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：文本处理管道</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove_punctuation</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="keyword">import</span> string</span><br><span class="line">    <span class="comment"># 去除标点符号</span></span><br><span class="line">    <span class="comment"># str.maketrans创建一个转换表，将所有标点符号映射为空</span></span><br><span class="line">    <span class="comment"># string.punctuation包含所有标点符号</span></span><br><span class="line">    <span class="keyword">return</span> text.translate(<span class="built_in">str</span>.maketrans(<span class="string">''</span>, <span class="string">''</span>, string.punctuation))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lowercase</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="comment"># 将文本转换为小写</span></span><br><span class="line">    <span class="keyword">return</span> text.lower()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove_whitespace</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="comment"># 先用split()将文本按空白字符分割成列表</span></span><br><span class="line">    <span class="comment"># 然后用join重新连接，确保单词之间只有一个空格</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">' '</span>.join(text.split())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 组合函数</span></span><br><span class="line"><span class="comment"># 这里创建了一个处理管道，按照从右到左的顺序执行：</span></span><br><span class="line"><span class="comment"># 1. 首先remove_punctuation去除标点</span></span><br><span class="line"><span class="comment"># 2. 然后lowercase转小写</span></span><br><span class="line"><span class="comment"># 3. 最后remove_whitespace规范化空白</span></span><br><span class="line">process_text = compose(remove_whitespace, lowercase, remove_punctuation)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用函数管道</span></span><br><span class="line">text = <span class="string">"Hello, World!  This is an Example."</span></span><br><span class="line"><span class="comment"># 执行过程：</span></span><br><span class="line"><span class="comment"># 1. remove_punctuation: "Hello World  This is an Example"</span></span><br><span class="line"><span class="comment"># 2. lowercase: "hello world  this is an example"</span></span><br><span class="line"><span class="comment"># 3. remove_whitespace: "hello world this is an example"</span></span><br><span class="line"><span class="built_in">print</span>(process_text(text))  <span class="comment"># "hello world this is an example"</span></span><br></pre></td></tr></tbody></table></figure><h4 id="部分应用"><a href="#部分应用" class="headerlink" title="部分应用"></a>部分应用</h4><p>部分应用是预先指定一个函数的部分参数，创建一个新的函数。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">power</span>(<span class="params">base, exponent</span>):</span><br><span class="line">    <span class="keyword">return</span> base ** exponent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个计算平方的函数</span></span><br><span class="line">square = partial(power, exponent=<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(square(<span class="number">4</span>))  <span class="comment"># 16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个计算立方的函数</span></span><br><span class="line">cube = partial(power, exponent=<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(cube(<span class="number">3</span>))  <span class="comment"># 27</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个计算2的幂的函数</span></span><br><span class="line">powers_of_two = partial(power, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(powers_of_two(<span class="number">8</span>))  <span class="comment"># 256 (2^8)</span></span><br></pre></td></tr></tbody></table></figure><h3 id="8-6-匿名函数-lambda"><a href="#8-6-匿名函数-lambda" class="headerlink" title="8.6 匿名函数(lambda)"></a>8.6 匿名函数(lambda)</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 基本语法</span></span><br><span class="line"><span class="keyword">lambda</span> 参数: 表达式</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">add = <span class="keyword">lambda</span> x, y: x + y</span><br><span class="line"><span class="built_in">print</span>(add(<span class="number">5</span>, <span class="number">3</span>))  <span class="comment"># 结果：8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在高阶函数中使用</span></span><br><span class="line">numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">squares = <span class="built_in">map</span>(<span class="keyword">lambda</span> x: x**<span class="number">2</span>, numbers)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(squares))  <span class="comment"># 结果：[1, 4, 9, 16, 25]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在排序中使用</span></span><br><span class="line">words = [<span class="string">'apple'</span>, <span class="string">'banana'</span>, <span class="string">'cherry'</span>]</span><br><span class="line">sorted_words = <span class="built_in">sorted</span>(words, key=<span class="keyword">lambda</span> x: <span class="built_in">len</span>(x))</span><br></pre></td></tr></tbody></table></figure><h3 id="8-7-闭包函数"><a href="#8-7-闭包函数" class="headerlink" title="8.7 闭包函数"></a>8.7 闭包函数</h3><p>闭包是指内部函数引用了外部函数的变量，并且外部函数返回了内部函数。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">counter</span>():</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">increment</span>():</span><br><span class="line">        <span class="keyword">nonlocal</span> count</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br><span class="line">    <span class="keyword">return</span> increment</span><br><span class="line"></span><br><span class="line">my_counter = counter()</span><br><span class="line"><span class="built_in">print</span>(my_counter())  <span class="comment"># 1</span></span><br><span class="line"><span class="built_in">print</span>(my_counter())  <span class="comment"># 2</span></span><br><span class="line"><span class="built_in">print</span>(my_counter())  <span class="comment"># 3</span></span><br></pre></td></tr></tbody></table></figure><h3 id="8-8-递归函数"><a href="#8-8-递归函数" class="headerlink" title="8.8 递归函数"></a>8.8 递归函数</h3><p>递归是一种函数在执行过程中调用自身的编程技巧。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 阶乘递归实现</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">factorial</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="comment"># 基本情况（递归终止条件）</span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">or</span> n == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># 递归调用</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> n * factorial(n-<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line"><span class="built_in">print</span>(factorial(<span class="number">5</span>))  <span class="comment"># 120</span></span><br></pre></td></tr></tbody></table></figure><h4 id="递归的关键要素"><a href="#递归的关键要素" class="headerlink" title="递归的关键要素"></a>递归的关键要素</h4><ol><li><strong>基本情况（终止条件）</strong>：必须定义何时停止递归</li><li><strong>递归关系</strong>：将问题分解为更小的子问题</li></ol><h4 id="递归深度限制"><a href="#递归深度限制" class="headerlink" title="递归深度限制"></a>递归深度限制</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="built_in">print</span>(sys.getrecursionlimit())  <span class="comment"># 默认递归深度（通常为1000）</span></span><br><span class="line">sys.setrecursionlimit(<span class="number">3000</span>)     <span class="comment"># 调整递归深度限制</span></span><br></pre></td></tr></tbody></table></figure><h4 id="递归案例：列表扁平化"><a href="#递归案例：列表扁平化" class="headerlink" title="递归案例：列表扁平化"></a>递归案例：列表扁平化</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">flatten_list</span>(<span class="params">nested_list</span>):</span><br><span class="line">    <span class="string">"""递归扁平化嵌套列表"""</span></span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> nested_list:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">list</span>):</span><br><span class="line">            <span class="comment"># 递归处理子列表</span></span><br><span class="line">            result.extend(flatten_list(item))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 基本情况：添加非列表元素</span></span><br><span class="line">            result.append(item)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">nested = [<span class="number">1</span>, [<span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, [<span class="number">5</span>, <span class="number">6</span>], <span class="number">7</span>], <span class="number">8</span>, [<span class="number">9</span>, [<span class="number">10</span>, [<span class="number">11</span>, <span class="number">12</span>]]]]</span><br><span class="line"><span class="built_in">print</span>(flatten_list(nested))  <span class="comment"># [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]</span></span><br></pre></td></tr></tbody></table></figure><h4 id="-1"><a href="#-1" class="headerlink"></a></h4><h3 id="8-9-装饰器"><a href="#8-9-装饰器" class="headerlink" title="8.9 装饰器"></a>8.9 装饰器</h3><p>装饰器是一种特殊的函数，用于修改其他函数的功能。</p><h4 id="基本装饰器"><a href="#基本装饰器" class="headerlink" title="基本装饰器"></a>基本装饰器</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">count_time</span>(<span class="params">func</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args,**kwargs</span>):</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        result = func(*args,**kwargs)</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"总共耗时："</span>,end_time-start_time)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@count_time </span><span class="comment"># 在这里装饰器相当于 count_time = count_time(test)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000000</span>):</span><br><span class="line">        <span class="built_in">sum</span> += i</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result = test()</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></tbody></table></figure><h4 id="带参数的装饰器"><a href="#带参数的装饰器" class="headerlink" title="带参数的装饰器"></a>带参数的装饰器</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">repeat</span>(<span class="params">times</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">count_time</span>(<span class="params">func</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            result = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(times):</span><br><span class="line">                result = func(*args, **kwargs)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"第<span class="subst">{i+<span class="number">1</span>}</span>次执行完成"</span>)</span><br><span class="line">            end_time = time.time()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"总共耗时："</span>, end_time - start_time)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> count_time</span><br><span class="line"></span><br><span class="line"><span class="meta">@repeat(<span class="params"><span class="number">3</span></span>) </span><span class="comment"># 重复执行3次</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">count_sum</span>():</span><br><span class="line">    <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000000</span>):</span><br><span class="line">        <span class="built_in">sum</span> += i</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result = count_sum()</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></tbody></table></figure><h4 id="保留原函数元数据"><a href="#保留原函数元数据" class="headerlink" title="保留原函数元数据"></a>保留原函数元数据</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">func</span>):</span><br><span class="line"><span class="meta">    @wraps(<span class="params">func</span>)  </span><span class="comment"># 保留原函数的元数据</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="string">"""包装函数"""</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"函数执行前"</span>)</span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"函数执行后"</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@decorator</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">say_hello</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="string">"""打招呼函数"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Hello, <span class="subst">{name}</span>!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># __name__属性为函数的名称，但默认情况下，被装饰器装饰了的函数的名称会变成wrapper，可以通过wraps装饰器保留原函数的元数据来解决这个问题。</span></span><br><span class="line"><span class="built_in">print</span>(say_hello.__name__)  <span class="comment"># say_hello (而不是wrapper)</span></span><br><span class="line"><span class="comment"># 同理，__doc__属性为函数的文档字符串，可以通过wraps装饰器保留原函数的元数据来解决这个问题。</span></span><br><span class="line"><span class="built_in">print</span>(say_hello.__doc__)  <span class="comment"># 打招呼函数</span></span><br></pre></td></tr></tbody></table></figure><h4 id="装饰器叠加"><a href="#装饰器叠加" class="headerlink" title="装饰器叠加"></a>装饰器叠加</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@decorator1</span></span><br><span class="line"><span class="meta">@decorator2</span></span><br><span class="line"><span class="meta">@decorator3</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">function</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">function = decorator1(decorator2(decorator3(function)))</span><br></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行顺序示例</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decorator1</span>(<span class="params">func</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"装饰器1开始"</span>)</span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"装饰器1结束"</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decorator2</span>(<span class="params">func</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"装饰器2开始"</span>)</span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"装饰器2结束"</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@decorator1</span></span><br><span class="line"><span class="meta">@decorator2</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">greet</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"问候函数执行"</span>)</span><br><span class="line"></span><br><span class="line">greet()</span><br><span class="line"><span class="comment"># 输出:</span></span><br><span class="line"><span class="comment"># 装饰器1开始</span></span><br><span class="line"><span class="comment"># 装饰器2开始</span></span><br><span class="line"><span class="comment"># 问候函数执行</span></span><br><span class="line"><span class="comment"># 装饰器2结束</span></span><br><span class="line"><span class="comment"># 装饰器1结束</span></span><br></pre></td></tr></tbody></table></figure><h4 id="装饰器工厂"><a href="#装饰器工厂" class="headerlink" title="装饰器工厂"></a>装饰器工厂</h4><p>创建能够接受多种配置的通用装饰器。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">retry</span>(<span class="params">exceptions, tries=<span class="number">4</span>, delay=<span class="number">3</span>, backoff=<span class="number">2</span>, logger=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""可配置的重试装饰器</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        exceptions: 要捕获的异常类或异常类元组</span></span><br><span class="line"><span class="string">        tries: 最大尝试次数</span></span><br><span class="line"><span class="string">        delay: 初始延迟时间（秒）</span></span><br><span class="line"><span class="string">        backoff: 重试间隔的增长因子</span></span><br><span class="line"><span class="string">        logger: 用于记录警告的日志对象</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">func</span>):</span><br><span class="line"><span class="meta">        @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">            mtries, mdelay = tries, delay</span><br><span class="line">            last_exception = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> mtries &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">                <span class="keyword">except</span> exceptions <span class="keyword">as</span> e:</span><br><span class="line">                    last_exception = e</span><br><span class="line">                    msg = <span class="string">f"<span class="subst">{func.__name__}</span>: 重试 <span class="subst">{tries - mtries + <span class="number">1</span>}</span>/<span class="subst">{tries}</span> 失败: <span class="subst">{e}</span>"</span></span><br><span class="line">                    <span class="keyword">if</span> logger:</span><br><span class="line">                        logger.warning(msg)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="built_in">print</span>(msg)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 延迟后重试</span></span><br><span class="line">                    time.sleep(mdelay)</span><br><span class="line">                    mdelay *= backoff</span><br><span class="line">                    mtries -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 所有尝试都失败</span></span><br><span class="line">            <span class="keyword">raise</span> last_exception</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="meta">@retry(<span class="params">exceptions=(<span class="params">requests.RequestException, ConnectionError</span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">       tries=<span class="number">3</span>, delay=<span class="number">1</span>, backoff=<span class="number">2</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="string">"""获取URL内容，失败时自动重试"""</span></span><br><span class="line">    response = requests.get(url, timeout=<span class="number">2</span>)</span><br><span class="line">    response.raise_for_status()</span><br><span class="line">    <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用示例</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    content = fetch_url(<span class="string">"https://this-website-does-not-exist-123456789.com"</span>)</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line"><span class="keyword">except</span> requests.RequestException <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"获取内容失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="第九章：迭代器、生成器与推导式"><a href="#第九章：迭代器、生成器与推导式" class="headerlink" title="第九章：迭代器、生成器与推导式"></a>第九章：迭代器、生成器与推导式</h2><h3 id="9-1-迭代器"><a href="#9-1-迭代器" class="headerlink" title="9.1 迭代器"></a>9.1 迭代器</h3><p>迭代器是一种可以被遍历的对象，它实现了 <code>__iter__()</code> 和 <code>__next__()</code> 方法。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取迭代器的两种方式</span></span><br><span class="line"><span class="comment"># 方法一：使用iter()函数</span></span><br><span class="line">iter_str = <span class="built_in">iter</span>(<span class="string">"Python"</span>) <span class="comment"># 将字符串转换为迭代器</span></span><br><span class="line"><span class="comment"># 使用next()函数获取迭代器的元素</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(iter_str)) <span class="comment"># 输出：'P'</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(iter_str)) <span class="comment"># 输出：'y'</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(iter_str)) <span class="comment"># 输出：'t'</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(iter_str)) <span class="comment"># 输出：'h'</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(iter_str)) <span class="comment"># 输出：'o'</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(iter_str)) <span class="comment"># 输出：'n'</span></span><br><span class="line"><span class="comment"># 也可以通过for循环获取迭代器的元素</span></span><br><span class="line"><span class="keyword">for</span> char <span class="keyword">in</span> iter_str:</span><br><span class="line">    <span class="built_in">print</span>(char) <span class="comment"># 在这里不会输出了，因为迭代器的元素已经被上方取完了</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二：使用__iter__()方法</span></span><br><span class="line"><span class="comment"># 在Python中，所有的元素都会有一个默认的__iter__()方法，该方法返回一个迭代器对象，该对象可以用来获取元素。</span></span><br><span class="line"><span class="comment"># 因此，如果一个对象实现了__iter__()方法，那么它就可以被转换为迭代器。</span></span><br><span class="line">iter_str2 = <span class="string">"Python"</span>.__iter__() <span class="comment"># 调用字符串的__iter__()方法，将字符串转换为迭代器</span></span><br><span class="line"><span class="built_in">print</span>(iter_str2.__next__()) <span class="comment"># 输出：'P'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 迭代完成后会抛出StopIteration异常</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">next</span>(iter_str2))</span><br><span class="line"><span class="keyword">except</span> StopIteration:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"迭代完成"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="自定义迭代器"><a href="#自定义迭代器" class="headerlink" title="自定义迭代器"></a>自定义迭代器</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CountDown</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, start</span>):</span><br><span class="line">        <span class="variable language_">self</span>.start = start</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.start &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> StopIteration</span><br><span class="line">        <span class="variable language_">self</span>.start -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.start + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 使用自定义迭代器</span></span><br><span class="line">counter = CountDown(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> counter:</span><br><span class="line">    <span class="built_in">print</span>(num)  <span class="comment"># 输出: 5, 4, 3, 2, 1</span></span><br></pre></td></tr></tbody></table></figure><h4 id="for-循环的工作原理"><a href="#for-循环的工作原理" class="headerlink" title="for 循环的工作原理"></a>for 循环的工作原理</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for循环实际上是这样工作的:</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_for</span>(<span class="params">iterable, callback</span>): <span class="comment"># iterable是可迭代对象，callback是一个回调函数，每一次迭代都会调用这个函数</span></span><br><span class="line">    <span class="comment">#通过iter()函数将"abc"转换成一个迭代器</span></span><br><span class="line">    iterator = <span class="built_in">iter</span>(iterable)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 无限循环，直到迭代器结束</span></span><br><span class="line">            item = <span class="built_in">next</span>(iterator)</span><br><span class="line">            <span class="comment"># 调用回调函数</span></span><br><span class="line">            callback(item)</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 例如：</span></span><br><span class="line">my_for(<span class="string">"abc"</span>, <span class="keyword">lambda</span> x: <span class="built_in">print</span>(x))</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">"abc"</span>:</span><br><span class="line">    <span class="built_in">print</span>(x)</span><br></pre></td></tr></tbody></table></figure><h3 id="9-2-生成器"><a href="#9-2-生成器" class="headerlink" title="9.2 生成器"></a>9.2 生成器</h3><p>生成器是一种特殊的迭代器，使用 <code>yield</code> 语句而不是 <code>return</code> 语句返回值。每次调用 <code>next()</code> 时，生成器函数从上次离开的地方继续执行</p><blockquote><p><code>yield</code> 相比较 <code>return</code> 关键字在于 yield 属于“等一下再离开”，每次调用 yield 都会返回不同的值，也就是每一次循环便利都会返回下一个 yield，直到没有</p></blockquote><p>在这里我们简单的了解一下 yield 关键字，到了并发编程中，yiled 还会有一些常见的用途，如：</p><p>1、形成生成器</p><p>2、协程</p><p>3.上下文管理器</p><p>4、yield from</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单的生成器函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">simple_generator</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span></span><br><span class="line">    </span><br><span class="line">gen = simple_generator()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(gen))  <span class="comment"># 1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(gen))  <span class="comment"># 2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(gen))  <span class="comment"># 3</span></span><br><span class="line"><span class="comment"># print(next(gen))  # 抛出StopIteration</span></span><br></pre></td></tr></tbody></table></figure><h4 id="生成器表达式-推导式"><a href="#生成器表达式-推导式" class="headerlink" title="生成器表达式(推导式)"></a>生成器表达式(推导式)</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成器表达式</span></span><br><span class="line">even_numbers = (x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>) <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用生成器</span></span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> even_numbers:</span><br><span class="line">    <span class="built_in">print</span>(num)  <span class="comment"># 输出: 0, 2, 4, 6, 8</span></span><br></pre></td></tr></tbody></table></figure><h4 id="生成器的优势"><a href="#生成器的优势" class="headerlink" title="生成器的优势"></a>生成器的优势</h4><ol><li><strong>内存效率</strong>：生成器不会一次性生成所有值，而是按需生成，降低内存使用</li><li><strong>延迟计算</strong>：只有在请求下一个值时才执行计算</li><li><strong>无限序列</strong>：可以表示理论上无限的数据流</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 内存效率示例</span></span><br><span class="line"><span class="comment"># 传统列表方式</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_lines_list</span>(<span class="params">file_path</span>):</span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            result.append(line.strip())</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成器方式</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_lines_generator</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            <span class="keyword">yield</span> line.strip()</span><br></pre></td></tr></tbody></table></figure><h4 id="生成器应用场景"><a href="#生成器应用场景" class="headerlink" title="生成器应用场景"></a>生成器应用场景</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 批量处理示例</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">batch_processor</span>(<span class="params">items, batch_size=<span class="number">100</span></span>):</span><br><span class="line">    <span class="string">"""将大列表分成小批次处理"""</span></span><br><span class="line">    batch = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">        batch.append(item)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(batch) == batch_size:</span><br><span class="line">            <span class="keyword">yield</span> batch</span><br><span class="line">            batch = []</span><br><span class="line">    <span class="keyword">if</span> batch:  <span class="comment"># 处理最后不满batch_size的批次</span></span><br><span class="line">        <span class="keyword">yield</span> batch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">items = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">1050</span>))</span><br><span class="line"><span class="keyword">for</span> batch <span class="keyword">in</span> batch_processor(items, <span class="number">300</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"处理批次，大小: <span class="subst">{<span class="built_in">len</span>(batch)}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h3 id="9-3-推导式"><a href="#9-3-推导式" class="headerlink" title="9.3 推导式"></a>9.3 推导式</h3><p>推导式是创建数据集合的简洁方法。</p><h4 id="列表推导式"><a href="#列表推导式" class="headerlink" title="列表推导式"></a>列表推导式</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本语法</span></span><br><span class="line">[表达式 <span class="keyword">for</span> 变量 <span class="keyword">in</span> 可迭代对象 <span class="keyword">if</span> 条件]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">squares = [x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>)]  <span class="comment"># [1, 4, 9, 16, 25, 36, 49, 64, 81, 100]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 带条件过滤</span></span><br><span class="line">even_squares = [x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>) <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>]  <span class="comment"># [4, 16, 36, 64, 100]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多层推导式</span></span><br><span class="line">matrix = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]]</span><br><span class="line">flattened = [x <span class="keyword">for</span> row <span class="keyword">in</span> matrix <span class="keyword">for</span> x <span class="keyword">in</span> row]  <span class="comment"># [1, 2, 3, 4, 5, 6, 7, 8, 9]</span></span><br></pre></td></tr></tbody></table></figure><h4 id="字典推导式"><a href="#字典推导式" class="headerlink" title="字典推导式"></a>字典推导式</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本语法</span></span><br><span class="line">{键表达式: 值表达式 <span class="keyword">for</span> 变量 <span class="keyword">in</span> 可迭代对象 <span class="keyword">if</span> 条件}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">squares_dict = {x: x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>)}  <span class="comment"># {1: 1, 2: 4, 3: 9, 4: 16, 5: 25}</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 键值互换</span></span><br><span class="line">original = {<span class="string">'a'</span>: <span class="number">1</span>, <span class="string">'b'</span>: <span class="number">2</span>, <span class="string">'c'</span>: <span class="number">3</span>}</span><br><span class="line">inverted = {v: k <span class="keyword">for</span> k, v <span class="keyword">in</span> original.items()}  <span class="comment"># {1: 'a', 2: 'b', 3: 'c'}</span></span><br></pre></td></tr></tbody></table></figure><h4 id="集合推导式"><a href="#集合推导式" class="headerlink" title="集合推导式"></a>集合推导式</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本语法</span></span><br><span class="line">{表达式 <span class="keyword">for</span> 变量 <span class="keyword">in</span> 可迭代对象 <span class="keyword">if</span> 条件}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">squares_set = {x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>)}  <span class="comment"># {1, 4, 9, 16, 25, 36, 49, 64, 81, 100}</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 去除重复元素</span></span><br><span class="line">words = [<span class="string">'hello'</span>, <span class="string">'world'</span>, <span class="string">'hello'</span>, <span class="string">'python'</span>]</span><br><span class="line">unique_lengths = {<span class="built_in">len</span>(word) <span class="keyword">for</span> word <span class="keyword">in</span> words}  <span class="comment"># {5, 6}</span></span><br></pre></td></tr></tbody></table></figure><h4 id="生成器表达式"><a href="#生成器表达式" class="headerlink" title="生成器表达式"></a>生成器表达式</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本语法</span></span><br><span class="line">(表达式 <span class="keyword">for</span> 变量 <span class="keyword">in</span> 可迭代对象 <span class="keyword">if</span> 条件)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">squares_gen = (x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在函数调用中使用(不需要额外括号)</span></span><br><span class="line">sum_of_squares = <span class="built_in">sum</span>(x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>))  <span class="comment"># 385</span></span><br></pre></td></tr></tbody></table></figure><h4 id="三元表达式"><a href="#三元表达式" class="headerlink" title="三元表达式"></a>三元表达式</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本语法</span></span><br><span class="line">值<span class="number">1</span> <span class="keyword">if</span> 条件 <span class="keyword">else</span> 值<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">x, y = <span class="number">10</span>, <span class="number">20</span></span><br><span class="line">larger = x <span class="keyword">if</span> x &gt; y <span class="keyword">else</span> y  <span class="comment"># y</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在推导式中使用</span></span><br><span class="line">values = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">result = [x*<span class="number">2</span> <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span> <span class="keyword">else</span> x*<span class="number">3</span> <span class="keyword">for</span> x <span class="keyword">in</span> values]  <span class="comment"># [3, 4, 9, 8, 15]</span></span><br></pre></td></tr></tbody></table></figure><h2 id="第十章：-模块与包"><a href="#第十章：-模块与包" class="headerlink" title="第十章： 模块与包"></a>第十章： 模块与包</h2><p>模块是 Python 中组织代码的基本单位，本质上是一个包含 Python 定义和语句的文件。本文将深入探讨模块与包的概念、使用方法以及高级应用技巧，结合 PyCharm 中的包管理最佳实践。</p><h3 id="10-1-模块分类"><a href="#10-1-模块分类" class="headerlink" title="10.1 模块分类"></a>10.1 模块分类</h3><p>在 Python 生态系统中，模块可以分为三大类：</p><table><thead><tr><th>模块类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>内置模块</strong></td><td>Python 解释器自带的标准库模块</td><td>os, sys, math, datetime</td></tr><tr><td><strong>第三方模块</strong></td><td>社区开发者创建的模块</td><td>numpy, pandas, requests</td></tr><tr><td><strong>自定义模块</strong></td><td>开发者自己创建的模块</td><td>项目中自定义的.py 文件</td></tr></tbody></table><blockquote><p><strong>重要提示</strong>：首次导入自定义模块时，Python 会执行该模块中的所有顶层代码。每个模块都有自己的名称空间，模块中定义的变量属于该模块的名称空间。</p></blockquote><h3 id="10-2-模块导入方式"><a href="#10-2-模块导入方式" class="headerlink" title="10.2 模块导入方式"></a>10.2 模块导入方式</h3><h4 id="10-2-1-导入整个模块"><a href="#10-2-1-导入整个模块" class="headerlink" title="10.2.1 导入整个模块"></a>10.2.1 导入整个模块</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> module_name</span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用模块中的内容</span></span><br><span class="line">module_name.function_name()</span><br><span class="line">module_name.variable_name</span><br></pre></td></tr></tbody></table></figure><h4 id="10-2-2-从模块导入特定内容"><a href="#10-2-2-从模块导入特定内容" class="headerlink" title="10.2.2 从模块导入特定内容"></a>10.2.2 从模块导入特定内容</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> module_name <span class="keyword">import</span> function_name, variable_name</span><br><span class="line"></span><br><span class="line"><span class="comment">## 直接使用，无需模块名前缀</span></span><br><span class="line">function_name()</span><br><span class="line"><span class="built_in">print</span>(variable_name)</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>工作原理</strong>：使用 <code>from</code> 方式导入时，被导入的对象会直接引用模块中对应变量的内存地址，可以直接使用而无需模块前缀。</p></blockquote><h4 id="10-2-3-导入时重命名"><a href="#10-2-3-导入时重命名" class="headerlink" title="10.2.3 导入时重命名"></a>10.2.3 导入时重命名</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 模块重命名</span></span><br><span class="line"><span class="keyword">import</span> module_name <span class="keyword">as</span> alias</span><br><span class="line">alias.function_name()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 函数重命名</span></span><br><span class="line"><span class="keyword">from</span> module_name <span class="keyword">import</span> function_name <span class="keyword">as</span> fn</span><br><span class="line">fn()</span><br></pre></td></tr></tbody></table></figure><h4 id="10-2-4-导入所有内容（不推荐）"><a href="#10-2-4-导入所有内容（不推荐）" class="headerlink" title="10.2.4 导入所有内容（不推荐）"></a>10.2.4 导入所有内容（不推荐）</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> module_name <span class="keyword">import</span> *</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>注意</strong>：这种方式可能导致命名冲突，不利于代码可读性和维护性。在大型项目中应避免使用。</p></blockquote><h3 id="10-3-控制模块导入"><a href="#10-3-控制模块导入" class="headerlink" title="10.3 控制模块导入"></a>10.3 控制模块导入</h3><p>我们可以在每一个模块的 <code>__init__</code> 文件中使用如下的操作</p><p>可以使用 <code>__all__</code> 列表来控制 <code>from module import *</code> 语句导入的内容：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 在模块文件中定义</span></span><br><span class="line">__all__ = [<span class="string">'function1'</span>, <span class="string">'function2'</span>, <span class="string">'CONSTANT1'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 不在__all__中的变量和函数，使用from module import *时不会被导入</span></span><br><span class="line">_private_variable = <span class="string">"这个变量不会被导入"</span></span><br></pre></td></tr></tbody></table></figure><h3 id="10-4-模块的特殊属性"><a href="#10-4-模块的特殊属性" class="headerlink" title="10.4 模块的特殊属性"></a>10.4 模块的特殊属性</h3><h4 id="10-4-1-name-属性"><a href="#10-4-1-name-属性" class="headerlink" title="10.4.1 __name__ 属性"></a>10.4.1 <code>__name__</code> 属性</h4><p>每个 Python 文件都有一个 <code>__name__</code> 属性：</p><ul><li>当直接运行该文件时，<code>__name__</code> 的值为 <code>'__main__'</code></li><li>当作为模块被导入时，<code>__name__</code> 的值为模块名</li></ul><p>这个特性可用于编写既可作为模块导入，又可独立运行的代码：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 模块内的代码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main_function</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"执行主函数逻辑"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">helper_function</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"辅助函数"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 这部分代码只在直接运行文件时执行</span></span><br><span class="line">    <span class="comment"># 作为模块导入时不会执行</span></span><br><span class="line">    main_function()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"运行模块自测试..."</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="10-4-2-From-模块无法识别问题"><a href="#10-4-2-From-模块无法识别问题" class="headerlink" title="10.4.2 From 模块无法识别问题"></a>10.4.2 From 模块无法识别问题</h4><p>Python 在导入模块时会按照一定顺序搜索模块文件，在有些情况下我们自己定义的模块不一定会被检测到<br>如下列图片：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250426173806981.png" alt="image-20250426173806981"></p><p>例如，当我们的模型层期望用到另外一个 <code>包</code> 的代码时，往往会这样引入：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ecommerce_system.ecommerce.interfaces.payment <span class="keyword">import</span> PaymentProcessor</span><br><span class="line"><span class="keyword">from</span> ecommerce_system.ecommerce.interfaces.shipping <span class="keyword">import</span> ShippingMethod, Address</span><br></pre></td></tr></tbody></table></figure><p>但这样是无法被识别到的，我们应该是需要这样做：</p><ul><li>1.标记外层的包为根包</li><li>2.去掉 ecommerce_system 前缀</li></ul><p>这样 Pycharm 就会检测到我们是在这个包下进行操作的，即可识别到</p><p>从我们的根包出发，也就是图片中蓝色的包（这个是需要在 IDEA）手动标注的</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250426174310742.png" alt="image-20250426174310742"></p><h3 id="10-5-包的概念与使用"><a href="#10-5-包的概念与使用" class="headerlink" title="10.5 包的概念与使用"></a>10.5 包的概念与使用</h3><p>包是一种特殊的模块，它是一个包含 <code>__init__.py</code> 文件的目录，用于组织相关模块。包可以包含子包和模块，形成层次结构。</p><h4 id="10-5-1-包的结构示例"><a href="#10-5-1-包的结构示例" class="headerlink" title="10.5.1 包的结构示例"></a>10.5.1 包的结构示例</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mypackage/</span><br><span class="line">    __init__.py     # 使目录成为包的文件</span><br><span class="line">    module1.py      # 模块1</span><br><span class="line">    module2.py      # 模块2</span><br><span class="line">    subpackage/     # 子包</span><br><span class="line">        __init__.py</span><br><span class="line">        module3.py</span><br></pre></td></tr></tbody></table></figure><h4 id="10-5-2-init-py-文件的作用"><a href="#10-5-2-init-py-文件的作用" class="headerlink" title="10.5.2 __init__.py 文件的作用"></a>10.5.2 <code>__init__.py</code> 文件的作用</h4><ol><li><strong>标识目录为包</strong>：Python 将包含 <code>__init__.py</code> 的目录视为包</li><li><strong>初始化包</strong>：在导入包时执行初始化代码</li><li><strong>定义包的公共接口</strong>：通过 <code>__all__</code> 列表指定 <code>from package import *</code> 时导入的内容</li><li><strong>自动导入子模块</strong>：可以在 <code>__init__.py</code> 中导入子模块，使它们在导入包时可用</li></ol><p><strong>示例 <code>__init__.py</code></strong>：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## mypackage/__init__.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 从子模块导入主要函数，使它们在导入包时可用</span></span><br><span class="line"><span class="keyword">from</span> .module1 <span class="keyword">import</span> function1</span><br><span class="line"><span class="keyword">from</span> .module2 <span class="keyword">import</span> function2</span><br><span class="line"></span><br><span class="line"><span class="comment">## 定义包导出的符号</span></span><br><span class="line">__all__ = [<span class="string">'function1'</span>, <span class="string">'function2'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 包初始化代码</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"mypackage 已加载"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="10-5-3-包的导入方式"><a href="#10-5-3-包的导入方式" class="headerlink" title="10.5.3 包的导入方式"></a>10.5.3 包的导入方式</h4><h5 id="10-5-3-1-导入包中的模块"><a href="#10-5-3-1-导入包中的模块" class="headerlink" title="10.5.3.1 导入包中的模块"></a>10.5.3.1 导入包中的模块</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 完整路径导入</span></span><br><span class="line"><span class="keyword">import</span> mypackage.module1</span><br><span class="line">mypackage.module1.function1()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 导入特定模块</span></span><br><span class="line"><span class="keyword">from</span> mypackage <span class="keyword">import</span> module1</span><br><span class="line">module1.function1()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 导入子包中的模块</span></span><br><span class="line"><span class="keyword">from</span> mypackage.subpackage <span class="keyword">import</span> module3</span><br><span class="line">module3.function3()</span><br></pre></td></tr></tbody></table></figure><h5 id="10-5-3-2-导入包中特定内容"><a href="#10-5-3-2-导入包中特定内容" class="headerlink" title="10.5.3.2 导入包中特定内容"></a>10.5.3.2 导入包中特定内容</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mypackage.module1 <span class="keyword">import</span> function1</span><br><span class="line">function1()</span><br></pre></td></tr></tbody></table></figure><h4 id="10-5-4-相对导入与绝对导入"><a href="#10-5-4-相对导入与绝对导入" class="headerlink" title="10.5.4 相对导入与绝对导入"></a>10.5.4 相对导入与绝对导入</h4><h5 id="10-5-4-1-绝对导入"><a href="#10-5-4-1-绝对导入" class="headerlink" title="10.5.4.1 绝对导入"></a>10.5.4.1 绝对导入</h5><p>从项目的顶级包开始导入：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> package_name.module_name <span class="keyword">import</span> function_name</span><br></pre></td></tr></tbody></table></figure><h5 id="10-5-4-2-相对导入"><a href="#10-5-4-2-相对导入" class="headerlink" title="10.5.4.2 相对导入"></a>10.5.4.2 相对导入</h5><p>使用点号表示相对位置：</p><ul><li><code>.module_name</code>：当前包中的模块</li><li><code>..module_name</code>：父包中的模块</li><li><code>...module_name</code>：祖父包中的模块</li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 在mypackage.subpackage.module3中导入同级模块</span></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> another_module  <span class="comment"># 导入同级模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 导入父包中的模块</span></span><br><span class="line"><span class="keyword">from</span> .. <span class="keyword">import</span> module1  <span class="comment"># 导入父包中的模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 导入父包中模块的特定函数</span></span><br><span class="line"><span class="keyword">from</span> ..module2 <span class="keyword">import</span> function2</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>注意</strong>：相对导入只能在包内使用，不能在顶级模块中使用。相对导入基于当前模块的 <code>__name__</code> 属性，而直接运行的脚本的 <code>__name__</code> 总是 <code>'__main__'</code>。</p></blockquote><h3 id="10-6-高级应用技巧"><a href="#10-6-高级应用技巧" class="headerlink" title="10.6 高级应用技巧"></a>10.6 高级应用技巧</h3><h4 id="10-6-1-动态导入"><a href="#10-6-1-动态导入" class="headerlink" title="10.6.1 动态导入"></a>10.6.1 动态导入</h4><p>在运行时根据条件动态导入模块：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 方法1：使用__import__</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">import_module_by_name</span>(<span class="params">module_name</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">__import__</span>(module_name)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 方法2：使用importlib（推荐）</span></span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_module</span>(<span class="params">module_name</span>):</span><br><span class="line">    <span class="string">"""根据名称动态导入模块"""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> importlib.import_module(module_name)</span><br><span class="line">    <span class="keyword">except</span> ImportError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"无法导入模块 <span class="subst">{module_name}</span>: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 示例：根据条件选择不同的模块</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_database_module</span>(<span class="params">db_type</span>):</span><br><span class="line">    <span class="string">"""根据数据库类型动态选择数据库模块"""</span></span><br><span class="line">    <span class="keyword">if</span> db_type.lower() == <span class="string">'mysql'</span>:</span><br><span class="line">        <span class="keyword">return</span> importlib.import_module(<span class="string">'mysql.connector'</span>)</span><br><span class="line">    <span class="keyword">elif</span> db_type.lower() == <span class="string">'postgresql'</span>:</span><br><span class="line">        <span class="keyword">return</span> importlib.import_module(<span class="string">'psycopg2'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> importlib.import_module(<span class="string">'sqlite3'</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="10-6-2-延迟导入"><a href="#10-6-2-延迟导入" class="headerlink" title="10.6.2 延迟导入"></a>10.6.2 延迟导入</h4><p>推迟导入耗时模块，直到真正需要时才导入，可以加快程序启动速度：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">function_that_needs_numpy</span>():</span><br><span class="line">    <span class="string">"""只在函数被调用时导入numpy"""</span></span><br><span class="line">    <span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">    <span class="keyword">return</span> np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_image</span>(<span class="params">image_path</span>):</span><br><span class="line">    <span class="string">"""图像处理函数，仅在需要时导入PIL"""</span></span><br><span class="line">    <span class="comment"># 只在需要处理图像时才导入PIL</span></span><br><span class="line">    <span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line">    </span><br><span class="line">    img = Image.<span class="built_in">open</span>(image_path)</span><br><span class="line">    <span class="comment"># 处理图像...</span></span><br><span class="line">    <span class="keyword">return</span> img</span><br></pre></td></tr></tbody></table></figure><h4 id="10-6-3-使用-slots-优化内存"><a href="#10-6-3-使用-slots-优化内存" class="headerlink" title="10.6.3 使用 __slots__ 优化内存"></a>10.6.3 使用 <code>__slots__</code> 优化内存</h4><p>在模块级别的类中使用 <code>__slots__</code> 限制属性，提高内存效率：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataPoint</span>:</span><br><span class="line">    <span class="string">"""使用__slots__优化内存的数据点类"""</span></span><br><span class="line">    __slots__ = [<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>]  <span class="comment"># 只允许这些属性</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x, y, z</span>):</span><br><span class="line">        <span class="variable language_">self</span>.x = x</span><br><span class="line">        <span class="variable language_">self</span>.y = y</span><br><span class="line">        <span class="variable language_">self</span>.z = z</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">distance_from_origin</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""计算到原点的距离"""</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="variable language_">self</span>.x**<span class="number">2</span> + <span class="variable language_">self</span>.y**<span class="number">2</span> + <span class="variable language_">self</span>.z**<span class="number">2</span>) ** <span class="number">0.5</span></span><br></pre></td></tr></tbody></table></figure><h3 id="10-7-包的发布与安装"><a href="#10-7-包的发布与安装" class="headerlink" title="10.7 包的发布与安装"></a>10.7 包的发布与安装</h3><p>创建自己的包并发布到 PyPI：</p><h4 id="10-7-1-创建-setup-py-文件"><a href="#10-7-1-创建-setup-py-文件" class="headerlink" title="10.7.1 创建 setup.py 文件"></a>10.7.1 创建 <code>setup.py</code> 文件</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup, find_packages</span><br><span class="line"></span><br><span class="line">setup(</span><br><span class="line">    name=<span class="string">"mypackage"</span>,</span><br><span class="line">    version=<span class="string">"0.1.0"</span>,</span><br><span class="line">    author=<span class="string">"Your Name"</span>,</span><br><span class="line">    author_email=<span class="string">"your.email@example.com"</span>,</span><br><span class="line">    description=<span class="string">"A short description of the package"</span>,</span><br><span class="line">    long_description=<span class="built_in">open</span>(<span class="string">"README.md"</span>).read(),</span><br><span class="line">    long_description_content_type=<span class="string">"text/markdown"</span>,</span><br><span class="line">    url=<span class="string">"https://github.com/yourusername/mypackage"</span>,</span><br><span class="line">    packages=find_packages(),</span><br><span class="line">    classifiers=[</span><br><span class="line">        <span class="string">"Programming Language :: Python :: 3"</span>,</span><br><span class="line">        <span class="string">"License :: OSI Approved :: MIT License"</span>,</span><br><span class="line">        <span class="string">"Operating System :: OS Independent"</span>,</span><br><span class="line">    ],</span><br><span class="line">    python_requires=<span class="string">'&gt;=3.6'</span>,</span><br><span class="line">    install_requires=[</span><br><span class="line">        <span class="string">'dependency1&gt;=1.0.0'</span>,</span><br><span class="line">        <span class="string">'dependency2&gt;=2.0.0'</span>,</span><br><span class="line">    ],</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><h4 id="10-7-2-打包与上传"><a href="#10-7-2-打包与上传" class="headerlink" title="10.7.2 打包与上传"></a>10.7.2 打包与上传</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装打包工具</span></span><br><span class="line">pip install --upgrade setuptools wheel twine</span><br><span class="line"></span><br><span class="line"><span class="comment">## 构建分发包</span></span><br><span class="line">python setup.py sdist bdist_wheel</span><br><span class="line"></span><br><span class="line"><span class="comment">## 上传到PyPI</span></span><br><span class="line">twine upload dist/*</span><br></pre></td></tr></tbody></table></figure><h4 id="10-7-3-安装包"><a href="#10-7-3-安装包" class="headerlink" title="10.7.3 安装包"></a>10.7.3 安装包</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mypackage</span><br></pre></td></tr></tbody></table></figure><h3 id="10-8-PyCharm-中的包管理"><a href="#10-8-PyCharm-中的包管理" class="headerlink" title="10.8 PyCharm 中的包管理"></a>10.8 PyCharm 中的包管理</h3><p>PyCharm 提供了强大的图形界面来管理 Python 包，让包的安装和管理变得简单高效。</p><h4 id="10-8-1-使用-Python-Packages-工具"><a href="#10-8-1-使用-Python-Packages-工具" class="headerlink" title="10.8.1 使用 Python Packages 工具"></a>10.8.1 使用 Python Packages 工具</h4><p>在 PyCharm 中管理包的最简单方法是使用内置的 Python Packages 工具：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://i-blog.csdnimg.cn/direct/00b70a4bd0534549b0bb79bdfdd75d3f.png" alt="PyCharm Python Packages 界面"></p><ol><li>点击底部的 <strong>Python Packages</strong> 标签打开包管理器</li><li>在搜索框中输入要安装的包名称</li><li>点击包右侧的 <strong>Install</strong> 按钮安装包</li><li>已安装的包会显示在 <strong>Installed</strong> 标签下，可以查看版本并进行升级或卸载操作</li></ol><h4 id="10-8-2-更改-PyCharm-的-pip-源"><a href="#10-8-2-更改-PyCharm-的-pip-源" class="headerlink" title="10.8.2 更改 PyCharm 的 pip 源"></a>10.8.2 更改 PyCharm 的 pip 源</h4><p>默认的 PyPI 源在国内访问可能较慢，可以更换为国内镜像以提高下载速度：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img2023.cnblogs.com/blog/1756102/202306/1756102-20230620182228379-1786442487.png" alt="PyCharm 更改 pip 源"></p><ol><li>在 Python Packages 界面点击左上角的齿轮图标</li><li>点击 “+” 按钮添加新的软件源</li><li>输入国内镜像源地址，例如：<ul><li>阿里云：<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly9taXJyb3JzLmFsaXl1bi5jb20vcHlwaS9zaW1wbGUv">https://mirrors.aliyun.com/pypi/simple/</a></li><li>清华：<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly9weXBpLnR1bmEudHNpbmdodWEuZWR1LmNuL3NpbXBsZS8">https://pypi.tuna.tsinghua.edu.cn/simple/</a></li><li>中国科技大学：<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly9weXBpLm1pcnJvcnMudXN0Yy5lZHUuY24vc2ltcGxlLw">https://pypi.mirrors.ustc.edu.cn/simple/</a></li><li>豆瓣：<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cDovL3B5cGkuZG91YmFuLmNvbS9zaW1wbGUv">http://pypi.douban.com/simple/</a></li></ul></li></ol><h4 id="10-8-3-使用-Project-Interpreter-管理包"><a href="#10-8-3-使用-Project-Interpreter-管理包" class="headerlink" title="10.8.3 使用 Project Interpreter 管理包"></a>10.8.3 使用 Project Interpreter 管理包</h4><p>除了 Python Packages 工具外，还可以通过 Project Interpreter 设置管理包：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/9bd22f4d41e33fbc711d1c53a17c8892.png" alt="PyCharm Project Interpreter"></p><ol><li>进入 <strong>File &gt; Settings &gt; Project &gt; Python Interpreter</strong></li><li>点击 “+” 按钮添加新包</li><li>在弹出窗口中搜索并安装需要的包</li></ol><h4 id="10-8-4-导出和导入项目依赖"><a href="#10-8-4-导出和导入项目依赖" class="headerlink" title="10.8.4 导出和导入项目依赖"></a>10.8.4 导出和导入项目依赖</h4><p>在团队开发中，共享项目依赖非常重要。PyCharm 提供了方便的方式来管理 requirements.txt 文件：</p><h5 id="10-8-4-1-导出依赖"><a href="#10-8-4-1-导出依赖" class="headerlink" title="10.8.4.1 导出依赖"></a>10.8.4.1 导出依赖</h5><p>推荐使用 pipreqs 工具导出仅项目使用的依赖包：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装pipreqs</span></span><br><span class="line">pip install pipreqs</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在项目根目录执行</span></span><br><span class="line">pipreqs . --encoding=utf8 --force</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>提示</strong>：<code>--force</code> 参数会强制覆盖已存在的 requirements.txt 文件，<code>--encoding=utf8</code> 确保使用 UTF-8 编码处理文件。</p></blockquote><h5 id="10-8-4-2-导入依赖"><a href="#10-8-4-2-导入依赖" class="headerlink" title="10.8.4.2 导入依赖"></a>10.8.4.2 导入依赖</h5><p>在 PyCharm 的 Terminal 中执行：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></tbody></table></figure><p>或者指定国内镜像源：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/</span><br></pre></td></tr></tbody></table></figure><h4 id="10-8-5-使用虚拟环境"><a href="#10-8-5-使用虚拟环境" class="headerlink" title="10.8.5 使用虚拟环境"></a>10.8.5 使用虚拟环境</h4><p>PyCharm 支持多种虚拟环境管理工具，如 Virtualenv、Pipenv 和 Conda：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/5e33e43c899366b78dfd0b1f7bc395c7.png" alt="PyCharm 虚拟环境设置"></p><ol><li>创建新项目时选择虚拟环境类型</li><li>对于现有项目，可以在 <strong>File &gt; Settings &gt; Project &gt; Python Interpreter</strong> 中配置</li><li>点击齿轮图标，选择 “Add…”，然后选择合适的虚拟环境类型</li></ol><h5 id="10-8-5-1-虚拟环境工具对比"><a href="#10-8-5-1-虚拟环境工具对比" class="headerlink" title="10.8.5.1 虚拟环境工具对比"></a>10.8.5.1 虚拟环境工具对比</h5><table><thead><tr><th>工具</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>Virtualenv</td><td>轻量级，易于使用</td><td>需要手动维护 requirements.txt</td><td>简单项目</td></tr><tr><td>Pipenv</td><td>自动管理依赖，有锁文件</td><td>比 Virtualenv 慢</td><td>中型团队项目</td></tr><tr><td>Conda</td><td>同时管理 Python 版本和包</td><td>占用空间大</td><td>数据科学项目</td></tr></tbody></table><h3 id="10-9-模块开发最佳实践"><a href="#10-9-模块开发最佳实践" class="headerlink" title="10.9 模块开发最佳实践"></a>10.9 模块开发最佳实践</h3><h4 id="10-9-1-模块组织"><a href="#10-9-1-模块组织" class="headerlink" title="10.9.1 模块组织"></a>10.9.1 模块组织</h4><ul><li>相关功能放在同一个模块中</li><li>单个模块不要过大，保持在 1000 行以内</li><li>使用子模块和子包组织复杂功能</li><li>使用清晰的命名约定，避免与标准库和流行第三方库冲突</li></ul><h4 id="10-9-2-导入顺序"><a href="#10-9-2-导入顺序" class="headerlink" title="10.9.2 导入顺序"></a>10.9.2 导入顺序</h4><p>遵循 PEP8 建议的导入顺序：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 1. 标准库导入</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment">## 2. 相关第三方库导入</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="comment">## 3. 本地应用/库特定导入</span></span><br><span class="line"><span class="keyword">from</span> mypackage <span class="keyword">import</span> module1</span><br><span class="line"><span class="keyword">from</span> .utils <span class="keyword">import</span> helper_function</span><br></pre></td></tr></tbody></table></figure><h4 id="10-9-3-文档化模块和包"><a href="#10-9-3-文档化模块和包" class="headerlink" title="10.9.3 文档化模块和包"></a>10.9.3 文档化模块和包</h4><p>为模块、类和函数编写清晰的文档字符串：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">模块名称: data_processing</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">这个模块提供了处理数据的实用函数。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">主要功能:</span></span><br><span class="line"><span class="string">    * 数据清洗</span></span><br><span class="line"><span class="string">    * 特征工程</span></span><br><span class="line"><span class="string">    * 数据转换</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clean_data</span>(<span class="params">df</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    清洗输入的DataFrame。</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">        df (pandas.DataFrame): 需要清洗的数据帧</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">        pandas.DataFrame: 清洗后的数据帧</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    示例:</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; import pandas as pd</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; df = pd.DataFrame({'A': [1, None, 3], 'B': [4, 5, None]})</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; clean_data(df)</span></span><br><span class="line"><span class="string">           A    B</span></span><br><span class="line"><span class="string">        0  1.0  4.0</span></span><br><span class="line"><span class="string">        2  3.0  5.0</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 函数实现...</span></span><br></pre></td></tr></tbody></table></figure><h2 id="第十一章：面向对象编程"><a href="#第十一章：面向对象编程" class="headerlink" title="第十一章：面向对象编程"></a>第十一章：面向对象编程</h2><h3 id="对象的本质"><a href="#对象的本质" class="headerlink" title="对象的本质"></a>对象的本质</h3><p><strong><span style="color:red">对象本质上是一个 “容器”，用来存放数据和功能的集合体。面向对象编程的核心思想是将数据和操作数据的方法封装在一起，形成独立的实体。</span></strong></p><h4 id="为什么需要对象"><a href="#为什么需要对象" class="headerlink" title="为什么需要对象"></a>为什么需要对象</h4><p>以开发 MOBA 游戏为例，每个英雄都有自己的属性（如攻击力、移动速度）和功能（如技能）。如果不使用对象，代码会变得非常冗余：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 不使用对象的方式</span></span><br><span class="line">hero_work = <span class="string">'soldier'</span></span><br><span class="line">hero_name = <span class="string">'盖伦'</span></span><br><span class="line">hero_atk = <span class="number">165</span></span><br><span class="line">hero_speed = <span class="number">475</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hero_info</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f'我的名字是<span class="subst">{hero_name}</span>,职业是<span class="subst">{hero_work}</span>,攻击力是<span class="subst">{hero_atk}</span>,移动速度是<span class="subst">{hero_speed}</span>'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hero_atk_up</span>(<span class="params">atk</span>):</span><br><span class="line">    <span class="keyword">global</span> hero_atk</span><br><span class="line">    hero_atk += atk</span><br><span class="line"></span><br><span class="line"><span class="comment">## 第二个英雄</span></span><br><span class="line">hero_work2 = <span class="string">'ADC'</span></span><br><span class="line">hero_name2 = <span class="string">'后裔'</span></span><br><span class="line">hero_atk2 = <span class="number">150</span></span><br><span class="line">hero_speed2 = <span class="number">450</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hero_info2</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f'我的名字是<span class="subst">{hero_name2}</span>,职业是<span class="subst">{hero_work2}</span>,攻击力是<span class="subst">{hero_atk2}</span>,移动速度是<span class="subst">{hero_speed2}</span>'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hero_atk_up2</span>(<span class="params">atk</span>):</span><br><span class="line">    <span class="keyword">global</span> hero_atk2</span><br><span class="line">    hero_atk2 += atk</span><br></pre></td></tr></tbody></table></figure><p>使用字典可以改进一些，如下、但这样还是有一些瑕疵，因为函数是暴露在外面的，最理想的状态是函数也存在在 hero_obj 这个对象里</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hero_info</span>(<span class="params">hero_obj</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f'我的名字是<span class="subst">{hero_obj[<span class="string">"name"</span>]}</span>,职业是<span class="subst">{hero_obj[<span class="string">"work"</span>]}</span>,攻击力是<span class="subst">{hero_obj[<span class="string">"atk"</span>]}</span>'</span></span><br><span class="line">          <span class="string">f',移动速度是<span class="subst">{hero_obj[<span class="string">"speed"</span>]}</span>'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hero_atk_up</span>(<span class="params">hero_obj, atk</span>):</span><br><span class="line">   hero_obj[<span class="string">"atk"</span>] += atk</span><br><span class="line"></span><br><span class="line">hero_obj = {</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'盖伦'</span>,</span><br><span class="line">    <span class="string">'work'</span>: <span class="string">'soldier'</span>,</span><br><span class="line">    <span class="string">'atk'</span>: <span class="number">165</span>,</span><br><span class="line">    <span class="string">'speed'</span>: <span class="number">475</span>,</span><br><span class="line">    <span class="string">'info'</span>: hero_info,</span><br><span class="line">    <span class="string">'atk_up'</span>: hero_atk_up</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在对象中，还有类的这么一个概念，比如说又新创建了一个“艾希”英雄，他与后裔的差别无非就是 ATK 与 Speed 是不一致的，但他们都同属于 ADC 这个职业，所以他们就可以存在在一个 ADC 类里面，在面向对象编程里面，是先创建一个类，再将对象创建出来，所以类也算是一种容器，他也可以被称作是对象</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Hero</span>:</span><br><span class="line">    work = <span class="string">'ADC'</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hero_info</span>(<span class="params">hero_obj</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f'我的名字是<span class="subst">{hero_obj[<span class="string">"name"</span>]}</span>,职业是<span class="subst">{hero_obj[<span class="string">"work"</span>]}</span>,攻击力是<span class="subst">{hero_obj[<span class="string">"atk"</span>]}</span>'</span></span><br><span class="line">              <span class="string">f',移动速度是<span class="subst">{hero_obj[<span class="string">"speed"</span>]}</span>'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hero_atk_up</span>(<span class="params">hero_obj,atk</span>):</span><br><span class="line">       hero_obj[<span class="string">"atk"</span>] += atk</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'xxx'</span>) <span class="comment"># 在程序运行时，类的子代码会被运行，也就代表类在定义阶段就已经创建好了名称空间</span></span><br><span class="line"><span class="comment"># 在python里面类的名称空间中，会默认创建一个__dict__的字典属性</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'='</span>*<span class="number">50</span>)</span><br><span class="line"><span class="built_in">print</span>(Hero.__dict__)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'='</span>*<span class="number">50</span>)</span><br><span class="line"><span class="comment"># {'__module__': '__main__', 'work': 'ADC', 'hero_info': &lt;function Hero.hero_info at 0x00000226DA7B8C10&gt;, 'hero_atk_up': &lt;function Hero.hero_atk_up at 0x00000226DA7B9820&gt;, '__dict__': &lt;attribute '__dict__' of 'Hero' objects&gt;, '__weakref__': &lt;attribute '__weakref__' of 'Hero' objects&gt;, '__doc__': None}</span></span><br><span class="line"><span class="comment"># 所以想要拿到类的属性，实际上访问的是类名称空间中的__dict__字典属性</span></span><br><span class="line"><span class="built_in">print</span>(Hero.__dict__[<span class="string">'work'</span>]) <span class="comment"># ADC</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'='</span>*<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># python提供了一个更简便的语法，也就是通过类名.属性名来访问的</span></span><br><span class="line"><span class="built_in">print</span>(Hero.work) <span class="comment"># ADC</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'='</span>*<span class="number">50</span>)</span><br><span class="line"><span class="comment"># 每次调用一个类就会产生一个对象，此时这个对象里面的Dict是空的，需要添加值</span></span><br><span class="line">hero_obj = Hero()</span><br><span class="line">hero_obj2 = Hero()</span><br><span class="line">hero_obj3 = Hero()</span><br><span class="line"><span class="built_in">print</span>(hero_obj.__dict__) <span class="comment"># {}</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'='</span>*<span class="number">50</span>)</span><br><span class="line"><span class="built_in">print</span>(hero_obj2.__dict__) <span class="comment"># {}</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'='</span>*<span class="number">50</span>)</span><br><span class="line"><span class="built_in">print</span>(hero_obj3.__dict__) <span class="comment"># {}</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'='</span>*<span class="number">50</span>)</span><br><span class="line"><span class="comment"># 给对象添加属性</span></span><br><span class="line">hero_obj.__dict__[<span class="string">'name'</span>] = <span class="string">'亚瑟'</span></span><br><span class="line">hero_obj.__dict__[<span class="string">'work'</span>] = <span class="string">'tank'</span></span><br><span class="line">hero_obj.__dict__[<span class="string">'atk'</span>] = <span class="number">100</span></span><br><span class="line">hero_obj.__dict__[<span class="string">'speed'</span>] = <span class="number">300</span></span><br><span class="line"><span class="comment"># 可是通过这种方式过于复杂，python也提供了简便的语法</span></span><br><span class="line">hero_obj2.name = <span class="string">'妲己'</span></span><br><span class="line">hero_obj2.work = <span class="string">'mage'</span></span><br><span class="line">hero_obj2.atk = <span class="number">120</span></span><br><span class="line">hero_obj2.speed = <span class="number">350</span></span><br><span class="line"></span><br><span class="line">hero_obj3.name = <span class="string">'后裔'</span></span><br><span class="line">hero_obj3.work = <span class="string">'ADC'</span></span><br><span class="line">hero_obj3.atk = <span class="number">150</span></span><br><span class="line">hero_obj3.speed = <span class="number">450</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(hero_obj.__dict__) <span class="comment"># {'name': '亚瑟', 'work': 'tank', 'atk': 100, 'speed': 300}</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'='</span>*<span class="number">50</span>)</span><br><span class="line"><span class="built_in">print</span>(hero_obj2.__dict__) <span class="comment"># {'name': '妲己', 'work': 'mage', 'atk': 120, 'speed': 350}</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'='</span>*<span class="number">50</span>)</span><br><span class="line"><span class="built_in">print</span>(hero_obj3.__dict__) <span class="comment"># {'name': '后裔', 'work': 'ADC', 'atk': 150, 'speed': 450}</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'='</span>*<span class="number">50</span>)</span><br></pre></td></tr></tbody></table></figure><h3 id="init-方法"><a href="#init-方法" class="headerlink" title="__init__ 方法"></a><code>__init__</code> 方法</h3><p>为了减少代码冗余，我们可以定义一个初始化方法，在创建对象时自动设置属性：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Hero</span>:</span><br><span class="line">    work = <span class="string">'ADC'</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hero_info</span>(<span class="params">hero_obj</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f'我的名字是<span class="subst">{hero_obj[<span class="string">"name"</span>]}</span>,职业是<span class="subst">{hero_obj[<span class="string">"work"</span>]}</span>,攻击力是<span class="subst">{hero_obj[<span class="string">"atk"</span>]}</span>'</span></span><br><span class="line">              <span class="string">f',移动速度是<span class="subst">{hero_obj[<span class="string">"speed"</span>]}</span>'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hero_atk_up</span>(<span class="params">hero_obj,atk</span>):</span><br><span class="line">       hero_obj[<span class="string">"atk"</span>] += atk</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'xxx'</span>) <span class="comment"># 在程序运行时，类的子代码会被运行，也就代表类在定义阶段就已经创建好了名称空间</span></span><br><span class="line"></span><br><span class="line">hero1_obj = Hero()</span><br><span class="line">hero2_obj = Hero()</span><br><span class="line">hero3_obj = Hero()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">hero_obj,name,work,atk,speed</span>):</span><br><span class="line">    hero_obj.name = name</span><br><span class="line">    hero_obj.work = work</span><br><span class="line">    hero_obj.atk = atk</span><br><span class="line">    hero_obj.speed = speed</span><br><span class="line"></span><br><span class="line">init(hero1_obj,<span class="string">'后裔'</span>,<span class="string">'ADC'</span>,<span class="number">150</span>,<span class="number">450</span>)</span><br><span class="line">init(hero2_obj,<span class="string">'程咬金'</span>,<span class="string">'ADC'</span>,<span class="number">150</span>,<span class="number">450</span>)</span><br><span class="line">init(hero3_obj,<span class="string">'妲己'</span>,<span class="string">'ADC'</span>,<span class="number">150</span>,<span class="number">450</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(hero1_obj.__dict__) <span class="comment"># {'name': '后裔', 'work': 'ADC', 'atk': 150, 'speed': 450}</span></span><br><span class="line"><span class="built_in">print</span>(hero2_obj.__dict__) <span class="comment"># {'name': '程咬金', 'work': 'ADC', 'atk': 150, 'speed': 450}</span></span><br><span class="line"><span class="built_in">print</span>(hero3_obj.__dict__) <span class="comment"># {'name': '妲己', 'work': 'ADC', 'atk': 150, 'speed': 450}</span></span><br></pre></td></tr></tbody></table></figure><p>这还不够完美，面向对象的核心思想就是整合两个字，现在定义的这个函数和类是完全独立开的，那有没有什么办法能把这个 init 函数，和前面定义的类进一步整合到一起呢，最好是产生对象的时候，就自动调用 init 这个功能，完成对象属性的初始化操作，这时候拿到的对象就是有自己独有属性的对象</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Hero</span>:</span><br><span class="line">    work = <span class="string">'ADC'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">hero_obj, name, work, atk, speed</span>):</span><br><span class="line">        hero_obj.name = name</span><br><span class="line">        hero_obj.work = work</span><br><span class="line">        hero_obj.atk = atk</span><br><span class="line">        hero_obj.speed = speed</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hero_info</span>(<span class="params">hero_obj</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f'我的名字是<span class="subst">{hero_obj.__dict__[<span class="string">"name"</span>]}</span>,职业是<span class="subst">{hero_obj.__dict__[<span class="string">"work"</span>]}</span>,攻击力是<span class="subst">{hero_obj.__dict__[<span class="string">"atk"</span>]}</span>'</span></span><br><span class="line">              <span class="string">f',移动速度是<span class="subst">{hero_obj.__dict__[<span class="string">"speed"</span>]}</span>'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hero_atk_up</span>(<span class="params">hero_obj,atk</span>):</span><br><span class="line">       hero_obj.__dict__[<span class="string">"atk"</span>] += atk</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'xxx'</span>) <span class="comment"># 在程序运行时，类的子代码会被运行，也就代表类在定义阶段就已经创建好了名称空间</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在我们调用类自动创建对象的时候,python内部会自动调用类下面的__init__方法并传入一个空对象，所以在实际传值时仅需要传入四个参数即可</span></span><br><span class="line">hero1_obj = Hero(<span class="string">'后裔'</span>,<span class="string">'ADC'</span>,<span class="number">150</span>,<span class="number">450</span>) <span class="comment"># Hero.__init__(空对象,name,work,atk,speed)</span></span><br><span class="line">hero2_obj = Hero(<span class="string">'程咬金'</span>,<span class="string">'ADC'</span>,<span class="number">150</span>,<span class="number">450</span>)</span><br><span class="line">hero3_obj = Hero(<span class="string">'妲己'</span>,<span class="string">'ADC'</span>,<span class="number">150</span>,<span class="number">450</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(hero1_obj.__dict__) <span class="comment"># {'name': '后裔', 'work': 'ADC', 'atk': 150, 'speed': 450}</span></span><br><span class="line"><span class="built_in">print</span>(hero2_obj.__dict__) <span class="comment"># {'name': '程咬金', 'work': 'ADC', 'atk': 150, 'speed': 450}</span></span><br><span class="line"><span class="built_in">print</span>(hero3_obj.__dict__) <span class="comment"># {'name': '妲己', 'work': 'ADC', 'atk': 150, 'speed': 450}</span></span><br><span class="line"></span><br><span class="line">hero1_obj.hero_info() <span class="comment"># 我的名字是后裔,职业是ADC,攻击力是150,移动速度是450</span></span><br><span class="line">hero2_obj.hero_info() <span class="comment"># 我的名字是程咬金,职业是ADC,攻击力是150,移动速度是450</span></span><br><span class="line">hero3_obj.hero_info() <span class="comment"># 我的名字是妲己,职业是ADC,攻击力是150,移动速度是450</span></span><br></pre></td></tr></tbody></table></figure><p>进一步修改代码，通过 dict [] 拿属性过于繁杂，所以也可以用到类名.属性名的方式来传值给函数，并且在代码最后，在打印函数的内存地址的时候会发现打印类里的函数是一个正常的函数，而打印对象的函数方法则是一个绑定方法，也就是说类的函数属性，<code>绑定给对象使用了之后，就不再是一个普通函数</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Hero</span>:</span><br><span class="line">    work = <span class="string">'ADC'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">hero_obj, name, work, atk, speed</span>):</span><br><span class="line">        hero_obj.name = name</span><br><span class="line">        hero_obj.work = work</span><br><span class="line">        hero_obj.atk = atk</span><br><span class="line">        hero_obj.speed = speed</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hero_info</span>(<span class="params">hero_obj</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f'我的名字是<span class="subst">{hero_obj.name}</span>,职业是<span class="subst">{hero_obj.work}</span>,攻击力是<span class="subst">{hero_obj.atk}</span>'</span></span><br><span class="line">              <span class="string">f',移动速度是<span class="subst">{hero_obj.speed}</span>'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hero_atk_up</span>(<span class="params">hero_obj,atk</span>):</span><br><span class="line">       hero_obj.atk += atk</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'xxx'</span>) <span class="comment"># 在程序运行时，类的子代码会被运行，也就代表类在定义阶段就已经创建好了名称空间</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在我们调用类自动创建对象的时候,python内部会自动调用类下面的__init__方法并传入一个空对象，所以在实际传值时仅需要传入四个参数即可</span></span><br><span class="line">hero1_obj = Hero(<span class="string">'后裔'</span>,<span class="string">'ADC'</span>,<span class="number">150</span>,<span class="number">450</span>) <span class="comment"># Hero.__init__(空对象,name,work,atk,speed)</span></span><br><span class="line">hero2_obj = Hero(<span class="string">'程咬金'</span>,<span class="string">'ADC'</span>,<span class="number">150</span>,<span class="number">450</span>)</span><br><span class="line">hero3_obj = Hero(<span class="string">'妲己'</span>,<span class="string">'ADC'</span>,<span class="number">150</span>,<span class="number">450</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定方法</span></span><br><span class="line"><span class="built_in">print</span>(Hero.hero_info) <span class="comment"># &lt;function Hero.hero_info at 0x0000019021E39820&gt;</span></span><br><span class="line"><span class="built_in">print</span>(hero1_obj.hero_info)</span><br><span class="line"><span class="comment"># &lt;bound method Hero.hero_info of &lt;__main__.Hero object at 0x0000019021F13BE0&gt;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(hero2_obj.hero_info)</span><br><span class="line"><span class="comment"># &lt;bound method Hero.hero_info of &lt;__main__.Hero object at 0x0000019021F13DC0&gt;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(hero3_obj.hero_info)</span><br><span class="line"><span class="comment"># &lt;bound method Hero.hero_info of &lt;__main__.Hero object at 0x0000019021F4F940&gt;&gt;</span></span><br><span class="line"></span><br><span class="line">hero1_obj.hero_atk_up(<span class="number">50000</span>)</span><br><span class="line">hero1_obj.hero_info()</span><br><span class="line">hero2_obj.hero_info()</span><br><span class="line">hero3_obj.hero_info()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 三个内存地址不一样并不代表代码就存了三份，代码本身只存了一份，因为类的作用就是为了减少计算机资源的浪费</span></span><br><span class="line"><span class="comment"># 可以理解为类的属性绑定给对象之后，这个函数的内存地址，就会被包装成一个绑定方法，或者也可以理解为</span></span><br><span class="line"><span class="comment"># 是一个装饰器，当通过对象访问这些函数的时候，访问的也是这个绑定方法的内存地址，而他在给函数传入值时</span></span><br><span class="line"><span class="comment"># 也会像init方法一样自动传入一个对象进去</span></span><br></pre></td></tr></tbody></table></figure><p>所以就能明白，在我们实例化对象传入参数时，他默认的第一个参数是一个对象，这个对象就是 self 对象，他仅仅只是一个变量名，在代码的规范角度来讲，类里面的函数的第一个对象就是 <code>self</code>，仅此而已</p><p>通过这种方式，只需要在 init 方法下增添需要的绑定方法，添加对应的函数功能，就能够实现谁调用这个对象的函数方法，就给谁增添对应的数据</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Hero</span>:</span><br><span class="line">    work = <span class="string">'ADC'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, work, atk, speed</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.work = work</span><br><span class="line">        <span class="variable language_">self</span>.atk = atk</span><br><span class="line">        <span class="variable language_">self</span>.speed = speed</span><br><span class="line">        <span class="variable language_">self</span>.equipment = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hero_info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f'我的名字是<span class="subst">{self.name}</span>,职业是<span class="subst">{self.work}</span>,攻击力是<span class="subst">{self.atk}</span>'</span></span><br><span class="line">              <span class="string">f',移动速度是<span class="subst">{self.speed}</span>'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hero_atk_up</span>(<span class="params">self,atk</span>):</span><br><span class="line">       <span class="variable language_">self</span>.atk += atk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buy_equipment</span>(<span class="params">self,equipment</span>):</span><br><span class="line">        <span class="variable language_">self</span>.equipment.append(equipment)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f'<span class="subst">{self.name}</span>购买了<span class="subst">{equipment}</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hero1_obj = Hero(<span class="string">'后裔'</span>,<span class="string">'ADC'</span>,<span class="number">150</span>,<span class="number">450</span>)</span><br><span class="line">hero2_obj = Hero(<span class="string">'程咬金'</span>,<span class="string">'ADC'</span>,<span class="number">150</span>,<span class="number">450</span>)</span><br><span class="line">hero3_obj = Hero(<span class="string">'妲己'</span>,<span class="string">'ADC'</span>,<span class="number">150</span>,<span class="number">450</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hero1_obj.buy_equipment(<span class="string">'屠龙宝刀966666'</span>)</span><br><span class="line">hero2_obj.buy_equipment(<span class="string">'屠龙宝刀966666'</span>)</span><br><span class="line"><span class="built_in">print</span>(hero3_obj.equipment) <span class="comment"># []</span></span><br></pre></td></tr></tbody></table></figure><h3 id="面向对象的三大特性"><a href="#面向对象的三大特性" class="headerlink" title="面向对象的三大特性"></a>面向对象的三大特性</h3><h4 id="1-封装"><a href="#1-封装" class="headerlink" title="1. 封装"></a>1. 封装</h4><p>封装是将数据和方法包装在对象内部，并向外界提供必要的接口，同时隐藏实现细节的过程。</p><h5 id="属性隐藏"><a href="#属性隐藏" class="headerlink" title="属性隐藏"></a>属性隐藏</h5><p>Python 使用名称修饰（name mangling）实现属性隐藏，即在属性名前加上双下划线：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Hero</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, work, atk, speed</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">         <span class="variable language_">self</span>.work = work</span><br><span class="line">        <span class="variable language_">self</span>.__atk = atk  <span class="comment"># 私有属性</span></span><br><span class="line">        <span class="variable language_">self</span>.speed = speed</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__buy_equipment</span>(<span class="params">self, equipment</span>):  <span class="comment"># 私有方法</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f'<span class="subst">{self.name}</span>购买了<span class="subst">{equipment}</span>'</span>)</span><br><span class="line">        </span><br><span class="line">hero = Hero(<span class="string">'后裔'</span>, <span class="string">'ADC'</span>, <span class="number">150</span>, <span class="number">450</span>)</span><br><span class="line"><span class="comment">## print(hero.__atk)  # AttributeError: 'Hero' object has no attribute '__atk'</span></span><br><span class="line"><span class="comment">## hero.__buy_equipment('无尽战刃')  # AttributeError</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 但这只是名称修饰，仍然可以通过修饰后的名称访问</span></span><br><span class="line"><span class="built_in">print</span>(hero._Hero__atk)  <span class="comment"># 150</span></span><br><span class="line">hero._Hero__buy_equipment(<span class="string">'无尽战刃'</span>)  <span class="comment"># 后裔购买了无尽战刃</span></span><br></pre></td></tr></tbody></table></figure><h5 id="属性访问控制"><a href="#属性访问控制" class="headerlink" title="属性访问控制"></a>属性访问控制</h5><p>为了更好地控制属性访问，可以使用 getter 和 setter 方法：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.__name = name</span><br><span class="line">        <span class="variable language_">self</span>.__age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_name</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.__name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_age</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.__age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_age</span>(<span class="params">self, age</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(age, <span class="built_in">int</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">'年龄必须为整数'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="variable language_">self</span>.__age = age</span><br><span class="line">    <span class="comment"># 相当于Java的toString()方法</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Person(name={}, age={})'</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>.__name, <span class="variable language_">self</span>.__age)</span><br><span class="line"></span><br><span class="line">p = Person(<span class="string">'Alice'</span>, <span class="number">25</span>)</span><br><span class="line"><span class="built_in">print</span>(p.get_name()) <span class="comment"># Alice</span></span><br><span class="line"><span class="built_in">print</span>(p.get_age()) <span class="comment"># 25</span></span><br><span class="line">p.set_age(<span class="number">30</span>)  <span class="comment"># 设置年龄为 30</span></span><br><span class="line"><span class="built_in">print</span>(p.get_age()) <span class="comment"># 30</span></span><br></pre></td></tr></tbody></table></figure><h5 id="使用-property-装饰器"><a href="#使用-property-装饰器" class="headerlink" title="使用@property 装饰器"></a>使用@property 装饰器</h5><p>Python 的 <code>@property</code> 装饰器提供了更优雅的属性访问方式：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这段代码展示了Python中的属性装饰器(@property)的使用，它有以下意义：</span></span><br><span class="line"><span class="comment"># 1. 封装性：通过私有变量(__age)和属性装饰器，实现了对数据的封装和保护</span></span><br><span class="line"><span class="comment"># 2. 数据验证：在setter方法中可以对输入数据进行验证，确保数据的有效性</span></span><br><span class="line"><span class="comment"># 3. 接口一致性：虽然内部使用了方法，但对外提供了类似直接访问属性的简洁接口</span></span><br><span class="line"><span class="comment"># 4. 控制访问：可以分别控制属性的读取、修改和删除行为</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.__age = age</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">age</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""获取年龄"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.__age</span><br><span class="line"></span><br><span class="line"><span class="meta">    @age.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">age</span>(<span class="params">self, age</span>):</span><br><span class="line">        <span class="string">"""设置年龄"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(age, <span class="built_in">int</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">'年龄必须为整数'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="variable language_">self</span>.__age = age</span><br><span class="line"></span><br><span class="line"><span class="meta">    @age.deleter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">age</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""删除年龄属性"""</span></span><br><span class="line">        <span class="keyword">del</span> <span class="variable language_">self</span>.__age</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">person = Person(<span class="number">25</span>)</span><br><span class="line"><span class="built_in">print</span>(person.age)  <span class="comment"># 使用getter</span></span><br><span class="line">person.age = <span class="number">30</span>  <span class="comment"># 使用setter</span></span><br><span class="line"><span class="keyword">del</span> person.age  <span class="comment"># 使用deleter</span></span><br></pre></td></tr></tbody></table></figure><h4 id="2-继承"><a href="#2-继承" class="headerlink" title="2. 继承"></a>2. 继承</h4><p>继承允许一个类（子类）继承另一个类（父类）的属性和方法。</p><h5 id="单继承和多继承"><a href="#单继承和多继承" class="headerlink" title="单继承和多继承"></a>单继承和多继承</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">eat</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"吃"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span>(<span class="title class_ inherited__">Animal</span>):  <span class="comment"># 单继承</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bark</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"汪汪叫"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bird</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fly</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"飞翔"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlyingDog</span>(Dog, Bird):  <span class="comment"># 多继承</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">dog = Dog()</span><br><span class="line">dog.eat()  <span class="comment"># 吃 (继承自Animal)</span></span><br><span class="line">dog.bark()  <span class="comment"># 汪汪叫</span></span><br><span class="line"></span><br><span class="line">flying_dog = FlyingDog()</span><br><span class="line">flying_dog.eat()    <span class="comment"># 吃 (继承自Animal)</span></span><br><span class="line">flying_dog.bark()   <span class="comment"># 汪汪叫 (继承自Dog)</span></span><br><span class="line">flying_dog.fly()    <span class="comment"># 飞翔 (继承自Bird)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看继承关系</span></span><br><span class="line"><span class="built_in">print</span>(Dog.__bases__)  <span class="comment"># (&lt;class '__main__.Animal'&gt;,)</span></span><br><span class="line"><span class="built_in">print</span>(FlyingDog.__bases__)  <span class="comment"># (&lt;class '__main__.Dog'&gt;, &lt;class '__main__.Bird'&gt;)</span></span><br></pre></td></tr></tbody></table></figure><h5 id="方法重写和调用父类方法"><a href="#方法重写和调用父类方法" class="headerlink" title="方法重写和调用父类方法"></a>方法重写和调用父类方法</h5><p>子类可以重写父类的方法，也可以通过 super()调用父类方法：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"我是<span class="subst">{self.name}</span>，今年<span class="subst">{self.age}</span>岁了"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age,breed</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name,age)</span><br><span class="line">        <span class="variable language_">self</span>.breed = breed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().info() <span class="comment"># 这里调用父类的info方法</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"我是<span class="subst">{self.name}</span>，我今年<span class="subst">{self.age}</span>岁了，我是属于<span class="subst">{self.breed}</span>品种的狗"</span>)</span><br><span class="line"></span><br><span class="line">dog = Dog(<span class="string">"旺财"</span>,<span class="number">2</span>,<span class="string">"哈士奇"</span>)</span><br><span class="line">dog.info()</span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># 我是旺财，今年2岁了 # 调用了父类的info方法</span></span><br><span class="line"><span class="comment"># 我是旺财，我今年2岁了，我是属于哈士奇品种的狗 # 重写了父类的info方法</span></span><br></pre></td></tr></tbody></table></figure><h5 id="继承的属性查找顺序-MRO"><a href="#继承的属性查找顺序-MRO" class="headerlink" title="继承的属性查找顺序 (MRO)"></a>继承的属性查找顺序 (MRO)</h5><p>Python 使用 C3 算法计算方法解析顺序(MRO)：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BaseClass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">display_info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"基类的Info方法"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FirstChild</span>(<span class="title class_ inherited__">BaseClass</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">display_info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"第一个子类的info方法"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SecondChild</span>(<span class="title class_ inherited__">BaseClass</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">display_info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"第二个子类的info方法"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultipleInheritance</span>(FirstChild, SecondChild):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(MultipleInheritance.mro())</span><br><span class="line"><span class="comment">## 输出: [&lt;class '__main__.MultipleInheritance'&gt;, &lt;class '__main__.FirstChild'&gt;, &lt;class '__main__.SecondChild'&gt;, &lt;class '__main__.BaseClass'&gt;, &lt;class 'object'&gt;]</span></span><br><span class="line"><span class="comment"># 先是自己=&gt;再是第一个传入的类，第二个传入的类，最后是基类，最后是object</span></span><br><span class="line">instance = MultipleInheritance()</span><br><span class="line">instance.display_info()  <span class="comment"># FirstChild.display_info (按MRO顺序查找)</span></span><br></pre></td></tr></tbody></table></figure><h5 id="菱形继承问题"><a href="#菱形继承问题" class="headerlink" title="菱形继承问题"></a>菱形继承问题</h5><p>菱形继承（钻石继承）是指一个子类通过不同的路径继承了同一个基类：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_sound</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Animal.make_sound"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_sound</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Dog.make_sound"</span>)</span><br><span class="line">        <span class="built_in">super</span>().make_sound()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cat</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_sound</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Cat.make_sound"</span>)</span><br><span class="line">        <span class="built_in">super</span>().make_sound()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CatDog</span>(Dog, Cat):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_sound</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"CatDog.make_sound"</span>)</span><br><span class="line">        <span class="built_in">super</span>().make_sound()</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 菱形继承结构:</span></span><br><span class="line"><span class="comment">#       Animal</span></span><br><span class="line"><span class="comment">#      /      \</span></span><br><span class="line"><span class="comment">#    Dog      Cat</span></span><br><span class="line"><span class="comment">#      \      /</span></span><br><span class="line"><span class="comment">#       CatDog</span></span><br><span class="line"></span><br><span class="line">catdog = CatDog()</span><br><span class="line">catdog.make_sound()</span><br><span class="line"><span class="comment">## 输出:</span></span><br><span class="line"><span class="comment">## CatDog.make_sound</span></span><br><span class="line"><span class="comment">## Dog.make_sound</span></span><br><span class="line"><span class="comment">## Cat.make_sound</span></span><br><span class="line"><span class="comment">## Animal.make_sound</span></span><br></pre></td></tr></tbody></table></figure><p>在 Python 3 中，无论继承路径如何复杂，每个类在 MRO 中只会出现一次。</p><h5 id="MixIn-设计模式"><a href="#MixIn-设计模式" class="headerlink" title="MixIn 设计模式"></a>MixIn 设计模式</h5><p>MixIn 是一种设计模式，用于为类添加功能，而不使用传统继承关系：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SwimMixin</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">swim</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"I can swim"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlyMixin</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fly</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"I can fly"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">eat</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"I can eat"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Duck</span>(Animal, SwimMixin, FlyMixin):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">duck = Duck()</span><br><span class="line">duck.eat()   <span class="comment"># I can eat</span></span><br><span class="line">duck.swim()  <span class="comment"># I can swim</span></span><br><span class="line">duck.fly()   <span class="comment"># I can fly</span></span><br></pre></td></tr></tbody></table></figure><h4 id="3-多态"><a href="#3-多态" class="headerlink" title="3. 多态"></a>3. 多态</h4><p>多态是一种编程思想，在 python 中是没有多态这么一个技术的，比如汽车这种事物，他就有很多种形态，奔驰、宝马、奥拓这就叫多态、多态只是在继承下演化出来的一种概念而已，而我们要知道的是，为什么要有多态这个概念，奔驰宝马奥拓这都是可以跑的对吧，也就是说跑这个功能是汽车共有的功能，那我就在他们的共同的父类里面定义一个 run 方法</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Car</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'开始跑'</span>, end=<span class="string">' '</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Benz</span>(<span class="title class_ inherited__">Car</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().run()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'奔驰跑起来好快哦!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BMW</span>(<span class="title class_ inherited__">Car</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().run()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'宝马跑起来好稳哦!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Auto</span>(<span class="title class_ inherited__">Car</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().run()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'奥拓跑起来好省油哦!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 多态性示例</span></span><br><span class="line">cars = [Benz(), BMW(), Auto()]</span><br><span class="line"><span class="keyword">for</span> car <span class="keyword">in</span> cars:</span><br><span class="line">    car.run()  <span class="comment"># 同一方法调用，不同行为</span></span><br></pre></td></tr></tbody></table></figure><h5 id="鸭子类型"><a href="#鸭子类型" class="headerlink" title="鸭子类型"></a>鸭子类型</h5><p><strong>多态性带来的好处</strong>：统一了使用标准，以不变应万变，无论对象千变万化，使用者都是使用同一种方式去调用，需要注意的是：不一定要继承父类的 run 方法才算是一种多态，引入 python 推崇的一个鸭子模型的概念，只要你长得像鸭子，走路像鸭子，那么你就是一只鸭子，所以类只要内部定义的方法一样，那么他们就同属于一种类别，这也是一种解耦合的方法</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Duck</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">quack</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"呱呱呱!"</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">swim</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"鸭子游泳!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">quack</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"人类模仿鸭叫!"</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">swim</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"人类游泳!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_it_quack_and_swim</span>(<span class="params">thing</span>):</span><br><span class="line">    thing.quack()</span><br><span class="line">    thing.swim()</span><br><span class="line"></span><br><span class="line">duck = Duck()</span><br><span class="line">person = Person()</span><br><span class="line"></span><br><span class="line">make_it_quack_and_swim(duck)</span><br><span class="line">make_it_quack_and_swim(person)  <span class="comment"># 人类没有继承Duck类，但可以表现得像鸭子</span></span><br></pre></td></tr></tbody></table></figure><h5 id="抽象基类"><a href="#抽象基类" class="headerlink" title="抽象基类"></a>抽象基类</h5><p>如果你不想使用鸭子模型，就想用父类来达到规范子类的效果，可以引入一个抽象基类概念，而这并不是 python 推崇的，python 推崇的永远是简洁至上，这样限制只会让程序变得臃肿</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Car</span>(metaclass=abc.ABCMeta):</span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Benz</span>(<span class="title class_ inherited__">Car</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"奔驰开始跑"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"奔驰停止"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment">## benz = Benz()  # 如果没有实现所有抽象方法，会抛出TypeError</span></span><br></pre></td></tr></tbody></table></figure><h3 id="类方法与静态方法"><a href="#类方法与静态方法" class="headerlink" title="类方法与静态方法"></a>类方法与静态方法</h3><h4 id="方法类型比较"><a href="#方法类型比较" class="headerlink" title="方法类型比较"></a>方法类型比较</h4><table><thead><tr><th>方法类型</th><th>装饰器</th><th>第一参数</th><th>使用场景</th></tr></thead><tbody><tr><td>实例方法</td><td>无</td><td>self</td><td>操作实例状态</td></tr><tr><td>类方法</td><td>@classmethod</td><td>cls</td><td>操作类状态，替代构造函数</td></tr><tr><td>静态方法</td><td>@staticmethod</td><td>无特殊参数</td><td>工具函数</td></tr></tbody></table><p><strong>示例场景</strong>：</p><ul><li>在实际的开发中，实例方法通常用于操作与当前对象状态相关的行为。比如，我们定义一个 <code>Person</code> 类，该类实例方法可以访问每个对象的名称和年龄，并提供修改、获取这些属性的功能。</li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">greet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"Hello, my name is <span class="subst">{self.name}</span> and I am <span class="subst">{self.age}</span> years old."</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建实例并调用实例方法</span></span><br><span class="line">person = Person(<span class="string">"Alice"</span>, <span class="number">30</span>)</span><br><span class="line">person.greet()  <span class="comment"># 输出：Hello, my name is Alice and I am 30 years old.</span></span><br></pre></td></tr></tbody></table></figure><h4 id="2-类方法（-classmethod）"><a href="#2-类方法（-classmethod）" class="headerlink" title="2. 类方法（@classmethod）"></a>2. <strong>类方法</strong>（@classmethod）</h4><p><strong>常见示例场景</strong>：</p><ul><li><strong>替代构造函数</strong>: 类方法通常用于定义一个替代构造函数，根据不同的输入创建对象。比如可以根据不同的配置文件或环境变量来初始化对象。</li><li><strong>操作类状态</strong>: 类方法通常用于修改与类相关的共享数据，比如修改所有实例的共享配置。</li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataBase</span>:</span><br><span class="line">    IP = <span class="string">"127.0.0.1"</span></span><br><span class="line">    PORT = <span class="number">8080</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ip, port</span>):</span><br><span class="line">        <span class="variable language_">self</span>.ip = ip</span><br><span class="line">        <span class="variable language_">self</span>.port = port</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"连接数据库成功！IP地址：<span class="subst">{self.ip}</span>, 端口号：<span class="subst">{self.port}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">instance_from_setting</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="comment"># 从配置文件（如setting模块）或环境变量中读取IP和PORT并实例化对象</span></span><br><span class="line">        obj = cls(cls.IP, cls.PORT)</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用类方法来创建实例</span></span><br><span class="line">db = DataBase.instance_from_setting()  </span><br><span class="line"><span class="built_in">print</span>(db.__dict__)  <span class="comment"># 输出：{'ip': '127.0.0.1', 'port': 8080}</span></span><br><span class="line">db.connect()  <span class="comment"># 输出：连接数据库成功！IP地址：127.0.0.1, 端口号：8080</span></span><br></pre></td></tr></tbody></table></figure><p><strong>应用场景</strong>：</p><ul><li>你可以在配置或环境变化时灵活地调整类的构造逻辑，不需要每次都显式地提供参数。这使得代码更加简洁，并且易于扩展。</li></ul><h4 id="3-静态方法（-staticmethod）"><a href="#3-静态方法（-staticmethod）" class="headerlink" title="3. 静态方法（@staticmethod）"></a>3. <strong>静态方法</strong>（@staticmethod）</h4><ul><li><strong>第一参数</strong>: 无特殊参数。静态方法与类或实例无关，不需要 <code>self</code> 或 <code>cls</code> 参数。</li><li><strong>访问实例变量</strong>: 静态方法无法访问实例或类的属性。</li><li><strong>访问类变量</strong>: 静态方法只能做独立于实例和类的操作。它通常用于工具函数，或者处理与对象本身无关的逻辑。</li></ul><p><strong>常见示例场景</strong>：</p><ul><li>静态方法通常用来封装一些独立的工具函数，这些函数与类或实例的状态无关。例如，数学计算、字符串处理等功能。</li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MathTools</span>:</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">        <span class="keyword">return</span> a + b</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">multiply</span>(<span class="params">a, b</span>):</span><br><span class="line">        <span class="keyword">return</span> a * b</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用静态方法，无需实例化类</span></span><br><span class="line"><span class="built_in">print</span>(MathTools.add(<span class="number">5</span>, <span class="number">3</span>))  <span class="comment"># 输出：8</span></span><br><span class="line"><span class="built_in">print</span>(MathTools.multiply(<span class="number">4</span>, <span class="number">2</span>))  <span class="comment"># 输出：8</span></span><br></pre></td></tr></tbody></table></figure><h3 id="反射机制"><a href="#反射机制" class="headerlink" title="反射机制"></a>反射机制</h3><p>反射（Reflection）是指在程序运行时，能够检查、访问、修改对象的属性和方法的能力。在 Python 中，反射允许我们在运行时动态地操作类和对象，<strong>特别是在无法事先确定对象类型或者对象的属性和方法时</strong>，反射提供了极大的灵活性。</p><h4 id="常用反射函数"><a href="#常用反射函数" class="headerlink" title="常用反射函数"></a>常用反射函数</h4><table><thead><tr><th>函数</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td><code>hasattr(obj, name)</code></td><td>检查对象是否有属性</td><td><code>hasattr(obj, 'age')</code></td></tr><tr><td><code>getattr(obj, name, default)</code></td><td>获取对象的属性</td><td><code>getattr(obj, 'age', 0)</code></td></tr><tr><td><code>setattr(obj, name, value)</code></td><td>设置对象的属性</td><td><code>setattr(obj, 'age', 25)</code></td></tr><tr><td><code>delattr(obj, name)</code></td><td>删除对象的属性</td><td><code>delattr(obj, 'age')</code></td></tr><tr><td><code>dir(obj)</code></td><td>列出对象的所有属性</td><td><code>dir(obj)</code></td></tr><tr><td><code>type(obj)</code></td><td>获取对象的类型</td><td><code>type(obj)</code></td></tr><tr><td><code>isinstance(obj, cls)</code></td><td>检查对象是否为类的实例</td><td><code>isinstance(obj, Person)</code></td></tr><tr><td><code>issubclass(cls, parent)</code></td><td>检查类是否为另一个类的子类</td><td><code>issubclass(Dog, Animal)</code></td></tr><tr><td><code>callable(obj)</code></td><td>检查对象是否可调用</td><td><code>callable(obj.method)</code></td></tr><tr><td><code>vars(obj)</code></td><td>获取对象的 <code>__dict__</code></td><td><code>vars(obj)</code></td></tr></tbody></table><h4 id="1-hasattr-—-检查对象是否有指定属性"><a href="#1-hasattr-—-检查对象是否有指定属性" class="headerlink" title="1. hasattr() — 检查对象是否有指定属性"></a>1. <strong><code>hasattr()</code></strong> — 检查对象是否有指定属性</h4><p><code>hasattr(obj, name)</code> 用于检查一个对象 <code>obj</code> 是否有指定名称的属性 <code>name</code>，返回 <code>True</code> 或 <code>False</code>。</p><p><strong>示例</strong>：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">hasattr</span>(p, <span class="string">'name'</span>):  <span class="comment"># 检查 Person 对象是否有 'name' 属性</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">getattr</span>(p, <span class="string">'name'</span>))  <span class="comment"># 输出: Alice</span></span><br></pre></td></tr></tbody></table></figure><h4 id="2-getattr-—-获取对象的属性"><a href="#2-getattr-—-获取对象的属性" class="headerlink" title="2. getattr() — 获取对象的属性"></a>2. <strong><code>getattr()</code></strong> — 获取对象的属性</h4><p><code>getattr(obj, name, default)</code> 用于获取对象的属性。如果该属性存在，返回其值；如果不存在，则返回指定的 <code>default</code> 值。如果没有提供 <code>default</code>，当属性不存在时会抛出 <code>AttributeError</code>。</p><p><strong>示例</strong>：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">name = <span class="built_in">getattr</span>(p, <span class="string">'name'</span>)  <span class="comment"># 获取属性 'name' 的值</span></span><br><span class="line"><span class="built_in">print</span>(name)  <span class="comment"># 输出: Alice</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果属性不存在，使用默认值</span></span><br><span class="line">age = <span class="built_in">getattr</span>(p, <span class="string">'age'</span>, <span class="number">0</span>)  <span class="comment"># 属性 'age' 存在，返回 30</span></span><br><span class="line"><span class="built_in">print</span>(age)  <span class="comment"># 输出: 30</span></span><br></pre></td></tr></tbody></table></figure><h4 id="3-setattr-—-设置对象的属性"><a href="#3-setattr-—-设置对象的属性" class="headerlink" title="3. setattr() — 设置对象的属性"></a>3. <strong><code>setattr()</code></strong> — 设置对象的属性</h4><p><code>setattr(obj, name, value)</code> 用于给对象的指定属性 <code>name</code> 设置新值 <code>value</code>。如果该属性不存在，则会动态创建一个新的属性。</p><p><strong>示例</strong>：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setattr</span>(p, <span class="string">'city'</span>, <span class="string">'New York'</span>)  <span class="comment"># 动态设置新的属性 'city'</span></span><br><span class="line"><span class="built_in">print</span>(p.city)  <span class="comment"># 输出: New York</span></span><br></pre></td></tr></tbody></table></figure><h4 id="4-delattr-—-删除对象的属性"><a href="#4-delattr-—-删除对象的属性" class="headerlink" title="4. delattr() — 删除对象的属性"></a>4. <strong><code>delattr()</code></strong> — 删除对象的属性</h4><p><code>delattr(obj, name)</code> 用于删除对象的指定属性。删除属性后，访问该属性会抛出 <code>AttributeError</code>。</p><p><strong>示例</strong>：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">delattr</span>(p, <span class="string">'city'</span>)  <span class="comment"># 删除属性 'city'</span></span><br><span class="line"><span class="comment"># print(p.city)  # 会抛出 AttributeError: 'Person' object has no attribute 'city'</span></span><br></pre></td></tr></tbody></table></figure><h4 id="5-dir-—-列出对象的所有属性"><a href="#5-dir-—-列出对象的所有属性" class="headerlink" title="5. dir() — 列出对象的所有属性"></a>5. <strong><code>dir()</code></strong> — 列出对象的所有属性</h4><p><code>dir(obj)</code> 返回一个列表，包含对象 <code>obj</code> 的所有属性和方法（包括其继承的属性）。</p><p><strong>示例</strong>：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">dir</span>(p))  <span class="comment"># 列出 Person 对象的所有属性</span></span><br></pre></td></tr></tbody></table></figure><h4 id="6-type-—-获取对象的类型"><a href="#6-type-—-获取对象的类型" class="headerlink" title="6. type() — 获取对象的类型"></a>6. <strong><code>type()</code></strong> — 获取对象的类型</h4><p><code>type(obj)</code> 返回对象 <code>obj</code> 的类型（即类）。</p><p><strong>示例</strong>：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(p))  <span class="comment"># 输出: &lt;class '__main__.Person'&gt;</span></span><br></pre></td></tr></tbody></table></figure><h4 id="7-isinstance-—-检查对象是否为类的实例"><a href="#7-isinstance-—-检查对象是否为类的实例" class="headerlink" title="7. isinstance() — 检查对象是否为类的实例"></a>7. <strong><code>isinstance()</code></strong> — 检查对象是否为类的实例</h4><p><code>isinstance(obj, cls)</code> 用于检查对象 <code>obj</code> 是否为类 <code>cls</code> 的实例或其子类的实例。</p><p><strong>示例</strong>：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">isinstance</span>(p, Person):  <span class="comment"># 检查 p 是否是 Person 类的实例</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"p 是 Person 类的实例"</span>)  <span class="comment"># 输出: p 是 Person 类的实例</span></span><br></pre></td></tr></tbody></table></figure><h4 id="8-issubclass-—-检查类是否为另一个类的子类"><a href="#8-issubclass-—-检查类是否为另一个类的子类" class="headerlink" title="8. issubclass() — 检查类是否为另一个类的子类"></a>8. <strong><code>issubclass()</code></strong> — 检查类是否为另一个类的子类</h4><p><code>issubclass(cls, parent)</code> 用于检查类 <code>cls</code> 是否是类 <code>parent</code> 的子类。</p><p><strong>示例</strong>：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">issubclass</span>(Dog, Animal))  <span class="comment"># 输出: True</span></span><br></pre></td></tr></tbody></table></figure><h4 id="9-callable-—-检查对象是否可调用"><a href="#9-callable-—-检查对象是否可调用" class="headerlink" title="9. callable() — 检查对象是否可调用"></a>9. <strong><code>callable()</code></strong> — 检查对象是否可调用</h4><p><code>callable(obj)</code> 用于检查对象 <code>obj</code> 是否可以调用，即它是否是一个函数或具有 <code>__call__()</code> 方法的对象。</p><p><strong>示例</strong>：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">greet</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">callable</span>(greet))  <span class="comment"># 输出: True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">callable</span>(p))      <span class="comment"># 输出: False，因为 Person 对象不可调用</span></span><br></pre></td></tr></tbody></table></figure><h4 id="10-vars-—-获取对象的-dict"><a href="#10-vars-—-获取对象的-dict" class="headerlink" title="10. vars() — 获取对象的 __dict__"></a>10. <strong><code>vars()</code></strong> — 获取对象的 <code>__dict__</code></h4><p><code>vars(obj)</code> 返回一个字典，包含对象 <code>obj</code> 的所有属性和对应的值。这是访问对象的实例变量的一种方式。</p><p><strong>示例</strong>：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">vars</span>(p))  <span class="comment"># 输出: {'name': 'Alice', 'age': 30}</span></span><br></pre></td></tr></tbody></table></figure><h4 id="反射示例"><a href="#反射示例" class="headerlink" title="反射示例"></a>反射示例</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">greet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"Hello, I'm <span class="subst">{self.name}</span>"</span></span><br><span class="line">        </span><br><span class="line">p = Person(<span class="string">"Alice"</span>, <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 检查和获取属性</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hasattr</span>(p, <span class="string">'name'</span>):  <span class="comment"># 检查 p 对象是否有 'name' 属性</span></span><br><span class="line">    name = <span class="built_in">getattr</span>(p, <span class="string">'name'</span>)  <span class="comment"># 获取 'name' 属性的值</span></span><br><span class="line">    <span class="built_in">print</span>(name)  <span class="comment"># 输出: Alice</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">## 设置新属性</span></span><br><span class="line"><span class="built_in">setattr</span>(p, <span class="string">'city'</span>, <span class="string">'New York'</span>)  <span class="comment"># 动态为 p 对象设置 'city' 属性</span></span><br><span class="line"><span class="built_in">print</span>(p.city)  <span class="comment"># 输出: New York</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除属性</span></span><br><span class="line"><span class="built_in">delattr</span>(p, <span class="string">'city'</span>)  <span class="comment"># 删除 'city' 属性</span></span><br><span class="line"><span class="comment"># print(p.city)  # 如果取消注释，会抛出 AttributeError: 'Person' object has no attribute 'city'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 动态调用方法</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hasattr</span>(p, <span class="string">'greet'</span>) <span class="keyword">and</span> <span class="built_in">callable</span>(<span class="built_in">getattr</span>(p, <span class="string">'greet'</span>)):  <span class="comment"># 检查 greet 方法是否可调用</span></span><br><span class="line">    method = <span class="built_in">getattr</span>(p, <span class="string">'greet'</span>)  <span class="comment"># 获取 greet 方法</span></span><br><span class="line">    <span class="built_in">print</span>(method())  <span class="comment"># 输出: Hello, I'm Alice</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 获取所有属性</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dir</span>(p))  <span class="comment"># 输出：['name', 'age', 'greet', ...]，列出所有属性和方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 通过字符串获取类</span></span><br><span class="line">class_name = <span class="string">'Person'</span></span><br><span class="line"><span class="keyword">if</span> class_name <span class="keyword">in</span> <span class="built_in">globals</span>():  <span class="comment"># 检查 Person 类是否在全局命名空间中</span></span><br><span class="line">    cls = <span class="built_in">globals</span>()[class_name]  <span class="comment"># 动态获取 Person 类</span></span><br><span class="line">    new_person = cls(<span class="string">'Bob'</span>, <span class="number">25</span>)  <span class="comment"># 使用动态获取的类实例化对象</span></span><br><span class="line">    <span class="built_in">print</span>(new_person.name)  <span class="comment"># 输出: Bob</span></span><br></pre></td></tr></tbody></table></figure><h3 id="通用枚举以及抽象接口定义"><a href="#通用枚举以及抽象接口定义" class="headerlink" title="通用枚举以及抽象接口定义"></a>通用枚举以及抽象接口定义</h3><h5 id="enum-模块：实现枚举类型"><a href="#enum-模块：实现枚举类型" class="headerlink" title="enum 模块：实现枚举类型"></a><code>enum</code> 模块：实现枚举类型</h5><p><code>enum</code> 模块 (Python 3.4+引入) 提供了一种创建枚举（Enumerations）的方法。枚举是一组绑定的符号名称（成员），这些名称是常量，并且具有唯一的（通常是整数）值。使用枚举可以使代码更具可读性、更易于维护，并能有效防止因使用魔法数字或字符串而导致的错误。</p><h6 id="enum-常用功能"><a href="#enum-常用功能" class="headerlink" title="enum 常用功能"></a><code>enum</code> 常用功能</h6><table><thead><tr><th>类/函数/装饰器</th><th>描述</th></tr></thead><tbody><tr><td><code>enum.Enum</code></td><td>创建基本枚举类型的基类。</td></tr><tr><td><code>enum.IntEnum</code></td><td><code>Enum</code> 的子类，其成员也是整数，可以和整数直接比较。</td></tr><tr><td><code>enum.Flag</code></td><td><code>Enum</code> 的子类，其成员可以使用位运算符 (`</td></tr><tr><td><code>enum.IntFlag</code></td><td><code>Flag</code> 的子类，其成员也是整数，并支持位运算。</td></tr><tr><td><code>enum.auto()</code></td><td>在定义枚举成员时，自动为其分配合适的值 (通常是递增的整数)。</td></tr><tr><td><code>@enum.unique</code></td><td>一个类装饰器，确保枚举中没有重复值的成员。</td></tr><tr><td><code>MyEnum.MEMBER_NAME</code></td><td>访问枚举成员。</td></tr><tr><td><code>MyEnum['MEMBER_NAME']</code></td><td>通过字符串名称访问枚举成员。</td></tr><tr><td><code>MyEnum(value)</code></td><td>通过值获取枚举成员。</td></tr><tr><td><code>member.name</code></td><td>(枚举成员属性) 获取成员的名称 (字符串)。</td></tr><tr><td><code>member.value</code></td><td>(枚举成员属性) 获取成员的值。</td></tr></tbody></table><blockquote><p><strong>批注：核心记忆功能 (<code>enum</code> 模块)</strong></p><ul><li>继承 <code>enum.Enum</code> (或 <code>IntEnum</code>, <code>Flag</code>) 来定义自己的枚举。</li><li>使用 <code>enum.auto()</code> 自动分配值，非常方便。</li><li>通过 <code>MyEnum.MEMBER_NAME</code> 或 <code>MyEnum(value)</code> 来引用和获取枚举成员。</li><li><code>member.name</code> 和 <code>member.value</code> 是最常用的成员属性。</li><li><code>@unique</code> 装饰器有助于保证值的唯一性。</li></ul></blockquote><h6 id="enum-模块代码示例"><a href="#enum-模块代码示例" class="headerlink" title="enum 模块代码示例"></a><code>enum</code> 模块代码示例</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> print_utils <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum, IntEnum, Flag, auto, unique</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Any</span> <span class="comment"># 用于类型注解</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line"><span class="comment">## 0. enum 模块演示准备</span></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line">print_header(<span class="string">"enum 模块功能演示"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line"><span class="comment">## 1. 基本枚举 (Enum)</span></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line">print_subheader(<span class="string">"1. 基本枚举 (Enum)"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Color</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    RED = <span class="number">1</span></span><br><span class="line">    GREEN = <span class="number">2</span></span><br><span class="line">    BLUE = <span class="number">3</span></span><br><span class="line"><span class="comment">#    # YELLOW = 1 # 如果没有 @unique，这不会报错，但可能不是期望的行为</span></span><br><span class="line">    </span><br><span class="line">print_info(<span class="string">f"枚举成员 Color.RED: <span class="subst">{Color.RED}</span>"</span>)</span><br><span class="line">print_info(<span class="string">f"  Color.RED 的名称 (name): '<span class="subst">{Color.RED.name}</span>'"</span>)</span><br><span class="line">print_info(<span class="string">f"  Color.RED 的值 (value): <span class="subst">{Color.RED.value}</span>"</span>)</span><br><span class="line">print_info(<span class="string">f"  通过值获取成员 Color(2): <span class="subst">{Color(<span class="number">2</span>)}</span>"</span>)</span><br><span class="line">print_info(<span class="string">f"  通过名称获取成员 Color['GREEN']: <span class="subst">{Color[<span class="string">'GREEN'</span>]}</span>"</span>)</span><br><span class="line">print_info(<span class="string">f"  Color.RED is Color.GREEN: <span class="subst">{Color.RED <span class="keyword">is</span> Color.GREEN}</span>"</span>)</span><br><span class="line">print_info(<span class="string">f"  Color.RED == Color(1): <span class="subst">{Color.RED == Color(<span class="number">1</span>)}</span>"</span>)</span><br><span class="line">print_info(<span class="string">f"  遍历枚举 Color:"</span>)</span><br><span class="line"><span class="keyword">for</span> color_member <span class="keyword">in</span> Color:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"    - <span class="subst">{color_member.name}</span> -&gt; <span class="subst">{color_member.value}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line"><span class="comment">## 2. 使用 auto() 自动分配值 和 @unique 确保值唯一</span></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line">print_subheader(<span class="string">"2. 使用 auto() 和 @unique"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@unique </span><span class="comment"># 确保枚举成员的值是唯一的</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Weekday</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    MONDAY = auto()    <span class="comment"># 值通常从 1 开始递增</span></span><br><span class="line">    TUESDAY = auto()</span><br><span class="line">    WEDNESDAY = auto()</span><br><span class="line">    THURSDAY = auto()</span><br><span class="line">    FRIDAY = auto()</span><br><span class="line">    SATURDAY = auto()</span><br><span class="line">    SUNDAY = auto()</span><br><span class="line"></span><br><span class="line">print_info(<span class="string">"使用 auto() 和 @unique 的 Weekday 枚举:"</span>)</span><br><span class="line"><span class="keyword">for</span> day <span class="keyword">in</span> Weekday:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  - <span class="subst">{day.name}</span>: <span class="subst">{day.value}</span>"</span>)</span><br><span class="line"></span><br><span class="line">print_info(<span class="string">f"Weekday['MONDAY'].value: <span class="subst">{Weekday.MONDAY.value}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line"><span class="comment">## 3. 整数枚举 (IntEnum)</span></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line">print_subheader(<span class="string">"3. 整数枚举 (IntEnum)"</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorCode</span>(<span class="title class_ inherited__">IntEnum</span>): <span class="comment"># 成员可以直接与整数比较</span></span><br><span class="line">    OK = <span class="number">0</span></span><br><span class="line">    NOT_FOUND = <span class="number">404</span></span><br><span class="line">    SERVER_ERROR = <span class="number">500</span></span><br><span class="line"></span><br><span class="line">print_info(<span class="string">f"ErrorCode.NOT_FOUND: <span class="subst">{ErrorCode.NOT_FOUND}</span>"</span>)</span><br><span class="line">print_info(<span class="string">f"  ErrorCode.NOT_FOUND == 404: <span class="subst">{ErrorCode.NOT_FOUND == <span class="number">404</span>}</span>"</span>) <span class="comment"># True</span></span><br><span class="line">print_info(<span class="string">f"  ErrorCode.OK &lt; ErrorCode.SERVER_ERROR: <span class="subst">{ErrorCode.OK &lt; ErrorCode.SERVER_ERROR}</span>"</span>) <span class="comment"># True</span></span><br><span class="line">print_info(<span class="string">f"  int(ErrorCode.SERVER_ERROR): <span class="subst">{<span class="built_in">int</span>(ErrorCode.SERVER_ERROR)}</span>"</span>) <span class="comment"># 500</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line"><span class="comment">## 4. 标志枚举 (Flag 和 IntFlag) - 支持位运算</span></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line">print_subheader(<span class="string">"4. 标志枚举 (Flag 和 IntFlag)"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Permissions</span>(<span class="title class_ inherited__">Flag</span>): <span class="comment"># Flag 成员的值通常是 2 的幂</span></span><br><span class="line">    NONE = <span class="number">0</span> <span class="comment"># 通常定义一个 "无" 或 "空" 标志</span></span><br><span class="line">    READ = auto()    <span class="comment"># 1</span></span><br><span class="line">    WRITE = auto()   <span class="comment"># 2</span></span><br><span class="line">    EXECUTE = auto() <span class="comment"># 4</span></span><br><span class="line">    READ_WRITE = READ | WRITE <span class="comment"># 组合标志</span></span><br><span class="line">    ALL = READ | WRITE | EXECUTE</span><br><span class="line"></span><br><span class="line">user1_perms: Permissions = Permissions.READ | Permissions.WRITE</span><br><span class="line">user2_perms: Permissions = Permissions.READ</span><br><span class="line">admin_perms: Permissions = Permissions.ALL</span><br><span class="line"></span><br><span class="line">print_info(<span class="string">f"User1 权限 (READ | WRITE): <span class="subst">{user1_perms}</span> (值为: <span class="subst">{user1_perms.value}</span>)"</span>)</span><br><span class="line">print_info(<span class="string">f"  User1 是否有 READ 权限: <span class="subst">{Permissions.READ <span class="keyword">in</span> user1_perms}</span>"</span>)   <span class="comment"># True</span></span><br><span class="line">print_info(<span class="string">f"  User1 是否有 EXECUTE 权限: <span class="subst">{Permissions.EXECUTE <span class="keyword">in</span> user1_perms}</span>"</span>) <span class="comment"># False</span></span><br><span class="line">print_info(<span class="string">f"  User1 是否只有 READ_WRITE 权限: <span class="subst">{user1_perms == Permissions.READ_WRITE}</span>"</span>) <span class="comment"># True</span></span><br><span class="line"></span><br><span class="line">print_info(<span class="string">f"Admin 权限 (ALL): <span class="subst">{admin_perms}</span> (值为: <span class="subst">{admin_perms.value}</span>)"</span>)</span><br><span class="line">print_info(<span class="string">f"  Admin 是否包含所有权限 (READ|WRITE|EXECUTE): <span class="subst">{admin_perms == (Permissions.READ | Permissions.WRITE | Permissions.EXECUTE)}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## IntFlag 类似，但其成员也是整数</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileAccess</span>(<span class="title class_ inherited__">IntFlag</span>):</span><br><span class="line">    R_OK = os.R_OK <span class="comment"># 使用 os 模块的常量 (通常是 4)</span></span><br><span class="line">    W_OK = os.W_OK <span class="comment"># (通常是 2)</span></span><br><span class="line">    X_OK = os.X_OK <span class="comment"># (通常是 1)</span></span><br><span class="line">    RW_OK = R_OK | W_OK</span><br><span class="line"></span><br><span class="line">file_mode: FileAccess = FileAccess.R_OK | FileAccess.W_OK</span><br><span class="line">print_info(<span class="string">f"\nFileAccess 模式 (R_OK | W_OK): <span class="subst">{file_mode}</span> (值为: <span class="subst">{file_mode.value}</span>)"</span>)</span><br><span class="line">print_info(<span class="string">f"  文件是否可读 (R_OK in file_mode): <span class="subst">{FileAccess.R_OK <span class="keyword">in</span> file_mode}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>坑点与建议 (<code>enum</code> 模块)</strong>:</p><ul><li><strong>可读性与维护性</strong>: 使用枚举可以替代代码中散落的魔法数字或字符串常量，使得代码意图更清晰，更易于维护。当需要修改某个状态的含义或值时，只需在枚举定义处修改一处即可。</li><li><strong>成员的唯一性</strong>:<ul><li>默认情况下，<code>Enum</code> 允许不同的成员名称指向相同的值（别名）。</li><li>使用 <code>@unique</code> 类装饰器可以强制枚举中的所有成员值必须唯一，如果存在重复值则会在定义时抛出 <code>ValueError</code>。</li></ul></li><li><strong>成员的比较</strong>: 枚举成员是单例。你可以使用 <code>is</code> 或 <code>==</code> 来比较两个枚举成员是否相同。<code>IntEnum</code> 和 <code>IntFlag</code> 的成员还可以直接与整数进行比较。</li><li><strong>迭代与访问</strong>: 可以迭代枚举类的所有成员。可以通过成员名 (<code>MyEnum.MEMBER</code>)、方括号加成员名字符串 (<code>MyEnum['MEMBER']</code>) 或成员值 (<code>MyEnum(value)</code>) 来访问特定的枚举成员。</li><li><strong><code>auto()</code> 的行为</strong>: <code>enum.auto()</code> 会自动为枚举成员分配一个值。默认情况下，对于 <code>Enum</code>，它从1开始递增。对于 <code>Flag</code>，它会分配2的幂 (1, 2, 4, 8, …)。你可以通过重写 <code>_generate_next_value_</code> 特殊方法来自定义 <code>auto()</code> 的行为。</li><li><strong><code>Flag</code> 与位运算</strong>: <code>Flag</code> 和 <code>IntFlag</code> 类型的枚举成员支持位运算符 (<code>|</code>, <code>&amp;</code>, <code>^</code>, <code>~</code>)，非常适合表示权限、状态组合等场景。可以使用 <code>in</code> 操作符来检查一个组合标志是否包含某个特定标志。</li><li><strong>JSON 序列化</strong>: 默认情况下，枚举成员在 JSON 序列化时可能不会直接变成期望的字符串或整数。你可能需要自定义序列化逻辑，或者在序列化前获取成员的 <code>.name</code> 或 <code>.value</code> 属性。</li></ul></blockquote><h5 id="abc-模块：定义抽象基类-Abstract-Base-Classes"><a href="#abc-模块：定义抽象基类-Abstract-Base-Classes" class="headerlink" title="abc 模块：定义抽象基类 (Abstract Base Classes)"></a><code>abc</code> 模块：定义抽象基类 (Abstract Base Classes)</h5><p><code>abc</code> 模块 (Abstract Base Classes) 用于帮助定义和使用抽象基类。抽象基类是一种不能被直接实例化的类，它存在的目的是作为其他类的“模板”或“接口约定”。子类如果继承了抽象基类，就必须实现抽象基类中声明的所有抽象方法和抽象属性，否则子类本身也会成为抽象类，无法实例化。</p><p>这有助于强制执行接口规范，实现多态，并构建更健壮、更松耦合的系统。</p><h6 id="abc-常用功能"><a href="#abc-常用功能" class="headerlink" title="abc 常用功能"></a><code>abc</code> 常用功能</h6><table><thead><tr><th>类/装饰器</th><th>描述</th></tr></thead><tbody><tr><td><code>abc.ABC</code></td><td>一个辅助类，用于通过继承来创建抽象基类。</td></tr><tr><td><code>@abc.abstractmethod</code></td><td>一个装饰器，用于声明一个抽象方法，子类必须实现它。</td></tr><tr><td><code>@abc.abstractproperty</code></td><td>(Python 3.3+) 一个装饰器，用于声明一个抽象属性 (getter, setter, deleter)，子类必须实现。在旧版本中，通常通过组合 <code>@property</code> 和 <code>@abstractmethod</code> 实现。</td></tr><tr><td><code>@abc.abstractclassmethod</code></td><td>(Python 3.3+) 声明抽象类方法。</td></tr><tr><td><code>@abc.abstractstaticmethod</code></td><td>(Python 3.3+) 声明抽象静态方法。</td></tr><tr><td><code>isinstance(obj, MyABC)</code></td><td>可以检查一个对象 <code>obj</code> 是否是某个抽象基类 <code>MyABC</code> 的实例 (即使是通过虚拟子类注册的)。</td></tr><tr><td><code>MyABC.register(MyClass)</code></td><td>(类方法) 将 <code>MyClass</code> 注册为 <code>MyABC</code> 的虚拟子类，即使 <code>MyClass</code> 没有显式继承 <code>MyABC</code>。</td></tr></tbody></table><blockquote><p><strong>批注：核心记忆功能 (<code>abc</code> 模块)</strong></p><ul><li>继承 <code>ABC</code> 来定义抽象基类。</li><li>使用 <code>@abstractmethod</code> 来标记那些必须在具体子类中被重写的方法。</li><li>抽象基类不能直接实例化。</li><li>它的主要目的是定义一个清晰的接口或契约，供子类遵循。</li></ul></blockquote><h6 id="abc-模块代码示例"><a href="#abc-模块代码示例" class="headerlink" title="abc 模块代码示例"></a><code>abc</code> 模块代码示例</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> print_utils <span class="keyword">import</span> * <span class="comment"># 假设 print_utils.py 可用</span></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod, abstractproperty <span class="comment"># Python 3.3+ for abstractproperty</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Tuple</span>, <span class="type">Type</span>, <span class="type">Any</span> <span class="comment"># 用于类型注解</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line"><span class="comment">## 0. abc 模块演示准备</span></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line">print_header(<span class="string">"abc 模块 (抽象基类) 功能演示"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line"><span class="comment">## 1. 定义一个抽象基类 Shape</span></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line">print_subheader(<span class="string">"1. 定义抽象基类 Shape"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Shape</span>(<span class="title class_ inherited__">ABC</span>): <span class="comment"># 继承自 ABC，表明这是一个抽象基类</span></span><br><span class="line">    <span class="string">"""一个表示几何形状的抽象基类。"""</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod </span><span class="comment"># 标记 area() 为抽象方法</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">area</span>(<span class="params">self</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">"""计算并返回形状的面积。子类必须实现此方法。"""</span></span><br><span class="line">        <span class="keyword">pass</span> <span class="comment"># 抽象方法通常只有 pass 或 raise NotImplementedError()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod </span><span class="comment"># 标记 perimeter() 为抽象方法</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perimeter</span>(<span class="params">self</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">"""计算并返回形状的周长。子类必须实现此方法。"""</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">"子类必须实现 perimeter 方法"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractproperty </span><span class="comment"># Python 3.3+ (旧版本用 @property + @abstractmethod)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">shape_type</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">"""返回形状的类型名称 (例如 'Circle', 'Rectangle')。子类必须实现此属性。"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">#    # 这是一个具体方法，子类可以直接继承或重写</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">describe</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">"""返回对形状的描述。"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"这是一个 '<span class="subst">{self.shape_type}</span>'，面积为 <span class="subst">{self.area():<span class="number">.2</span>f}</span>，周长为 <span class="subst">{self.perimeter():<span class="number">.2</span>f}</span>。"</span></span><br><span class="line"></span><br><span class="line">print_info(<span class="string">"抽象基类 Shape 已定义。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 尝试实例化抽象基类 (会失败)</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    s = Shape()</span><br><span class="line">    print_error(<span class="string">"错误：抽象基类 Shape 被实例化了！(不应发生)"</span>)</span><br><span class="line"><span class="keyword">except</span> TypeError <span class="keyword">as</span> e:</span><br><span class="line">    print_success(<span class="string">f"尝试实例化 Shape 时捕获到预期的 TypeError: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line"><span class="comment">## 2. 创建具体子类 Circle 和 Rectangle</span></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line">print_subheader(<span class="string">"2. 创建具体子类 Circle 和 Rectangle"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Circle</span>(<span class="title class_ inherited__">Shape</span>):</span><br><span class="line">    <span class="string">"""表示圆形的具体类。"""</span></span><br><span class="line">    PI: <span class="built_in">float</span> = <span class="number">3.1415926535</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, radius: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="keyword">if</span> radius &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"半径必须为正数。"</span>)</span><br><span class="line">        <span class="variable language_">self</span>._radius: <span class="built_in">float</span> = radius</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">area</span>(<span class="params">self</span>) -&gt; <span class="built_in">float</span>: <span class="comment"># 实现抽象方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.PI * (<span class="variable language_">self</span>._radius ** <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perimeter</span>(<span class="params">self</span>) -&gt; <span class="built_in">float</span>: <span class="comment"># 实现抽象方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> * <span class="variable language_">self</span>.PI * <span class="variable language_">self</span>._radius</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property </span><span class="comment"># 实现抽象属性</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">shape_type</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"圆形"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rectangle</span>(<span class="title class_ inherited__">Shape</span>):</span><br><span class="line">    <span class="string">"""表示矩形的具体类。"""</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, width: <span class="built_in">float</span>, height: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="keyword">if</span> width &lt;= <span class="number">0</span> <span class="keyword">or</span> height &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"宽度和高度必须为正数。"</span>)</span><br><span class="line">        <span class="variable language_">self</span>._width: <span class="built_in">float</span> = width</span><br><span class="line">        <span class="variable language_">self</span>._height: <span class="built_in">float</span> = height</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">area</span>(<span class="params">self</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._width * <span class="variable language_">self</span>._height</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perimeter</span>(<span class="params">self</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> * (<span class="variable language_">self</span>._width + <span class="variable language_">self</span>._height)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">shape_type</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"矩形"</span></span><br><span class="line"></span><br><span class="line">print_info(<span class="string">"具体子类 Circle 和 Rectangle 已定义。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 实例化具体子类</span></span><br><span class="line">circle_instance = Circle(radius=<span class="number">5.0</span>)</span><br><span class="line">rectangle_instance = Rectangle(width=<span class="number">4.0</span>, height=<span class="number">6.0</span>)</span><br><span class="line"></span><br><span class="line">print_success(<span class="string">f"圆的描述: <span class="subst">{circle_instance.describe()}</span>"</span>)</span><br><span class="line">print_success(<span class="string">f"矩形的描述: <span class="subst">{rectangle_instance.describe()}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line"><span class="comment">## 3. 演示未完全实现抽象方法的子类</span></span><br><span class="line"><span class="comment">## =============================================================</span></span><br><span class="line">print_subheader(<span class="string">"3. 演示未完全实现抽象方法的子类"</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IncompleteSquare</span>(<span class="title class_ inherited__">Shape</span>): <span class="comment"># Square 应该也实现 perimeter 和 shape_type</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, side: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>._side: <span class="built_in">float</span> = side</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">area</span>(<span class="params">self</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._side ** <span class="number">2</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#    # 故意不实现 perimeter 和 shape_type</span></span><br><span class="line"><span class="comment">#    # @property</span></span><br><span class="line"><span class="comment">#    # def shape_type(self) -&gt; str:</span></span><br><span class="line"><span class="comment">#    #     return "不完整的正方形"</span></span><br><span class="line"></span><br><span class="line">print_info(<span class="string">"定义了一个未完全实现抽象方法的 IncompleteSquare 类。"</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    incomplete_sq = IncompleteSquare(side=<span class="number">3</span>)</span><br><span class="line">    print_error(<span class="string">"错误：不完整的抽象子类 IncompleteSquare 被实例化了！(不应发生)"</span>)</span><br><span class="line"><span class="comment">#    # incomplete_sq.describe() # 如果能实例化，这里调用 perimeter() 会出错</span></span><br><span class="line"><span class="keyword">except</span> TypeError <span class="keyword">as</span> e:</span><br><span class="line">    print_success(<span class="string">f"尝试实例化 IncompleteSquare 时捕获到预期的 TypeError: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">pass</span> <span class="comment"># 演示已在各节内进行</span></span><br><span class="line">print_header(<span class="string">"abc 模块演示结束。"</span>)</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>坑点与建议 (<code>abc</code> 模块)</strong>:</p><ul><li><strong>强制接口实现</strong>: <code>abc</code> 模块的主要目的是强制子类实现特定的方法和属性，从而确保它们都遵循一个共同的“契约”或“接口”。这在大型项目或框架设计中非常有用，可以提高代码的稳定性和可维护性。</li><li><strong>实例化错误</strong>: 如果一个类继承了 <code>ABC</code> 并有未被实现的抽象方法/属性（通过 <code>@abstractmethod</code> 或 <code>@abstractproperty</code> 标记），那么尝试实例化这个类（或其同样未完全实现的子类）会在运行时抛出 <code>TypeError</code>。</li><li><strong><code>@abstractproperty</code></strong>: 从 Python 3.3 开始，可以直接使用 <code>@abstractproperty</code>。在此之前，定义抽象属性通常需要组合使用 <code>@property</code> 和 <code>@abstractmethod</code>：<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="meta">@abstractmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_abstract_prop</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure></li><li><strong>虚拟子类 (<code>register</code>)</strong>: 除了通过继承，你还可以使用 <code>MyABC.register(AnotherClass)</code> 将一个完全不相关的类 <code>AnotherClass</code> 注册为抽象基类 <code>MyABC</code> 的“虚拟子类”。这意味着 <code>isinstance(obj_of_another_class, MyABC)</code> 会返回 <code>True</code>，但 <code>AnotherClass</code> 并不会真正从 <code>MyABC</code> 继承任何方法或属性，也不会被强制实现抽象方法。这种方式主要用于在不修改现有类继承关系的情况下，将其归类到某个抽象接口下。</li><li><strong>不仅仅是“接口”</strong>: 虽然抽象基类的作用与某些语言中的“接口”概念相似，但 Python 的抽象基类可以包含具体的方法实现（如示例中的 <code>describe()</code> 方法），子类可以直接继承这些实现。</li><li><strong>何时使用</strong>: 当你希望定义一组类应该共同拥有的行为，但具体实现方式因类而异时，抽象基类是一个很好的选择。例如，定义一个通用的 <code>DataStorage</code> 接口，然后有 <code>DatabaseStorage</code>, <code>FileStorage</code>, <code>InMemoryStorage</code> 等具体实现。</li></ul></blockquote><h3 id="元类编程"><a href="#元类编程" class="headerlink" title="元类编程"></a>元类编程</h3><p>元类是创建类的类，<code>type</code> 是 Python 的内置元类。</p><h4 id="元类的核心方法"><a href="#元类的核心方法" class="headerlink" title="元类的核心方法"></a>元类的核心方法</h4><table><thead><tr><th>方法</th><th>描述</th><th>调用时机</th></tr></thead><tbody><tr><td><code>__new__(mcs, name, bases, attrs)</code></td><td>创建类对象</td><td>定义类时</td></tr><tr><td><code>__init__(cls, name, bases, attrs)</code></td><td>初始化类对象</td><td>类创建后</td></tr><tr><td><code>__call__(cls, *args, **kwargs)</code></td><td>创建类的实例</td><td>实例化类时</td></tr></tbody></table><h4 id="使用-type-动态创建类"><a href="#使用-type-动态创建类" class="headerlink" title="使用 type 动态创建类"></a>使用 type 动态创建类</h4><p>在我们使用 class 定义关键字时，其实是 Python 底层执行了以下四步操作为我们定义了一个类，分别是：</p><ul><li>1.定义类名</li><li>2.定义基类</li><li>3.执行类子代码，产生名称空间</li><li>4.调用元素</li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 1.定义类名</span></span><br><span class="line">class_name = <span class="string">"Human"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.定义基类</span></span><br><span class="line">class_bases = (<span class="built_in">object</span>,)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.执行子类代码，产生名称空间</span></span><br><span class="line">class_dic = {}</span><br><span class="line">class_body = <span class="string">"""</span></span><br><span class="line"><span class="string">def __init__(self, name, age):</span></span><br><span class="line"><span class="string">    self.name = name</span></span><br><span class="line"><span class="string">    self.age = age</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def say_hello(self):</span></span><br><span class="line"><span class="string">    print(f"你好，我是{self.name}，今年{self.age}岁")</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="comment"># exec函数语法：exec(object[, globals[, locals]])</span></span><br><span class="line"><span class="comment"># object: 要执行的Python代码字符串或代码对象</span></span><br><span class="line"><span class="comment"># globals: 可选参数，指定代码执行时的全局命名空间，默认为当前全局命名空间</span></span><br><span class="line"><span class="comment"># locals: 可选参数，指定代码执行时的局部命名空间，默认与globals相同</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里传入三个参数：</span></span><br><span class="line"><span class="comment"># 1. class_body: 包含类方法定义的Python代码字符串</span></span><br><span class="line"><span class="comment"># 2. {}: 空字典作为全局命名空间，避免访问外部全局变量</span></span><br><span class="line"><span class="comment"># 3. class_dic: 作为局部命名空间，执行后class_body中定义的方法会存储在这个字典中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这样做的目的是隔离执行环境，并将执行结果(类的方法定义)收集到class_dic字典中，</span></span><br><span class="line"><span class="comment"># 之后可以将这个字典传给type函数来动态创建类</span></span><br><span class="line"><span class="built_in">exec</span>(class_body, {}, class_dic)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.调用原类</span></span><br><span class="line">Human = <span class="built_in">type</span>(class_name,class_bases,class_dic)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 创建实例对象</span></span><br><span class="line">person = Human(<span class="string">"张三"</span>, <span class="number">25</span>)</span><br><span class="line"><span class="comment"># 6. 调用实例方法</span></span><br><span class="line">person.say_hello() <span class="comment"># 你好，我是张三，今年25岁</span></span><br></pre></td></tr></tbody></table></figure><h4 id="自定义元类"><a href="#自定义元类" class="headerlink" title="自定义元类"></a>自定义元类</h4><p>对于元类来说，最关键的步骤也就是在第四步，在我们调用原类之前可以对这个类做一些自定义化操作，如 <code>类名不能带特殊符号，类必须写文档注释......</code> 我们通过一个自定义类来实现这个功能</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyType</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, class_name, class_bases, class_attrs</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"_"</span> <span class="keyword">in</span> class_name:</span><br><span class="line">            <span class="keyword">raise</span> NameError(<span class="string">"类名不能包含下划线"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> class_attrs.get(<span class="string">"__doc__"</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"类必须有文档注释"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查类属性名是否符合规范</span></span><br><span class="line">        <span class="keyword">for</span> attr_name <span class="keyword">in</span> class_attrs:</span><br><span class="line">            <span class="keyword">if</span> attr_name.startswith(<span class="string">"__"</span>) <span class="keyword">and</span> attr_name.endswith(<span class="string">"__"</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> attr_name.islower():</span><br><span class="line">                <span class="keyword">raise</span> NameError(<span class="string">"属性名必须全部小写"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否有必要的方法</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"info"</span> <span class="keyword">not</span> <span class="keyword">in</span> class_attrs:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"类必须实现info方法"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查类的基类</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> class_bases:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"类必须继承至少一个父类"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Human</span>(<span class="built_in">object</span>, metaclass=MyType):</span><br><span class="line">    <span class="string">"""人类的基本信息类，如果没有这个注释会报错"""</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"name:<span class="subst">{self.name}</span>,age:<span class="subst">{self.age}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="元类的-new-方法"><a href="#元类的-new-方法" class="headerlink" title="元类的 __new__ 方法"></a>元类的 <code>__new__</code> 方法</h4><p>在我们调用类产生一个空对象的时候，在执行 <code>__init__</code> 方法之前一定执行了其他方法，我们都知道在 Python 中，所有的类都默认继承自 <code>object</code> 基类，但在下述的例子，当我们没有给自定义元类传入 object，他报错了，这是为什么呢？</p><p>本质上我们的 self，也就指的是 <code>Human</code> 这个类，对于 class_bases 来说，他只是一个形参而已，真正为我们继承父类的方法是 <code>__new__</code> 方法</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyType</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, class_name, class_bases, class_attrs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="variable language_">self</span>.__bases__) <span class="comment"># (&lt;class 'object'&gt;,)</span></span><br><span class="line">        <span class="comment"># 检查类的基类</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> class_bases:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"类必须继承至少一个父类"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Human</span>(metaclass=MyType):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"name:<span class="subst">{self.name}</span>,age:<span class="subst">{self.age}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>我们可以通过进一步剖析 <code>__new__</code> 方法</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyType</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, class_name, class_bases, class_attrs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="variable language_">self</span>.__bases__)  <span class="comment"># (&lt;class 'object'&gt;,)</span></span><br><span class="line">        <span class="comment"># 检查类的基类</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> class_bases:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"类必须继承至少一个父类"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"cls==========&gt;"</span>, cls) <span class="comment"># &lt;class '__main__.MyType'&gt;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"args=========&gt;"</span>, args)  <span class="comment"># ('Human', (), {'__module__': '__main__', '__qualname__': 'Human', '__init__': &lt;function Human.__init__ at 0x000001D726C02CA0&gt;, 'info': &lt;function Human.info at 0x000001D726B9BEE0&gt;})</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"kwargs=========&gt;"</span>, kwargs)  <span class="comment"># {}</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__new__(cls, *args, **kwargs) <span class="comment"># 通过调用父类的__new__方法,他会在底层帮我们继承object对象,存放__()__属性等</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Human</span>(metaclass=MyType):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"name:<span class="subst">{self.name}</span>,age:<span class="subst">{self.age}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="元类的-call-方法实例"><a href="#元类的-call-方法实例" class="headerlink" title="元类的 __call__ 方法实例"></a>元类的 <code>__call__</code> 方法实例</h4><p>当调用类（如 <code>Person()</code>）创建实例时，实际上是调用元类的 <code>__call__</code> 方法。自定义此方法可以控制实例化过程：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SingletonMeta</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    _instances = {}</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="string">"""控制类实例化过程"""</span></span><br><span class="line">        <span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> cls._instances:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"创建 <span class="subst">{cls.__name__}</span> 的新实例"</span>)</span><br><span class="line">            <span class="comment"># 正常的实例化过程：创建实例并初始化</span></span><br><span class="line">            instance = <span class="built_in">super</span>().__call__(*args, **kwargs)</span><br><span class="line">            cls._instances[cls] = instance</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"返回 <span class="subst">{cls.__name__}</span> 的现有实例"</span>)</span><br><span class="line">        <span class="keyword">return</span> cls._instances[cls]</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Database</span>(metaclass=SingletonMeta):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host, port</span>):</span><br><span class="line">        <span class="variable language_">self</span>.host = host</span><br><span class="line">        <span class="variable language_">self</span>.port = port</span><br><span class="line">        </span><br><span class="line"><span class="comment">## 第一次调用，创建新实例</span></span><br><span class="line">db1 = Database(<span class="string">"localhost"</span>, <span class="number">5432</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"DB1: <span class="subst">{db1.host}</span>:<span class="subst">{db1.port}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 第二次调用，返回现有实例</span></span><br><span class="line">db2 = Database(<span class="string">"example.com"</span>, <span class="number">8080</span>)  <span class="comment"># 参数被忽略！</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"DB2: <span class="subst">{db2.host}</span>:<span class="subst">{db2.port}</span>"</span>)  <span class="comment"># 仍然是localhost:5432</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 验证是同一个实例</span></span><br><span class="line"><span class="built_in">print</span>(db1 <span class="keyword">is</span> db2)  <span class="comment"># True</span></span><br></pre></td></tr></tbody></table></figure><h4 id="元类链和类创建过程"><a href="#元类链和类创建过程" class="headerlink" title="元类链和类创建过程"></a>元类链和类创建过程</h4><table><thead><tr><th>步骤</th><th>描述</th><th>涉及方法</th></tr></thead><tbody><tr><td>1</td><td>收集类定义信息</td><td>Python 解释器执行类体</td></tr><tr><td>2</td><td>调用元类的 <code>__new__</code></td><td>创建类对象</td></tr><tr><td>3</td><td>调用元类的 <code>__init__</code></td><td>初始化类对象</td></tr><tr><td>4</td><td>返回创建的类</td><td>类可以使用了</td></tr></tbody></table><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TraceMeta</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">mcs, name, bases, attrs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"[元类__new__] 创建类 <span class="subst">{name}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__new__(mcs, name, bases, attrs)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">cls, name, bases, attrs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"[元类__init__] 初始化类 <span class="subst">{name}</span>"</span>)</span><br><span class="line">        <span class="built_in">super</span>().__init__(name, bases, attrs)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"[元类__call__] 调用类 <span class="subst">{cls.__name__}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. 创建实例（调用类的__new__）</span></span><br><span class="line">        instance = cls.__new__(cls, *args, **kwargs)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. 初始化实例（调用类的__init__）</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(instance, cls):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[元类__call__] 初始化 <span class="subst">{cls.__name__}</span> 实例"</span>)</span><br><span class="line">            cls.__init__(instance, *args, **kwargs)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>(metaclass=TraceMeta):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"[类__new__] 创建 <span class="subst">{cls.__name__}</span> 实例"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__new__(cls)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"[类__init__] 初始化 <span class="subst">{self.__class__.__name__}</span> 实例，x=<span class="subst">{x}</span>"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.x = x</span><br><span class="line">        </span><br><span class="line"><span class="built_in">print</span>(<span class="string">"定义完成，开始创建实例..."</span>)</span><br><span class="line">obj = MyClass(<span class="number">42</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="内置的元类属性和方法表"><a href="#内置的元类属性和方法表" class="headerlink" title="内置的元类属性和方法表"></a>内置的元类属性和方法表</h4><table><thead><tr><th>属性/方法</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td><code>__metaclass__</code></td><td>指定类的元类</td><td><code>class A(metaclass=MyMeta):</code></td></tr><tr><td><code>__mro__</code></td><td>方法解析顺序</td><td><code>A.__mro__</code></td></tr><tr><td><code>__bases__</code></td><td>直接父类元组</td><td><code>A.__bases__</code></td></tr><tr><td><code>__subclasses__()</code></td><td>直接子类列表</td><td><code>A.__subclasses__()</code></td></tr><tr><td><code>__class__</code></td><td>对象的类</td><td><code>obj.__class__</code></td></tr><tr><td><code>mro()</code></td><td>返回方法解析顺序</td><td><code>A.mro()</code></td></tr></tbody></table><h3 id="Python-特殊方法（魔术方法）"><a href="#Python-特殊方法（魔术方法）" class="headerlink" title="Python 特殊方法（魔术方法）"></a>Python 特殊方法（魔术方法）</h3><p>Python 的特殊方法（也称为魔术方法或双下方法）是 Python 面向对象编程中的核心概念，它们允许自定义类行为以适应 Python 的语言特性。这些方法以双下划线开始和结束（如 <code>__init__</code>），当特定操作发生时会被自动调用</p><h5 id="1-对象创建与销毁"><a href="#1-对象创建与销毁" class="headerlink" title="1. 对象创建与销毁"></a>1. 对象创建与销毁</h5><table><thead><tr><th>方法名</th><th>描述</th><th>触发方式</th><th>使用场景</th></tr></thead><tbody><tr><td><code>__init__(self, ...)</code></td><td>初始化对象</td><td>创建实例后调用</td><td>设置实例属性</td></tr><tr><td><code>__new__(cls, ...)</code></td><td>创建对象</td><td>实例化时调用（比 init 先）</td><td>自定义实例创建过程，实现单例模式</td></tr><tr><td><code>__del__(self)</code></td><td>析构方法</td><td>对象被销毁时调用</td><td>释放资源，关闭文件或连接</td></tr></tbody></table><h6 id="实际应用场景："><a href="#实际应用场景：" class="headerlink" title="实际应用场景："></a>实际应用场景：</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseConnection</span>:</span><br><span class="line">    _instance = <span class="literal">None</span>  <span class="comment"># 类变量用于存储单例实例</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):  <span class="comment"># 这里的cls，也就是我们当前的类DatabaseConnection</span></span><br><span class="line">        <span class="comment"># 实现单例模式，确保只创建一个数据库连接实例</span></span><br><span class="line">        <span class="keyword">if</span> cls._instance <span class="keyword">is</span> <span class="literal">None</span>:  <span class="comment"># 若我们的类里面的_instance变量没有被初始化，则创建一个新的实例</span></span><br><span class="line">            cls._instance = <span class="built_in">super</span>().__new__(cls)  <span class="comment"># 调用父类的__new__方法，创建实例</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"创建新的数据库连接实例"</span>)  <span class="comment"># 打印日志</span></span><br><span class="line">        <span class="keyword">return</span> cls._instance  <span class="comment"># 返回单例实例</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host, user, password</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>,<span class="string">"initialized"</span>): <span class="comment"># 如果类对象身上</span></span><br><span class="line">            <span class="variable language_">self</span>.host = host</span><br><span class="line">            <span class="variable language_">self</span>.user = user</span><br><span class="line">            <span class="variable language_">self</span>.password = password</span><br><span class="line">            <span class="variable language_">self</span>.initialized = <span class="literal">True</span>  <span class="comment"># 初始化完成</span></span><br><span class="line">            <span class="variable language_">self</span>.connection = <span class="literal">None</span>  <span class="comment"># 数据库连接对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 模拟数据库连接</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.connection:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"连接到数据库<span class="subst">{self.host}</span> 成功 \n 用户名：<span class="subst">{self.user}</span> \n 密码：<span class="subst">{self.password}</span>"</span>)</span><br><span class="line">            <span class="variable language_">self</span>.connection = <span class="literal">True</span>  <span class="comment"># 连接成功</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.connection</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 对象销毁时关闭连接</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.connection:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"关闭数据库连接：<span class="subst">{self.host}</span>"</span>)</span><br><span class="line">            <span class="variable language_">self</span>.connection = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">db1 = DatabaseConnection(<span class="string">"localhost"</span>, <span class="string">"admin"</span>, <span class="string">"password"</span>)</span><br><span class="line">db2 = DatabaseConnection(<span class="string">"localhost"</span>, <span class="string">"admin"</span>, <span class="string">"newpassword"</span>)  <span class="comment"># 不会创建新实例</span></span><br><span class="line"><span class="comment"># 判断两者是否为同一个实例</span></span><br><span class="line"><span class="built_in">print</span>(db1 <span class="keyword">is</span> db2)  <span class="comment"># True</span></span><br><span class="line">db1.connect()  <span class="comment"># 连接到数据库</span></span><br></pre></td></tr></tbody></table></figure><h5 id="2-对象表示"><a href="#2-对象表示" class="headerlink" title="2. 对象表示"></a>2. 对象表示</h5><table><thead><tr><th>方法名</th><th>描述</th><th>触发方式</th><th>使用场景</th></tr></thead><tbody><tr><td><code>__str__(self)</code></td><td>可读字符串表示</td><td><code>str(obj)</code>, <code>print(obj)</code></td><td>在直接输出类时标准化的输出类上面的所有属性</td></tr><tr><td><code>__repr__(self)</code></td><td>正式字符串表示</td><td><code>repr(obj)</code></td><td>为开发者提供详细信息，理想情况下应返回可重新创建对象的代码</td></tr></tbody></table><h6 id="实际应用场景：-1"><a href="#实际应用场景：-1" class="headerlink" title="实际应用场景："></a>实际应用场景：</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Product</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, <span class="built_in">id</span>, name, price</span>):</span><br><span class="line">        <span class="variable language_">self</span>.<span class="built_in">id</span> = <span class="built_in">id</span></span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.price = price</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 返回用户友好的描述</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"<span class="subst">{self.name}</span> (¥<span class="subst">{self.price:<span class="number">.2</span>f}</span>)"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 返回可重新创建此对象的代码</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"Product(id=<span class="subst">{self.<span class="built_in">id</span>!r}</span>, name=<span class="subst">{self.name!r}</span>, price=<span class="subst">{self.price!r}</span>)"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">apple = Product(<span class="number">1</span>, <span class="string">"苹果"</span>, <span class="number">5.99</span>)</span><br><span class="line"><span class="built_in">print</span>(apple)  <span class="comment"># 输出: 苹果 (¥5.99)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(apple))  <span class="comment"># 输出: Product(id=1, name='苹果', price=5.99)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在调试中的价值</span></span><br><span class="line">products = [</span><br><span class="line">    Product(<span class="number">1</span>, <span class="string">"苹果"</span>, <span class="number">5.99</span>),</span><br><span class="line">    Product(<span class="number">2</span>, <span class="string">"香蕉"</span>, <span class="number">3.50</span>)</span><br><span class="line">]</span><br><span class="line"><span class="built_in">print</span>(products)  <span class="comment"># 会显示完整的repr信息，有助于调试</span></span><br></pre></td></tr></tbody></table></figure><ul><li><p><code>__str__</code> 输出的是一个友好易读的字符串，适合用户查看。</p></li><li><p><code>__repr__</code> 输出的是一个更正式的字符串，通常能够通过 <code>eval()</code> 来重建该对象。</p></li><li><p><strong>示例 2：交互式环境中的 <code>__repr__</code></strong></p><p>在 Python 的交互式环境中（比如直接在命令行输入 <code>python</code>），当你打印一个对象时，如果对象有 <code>__repr__</code> 方法，通常会看到 <code>__repr__</code> 的返回值，而不是 <code>__str__</code>。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obj = MyClass(<span class="string">"Bob"</span>, <span class="number">25</span>)</span><br><span class="line">obj  <span class="comment"># 在交互式环境中，自动调用 __repr__</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MyClass('Bob', 25)</span><br></pre></td></tr></tbody></table></figure></li></ul><ol start="3"><li><p><strong><code>__repr__</code> 的目标</strong></p><p><code>__repr__</code> 的设计目标是让对象的字符串表示能够作为一种明确、无歧义的代码表达式，最好能够让开发者通过 <code>eval()</code> 来重新构建该对象。例如，<code>__repr__</code> 返回的字符串应该是：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MyClass(<span class="string">'Bob'</span>, <span class="number">25</span>)</span><br></pre></td></tr></tbody></table></figure><p>如果你运行 <code>eval("MyClass('Bob', 25)")</code>，它应该能够重新创建出一个与 <code>obj</code> 相同的 <code>MyClass</code> 实例。</p></li></ol><hr><h5 id="3-集合类操作"><a href="#3-集合类操作" class="headerlink" title="3. 集合类操作"></a>3. 集合类操作</h5><table><thead><tr><th>方法名</th><th>描述</th><th>触发方式</th><th>使用场景</th></tr></thead><tbody><tr><td><code>__len__(self)</code></td><td>获取对象长度</td><td><code>len(obj)</code></td><td>自定义集合的大小</td></tr><tr><td><code>__getitem__(self, key)</code></td><td>索引访问</td><td><code>obj[key]</code></td><td>使对象可通过索引或键访问</td></tr><tr><td><code>__setitem__(self, key, value)</code></td><td>索引赋值</td><td><code>obj[key] = value</code></td><td>允许通过索引设置值</td></tr><tr><td><code>__delitem__(self, key)</code></td><td>删除索引项</td><td><code>del obj[key]</code></td><td>允许通过索引删除项</td></tr><tr><td><code>__iter__(self)</code></td><td>返回迭代器</td><td><code>for x in obj</code></td><td>使对象可迭代</td></tr><tr><td><code>__next__(self)</code></td><td>返回下一个值</td><td><code>next(obj)</code></td><td>实现迭代器协议</td></tr><tr><td><code>__contains__(self, item)</code></td><td>成员检查</td><td><code>item in obj</code></td><td>自定义成员检查逻辑</td></tr></tbody></table><h6 id="实际应用场景：自定义商品购物车"><a href="#实际应用场景：自定义商品购物车" class="headerlink" title="实际应用场景：自定义商品购物车"></a>实际应用场景：自定义商品购物车</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Product</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, <span class="built_in">id</span>, name, price</span>):</span><br><span class="line">        <span class="variable language_">self</span>.<span class="built_in">id</span> = <span class="built_in">id</span></span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.price = price</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""返回用户友好的描述"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"<span class="subst">{self.name}</span> (¥<span class="subst">{self.price:<span class="number">.2</span>f}</span>)"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""返回可重新创建此对象的代码"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"Product(id=<span class="subst">{self.<span class="built_in">id</span>!r}</span>, name=<span class="subst">{self.name!r}</span>, price=<span class="subst">{self.price!r}</span>)"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShoppingCart</span>:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    购物车类：管理用户选择的商品及其数量</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""初始化空购物车"""</span></span><br><span class="line">        <span class="variable language_">self</span>.items = {}  <span class="comment"># 商品ID -&gt; (商品, 数量)的映射</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_item</span>(<span class="params">self, product, quantity=<span class="number">1</span></span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        增加商品到购物车</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        参数:</span></span><br><span class="line"><span class="string">            product (Product): 要添加的商品</span></span><br><span class="line"><span class="string">            quantity (int): 添加的数量，默认为1</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> product.<span class="built_in">id</span> <span class="keyword">in</span> <span class="variable language_">self</span>.items:</span><br><span class="line">            <span class="comment"># 如果商品已经在购物车中，更新数量</span></span><br><span class="line">            <span class="variable language_">self</span>.items[product.<span class="built_in">id</span>] = (product, <span class="variable language_">self</span>.items[product.<span class="built_in">id</span>][<span class="number">1</span>] + quantity)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 如果商品不在购物车中，直接添加</span></span><br><span class="line">            <span class="variable language_">self</span>.items[product.<span class="built_in">id</span>] = (product, quantity)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, product_id</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        支持通过索引访问: cart[product_id]</span></span><br><span class="line"><span class="string">        返回商品和数量的元组</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> product_id <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.items:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">f"商品ID <span class="subst">{product_id}</span> 不在购物车中"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.items[product_id]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setitem__</span>(<span class="params">self, product_id, quantity</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        支持通过索引设置数量: cart[product_id] = quantity</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> product_id <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.items:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">f"商品ID <span class="subst">{product_id}</span> 不在购物车中"</span>)</span><br><span class="line">        product = <span class="variable language_">self</span>.items[product_id][<span class="number">0</span>]</span><br><span class="line">        <span class="variable language_">self</span>.items[product_id] = (product, quantity)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__delitem__</span>(<span class="params">self, product_id</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        支持通过del删除商品: del cart[product_id]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> product_id <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.items:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">f"商品ID <span class="subst">{product_id}</span> 不在购物车中"</span>)</span><br><span class="line">        <span class="keyword">del</span> <span class="variable language_">self</span>.items[product_id]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""返回购物车中的商品种类数量"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.items)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""使购物车可迭代，返回商品和数量"""</span></span><br><span class="line">        <span class="keyword">for</span> product_id <span class="keyword">in</span> <span class="variable language_">self</span>.items:</span><br><span class="line">            <span class="keyword">yield</span> <span class="variable language_">self</span>.items[product_id]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__contains__</span>(<span class="params">self, product_id</span>):</span><br><span class="line">        <span class="string">"""支持成员检查: product_id in cart"""</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"__contains__被调用"</span>)</span><br><span class="line">        <span class="keyword">return</span> product_id <span class="keyword">in</span> <span class="variable language_">self</span>.items</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">total_price</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""计算购物车中所有商品的总价"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(product.price * quantity <span class="keyword">for</span> product, quantity <span class="keyword">in</span> <span class="variable language_">self</span>.items.values())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""用户友好的购物车展示"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.items:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"购物车为空"</span></span><br><span class="line"></span><br><span class="line">        cart_str = <span class="string">"购物车内容:\n"</span></span><br><span class="line">        <span class="keyword">for</span> product, quantity <span class="keyword">in</span> <span class="variable language_">self</span>.items.values():</span><br><span class="line">            cart_str += <span class="string">f"  <span class="subst">{product.name}</span> x <span class="subst">{quantity}</span>: ¥<span class="subst">{product.price * quantity:<span class="number">.2</span>f}</span>\n"</span></span><br><span class="line">        cart_str += <span class="string">f"总计: ¥<span class="subst">{self.total_price():<span class="number">.2</span>f}</span>"</span></span><br><span class="line">        <span class="keyword">return</span> cart_str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 测试代码 =====</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"===== 创建商品 ====="</span>)</span><br><span class="line">apple = Product(<span class="number">1</span>, <span class="string">"苹果"</span>, <span class="number">5.99</span>)</span><br><span class="line">banana = Product(<span class="number">2</span>, <span class="string">"香蕉"</span>, <span class="number">3.50</span>)</span><br><span class="line">orange = Product(<span class="number">3</span>, <span class="string">"橙子"</span>, <span class="number">4.25</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"商品1: <span class="subst">{apple}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"商品2: <span class="subst">{banana}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"商品3: <span class="subst">{orange}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"商品repr: <span class="subst">{<span class="built_in">repr</span>(apple)}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n===== 购物车基本操作 ====="</span>)</span><br><span class="line">cart = ShoppingCart()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"空购物车:"</span>, cart)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加商品测试</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n添加商品:"</span>)</span><br><span class="line">cart.add_item(apple, <span class="number">3</span>)</span><br><span class="line">cart.add_item(banana, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(cart)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加已有商品测试</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n添加已有商品:"</span>)</span><br><span class="line">cart.add_item(apple, <span class="number">2</span>)  <span class="comment"># 现在应该有5个苹果</span></span><br><span class="line"><span class="built_in">print</span>(cart)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过索引访问测试</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n通过索引访问:"</span>)</span><br><span class="line">apple_info = cart[<span class="number">1</span>]  <span class="comment"># 获取ID为1的商品信息</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"ID为1的商品信息: <span class="subst">{apple_info[<span class="number">0</span>].name}</span>, 数量: <span class="subst">{apple_info[<span class="number">1</span>]}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过索引修改数量测试</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n通过索引修改数量:"</span>)</span><br><span class="line">cart[<span class="number">2</span>] = <span class="number">4</span>  <span class="comment"># 将香蕉的数量改为4</span></span><br><span class="line"><span class="built_in">print</span>(cart)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除商品测试</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n删除商品:"</span>)</span><br><span class="line"><span class="keyword">del</span> cart[<span class="number">1</span>]  <span class="comment"># 删除苹果</span></span><br><span class="line"><span class="built_in">print</span>(cart)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 长度测试</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n购物车商品种类:"</span>, <span class="built_in">len</span>(cart))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 迭代购物车测试</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n迭代购物车中的商品:"</span>)</span><br><span class="line"><span class="keyword">for</span> product, quantity <span class="keyword">in</span> cart:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  <span class="subst">{product.name}</span>: <span class="subst">{quantity}</span>个"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 成员检查测试</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n成员检查:"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"香蕉在购物车中? <span class="subst">{<span class="number">2</span> <span class="keyword">in</span> cart}</span>"</span>)  <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"苹果在购物车中? <span class="subst">{<span class="number">1</span> <span class="keyword">in</span> cart}</span>"</span>)  <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"橙子在购物车中? <span class="subst">{<span class="number">3</span> <span class="keyword">in</span> cart}</span>"</span>)  <span class="comment"># False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加新商品测试</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n添加新商品:"</span>)</span><br><span class="line">cart.add_item(orange, <span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(cart)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算总价测试</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n购物车总价: ¥{:.2f}"</span>.<span class="built_in">format</span>(cart.total_price()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 错误处理测试</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n===== 错误处理测试 ====="</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cart[<span class="number">4</span>]  <span class="comment"># 尝试访问不存在的商品</span></span><br><span class="line"><span class="keyword">except</span> KeyError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"预期的错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="4-调用与比较操作"><a href="#4-调用与比较操作" class="headerlink" title="4. 调用与比较操作"></a>4. 调用与比较操作</h5><p>我们这里主要讲 <code>__call__</code> 这个方法，有利于我们理解为什么 <code>__new__</code> 方法可以在对象实例化的时候调用</p><p>当我们调用一个对象，也就相当于 ↓</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"__call__ 被调用了"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.name, <span class="variable language_">self</span>.age</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = Person(<span class="string">"张三"</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(p()) <span class="comment"># __call__ 被调用了    ('张三', 20)</span></span><br></pre></td></tr></tbody></table></figure><p>那么 Python 就会自动调用 obj 中的 <code>__call__</code> 方法，同样的，<code>__call__</code> 内的返回值也会传递给 obj</p><p>那么也就是说，如果想把一个对象变成一个可以加括号调用的对象，就在对象的类里面增添一个 <code>__call__</code> 方法</p><table><thead><tr><th>方法名</th><th>描述</th><th>触发方式</th><th>使用场景</th></tr></thead><tbody><tr><td><code>__call__(self, ...)</code></td><td>使对象可调用</td><td><code>obj()</code></td><td>创建可调用对象，函数式编程</td></tr><tr><td><code>__eq__(self, other)</code></td><td>相等比较</td><td><code>obj1 == obj2</code></td><td>自定义对象相等性</td></tr><tr><td><code>__lt__(self, other)</code></td><td>小于比较</td><td><code>obj1 &lt; obj2</code></td><td>自定义对象排序</td></tr><tr><td><code>__gt__(self, other)</code></td><td>大于比较</td><td><code>obj1 &gt; obj2</code></td><td>自定义对象排序</td></tr><tr><td><code>__le__(self, other)</code></td><td>小于等于</td><td><code>obj1 &lt;= obj2</code></td><td>自定义对象排序</td></tr><tr><td><code>__ge__(self, other)</code></td><td>大于等于</td><td><code>obj1 &gt;= obj2</code></td><td>自定义对象排序</td></tr><tr><td><code>__hash__(self)</code></td><td>计算哈希值</td><td><code>hash(obj)</code></td><td>允许对象作为字典键或集合元素</td></tr></tbody></table><h5 id="实际应用场景：数据分析器"><a href="#实际应用场景：数据分析器" class="headerlink" title="实际应用场景：数据分析器"></a>实际应用场景：数据分析器</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataAnalyzer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.data = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_data</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="comment"># 添加数据点</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"数据必须是数字类型"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.data.append(value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, new_data=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># 调用对象时可以添加新数据并返回分析结果</span></span><br><span class="line">        <span class="keyword">if</span> new_data <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(new_data, <span class="built_in">list</span>):</span><br><span class="line">                <span class="keyword">for</span> value <span class="keyword">in</span> new_data:</span><br><span class="line">                    <span class="variable language_">self</span>.add_data(value)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>.add_data(new_data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.data:</span><br><span class="line">            <span class="keyword">return</span> {<span class="string">"count"</span>: <span class="number">0</span>, <span class="string">"sum"</span>: <span class="number">0</span>, <span class="string">"avg"</span>: <span class="number">0</span>, <span class="string">"min"</span>: <span class="literal">None</span>, <span class="string">"max"</span>: <span class="literal">None</span>}</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> {</span><br><span class="line">            <span class="string">"count"</span>: <span class="built_in">len</span>(<span class="variable language_">self</span>.data),</span><br><span class="line">            <span class="string">"sum"</span>: <span class="built_in">sum</span>(<span class="variable language_">self</span>.data),</span><br><span class="line">            <span class="string">"avg"</span>: <span class="built_in">sum</span>(<span class="variable language_">self</span>.data) / <span class="built_in">len</span>(<span class="variable language_">self</span>.data),</span><br><span class="line">            <span class="string">"min"</span>: <span class="built_in">min</span>(<span class="variable language_">self</span>.data),</span><br><span class="line">            <span class="string">"max"</span>: <span class="built_in">max</span>(<span class="variable language_">self</span>.data)</span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="comment"># 比较两个分析器的数据是否相同</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(other, DataAnalyzer):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.data == other.data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__lt__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="comment"># 根据数据平均值比较分析器</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(other, DataAnalyzer):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"只能与另一个DataAnalyzer比较"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.data <span class="keyword">or</span> <span class="keyword">not</span> other.data:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"无法比较空数据集"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(<span class="variable language_">self</span>.data)/<span class="built_in">len</span>(<span class="variable language_">self</span>.data) &lt; <span class="built_in">sum</span>(other.data)/<span class="built_in">len</span>(other.data)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__hash__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 允许对象作为字典键，基于名称和数据的散列</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>((<span class="variable language_">self</span>.name, <span class="built_in">tuple</span>(<span class="variable language_">self</span>.data)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">analyzer1 = DataAnalyzer(<span class="string">"温度分析器"</span>)</span><br><span class="line">analyzer1.add_data(<span class="number">22.5</span>)</span><br><span class="line">analyzer1.add_data(<span class="number">23.1</span>)</span><br><span class="line">analyzer1.add_data(<span class="number">21.8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过调用对象获取分析结果</span></span><br><span class="line"><span class="built_in">print</span>(analyzer1())  <span class="comment"># 输出分析结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数式用法 - 添加新数据并获取结果</span></span><br><span class="line">result = analyzer1([<span class="number">24.2</span>, <span class="number">22.9</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"更新后的分析结果: <span class="subst">{result}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建另一个分析器用于比较</span></span><br><span class="line">analyzer2 = DataAnalyzer(<span class="string">"湿度分析器"</span>)</span><br><span class="line">analyzer2([<span class="number">45</span>, <span class="number">48</span>, <span class="number">51</span>, <span class="number">47</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 比较分析器</span></span><br><span class="line"><span class="keyword">if</span> analyzer1 &lt; analyzer2:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{analyzer1.name}</span>的平均值低于<span class="subst">{analyzer2.name}</span>"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{analyzer1.name}</span>的平均值高于或等于<span class="subst">{analyzer2.name}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用分析器作为字典键</span></span><br><span class="line">analyzers = {</span><br><span class="line">    analyzer1: <span class="string">"温度数据"</span>,</span><br><span class="line">    analyzer2: <span class="string">"湿度数据"</span></span><br><span class="line">}</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"字典中的分析器: <span class="subst">{<span class="built_in">list</span>(analyzers.values())}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="5-算术运算操作"><a href="#5-算术运算操作" class="headerlink" title="5. 算术运算操作"></a>5. 算术运算操作</h5><p>在我们通过内置的运算符需要频繁实现一些非常规四则运算时，可以重写四则运算方法，通过这样来快速的进行数学运算分析</p><table><thead><tr><th>方法名</th><th>描述</th><th>触发方式</th><th>使用场景</th></tr></thead><tbody><tr><td><code>__add__(self, other)</code></td><td>加法</td><td><code>obj1 + obj2</code></td><td>自定义对象相加</td></tr><tr><td><code>__sub__(self, other)</code></td><td>减法</td><td><code>obj1 - obj2</code></td><td>自定义对象相减</td></tr><tr><td><code>__mul__(self, other)</code></td><td>乘法</td><td><code>obj1 * obj2</code></td><td>自定义对象相乘</td></tr><tr><td><code>__truediv__(self, other)</code></td><td>除法</td><td><code>obj1 / obj2</code></td><td>自定义对象相除</td></tr></tbody></table><h6 id="实际应用场景：向量运算"><a href="#实际应用场景：向量运算" class="headerlink" title="实际应用场景：向量运算"></a>实际应用场景：向量运算</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Vector2D</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x=<span class="number">0</span>, y=<span class="number">0</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.x = x</span><br><span class="line">        <span class="variable language_">self</span>.y = y</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__add__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="comment"># 向量加法</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, Vector2D):</span><br><span class="line">            <span class="keyword">return</span> Vector2D(<span class="variable language_">self</span>.x + other.x, <span class="variable language_">self</span>.y + other.y)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(other, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">            <span class="comment"># 支持向量与标量相加</span></span><br><span class="line">            <span class="keyword">return</span> Vector2D(<span class="variable language_">self</span>.x + other, <span class="variable language_">self</span>.y + other)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"不支持的操作数类型"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__sub__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="comment"># 向量减法</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, Vector2D):</span><br><span class="line">            <span class="keyword">return</span> Vector2D(<span class="variable language_">self</span>.x - other.x, <span class="variable language_">self</span>.y - other.y)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(other, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">            <span class="keyword">return</span> Vector2D(<span class="variable language_">self</span>.x - other, <span class="variable language_">self</span>.y - other)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"不支持的操作数类型"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__mul__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="comment"># 向量乘法(点积或标量乘法)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, Vector2D):</span><br><span class="line">            <span class="comment"># 向量点积</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.x * other.x + <span class="variable language_">self</span>.y * other.y</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(other, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">            <span class="comment"># 向量与标量相乘</span></span><br><span class="line">            <span class="keyword">return</span> Vector2D(<span class="variable language_">self</span>.x * other, <span class="variable language_">self</span>.y * other)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"不支持的操作数类型"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__truediv__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="comment"># 向量除法(仅支持标量除法)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">            <span class="keyword">if</span> other == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> ZeroDivisionError(<span class="string">"除数不能为零"</span>)</span><br><span class="line">            <span class="keyword">return</span> Vector2D(<span class="variable language_">self</span>.x / other, <span class="variable language_">self</span>.y / other)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"向量只能被标量除"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">magnitude</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 向量长度</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="variable language_">self</span>.x ** <span class="number">2</span> + <span class="variable language_">self</span>.y ** <span class="number">2</span>) ** <span class="number">0.5</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">normalize</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 单位向量</span></span><br><span class="line">        mag = <span class="variable language_">self</span>.magnitude()</span><br><span class="line">        <span class="keyword">if</span> mag == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> Vector2D(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span> / mag</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"Vector2D(<span class="subst">{self.x}</span>, <span class="subst">{self.y}</span>)"</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"Vector2D(x=<span class="subst">{self.x}</span>, y=<span class="subst">{self.y}</span>)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">v1 = Vector2D(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">v2 = Vector2D(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 向量加法</span></span><br><span class="line">v3 = v1 + v2</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"v1 + v2 = <span class="subst">{v3}</span>"</span>)  <span class="comment"># Vector2D(4, 6)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 向量减法</span></span><br><span class="line">v4 = v1 - v2</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"v1 - v2 = <span class="subst">{v4}</span>"</span>)  <span class="comment"># Vector2D(2, 2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 向量点积</span></span><br><span class="line">dot_product = v1 * v2</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"v1 · v2 = <span class="subst">{dot_product}</span>"</span>)  <span class="comment"># 11</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 向量缩放</span></span><br><span class="line">v5 = v1 * <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"v1 * 2 = <span class="subst">{v5}</span>"</span>)  <span class="comment"># Vector2D(6, 8)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 向量除法</span></span><br><span class="line">v6 = v1 / <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"v1 / 2 = <span class="subst">{v6}</span>"</span>)  <span class="comment"># Vector2D(1.5, 2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 向量长度和归一化</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"v1的长度: <span class="subst">{v1.magnitude()}</span>"</span>)  <span class="comment"># 5.0</span></span><br><span class="line">v7 = v1.normalize()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"v1的单位向量: <span class="subst">{v7}</span>"</span>)  <span class="comment"># Vector2D(0.6, 0.8)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"单位向量的长度: <span class="subst">{v7.magnitude()}</span>"</span>)  <span class="comment"># 1.0</span></span><br></pre></td></tr></tbody></table></figure><h5 id="6-属性访问控制"><a href="#6-属性访问控制" class="headerlink" title="6. 属性访问控制"></a>6. 属性访问控制</h5><table><thead><tr><th>方法名</th><th>描述</th><th>触发方式</th><th>使用场景</th></tr></thead><tbody><tr><td><code>__getattr__(self, name)</code></td><td>获取不存在的属性</td><td><code>obj.name</code> (name 不存在)</td><td>处理不存在的属性访问</td></tr><tr><td><code>__setattr__(self, name, value)</code></td><td>设置属性</td><td><code>obj.name = value</code></td><td>拦截所有属性赋值</td></tr><tr><td><code>__delattr__(self, name)</code></td><td>删除属性</td><td><code>del obj.name</code></td><td>拦截属性删除</td></tr></tbody></table><h6 id="实际应用场景：属性验证与保护"><a href="#实际应用场景：属性验证与保护" class="headerlink" title="实际应用场景：属性验证与保护"></a>实际应用场景：属性验证与保护</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ProtectedObject</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>._data = {}  <span class="comment"># 存储实际数据</span></span><br><span class="line">        <span class="variable language_">self</span>._protected = [<span class="string">'_data'</span>, <span class="string">'_protected'</span>]  <span class="comment"># 保护的属性列表</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="comment"># 当访问不存在的属性时调用</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> <span class="variable language_">self</span>._data:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._data[name]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 记录未知属性访问并返回None</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"警告: 尝试访问不存在的属性 '<span class="subst">{name}</span>'"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, name, value</span>):</span><br><span class="line">        <span class="comment"># 拦截所有属性赋值</span></span><br><span class="line">        <span class="keyword">if</span> name.startswith(<span class="string">'_'</span>):</span><br><span class="line">            <span class="comment"># 允许设置内部属性</span></span><br><span class="line">            <span class="built_in">super</span>().__setattr__(name, value)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> <span class="variable language_">self</span>._protected:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">f"'<span class="subst">{name}</span>' 是受保护的属性，不能直接赋值"</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 验证并存储数据</span></span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">'age'</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, <span class="built_in">int</span>):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"年龄必须是整数"</span>)</span><br><span class="line">        <span class="keyword">elif</span> name == <span class="string">'age'</span> <span class="keyword">and</span> (value &lt; <span class="number">0</span> <span class="keyword">or</span> value &gt; <span class="number">150</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"年龄必须在0-150之间"</span>)</span><br><span class="line">        <span class="keyword">elif</span> name == <span class="string">'email'</span> <span class="keyword">and</span> <span class="string">'@'</span> <span class="keyword">not</span> <span class="keyword">in</span> value:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"无效的电子邮件格式"</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 存储验证后的数据</span></span><br><span class="line">        <span class="variable language_">self</span>._data[name] = value</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"属性 '<span class="subst">{name}</span>' 设置为 <span class="subst">{value}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__delattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="comment"># 拦截属性删除</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> <span class="variable language_">self</span>._protected:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">f"'<span class="subst">{name}</span>' 是受保护的属性，不能删除"</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> <span class="variable language_">self</span>._data:</span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>._data[name]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"已删除属性 '<span class="subst">{name}</span>'"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">f"'<span class="subst">{name}</span>' 属性不存在，无法删除"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"ProtectedObject(attributes=<span class="subst">{<span class="built_in">list</span>(self._data.keys())}</span>)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">person = ProtectedObject()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置属性(经过验证)</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">    person.age = <span class="number">30</span>  <span class="comment"># 通过验证</span></span><br><span class="line">    person.email = <span class="string">"zhangsan@example.com"</span>  <span class="comment"># 通过验证</span></span><br><span class="line">   </span><br><span class="line">    person.age = <span class="string">"三十"</span>  <span class="comment"># 类型错误</span></span><br><span class="line"><span class="keyword">except</span> (TypeError, ValueError) <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 尝试访问不存在的属性</span></span><br><span class="line"><span class="built_in">print</span>(person.address)  <span class="comment"># 返回None并显示警告</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 尝试删除属性</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">del</span> person.name  <span class="comment"># 正常删除</span></span><br><span class="line">    <span class="keyword">del</span> person._data  <span class="comment"># 尝试删除受保护属性</span></span><br><span class="line"><span class="keyword">except</span> AttributeError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(person)  <span class="comment"># 显示当前属性</span></span><br></pre></td></tr></tbody></table></figure><h5 id="7-上下文管理（with-语句）"><a href="#7-上下文管理（with-语句）" class="headerlink" title="7. 上下文管理（with 语句）"></a>7. 上下文管理（with 语句）</h5><table><thead><tr><th>方法名</th><th>描述</th><th>触发方式</th><th>使用场景</th></tr></thead><tbody><tr><td><code>__enter__(self)</code></td><td>进入上下文</td><td><code>with obj as x:</code></td><td>资源获取，连接建立等</td></tr><tr><td><code>__exit__(self, exc_type, exc_val, exc_tb)</code></td><td>退出上下文</td><td><code>with</code> 块结束</td><td>资源释放，异常处理等</td></tr></tbody></table><h6 id="实际应用场景：数据库连接管理"><a href="#实际应用场景：数据库连接管理" class="headerlink" title="实际应用场景：数据库连接管理"></a>实际应用场景：数据库连接管理</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseConnection</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host, user, password, database</span>):</span><br><span class="line">        <span class="variable language_">self</span>.host = host</span><br><span class="line">        <span class="variable language_">self</span>.user = user</span><br><span class="line">        <span class="variable language_">self</span>.password = password</span><br><span class="line">        <span class="variable language_">self</span>.database = database</span><br><span class="line">        <span class="variable language_">self</span>.connection = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.transaction_active = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 进入上下文时建立连接</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"连接到数据库 <span class="subst">{self.host}</span>/<span class="subst">{self.database}</span>..."</span>)</span><br><span class="line">        <span class="variable language_">self</span>.connection = <span class="string">f"Connection to <span class="subst">{self.host}</span>/<span class="subst">{self.database}</span> as <span class="subst">{self.user}</span>"</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">        <span class="comment"># 退出上下文时处理异常并关闭连接</span></span><br><span class="line">        <span class="keyword">if</span> exc_type <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 发生异常时回滚事务</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.transaction_active:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"发生异常: <span class="subst">{exc_val}</span>，回滚事务"</span>)</span><br><span class="line">                <span class="variable language_">self</span>.rollback()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"异常信息: <span class="subst">{exc_type.__name__}</span>: <span class="subst">{exc_val}</span>"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 没有异常时提交事务</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.transaction_active:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"提交事务"</span>)</span><br><span class="line">                <span class="variable language_">self</span>.commit()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"关闭数据库连接: <span class="subst">{self.host}</span>"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.connection = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 返回False表示不抑制异常，让异常继续传播</span></span><br><span class="line">        <span class="comment"># 返回True表示抑制异常，异常不会传播到with语句之外</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>  <span class="comment"># 不抑制异常</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">begin_transaction</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.connection:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"数据库未连接"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"开始事务"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.transaction_active = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.connection:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"数据库未连接"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"执行SQL: <span class="subst">{sql}</span>"</span>)</span><br><span class="line">        <span class="comment"># 模拟SQL错误</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"ERROR"</span> <span class="keyword">in</span> sql:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"SQL语法错误"</span>)</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"SQL语法错误"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"执行结果: <span class="subst">{sql}</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">commit</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.connection:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"数据库未连接"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"提交事务"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.transaction_active = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rollback</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.connection:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"数据库未连接"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"回滚事务"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.transaction_active = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例 - 正常情况</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"=== 正常执行 ==="</span>)</span><br><span class="line"><span class="keyword">with</span> DatabaseConnection(<span class="string">"localhost"</span>, <span class="string">"admin"</span>, <span class="string">"password"</span>, <span class="string">"mydb"</span>) <span class="keyword">as</span> db:</span><br><span class="line">    db.begin_transaction()</span><br><span class="line">    db.execute(<span class="string">"SELECT * FROM users"</span>)</span><br><span class="line">    db.execute(<span class="string">"UPDATE users SET active = TRUE"</span>)</span><br><span class="line">    <span class="comment"># 自动提交事务并关闭连接</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例 - 异常情况</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n=== 有异常情况 ==="</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> DatabaseConnection(<span class="string">"localhost"</span>, <span class="string">"admin"</span>, <span class="string">"password"</span>, <span class="string">"mydb"</span>) <span class="keyword">as</span> db:</span><br><span class="line">        db.begin_transaction()</span><br><span class="line">        db.execute(<span class="string">"SELECT * FROM users"</span>)</span><br><span class="line">        db.execute(<span class="string">"UPDATE users SET ERROR = TRUE"</span>)  <span class="comment"># 这会触发异常</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"这一行不会执行"</span>)  <span class="comment"># 由于异常，这行不会执行</span></span><br><span class="line"><span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"捕获到异常: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="8-描述符与属性装饰器"><a href="#8-描述符与属性装饰器" class="headerlink" title="8. 描述符与属性装饰器"></a>8. 描述符与属性装饰器</h5><h6 id="描述符协议方法"><a href="#描述符协议方法" class="headerlink" title="描述符协议方法"></a>描述符协议方法</h6><table><thead><tr><th>方法</th><th>描述</th><th>触发条件</th><th>使用场景</th></tr></thead><tbody><tr><td><code>__get__(self, instance, owner)</code></td><td>获取属性值</td><td>访问属性时触发</td><td>自定义属性访问行为</td></tr><tr><td><code>__set__(self, instance, value)</code></td><td>设置属性值</td><td>属性赋值时触发</td><td>验证或转换属性值</td></tr><tr><td><code>__delete__(self, instance)</code></td><td>删除属性</td><td>删除属性时触发</td><td>自定义属性删除行为</td></tr></tbody></table><h6 id="实际应用场景：数据验证描述符"><a href="#实际应用场景：数据验证描述符" class="headerlink" title="实际应用场景：数据验证描述符"></a>实际应用场景：数据验证描述符</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    name = StringValidator(min_length=<span class="number">2</span>, max_length=<span class="number">50</span>)</span><br><span class="line">    age = NumberValidator(min_value=<span class="number">0</span>, max_value=<span class="number">150</span>, type_=<span class="built_in">int</span>)</span><br><span class="line">    email = StringValidator(pattern=<span class="string">r'^[\w.-]+@[\w.-]+\.\w+$'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age, email</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line">        <span class="variable language_">self</span>.email = email</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"Person(name='<span class="subst">{self.name}</span>', age=<span class="subst">{self.age}</span>, email='<span class="subst">{self.email}</span>')"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 创建有效的Person对象</span></span><br><span class="line">    p1 = Person(<span class="string">"张三"</span>, <span class="number">30</span>, <span class="string">"zhangsan@example.com"</span>)</span><br><span class="line">    <span class="built_in">print</span>(p1)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 尝试设置无效的值</span></span><br><span class="line">    p1.name = <span class="string">"李"</span>  <span class="comment"># 名字太短</span></span><br><span class="line"><span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"验证错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    p1.age = <span class="string">"三十"</span>  <span class="comment"># 类型错误</span></span><br><span class="line"><span class="keyword">except</span> TypeError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"类型错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    p1.email = <span class="string">"invalid-email"</span>  <span class="comment"># 无效的邮箱格式</span></span><br><span class="line"><span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"验证错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置有效值</span></span><br><span class="line">p1.name = <span class="string">"李四"</span></span><br><span class="line">p1.age = <span class="number">25</span></span><br><span class="line">p1.email = <span class="string">"lisi@example.com"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"更新后: <span class="subst">{p1}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="属性装饰器-property-实际应用"><a href="#属性装饰器-property-实际应用" class="headerlink" title="属性装饰器(@property)实际应用"></a>属性装饰器(@property)实际应用</h6><p>属性装饰器是 Python 中实现属性的更简洁方式，它允许我们用方法行为来定义属性。以下是一个成绩管理系统的示例：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, student_id</span>):</span><br><span class="line">        <span class="variable language_">self</span>._name = name</span><br><span class="line">        <span class="variable language_">self</span>._student_id = student_id</span><br><span class="line">        <span class="variable language_">self</span>._scores = {}  <span class="comment"># 课程 -&gt; 分数的映射</span></span><br><span class="line">        <span class="variable language_">self</span>._attendance = {}  <span class="comment"># 日期 -&gt; 出勤状态的映射</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">name</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""学生姓名，只读属性"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._name</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">student_id</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""学生ID，只读属性"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._student_id</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">scores</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""获取成绩副本，防止外部直接修改"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._scores.copy()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_score</span>(<span class="params">self, course, score</span>):</span><br><span class="line">        <span class="string">"""添加或更新课程成绩"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(score, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"成绩必须是数字"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">0</span> &lt;= score &lt;= <span class="number">100</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"成绩必须在0到100之间"</span>)</span><br><span class="line">        <span class="variable language_">self</span>._scores[course] = score</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">average_score</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""计算平均成绩"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._scores:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(<span class="variable language_">self</span>._scores.values()) / <span class="built_in">len</span>(<span class="variable language_">self</span>._scores)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">grade_point</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""计算绩点(GPA)"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._scores:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 成绩到绩点的映射</span></span><br><span class="line">        grade_map = {</span><br><span class="line">            <span class="string">'A'</span>: <span class="number">4.0</span>,  <span class="comment"># 90-100</span></span><br><span class="line">            <span class="string">'B'</span>: <span class="number">3.0</span>,  <span class="comment"># 80-89</span></span><br><span class="line">            <span class="string">'C'</span>: <span class="number">2.0</span>,  <span class="comment"># 70-79</span></span><br><span class="line">            <span class="string">'D'</span>: <span class="number">1.0</span>,  <span class="comment"># 60-69</span></span><br><span class="line">            <span class="string">'F'</span>: <span class="number">0.0</span>   <span class="comment"># 0-59</span></span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算每门课的绩点</span></span><br><span class="line">        points = []</span><br><span class="line">        <span class="keyword">for</span> score <span class="keyword">in</span> <span class="variable language_">self</span>._scores.values():</span><br><span class="line">            <span class="keyword">if</span> score &gt;= <span class="number">90</span>:</span><br><span class="line">                points.append(grade_map[<span class="string">'A'</span>])</span><br><span class="line">            <span class="keyword">elif</span> score &gt;= <span class="number">80</span>:</span><br><span class="line">                points.append(grade_map[<span class="string">'B'</span>])</span><br><span class="line">            <span class="keyword">elif</span> score &gt;= <span class="number">70</span>:</span><br><span class="line">                points.append(grade_map[<span class="string">'C'</span>])</span><br><span class="line">            <span class="keyword">elif</span> score &gt;= <span class="number">60</span>:</span><br><span class="line">                points.append(grade_map[<span class="string">'D'</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                points.append(grade_map[<span class="string">'F'</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(points) / <span class="built_in">len</span>(points)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_attendance</span>(<span class="params">self, date, status</span>):</span><br><span class="line">        <span class="string">"""记录出勤状态"""</span></span><br><span class="line">        <span class="keyword">if</span> status <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">'present'</span>, <span class="string">'absent'</span>, <span class="string">'late'</span>]:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"出勤状态必须是 'present', 'absent' 或 'late'"</span>)</span><br><span class="line">        <span class="variable language_">self</span>._attendance[date] = status</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">attendance_rate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""计算出勤率"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._attendance:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1.0</span>  <span class="comment"># 默认100%</span></span><br><span class="line">            </span><br><span class="line">        present_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> status <span class="keyword">in</span> <span class="variable language_">self</span>._attendance.values() <span class="keyword">if</span> status == <span class="string">'present'</span>)</span><br><span class="line">        late_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> status <span class="keyword">in</span> <span class="variable language_">self</span>._attendance.values() <span class="keyword">if</span> status == <span class="string">'late'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 迟到计为0.5次出勤</span></span><br><span class="line">        <span class="keyword">return</span> (present_count + <span class="number">0.5</span> * late_count) / <span class="built_in">len</span>(<span class="variable language_">self</span>._attendance)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"学生: <span class="subst">{self._name}</span> (ID: <span class="subst">{self._student_id}</span>), 平均分: <span class="subst">{self.average_score:<span class="number">.1</span>f}</span>, GPA: <span class="subst">{self.grade_point:<span class="number">.2</span>f}</span>"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">student = Student(<span class="string">"王小明"</span>, <span class="string">"S12345"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加课程成绩</span></span><br><span class="line">student.add_score(<span class="string">"数学"</span>, <span class="number">92</span>)</span><br><span class="line">student.add_score(<span class="string">"物理"</span>, <span class="number">85</span>)</span><br><span class="line">student.add_score(<span class="string">"化学"</span>, <span class="number">78</span>)</span><br><span class="line">student.add_score(<span class="string">"语文"</span>, <span class="number">88</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录出勤</span></span><br><span class="line">student.record_attendance(<span class="string">"2025-04-01"</span>, <span class="string">"present"</span>)</span><br><span class="line">student.record_attendance(<span class="string">"2025-04-02"</span>, <span class="string">"present"</span>)</span><br><span class="line">student.record_attendance(<span class="string">"2025-04-03"</span>, <span class="string">"late"</span>)</span><br><span class="line">student.record_attendance(<span class="string">"2025-04-04"</span>, <span class="string">"absent"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问属性</span></span><br><span class="line"><span class="built_in">print</span>(student)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"学生姓名: <span class="subst">{student.name}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"学生ID: <span class="subst">{student.student_id}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"课程成绩: <span class="subst">{student.scores}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"平均分: <span class="subst">{student.average_score:<span class="number">.1</span>f}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"GPA: <span class="subst">{student.grade_point:<span class="number">.2</span>f}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"出勤率: <span class="subst">{student.attendance_rate:<span class="number">.1</span>%}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 尝试修改只读属性</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    student.name = <span class="string">"张三"</span>  <span class="comment"># 这会失败，因为name是只读属性</span></span><br><span class="line"><span class="keyword">except</span> AttributeError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有课程及分数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n所有课程成绩:"</span>)</span><br><span class="line"><span class="keyword">for</span> course, score <span class="keyword">in</span> student.scores.items():</span><br><span class="line">    grade = <span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> score &gt;= <span class="number">90</span>: grade = <span class="string">"A"</span></span><br><span class="line">    <span class="keyword">elif</span> score &gt;= <span class="number">80</span>: grade = <span class="string">"B"</span></span><br><span class="line">    <span class="keyword">elif</span> score &gt;= <span class="number">70</span>: grade = <span class="string">"C"</span></span><br><span class="line">    <span class="keyword">elif</span> score &gt;= <span class="number">60</span>: grade = <span class="string">"D"</span></span><br><span class="line">    <span class="keyword">else</span>: grade = <span class="string">"F"</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  <span class="subst">{course}</span>: <span class="subst">{score}</span> (<span class="subst">{grade}</span>)"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="10-常见特殊方法使用陷阱与最佳实践"><a href="#10-常见特殊方法使用陷阱与最佳实践" class="headerlink" title="10. 常见特殊方法使用陷阱与最佳实践"></a>10. 常见特殊方法使用陷阱与最佳实践</h5><h6 id="陷阱与注意事项"><a href="#陷阱与注意事项" class="headerlink" title="陷阱与注意事项"></a>陷阱与注意事项</h6><ol><li><strong><code>__init__</code> vs <code>__new__</code></strong>：<ul><li><strong>陷阱</strong>：混淆这两个方法的用途和调用顺序。</li><li><strong>最佳实践</strong>：除非实现元类或单例模式，一般只需重写 <code>__init__</code>。</li></ul></li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 错误示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BadVector</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        <span class="variable language_">self</span>.x = x</span><br><span class="line">        <span class="variable language_">self</span>.y = y</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__add__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="comment"># 错误：返回元组而非同类型的对象</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="variable language_">self</span>.x + other.x, <span class="variable language_">self</span>.y + other.y)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正确示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GoodVector</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        <span class="variable language_">self</span>.x = x</span><br><span class="line">        <span class="variable language_">self</span>.y = y</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__add__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="comment"># 正确：返回同类型对象</span></span><br><span class="line">        <span class="keyword">return</span> GoodVector(<span class="variable language_">self</span>.x + other.x, <span class="variable language_">self</span>.y + other.y)</span><br></pre></td></tr></tbody></table></figure><ol start="3"><li><strong><code>__eq__</code> 和 <code>__hash__</code></strong>：<ul><li><strong>陷阱</strong>：实现 <code>__eq__</code> 而不实现 <code>__hash__</code>，导致对象无法用作字典键。</li><li><strong>最佳实践</strong>：如果重写 <code>__eq__</code>，也应该重写 <code>__hash__</code> 或设置 <code>__hash__ = None</code> 使对象不可哈希。</li></ul></li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(other, Person):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.name == other.name <span class="keyword">and</span> <span class="variable language_">self</span>.age == other.age</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果不实现__hash__，对象将不可哈希</span></span><br><span class="line">    <span class="comment"># 选项1：使对象不可哈希</span></span><br><span class="line">    __hash__ = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 选项2：实现兼容的哈希方法</span></span><br><span class="line">    <span class="comment"># def __hash__(self):</span></span><br><span class="line">    <span class="comment">#     return hash((self.name, self.age))</span></span><br></pre></td></tr></tbody></table></figure><ol start="4"><li><strong>递归问题</strong>：<ul><li><strong>陷阱</strong>：在特殊方法中无限递归调用自身。</li><li><strong>最佳实践</strong>：避免在特殊方法中使用可能触发同一方法的操作。</li></ul></li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BadString</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="variable language_">self</span>.value = value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 错误：这会导致无限递归</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"BadString: <span class="subst">{self}</span>"</span>  <span class="comment"># 递归调用__str__</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GoodString</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="variable language_">self</span>.value = value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 正确：使用原始值</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"GoodString: <span class="subst">{self.value}</span>"</span></span><br></pre></td></tr></tbody></table></figure><ol start="5"><li><strong><code>__bool__</code> 和 <code>__len__</code></strong>：<ul><li><strong>陷阱</strong>：不了解这两个方法的优先级和用途。</li><li><strong>最佳实践</strong>：<code>__bool__</code> 优先于 <code>__len__</code>；对于集合类，实现 <code>__len__</code>；对于真假逻辑，实现 <code>__bool__</code>。</li></ul></li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataCollection</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.data = data <span class="keyword">or</span> []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 返回集合长度</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.data)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__bool__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 特殊逻辑：即使长度为0，如果有特定标记也认为是True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(<span class="variable language_">self</span>.data) <span class="keyword">or</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">'special_flag'</span>)</span><br></pre></td></tr></tbody></table></figure><ol start="6"><li><strong>反向方法失效</strong>：<ul><li><strong>陷阱</strong>：忽略实现反向操作方法（如 <code>__radd__</code>）。</li><li><strong>最佳实践</strong>：为算术操作同时实现普通方法和反向方法。</li></ul></li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SafeNumber</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="variable language_">self</span>.value = value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__add__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="comment"># 普通加法: self + other</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">            <span class="keyword">return</span> SafeNumber(<span class="variable language_">self</span>.value + other)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, SafeNumber):</span><br><span class="line">            <span class="keyword">return</span> SafeNumber(<span class="variable language_">self</span>.value + other.value)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NotImplemented</span>  <span class="comment"># 告诉Python尝试反向操作</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__radd__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="comment"># 反向加法: other + self</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">            <span class="keyword">return</span> SafeNumber(other + <span class="variable language_">self</span>.value)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NotImplemented</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"SafeNumber(<span class="subst">{self.value}</span>)"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">num = SafeNumber(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(num + <span class="number">3</span>)       <span class="comment"># SafeNumber + int</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">3</span> + num)       <span class="comment"># int + SafeNumber (触发__radd__)</span></span><br></pre></td></tr></tbody></table></figure><h5 id="11-总结：特殊方法的选择指南"><a href="#11-总结：特殊方法的选择指南" class="headerlink" title="11. 总结：特殊方法的选择指南"></a>11. 总结：特殊方法的选择指南</h5><table><thead><tr><th>需求</th><th>推荐实现的特殊方法</th><th>注意事项</th></tr></thead><tbody><tr><td>初始化和配置对象</td><td><code>__init__</code></td><td>保持简单，仅做必要设置</td></tr><tr><td>自定义对象创建</td><td><code>__new__</code></td><td>谨慎使用，主要用于元类和单例</td></tr><tr><td>字符串表示</td><td><code>__str__</code>, <code>__repr__</code></td><td><code>__repr__</code> 应提供准确代表对象的信息</td></tr><tr><td>集合或容器行为</td><td><code>__len__</code>, <code>__getitem__</code>, <code>__setitem__</code>, <code>__delitem__</code>, <code>__iter__</code></td><td>保持与 Python 内置类型一致的行为</td></tr><tr><td>对象比较和哈希</td><td><code>__eq__</code>, <code>__lt__</code>, <code>__gt__</code>, <code>__hash__</code></td><td>注意 <code>__eq__</code> 和 <code>__hash__</code> 的兼容性</td></tr><tr><td>算术运算</td><td><code>__add__</code>, <code>__sub__</code>, <code>__mul__</code>, 以及对应的反向方法</td><td>对不兼容类型返回 <code>NotImplemented</code></td></tr><tr><td>属性访问控制</td><td><code>__getattr__</code>, <code>__setattr__</code>, <code>__getattribute__</code></td><td>注意避免递归调用</td></tr><tr><td>资源管理</td><td><code>__enter__</code>, <code>__exit__</code></td><td>确保资源正确释放，处理异常</td></tr><tr><td>描述符协议</td><td><code>__get__</code>, <code>__set__</code>, <code>__delete__</code></td><td>用于创建可重用的属性行为</td></tr></tbody></table><h3 id="对象与类的高级概念"><a href="#对象与类的高级概念" class="headerlink" title="对象与类的高级概念"></a>对象与类的高级概念</h3><h4 id="深入理解实例、类和元类关系"><a href="#深入理解实例、类和元类关系" class="headerlink" title="深入理解实例、类和元类关系"></a>深入理解实例、类和元类关系</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一个普通类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="variable language_">self</span>.value = value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">display</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"Value: <span class="subst">{self.value}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建类的实例</span></span><br><span class="line">obj = MyClass(<span class="number">42</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印并验证三个层次的关系</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"=== 三个层次的关系 ==="</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"obj.__class__ is MyClass: <span class="subst">{obj.__class__ <span class="keyword">is</span> MyClass}</span>"</span>)  <span class="comment"># True - 实例的类是MyClass</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"MyClass.__class__ is type: <span class="subst">{MyClass.__class__ <span class="keyword">is</span> <span class="built_in">type</span>}</span>"</span>)  <span class="comment"># True - 类的类是type(元类)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"type.__class__ is type: <span class="subst">{<span class="built_in">type</span>.__class__ <span class="keyword">is</span> <span class="built_in">type</span>}</span>"</span>)  <span class="comment"># True - type是自己的元类</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印并验证继承关系</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n=== 继承关系 ==="</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"issubclass(MyClass, object): <span class="subst">{<span class="built_in">issubclass</span>(MyClass, <span class="built_in">object</span>)}</span>"</span>)  <span class="comment"># True - 所有类都继承自object</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"issubclass(type, object): <span class="subst">{<span class="built_in">issubclass</span>(<span class="built_in">type</span>, <span class="built_in">object</span>)}</span>"</span>)  <span class="comment"># True - type也继承自object</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印并验证元类关系</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n=== 元类关系 ==="</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"type(obj) is MyClass: <span class="subst">{<span class="built_in">type</span>(obj) <span class="keyword">is</span> MyClass}</span>"</span>)  <span class="comment"># True - 实例的类型是MyClass</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"type(MyClass) is type: <span class="subst">{<span class="built_in">type</span>(MyClass) <span class="keyword">is</span> <span class="built_in">type</span>}</span>"</span>)  <span class="comment"># True - 类的类型是type</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"type(type) is type: <span class="subst">{<span class="built_in">type</span>(<span class="built_in">type</span>) <span class="keyword">is</span> <span class="built_in">type</span>}</span>"</span>)  <span class="comment"># True - type的类型也是type</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示类型检查</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n=== 类型检查 ==="</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"isinstance(obj, MyClass): <span class="subst">{<span class="built_in">isinstance</span>(obj, MyClass)}</span>"</span>)  <span class="comment"># True - obj是MyClass的实例</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"isinstance(MyClass, type): <span class="subst">{<span class="built_in">isinstance</span>(MyClass, <span class="built_in">type</span>)}</span>"</span>)  <span class="comment"># True - MyClass是type的实例</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"isinstance(type, type): <span class="subst">{<span class="built_in">isinstance</span>(<span class="built_in">type</span>, <span class="built_in">type</span>)}</span>"</span>)  <span class="comment"># True - type是自己的实例</span></span><br></pre></td></tr></tbody></table></figure><h4 id="属性查找的复杂情况"><a href="#属性查找的复杂情况" class="headerlink" title="属性查找的复杂情况"></a>属性查找的复杂情况</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Mytype</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="string">'''实现自定义元类，并定义元类方法'''</span></span><br><span class="line">    attr = <span class="string">'元类属性'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">meta_method</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"调用元方法 "</span> + cls.__name__</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Parent</span>:</span><br><span class="line">    attr = <span class="string">'父类属性'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parent_method</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"调用父类方法"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Child</span>(Parent, metaclass=Mytype):</span><br><span class="line">    attr = <span class="string">'子类属性'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">child_method</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"调用子类方法"</span></span><br><span class="line"></span><br><span class="line">obj = Child()</span><br><span class="line"><span class="comment">## 对象属性查找:</span></span><br><span class="line"><span class="built_in">print</span>(obj.attr)  <span class="comment"># '子类属性'（首先在实例中查找，然后是类，然后是父类）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 类属性查找:</span></span><br><span class="line"><span class="built_in">print</span>(Child.attr)  <span class="comment"># '子类属性'（首先在类中查找，然后是父类，然后是元类）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 方法查找:</span></span><br><span class="line"><span class="built_in">print</span>(obj.child_method())  <span class="comment"># '调用子类方法'</span></span><br><span class="line"><span class="built_in">print</span>(obj.parent_method())  <span class="comment"># '调用父类方法'（从父类继承）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 元类方法：</span></span><br><span class="line"><span class="built_in">print</span>(Child.meta_method())  <span class="comment"># '调用元方法 Child'（从元类获取）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除子类属性，回退到父类:</span></span><br><span class="line"><span class="keyword">del</span> Child.attr</span><br><span class="line"><span class="built_in">print</span>(Child.attr)  <span class="comment"># '父类属性'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除父类属性，回退到元类:</span></span><br><span class="line"><span class="keyword">del</span> Parent.attr</span><br><span class="line"><span class="built_in">print</span>(Child.attr)  <span class="comment"># '元类属性'</span></span><br></pre></td></tr></tbody></table></figure><h3 id="内存管理与对象生命周期"><a href="#内存管理与对象生命周期" class="headerlink" title="内存管理与对象生命周期"></a>内存管理与对象生命周期</h3><h4 id="对象创建和销毁的完整过程"><a href="#对象创建和销毁的完整过程" class="headerlink" title="对象创建和销毁的完整过程"></a>对象创建和销毁的完整过程</h4><table><thead><tr><th>阶段</th><th>触发方法</th><th>描述</th></tr></thead><tbody><tr><td>创建</td><td><code>__new__</code></td><td>分配内存并创建实例</td></tr><tr><td>初始化</td><td><code>__init__</code></td><td>初始化实例属性</td></tr><tr><td>表示</td><td><code>__repr__</code>, <code>__str__</code></td><td>定义对象的字符串表示</td></tr><tr><td>使用</td><td>各种操作符和方法</td><td>对象的正常使用期</td></tr><tr><td>销毁</td><td><code>__del__</code></td><td>对象不再被引用时的清理</td></tr></tbody></table><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResourceManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"1. __new__: 分配内存"</span>)</span><br><span class="line">        instance = <span class="built_in">super</span>().__new__(cls)</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, value</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"2. __init__: 初始化对象"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.value = value</span><br><span class="line">        <span class="variable language_">self</span>._resource = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"ResourceManager(name='<span class="subst">{self.name}</span>', value=<span class="subst">{self.value}</span>)"</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"Resource '<span class="subst">{self.name}</span>' with value <span class="subst">{self.value}</span>"</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"Acquiring resource: <span class="subst">{self.name}</span>"</span>)</span><br><span class="line">        <span class="variable language_">self</span>._resource = <span class="string">f"RESOURCE_<span class="subst">{self.name}</span>_<span class="subst">{<span class="built_in">id</span>(self)}</span>"</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._resource</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">release</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>._resource:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"Explicitly releasing: <span class="subst">{self._resource}</span>"</span>)</span><br><span class="line">            <span class="variable language_">self</span>._resource = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"3. __del__: 清理 '<span class="subst">{self.name}</span>'"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>._resource:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"Warning: 资源 <span class="subst">{self._resource}</span> 在销毁时仍未释放"</span>)</span><br><span class="line">            <span class="variable language_">self</span>.release()</span><br><span class="line">            </span><br><span class="line"><span class="comment">## 创建和使用对象</span></span><br><span class="line">rm = ResourceManager(<span class="string">"db_connection"</span>, <span class="number">42</span>)</span><br><span class="line"><span class="built_in">print</span>(rm)  <span class="comment"># 调用__str__</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(rm))  <span class="comment"># 调用__repr__</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用资源</span></span><br><span class="line">res = rm.acquire()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"使用资源: <span class="subst">{res}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 两种清理方式:</span></span><br><span class="line"><span class="comment">## 1. 显式释放 (推荐)</span></span><br><span class="line">rm.release()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 2. 依赖垃圾回收 (不推荐)</span></span><br><span class="line"><span class="comment">## rm = None  # 删除引用，触发垃圾回收</span></span><br></pre></td></tr></tbody></table></figure><h4 id="引用计数和循环引用"><a href="#引用计数和循环引用" class="headerlink" title="引用计数和循环引用"></a>引用计数和循环引用</h4><p>Python 的内存管理主要依靠引用计数</p><ul><li>每个对象都有一个引用计数器，记录有多少个引用指向该对象</li><li>当引用计数降为 0 时，对象会被自动销毁，内存被释放</li><li><code>sys.getrefcount()</code> 函数可以查看对象的引用计数</li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.children = []</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"创建节点: <span class="subst">{name}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_child</span>(<span class="params">self, child</span>):</span><br><span class="line">        <span class="variable language_">self</span>.children.append(child)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"删除节点: <span class="subst">{self.name}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建节点</span></span><br><span class="line">node1 = Node(<span class="string">"A"</span>)</span><br><span class="line">node2 = Node(<span class="string">"B"</span>)</span><br><span class="line">node3 = Node(<span class="string">"C"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建循环引用</span></span><br><span class="line">node1.add_child(node2)</span><br><span class="line">node2.add_child(node3)</span><br><span class="line">node3.add_child(node1)  <span class="comment"># 循环引用!</span></span><br><span class="line"><span class="comment">#     +-------+</span></span><br><span class="line"><span class="comment">#     |       v</span></span><br><span class="line"><span class="comment"># node1(A) → node2(B)</span></span><br><span class="line"><span class="comment">#     ^       |</span></span><br><span class="line"><span class="comment">#     |       v</span></span><br><span class="line"><span class="comment">#     +--- node3(C)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建弱引用或保存ID以便后续检查</span></span><br><span class="line"><span class="keyword">import</span> weakref</span><br><span class="line"></span><br><span class="line">node_refs = [weakref.ref(node1), weakref.ref(node2), weakref.ref(node3)]</span><br><span class="line">node_ids = [<span class="built_in">id</span>(node1), <span class="built_in">id</span>(node2), <span class="built_in">id</span>(node3)]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除外部引用</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"删除对节点的外部引用..."</span>)</span><br><span class="line"><span class="keyword">del</span> node1</span><br><span class="line"><span class="keyword">del</span> node2</span><br><span class="line"><span class="keyword">del</span> node3</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"垃圾回收前..."</span>)</span><br><span class="line"><span class="comment"># 检查对象是否还存在</span></span><br><span class="line"><span class="keyword">for</span> i, ref <span class="keyword">in</span> <span class="built_in">enumerate</span>(node_refs):</span><br><span class="line">    obj = ref()</span><br><span class="line">    <span class="keyword">if</span> obj <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"节点<span class="subst">{<span class="built_in">chr</span>(<span class="number">65</span> + i)}</span>仍然存在于内存中"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"手动触发垃圾回收..."</span>)</span><br><span class="line">gc.collect()  <span class="comment"># 强制运行垃圾回收</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"垃圾回收后..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次检查对象是否存在</span></span><br><span class="line"><span class="keyword">for</span> i, ref <span class="keyword">in</span> <span class="built_in">enumerate</span>(node_refs):</span><br><span class="line">    obj = ref()</span><br><span class="line">    <span class="keyword">if</span> obj <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"节点<span class="subst">{<span class="built_in">chr</span>(<span class="number">65</span> + i)}</span>已被回收"</span>) <span class="comment"># 不可能进这个判断，因为存在计数引用和循环引用问题</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="高级常用设计模式"><a href="#高级常用设计模式" class="headerlink" title="高级常用设计模式"></a>高级常用设计模式</h3><h4 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span>:</span><br><span class="line">    _instance = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> cls._instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            cls._instance = <span class="built_in">super</span>().__new__(cls)</span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line">        </span><br><span class="line"><span class="comment">## ======================================或使用元类实现========================================================</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SingletonMeta</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    _instance = {}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> cls._instance: <span class="comment"># 若cls没有实例化过，则新建一个实例</span></span><br><span class="line">            cls._instance[cls] = <span class="built_in">super</span>().__call__(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> cls._instance[cls] <span class="comment"># 返回cls的实例</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Database</span>(metaclass=SingletonMeta):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, connection_string=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> connection_string:</span><br><span class="line">            <span class="variable language_">self</span>.connection_string = connection_string</span><br><span class="line"></span><br><span class="line">db1 = Database(<span class="string">'mysql://user:password@localhost/database'</span>)</span><br><span class="line">db2 = Database(<span class="string">'sqlite:///database.db'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(db1 <span class="keyword">is</span> db2) <span class="comment"># True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## ======================================或使用装饰器实现========================================================</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Singleton</span>(<span class="params">cls</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    单例模式装饰器</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数 cls 是被装饰的类，当使用 @Singleton 语法时，Python 解释器会自动将</span></span><br><span class="line"><span class="string">    被装饰的类作为第一个参数传递给装饰器函数。</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    装饰器工作原理：</span></span><br><span class="line"><span class="string">    1. 当使用 @Singleton 装饰 MyClass 时，Python 实际上执行了 MyClass = Singleton(MyClass)</span></span><br><span class="line"><span class="string">    2. Singleton 函数接收 MyClass 作为 cls 参数</span></span><br><span class="line"><span class="string">    3. Singleton 返回 get_instance 函数，该函数替代了原始的 MyClass</span></span><br><span class="line"><span class="string">    4. 当我们调用 MyClass() 时，实际上调用的是 get_instance()</span></span><br><span class="line"><span class="string">    5. get_instance 函数内部可以访问 cls，因为它是一个闭包，能够访问外部函数的变量</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    _instance = {}  <span class="comment"># 用于存储每个类的单例实例</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_instance</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> _instance:</span><br><span class="line">            <span class="comment"># 如果该类的实例不存在，则创建一个新实例</span></span><br><span class="line">            _instance[cls] = cls(*args, **kwargs)</span><br><span class="line">        <span class="comment"># 返回该类的单例实例</span></span><br><span class="line">        <span class="keyword">return</span> _instance[cls]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> get_instance</span><br><span class="line"></span><br><span class="line"><span class="meta">@Singleton </span><span class="comment"># 这里相当于 MyClass = Singleton(MyClass)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class1 = MyClass(<span class="string">"John"</span>)</span><br><span class="line">class2 = MyClass(<span class="string">"Mary"</span>)</span><br><span class="line"><span class="built_in">print</span>(class1.name)  <span class="comment"># John</span></span><br><span class="line"><span class="built_in">print</span>(class2.name)  <span class="comment"># John</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="懒汉式单例模式的使用场景"><a href="#懒汉式单例模式的使用场景" class="headerlink" title="懒汉式单例模式的使用场景"></a>懒汉式单例模式的使用场景</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># singleton.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.value = <span class="string">"我是单例的"</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">some_method</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.value</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在模块级别创建实例</span></span><br><span class="line">instance = Singleton()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他文件中使用</span></span><br><span class="line"><span class="keyword">from</span> singleton <span class="keyword">import</span> instance</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(instance.some_method())  <span class="comment"># 输出: 我是单例的</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>懒汉式单例模式在以下情况特别适用：</p><ol><li><strong>资源密集型对象</strong>：当创建实例需要消耗大量资源（如数据库连接、文件系统操作等），懒汉式可以推迟实例化，直到真正需要时才创建。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseConnection</span>:</span><br><span class="line">    _instance = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> cls._instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"创建新的数据库连接..."</span>)</span><br><span class="line">            cls._instance = <span class="built_in">super</span>().__new__(cls)</span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, connection_string=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># 初始化只在首次创建时执行</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">'initialized'</span>):</span><br><span class="line">            <span class="variable language_">self</span>.connection_string = connection_string</span><br><span class="line">            <span class="variable language_">self</span>.initialized = <span class="literal">True</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"连接到: <span class="subst">{connection_string}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><ol start="2"><li><strong>配置管理器</strong>：应用程序的配置管理器通常是单例的，且配置加载可能很耗时。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ConfigManager</span>:</span><br><span class="line">    _instance = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="keyword">if</span> cls._instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            cls._instance = <span class="built_in">super</span>().__new__(cls)</span><br><span class="line">            cls._instance.load_config()</span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_config</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"从文件加载配置..."</span>)</span><br><span class="line">        <span class="comment"># 模拟加载配置文件的耗时操作</span></span><br></pre></td></tr></tbody></table></figure><ol start="3"><li><strong>应用程序状态管理</strong>：当需要全局访问应用状态但又不希望在程序启动时立即初始化时。</li></ol><p>元类实现方式适合需要更灵活控制实例化过程的场景，特别是需要根据参数动态决定实例化行为的情况：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 日志管理器单例，可以根据不同的日志级别创建不同配置的单例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoggerMeta</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    _instances = {}</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">cls, log_level=<span class="literal">None</span></span>):</span><br><span class="line">        key = (cls, log_level)  <span class="comment"># 组合键，针对每个日志级别创建唯一实例</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> cls._instances:</span><br><span class="line">            cls._instances[key] = <span class="built_in">super</span>().__call__(log_level)</span><br><span class="line">        <span class="keyword">return</span> cls._instances[key]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Logger</span>(metaclass=LoggerMeta):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, log_level</span>):</span><br><span class="line">        <span class="variable language_">self</span>.log_level = log_level</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"创建<span class="subst">{log_level}</span>级别的日志记录器"</span>)</span><br></pre></td></tr></tbody></table></figure><p>装饰器实现方式适合需要将现有类转换为单例而不修改其内部代码的场景：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第三方库类转换为单例</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">singleton</span>(<span class="params">cls</span>):</span><br><span class="line">    instances = {}</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_instance</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> instances:</span><br><span class="line">            instances[cls] = cls(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> instances[cls]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> get_instance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将外部库中的类转换为单例</span></span><br><span class="line"><span class="meta">@singleton</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThirdPartyClass</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure><h5 id="饿汉式单例模式的使用场景"><a href="#饿汉式单例模式的使用场景" class="headerlink" title="饿汉式单例模式的使用场景"></a>饿汉式单例模式的使用场景</h5><p>饿汉式单例模式最适合以下场景：</p><ol><li><strong>必然会使用的核心服务</strong>：如应用程序中必定会使用的服务组件。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app_services.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventBus</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"初始化事件总线..."</span>)</span><br><span class="line">        <span class="variable language_">self</span>.listeners = {}</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">subscribe</span>(<span class="params">self, event, callback</span>):</span><br><span class="line">        <span class="keyword">if</span> event <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.listeners:</span><br><span class="line">            <span class="variable language_">self</span>.listeners[event] = []</span><br><span class="line">        <span class="variable language_">self</span>.listeners[event].append(callback)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">publish</span>(<span class="params">self, event, data</span>):</span><br><span class="line">        <span class="keyword">if</span> event <span class="keyword">in</span> <span class="variable language_">self</span>.listeners:</span><br><span class="line">            <span class="keyword">for</span> callback <span class="keyword">in</span> <span class="variable language_">self</span>.listeners[event]:</span><br><span class="line">                callback(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块级别立即创建实例</span></span><br><span class="line">event_bus = EventBus()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在其他文件中使用</span></span><br><span class="line"><span class="keyword">from</span> app_services <span class="keyword">import</span> event_bus</span><br></pre></td></tr></tbody></table></figure><ol start="2"><li><strong>应用程序设置和常量</strong>：包含应用配置的单例对象。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppSettings</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"加载应用程序设置..."</span>)</span><br><span class="line">        <span class="variable language_">self</span>.debug_mode = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>.api_url = <span class="string">"https://api.example.com"</span></span><br><span class="line">        <span class="variable language_">self</span>.max_connections = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 立即创建全局设置对象</span></span><br><span class="line">settings = AppSettings()</span><br></pre></td></tr></tbody></table></figure><ol start="3"><li><strong>线程安全要求高的场景</strong>：饿汉式单例天然线程安全，适合多线程环境。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># thread_pool.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPoolManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"初始化线程池..."</span>)</span><br><span class="line">        <span class="variable language_">self</span>.max_workers = <span class="number">10</span></span><br><span class="line">        <span class="comment"># 线程池初始化代码</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">submit_task</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"提交任务到线程池: <span class="subst">{task}</span>"</span>)</span><br><span class="line">        <span class="comment"># 任务提交逻辑</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 程序启动时即创建线程池</span></span><br><span class="line">thread_pool = ThreadPoolManager()</span><br></pre></td></tr></tbody></table></figure><h4 id="工厂模式"><a href="#工厂模式" class="headerlink" title="工厂模式"></a>工厂模式</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 抽象产品</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 具体产品</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Woof!"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cat</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Meow!"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Duck</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Quack!"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 工厂类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AnimalFactory</span>:</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_animal</span>(<span class="params">animal_type</span>):</span><br><span class="line">        <span class="keyword">match</span> animal_type.lower():</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"dog"</span>:</span><br><span class="line">                <span class="keyword">return</span> Dog()</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"cat"</span>:</span><br><span class="line">                <span class="keyword">return</span> Cat()</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"duck"</span>:</span><br><span class="line">                <span class="keyword">return</span> Duck()</span><br><span class="line">            <span class="keyword">case</span> _:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f"Invalid animal type: <span class="subst">{animal_type}</span>"</span>)</span><br><span class="line"><span class="comment">## 使用工厂</span></span><br><span class="line">factory = AnimalFactory()</span><br><span class="line">animals = [</span><br><span class="line">    factory.create_animal(<span class="string">"dog"</span>),</span><br><span class="line">    factory.create_animal(<span class="string">"cat"</span>),</span><br><span class="line">    factory.create_animal(<span class="string">"duck"</span>)</span><br><span class="line">]</span><br><span class="line"><span class="keyword">for</span> animal <span class="keyword">in</span> animals:</span><br><span class="line">    <span class="built_in">print</span>(animal.speak()) <span class="comment"># Output: Woof! Meow! Quack!</span></span><br></pre></td></tr></tbody></table></figure><p>工厂模式在以下场景中特别有用：</p><ol><li><strong>插件架构</strong>：当系统需要动态加载和使用不同的插件或扩展时。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">├── app.py                 <span class="comment"># 主应用程序，演示如何使用插件</span></span><br><span class="line">├── plugin_interface.py    <span class="comment"># 定义插件接口</span></span><br><span class="line">├── plugin_factory.py      <span class="comment"># 工厂方法模式的实现</span></span><br><span class="line">├── plugins/               <span class="comment"># 插件目录</span></span><br><span class="line">│   ├── __init__.py        <span class="comment"># 插件包初始化文件</span></span><br><span class="line">│   ├── image_processor.py <span class="comment"># 图片处理插件</span></span><br><span class="line">│   └── text_analyzer.py   <span class="comment"># 文本分析插件</span></span><br></pre></td></tr></tbody></table></figure><p>首先我们定义一个插件接口 <code>plugin_interface.py</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PluginInterface</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">"插件必须实现process方法"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_name</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">"插件必须实现get_name方法"</span>) </span><br></pre></td></tr></tbody></table></figure><p>依照插件接口新建目录文件夹 <code>plugins</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使plugins目录成为一个Python包</span></span><br><span class="line"><span class="comment"># 这允许我们使用 from plugins import xxx 的导入方式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有可用的插件模块名，方便外部遍历</span></span><br><span class="line">available_plugins = [</span><br><span class="line">    <span class="string">"image_processor"</span>,</span><br><span class="line">    <span class="string">"text_analyzer"</span></span><br><span class="line">] </span><br></pre></td></tr></tbody></table></figure><p>图片处理插件 <code>image_processor</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> plugin_interface <span class="keyword">import</span> PluginInterface</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ImageProcessorPlugin</span>(<span class="title class_ inherited__">PluginInterface</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">self, image_data</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"处理图片数据: <span class="subst">{image_data[:<span class="number">30</span>]}</span>..."</span>)</span><br><span class="line">        <span class="comment"># 实际项目中这里会有图片处理逻辑</span></span><br><span class="line">        <span class="comment"># 例如：调整大小、滤镜、裁剪等</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"已处理的图片: <span class="subst">{image_data[:<span class="number">10</span>]}</span>..."</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_name</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"图片处理插件"</span> </span><br></pre></td></tr></tbody></table></figure><p>文本处理插件 <code>text_analyzer</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> plugin_interface <span class="keyword">import</span> PluginInterface</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TextAnalyzerPlugin</span>(<span class="title class_ inherited__">PluginInterface</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">self, text</span>):</span><br><span class="line">        word_count = <span class="built_in">len</span>(text.split())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"分析文本: 共<span class="subst">{word_count}</span>个单词"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 实际项目中这里会有更复杂的文本分析逻辑</span></span><br><span class="line">        <span class="comment"># 例如：情感分析、关键词提取、语法检查等</span></span><br><span class="line">        <span class="keyword">return</span> {</span><br><span class="line">            <span class="string">"word_count"</span>: word_count,</span><br><span class="line">            <span class="string">"sentiment"</span>: <span class="string">"positive"</span> <span class="keyword">if</span> <span class="string">"good"</span> <span class="keyword">in</span> text.lower() <span class="keyword">else</span> <span class="string">"neutral"</span>,</span><br><span class="line">            <span class="string">"characters"</span>: <span class="built_in">len</span>(text),</span><br><span class="line">            <span class="string">"has_question"</span>: <span class="string">"?"</span> <span class="keyword">in</span> text</span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_name</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"文本分析插件"</span></span><br></pre></td></tr></tbody></table></figure><p>重点在我们的 <code>plugin_factory.py</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"><span class="keyword">from</span> plugin_interface <span class="keyword">import</span> PluginInterface</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PluginCreator</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    插件创建者的抽象基类 - 工厂方法模式的核心</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_plugin</span>(<span class="params">self</span>) -&gt; PluginInterface:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_plugin_info</span>(<span class="params">self</span>):</span><br><span class="line">        plugin = <span class="variable language_">self</span>.create_plugin()</span><br><span class="line">        <span class="keyword">return</span> {</span><br><span class="line">            <span class="string">"name"</span>: plugin.get_name(),</span><br><span class="line">            <span class="string">"type"</span>: <span class="variable language_">self</span>.__class__.__name__</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DynamicPluginCreator</span>(<span class="title class_ inherited__">PluginCreator</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, plugin_name</span>):</span><br><span class="line">        <span class="variable language_">self</span>.plugin_name = plugin_name</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_plugin</span>(<span class="params">self</span>) -&gt; PluginInterface:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 动态导入插件模块</span></span><br><span class="line">            module = <span class="built_in">__import__</span>(<span class="string">f"plugins.<span class="subst">{self.plugin_name}</span>"</span>, fromlist=[<span class="string">"plugins"</span>])</span><br><span class="line">            <span class="comment"># 获取插件类（约定：插件类名为模块名首字母大写+Plugin）</span></span><br><span class="line">            plugin_class_name = <span class="string">f"<span class="subst">{self.plugin_name.capitalize()}</span>Plugin"</span></span><br><span class="line">            plugin_class = <span class="built_in">getattr</span>(module, plugin_class_name)</span><br><span class="line">            <span class="comment"># 创建并返回插件实例</span></span><br><span class="line">            <span class="keyword">return</span> plugin_class()</span><br><span class="line">        <span class="keyword">except</span> (ImportError, AttributeError) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f"Plugin <span class="subst">{self.plugin_name}</span> not found: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ImagePluginCreator</span>(<span class="title class_ inherited__">PluginCreator</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_plugin</span>(<span class="params">self</span>) -&gt; PluginInterface:</span><br><span class="line">        <span class="comment"># 这里直接导入具体类，不再使用动态导入</span></span><br><span class="line">        <span class="keyword">from</span> plugins.image_processor <span class="keyword">import</span> ImageProcessorPlugin</span><br><span class="line">        <span class="keyword">return</span> ImageProcessorPlugin()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TextPluginCreator</span>(<span class="title class_ inherited__">PluginCreator</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_plugin</span>(<span class="params">self</span>) -&gt; PluginInterface:</span><br><span class="line">        <span class="comment"># 这里直接导入具体类，不再使用动态导入</span></span><br><span class="line">        <span class="keyword">from</span> plugins.text_analyzer <span class="keyword">import</span> TextAnalyzerPlugin</span><br><span class="line">        <span class="keyword">return</span> TextAnalyzerPlugin()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 工厂注册表，用于根据名称获取对应的工厂</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PluginFactory</span>:</span><br><span class="line">    <span class="comment"># 插件工厂注册表</span></span><br><span class="line">    _factories = {</span><br><span class="line">        <span class="string">"image_processor"</span>: ImagePluginCreator,</span><br><span class="line">        <span class="string">"text_analyzer"</span>: TextPluginCreator</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_factory</span>(<span class="params">cls, plugin_name</span>):</span><br><span class="line">        <span class="keyword">if</span> plugin_name <span class="keyword">in</span> cls._factories:</span><br><span class="line">            <span class="keyword">return</span> cls._factories[plugin_name]()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 如果没有具体工厂，则使用动态加载工厂</span></span><br><span class="line">            <span class="keyword">return</span> DynamicPluginCreator(plugin_name)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_factory</span>(<span class="params">cls, plugin_name, factory_class</span>):</span><br><span class="line">        cls._factories[plugin_name] = factory_class </span><br></pre></td></tr></tbody></table></figure><p>使用我们的插件工厂与插件 <code>app.py</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> plugin_factory <span class="keyword">import</span> PluginFactory</span><br><span class="line"><span class="keyword">from</span> plugins <span class="keyword">import</span> available_plugins</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    主应用程序，演示如何使用插件系统</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"=== 插件系统演示 - 工厂方法模式 ==="</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 存储已加载的插件</span></span><br><span class="line">    loaded_plugins = {}</span><br><span class="line">    plugin_infos = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 列出所有可用插件</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n可用插件列表: <span class="subst">{available_plugins}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用工厂方法模式加载所有可用插件</span></span><br><span class="line">    <span class="keyword">for</span> plugin_name <span class="keyword">in</span> available_plugins:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 获取插件创建者</span></span><br><span class="line">            plugin_creator = PluginFactory.get_factory(plugin_name)</span><br><span class="line">            <span class="comment"># 获取插件信息</span></span><br><span class="line">            plugin_info = plugin_creator.get_plugin_info()</span><br><span class="line">            plugin_infos.append(plugin_info)</span><br><span class="line">            <span class="comment"># 创建插件实例</span></span><br><span class="line">            plugin = plugin_creator.create_plugin()</span><br><span class="line">            loaded_plugins[plugin_name] = plugin</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"已加载插件: <span class="subst">{plugin.get_name()}</span> (类型: <span class="subst">{plugin_info[<span class="string">'type'</span>]}</span>)"</span>)</span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"加载插件 <span class="subst">{plugin_name}</span> 失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n=== 使用图片处理插件 ==="</span>)</span><br><span class="line">    <span class="comment"># 使用图片处理插件</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"image_processor"</span> <span class="keyword">in</span> loaded_plugins:</span><br><span class="line">        image_plugin = loaded_plugins[<span class="string">"image_processor"</span>]</span><br><span class="line">        <span class="comment"># 模拟图片数据</span></span><br><span class="line">        image_data = <span class="string">"iVBORw0KGgoAAAANSUhEUgAA..."</span>  </span><br><span class="line">        result = image_plugin.process(image_data)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"处理结果: <span class="subst">{result}</span>"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"图片处理插件未加载"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n=== 使用文本分析插件 ==="</span>)</span><br><span class="line">    <span class="comment"># 使用文本分析插件</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"text_analyzer"</span> <span class="keyword">in</span> loaded_plugins:</span><br><span class="line">        text_plugin = loaded_plugins[<span class="string">"text_analyzer"</span>]</span><br><span class="line">        <span class="comment"># 要分析的文本</span></span><br><span class="line">        text_data = <span class="string">"This is a good example of factory method pattern. Isn't it?"</span></span><br><span class="line">        result = text_plugin.process(text_data)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"分析结果:"</span>)</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> result.items():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  - <span class="subst">{key}</span>: <span class="subst">{value}</span>"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"文本分析插件未加载"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n=== 演示自定义插件创建 ==="</span>)</span><br><span class="line">    <span class="comment"># 演示自定义插件创建</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 直接使用特定的创建者</span></span><br><span class="line">        <span class="keyword">from</span> plugin_factory <span class="keyword">import</span> TextPluginCreator</span><br><span class="line">        text_creator = TextPluginCreator()</span><br><span class="line">        custom_text_plugin = text_creator.create_plugin()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"通过具体工厂直接创建插件: <span class="subst">{custom_text_plugin.get_name()}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 动态注册一个新工厂</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">CustomPluginCreator</span>(<span class="title class_ inherited__">TextPluginCreator</span>):</span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">get_plugin_info</span>(<span class="params">self</span>):</span><br><span class="line">                info = <span class="built_in">super</span>().get_plugin_info()</span><br><span class="line">                info[<span class="string">"custom"</span>] = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">return</span> info</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 注册自定义工厂</span></span><br><span class="line">        PluginFactory.register_factory(<span class="string">"custom_text"</span>, CustomPluginCreator)</span><br><span class="line">        custom_creator = PluginFactory.get_factory(<span class="string">"custom_text"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"自定义工厂信息: <span class="subst">{custom_creator.get_plugin_info()}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"自定义插件创建失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n=== 演示完成 ==="</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main() </span><br></pre></td></tr></tbody></table></figure><ol start="2"><li><strong>跨平台应用程序</strong>：根据不同操作系统创建适当的组件。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UIFactory</span>:</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_button</span>(<span class="params">label</span>):</span><br><span class="line">        system = platform.system()</span><br><span class="line">        <span class="keyword">if</span> system == <span class="string">"Windows"</span>:</span><br><span class="line">            <span class="keyword">return</span> WindowsButton(label)</span><br><span class="line">        <span class="keyword">elif</span> system == <span class="string">"Darwin"</span>:  <span class="comment"># macOS</span></span><br><span class="line">            <span class="keyword">return</span> MacButton(label)</span><br><span class="line">        <span class="keyword">elif</span> system == <span class="string">"Linux"</span>:</span><br><span class="line">            <span class="keyword">return</span> LinuxButton(label)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> GenericButton(label)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用场景</span></span><br><span class="line">login_button = UIFactory.create_button(<span class="string">"Login"</span>)</span><br><span class="line">login_button.render()  <span class="comment"># 根据当前操作系统渲染适当的按钮</span></span><br></pre></td></tr></tbody></table></figure><ol start="3"><li><strong>数据库访问层</strong>：根据配置选择不同的数据库实现。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseFactory</span>:</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_database</span>(<span class="params">db_type, connection_string</span>):</span><br><span class="line">        <span class="keyword">if</span> db_type.lower() == <span class="string">"mysql"</span>:</span><br><span class="line">            <span class="keyword">return</span> MySQLDatabase(connection_string)</span><br><span class="line">        <span class="keyword">elif</span> db_type.lower() == <span class="string">"postgresql"</span>:</span><br><span class="line">            <span class="keyword">return</span> PostgreSQLDatabase(connection_string)</span><br><span class="line">        <span class="keyword">elif</span> db_type.lower() == <span class="string">"mongodb"</span>:</span><br><span class="line">            <span class="keyword">return</span> MongoDBDatabase(connection_string)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f"Unsupported database type: <span class="subst">{db_type}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用场景 - 从配置创建适当的数据库连接</span></span><br><span class="line">config = {<span class="string">"db_type"</span>: <span class="string">"postgresql"</span>, <span class="string">"connection"</span>: <span class="string">"postgresql://user:pass@localhost/mydb"</span>}</span><br><span class="line">db = DatabaseFactory.get_database(config[<span class="string">"db_type"</span>], config[<span class="string">"connection"</span>])</span><br><span class="line">users = db.query(<span class="string">"SELECT * FROM users"</span>)</span><br></pre></td></tr></tbody></table></figure><ol start="4"><li><strong>测试替身创建</strong>：在测试环境中替换真实依赖项。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PaymentProcessorFactory</span>:</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">environment=<span class="string">"production"</span></span>):</span><br><span class="line">        <span class="keyword">if</span> environment == <span class="string">"production"</span>:</span><br><span class="line">            <span class="keyword">return</span> StripePaymentProcessor()</span><br><span class="line">        <span class="keyword">elif</span> environment == <span class="string">"sandbox"</span>:</span><br><span class="line">            <span class="keyword">return</span> SandboxPaymentProcessor()</span><br><span class="line">        <span class="keyword">elif</span> environment == <span class="string">"test"</span>:</span><br><span class="line">            <span class="keyword">return</span> MockPaymentProcessor()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f"Unknown environment: <span class="subst">{environment}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试场景</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_payment_flow</span>():</span><br><span class="line">    processor = PaymentProcessorFactory.create(<span class="string">"test"</span>)</span><br><span class="line">    result = processor.process_payment(<span class="number">100.00</span>, <span class="string">"4242424242424242"</span>)</span><br><span class="line">    <span class="keyword">assert</span> result.success == <span class="literal">True</span></span><br></pre></td></tr></tbody></table></figure><h4 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Subject</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>._observers = [] <span class="comment"># 观察者列表</span></span><br><span class="line">        <span class="variable language_">self</span>._state = <span class="literal">None</span> <span class="comment"># 当前状态</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">attach</span>(<span class="params">self,observer</span>):</span><br><span class="line">        <span class="string">""" 注册观察者 """</span></span><br><span class="line">        <span class="keyword">if</span> observer <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>._observers:</span><br><span class="line">            <span class="variable language_">self</span>._observers.append(observer)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"<span class="subst">{observer}</span> 注册成功"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detach</span>(<span class="params">self,observer</span>):</span><br><span class="line">        <span class="string">""" 注销观察者 """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>._observers.remove(observer)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"<span class="subst">{observer}</span> 注销成功"</span>)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"<span class="subst">{observer}</span> 不在观察者列表中"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">""" 通知观察者 """</span></span><br><span class="line">        <span class="keyword">for</span> observer <span class="keyword">in</span> <span class="variable language_">self</span>._observers:</span><br><span class="line">            observer.update(<span class="variable language_">self</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义Getter和Setter方法</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">state</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._state</span><br><span class="line"></span><br><span class="line"><span class="meta">    @state.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">state</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="variable language_">self</span>._state = value</span><br><span class="line">        <span class="variable language_">self</span>.notify()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self,subject</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"名称为<span class="subst">{self.name}</span>的观察者收到<span class="subst">{subject.state}</span>的更新"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用观察者模式</span></span><br><span class="line">subject = Subject()</span><br><span class="line">observer1 = Observer(<span class="string">"观察者1"</span>)</span><br><span class="line">observer2 = Observer(<span class="string">"观察者2"</span>) </span><br><span class="line">subject.attach(observer1) <span class="comment"># 注册观察者</span></span><br><span class="line">subject.attach(observer2) <span class="comment"># 注册观察者</span></span><br><span class="line">subject.state = <span class="string">"状态1"</span> <span class="comment"># 通知观察者</span></span><br><span class="line">subject.state = <span class="string">"状态2"</span> <span class="comment"># 通知观察者</span></span><br><span class="line">subject.detach(observer1)</span><br></pre></td></tr></tbody></table></figure><p>观察者模式在以下场景中非常有效：</p><ol><li><strong>事件驱动的系统</strong>：如 GUI 应用程序，响应用户操作。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QMainWindow, QPushButton, QVBoxLayout, QWidget, QLabel, QLineEdit, QMessageBox</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主题(Subject) - 被观察者</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ButtonSubject</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>._observers = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">attach</span>(<span class="params">self, observer</span>):</span><br><span class="line">        <span class="string">"""添加观察者"""</span></span><br><span class="line">        <span class="keyword">if</span> observer <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>._observers:</span><br><span class="line">            <span class="variable language_">self</span>._observers.append(observer)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detach</span>(<span class="params">self, observer</span>):</span><br><span class="line">        <span class="string">"""移除观察者"""</span></span><br><span class="line">        <span class="keyword">if</span> observer <span class="keyword">in</span> <span class="variable language_">self</span>._observers:</span><br><span class="line">            <span class="variable language_">self</span>._observers.remove(observer)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify</span>(<span class="params">self, button, username=<span class="literal">None</span>, password=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">"""通知所有观察者"""</span></span><br><span class="line">        <span class="keyword">for</span> observer <span class="keyword">in</span> <span class="variable language_">self</span>._observers:</span><br><span class="line">            observer.update(button, username, password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 观察者接口</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, button, username=<span class="literal">None</span>, password=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">"""观察者接收通知后执行的方法"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 具体观察者 - 登录处理器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoginHandler</span>(<span class="title class_ inherited__">Observer</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, status_label</span>):</span><br><span class="line">        <span class="variable language_">self</span>.status_label = status_label</span><br><span class="line">        <span class="comment"># 模拟用户数据库</span></span><br><span class="line">        <span class="variable language_">self</span>.users = {</span><br><span class="line">            <span class="string">"admin"</span>: <span class="string">"admin123"</span>,</span><br><span class="line">            <span class="string">"user"</span>: <span class="string">"password"</span></span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, button, username=<span class="literal">None</span>, password=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> button.text() == <span class="string">"登录"</span>:</span><br><span class="line">            <span class="variable language_">self</span>.process_login(username, password)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_login</span>(<span class="params">self, username, password</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">            <span class="variable language_">self</span>.status_label.setText(<span class="string">"请输入用户名和密码"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">in</span> <span class="variable language_">self</span>.users <span class="keyword">and</span> <span class="variable language_">self</span>.users[username] == password:</span><br><span class="line">            <span class="variable language_">self</span>.status_label.setText(<span class="string">f"登录成功，欢迎 <span class="subst">{username}</span>!"</span>)</span><br><span class="line">            QMessageBox.information(<span class="literal">None</span>, <span class="string">"登录成功"</span>, <span class="string">f"欢迎回来，<span class="subst">{username}</span>!"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.status_label.setText(<span class="string">"用户名或密码错误"</span>)</span><br><span class="line">            QMessageBox.warning(<span class="literal">None</span>, <span class="string">"登录失败"</span>, <span class="string">"用户名或密码错误"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建PyQt应用程序</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_observer_pattern_demo</span>():</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    window = QMainWindow()</span><br><span class="line">    window.setWindowTitle(<span class="string">"登录示例"</span>)</span><br><span class="line">    window.setGeometry(<span class="number">100</span>, <span class="number">100</span>, <span class="number">400</span>, <span class="number">250</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建中央部件和布局</span></span><br><span class="line">    central_widget = QWidget()</span><br><span class="line">    layout = QVBoxLayout(central_widget)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建用户名和密码输入框</span></span><br><span class="line">    username_label = QLabel(<span class="string">"用户名:"</span>)</span><br><span class="line">    username_input = QLineEdit()</span><br><span class="line">    username_input.setPlaceholderText(<span class="string">"请输入用户名"</span>)</span><br><span class="line">    </span><br><span class="line">    password_label = QLabel(<span class="string">"密码:"</span>)</span><br><span class="line">    password_input = QLineEdit()</span><br><span class="line">    password_input.setPlaceholderText(<span class="string">"请输入密码"</span>)</span><br><span class="line">    password_input.setEchoMode(QLineEdit.Password)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建状态标签</span></span><br><span class="line">    status_label = QLabel(<span class="string">"请登录..."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建按钮</span></span><br><span class="line">    login_button = QPushButton(<span class="string">"登录"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建主题</span></span><br><span class="line">    button_subject = ButtonSubject()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建观察者</span></span><br><span class="line">    login_handler = LoginHandler(status_label)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 注册观察者</span></span><br><span class="line">    button_subject.attach(login_handler)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 连接按钮点击事件</span></span><br><span class="line">    login_button.clicked.connect(</span><br><span class="line">        <span class="keyword">lambda</span>: button_subject.notify(</span><br><span class="line">            login_button, </span><br><span class="line">            username_input.text(), </span><br><span class="line">            password_input.text()</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加部件到布局</span></span><br><span class="line">    layout.addWidget(username_label)</span><br><span class="line">    layout.addWidget(username_input)</span><br><span class="line">    layout.addWidget(password_label)</span><br><span class="line">    layout.addWidget(password_input)</span><br><span class="line">    layout.addWidget(login_button)</span><br><span class="line">    layout.addWidget(status_label)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置中央部件</span></span><br><span class="line">    window.setCentralWidget(central_widget)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 显示窗口</span></span><br><span class="line">    window.show()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app, window, button_subject</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app, window, subject = create_observer_pattern_demo()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></tbody></table></figure><ol start="2"><li><strong>发布-订阅系统</strong>：多个组件需要对特定事件做出响应。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NewsPublisher</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>._subscribers = []</span><br><span class="line">        <span class="variable language_">self</span>._latest_news = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">attach</span>(<span class="params">self, subscriber</span>):</span><br><span class="line">        <span class="keyword">if</span> subscriber <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>._subscribers:</span><br><span class="line">            <span class="variable language_">self</span>._subscribers.append(subscriber)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detach</span>(<span class="params">self, subscriber</span>):</span><br><span class="line">        <span class="keyword">if</span> subscriber <span class="keyword">in</span> <span class="variable language_">self</span>._subscribers:</span><br><span class="line">            <span class="variable language_">self</span>._subscribers.remove(subscriber)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> subscriber <span class="keyword">in</span> <span class="variable language_">self</span>._subscribers:</span><br><span class="line">            subscriber.update(<span class="variable language_">self</span>._latest_news)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_news</span>(<span class="params">self, news</span>):</span><br><span class="line">        <span class="variable language_">self</span>._latest_news = news</span><br><span class="line">        <span class="variable language_">self</span>.notify()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NewsSubscriber</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, news</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{self.name}</span> 收到新闻: <span class="subst">{news}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用场景 - 新闻分发系统</span></span><br><span class="line">publisher = NewsPublisher()</span><br><span class="line"></span><br><span class="line">subscriber1 = NewsSubscriber(<span class="string">"用户1"</span>)</span><br><span class="line">subscriber2 = NewsSubscriber(<span class="string">"用户2"</span>)</span><br><span class="line"></span><br><span class="line">publisher.attach(subscriber1)</span><br><span class="line">publisher.attach(subscriber2)</span><br><span class="line"></span><br><span class="line">publisher.add_news(<span class="string">"今天是个好日子!"</span>)  <span class="comment"># 所有订阅者都会收到通知</span></span><br></pre></td></tr></tbody></table></figure><ol start="3"><li><strong>数据变更监控</strong>：当对象状态变化需要通知其他对象时。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataModel</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, value=<span class="number">0</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>._observers = []</span><br><span class="line">        <span class="variable language_">self</span>._value = value</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_observer</span>(<span class="params">self, observer</span>):</span><br><span class="line">        <span class="variable language_">self</span>._observers.append(observer)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_observers</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> observer <span class="keyword">in</span> <span class="variable language_">self</span>._observers:</span><br><span class="line">            observer.update(<span class="variable language_">self</span>)</span><br><span class="line">            </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">value</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._value</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @value.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">value</span>(<span class="params">self, new_value</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>._value != new_value:</span><br><span class="line">            <span class="variable language_">self</span>._value = new_value</span><br><span class="line">            <span class="variable language_">self</span>.notify_observers()</span><br><span class="line">            </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChartView</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, model</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"图表更新为新值: <span class="subst">{model.value}</span>"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TableView</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, model</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"表格更新为新值: <span class="subst">{model.value}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用场景 - MVC架构中的数据更新</span></span><br><span class="line">model = DataModel(<span class="number">10</span>)</span><br><span class="line">chart = ChartView()</span><br><span class="line">table = TableView()</span><br><span class="line"></span><br><span class="line">model.register_observer(chart)</span><br><span class="line">model.register_observer(table)</span><br><span class="line"></span><br><span class="line">model.value = <span class="number">20</span>  <span class="comment"># 自动通知所有视图更新</span></span><br></pre></td></tr></tbody></table></figure><ol start="4"><li><strong>系统监控</strong>：监控系统状态变化并触发警报。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ServerMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>._observers = []</span><br><span class="line">        <span class="variable language_">self</span>._status = <span class="string">"正常"</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_observer</span>(<span class="params">self, observer</span>):</span><br><span class="line">        <span class="variable language_">self</span>._observers.append(observer)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_status</span>(<span class="params">self, status</span>):</span><br><span class="line">        old_status = <span class="variable language_">self</span>._status</span><br><span class="line">        <span class="variable language_">self</span>._status = status</span><br><span class="line">        <span class="keyword">if</span> old_status != status:</span><br><span class="line">            <span class="variable language_">self</span>.notify_observers()</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_observers</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> observer <span class="keyword">in</span> <span class="variable language_">self</span>._observers:</span><br><span class="line">            observer.update(<span class="variable language_">self</span>._status)</span><br><span class="line">            </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EmailAlert</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, status</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"发送邮件警报: 服务器状态变为 <span class="subst">{status}</span>"</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SMSAlert</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, status</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"发送短信警报: 服务器状态变为 <span class="subst">{status}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用场景 - 服务器监控系统</span></span><br><span class="line">monitor = ServerMonitor()</span><br><span class="line">email_alert = EmailAlert()</span><br><span class="line">sms_alert = SMSAlert()</span><br><span class="line"></span><br><span class="line">monitor.add_observer(email_alert)</span><br><span class="line">monitor.add_observer(sms_alert)</span><br><span class="line"></span><br><span class="line">monitor.set_status(<span class="string">"严重错误"</span>)  <span class="comment"># 触发所有警报</span></span><br></pre></td></tr></tbody></table></figure><h4 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h4><p>代理模式是一种结构型设计模式，它为其他对象提供了一种代理以控制对这些对象的访问；可以把代理模式理解为一个“守门员”，在客户（Client）和真实对象（RealSubject）之间充当中介，控制请求的传递和处理—— 就像你想看一部付费电影时，需要先通过一个“守门员”确认你是否支付了费用，这名守门员就是代理，他会在你访问电影资源之前先做一些检查，确保你有权利观看。</p><p>接下来，我们通过代码展示如何在 Python 中实现一些常用的代理模式——静态代理、动态代理、保护代理、虚拟代理。</p><h5 id="1-静态代理实现"><a href="#1-静态代理实现" class="headerlink" title="1.静态代理实现"></a>1.静态代理实现</h5><p>静态代理在编译时确定代理行为，非常适合结构固定的场景。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RealSubject</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"真实对象，请求被调用"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Proxy</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,real_subject:RealSubject</span>):</span><br><span class="line">        <span class="variable language_">self</span>.real_subject = real_subject</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"代理:在真实对象之前检查权限"</span>)</span><br><span class="line">        <span class="comment"># 代理控制访问</span></span><br><span class="line">        <span class="variable language_">self</span>.real_subject.request()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"代理：在真实对象之后记录日志"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用代理</span></span><br><span class="line">real_subject = RealSubject()</span><br><span class="line">proxy = Proxy(real_subject)</span><br><span class="line">proxy.request()</span><br></pre></td></tr></tbody></table></figure><h5 id="2-动态代理实现"><a href="#2-动态代理实现" class="headerlink" title="2.动态代理实现"></a>2.动态代理实现</h5><p>动态代理可以在运行时动态地为对象添加功能，而不需要在编译时确定：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">timing_proxy</span>(<span class="params">func</span>):</span><br><span class="line">    <span class="string">'''定义一个装饰器，打印函数执行时间'''</span></span><br><span class="line"><span class="meta">    @wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{func.__name__}</span> 执行时间：<span class="subst">{end_time - start_time:<span class="number">.4</span>f}</span> 秒。"</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SomeService</span>:</span><br><span class="line"><span class="meta">    @timing_proxy</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perform_task</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"正在执行任务..."</span>)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line"><span class="comment"># 使用动态代理</span></span><br><span class="line">service = SomeService()</span><br><span class="line">service.perform_task()</span><br></pre></td></tr></tbody></table></figure><h5 id="3-保护代理实现"><a href="#3-保护代理实现" class="headerlink" title="3.保护代理实现"></a>3.保护代理实现</h5><p>保护代理是一种常见的应用场景，用于控制对对象的访问权限，下面的例子展示了如何实现一个简单的保护代理：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RealSubject</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">self,user_role</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{user_role}</span> 访问 执行敏感操作"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProtectionProxy</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,real_subject:RealSubject</span>):</span><br><span class="line">        <span class="variable language_">self</span>.real_subject = real_subject</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">self,user_role</span>):</span><br><span class="line">        <span class="keyword">if</span> user_role == <span class="string">"admin"</span>:</span><br><span class="line">            <span class="variable language_">self</span>.real_subject.request(user_role)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"权限不足"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用保护代理</span></span><br><span class="line">real_subject = RealSubject()</span><br><span class="line">proxy = ProtectionProxy(real_subject)</span><br><span class="line">proxy.request(<span class="string">"admin"</span>)</span><br><span class="line">proxy.request(<span class="string">"user"</span>) <span class="comment"># 权限不足</span></span><br></pre></td></tr></tbody></table></figure><h5 id="4-虚拟代理实现"><a href="#4-虚拟代理实现" class="headerlink" title="4.虚拟代理实现"></a>4.虚拟代理实现</h5><p>虚拟代理用于控制昂贵资源的延迟加载，只有在真正需要时才创建对象：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HeavyResource</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"加载大量数据..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VirtualProxy</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>._real_resource = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>._real_resource <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="variable language_">self</span>._real_resource = HeavyResource()</span><br><span class="line">            <span class="variable language_">self</span>._real_resource.load()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"资源已加载，执行操作。"</span>)</span><br><span class="line"><span class="comment"># 使用虚拟代理</span></span><br><span class="line">proxy = VirtualProxy()</span><br><span class="line">proxy.request()  <span class="comment"># 首次调用会加载数据</span></span><br><span class="line">proxy.request()  <span class="comment"># 第二次调用不会再次加载数据</span></span><br></pre></td></tr></tbody></table></figure><hr><h3 id="SOLID-原则"><a href="#SOLID-原则" class="headerlink" title="SOLID 原则"></a>SOLID 原则</h3><h4 id="SOLID-原则概述"><a href="#SOLID-原则概述" class="headerlink" title="SOLID 原则概述"></a>SOLID 原则概述</h4><p>SOLID 是面向对象设计的五个核心原则的首字母缩写，由罗伯特·C·马丁（Robert C. Martin）在 21 世纪早期提出。这些原则旨在帮助开发者创建易于维护和扩展的软件系统。SOLID 原则包括：</p><table><thead><tr><th>原则</th><th>全称</th><th>简述</th></tr></thead><tbody><tr><td>S</td><td>单一职责原则 (Single Responsibility Principle)</td><td>一个类应该只有一个引起它变化的原因</td></tr><tr><td>O</td><td>开放封闭原则 (Open-Closed Principle)</td><td>软件实体应该对扩展开放，对修改关闭</td></tr><tr><td>L</td><td>里氏替换原则 (Liskov Substitution Principle)</td><td>子类必须能够替换其基类使用</td></tr><tr><td>I</td><td>接口隔离原则 (Interface Segregation Principle)</td><td>不应强制客户依赖于它们不使用的接口</td></tr><tr><td>D</td><td>依赖倒置原则 (Dependency Inversion Principle)</td><td>依赖抽象而不是具体实现</td></tr></tbody></table><p>遵循这些原则可以创建出更加灵活、可维护、可扩展的代码，减少系统的脆弱性和紧耦合性，提高代码的复用性和可测试性。接下来，我们将通过电商系统的实例，逐一深入解析这些原则。</p><h4 id="1-单一职责原则-SRP"><a href="#1-单一职责原则-SRP" class="headerlink" title="1. 单一职责原则 (SRP)"></a>1. 单一职责原则 (SRP)</h4><h5 id="1-1-原则解析"><a href="#1-1-原则解析" class="headerlink" title="1.1 原则解析"></a>1.1 原则解析</h5><p><strong>定义</strong>：一个类应该只有一个引起它变化的原因。</p><p><strong>核心思想</strong>：每个类或模块只负责一项职责，将不同的职责分离到不同的类中。</p><p><strong>优势</strong>：</p><ul><li>提高代码的内聚性</li><li>降低类的复杂度</li><li>增强代码的可维护性</li><li>降低变更引起的风险</li></ul><h5 id="1-2-电商系统中的应用"><a href="#1-2-电商系统中的应用" class="headerlink" title="1.2 电商系统中的应用"></a>1.2 电商系统中的应用</h5><p>让我们看看电商系统中如何应用单一职责原则。在许多不遵循 SRP 的系统中，我们可能会看到一个 “超级类” 包含了所有与订单相关的功能：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 违反单一职责原则的示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, order_id, customer_info</span>):</span><br><span class="line">        <span class="variable language_">self</span>.order_id = order_id</span><br><span class="line">        <span class="variable language_">self</span>.customer_info = customer_info</span><br><span class="line">        <span class="variable language_">self</span>.items = []</span><br><span class="line">        <span class="variable language_">self</span>.status = <span class="string">"created"</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_item</span>(<span class="params">self, product, quantity</span>):</span><br><span class="line">        <span class="comment"># 添加商品</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove_item</span>(<span class="params">self, product</span>):</span><br><span class="line">        <span class="comment"># 移除商品</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_total</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 计算总价</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_payment</span>(<span class="params">self, payment_method, payment_details</span>):</span><br><span class="line">        <span class="comment"># 处理支付</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_confirmation_email</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 发送确认邮件</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ship_order</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 处理配送</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_to_database</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 保存到数据库</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure><p>这个类违反了单一职责原则，它同时承担了多项职责：处理订单项目、计算金额、处理支付、发送通知、处理配送、数据存储等。</p><h5 id="1-3-遵循-SRP-的实现"><a href="#1-3-遵循-SRP-的实现" class="headerlink" title="1.3 遵循 SRP 的实现"></a>1.3 遵循 SRP 的实现</h5><p>按照单一职责原则，我们应该将不同职责分离到不同的类中：</p><ol><li><strong>订单模型类</strong>：只负责订单的基本属性和状态</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### models/order.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, order_id, customer_email</span>):</span><br><span class="line">        <span class="variable language_">self</span>.<span class="built_in">id</span> = order_id</span><br><span class="line">        <span class="variable language_">self</span>.customer_email = customer_email</span><br><span class="line">        <span class="variable language_">self</span>.items = []</span><br><span class="line">        <span class="variable language_">self</span>.status = <span class="string">"created"</span></span><br><span class="line">        <span class="variable language_">self</span>.shipping_address = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_item</span>(<span class="params">self, product, quantity</span>):</span><br><span class="line">        <span class="comment"># 仅负责添加商品到订单</span></span><br><span class="line">        <span class="variable language_">self</span>.items.append({</span><br><span class="line">            <span class="string">"product"</span>: product,</span><br><span class="line">            <span class="string">"quantity"</span>: quantity,</span><br><span class="line">            <span class="string">"price"</span>: product.price</span><br><span class="line">        })</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove_item</span>(<span class="params">self, product</span>):</span><br><span class="line">        <span class="comment"># 仅负责从订单中移除商品</span></span><br><span class="line">        original_length = <span class="built_in">len</span>(<span class="variable language_">self</span>.items)</span><br><span class="line">        <span class="variable language_">self</span>.items = [item <span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable language_">self</span>.items <span class="keyword">if</span> item[<span class="string">"product"</span>].<span class="built_in">id</span> != product.<span class="built_in">id</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.items) &lt; original_length</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_total</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 仅负责计算订单总价</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(item[<span class="string">"price"</span>] * item[<span class="string">"quantity"</span>] <span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable language_">self</span>.items)</span><br></pre></td></tr></tbody></table></figure><ol start="2"><li><strong>支付处理类</strong>：专门负责支付相关功能</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### models/payment.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CreditCardProcessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_payment</span>(<span class="params">self, amount, payment_data</span>):</span><br><span class="line">        <span class="comment"># 专门处理信用卡支付</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"处理 ¥<span class="subst">{amount:<span class="number">.2</span>f}</span> 的信用卡支付"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AlipayProcessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_payment</span>(<span class="params">self, amount, payment_data</span>):</span><br><span class="line">        <span class="comment"># 专门处理支付宝支付</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"处理 ¥<span class="subst">{amount:<span class="number">.2</span>f}</span> 的支付宝支付"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WechatPayProcessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_payment</span>(<span class="params">self, amount, payment_data</span>):</span><br><span class="line">        <span class="comment"># 专门处理微信支付</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"处理 ¥<span class="subst">{amount:<span class="number">.2</span>f}</span> 的微信支付"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></tbody></table></figure><ol start="3"><li><strong>通知服务类</strong>：专门负责通知功能</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### services/notification.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EmailOrderNotifier</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_creation</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="comment"># 通知订单创建</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"向 <span class="subst">{order.customer_email}</span> 发送订单创建通知"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_shipping</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="comment"># 通知订单发货</span></span><br><span class="line">        delivery_date = order.get_estimated_delivery()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"向 <span class="subst">{order.customer_email}</span> 发送订单发货通知"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_cancellation</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="comment"># 通知订单取消</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"向 <span class="subst">{order.customer_email}</span> 发送订单取消通知"</span>)</span><br></pre></td></tr></tbody></table></figure><ol start="4"><li><strong>订单仓储类</strong>：专门负责数据存储</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### repositories/order_repository.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqliteOrderRepository</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="comment"># 专门负责订单持久化</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"将订单 <span class="subst">{order.<span class="built_in">id</span>}</span> 保存到SQLite数据库"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_by_id</span>(<span class="params">self, order_id</span>):</span><br><span class="line">        <span class="comment"># 专门负责查询订单</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"从SQLite数据库查询订单 <span class="subst">{order_id}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><p>通过这样的设计，我们将不同的职责分离到不同的类中，每个类只负责一个特定的功能，符合单一职责原则。</p><h4 id="2-开放封闭原则-OCP"><a href="#2-开放封闭原则-OCP" class="headerlink" title="2. 开放封闭原则 (OCP)"></a>2. 开放封闭原则 (OCP)</h4><h5 id="2-1-原则解析"><a href="#2-1-原则解析" class="headerlink" title="2.1 原则解析"></a>2.1 原则解析</h5><p><strong>定义</strong>：软件实体（类、模块、函数等）应该对扩展开放，对修改封闭。</p><p><strong>核心思想</strong>：当需要添加新功能时，应该通过扩展现有代码（如添加新类、新方法）而不是修改现有代码。</p><p><strong>优势</strong>：</p><ul><li>提高系统稳定性</li><li>减少现有代码的改动和破坏</li><li>提高代码的可复用性</li><li>降低维护成本</li></ul><h5 id="2-2-电商系统中的应用"><a href="#2-2-电商系统中的应用" class="headerlink" title="2.2 电商系统中的应用"></a>2.2 电商系统中的应用</h5><p>考虑支付处理的场景。如果没有遵循开放封闭原则，我们可能会这样实现：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 违反开放封闭原则的示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PaymentProcessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_payment</span>(<span class="params">self, amount, payment_method, payment_data</span>):</span><br><span class="line">        <span class="keyword">if</span> payment_method == <span class="string">"credit_card"</span>:</span><br><span class="line">            <span class="comment"># 处理信用卡支付</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"处理 ¥<span class="subst">{amount:<span class="number">.2</span>f}</span> 的信用卡支付"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> payment_method == <span class="string">"alipay"</span>:</span><br><span class="line">            <span class="comment"># 处理支付宝支付</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"处理 ¥<span class="subst">{amount:<span class="number">.2</span>f}</span> 的支付宝支付"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> payment_method == <span class="string">"wechat"</span>:</span><br><span class="line">            <span class="comment"># 处理微信支付</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"处理 ¥<span class="subst">{amount:<span class="number">.2</span>f}</span> 的微信支付"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f"不支持的支付方式: <span class="subst">{payment_method}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><p>这个设计违反了开放封闭原则，因为每当我们想添加新的支付方式（如 PayPal），都需要修改这个类的代码，添加新的条件分支。</p><h5 id="2-3-遵循-OCP-的实现"><a href="#2-3-遵循-OCP-的实现" class="headerlink" title="2.3 遵循 OCP 的实现"></a>2.3 遵循 OCP 的实现</h5><p>按照开放封闭原则，我们应该通过抽象接口和多态来实现支付处理：</p><ol><li><strong>定义支付处理接口</strong></li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### interfaces/payment.py</span></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PaymentProcessor</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_payment</span>(<span class="params">self, amount, payment_data</span>):</span><br><span class="line">        <span class="string">"""处理支付"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_payment_method_name</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""获取支付方式名称"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure><ol start="2"><li><strong>实现具体支付处理器</strong></li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### models/payment.py</span></span><br><span class="line"><span class="keyword">from</span> ecommerce.interfaces.payment <span class="keyword">import</span> PaymentProcessor</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CreditCardProcessor</span>(<span class="title class_ inherited__">PaymentProcessor</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_payment</span>(<span class="params">self, amount, payment_data</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"处理 ¥<span class="subst">{amount:<span class="number">.2</span>f}</span> 的信用卡支付"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_payment_method_name</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"信用卡支付"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AlipayProcessor</span>(<span class="title class_ inherited__">PaymentProcessor</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_payment</span>(<span class="params">self, amount, payment_data</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"处理 ¥<span class="subst">{amount:<span class="number">.2</span>f}</span> 的支付宝支付"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_payment_method_name</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"支付宝支付"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WechatPayProcessor</span>(<span class="title class_ inherited__">PaymentProcessor</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_payment</span>(<span class="params">self, amount, payment_data</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"处理 ¥<span class="subst">{amount:<span class="number">.2</span>f}</span> 的微信支付"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_payment_method_name</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"微信支付"</span></span><br></pre></td></tr></tbody></table></figure><ol start="3"><li><strong>创建支付处理器工厂</strong></li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### models/payment.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PaymentProcessorFactory</span>:</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_processor</span>(<span class="params">payment_method</span>):</span><br><span class="line">        processors = {</span><br><span class="line">            <span class="string">"credit_card"</span>: CreditCardProcessor(),</span><br><span class="line">            <span class="string">"alipay"</span>: AlipayProcessor(),</span><br><span class="line">            <span class="string">"wechat"</span>: WechatPayProcessor()</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> payment_method <span class="keyword">not</span> <span class="keyword">in</span> processors:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f"不支持的支付方式: <span class="subst">{payment_method}</span>"</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> processors[payment_method]</span><br></pre></td></tr></tbody></table></figure><p>现在，如果我们想添加新的支付方式（如 PayPal），只需要：</p><ol><li>创建一个新的 <code>PayPalProcessor</code> 类实现 <code>PaymentProcessor</code> 接口</li><li>将其添加到 <code>PaymentProcessorFactory</code> 的映射中</li></ol><p>无需修改现有代码，只需扩展新功能，完全符合开放封闭原则。</p><h4 id="3-里氏替换原则-LSP"><a href="#3-里氏替换原则-LSP" class="headerlink" title="3. 里氏替换原则 (LSP)"></a>3. 里氏替换原则 (LSP)</h4><h5 id="3-1-原则解析"><a href="#3-1-原则解析" class="headerlink" title="3.1 原则解析"></a>3.1 原则解析</h5><p><strong>定义</strong>：子类型必须能够替换其基类型使用。</p><p><strong>核心思想</strong>：继承类应当能够替代其父类使用，而不改变程序的正确性。子类应当保持父类的行为约定。</p><p><strong>优势</strong>：</p><ul><li>确保类的层次结构设计合理</li><li>增强代码的可复用性</li><li>提高系统的健壮性</li><li>保证面向对象设计的正确性</li></ul><h5 id="3-2-电商系统中的应用"><a href="#3-2-电商系统中的应用" class="headerlink" title="3.2 电商系统中的应用"></a>3.2 电商系统中的应用</h5><p>考虑配送方式的实现。如果违反里氏替换原则，我们可能会遇到这样的情况：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 违反里氏替换原则的示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShippingMethod</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_cost</span>(<span class="params">self, weight, distance</span>):</span><br><span class="line">        <span class="comment"># 计算标准运费</span></span><br><span class="line">        <span class="keyword">return</span> weight * <span class="number">0.5</span> + distance * <span class="number">0.1</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_estimated_days</span>(<span class="params">self, distance</span>):</span><br><span class="line">        <span class="comment"># 获取估计送达天数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(<span class="number">1</span>, <span class="built_in">int</span>(distance / <span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExpressShipping</span>(<span class="title class_ inherited__">ShippingMethod</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_cost</span>(<span class="params">self, weight, distance</span>):</span><br><span class="line">        <span class="comment"># 快递费用比标准运费高</span></span><br><span class="line">        <span class="keyword">return</span> weight * <span class="number">1.0</span> + distance * <span class="number">0.2</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_estimated_days</span>(<span class="params">self, distance</span>):</span><br><span class="line">        <span class="comment"># 快递比标准配送快</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(<span class="number">1</span>, <span class="built_in">int</span>(distance / <span class="number">200</span>))</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FreeShipping</span>(<span class="title class_ inherited__">ShippingMethod</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_cost</span>(<span class="params">self, weight, distance</span>):</span><br><span class="line">        <span class="comment"># 免费配送</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_estimated_days</span>(<span class="params">self, distance</span>):</span><br><span class="line">        <span class="comment"># 不提供送达时间估计，返回None而不是整数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># 违反了父类的行为约定</span></span><br></pre></td></tr></tbody></table></figure><p>在上面的例子中，<code>FreeShipping</code> 类违反了里氏替换原则，因为它的 <code>get_estimated_days</code> 方法返回了 <code>None</code> 而不是整数，这与父类的行为约定不一致。如果有代码依赖于 <code>ShippingMethod</code> 的返回值是整数，那么使用 <code>FreeShipping</code> 时可能会导致错误。</p><h5 id="3-3-遵循-LSP-的实现"><a href="#3-3-遵循-LSP-的实现" class="headerlink" title="3.3 遵循 LSP 的实现"></a>3.3 遵循 LSP 的实现</h5><p>以下是遵循里氏替换原则的配送方式实现：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### interfaces/shipping.py</span></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShippingMethod</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_cost</span>(<span class="params">self, weight, distance</span>):</span><br><span class="line">        <span class="string">"""计算运费"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_estimated_days</span>(<span class="params">self, distance</span>):</span><br><span class="line">        <span class="string">"""获取预计配送天数"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### models/shipping.py</span></span><br><span class="line"><span class="keyword">from</span> ecommerce.interfaces.shipping <span class="keyword">import</span> ShippingMethod</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StandardShipping</span>(<span class="title class_ inherited__">ShippingMethod</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_cost</span>(<span class="params">self, weight, distance</span>):</span><br><span class="line">        <span class="keyword">return</span> weight * <span class="number">0.5</span> + distance * <span class="number">0.1</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_estimated_days</span>(<span class="params">self, distance</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(<span class="number">1</span>, <span class="built_in">int</span>(distance / <span class="number">100</span>))</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"标准配送"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExpressShipping</span>(<span class="title class_ inherited__">ShippingMethod</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_cost</span>(<span class="params">self, weight, distance</span>):</span><br><span class="line">        <span class="keyword">return</span> weight * <span class="number">1.0</span> + distance * <span class="number">0.2</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_estimated_days</span>(<span class="params">self, distance</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(<span class="number">1</span>, <span class="built_in">int</span>(distance / <span class="number">200</span>))</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"快速配送"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FreeShipping</span>(<span class="title class_ inherited__">ShippingMethod</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_cost</span>(<span class="params">self, weight, distance</span>):</span><br><span class="line">        <span class="comment"># 免费配送</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_estimated_days</span>(<span class="params">self, distance</span>):</span><br><span class="line">        <span class="comment"># 仍然返回整数，保持与父类一致的行为约定</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(<span class="number">5</span>, <span class="built_in">int</span>(distance / <span class="number">50</span>))  <span class="comment"># 免费配送较慢</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"免费配送"</span></span><br></pre></td></tr></tbody></table></figure><p>现在，所有的配送方式类都符合里氏替换原则，它们都保持了父类的行为约定：<code>calculate_cost</code> 返回数值，<code>get_estimated_days</code> 返回整数。</p><h4 id="4-接口隔离原则-ISP"><a href="#4-接口隔离原则-ISP" class="headerlink" title="4. 接口隔离原则 (ISP)"></a>4. 接口隔离原则 (ISP)</h4><h5 id="4-1-原则解析"><a href="#4-1-原则解析" class="headerlink" title="4.1 原则解析"></a>4.1 原则解析</h5><p><strong>定义</strong>：客户端不应该被迫依赖于它们不使用的接口。</p><p><strong>核心思想</strong>：一个类不应该依赖于它不需要的接口。接口应该是小而精的，一个大而全的接口应该被拆分为多个小接口。</p><p><strong>优势</strong>：</p><ul><li>提高接口的聚合度</li><li>减少冗余的接口实现</li><li>提高系统的灵活性和可扩展性</li><li>降低接口之间的耦合度</li></ul><h5 id="4-2-电商系统中的应用"><a href="#4-2-电商系统中的应用" class="headerlink" title="4.2 电商系统中的应用"></a>4.2 电商系统中的应用</h5><p>考虑订单通知的场景。违反接口隔离原则的设计可能如下：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 违反接口隔离原则的示例</span></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderNotifier</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_creation</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="string">"""通知订单创建"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_shipping</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="string">"""通知订单配送"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_cancellation</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="string">"""通知订单取消"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_sms</span>(<span class="params">self, phone_number, message</span>):</span><br><span class="line">        <span class="string">"""发送短信通知"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_email</span>(<span class="params">self, email, subject, message</span>):</span><br><span class="line">        <span class="string">"""发送邮件通知"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_push_notification</span>(<span class="params">self, device_id, message</span>):</span><br><span class="line">        <span class="string">"""发送推送通知"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure><p>这个接口违反了接口隔离原则，因为它强制所有实现类都必须实现所有方法。例如，一个邮件通知实现类可能不需要实现 SMS 或推送通知的方法。</p><h5 id="4-3-遵循-ISP-的实现"><a href="#4-3-遵循-ISP-的实现" class="headerlink" title="4.3 遵循 ISP 的实现"></a>4.3 遵循 ISP 的实现</h5><p>按照接口隔离原则，我们应该将大接口拆分为多个小接口：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### interfaces/notification.py</span></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderNotifier</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_creation</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="string">"""通知订单创建"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_shipping</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="string">"""通知订单配送"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_cancellation</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="string">"""通知订单取消"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EmailNotifier</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_email</span>(<span class="params">self, email, subject, message</span>):</span><br><span class="line">        <span class="string">"""发送邮件"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SMSNotifier</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_sms</span>(<span class="params">self, phone_number, message</span>):</span><br><span class="line">        <span class="string">"""发送短信"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PushNotifier</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_push_notification</span>(<span class="params">self, device_id, message</span>):</span><br><span class="line">        <span class="string">"""发送推送通知"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure><p>然后，实现类可以选择性地实现它们需要的接口：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### services/notification.py</span></span><br><span class="line"><span class="keyword">from</span> ecommerce.interfaces.notification <span class="keyword">import</span> OrderNotifier, EmailNotifier</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EmailOrderNotifier</span>(OrderNotifier, EmailNotifier):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_creation</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"向 <span class="subst">{order.customer_email}</span> 发送订单创建通知"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.send_email(order.customer_email, <span class="string">"订单已创建"</span>, <span class="string">f"您的订单 <span class="subst">{order.<span class="built_in">id</span>}</span> 已创建"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_shipping</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"向 <span class="subst">{order.customer_email}</span> 发送订单配送通知"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.send_email(order.customer_email, <span class="string">"订单已发货"</span>, <span class="string">f"您的订单 <span class="subst">{order.<span class="built_in">id</span>}</span> 已发货"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_cancellation</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"向 <span class="subst">{order.customer_email}</span> 发送订单取消通知"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.send_email(order.customer_email, <span class="string">"订单已取消"</span>, <span class="string">f"您的订单 <span class="subst">{order.<span class="built_in">id</span>}</span> 已取消"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_email</span>(<span class="params">self, email, subject, message</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"发送邮件到 <span class="subst">{email}</span>，主题: <span class="subst">{subject}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### services/notification.py</span></span><br><span class="line"><span class="keyword">from</span> ecommerce.interfaces.notification <span class="keyword">import</span> OrderNotifier, SMSNotifier</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SMSOrderNotifier</span>(OrderNotifier, SMSNotifier):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_creation</span>(<span class="params">self, order</span>):</span><br><span class="line">        phone = <span class="variable language_">self</span>._get_phone_from_order(order)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"向手机号 <span class="subst">{phone}</span> 发送订单创建短信通知"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.send_sms(phone, <span class="string">f"您的订单 <span class="subst">{order.<span class="built_in">id</span>}</span> 已创建"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_shipping</span>(<span class="params">self, order</span>):</span><br><span class="line">        phone = <span class="variable language_">self</span>._get_phone_from_order(order)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"向手机号 <span class="subst">{phone}</span> 发送订单配送短信通知"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.send_sms(phone, <span class="string">f"您的订单 <span class="subst">{order.<span class="built_in">id</span>}</span> 已发货"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">notify_cancellation</span>(<span class="params">self, order</span>):</span><br><span class="line">        phone = <span class="variable language_">self</span>._get_phone_from_order(order)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"向手机号 <span class="subst">{phone}</span> 发送订单取消短信通知"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.send_sms(phone, <span class="string">f"您的订单 <span class="subst">{order.<span class="built_in">id</span>}</span> 已取消"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_sms</span>(<span class="params">self, phone_number, message</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"发送短信到 <span class="subst">{phone_number}</span>: <span class="subst">{message}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_phone_from_order</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="comment"># 实际应用中应该从订单中获取电话号码</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"1234567890"</span></span><br></pre></td></tr></tbody></table></figure><p>通过这种方式，每个实现类只需要实现它关心的接口，符合接口隔离原则。</p><h4 id="5-依赖倒置原则-DIP"><a href="#5-依赖倒置原则-DIP" class="headerlink" title="5. 依赖倒置原则 (DIP)"></a>5. 依赖倒置原则 (DIP)</h4><h5 id="5-1-原则解析"><a href="#5-1-原则解析" class="headerlink" title="5.1 原则解析"></a>5.1 原则解析</h5><p><strong>定义</strong>：高层模块不应该依赖于低层模块，两者都应该依赖于抽象。抽象不应该依赖于细节，细节应该依赖于抽象。</p><p><strong>核心思想</strong>：通过引入抽象层（如接口、抽象类）来解耦高层和低层模块，实现可扩展性和可维护性。</p><p><strong>优势</strong>：</p><ul><li>降低模块间的耦合度</li><li>提高代码的可重用性</li><li>方便系统的单元测试</li><li>提高系统的可扩展性</li></ul><h5 id="5-2-电商系统中的应用"><a href="#5-2-电商系统中的应用" class="headerlink" title="5.2 电商系统中的应用"></a>5.2 电商系统中的应用</h5><p>考虑订单服务与数据持久化的关系。违反依赖倒置原则的设计可能如下：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 违反依赖倒置原则的示例</span></span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 直接依赖具体的SQLite实现</span></span><br><span class="line">        <span class="variable language_">self</span>.connection = sqlite3.connect(<span class="string">'orders.db'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_order</span>(<span class="params">self, order_data</span>):</span><br><span class="line">        cursor = <span class="variable language_">self</span>.connection.cursor()</span><br><span class="line">        <span class="comment"># 插入订单数据</span></span><br><span class="line">        cursor.execute(</span><br><span class="line">            <span class="string">"INSERT INTO orders (id, customer_email, status) VALUES (?, ?, ?)"</span>,</span><br><span class="line">            (order_data[<span class="string">'id'</span>], order_data[<span class="string">'email'</span>], <span class="string">'created'</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.connection.commit()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_order</span>(<span class="params">self, order_id</span>):</span><br><span class="line">        cursor = <span class="variable language_">self</span>.connection.cursor()</span><br><span class="line">        <span class="comment"># 查询订单数据</span></span><br><span class="line">        cursor.execute(<span class="string">"SELECT * FROM orders WHERE id = ?"</span>, (order_id,))</span><br><span class="line">        <span class="keyword">return</span> cursor.fetchone()</span><br></pre></td></tr></tbody></table></figure><p>这个设计违反了依赖倒置原则，高层模块 <code>OrderService</code> 直接依赖于低层模块 <code>sqlite3</code>。如果我们想切换到其他数据库，需要修改 <code>OrderService</code> 类的代码。</p><h5 id="5-3-遵循-DIP-的实现"><a href="#5-3-遵循-DIP-的实现" class="headerlink" title="5.3 遵循 DIP 的实现"></a>5.3 遵循 DIP 的实现</h5><p>按照依赖倒置原则，我们应该让高层和低层模块都依赖于抽象：</p><ol><li><strong>定义订单仓储接口（抽象）</strong></li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### interfaces/repository.py</span></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderRepository</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="string">"""保存订单"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_by_id</span>(<span class="params">self, order_id</span>):</span><br><span class="line">        <span class="string">"""根据ID查找订单"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">list_orders</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""列出所有订单"""</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure><ol start="2"><li><strong>实现具体的订单仓储类</strong></li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### repositories/order_repository.py</span></span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">from</span> ecommerce.interfaces.repository <span class="keyword">import</span> OrderRepository</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqliteOrderRepository</span>(<span class="title class_ inherited__">OrderRepository</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 具体的SQLite实现</span></span><br><span class="line">        <span class="variable language_">self</span>.connection = sqlite3.connect(<span class="string">'orders.db'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self, order</span>):</span><br><span class="line">        cursor = <span class="variable language_">self</span>.connection.cursor()</span><br><span class="line">        <span class="comment"># 保存订单到SQLite</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"将订单 <span class="subst">{order.<span class="built_in">id</span>}</span> 保存到SQLite数据库"</span>)</span><br><span class="line">        <span class="comment"># 实际的SQL操作...</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_by_id</span>(<span class="params">self, order_id</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"从SQLite数据库查询订单 <span class="subst">{order_id}</span>"</span>)</span><br><span class="line">        <span class="comment"># 实际的SQL查询...</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">list_orders</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"从SQLite数据库查询所有订单"</span>)</span><br><span class="line">        <span class="comment"># 实际的SQL查询...</span></span><br></pre></td></tr></tbody></table></figure><ol start="3"><li><strong>修改订单服务，依赖抽象接口</strong></li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### services/order.py</span></span><br><span class="line"><span class="keyword">from</span> ecommerce.interfaces.repository <span class="keyword">import</span> OrderRepository</span><br><span class="line"><span class="keyword">from</span> ecommerce.interfaces.notification <span class="keyword">import</span> OrderNotifier</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, repository: OrderRepository, notifier: OrderNotifier</span>):</span><br><span class="line">        <span class="comment"># 依赖抽象接口，而不是具体实现</span></span><br><span class="line">        <span class="variable language_">self</span>._repository = repository</span><br><span class="line">        <span class="variable language_">self</span>._notifier = notifier</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_order</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="variable language_">self</span>._repository.save(order)</span><br><span class="line">        <span class="variable language_">self</span>._notifier.notify_creation(order)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_order</span>(<span class="params">self, order_id</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._repository.find_by_id(order_id)</span><br></pre></td></tr></tbody></table></figure><p>通过这种设计，<code>OrderService</code> 依赖于抽象接口 <code>OrderRepository</code> 和 <code>OrderNotifier</code>，而不是具体实现。这样我们可以轻松地替换具体实现，例如从 SQLite 切换到 MySQL，只需要提供一个新的实现类，而不需要修改 <code>OrderService</code> 的代码。</p><h3 id="Python-中的-slots"><a href="#Python-中的-slots" class="headerlink" title="Python 中的 __slots__"></a>Python 中的 <code>__slots__</code></h3><p><code>__slots__</code> 是一个特殊的类变量，它可以限制类的实例能拥有的属性，节省内存并提高性能：</p><h4 id="slots-的工作原理与性能优势"><a href="#slots-的工作原理与性能优势" class="headerlink" title="__slots__ 的工作原理与性能优势"></a><code>__slots__</code> 的工作原理与性能优势</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment">## 不使用__slots__的普通类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用__slots__的类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PersonWithSlots</span>:</span><br><span class="line">    __slots__ = [<span class="string">'name'</span>, <span class="string">'age'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建实例</span></span><br><span class="line">p1 = Person(<span class="string">"Alice"</span>, <span class="number">30</span>)</span><br><span class="line">p2 = PersonWithSlots(<span class="string">"Bob"</span>, <span class="number">25</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 检查内存使用</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"Person实例大小: <span class="subst">{sys.getsizeof(p1)}</span> 字节"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"PersonWithSlots实例大小: <span class="subst">{sys.getsizeof(p2)}</span> 字节"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 检查属性字典</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"Person有__dict__: <span class="subst">{<span class="built_in">hasattr</span>(p1, <span class="string">'__dict__'</span>)}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"PersonWithSlots有__dict__: <span class="subst">{<span class="built_in">hasattr</span>(p2, <span class="string">'__dict__'</span>)}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 属性访问性能比较</span></span><br><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">access_person</span>():</span><br><span class="line">    p = Person(<span class="string">"Alice"</span>, <span class="number">30</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">        x = p.name</span><br><span class="line">        y = p.age</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">access_person_with_slots</span>():</span><br><span class="line">    p = PersonWithSlots(<span class="string">"Alice"</span>, <span class="number">30</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">        x = p.name</span><br><span class="line">        y = p.age</span><br><span class="line"></span><br><span class="line"><span class="comment">## 测量访问性能</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"访问Person属性时间: <span class="subst">{timeit.timeit(access_person, number=<span class="number">5</span>):<span class="number">.4</span>f}</span>秒"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"访问PersonWithSlots属性时间: <span class="subst">{timeit.timeit(access_person_with_slots, number=<span class="number">5</span>):<span class="number">.4</span>f}</span>秒"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="slots-的限制和继承行为"><a href="#slots-的限制和继承行为" class="headerlink" title="__slots__ 的限制和继承行为"></a><code>__slots__</code> 的限制和继承行为</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span>:</span><br><span class="line">    __slots__ = [<span class="string">'x'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="variable language_">self</span>.x = x</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Child</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __slots__ = [<span class="string">'y'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(x)</span><br><span class="line">        <span class="variable language_">self</span>.y = y</span><br><span class="line"></span><br><span class="line"><span class="comment">## 行为测试</span></span><br><span class="line">c = Child(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"Child实例可以访问x: <span class="subst">{c.x}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"Child实例可以访问y: <span class="subst">{c.y}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    c.z = <span class="number">3</span>  <span class="comment"># 尝试设置未在__slots__中定义的属性</span></span><br><span class="line"><span class="keyword">except</span> AttributeError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"无法设置z属性: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 检查实例字典</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"Child有__dict__: <span class="subst">{<span class="built_in">hasattr</span>(c, <span class="string">'__dict__'</span>)}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h2 id="第十二章：-异常处理"><a href="#第十二章：-异常处理" class="headerlink" title="第十二章： 异常处理"></a>第十二章： 异常处理</h2><p>异常处理是 Python 编程中的重要环节，它允许程序在遇到错误时优雅地恢复或退出，而不是直接崩溃。</p><h3 id="12-1-基本异常处理"><a href="#12-1-基本异常处理" class="headerlink" title="12.1 基本异常处理"></a>12.1 基本异常处理</h3><p>异常处理的核心是 <code>try-except</code> 结构，它允许程序捕获并处理运行时错误。</p><h4 id="12-1-1-异常的概念与意义"><a href="#12-1-1-异常的概念与意义" class="headerlink" title="12.1.1 异常的概念与意义"></a>12.1.1 异常的概念与意义</h4><p>异常是程序运行时发生的错误，会打断正常的程序执行流程。Python 提供了强大的异常处理机制，使程序能够：</p><ul><li>预测可能的错误并妥善处理</li><li>提供用户友好的错误信息</li><li>防止程序意外终止</li><li>实现优雅的错误恢复策略</li></ul><h4 id="12-1-2-基础-try-except-结构"><a href="#12-1-2-基础-try-except-结构" class="headerlink" title="12.1.2 基础 try-except 结构"></a>12.1.2 基础 try-except 结构</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 可能引发异常的代码</span></span><br><span class="line">    num = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">"请输入一个数字: "</span>))  <span class="comment"># 可能引发 ValueError</span></span><br><span class="line">    result = <span class="number">10</span> / num  <span class="comment"># 可能引发 ZeroDivisionError</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"结果是: <span class="subst">{result}</span>"</span>)</span><br><span class="line"><span class="keyword">except</span> ValueError:</span><br><span class="line">    <span class="comment"># 处理特定异常</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"输入必须是数字!"</span>)</span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">    <span class="comment"># 处理另一种特定异常</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"不能除以零!"</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="comment"># 捕获所有其他异常(不推荐这种写法)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"发生了其他错误!"</span>)</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>常见内置异常</th><th>触发场景</th><th>示例</th></tr></thead><tbody><tr><td>ValueError</td><td>传入无效值</td><td><code>int("abc")</code></td></tr><tr><td>TypeError</td><td>类型不匹配</td><td><code>"2" + 2</code></td></tr><tr><td>ZeroDivisionError</td><td>除数为零</td><td><code>10/0</code></td></tr><tr><td>IndexError</td><td>索引超出范围</td><td><code>[1,2,3][10]</code></td></tr><tr><td>KeyError</td><td>字典中不存在的键</td><td><code>{"a":1}["b"]</code></td></tr><tr><td>FileNotFoundError</td><td>文件不存在</td><td><code>open("不存在.txt")</code></td></tr><tr><td>ImportError</td><td>导入模块失败</td><td><code>import 不存在模块</code></td></tr><tr><td>AttributeError</td><td>对象没有特定属性</td><td><code>"hello".append(1)</code></td></tr></tbody></table><h3 id="12-2-完整的异常处理结构"><a href="#12-2-完整的异常处理结构" class="headerlink" title="12.2 完整的异常处理结构"></a>12.2 完整的异常处理结构</h3><p>完整的异常处理结构包括 <code>try</code>, <code>except</code>, <code>else</code>, 和 <code>finally</code> 四个部分，每个部分负责不同的功能。</p><h4 id="12-2-1-try-except-else-finally-完整结构"><a href="#12-2-1-try-except-else-finally-完整结构" class="headerlink" title="12.2.1 try-except-else-finally 完整结构"></a>12.2.1 try-except-else-finally 完整结构</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 可能引发异常的代码</span></span><br><span class="line">    num = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">"请输入一个数字: "</span>))</span><br><span class="line">    result = <span class="number">10</span> / num</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"结果是: <span class="subst">{result}</span>"</span>)</span><br><span class="line"><span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 处理特定异常，e 包含异常的详细信息</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"输入错误: <span class="subst">{e}</span>"</span>)  <span class="comment"># e 可能显示: "invalid literal for int() with base 10: 'abc'"</span></span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 处理另一种特定异常</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"除零错误: <span class="subst">{e}</span>"</span>)  <span class="comment"># e 可能显示: "division by zero"</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 处理所有其他异常(这种方式比空except更好)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"其他错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># 只有当try块中的代码执行成功且没有异常发生时执行</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"计算成功完成!"</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="comment"># 无论是否有异常都会执行的代码块</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"异常处理结束"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="12-2-2-各代码块执行条件总结"><a href="#12-2-2-各代码块执行条件总结" class="headerlink" title="12.2.2 各代码块执行条件总结"></a>12.2.2 各代码块执行条件总结</h4><table><thead><tr><th>代码块</th><th>执行条件</th><th>典型用途</th></tr></thead><tbody><tr><td><code>try</code></td><td>必定执行</td><td>放置可能出错的代码</td></tr><tr><td><code>except</code></td><td>对应类型异常发生时</td><td>处理特定类型错误</td></tr><tr><td><code>else</code></td><td>try 块无异常发生时</td><td>执行成功后的操作</td></tr><tr><td><code>finally</code></td><td>无论有无异常均执行</td><td>资源清理、释放</td></tr></tbody></table><h3 id="12-3-自定义异常"><a href="#12-3-自定义异常" class="headerlink" title="12.3 自定义异常"></a>12.3 自定义异常</h3><p>虽然 Python 提供了丰富的内置异常，但在开发特定应用时，创建自定义异常可以使代码更具可读性和针对性。</p><h4 id="12-3-1-创建自定义异常类"><a href="#12-3-1-创建自定义异常类" class="headerlink" title="12.3.1 创建自定义异常类"></a>12.3.1 创建自定义异常类</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义异常类，继承自 Exception</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InsufficientFundsError</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="string">"""当账户余额不足时引发的异常"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, balance, amount</span>):</span><br><span class="line">        <span class="variable language_">self</span>.balance = balance</span><br><span class="line">        <span class="variable language_">self</span>.amount = amount</span><br><span class="line">        <span class="comment"># 创建有意义的错误消息</span></span><br><span class="line">        <span class="variable language_">self</span>.message = <span class="string">f"余额不足: 当前余额 <span class="subst">{balance}</span> 元，尝试提取 <span class="subst">{amount}</span> 元"</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(<span class="variable language_">self</span>.message)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.message</span><br></pre></td></tr></tbody></table></figure><h4 id="12-3-2-使用自定义异常"><a href="#12-3-2-使用自定义异常" class="headerlink" title="12.3.2 使用自定义异常"></a>12.3.2 使用自定义异常</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在业务逻辑中使用自定义异常</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BankAccount</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, balance=<span class="number">0</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.balance = balance</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">withdraw</span>(<span class="params">self, amount</span>):</span><br><span class="line">        <span class="keyword">if</span> amount &gt; <span class="variable language_">self</span>.balance:</span><br><span class="line">            <span class="comment"># 在适当的条件下抛出自定义异常</span></span><br><span class="line">            <span class="keyword">raise</span> InsufficientFundsError(<span class="variable language_">self</span>.balance, amount)</span><br><span class="line">        <span class="variable language_">self</span>.balance -= amount</span><br><span class="line">        <span class="keyword">return</span> amount</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理自定义异常的实际场景</span></span><br><span class="line">account = BankAccount(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 尝试提取超过余额的金额</span></span><br><span class="line">    account.withdraw(<span class="number">150</span>)</span><br><span class="line"><span class="keyword">except</span> InsufficientFundsError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 针对性地处理特定业务异常</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"操作失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"您需要再存入至少 <span class="subst">{e.amount - e.balance}</span> 元"</span>)</span><br><span class="line">    <span class="comment"># 可以在这里提供补救措施，比如自动转入资金或提供贷款选项</span></span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>自定义异常命名惯例</th><th>示例</th><th>适用场景</th></tr></thead><tbody><tr><td>以 “Error” 结尾</td><td><code>ValidationError</code></td><td>程序错误，需纠正</td></tr><tr><td>以 “Warning” 结尾</td><td><code>DeprecationWarning</code></td><td>警告级别的问题</td></tr><tr><td>以具体领域开头</td><td><code>DatabaseConnectionError</code></td><td>特定领域的异常</td></tr></tbody></table><h3 id="12-4-异常的传播与重新抛出"><a href="#12-4-异常的传播与重新抛出" class="headerlink" title="12.4 异常的传播与重新抛出"></a>12.4 异常的传播与重新抛出</h3><p>了解异常如何在调用栈中传播以及如何重新抛出异常对于构建稳健的错误处理系统至关重要。</p><h4 id="12-4-1-异常传播机制"><a href="#12-4-1-异常传播机制" class="headerlink" title="12.4.1 异常传播机制"></a>12.4.1 异常传播机制</h4><p>当异常发生时，Python 会沿着调用栈向上查找，直到找到相应的 <code>except</code> 子句处理该异常，如果没有处理程序，程序将终止。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 异常传播示例</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_inner</span>():</span><br><span class="line">    <span class="comment"># 这里的异常会向上传播</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span> / <span class="number">0</span>  <span class="comment"># 引发 ZeroDivisionError</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_middle</span>():</span><br><span class="line">    <span class="comment"># 没有处理异常，所以异常继续传播</span></span><br><span class="line">    <span class="keyword">return</span> func_inner()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_outer</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 在这里捕获来自更深层次函数的异常</span></span><br><span class="line">        <span class="keyword">return</span> func_middle()</span><br><span class="line">    <span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"捕获了除零错误!"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用最外层函数</span></span><br><span class="line">result = func_outer()  <span class="comment"># 输出: 捕获了除零错误!</span></span><br></pre></td></tr></tbody></table></figure><h4 id="12-4-2-重新抛出异常"><a href="#12-4-2-重新抛出异常" class="headerlink" title="12.4.2 重新抛出异常"></a>12.4.2 重新抛出异常</h4><p>重新抛出异常有两种方式：</p><ol><li>直接使用 <code>raise</code> 语句不带参数</li><li>使用 <code>raise ... from ...</code> 结构表明异常的因果关系</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_data</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 尝试处理数据</span></span><br><span class="line">        result = data[<span class="number">0</span>] / data[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">        <span class="comment"># 记录错误并重新抛出当前异常</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"除数不能为零！"</span>)</span><br><span class="line">        <span class="keyword">raise</span>  <span class="comment"># 直接重新抛出当前捕获的异常</span></span><br><span class="line">    <span class="keyword">except</span> IndexError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 捕获后转换为更具体的应用级异常，并保留原始错误信息</span></span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"数据格式不正确，需要至少两个元素"</span>) <span class="keyword">from</span> e</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用函数并处理异常</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 尝试处理带有问题的数据</span></span><br><span class="line">    result = process_data([<span class="number">10</span>])  <span class="comment"># 数组只有一个元素，会引发 IndexError</span></span><br><span class="line"><span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 处理转换后的异常</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"发生错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="comment"># 访问原始异常</span></span><br><span class="line">    <span class="keyword">if</span> e.__cause__:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"原始错误: <span class="subst">{e.__cause__}</span>"</span>)  </span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>重新抛出方式</th><th>语法</th><th>适用场景</th></tr></thead><tbody><tr><td>简单重抛</td><td><code>raise</code></td><td>仅记录错误后继续传播</td></tr><tr><td>转换异常</td><td><code>raise NewError() from original_error</code></td><td>将低级异常转换为应用级异常</td></tr><tr><td>清除上下文</td><td><code>raise NewError() from None</code></td><td>隐藏原始异常(不推荐)</td></tr></tbody></table><h3 id="12-5-使用上下文管理器"><a href="#12-5-使用上下文管理器" class="headerlink" title="12.5 使用上下文管理器"></a>12.5 使用上下文管理器</h3><p>上下文管理器是 Python 的一种强大机制，通过 <code>with</code> 语句实现自动资源管理，特别适合处理需要显式打开和关闭的资源。</p><h4 id="12-5-1-with-语句和资源管理"><a href="#12-5-1-with-语句和资源管理" class="headerlink" title="12.5.1 with 语句和资源管理"></a>12.5.1 with 语句和资源管理</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文件操作 - 最常见的上下文管理器应用场景</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'file.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">'Hello, World!'</span>)</span><br><span class="line">    <span class="comment"># 可能发生异常的代码</span></span><br><span class="line">    <span class="comment"># raise ValueError("演示异常")</span></span><br><span class="line"><span class="comment"># 即使发生异常，文件也会自动关闭</span></span><br></pre></td></tr></tbody></table></figure><h4 id="12-5-2-自定义上下文管理器"><a href="#12-5-2-自定义上下文管理器" class="headerlink" title="12.5.2 自定义上下文管理器"></a>12.5.2 自定义上下文管理器</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseConnection</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, connection_string</span>):</span><br><span class="line">        <span class="variable language_">self</span>.connection_string = connection_string</span><br><span class="line">        <span class="variable language_">self</span>.connection = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""进入上下文时调用，返回值被赋给as后的变量"""</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"连接到数据库: <span class="subst">{self.connection_string}</span>"</span>)</span><br><span class="line">        <span class="comment"># 在实际应用中，这里会创建真正的数据库连接</span></span><br><span class="line">        <span class="variable language_">self</span>.connection = <span class="string">"已连接"</span>  </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.connection</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">        <span class="string">"""离开上下文时调用，无论是正常退出还是异常退出</span></span><br><span class="line"><span class="string">           参数: 异常类型、异常值、异常回溯信息"""</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"关闭数据库连接"</span>)</span><br><span class="line">        <span class="comment"># 释放资源</span></span><br><span class="line">        <span class="variable language_">self</span>.connection = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回值决定异常处理:</span></span><br><span class="line">        <span class="comment"># - True: 表示异常已处理，不再传播</span></span><br><span class="line">        <span class="comment"># - False/None: 表示需要继续传播异常</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>  <span class="comment"># 让异常继续传播</span></span><br></pre></td></tr></tbody></table></figure><h4 id="12-5-3-实际应用场景"><a href="#12-5-3-实际应用场景" class="headerlink" title="12.5.3 实际应用场景"></a>12.5.3 实际应用场景</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用自定义上下文管理器进行数据库操作</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> DatabaseConnection(<span class="string">"mysql://localhost/mydb"</span>) <span class="keyword">as</span> conn:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"使用连接: <span class="subst">{conn}</span>"</span>)</span><br><span class="line">        <span class="comment"># 数据库操作代码</span></span><br><span class="line">        <span class="comment"># 模拟操作失败</span></span><br><span class="line">        <span class="comment"># raise ValueError("数据插入失败")</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"捕获到异常: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="comment"># 处理数据库操作异常</span></span><br><span class="line">    <span class="comment"># 可能的恢复策略: 重试、记录日志、发送报警等</span></span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>常见上下文管理器</th><th>示例</th><th>自动管理的资源</th></tr></thead><tbody><tr><td><code>open()</code></td><td><code>with open('file.txt') as f:</code></td><td>文件句柄</td></tr><tr><td><code>threading.Lock()</code></td><td><code>with lock:</code></td><td>线程锁</td></tr><tr><td><code>contextlib.suppress()</code></td><td><code>with suppress(FileNotFoundError):</code></td><td>忽略特定异常</td></tr><tr><td><code>tempfile.NamedTemporaryFile()</code></td><td><code>with NamedTemporaryFile() as tmp:</code></td><td>临时文件</td></tr><tr><td><code>requests.Session()</code></td><td><code>with Session() as session:</code></td><td>HTTP 会话</td></tr></tbody></table><h4 id="12-5-4-使用-contextlib-简化上下文管理器创建"><a href="#12-5-4-使用-contextlib-简化上下文管理器创建" class="headerlink" title="12.5.4 使用 contextlib 简化上下文管理器创建"></a>12.5.4 使用 contextlib 简化上下文管理器创建</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">file_manager</span>(<span class="params">filename, mode</span>):</span><br><span class="line">    <span class="string">"""一个使用生成器函数创建的上下文管理器"""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 设置阶段 - 获取资源</span></span><br><span class="line">        f = <span class="built_in">open</span>(filename, mode)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"文件 <span class="subst">{filename}</span> 已打开"</span>)</span><br><span class="line">        <span class="comment"># yield 语句将控制权传递给 with 块内的代码</span></span><br><span class="line">        <span class="keyword">yield</span> f</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 清理阶段 - 释放资源</span></span><br><span class="line">        f.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"文件 <span class="subst">{filename}</span> 已关闭"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用自定义上下文管理器</span></span><br><span class="line"><span class="keyword">with</span> file_manager(<span class="string">'example.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(<span class="string">'这是一个使用contextlib创建的上下文管理器示例'</span>)</span><br></pre></td></tr></tbody></table></figure><h3 id="12-6-异常处理最佳实践"><a href="#12-6-异常处理最佳实践" class="headerlink" title="12.6 异常处理最佳实践"></a>12.6 异常处理最佳实践</h3><p>掌握异常处理的模式和反模式对于编写健壮的代码至关重要。</p><h4 id="12-6-1-不良实践与改进"><a href="#12-6-1-不良实践与改进" class="headerlink" title="12.6.1 不良实践与改进"></a>12.6.1 不良实践与改进</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不好的做法：过于宽泛的异常捕获</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bad_practice</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 大量不同类型的操作混在一起</span></span><br><span class="line">        config = <span class="built_in">open</span>(<span class="string">"config.ini"</span>).read()</span><br><span class="line">        settings = parse_config(config)</span><br><span class="line">        result = process_data(settings)</span><br><span class="line">        save_result(result)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="comment"># 捕获所有异常，无法区分不同错误</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"出错了"</span>)</span><br><span class="line">        <span class="comment"># 无法提供有价值的错误信息</span></span><br><span class="line">        <span class="comment"># 无法针对性恢复</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 好的做法：精确捕获和处理异常</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">good_practice</span>():</span><br><span class="line">    config = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 只包含读取配置文件的代码</span></span><br><span class="line">        config = <span class="built_in">open</span>(<span class="string">"config.ini"</span>)</span><br><span class="line">        config_text = config.read()</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="comment"># 针对性处理配置文件缺失</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"配置文件不存在，将使用默认配置"</span>)</span><br><span class="line">        config_text = DEFAULT_CONFIG</span><br><span class="line">    <span class="keyword">except</span> PermissionError:</span><br><span class="line">        <span class="comment"># 针对性处理权限问题</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"没有读取配置文件的权限"</span>)</span><br><span class="line">        <span class="comment"># 可以请求提升权限或使用备用方案</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 确保文件被关闭</span></span><br><span class="line">        <span class="keyword">if</span> config:</span><br><span class="line">            config.close()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 解析配置的代码单独放在try块中</span></span><br><span class="line">        settings = parse_config(config_text)</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 处理配置格式错误</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"配置格式错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 后续操作...</span></span><br></pre></td></tr></tbody></table></figure><h4 id="12-6-2-实际开发中的异常处理策略"><a href="#12-6-2-实际开发中的异常处理策略" class="headerlink" title="12.6.2 实际开发中的异常处理策略"></a>12.6.2 实际开发中的异常处理策略</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分层异常处理示例 - Web应用请求处理</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 底层数据访问层: 转换为应用层可理解的异常</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_user_data</span>(<span class="params">user_id</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 数据库操作</span></span><br><span class="line">        connection = get_db_connection()</span><br><span class="line">        cursor = connection.cursor()</span><br><span class="line">        cursor.execute(<span class="string">"SELECT * FROM users WHERE id = %s"</span>, (user_id,))</span><br><span class="line">        result = cursor.fetchone()</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">except</span> MySQLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 转换为应用级异常</span></span><br><span class="line">        <span class="keyword">if</span> e.errno == <span class="number">1045</span>:  <span class="comment"># 访问被拒绝</span></span><br><span class="line">            <span class="keyword">raise</span> DatabaseAccessError(<span class="string">"数据库访问被拒绝"</span>) <span class="keyword">from</span> e</span><br><span class="line">        <span class="keyword">elif</span> e.errno == <span class="number">2003</span>:  <span class="comment"># 连接失败</span></span><br><span class="line">            <span class="keyword">raise</span> DatabaseConnectionError(<span class="string">"无法连接到数据库"</span>) <span class="keyword">from</span> e</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> DatabaseError(<span class="string">f"数据库错误: <span class="subst">{e}</span>"</span>) <span class="keyword">from</span> e</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 资源清理</span></span><br><span class="line">        cursor.close()</span><br><span class="line">        connection.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 业务逻辑层: 处理应用级异常</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_profile</span>(<span class="params">user_id</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user_data = fetch_user_data(user_id)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_data:</span><br><span class="line">            <span class="comment"># 应用逻辑异常</span></span><br><span class="line">            <span class="keyword">raise</span> UserNotFoundError(<span class="string">f"用户ID <span class="subst">{user_id}</span> 不存在"</span>)</span><br><span class="line">        <span class="keyword">return</span> format_user_profile(user_data)</span><br><span class="line">    <span class="keyword">except</span> DatabaseError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 日志记录并决定是否传播</span></span><br><span class="line">        logger.error(<span class="string">f"获取用户数据失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="comment"># 可能的重试策略</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(e, DatabaseConnectionError) <span class="keyword">and</span> retry_count &lt; MAX_RETRIES:</span><br><span class="line">            <span class="keyword">return</span> get_user_profile_with_retry(user_id, retry_count + <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 传播异常供上层处理</span></span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 接口层: 向用户展示友好错误</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">api_get_user</span>(<span class="params">request, user_id</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        profile = get_user_profile(user_id)</span><br><span class="line">        <span class="keyword">return</span> JSONResponse(status_code=<span class="number">200</span>, content=profile)</span><br><span class="line">    <span class="keyword">except</span> UserNotFoundError:</span><br><span class="line">        <span class="comment"># 返回适当的HTTP状态码</span></span><br><span class="line">        <span class="keyword">return</span> JSONResponse(status_code=<span class="number">404</span>, content={<span class="string">"error"</span>: <span class="string">"用户不存在"</span>})</span><br><span class="line">    <span class="keyword">except</span> DatabaseConnectionError:</span><br><span class="line">        <span class="comment"># 返回服务暂时不可用</span></span><br><span class="line">        <span class="keyword">return</span> JSONResponse(status_code=<span class="number">503</span>, content={<span class="string">"error"</span>: <span class="string">"服务暂时不可用"</span>})</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 意外错误: 记录并返回通用错误</span></span><br><span class="line">        logger.critical(<span class="string">f"未处理的错误: <span class="subst">{e}</span>"</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> JSONResponse(status_code=<span class="number">500</span>, content={<span class="string">"error"</span>: <span class="string">"服务器内部错误"</span>})</span><br></pre></td></tr></tbody></table></figure><h3 id="12-7-高级异常处理技术"><a href="#12-7-高级异常处理技术" class="headerlink" title="12.7 高级异常处理技术"></a>12.7 高级异常处理技术</h3><h4 id="12-7-1-使用装饰器简化异常处理"><a href="#12-7-1-使用装饰器简化异常处理" class="headerlink" title="12.7.1 使用装饰器简化异常处理"></a>12.7.1 使用装饰器简化异常处理</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">retry</span>(<span class="params">max_attempts=<span class="number">3</span>, delay=<span class="number">1</span></span>):</span><br><span class="line">    <span class="string">"""一个用于自动重试的装饰器</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">        max_attempts: 最大尝试次数</span></span><br><span class="line"><span class="string">        delay: 重试之间的延迟(秒)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">func</span>):</span><br><span class="line"><span class="meta">        @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">            attempts = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> attempts &lt; max_attempts:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">                <span class="keyword">except</span> (ConnectionError, TimeoutError) <span class="keyword">as</span> e:</span><br><span class="line">                    attempts += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> attempts &gt;= max_attempts:</span><br><span class="line">                        <span class="keyword">raise</span>  <span class="comment"># 达到最大尝试次数，重新抛出异常</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f"操作失败: <span class="subst">{e}</span>，<span class="subst">{delay}</span>秒后重试 (<span class="subst">{attempts}</span>/<span class="subst">{max_attempts}</span>)"</span>)</span><br><span class="line">                    time.sleep(delay)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># 不会执行到这里</span></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用重试装饰器</span></span><br><span class="line"><span class="meta">@retry(<span class="params">max_attempts=<span class="number">3</span>, delay=<span class="number">2</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">connect_to_server</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="string">"""连接到远程服务器，可能会失败"""</span></span><br><span class="line">    <span class="keyword">import</span> random</span><br><span class="line">    <span class="keyword">if</span> random.random() &lt; <span class="number">0.7</span>:  <span class="comment"># 模拟70%的失败率</span></span><br><span class="line">        <span class="keyword">raise</span> ConnectionError(<span class="string">"连接服务器失败"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"连接成功"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用带重试功能的函数</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = connect_to_server(<span class="string">"https://example.com"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"结果: <span class="subst">{result}</span>"</span>)</span><br><span class="line"><span class="keyword">except</span> ConnectionError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"连接服务器最终失败"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="12-7-2-异常链与异常组"><a href="#12-7-2-异常链与异常组" class="headerlink" title="12.7.2 异常链与异常组"></a>12.7.2 异常链与异常组</h4><p>Python 3.10+ 引入了异常组(ExceptionGroup)和 except*语法，用于处理多个异常同时存在的情况：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Python 3.10+ 特性：异常组</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_multiple_tasks</span>():</span><br><span class="line">    <span class="comment"># 用于收集任务处理过程中的错误</span></span><br><span class="line">    exceptions: <span class="type">List</span>[<span class="built_in">tuple</span>[<span class="built_in">str</span>, Exception]] = []</span><br><span class="line"></span><br><span class="line">    tasks = [(<span class="string">"task1"</span>, <span class="number">0</span>), (<span class="string">"task2"</span>, <span class="number">2</span>), (<span class="string">"task3"</span>, <span class="string">"not_a_number"</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> task_name, value <span class="keyword">in</span> tasks:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 尝试处理任务</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"处理任务 <span class="subst">{task_name}</span>，输入值为 <span class="subst">{value}</span>"</span>)</span><br><span class="line">            result = <span class="number">10</span> / value</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"任务 <span class="subst">{task_name}</span> 处理结果为 <span class="subst">{result}</span>"</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            exceptions.append((task_name, e))</span><br><span class="line">    <span class="comment"># 如果有错误，以异常组的形式抛出</span></span><br><span class="line">    <span class="keyword">if</span> exceptions:</span><br><span class="line">        <span class="keyword">raise</span> ExceptionGroup(<span class="string">"处理任务过程中发生错误"</span>,</span><br><span class="line">                             [ValueError(<span class="string">f"任务 <span class="subst">{name}</span> 处理失败：<span class="subst">{err}</span>"</span>) <span class="keyword">for</span> name, err <span class="keyword">in</span> exceptions])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用except*处理异常组</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    process_multiple_tasks()</span><br><span class="line"><span class="keyword">except</span>* ZeroDivisionError <span class="keyword">as</span> eg:</span><br><span class="line">    <span class="comment"># 处理所有除零错误</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"除零错误: <span class="subst">{eg.exceptions}</span>"</span>) <span class="comment"># 这里就可以抓到task1的异常</span></span><br><span class="line"><span class="keyword">except</span>* TypeError <span class="keyword">as</span> eg:</span><br><span class="line">    <span class="comment"># 处理所有类型错误</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"类型错误: <span class="subst">{eg.exceptions}</span>"</span>) <span class="comment"># 这里就可以抓到task3的异常</span></span><br><span class="line"><span class="keyword">except</span>* Exception <span class="keyword">as</span> eg:</span><br><span class="line">    <span class="comment"># 处理其他所有错误</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"其他错误: <span class="subst">{eg.exceptions}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="12-7-3-EAFP-vs-LBYL-编程风格"><a href="#12-7-3-EAFP-vs-LBYL-编程风格" class="headerlink" title="12.7.3 EAFP vs LBYL 编程风格"></a>12.7.3 EAFP vs LBYL 编程风格</h4><p>Python 通常推崇 EAFP（”Easier to Ask Forgiveness than Permission”）而非 LBYL（”Look Before You Leap”）：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># LBYL风格（先检查后操作）</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">'key'</span> <span class="keyword">in</span> my_dict <span class="keyword">and</span> my_dict[<span class="string">'key'</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    value = my_dict[<span class="string">'key'</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    value = <span class="string">'default'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EAFP风格（先操作后处理异常）</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    value = my_dict[<span class="string">'key'</span>]</span><br><span class="line"><span class="keyword">except</span> (KeyError, TypeError):</span><br><span class="line">    value = <span class="string">'default'</span></span><br></pre></td></tr></tbody></table></figure><h2 id="第十三章：-高级数据处理"><a href="#第十三章：-高级数据处理" class="headerlink" title="第十三章： 高级数据处理"></a>第十三章： 高级数据处理</h2><p>Python 提供了多种处理不同类型数据的工具和库，能够轻松处理结构化和非结构化数据。本章将深入探讨 Python 中常用的数据格式处理技术，包括 JSON、CSV、XML 和配置文件等。</p><h3 id="13-1-JSON-处理"><a href="#13-1-JSON-处理" class="headerlink" title="13.1 JSON 处理"></a>13.1 JSON 处理</h3><p>JSON (JavaScript Object Notation) 是一种轻量级的数据交换格式，易于人阅读和编写，也易于机器解析和生成。Python 通过内置的 <code>json</code> 模块提供了 JSON 的序列化和反序列化功能。</p><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td><code>json.dump(obj, fp)</code></td><td>将 Python 对象 <code>obj</code> 编码为 JSON 格式并写入文件 <code>fp</code>。</td></tr><tr><td><code>json.dumps(obj)</code></td><td>将 Python 对象 <code>obj</code> 编码为 JSON 格式并返回字符串。</td></tr><tr><td><code>json.load(fp)</code></td><td>从文件 <code>fp</code> 读取 JSON 数据并解码为 Python 对象。</td></tr><tr><td><code>json.loads(s)</code></td><td>将字符串 <code>s</code> 解码为 Python 对象。</td></tr></tbody></table><h4 id="13-1-1-基本操作"><a href="#13-1-1-基本操作" class="headerlink" title="13.1.1 基本操作"></a>13.1.1 基本操作</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python对象转JSON</span></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"张三"</span>,</span><br><span class="line">    <span class="string">"age"</span>: <span class="number">30</span>,</span><br><span class="line">    <span class="string">"is_student"</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">"courses"</span>: [<span class="string">"Python"</span>, <span class="string">"数据分析"</span>, <span class="string">"机器学习"</span>],</span><br><span class="line">    <span class="string">"scores"</span>: {<span class="string">"Python"</span>: <span class="number">95</span>, <span class="string">"数据分析"</span>: <span class="number">88</span>}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换为JSON字符串</span></span><br><span class="line">json_str = json.dumps(data, ensure_ascii=<span class="literal">False</span>, indent=<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(json_str)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入JSON文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"data.json"</span>, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    json.dump(data, f, ensure_ascii=<span class="literal">False</span>, indent=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从JSON字符串解析</span></span><br><span class="line">parsed_data = json.loads(json_str)</span><br><span class="line"><span class="built_in">print</span>(parsed_data[<span class="string">"name"</span>])  <span class="comment"># 张三</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从JSON文件读取</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"data.json"</span>, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    loaded_data = json.load(f)</span><br><span class="line">    <span class="built_in">print</span>(loaded_data[<span class="string">"scores"</span>][<span class="string">"Python"</span>])  <span class="comment"># 95</span></span><br></pre></td></tr></tbody></table></figure><h4 id="13-1-2-重要参数说明"><a href="#13-1-2-重要参数说明" class="headerlink" title="13.1.2 重要参数说明"></a>13.1.2 重要参数说明</h4><table><thead><tr><th>参数</th><th>说明</th><th>用法示例</th></tr></thead><tbody><tr><td><code>ensure_ascii</code></td><td>是否转义非 ASCII 字符，False 时保留原始字符</td><td><code>json.dumps(data, ensure_ascii=False)</code></td></tr><tr><td><code>indent</code></td><td>缩进格式，美化输出</td><td><code>json.dumps(data, indent=4)</code></td></tr><tr><td><code>separators</code></td><td>指定分隔符，用于紧凑输出</td><td><code>json.dumps(data, separators=(',', ':'))</code></td></tr><tr><td><code>sort_keys</code></td><td>是否按键排序</td><td><code>json.dumps(data, sort_keys=True)</code></td></tr><tr><td><code>default</code></td><td>指定序列化函数，处理不可序列化对象</td><td><code>json.dumps(obj, default=lambda o: o.__dict__)</code></td></tr></tbody></table><h4 id="13-1-3-自定义对象序列化"><a href="#13-1-3-自定义对象序列化" class="headerlink" title="13.1.3 自定义对象序列化"></a>13.1.3 自定义对象序列化</h4><p>Python 的 <code>json</code> 模块默认无法直接序列化自定义类对象，但提供了多种方式解决：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 方法一：提供default参数 ==========</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">person_to_dict</span>(<span class="params">person</span>):</span><br><span class="line">    <span class="string">"""将Person对象转换为字典"""</span></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="string">"name"</span>: person.name,</span><br><span class="line">        <span class="string">"age"</span>: person.age</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：使用default参数序列化自定义对象</span></span><br><span class="line">person = Person(<span class="string">"李四"</span>, <span class="number">25</span>)</span><br><span class="line">json_str = json.dumps(person, default=person_to_dict, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(json_str)  <span class="comment"># {"name": "李四", "age": 25}</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 方法二：通过自定义编码器 ==========</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PersonEncoder</span>(json.JSONEncoder):</span><br><span class="line">    <span class="string">"""自定义JSON编码器处理Person类"""</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">default</span>(<span class="params">self, obj</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Person):</span><br><span class="line">            <span class="keyword">return</span> {<span class="string">"name"</span>: obj.name, <span class="string">"age"</span>: obj.age}</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().default(obj)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：使用自定义编码器序列化对象</span></span><br><span class="line">json_str = json.dumps(person, cls=PersonEncoder, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(json_str)  <span class="comment"># {"name": "李四", "age": 25}</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 方法三：添加to_json方法 ==========</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, grade</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.grade = grade</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"Student('<span class="subst">{self.name}</span>', <span class="subst">{self.grade}</span>)"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_json</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""返回可JSON序列化的字典"""</span></span><br><span class="line">        <span class="keyword">return</span> {</span><br><span class="line">            <span class="string">"name"</span>: <span class="variable language_">self</span>.name,</span><br><span class="line">            <span class="string">"grade"</span>: <span class="variable language_">self</span>.grade</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：使用对象的to_json方法序列化</span></span><br><span class="line">students = [Student(<span class="string">"小明"</span>, <span class="number">90</span>), Student(<span class="string">"小红"</span>, <span class="number">88</span>)]</span><br><span class="line">json_str = json.dumps([s.to_json() <span class="keyword">for</span> s <span class="keyword">in</span> students], ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(json_str)  <span class="comment"># [{"name": "小明", "grade": 90}, {"name": "小红", "grade": 88}]</span></span><br></pre></td></tr></tbody></table></figure><h4 id="13-1-4-JSON-解码为自定义对象"><a href="#13-1-4-JSON-解码为自定义对象" class="headerlink" title="13.1.4 JSON 解码为自定义对象"></a>13.1.4 JSON 解码为自定义对象</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name: <span class="built_in">str</span>, age: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"<span class="subst">{self.name}</span>(<span class="subst">{self.age}</span>)"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dict_to_person</span>(<span class="params">data: <span class="type">Dict</span></span>) -&gt; Person:</span><br><span class="line">    <span class="keyword">return</span> Person(data[<span class="string">"name"</span>], data[<span class="string">"age"</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 json.loads() 的 object_hook 参数将 JSON 字符串直接转换为自定义对象</span></span><br><span class="line"><span class="comment"># object_hook 的用途:</span></span><br><span class="line"><span class="comment"># 1. 自动将 JSON 解析出的字典转换为自定义类的实例</span></span><br><span class="line"><span class="comment"># 2. 在解析 JSON 时进行数据转换和验证</span></span><br><span class="line"><span class="comment"># 3. 简化从 JSON 到对象模型的映射过程</span></span><br><span class="line"><span class="comment"># 4. 避免手动创建对象的繁琐步骤</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作原理:</span></span><br><span class="line"><span class="comment"># - json.loads() 首先将 JSON 字符串解析为 Python 字典</span></span><br><span class="line"><span class="comment"># - 然后对每个解析出的字典调用 object_hook 函数</span></span><br><span class="line"><span class="comment"># - object_hook 函数返回的对象将替代原始字典</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 实际应用场景:</span></span><br><span class="line"><span class="comment"># - API 响应数据转换为应用程序对象模型</span></span><br><span class="line"><span class="comment"># - 配置文件解析为配置对象</span></span><br><span class="line"><span class="comment"># - 数据导入时的格式转换</span></span><br><span class="line"></span><br><span class="line">person_data = <span class="string">'{"name": "Alice", "age": 25}'</span></span><br><span class="line">person = json.loads(person_data, object_hook=dict_to_person)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(person))  <span class="comment"># &lt;class '__main__.Person'&gt;</span></span><br><span class="line"><span class="built_in">print</span>([person.name, person.age])  <span class="comment"># ['Alice', 25]</span></span><br><span class="line"><span class="built_in">print</span>(person)  <span class="comment"># Alice(25)</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="13-1-5-处理复杂-JSON-数据"><a href="#13-1-5-处理复杂-JSON-数据" class="headerlink" title="13.1.5 处理复杂 JSON 数据"></a>13.1.5 处理复杂 JSON 数据</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 处理嵌套结构</span></span><br><span class="line">nested_json = <span class="string">'''</span></span><br><span class="line"><span class="string">{</span></span><br><span class="line"><span class="string">    "company": "ABC Corp",</span></span><br><span class="line"><span class="string">    "employees": [</span></span><br><span class="line"><span class="string">        {"name": "张三", "department": "技术", "skills": ["Python", "Java"]},</span></span><br><span class="line"><span class="string">        {"name": "李四", "department": "市场", "skills": ["营销", "策划"]}</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    "locations": {</span></span><br><span class="line"><span class="string">        "headquarters": "北京",</span></span><br><span class="line"><span class="string">        "branches": ["上海", "广州", "深圳"]</span></span><br><span class="line"><span class="string">    }</span></span><br><span class="line"><span class="string">}</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">data = json.loads(nested_json)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问嵌套数据</span></span><br><span class="line"><span class="built_in">print</span>(data[<span class="string">"employees"</span>][<span class="number">0</span>][<span class="string">"name"</span>])        <span class="comment"># 张三</span></span><br><span class="line"><span class="built_in">print</span>(data[<span class="string">"employees"</span>][<span class="number">0</span>][<span class="string">"skills"</span>][<span class="number">0</span>])   <span class="comment"># Python</span></span><br><span class="line"><span class="built_in">print</span>(data[<span class="string">"locations"</span>][<span class="string">"branches"</span>][<span class="number">1</span>])    <span class="comment"># 广州</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改嵌套数据</span></span><br><span class="line">data[<span class="string">"employees"</span>][<span class="number">0</span>][<span class="string">"skills"</span>].append(<span class="string">"C++"</span>)</span><br><span class="line">data[<span class="string">"locations"</span>][<span class="string">"branches"</span>].append(<span class="string">"成都"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存修改后的数据</span></span><br><span class="line">updated_json = json.dumps(data, ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(updated_json)</span><br></pre></td></tr></tbody></table></figure><h4 id="13-1-6-性能优化"><a href="#13-1-6-性能优化" class="headerlink" title="13.1.6 性能优化"></a>13.1.6 性能优化</h4><p>处理大型 JSON 文件时，可以使用流式解析来提高性能：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ijson  <span class="comment"># 需安装: pip install ijson</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 流式解析大型JSON文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"large_file.json"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># 只提取特定字段</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> ijson.items(f, <span class="string">"items.item"</span>):</span><br><span class="line">        <span class="built_in">print</span>(item[<span class="string">"id"</span>], item[<span class="string">"name"</span>])</span><br><span class="line">        <span class="comment"># 处理一项后继续，不必载入整个文件</span></span><br></pre></td></tr></tbody></table></figure><h4 id="13-1-7-JSON-Schema-验证"><a href="#13-1-7-JSON-Schema-验证" class="headerlink" title="13.1.7 JSON Schema 验证"></a>13.1.7 JSON Schema 验证</h4><p>验证 JSON 数据是否符合预期格式：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jsonschema <span class="keyword">import</span> validate  <span class="comment"># 需安装: pip install jsonschema</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义JSON Schema</span></span><br><span class="line">schema = {</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"object"</span>,</span><br><span class="line">    <span class="string">"properties"</span>: {</span><br><span class="line">        <span class="string">"name"</span>: {<span class="string">"type"</span>: <span class="string">"string"</span>},</span><br><span class="line">        <span class="string">"age"</span>: {<span class="string">"type"</span>: <span class="string">"integer"</span>, <span class="string">"minimum"</span>: <span class="number">0</span>},</span><br><span class="line">        <span class="string">"email"</span>: {<span class="string">"type"</span>: <span class="string">"string"</span>, <span class="string">"format"</span>: <span class="string">"email"</span>}</span><br><span class="line">    },</span><br><span class="line">    <span class="string">"required"</span>: [<span class="string">"name"</span>, <span class="string">"age"</span>]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证数据</span></span><br><span class="line">valid_data = {<span class="string">"name"</span>: <span class="string">"张三"</span>, <span class="string">"age"</span>: <span class="number">30</span>, <span class="string">"email"</span>: <span class="string">"zhangsan@example.com"</span>}</span><br><span class="line">invalid_data = {<span class="string">"name"</span>: <span class="string">"李四"</span>, <span class="string">"age"</span>: -<span class="number">5</span>}</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    validate(instance=valid_data, schema=schema)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"有效数据"</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"验证失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    validate(instance=invalid_data, schema=schema)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"有效数据"</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"验证失败: <span class="subst">{e}</span>"</span>)  <span class="comment"># 会因age小于0而失败</span></span><br></pre></td></tr></tbody></table></figure><h3 id="13-2-CSV-处理"><a href="#13-2-CSV-处理" class="headerlink" title="13.2 CSV 处理"></a>13.2 CSV 处理</h3><p>CSV (Comma-Separated Values) 是一种常见的表格数据格式。Python 的 <code>csv</code> 模块提供了读写 CSV 文件的功能，适用于处理电子表格和数据库导出数据。</p><blockquote><p>在我们写入中文数据时，尽量将编码更换为 <code>GBK</code> 否则写入 CSV 会导致一些乱码问题</p></blockquote><h4 id="13-2-1-基本读写操作"><a href="#13-2-1-基本读写操作" class="headerlink" title="13.2.1 基本读写操作"></a>13.2.1 基本读写操作</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入CSV文件</span></span><br><span class="line">data = [</span><br><span class="line">    [<span class="string">"姓名"</span>, <span class="string">"年龄"</span>, <span class="string">"城市"</span>],</span><br><span class="line">    [<span class="string">"张三"</span>, <span class="number">30</span>, <span class="string">"北京"</span>],</span><br><span class="line">    [<span class="string">"李四"</span>, <span class="number">25</span>, <span class="string">"上海"</span>],</span><br><span class="line">    [<span class="string">"王五"</span>, <span class="number">28</span>, <span class="string">"广州"</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"people.csv"</span>, <span class="string">"w"</span>, newline=<span class="string">""</span>, encoding=<span class="string">"gbk"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    writer = csv.writer(f)</span><br><span class="line">    writer.writerows(data)  <span class="comment"># 一次写入多行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 逐行写入</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"people_row.csv"</span>, <span class="string">"w"</span>, newline=<span class="string">""</span>, encoding=<span class="string">"gbk"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    writer = csv.writer(f)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> data:</span><br><span class="line">        writer.writerow(row)  <span class="comment"># 一次写入一行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取CSV文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"people.csv"</span>, <span class="string">"r"</span>, encoding=<span class="string">"gbk"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    reader = csv.reader(f)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br></pre></td></tr></tbody></table></figure><h4 id="13-2-2-使用字典处理-CSV-文件"><a href="#13-2-2-使用字典处理-CSV-文件" class="headerlink" title="13.2.2 使用字典处理 CSV 文件"></a>13.2.2 使用字典处理 CSV 文件</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用字典写入CSV</span></span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line">dict_data = [</span><br><span class="line">    {<span class="string">"姓名"</span>: <span class="string">"张三"</span>, <span class="string">"年龄"</span>: <span class="number">30</span>, <span class="string">"城市"</span>: <span class="string">"北京"</span>},</span><br><span class="line">    {<span class="string">"姓名"</span>: <span class="string">"李四"</span>, <span class="string">"年龄"</span>: <span class="number">25</span>, <span class="string">"城市"</span>: <span class="string">"上海"</span>},</span><br><span class="line">    {<span class="string">"姓名"</span>: <span class="string">"王五"</span>, <span class="string">"年龄"</span>: <span class="number">28</span>, <span class="string">"城市"</span>: <span class="string">"广州"</span>}</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"people_dict.csv"</span>, <span class="string">"w"</span>, newline=<span class="string">""</span>, encoding=<span class="string">"gbk"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    fieldnames = [<span class="string">"姓名"</span>, <span class="string">"年龄"</span>, <span class="string">"城市"</span>]</span><br><span class="line">    writer = csv.DictWriter(f, fieldnames=fieldnames)</span><br><span class="line">    writer.writeheader()  <span class="comment"># 写入表头</span></span><br><span class="line">    writer.writerows(dict_data)  <span class="comment"># 写入多行数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用字典读取CSV</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"people_dict.csv"</span>, <span class="string">"r"</span>, encoding=<span class="string">"gbk"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    reader = csv.DictReader(f)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{row[<span class="string">'姓名'</span>]}</span> (<span class="subst">{row[<span class="string">'年龄'</span>]}</span>岁) 来自 <span class="subst">{row[<span class="string">'城市'</span>]}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="13-2-3-CSV-方言与格式化选项"><a href="#13-2-3-CSV-方言与格式化选项" class="headerlink" title="13.2.3 CSV 方言与格式化选项"></a>13.2.3 CSV 方言与格式化选项</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义CSV方言</span></span><br><span class="line">csv.register_dialect(</span><br><span class="line">    <span class="string">'tab_dialect'</span>,</span><br><span class="line">    delimiter=<span class="string">'\t'</span>,       <span class="comment"># 使用制表符作为分隔符</span></span><br><span class="line">    quotechar=<span class="string">'"'</span>,        <span class="comment"># 引号字符</span></span><br><span class="line">    escapechar=<span class="string">'\\'</span>,      <span class="comment"># 转义字符</span></span><br><span class="line">    doublequote=<span class="literal">False</span>,    <span class="comment"># 不使用双引号转义</span></span><br><span class="line">    quoting=csv.QUOTE_MINIMAL  <span class="comment"># 最小引用策略</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用自定义方言</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"tab_data.csv"</span>, <span class="string">"w"</span>, newline=<span class="string">""</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    writer = csv.writer(f, dialect=<span class="string">'tab_dialect'</span>)</span><br><span class="line">    writer.writerows(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常见格式化选项</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"formatted.csv"</span>, <span class="string">"w"</span>, newline=<span class="string">""</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    writer = csv.writer(</span><br><span class="line">        f,</span><br><span class="line">        delimiter=<span class="string">','</span>,          <span class="comment"># 分隔符</span></span><br><span class="line">        quotechar=<span class="string">'"'</span>,          <span class="comment"># 引号字符</span></span><br><span class="line">        quoting=csv.QUOTE_NONNUMERIC,  <span class="comment"># 为非数值字段添加引号</span></span><br><span class="line">        escapechar=<span class="string">'\\'</span>,        <span class="comment"># 转义字符</span></span><br><span class="line">        lineterminator=<span class="string">'\n'</span>     <span class="comment"># 行终止符</span></span><br><span class="line">    )</span><br><span class="line">    writer.writerows(data)</span><br></pre></td></tr></tbody></table></figure><h4 id="13-2-4-处理特殊情况"><a href="#13-2-4-处理特殊情况" class="headerlink" title="13.2.4 处理特殊情况"></a>13.2.4 处理特殊情况</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 处理含有引号和逗号的数据</span></span><br><span class="line">complex_data = [</span><br><span class="line">    [<span class="string">"产品"</span>, <span class="string">"描述"</span>, <span class="string">"价格"</span>],</span><br><span class="line">    [<span class="string">"笔记本"</span>, <span class="string">"14\" 高配, i7处理器"</span>, <span class="number">5999.99</span>],</span><br><span class="line">    [<span class="string">"手机"</span>, <span class="string">"5.5\" 屏幕, 双卡双待"</span>, <span class="number">2999.50</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"complex.csv"</span>, <span class="string">"w"</span>, newline=<span class="string">""</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    writer = csv.writer(f, quoting=csv.QUOTE_ALL)  <span class="comment"># 所有字段加引号</span></span><br><span class="line">    writer.writerows(complex_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过特定行</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"complex.csv"</span>, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    reader = csv.reader(f)</span><br><span class="line">    <span class="built_in">next</span>(reader)  <span class="comment"># 跳过表头</span></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理缺失值</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"missing.csv"</span>, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    reader = csv.reader(f)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">        <span class="comment"># 将空字符串转换为None</span></span><br><span class="line">        processed_row = [<span class="literal">None</span> <span class="keyword">if</span> cell == <span class="string">''</span> <span class="keyword">else</span> cell <span class="keyword">for</span> cell <span class="keyword">in</span> row]</span><br><span class="line">        <span class="built_in">print</span>(processed_row)</span><br></pre></td></tr></tbody></table></figure><h4 id="13-2-5-CSV-文件的高级操作"><a href="#13-2-5-CSV-文件的高级操作" class="headerlink" title="13.2.5 CSV 文件的高级操作"></a>13.2.5 CSV 文件的高级操作</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 过滤行</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"people.csv"</span>, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    reader = csv.DictReader(f)</span><br><span class="line">    <span class="comment"># 筛选年龄大于25的记录</span></span><br><span class="line">    filtered_data = [row <span class="keyword">for</span> row <span class="keyword">in</span> reader <span class="keyword">if</span> <span class="built_in">int</span>(row[<span class="string">"年龄"</span>]) &gt; <span class="number">25</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算统计值</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"grades.csv"</span>, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    reader = csv.DictReader(f)</span><br><span class="line">    <span class="comment"># 计算平均分</span></span><br><span class="line">    scores = [<span class="built_in">float</span>(row[<span class="string">"分数"</span>]) <span class="keyword">for</span> row <span class="keyword">in</span> reader]</span><br><span class="line">    avg_score = <span class="built_in">sum</span>(scores) / <span class="built_in">len</span>(scores)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"平均分: <span class="subst">{avg_score:<span class="number">.2</span>f}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并多个CSV文件</span></span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge_csv_files</span>(<span class="params">file_pattern, output_file</span>):</span><br><span class="line">    <span class="comment"># 获取所有匹配的文件</span></span><br><span class="line">    all_files = glob.glob(file_pattern)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">"w"</span>, newline=<span class="string">""</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> outfile:</span><br><span class="line">        <span class="comment"># 假设所有文件结构相同</span></span><br><span class="line">        <span class="keyword">for</span> i, filename <span class="keyword">in</span> <span class="built_in">enumerate</span>(all_files):</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> infile:</span><br><span class="line">                reader = csv.reader(infile)</span><br><span class="line">                <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                    <span class="comment"># 第一个文件，保留表头</span></span><br><span class="line">                    <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">                        csv.writer(outfile).writerow(row)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># 跳过后续文件的表头</span></span><br><span class="line">                    <span class="built_in">next</span>(reader, <span class="literal">None</span>)</span><br><span class="line">                    <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">                        csv.writer(outfile).writerow(row)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="comment"># merge_csv_files("data_*.csv", "merged_data.csv")</span></span><br></pre></td></tr></tbody></table></figure><h3 id="13-3-XML-处理"><a href="#13-3-XML-处理" class="headerlink" title="13.3 XML 处理"></a>13.3 XML 处理</h3><p>XML (eXtensible Markup Language) 是一种用于存储和传输数据的标记语言。Python 提供多种处理 XML 的方法，最常用的是 <code>xml.etree.ElementTree</code> 模块。</p><h4 id="13-3-1-创建和写入-XML"><a href="#13-3-1-创建和写入-XML" class="headerlink" title="13.3.1 创建和写入 XML"></a>13.3.1 创建和写入 XML</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建XML根元素</span></span><br><span class="line">root = ET.Element(<span class="string">"data"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加子元素</span></span><br><span class="line">items = ET.SubElement(root, <span class="string">"items"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加多个项目</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">4</span>):</span><br><span class="line">    item = ET.SubElement(items, <span class="string">"item"</span>)</span><br><span class="line">    item.<span class="built_in">set</span>(<span class="string">"id"</span>, <span class="built_in">str</span>(i))  <span class="comment"># 设置属性</span></span><br><span class="line">    item.text = <span class="string">f"第<span class="subst">{i}</span>项"</span>  <span class="comment"># 设置文本内容</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加嵌套元素</span></span><br><span class="line">    detail = ET.SubElement(item, <span class="string">"detail"</span>)</span><br><span class="line">    detail.text = <span class="string">f"项目<span class="subst">{i}</span>的详情"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户信息部分</span></span><br><span class="line">users = ET.SubElement(root, <span class="string">"users"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加用户</span></span><br><span class="line">user = ET.SubElement(users, <span class="string">"user"</span>)</span><br><span class="line">user.<span class="built_in">set</span>(<span class="string">"name"</span>, <span class="string">"张三"</span>)</span><br><span class="line">ET.SubElement(user, <span class="string">"age"</span>).text = <span class="string">"30"</span></span><br><span class="line">ET.SubElement(user, <span class="string">"city"</span>).text = <span class="string">"北京"</span></span><br><span class="line"></span><br><span class="line">user2 = ET.SubElement(users, <span class="string">"user"</span>)</span><br><span class="line">user2.<span class="built_in">set</span>(<span class="string">"name"</span>, <span class="string">"李四"</span>)</span><br><span class="line">ET.SubElement(user2, <span class="string">"age"</span>).text = <span class="string">"25"</span></span><br><span class="line">ET.SubElement(user2, <span class="string">"city"</span>).text = <span class="string">"上海"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成XML字符串</span></span><br><span class="line">xml_str = ET.tostring(root, encoding=<span class="string">"utf-8"</span>).decode(<span class="string">"utf-8"</span>)</span><br><span class="line"><span class="built_in">print</span>(xml_str)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入XML文件</span></span><br><span class="line">tree = ET.ElementTree(root)</span><br><span class="line">tree.write(<span class="string">"data.xml"</span>, encoding=<span class="string">"utf-8"</span>, xml_declaration=<span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="13-3-2-解析和读取-XML"><a href="#13-3-2-解析和读取-XML" class="headerlink" title="13.3.2 解析和读取 XML"></a>13.3.2 解析和读取 XML</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从文件解析XML</span></span><br><span class="line">tree = ET.parse(<span class="string">"data.xml"</span>)</span><br><span class="line">root = tree.getroot()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从字符串解析XML</span></span><br><span class="line">xml_string = <span class="string">'&lt;data&gt;&lt;item id="1"&gt;测试&lt;/item&gt;&lt;/data&gt;'</span></span><br><span class="line">root = ET.fromstring(xml_string)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取元素标签和属性</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"根元素标签: <span class="subst">{root.tag}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历子元素</span></span><br><span class="line"><span class="keyword">for</span> child <span class="keyword">in</span> root:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"子元素: <span class="subst">{child.tag}</span>, 属性: <span class="subst">{child.attrib}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找特定元素 - find()查找第一个匹配元素</span></span><br><span class="line">items = root.find(<span class="string">"items"</span>)</span><br><span class="line"><span class="keyword">if</span> items <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="comment"># 使用findall()查找所有匹配的子元素</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items.findall(<span class="string">"item"</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"项目ID: <span class="subst">{item.get(<span class="string">'id'</span>)}</span>, 内容: <span class="subst">{item.text}</span>"</span>)</span><br><span class="line">        <span class="comment"># 获取嵌套元素</span></span><br><span class="line">        detail = item.find(<span class="string">"detail"</span>)</span><br><span class="line">        <span class="keyword">if</span> detail <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  详情: <span class="subst">{detail.text}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用XPath查询</span></span><br><span class="line"><span class="comment"># 查找所有用户名称</span></span><br><span class="line">users = root.findall(<span class="string">".//user"</span>)</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"用户: <span class="subst">{user.get(<span class="string">'name'</span>)}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  年龄: <span class="subst">{user.find(<span class="string">'age'</span>).text}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  城市: <span class="subst">{user.find(<span class="string">'city'</span>).text}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更复杂的XPath查询 - 查找北京的用户</span></span><br><span class="line">beijing_users = root.findall(<span class="string">".//user[city='北京']"</span>)</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> beijing_users:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"北京用户: <span class="subst">{user.get(<span class="string">'name'</span>)}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="13-3-3-修改-XML"><a href="#13-3-3-修改-XML" class="headerlink" title="13.3.3 修改 XML"></a>13.3.3 修改 XML</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改元素属性</span></span><br><span class="line">user = root.find(<span class="string">".//user[@name='张三']"</span>)</span><br><span class="line"><span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    user.<span class="built_in">set</span>(<span class="string">"status"</span>, <span class="string">"active"</span>)  <span class="comment"># 添加新属性</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 修改子元素文本</span></span><br><span class="line">    age_elem = user.find(<span class="string">"age"</span>)</span><br><span class="line">    <span class="keyword">if</span> age_elem <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        age_elem.text = <span class="string">"31"</span>  <span class="comment"># 修改年龄</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加新元素</span></span><br><span class="line">    ET.SubElement(user, <span class="string">"email"</span>).text = <span class="string">"zhangsan@example.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除元素</span></span><br><span class="line">users = root.find(<span class="string">"users"</span>)</span><br><span class="line"><span class="keyword">if</span> users <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> users.findall(<span class="string">"user"</span>):</span><br><span class="line">        <span class="keyword">if</span> user.get(<span class="string">"name"</span>) == <span class="string">"李四"</span>:</span><br><span class="line">            users.remove(user)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存修改</span></span><br><span class="line">tree.write(<span class="string">"updated_data.xml"</span>, encoding=<span class="string">"utf-8"</span>, xml_declaration=<span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="13-3-4-命名空间处理"><a href="#13-3-4-命名空间处理" class="headerlink" title="13.3.4 命名空间处理"></a>13.3.4 命名空间处理</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建带命名空间的XML</span></span><br><span class="line">root = ET.Element(<span class="string">"data"</span>, {<span class="string">"xmlns:dt"</span>: <span class="string">"http://example.org/datatypes"</span>})</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加带命名空间前缀的元素</span></span><br><span class="line">item = ET.SubElement(root, <span class="string">"dt:item"</span>)</span><br><span class="line">item.<span class="built_in">set</span>(<span class="string">"dt:type"</span>, <span class="string">"special"</span>)</span><br><span class="line">item.text = <span class="string">"带命名空间的元素"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成XML字符串</span></span><br><span class="line">ns_xml = ET.tostring(root, encoding=<span class="string">"utf-8"</span>).decode(<span class="string">"utf-8"</span>)</span><br><span class="line"><span class="built_in">print</span>(ns_xml)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析带命名空间的XML</span></span><br><span class="line">ns_root = ET.fromstring(ns_xml)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用带命名空间的XPath查询</span></span><br><span class="line">namespaces = {<span class="string">"dt"</span>: <span class="string">"http://example.org/datatypes"</span>}</span><br><span class="line">ns_items = ns_root.findall(<span class="string">".//dt:item"</span>, namespaces)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> ns_items:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"找到命名空间元素: <span class="subst">{item.text}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"类型属性: <span class="subst">{item.get(<span class="string">'{http://example.org/datatypes}type'</span>)}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h3 id="13-4-配置文件处理"><a href="#13-4-配置文件处理" class="headerlink" title="13.4 配置文件处理"></a>13.4 配置文件处理</h3><p>配置文件是应用程序保存设置和首选项的常用方式。Python 提供了多种处理不同格式配置文件的方法。</p><h4 id="13-4-1-INI-配置文件处理"><a href="#13-4-1-INI-配置文件处理" class="headerlink" title="13.4.1 INI 配置文件处理"></a>13.4.1 INI 配置文件处理</h4><p>INI 文件是一种结构简单的配置文件格式，Python 通过 <code>configparser</code> 模块提供支持。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"><span class="comment"># configparser是Python标准库中用于处理配置文件的模块</span></span><br><span class="line"><span class="comment"># 它可以读取、写入和修改类似INI格式的配置文件</span></span><br><span class="line"><span class="comment"># 配置文件通常包含节(sections)</span></span><br><span class="line"><span class="comment"># 如:[DEFAULT]</span></span><br><span class="line"><span class="comment"># 和每个节下的键值对(key-value pairs)</span></span><br><span class="line"><span class="comment"># 如:</span></span><br><span class="line"><span class="comment"># language = 中文</span></span><br><span class="line"><span class="comment"># theme = 默认</span></span><br><span class="line"><span class="comment"># auto_save = true</span></span><br><span class="line"><span class="comment"># save_interval = 10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个新的配置解析器</span></span><br><span class="line">config = configparser.ConfigParser()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加默认节和配置项</span></span><br><span class="line">config[<span class="string">"DEFAULT"</span>] = {</span><br><span class="line">    <span class="string">"language"</span>: <span class="string">"中文"</span>,</span><br><span class="line">    <span class="string">"theme"</span>: <span class="string">"默认"</span>,</span><br><span class="line">    <span class="string">"auto_save"</span>: <span class="string">"true"</span>,  </span><br><span class="line">    <span class="string">"save_interval"</span>: <span class="string">"10"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加应用设置节</span></span><br><span class="line">config[<span class="string">"应用设置"</span>] = {}</span><br><span class="line">config[<span class="string">"应用设置"</span>][<span class="string">"font_size"</span>] = <span class="string">"14"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加用户信息节</span></span><br><span class="line">config[<span class="string">"用户信息"</span>] = {}</span><br><span class="line">user_info = config[<span class="string">"用户信息"</span>]  <span class="comment"># 创建一个引用，方便添加多个配置项</span></span><br><span class="line">user_info[<span class="string">"username"</span>] = <span class="string">"张三"</span></span><br><span class="line">user_info[<span class="string">"email"</span>] = <span class="string">"zhangsan@example.com"</span></span><br><span class="line">user_info[<span class="string">"remember_password"</span>] = <span class="string">"false"</span>  <span class="comment"># 修改为标准布尔值字符串</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加数据库连接节</span></span><br><span class="line">config[<span class="string">"数据库"</span>] = {}</span><br><span class="line">config[<span class="string">"数据库"</span>][<span class="string">"host"</span>] = <span class="string">"localhost"</span></span><br><span class="line">config[<span class="string">"数据库"</span>][<span class="string">"port"</span>] = <span class="string">"3306"</span></span><br><span class="line">config[<span class="string">"数据库"</span>][<span class="string">"username"</span>] = <span class="string">"root"</span></span><br><span class="line">config[<span class="string">"数据库"</span>][<span class="string">"password"</span>] = <span class="string">"123456"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将配置写入文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"config.ini"</span>, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config.write(f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取配置文件</span></span><br><span class="line">config = configparser.ConfigParser()</span><br><span class="line">config.read(<span class="string">"config.ini"</span>, encoding=<span class="string">"utf-8"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有节名称</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"所有配置节:"</span>, config.sections())  <span class="comment"># ['应用设置', '用户信息', '数据库']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取节中的所有键</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"用户信息节中的所有键:"</span>, <span class="built_in">list</span>(config[<span class="string">"用户信息"</span>].keys()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取特定配置值</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"用户名:"</span>, config[<span class="string">"用户信息"</span>][<span class="string">"username"</span>])  <span class="comment"># 张三</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取默认节中的值</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"默认语言:"</span>, config.get(<span class="string">"应用设置"</span>, <span class="string">"language"</span>))  <span class="comment"># 使用DEFAULT中的值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 类型转换方法</span></span><br><span class="line">font_size = config.getint(<span class="string">"应用设置"</span>, <span class="string">"font_size"</span>)</span><br><span class="line">auto_save = config.getboolean(<span class="string">"DEFAULT"</span>, <span class="string">"auto_save"</span>, fallback=<span class="literal">True</span>)  <span class="comment"># 将"true"转换为True</span></span><br><span class="line">save_interval = config.getint(<span class="string">"DEFAULT"</span>, <span class="string">"save_interval"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"字体大小: <span class="subst">{font_size}</span>, 类型: <span class="subst">{<span class="built_in">type</span>(font_size)}</span>"</span>)  <span class="comment"># 字体大小: 14, 类型: &lt;class 'int'&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"自动保存: <span class="subst">{auto_save}</span>, 类型: <span class="subst">{<span class="built_in">type</span>(auto_save)}</span>"</span>)  <span class="comment"># 自动保存: True, 类型: &lt;class 'bool'&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置</span></span><br><span class="line">config[<span class="string">"用户信息"</span>][<span class="string">"username"</span>] = <span class="string">"李四"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加新配置</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">"日志设置"</span> <span class="keyword">not</span> <span class="keyword">in</span> config:</span><br><span class="line">    config[<span class="string">"日志设置"</span>] = {}</span><br><span class="line">config[<span class="string">"日志设置"</span>][<span class="string">"log_level"</span>] = <span class="string">"INFO"</span></span><br><span class="line">config[<span class="string">"日志设置"</span>][<span class="string">"log_file"</span>] = <span class="string">"app.log"</span></span><br><span class="line">config[<span class="string">"日志设置"</span>][<span class="string">"max_size"</span>] = <span class="string">"10MB"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存修改后的配置</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"updated_config.ini"</span>, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config.write(f)</span><br></pre></td></tr></tbody></table></figure><h4 id="13-4-2-YAML-配置文件处理"><a href="#13-4-2-YAML-配置文件处理" class="headerlink" title="13.4.2 YAML 配置文件处理"></a>13.4.2 YAML 配置文件处理</h4><p>YAML 是一种人类友好的数据序列化格式，需要安装 <code>PyYAML</code> 库。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要安装PyYAML: pip install pyyaml</span></span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建YAML数据</span></span><br><span class="line">data = {</span><br><span class="line">    <span class="string">"server"</span>: {</span><br><span class="line">        <span class="string">"host"</span>: <span class="string">"example.com"</span>,</span><br><span class="line">        <span class="string">"port"</span>: <span class="number">8080</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"database"</span>: {</span><br><span class="line">        <span class="string">"host"</span>: <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">"port"</span>: <span class="number">5432</span>,</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">"secret"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"logging"</span>: {</span><br><span class="line">        <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/var/log/app.log"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"users"</span>: [</span><br><span class="line">        {<span class="string">"name"</span>: <span class="string">"张三"</span>, <span class="string">"role"</span>: <span class="string">"admin"</span>},</span><br><span class="line">        {<span class="string">"name"</span>: <span class="string">"李四"</span>, <span class="string">"role"</span>: <span class="string">"user"</span>}</span><br><span class="line">    ]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入YAML文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"config.yaml"</span>, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    yaml.dump(data, f, default_flow_style=<span class="literal">False</span>, allow_unicode=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取YAML文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"config.yaml"</span>, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config = yaml.safe_load(f)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 访问配置</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"服务器地址: <span class="subst">{config[<span class="string">'server'</span>][<span class="string">'host'</span>]}</span>"</span>)  <span class="comment"># example.com</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"第一个用户: <span class="subst">{config[<span class="string">'users'</span>][<span class="number">0</span>][<span class="string">'name'</span>]}</span>"</span>)  <span class="comment"># 张三</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置</span></span><br><span class="line">config[<span class="string">"server"</span>][<span class="string">"port"</span>] = <span class="number">9090</span></span><br><span class="line">config[<span class="string">"users"</span>].append({<span class="string">"name"</span>: <span class="string">"王五"</span>, <span class="string">"role"</span>: <span class="string">"user"</span>})</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存修改</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"updated_config.yaml"</span>, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    yaml.dump(config, f, default_flow_style=<span class="literal">False</span>, allow_unicode=<span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="13-4-3-使用环境变量作为配置"><a href="#13-4-3-使用环境变量作为配置" class="headerlink" title="13.4.3 使用环境变量作为配置"></a>13.4.3 使用环境变量作为配置</h4><p>环境变量是一种灵活的配置方式，尤其适用于容器化应用。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv  <span class="comment"># 需安装: pip install python-dotenv</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从.env文件加载环境变量</span></span><br><span class="line">load_dotenv()  <span class="comment"># 默认加载当前目录下的.env文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取环境变量，提供默认值</span></span><br><span class="line">database_url = os.environ.get(<span class="string">"DATABASE_URL"</span>, <span class="string">"sqlite:///default.db"</span>)</span><br><span class="line">debug_mode = os.environ.get(<span class="string">"DEBUG"</span>, <span class="string">"False"</span>).lower() <span class="keyword">in</span> (<span class="string">"true"</span>, <span class="string">"1"</span>, <span class="string">"yes"</span>)</span><br><span class="line">port = <span class="built_in">int</span>(os.environ.get(<span class="string">"PORT"</span>, <span class="string">"8000"</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"数据库URL: <span class="subst">{database_url}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"调试模式: <span class="subst">{debug_mode}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"端口: <span class="subst">{port}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建.env文件示例</span></span><br><span class="line">env_content = <span class="string">"""</span></span><br><span class="line"><span class="string"># 数据库设置</span></span><br><span class="line"><span class="string">DATABASE_URL=postgresql://user:pass@localhost/dbname</span></span><br><span class="line"><span class="string"># 应用设置</span></span><br><span class="line"><span class="string">DEBUG=True</span></span><br><span class="line"><span class="string">PORT=5000</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">".env.example"</span>, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(env_content)</span><br></pre></td></tr></tbody></table></figure><h4 id="13-4-4-JSON-作为配置文件"><a href="#13-4-4-JSON-作为配置文件" class="headerlink" title="13.4.4 JSON 作为配置文件"></a>13.4.4 JSON 作为配置文件</h4><p>JSON 也是一种常用的配置文件格式，尤其适合需要与 Web 应用共享配置的场景。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认配置</span></span><br><span class="line">default_config = {</span><br><span class="line">    <span class="string">"app_name"</span>: <span class="string">"MyApp"</span>,</span><br><span class="line">    <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">    <span class="string">"debug"</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">"database"</span>: {</span><br><span class="line">        <span class="string">"host"</span>: <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">"port"</span>: <span class="number">5432</span>,</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"app_db"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"cache"</span>: {</span><br><span class="line">        <span class="string">"enabled"</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">"ttl"</span>: <span class="number">3600</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置文件路径</span></span><br><span class="line">config_path = <span class="string">"app_config.json"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载配置</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_config</span>():</span><br><span class="line">    <span class="comment"># 如果配置文件存在，则加载它</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(config_path):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(config_path, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">return</span> json.load(f)</span><br><span class="line">    <span class="comment"># 否则使用默认配置并创建配置文件</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        save_config(default_config)</span><br><span class="line">        <span class="keyword">return</span> default_config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存配置</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_config</span>(<span class="params">config</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(config_path, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump(config, f, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新配置</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_config</span>(<span class="params">key, value</span>):</span><br><span class="line">    config = load_config()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 处理嵌套键 (如 "database.host")</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"."</span> <span class="keyword">in</span> key:</span><br><span class="line">        parts = key.split(<span class="string">"."</span>)</span><br><span class="line">        current = config</span><br><span class="line">        <span class="keyword">for</span> part <span class="keyword">in</span> parts[:-<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">if</span> part <span class="keyword">not</span> <span class="keyword">in</span> current:</span><br><span class="line">                current[part] = {}</span><br><span class="line">            current = current[part]</span><br><span class="line">        current[parts[-<span class="number">1</span>]] = value</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        config[key] = value</span><br><span class="line">    </span><br><span class="line">    save_config(config)</span><br><span class="line">    <span class="keyword">return</span> config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">config = load_config()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"应用名称: <span class="subst">{config[<span class="string">'app_name'</span>]}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"数据库主机: <span class="subst">{config[<span class="string">'database'</span>][<span class="string">'host'</span>]}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新配置</span></span><br><span class="line">update_config(<span class="string">"database.host"</span>, <span class="string">"db.example.com"</span>)</span><br><span class="line">update_config(<span class="string">"cache.ttl"</span>, <span class="number">7200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载配置</span></span><br><span class="line">config = load_config()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"更新后的数据库主机: <span class="subst">{config[<span class="string">'database'</span>][<span class="string">'host'</span>]}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"更新后的缓存TTL: <span class="subst">{config[<span class="string">'cache'</span>][<span class="string">'ttl'</span>]}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h3 id="13-5-正则表达式"><a href="#13-5-正则表达式" class="headerlink" title="13.5 正则表达式"></a>13.5 正则表达式</h3><p><strong>正则表达式</strong>（通常缩写为 regex 或 regexp）是一种强大的文本处理工具。它使用一种专门的语法来定义 <strong>搜索模式 (pattern)</strong>，然后可以用这个模式在文本中进行查找、匹配、提取或替换操作。正则表达式在各种编程任务中都极为有用，例如：</p><ul><li><strong>数据验证</strong>: 检查用户输入是否符合特定格式（如邮箱、手机号、日期）。</li><li><strong>数据提取</strong>: 从大量非结构化文本（如日志文件、网页内容）中精确地抽取所需信息（如 IP 地址、错误代码、特定标签内容）。</li><li><strong>文本替换</strong>: 对文本进行复杂的查找和替换操作，例如格式化代码、屏蔽敏感信息。</li><li><strong>文本分割</strong>: 根据复杂的模式分割字符串。</li></ul><p>Python 通过内置的 <code>re</code> 模块提供了对正则表达式的全面支持。</p><p><strong>核心概念</strong>: 正则表达式的核心在于使用 <strong>元字符 (metacharacters)</strong> 和普通字符组合来定义模式。元字符是具有特殊含义的字符，而普通字符则匹配它们自身。</p><h4 id="13-5-1-常用元字符和语法"><a href="#13-5-1-常用元字符和语法" class="headerlink" title="13.5.1 常用元字符和语法"></a>13.5.1 常用元字符和语法</h4><p>以下是一些最常用的正则表达式元字符及其含义：</p><table><thead><tr><th align="left">元字符</th><th align="left">描述</th><th align="left">示例模式</th><th align="left">示例匹配</th></tr></thead><tbody><tr><td align="left"><code>.</code></td><td align="left">匹配 <strong>除换行符 <code>\n</code> 之外</strong> 的任何单个字符 (使用 <code>re.DOTALL</code> 标志可匹配换行符)。</td><td align="left"><code>a.c</code></td><td align="left"><code>abc</code>, <code>a_c</code>, <code>a&amp;c</code> (但不匹配 <code>ac</code>)</td></tr><tr><td align="left"><code>^</code></td><td align="left">匹配字符串的 <strong>开头</strong>。在多行模式 (<code>re.MULTILINE</code>) 下，也匹配每行的开头。</td><td align="left"><code>^Hello</code></td><td align="left"><code>Hello world</code> (但不匹配 <code>Say Hello</code>)</td></tr><tr><td align="left"><code>$</code></td><td align="left">匹配字符串的 <strong>结尾</strong>。在多行模式 (<code>re.MULTILINE</code>) 下，也匹配每行的结尾。</td><td align="left"><code>world$</code></td><td align="left"><code>Hello world</code> (但不匹配 <code>world say</code>)</td></tr><tr><td align="left"><code>*</code></td><td align="left">匹配前面的元素 <strong>零次或多次</strong> (贪婪模式)。</td><td align="left"><code>go*d</code></td><td align="left"><code>gd</code>, <code>god</code>, <code>good</code>, <code>goooood</code></td></tr><tr><td align="left"><code>+</code></td><td align="left">匹配前面的元素 <strong>一次或多次</strong> (贪婪模式)。</td><td align="left"><code>go+d</code></td><td align="left"><code>god</code>, <code>good</code>, <code>goooood</code> (但不匹配 <code>gd</code>)</td></tr><tr><td align="left"><code>?</code></td><td align="left">匹配前面的元素 <strong>零次或一次</strong> (贪婪模式)。也用于将贪婪量词变为 <strong>非贪婪</strong> (见后文)。</td><td align="left"><code>colou?r</code></td><td align="left"><code>color</code>, <code>colour</code></td></tr><tr><td align="left"><code>{n}</code></td><td align="left">匹配前面的元素 <strong>恰好 <code>n</code> 次</strong>。</td><td align="left"><code>\d{3}</code></td><td align="left"><code>123</code> (但不匹配 <code>12</code> 或 <code>1234</code>)</td></tr><tr><td align="left"><code>{n,}</code></td><td align="left">匹配前面的元素 <strong>至少 <code>n</code> 次</strong> (贪婪模式)。</td><td align="left"><code>\d{2,}</code></td><td align="left"><code>12</code>, <code>123</code>, <code>12345</code></td></tr><tr><td align="left"><code>{n,m}</code></td><td align="left">匹配前面的元素 <strong>至少 <code>n</code> 次，但不超过 <code>m</code> 次</strong> (贪婪模式)。</td><td align="left"><code>\d{2,4}</code></td><td align="left"><code>12</code>, <code>123</code>, <code>1234</code> (但不匹配 <code>1</code> 或 <code>12345</code>)</td></tr><tr><td align="left"><code>[]</code></td><td align="left"><strong>字符集</strong>。匹配方括号中包含的 <strong>任意一个</strong> 字符。</td><td align="left"><code>[abc]</code></td><td align="left"><code>a</code> 或 <code>b</code> 或 <code>c</code></td></tr><tr><td align="left"><code>[^...]</code></td><td align="left"><strong>否定字符集</strong>。匹配 <strong>不在</strong> 方括号中包含的任何字符。</td><td align="left"><code>[^0-9]</code></td><td align="left">任何非数字字符</td></tr><tr><td align="left"><code>\</code></td><td align="left"><strong>转义符</strong>。用于转义元字符，使其匹配其字面含义 (如 <code>\.</code> 匹配句点 <code>.</code>)，或用于引入特殊序列 (如 <code>\d</code>)。</td><td align="left"><code>\$</code></td><td align="left"><code>$</code> 字符本身</td></tr><tr><td align="left">`</td><td align="left">`</td><td align="left"><strong>或 (OR)</strong> 运算符。匹配 `</td><td align="left">` 左边或右边的表达式。</td></tr><tr><td align="left"><code>()</code></td><td align="left"><strong>分组</strong>。将括号内的表达式视为一个整体，用于应用量词、限制 `</td><td align="left">` 的范围，或 <strong>捕获</strong> 匹配的子字符串。</td><td align="left"><code>(ab)+</code></td></tr></tbody></table><p><strong>踩坑提示</strong>:</p><ul><li><strong>转义</strong>: 当需要匹配元字符本身时（如 <code>.</code>、<code>*</code>、<code>?</code>），必须在前面加上反斜杠 <code>\</code> 进行转义。例如，要匹配 IP 地址中的点，应使用 <code>\.</code>。</li><li><strong>原始字符串 (Raw Strings)</strong>: 在 Python 中定义正则表达式模式时，<strong>强烈建议</strong> 使用原始字符串（在字符串前加 <code>r</code>），如 <code>r"\d+"</code>。这可以避免 Python 解释器对反斜杠进行自身的转义，从而简化正则表达式的书写，尤其是包含很多 <code>\</code> 的模式。</li></ul><h4 id="13-5-2-特殊序列-预定义字符集"><a href="#13-5-2-特殊序列-预定义字符集" class="headerlink" title="13.5.2 特殊序列 (预定义字符集)"></a>13.5.2 特殊序列 (预定义字符集)</h4><p><code>re</code> 模块提供了一些方便的特殊序列来代表常见的字符集：</p><table><thead><tr><th align="left">特殊序列</th><th align="left">描述</th><th align="left">等价于</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><code>\d</code></td><td align="left">匹配任何 <strong>Unicode 数字</strong> 字符 (包括 [0-9] 和其他语言的数字)。</td><td align="left"><code>[0-9]</code> (ASCII)</td><td align="left"><code>1</code>, <code>5</code></td></tr><tr><td align="left"><code>\D</code></td><td align="left">匹配任何 <strong>非数字</strong> 字符。</td><td align="left"><code>[^0-9]</code> (ASCII)</td><td align="left"><code>a</code>, <code>_</code>, <code></code></td></tr><tr><td align="left"><code>\s</code></td><td align="left">匹配任何 <strong>Unicode 空白</strong> 字符 (包括 <code></code>、<code>\t</code>、<code>\n</code>、<code>\r</code>、<code>\f</code>、<code>\v</code> 等)。</td><td align="left"></td><td align="left"><code></code>, <code>\t</code></td></tr><tr><td align="left"><code>\S</code></td><td align="left">匹配任何 <strong>非空白</strong> 字符。</td><td align="left"></td><td align="left"><code>a</code>, <code>1</code>, <code>.</code></td></tr><tr><td align="left"><code>\w</code></td><td align="left">匹配任何 <strong>Unicode 词语</strong> 字符 (字母、数字和下划线 <code>_</code>)。</td><td align="left"><code>[a-zA-Z0-9_]</code> (ASCII)</td><td align="left"><code>a</code>, <code>B</code>, <code>5</code>, <code>_</code></td></tr><tr><td align="left"><code>\W</code></td><td align="left">匹配任何 <strong>非词语</strong> 字符。</td><td align="left"><code>[^a-zA-Z0-9_]</code>(ASCII)</td><td align="left"><code>!</code>, <code></code>, <code>@</code></td></tr><tr><td align="left"><code>\b</code></td><td align="left">匹配 <strong>词语边界</strong> (word boundary)。这是一个零宽度断言，匹配词语字符 (<code>\w</code>) 和非词语字符 (<code>\W</code>) 之间，或词语字符和字符串开头/结尾之间的位置。</td><td align="left"></td><td align="left"><code>\bword\b</code></td></tr><tr><td align="left"><code>\B</code></td><td align="left">匹配 <strong>非词语边界</strong>。</td><td align="left"></td><td align="left"><code>\Bword\B</code></td></tr></tbody></table><h4 id="13-5-3-贪婪模式-vs-非贪婪模式"><a href="#13-5-3-贪婪模式-vs-非贪婪模式" class="headerlink" title="13.5.3 贪婪模式 vs. 非贪婪模式"></a>13.5.3 贪婪模式 vs. 非贪婪模式</h4><p>默认情况下，量词 (<code>*</code>, <code>+</code>, <code>?</code>, <code>{n,}</code>, <code>{n,m}</code>) 都是 <strong>贪婪 (Greedy)</strong> 的，它们会尽可能多地匹配字符。</p><p><strong>场景</strong>: 从 HTML 标签 <code>&lt;b&gt;Bold Text&lt;/b&gt;</code> 中提取 <code>&lt;b&gt;</code>。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">text = <span class="string">"&lt;b&gt;Bold Text&lt;/b&gt; Regular Text &lt;b&gt;Another Bold&lt;/b&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 贪婪模式 (默认)</span></span><br><span class="line">greedy_pattern = <span class="string">r"&lt;.*&gt;"</span> <span class="comment"># . 匹配任何字符，* 匹配零次或多次</span></span><br><span class="line">match_greedy = re.search(greedy_pattern, text)</span><br><span class="line"><span class="keyword">if</span> match_greedy:</span><br><span class="line">    <span class="comment"># * 会一直匹配到字符串的最后一个 &gt;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"贪婪匹配结果: <span class="subst">{match_greedy.group(<span class="number">0</span>)}</span>"</span>)</span><br><span class="line">    <span class="comment"># 输出: 贪婪匹配结果: &lt;b&gt;Bold Text&lt;/b&gt; Regular Text &lt;b&gt;Another Bold&lt;/b&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 非贪婪模式 (在量词后加 ?)</span></span><br><span class="line">non_greedy_pattern = <span class="string">r"&lt;.*?&gt;"</span> <span class="comment"># *? 匹配零次或多次，但尽可能少地匹配</span></span><br><span class="line">match_non_greedy = re.search(non_greedy_pattern, text)</span><br><span class="line"><span class="keyword">if</span> match_non_greedy:</span><br><span class="line">    <span class="comment"># *? 遇到第一个 &gt; 就停止匹配</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"非贪婪匹配结果: <span class="subst">{match_non_greedy.group(<span class="number">0</span>)}</span>"</span>)</span><br><span class="line">    <span class="comment"># 输出: 非贪婪匹配结果: &lt;b&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找所有非贪婪匹配</span></span><br><span class="line">all_matches_non_greedy = re.findall(non_greedy_pattern, text)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"所有非贪婪匹配: <span class="subst">{all_matches_non_greedy}</span>"</span>)</span><br><span class="line"><span class="comment"># 输出: 所有非贪婪匹配: ['&lt;b&gt;', '&lt;/b&gt;', '&lt;b&gt;', '&lt;/b&gt;']</span></span><br></pre></td></tr></tbody></table></figure><p><strong>何时使用非贪婪模式？</strong></p><p>当需要匹配从某个开始标记到 <strong>最近的</strong> 结束标记之间的内容时，通常需要使用非贪婪量词 (<code>*?</code>, <code>+?</code>, <code>??</code>, <code>{n,}?</code>, <code>{n,m}?</code>)。</p><h4 id="13-5-4-分组与捕获"><a href="#13-5-4-分组与捕获" class="headerlink" title="13.5.4 分组与捕获"></a>13.5.4 分组与捕获</h4><p>使用圆括号 <code>()</code> 可以将模式的一部分组合起来，形成一个 <strong>分组 (Group)</strong>。分组有几个重要作用：</p><ol><li><strong>应用量词</strong>: 将量词作用于整个分组，如 <code>(abc)+</code> 匹配 <code>abc</code>, <code>abcabc</code> 等。</li><li><strong>限制 <code>|</code> 范围</strong>: 如 <code>gr(a|e)y</code> 匹配 <code>gray</code> 或 <code>grey</code>。</li><li><strong>捕获内容</strong>: 默认情况下，每个分组会 <strong>捕获 (Capture)</strong> 其匹配到的子字符串，以便后续引用或提取。</li></ol><p><strong>场景</strong>: 从 “Name: John Doe, Age: 30” 中提取姓名和年龄。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">text = <span class="string">"Name: John Doe, Age: 30; Name: Jane Smith, Age: 25"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义带有捕获组的模式</span></span><br><span class="line"><span class="comment"># 第一个组 (\w+\s+\w+) 捕获姓名</span></span><br><span class="line"><span class="comment"># 第二个组 (\d+) 捕获年龄</span></span><br><span class="line">pattern_capture = <span class="string">r"Name: (\w+\s+\w+), Age: (\d+)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 findall 查找所有匹配项</span></span><br><span class="line"><span class="comment"># findall 返回一个列表，如果模式中有捕获组，列表元素是包含所有捕获组内容的元组</span></span><br><span class="line">matches = re.findall(pattern_capture, text)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"\n--- 使用 findall 提取分组 ---"</span>)</span><br><span class="line"><span class="built_in">print</span>(matches) <span class="comment"># 输出: [('John Doe', '30'), ('Jane Smith', '25')]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 finditer 获取 Match 对象，可以更灵活地访问分组</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n--- 使用 finditer 访问分组 ---"</span>)</span><br><span class="line"><span class="keyword">for</span> match_obj <span class="keyword">in</span> re.finditer(pattern_capture, text):</span><br><span class="line">    <span class="comment"># match_obj.group(0) 或 group() 获取整个匹配</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"整个匹配: <span class="subst">{match_obj.group(<span class="number">0</span>)}</span>"</span>)</span><br><span class="line">    <span class="comment"># match_obj.group(1) 获取第一个捕获组的内容 (姓名)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  姓名 (组 1): <span class="subst">{match_obj.group(<span class="number">1</span>)}</span>"</span>)</span><br><span class="line">    <span class="comment"># match_obj.group(2) 获取第二个捕获组的内容 (年龄)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  年龄 (组 2): <span class="subst">{match_obj.group(<span class="number">2</span>)}</span>"</span>)</span><br><span class="line">    <span class="comment"># match_obj.groups() 获取所有捕获组组成的元组</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  所有分组: <span class="subst">{match_obj.groups()}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 非捕获组 (?:...)</span></span><br><span class="line"><span class="comment"># 如果只想分组而不捕获内容，可以使用非捕获组</span></span><br><span class="line">pattern_non_capture = <span class="string">r"Name: (?:\w+\s+\w+), Age: (\d+)"</span> <span class="comment"># 第一个组不捕获</span></span><br><span class="line">matches_nc = re.findall(pattern_non_capture, text)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"\n--- 使用非捕获组的 findall ---"</span>)</span><br><span class="line"><span class="built_in">print</span>(matches_nc) <span class="comment"># 输出: ['30', '25'] (只包含捕获组的内容)</span></span><br></pre></td></tr></tbody></table></figure><p><strong>反向引用 (Backreferences)</strong>: 可以在模式内部或替换字符串中使用 <code>\1</code>, <code>\2</code>, … 来引用前面捕获组匹配到的文本。</p><p><strong>场景</strong>: 查找重复的单词，如 “the the”。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">text_repeat = <span class="string">"This is the the test sentence with repeated repeated words."</span></span><br><span class="line"><span class="comment"># \b 确保是完整的单词</span></span><br><span class="line"><span class="comment"># (\w+) 捕获第一个单词</span></span><br><span class="line"><span class="comment"># \s+ 匹配中间的空白</span></span><br><span class="line"><span class="comment"># \1 引用第一个捕获组匹配的内容</span></span><br><span class="line">pattern_repeat = <span class="string">r"\b(\w+)\s+\1\b"</span></span><br><span class="line">repeated_words = re.findall(pattern_repeat, text_repeat)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"\n--- 查找重复单词 ---"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"找到的重复单词: <span class="subst">{repeated_words}</span>"</span>) <span class="comment"># 输出: ['the', 'repeated']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 sub 进行替换</span></span><br><span class="line"><span class="comment"># 将重复的单词替换为单个单词</span></span><br><span class="line">corrected_text = re.sub(pattern_repeat, <span class="string">r"\1"</span>, text_repeat) <span class="comment"># 使用 \1 引用捕获组</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"修正后的文本: <span class="subst">{corrected_text}</span>"</span>)</span><br><span class="line"><span class="comment"># 输出: This is the test sentence with repeated words.</span></span><br></pre></td></tr></tbody></table></figure><h4 id="13-5-5-re-模块核心函数"><a href="#13-5-5-re-模块核心函数" class="headerlink" title="13.5.5 re 模块核心函数"></a>13.5.5 <code>re</code> 模块核心函数</h4><p>Python 的 <code>re</code> 模块提供了以下核心函数来执行正则表达式操作：</p><table><thead><tr><th align="left">函数</th><th align="left">描述</th><th align="left">返回值</th><th align="left">主要用途</th></tr></thead><tbody><tr><td align="left"><code>re.match(p, s, flags=0)</code></td><td align="left">从字符串 <code>s</code> 的 <strong>开头</strong> 尝试匹配模式 <code>p</code>。</td><td align="left">匹配成功返回 <code>Match</code> 对象，失败返回 <code>None</code>。</td><td align="left">验证字符串是否以特定模式开始。</td></tr><tr><td align="left"><code>re.search(p, s, flags=0)</code></td><td align="left">在 <strong>整个</strong> 字符串 <code>s</code> 中搜索模式 <code>p</code> 的 <strong>第一个</strong> 匹配项。</td><td align="left">匹配成功返回 <code>Match</code> 对象，失败返回 <code>None</code>。</td><td align="left">在字符串中查找模式是否存在，并获取第一个匹配项的信息。</td></tr><tr><td align="left"><code>re.findall(p, s, flags=0)</code></td><td align="left">在字符串 <code>s</code> 中查找模式 <code>p</code> 的 <strong>所有非重叠</strong> 匹配项。</td><td align="left">返回一个 <strong>列表</strong>。如果模式无捕获组，列表元素是匹配的字符串；如果有捕获组，列表元素是包含各捕获组内容的元组。</td><td align="left">提取字符串中所有符合模式的子串或捕获组内容。</td></tr><tr><td align="left"><code>re.finditer(p, s, flags=0)</code></td><td align="left">与 <code>findall</code> 类似，但返回一个 <strong>迭代器 (iterator)</strong>，迭代器中的每个元素都是一个 <code>Match</code> 对象。</td><td align="left">返回一个迭代器，每个元素是 <code>Match</code> 对象。</td><td align="left">处理大量匹配结果时更 <strong>内存高效</strong>，因为不需要一次性存储所有结果。可以方便地访问每个匹配的详细信息（如位置）。</td></tr><tr><td align="left"><code>re.sub(p, repl, s, count=0, flags=0)</code></td><td align="left">在字符串 <code>s</code> 中查找模式 <code>p</code> 的所有匹配项，并用 <code>repl</code> 替换它们。<code>repl</code> 可以是字符串（支持 <code>\g&lt;name&gt;</code> 或 <code>\1</code> 等反向引用）或函数。<code>count</code> 指定最大替换次数。</td><td align="left">返回替换后的 <strong>新字符串</strong>。</td><td align="left">执行查找和替换操作。<code>repl</code> 可以是函数，实现更复杂的替换逻辑。</td></tr><tr><td align="left"><code>re.split(p, s, maxsplit=0, flags=0)</code></td><td align="left">使用模式 <code>p</code> 作为分隔符来 <strong>分割</strong> 字符串 <code>s</code>。<code>maxsplit</code> 指定最大分割次数。</td><td align="left">返回一个 <strong>列表</strong>，包含分割后的子字符串。如果模式中有捕获组，捕获的内容也会包含在列表中。</td><td align="left">根据复杂的模式分割字符串。</td></tr><tr><td align="left"><code>re.compile(p, flags=0)</code></td><td align="left"><strong>编译</strong> 正则表达式模式 <code>p</code> 为一个 <strong>模式对象 (Pattern Object)</strong>。</td><td align="left">返回一个 <code>Pattern</code> 对象。</td><td align="left">当一个模式需要被 <strong>多次</strong> 使用时，预先编译可以 <strong>提高性能</strong>。模式对象拥有与 <code>re</code> 模块函数同名的方法（如 <code>pattern.search(s)</code>）。</td></tr></tbody></table><p><strong>代码示例</strong>:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">text = <span class="string">"The quick brown fox jumps over the lazy dog. Phone: 123-456-7890. Email: test@example.com."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. re.match() - 检查开头</span></span><br><span class="line">pattern_start = <span class="string">r"The"</span></span><br><span class="line">match_result = re.<span class="keyword">match</span>(pattern_start, text)</span><br><span class="line"><span class="keyword">if</span> match_result:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"match(): 字符串以 '<span class="subst">{pattern_start}</span>' 开头。匹配内容: '<span class="subst">{match_result.group(<span class="number">0</span>)}</span>'"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"match(): 字符串不以 '<span class="subst">{pattern_start}</span>' 开头。"</span>)</span><br><span class="line"></span><br><span class="line">match_fail = re.<span class="keyword">match</span>(<span class="string">r"quick"</span>, text) <span class="comment"># 不从开头匹配，所以失败</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"match() 失败示例: <span class="subst">{match_fail}</span>"</span>) <span class="comment"># None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. re.search() - 查找第一个匹配</span></span><br><span class="line">pattern_word = <span class="string">r"fox"</span></span><br><span class="line">search_result = re.search(pattern_word, text)</span><br><span class="line"><span class="keyword">if</span> search_result:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"search(): 找到单词 '<span class="subst">{pattern_word}</span>'。 起始位置: <span class="subst">{search_result.start()}</span>, 结束位置: <span class="subst">{search_result.end()}</span>"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"search(): 未找到单词 '<span class="subst">{pattern_word}</span>'。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. re.findall() - 查找所有匹配</span></span><br><span class="line">pattern_digits = <span class="string">r"\d+"</span> <span class="comment"># 查找所有数字序列</span></span><br><span class="line">all_digits = re.findall(pattern_digits, text)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"findall(): 找到的所有数字序列: <span class="subst">{all_digits}</span>"</span>) <span class="comment"># ['123', '456', '7890']</span></span><br><span class="line"></span><br><span class="line">pattern_email = <span class="string">r"(\w+)@(\w+\.\w+)"</span> <span class="comment"># 查找邮箱并捕获用户名和域名</span></span><br><span class="line">email_parts = re.findall(pattern_email, text)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"findall() 捕获组: <span class="subst">{email_parts}</span>"</span>) <span class="comment"># [('test', 'example.com')]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. re.finditer() - 迭代查找匹配对象</span></span><br><span class="line">pattern_words_o = <span class="string">r"\b\w*o\w*\b"</span> <span class="comment"># 查找所有包含字母'o'的单词</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"finditer(): 查找包含 'o' 的单词:"</span>)</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">match</span> <span class="keyword">in</span> re.finditer(pattern_words_o, text, re.IGNORECASE): <span class="comment"># 使用 IGNORECASE 标志</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  找到: '<span class="subst">{<span class="keyword">match</span>.group(<span class="number">0</span>)}</span>' at position <span class="subst">{<span class="keyword">match</span>.span()}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. re.sub() - 替换</span></span><br><span class="line">pattern_phone = <span class="string">r"\d{3}-\d{3}-\d{4}"</span></span><br><span class="line"><span class="comment"># 将电话号码替换为 [REDACTED]</span></span><br><span class="line">censored_text = re.sub(pattern_phone, <span class="string">"[REDACTED]"</span>, text)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"sub() 替换电话号码: <span class="subst">{censored_text}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用函数进行替换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mask_email</span>(<span class="params">match_obj</span>):</span><br><span class="line">    username = match_obj.group(<span class="number">1</span>)</span><br><span class="line">    domain = match_obj.group(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f"<span class="subst">{username[<span class="number">0</span>]}</span>***@<span class="subst">{domain}</span>"</span> <span class="comment"># 用户名只显示第一个字符</span></span><br><span class="line"></span><br><span class="line">censored_email_text = re.sub(pattern_email, mask_email, text)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"sub() 使用函数替换邮箱: <span class="subst">{censored_email_text}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. re.split() - 分割</span></span><br><span class="line">pattern_punct = <span class="string">r"[.,:;]\s*"</span> <span class="comment"># 按标点符号和后面的空格分割</span></span><br><span class="line">parts = re.split(pattern_punct, text)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"split(): 按标点分割: <span class="subst">{parts}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. re.compile() - 编译模式</span></span><br><span class="line">compiled_pattern = re.<span class="built_in">compile</span>(<span class="string">r"l\w*y"</span>, re.IGNORECASE) <span class="comment"># 编译查找以l开头y结尾的词</span></span><br><span class="line"><span class="comment"># 多次使用编译后的模式</span></span><br><span class="line">match1 = compiled_pattern.search(text)</span><br><span class="line"><span class="keyword">if</span> match1:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"compile() &amp; search(): 找到 '<span class="subst">{match1.group(<span class="number">0</span>)}</span>'"</span>)</span><br><span class="line">match2 = compiled_pattern.findall(<span class="string">"Actually, Lily is lovely."</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"compile() &amp; findall(): 找到 <span class="subst">{match2}</span>"</span>) <span class="comment"># ['Lily', 'lovely']</span></span><br></pre></td></tr></tbody></table></figure><h4 id="13-5-6-Match-对象详解"><a href="#13-5-6-Match-对象详解" class="headerlink" title="13.5.6 Match 对象详解"></a>13.5.6 Match 对象详解</h4><p>当 <code>re.match()</code>, <code>re.search()</code> 或 <code>re.finditer()</code> 中的一项成功匹配时，它们会返回一个 <strong><code>Match</code> 对象</strong>。这个对象包含了关于匹配结果的详细信息。</p><table><thead><tr><th align="left">Match 对象方法/属性</th><th align="left">描述</th><th align="left">示例 (假设 <code>m = re.search(r"(\w+) (\d+)", "Order P123 45")</code>)</th></tr></thead><tbody><tr><td align="left"><code>m.group(0)</code> 或 <code>m.group()</code></td><td align="left">返回整个匹配的字符串。</td><td align="left"><code>'P123 45'</code></td></tr><tr><td align="left"><code>m.group(n)</code></td><td align="left">返回第 <code>n</code> 个捕获组匹配的字符串 (从 1 开始计数)。</td><td align="left"><code>m.group(1)</code> 返回 <code>'P123'</code>, <code>m.group(2)</code> 返回 <code>'45'</code></td></tr><tr><td align="left"><code>m.groups()</code></td><td align="left">返回一个包含所有捕获组匹配内容的 <strong>元组</strong>。</td><td align="left"><code>('P123', '45')</code></td></tr><tr><td align="left"><code>m.groupdict()</code></td><td align="left">如果模式中使用了 <strong>命名捕获组</strong> <code>(?P&lt;name&gt;...)</code>，返回一个包含组名和匹配内容的字典。</td><td align="left">(需要命名组，如下例)</td></tr><tr><td align="left"><code>m.start([group])</code></td><td align="left">返回整个匹配或指定 <code>group</code> 的 <strong>起始索引</strong> (包含)。</td><td align="left"><code>m.start()</code> 返回 6, <code>m.start(1)</code> 返回 6, <code>m.start(2)</code> 返回 11</td></tr><tr><td align="left"><code>m.end([group])</code></td><td align="left">返回整个匹配或指定 <code>group</code> 的 <strong>结束索引</strong> (不包含)。</td><td align="left"><code>m.end()</code> 返回 13, <code>m.end(1)</code> 返回 10, <code>m.end(2)</code> 返回 13</td></tr><tr><td align="left"><code>m.span([group])</code></td><td align="left">返回一个包含 <code>(start, end)</code> 索引的 <strong>元组</strong>。</td><td align="left"><code>m.span()</code> 返回 <code>(6, 13)</code>, <code>m.span(1)</code> 返回 <code>(6, 10)</code></td></tr><tr><td align="left"><code>m.string</code></td><td align="left">传递给 <code>match()</code> 或 <code>search()</code> 的原始字符串。</td><td align="left"><code>'Order P123 45'</code></td></tr><tr><td align="left"><code>m.re</code></td><td align="left">匹配时使用的已编译的模式对象 (<code>Pattern</code> object)。</td><td align="left"></td></tr></tbody></table><p><strong>命名捕获组示例</strong>:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">text = <span class="string">"Product ID: ABC-987, Quantity: 50"</span></span><br><span class="line"><span class="comment"># 使用 ?P&lt;name&gt; 定义命名捕获组</span></span><br><span class="line">pattern_named = <span class="string">r"Product ID: (?P&lt;product_id&gt;[A-Z]+-\d+), Quantity: (?P&lt;quantity&gt;\d+)"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> = re.search(pattern_named, text)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n--- 使用命名捕获组 ---"</span>)</span><br><span class="line">    <span class="comment"># 通过组名访问捕获的内容</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"产品 ID: <span class="subst">{<span class="keyword">match</span>.group(<span class="string">'product_id'</span>)}</span>"</span>) <span class="comment"># ABC-987</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"数量: <span class="subst">{<span class="keyword">match</span>.group(<span class="string">'quantity'</span>)}</span>"</span>)   <span class="comment"># 50</span></span><br><span class="line">    <span class="comment"># groupdict() 返回包含所有命名组的字典</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"捕获字典: <span class="subst">{<span class="keyword">match</span>.groupdict()}</span>"</span>) <span class="comment"># {'product_id': 'ABC-987', 'quantity': '50'}</span></span><br></pre></td></tr></tbody></table></figure><h4 id="13-5-7-正则表达式标志-Flags"><a href="#13-5-7-正则表达式标志-Flags" class="headerlink" title="13.5.7 正则表达式标志 (Flags)"></a>13.5.7 正则表达式标志 (Flags)</h4><p>标志可以修改正则表达式的匹配行为。可以在 <code>re</code> 函数的 <code>flags</code> 参数中指定，或在编译时指定。多个标志可以使用 <code>|</code> (按位或) 组合。</p><table><thead><tr><th align="left">标志</th><th align="left">简写</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>re.IGNORECASE</code></td><td align="left"><code>re.I</code></td><td align="left">进行 <strong>不区分大小写</strong> 的匹配。</td></tr><tr><td align="left"><code>re.MULTILINE</code></td><td align="left"><code>re.M</code></td><td align="left">使 <code>^</code> 和 <code>$</code> 匹配 <strong>每行的开头和结尾</strong>，而不仅仅是整个字符串的开头和结尾。</td></tr><tr><td align="left"><code>re.DOTALL</code></td><td align="left"><code>re.S</code></td><td align="left">使元字符 <code>.</code> 能够匹配 <strong>包括换行符 <code>\n</code> 在内</strong> 的任何字符。</td></tr><tr><td align="left"><code>re.VERBOSE</code></td><td align="left"><code>re.X</code></td><td align="left"><strong>详细模式</strong>。允许在模式字符串中添加 <strong>空白和注释</strong> 以提高可读性，此时模式中的空白会被忽略，<code>#</code> 后到行尾的内容视为注释。</td></tr><tr><td align="left"><code>re.ASCII</code></td><td align="left"><code>re.A</code></td><td align="left">使 <code>\w</code>, <code>\W</code>, <code>\b</code>, <code>\B</code>, <code>\s</code>, <code>\S</code> 只匹配 ASCII 字符，而不是完整的 Unicode 字符集 (Python 3 默认匹配 Unicode)。</td></tr><tr><td align="left"><code>re.UNICODE</code> (默认)</td><td align="left"><code>re.U</code></td><td align="left">使 <code>\w</code>, <code>\W</code>, <code>\b</code>, <code>\B</code>, <code>\s</code>, <code>\S</code>, <code>\d</code>, <code>\D</code> 匹配完整的 Unicode 字符集。这是 Python 3 的默认行为。</td></tr></tbody></table><p><strong>示例</strong>:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">text_multi = <span class="string">"""first line</span></span><br><span class="line"><span class="string">second line</span></span><br><span class="line"><span class="string">THIRD line"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># re.I (忽略大小写)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"\n--- Flags 示例 ---"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"re.I: <span class="subst">{re.findall(<span class="string">r'line'</span>, text_multi, re.IGNORECASE)}</span>"</span>) <span class="comment"># ['line', 'line', 'line']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># re.M (多行模式)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"re.M (^): <span class="subst">{re.findall(<span class="string">r'^s.*'</span>, text_multi, re.MULTILINE | re.IGNORECASE)}</span>"</span>) <span class="comment"># ['second line']</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"re.M ($): <span class="subst">{re.findall(<span class="string">r'line$'</span>, text_multi, re.MULTILINE | re.IGNORECASE)}</span>"</span>) <span class="comment"># ['line', 'line', 'line']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># re.S (DOTALL)</span></span><br><span class="line">text_dot = <span class="string">"Hello\nWorld"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"re.S (.): <span class="subst">{re.search(<span class="string">r'Hello.World'</span>, text_dot, re.DOTALL)}</span>"</span>) <span class="comment"># 匹配成功</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"No re.S (.): <span class="subst">{re.search(<span class="string">r'Hello.World'</span>, text_dot)}</span>"</span>)      <span class="comment"># 匹配失败 (None)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># re.X (VERBOSE)</span></span><br><span class="line"><span class="comment"># 一个复杂的邮箱模式，使用 VERBOSE 模式添加注释和空格</span></span><br><span class="line">pattern_verbose = <span class="string">r"""</span></span><br><span class="line"><span class="string">  ^                  # 匹配字符串开头</span></span><br><span class="line"><span class="string">  [\w\.\-]+          # 用户名部分 (字母、数字、下划线、点、连字符)</span></span><br><span class="line"><span class="string">  @                  # @ 符号</span></span><br><span class="line"><span class="string">  ([\w\-]+\.)+       # 域名部分 (允许子域名，如 mail.example.)</span></span><br><span class="line"><span class="string">  [a-zA-Z]{2,7}      # 顶级域名 (如 .com, .org)</span></span><br><span class="line"><span class="string">  $                  # 匹配字符串结尾</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">email = <span class="string">"test.user-1@sub.example.com"</span></span><br><span class="line">match_verbose = re.<span class="keyword">match</span>(pattern_verbose, email, re.VERBOSE)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"re.X (VERBOSE): <span class="subst">{<span class="string">'匹配成功'</span> <span class="keyword">if</span> match_verbose <span class="keyword">else</span> <span class="string">'匹配失败'</span>}</span>"</span>) <span class="comment"># 匹配成功</span></span><br></pre></td></tr></tbody></table></figure><h4 id="13-5-8-实际应用场景示例"><a href="#13-5-8-实际应用场景示例" class="headerlink" title="13.5.8 实际应用场景示例"></a>13.5.8 实际应用场景示例</h4><p><strong>场景 1: 验证中国大陆手机号 (简单示例)</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_china_mobile</span>(<span class="params">phone_number: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">"""简单验证中国大陆手机号码 (11位数字，常见号段)"""</span></span><br><span class="line">    <span class="comment"># 模式解释:</span></span><br><span class="line">    <span class="comment"># ^            匹配字符串开头</span></span><br><span class="line">    <span class="comment"># (?:...)      非捕获组</span></span><br><span class="line">    <span class="comment"># 1[3-9]       第一位是1，第二位是3到9</span></span><br><span class="line">    <span class="comment"># \d{9}        后面跟9位数字</span></span><br><span class="line">    <span class="comment"># $            匹配字符串结尾</span></span><br><span class="line">    pattern = <span class="string">r"^(?:1[3-9])\d{9}$"</span></span><br><span class="line">    <span class="keyword">if</span> re.<span class="keyword">match</span>(pattern, phone_number):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n--- 手机号验证 ---"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"13812345678: <span class="subst">{is_valid_china_mobile(<span class="string">'13812345678'</span>)}</span>"</span>) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"12012345678: <span class="subst">{is_valid_china_mobile(<span class="string">'12012345678'</span>)}</span>"</span>) <span class="comment"># False (号段不对)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"1381234567: <span class="subst">{is_valid_china_mobile(<span class="string">'1381234567'</span>)}</span>"</span>)  <span class="comment"># False (位数不够)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"138123456789: <span class="subst">{is_valid_china_mobile(<span class="string">'138123456789'</span>)}</span>"</span>)<span class="comment"># False (位数太多)</span></span><br></pre></td></tr></tbody></table></figure><p><em>注意</em>: 实际手机号验证可能需要更复杂的规则或查询号段数据库。</p><p><strong>场景 2: 从 Apache/Nginx 日志中提取 IP 地址和请求路径</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">log_line = <span class="string">'192.168.1.101 - - [03/May/2025:17:20:01 +0900] "GET /index.html HTTP/1.1" 200 1542 "-" "Mozilla/5.0..."'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模式解释:</span></span><br><span class="line"><span class="comment"># ^([\d\.]+)      捕获开头的 IP 地址 (数字和点的组合)</span></span><br><span class="line"><span class="comment"># \s+-\s+-\s+      匹配中间的 ' - - ' 部分</span></span><br><span class="line"><span class="comment"># \[.*?\]        匹配并忽略方括号内的时间戳 (非贪婪)</span></span><br><span class="line"><span class="comment"># \s+"           匹配时间戳后的空格和双引号</span></span><br><span class="line"><span class="comment"># (GET|POST|PUT|DELETE|HEAD) \s+  捕获请求方法 (GET, POST 等) 和空格</span></span><br><span class="line"><span class="comment"># ([^\s"]+)      捕获请求路径 (非空格、非双引号的字符)</span></span><br><span class="line"><span class="comment"># \s+HTTP/[\d\.]+" 捕获 HTTP 版本部分</span></span><br><span class="line"><span class="comment"># .* 匹配剩余部分</span></span><br><span class="line">pattern_log = <span class="string">r'^([\d\.]+) \s+-\s+-\s+ \[.*?\] \s+"(GET|POST|PUT|DELETE|HEAD)\s+([^\s"]+)\s+HTTP/[\d\.]+" .*'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> = re.<span class="keyword">match</span>(pattern_log, log_line)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">    ip_address = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">    method = <span class="keyword">match</span>.group(<span class="number">2</span>)</span><br><span class="line">    path = <span class="keyword">match</span>.group(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n--- 日志解析 ---"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"IP 地址: <span class="subst">{ip_address}</span>"</span>) <span class="comment"># 192.168.1.101</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"请求方法: <span class="subst">{method}</span>"</span>)   <span class="comment"># GET</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"请求路径: <span class="subst">{path}</span>"</span>)     <span class="comment"># /index.html</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"日志格式不匹配"</span>)</span><br></pre></td></tr></tbody></table></figure><p><strong>场景 3: 将 Markdown 样式的链接 <code>[text](url)</code> 转换为 HTML <code>&lt;a&gt;</code> 标签</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">markdown_text = <span class="string">"这是一个链接 [Google](https://www.google.com) 和另一个 [Python 官网](http://python.org) 的例子。"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模式解释:</span></span><br><span class="line"><span class="comment"># \[        匹配字面量 '['</span></span><br><span class="line"><span class="comment"># ([^\]]+)  捕获链接文本 (不是 ']' 的任意字符一次或多次)</span></span><br><span class="line"><span class="comment"># \]        匹配字面量 ']'</span></span><br><span class="line"><span class="comment"># \(        匹配字面量 '('</span></span><br><span class="line"><span class="comment"># ([^\)]+)  捕获 URL (不是 ')' 的任意字符一次或多次)</span></span><br><span class="line"><span class="comment"># \)        匹配字面量 ')'</span></span><br><span class="line">pattern_md_link = <span class="string">r'\[([^\]]+)\]\(([^\)]+)\)'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 re.sub 和反向引用 \1, \2 进行替换</span></span><br><span class="line">html_text = re.sub(pattern_md_link, <span class="string">r'&lt;a href="\2"&gt;\1&lt;/a&gt;'</span>, markdown_text)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n--- Markdown 转 HTML 链接 ---"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"原始 Markdown: <span class="subst">{markdown_text}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"转换后 HTML: <span class="subst">{html_text}</span>"</span>)</span><br><span class="line"><span class="comment"># 输出: 这是一个链接 &lt;a href="https://www.google.com"&gt;Google&lt;/a&gt; 和另一个 &lt;a href="http://python.org"&gt;Python 官网&lt;/a&gt; 的例子。</span></span><br></pre></td></tr></tbody></table></figure><h2 id="第十四章：深入解析并发编程"><a href="#第十四章：深入解析并发编程" class="headerlink" title="第十四章：深入解析并发编程"></a>第十四章：深入解析并发编程</h2><h3 id="14-并发编程基本概念"><a href="#14-并发编程基本概念" class="headerlink" title="14. 并发编程基本概念"></a>14. 并发编程基本概念</h3><p>并发编程是指程序设计中允许多个任务同时执行的编程模式，它的核心目标是 <strong>提升执行效率</strong>。通过并发编程，原本需要 20 分钟执行的代码可能只需要 1 分钟就能完成。</p><h4 id="进程调度机制解析"><a href="#进程调度机制解析" class="headerlink" title="进程调度机制解析"></a>进程调度机制解析</h4><p>CPU 在执行程序时会涉及进程调度，主要有两种切换情况：</p><ol><li><strong>I/O 操作触发切换</strong>：当程序遇到 I/O 操作时，操作系统会剥夺该程序对 CPU 的执行权限</li><li><strong>时间片用尽触发切换</strong>：当一个程序长时间占用 CPU 时，操作系统也会剥夺程序对 CPU 的执行权限</li></ol><p>所谓 I/O 操作，指的为 <code>阻断</code> 程序的操作，类似于 <code>input()</code> 函数会将程序暂停运行，达到某一个条件后才会接触阻塞状态</p><p>时间片即 CPU 分配给各个程序的时间，每个线程被分配一个时间段，称作它的时间片，即该进程允许运行的时间，使各个程序从表面上看是同时进行的。如果在时间片结束时进程还在运行，则 CPU 将被剥夺并分配给另一个进程。如果进程在时间片结束前阻塞或结束，则 CPU 当即进行切换。而不会造成 CPU 资源浪费。</p><p>在宏观上：我们可以同时打开多个应用程序，每个程序并行不悖，同时运行。</p><p>但在微观上：由于只有一个 CPU，一次只能处理程序要求的一部分，如何处理公平，一种方法就是引入时间片，每个程序轮流执行。</p><h4 id="进程的三大状态与生命周期"><a href="#进程的三大状态与生命周期" class="headerlink" title="进程的三大状态与生命周期"></a>进程的三大状态与生命周期</h4><p>进程在其生命周期中会经历三种基本状态：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250426212152903.png" alt="image-20250426212152903"></p><p>首先一个程序想要被运行，当用户双击图标后，此时程序就会从硬盘加载到内存，所有的程序想要被执行就必须经历就绪态，然后等待 CPU 执行，就绪态之后会进入进程调度，然后运行</p><p>运行时会出现以下几种情况：</p><blockquote><ul><li>1.时间片运行完毕，程序也执行完毕，释放资源后退出</li><li>2.程序运行过程遇到 I/O 操作（读写、发送网络请求）它是不需要 CPU 工作的，只要运行遇到了 I/O，操作系统就会把 CPU 拿走，执行其他的时间片，程序就会进入阻塞态，当 IO 请求完成后它就会结束阻塞态，回到就绪态里排队</li></ul></blockquote><h3 id="14-1-同步与异步编程模型"><a href="#14-1-同步与异步编程模型" class="headerlink" title="14.1 同步与异步编程模型"></a>14.1 同步与异步编程模型</h3><h4 id="同步和异步"><a href="#同步和异步" class="headerlink" title="同步和异步"></a>同步和异步</h4><p>同步：任务提交之后，原地等待任务的返回结果，等待的过程中不做任何事情</p><p>异步：任务提交之后，不再等待任务的返回结果，而是去做一些其他的事情</p><p>这两个概念主要 <strong>描述任务的提交方式</strong>：</p><blockquote><p>📝 <strong>实际应用</strong>：在 Web 开发中，同步请求会阻塞页面渲染，而异步请求（AJAX）则可以在后台处理数据，不影响用户体验。</p></blockquote><h4 id="阻塞和非阻塞"><a href="#阻塞和非阻塞" class="headerlink" title="阻塞和非阻塞"></a>阻塞和非阻塞</h4><p>这两个概念主要 <strong>描述进程的运行状态</strong>：</p><ul><li><strong>阻塞</strong>：对应进程的阻塞态</li><li><strong>非阻塞</strong>：对应进程的就绪态、运行态</li></ul><p>结合同步/异步和阻塞/非阻塞，可以形成四种组合：</p><ul><li>同步阻塞</li><li>同步非阻塞</li><li>异步阻塞</li><li><strong>异步非阻塞</strong>（CPU 利用率最高的一种模式）</li></ul><blockquote><p>🔍 在实际开发中，异步非阻塞模式是高并发系统的首选模式，因为它允许程序在等待 I/O 操作时继续执行其他任务。</p></blockquote><hr><h3 id="14-2-多进程编程技术"><a href="#14-2-多进程编程技术" class="headerlink" title="14.2 多进程编程技术"></a>14.2 多进程编程技术</h3><h4 id="进程基础"><a href="#进程基础" class="headerlink" title="进程基础"></a>进程基础</h4><p><strong>进程</strong> 是程序在计算机中的一次执行过程：</p><ul><li><strong>程序</strong> 是静态的可执行文件，占用磁盘空间</li><li><strong>进程</strong> 是动态的执行过程，占用计算机运行资源</li></ul><p>类比：一个工厂有三个车间，每个车间一个工人（共 3 人），并行处理任务，相当于一个程序创建三个进程，每个进程一个线程（共 3 人），并行处理任务。</p><h4 id="进程创建方法"><a href="#进程创建方法" class="headerlink" title="进程创建方法"></a>进程创建方法</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line">Process(target,name,args,kwargs)</span><br><span class="line"><span class="string">''''''</span><span class="string">''''''</span><span class="string">'''''</span></span><br><span class="line"><span class="string">功能 ： 创建进程对象</span></span><br><span class="line"><span class="string">参数 ：  </span></span><br><span class="line"><span class="string">	  target 绑定要执行的目标函数 </span></span><br><span class="line"><span class="string">   	  name 进程名，默认是Process-x(整数)</span></span><br><span class="line"><span class="string">	  args 元组，用于给target函数位置传参</span></span><br><span class="line"><span class="string">	  kwargs 字典，给target函数键值传参</span></span><br><span class="line"><span class="string">'''</span><span class="string">''''''</span><span class="string">''''''</span><span class="string">''''</span></span><br></pre></td></tr></tbody></table></figure><h5 id="方法一：使用-Process-类创建进程"><a href="#方法一：使用-Process-类创建进程" class="headerlink" title="方法一：使用 Process 类创建进程"></a>方法一：使用 Process 类创建进程</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建进程的标准方法</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker_function</span>(<span class="params">name, age</span>):</span><br><span class="line">    <span class="string">"""子进程执行过程中触发的函数"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"子进程ID:<span class="subst">{os.getpid()}</span>,父进程ID<span class="subst">{os.getppid()}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"子进程正在执行，参数name=<span class="subst">{name}</span>,age=<span class="subst">{age}</span>"</span>)</span><br><span class="line">    <span class="comment"># 模拟耗时操作</span></span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"子进程<span class="subst">{name}</span>执行完毕"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cpu_intensive_task</span>(<span class="params">number</span>):</span><br><span class="line">    <span class="string">"""CPU密集型任务"""</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(number):</span><br><span class="line">        result += i * i</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程<span class="subst">{os.getpid()}</span> 计算完成，结果为<span class="subst">{result}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"父进程ID:<span class="subst">{os.getpid()}</span>"</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建多个进程，体现并行处理能力</span></span><br><span class="line">    processes = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建四个检测执行不同人物</span></span><br><span class="line">    p1 = Process(target=worker_function, args=(<span class="string">"张三"</span>,), kwargs={<span class="string">"age"</span>: <span class="number">20</span>})</span><br><span class="line">    p2 = Process(target=worker_function, args=(<span class="string">"李四"</span>,), kwargs={<span class="string">"age"</span>: <span class="number">30</span>})</span><br><span class="line">    p3 = Process(target=cpu_intensive_task, args=(<span class="number">10000</span>,))</span><br><span class="line">    p4 = Process(target=cpu_intensive_task, args=(<span class="number">20000</span>,))</span><br><span class="line"></span><br><span class="line">    processes.extend([p1, p2, p3, p4]) <span class="comment"># 将进程添加到列表中</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.start() <span class="comment"># 启动进程</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待所有进程结束</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.join()</span><br><span class="line"></span><br><span class="line">    end_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"所有进程执行完毕，总耗时<span class="subst">{end_time - start_time:<span class="number">.2</span>f}</span>秒"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"如果使用单进程顺序执行，耗时会更长，因为是两个任务在执行，多进程可以充分利用多核CPU并行处理任务"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><blockquote><p>⚠️ <strong>重要提示</strong>：在 Windows 系统中，必须在 <code>if __name__ == '__main__'</code> 条件下创建进程，这是因为 Windows 使用 spawn 方式创建进程，会重新导入模块，可能导致递归创建进程。</p></blockquote><h5 id="方法二：继承-Process-类创建进程"><a href="#方法二：继承-Process-类创建进程" class="headerlink" title="方法二：继承 Process 类创建进程"></a>方法二：继承 Process 类创建进程</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过继承Process类创建进程</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkerProcess</span>(<span class="title class_ inherited__">Process</span>):</span><br><span class="line">    <span class="string">"""继承Process类的自定义进程"""</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""重写run方法，进程启动后会执行该方法"""</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"子进程ID:<span class="subst">{os.getpid()}</span>,父进程ID<span class="subst">{os.getppid()}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"子进程正在执行，参数name=<span class="subst">{self.name}</span>,age=<span class="subst">{self.age}</span>"</span>)</span><br><span class="line">        <span class="comment"># 模拟耗时操作</span></span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"子进程<span class="subst">{self.name}</span>执行完毕"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CPUIntensiveProcess</span>(<span class="title class_ inherited__">Process</span>):</span><br><span class="line">    <span class="string">"""CPU密集型任务进程"""</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, number</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.number = number</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""重写run方法，执行CPU密集型计算"""</span></span><br><span class="line">        result = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.number):</span><br><span class="line">            result += i * i</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"进程<span class="subst">{os.getpid()}</span> 计算完成，结果为<span class="subst">{result}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"父进程ID:<span class="subst">{os.getpid()}</span>"</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建多个进程，体现并行处理能力</span></span><br><span class="line">    processes = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建四个进程实例</span></span><br><span class="line">    p1 = WorkerProcess(<span class="string">"张三"</span>, <span class="number">20</span>)</span><br><span class="line">    p2 = WorkerProcess(<span class="string">"李四"</span>, <span class="number">30</span>)</span><br><span class="line">    p3 = CPUIntensiveProcess(<span class="number">10000</span>)</span><br><span class="line">    p4 = CPUIntensiveProcess(<span class="number">20000</span>)</span><br><span class="line"></span><br><span class="line">    processes.extend([p1, p2, p3, p4]) <span class="comment"># 将进程添加到列表中</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.start() <span class="comment"># 启动进程</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待所有进程结束</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.join()</span><br><span class="line"></span><br><span class="line">    end_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"所有进程执行完毕，总耗时<span class="subst">{end_time - start_time:<span class="number">.2</span>f}</span>秒"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="多进程常用方法表"><a href="#多进程常用方法表" class="headerlink" title="多进程常用方法表"></a>多进程常用方法表</h4><table><thead><tr><th>方法名</th><th>说明</th><th>实际应用场景</th></tr></thead><tbody><tr><td><code>Process(target=...)</code></td><td>创建进程对象</td><td>指定新进程要执行的函数</td></tr><tr><td><code>start()</code></td><td>启动进程</td><td>开始执行进程的任务</td></tr><tr><td><code>join()</code></td><td>等待进程结束</td><td>协调多个进程的执行顺序</td></tr><tr><td><code>is_alive()</code></td><td>检查进程是否存活</td><td>监控进程状态</td></tr><tr><td><code>terminate()</code></td><td>强制终止进程</td><td>中断异常或超时的进程</td></tr><tr><td><code>Queue()</code></td><td>创建进程安全的队列</td><td>进程间数据传递</td></tr><tr><td><code>put(item)</code></td><td>添加元素到队列</td><td>向队列中放入数据</td></tr><tr><td><code>get()</code></td><td>从队列获取元素</td><td>从队列获取数据</td></tr><tr><td><code>Pipe()</code></td><td>创建管道对象</td><td>进程间双向通信</td></tr></tbody></table><h4 id="进程号与进程信息获取"><a href="#进程号与进程信息获取" class="headerlink" title="进程号与进程信息获取"></a>进程号与进程信息获取</h4><p>在多进程编程中，获取进程信息对于调试和管理至关重要。Python 的 <code>multiprocessing</code> 模块提供了 <code>current_process()</code> 方法来获取当前进程的信息。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_info</span>():</span><br><span class="line">    <span class="string">"""打印当前进程的信息"""</span></span><br><span class="line">    <span class="comment"># 获取当前进程对象</span></span><br><span class="line">    process = multiprocessing.current_process()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程名称: <span class="subst">{process.name}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程ID: <span class="subst">{process.pid}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"父进程ID: <span class="subst">{os.getppid()}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程授权键: <span class="subst">{process.authkey}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程是否活跃: <span class="subst">{process.is_alive()}</span>"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    p = multiprocessing.Process(target=process_info, name=<span class="string">"自定义进程名"</span>)</span><br><span class="line">    p.start()</span><br><span class="line">    p.join()</span><br></pre></td></tr></tbody></table></figure><h4 id="进程间通信示例"><a href="#进程间通信示例" class="headerlink" title="进程间通信示例"></a>进程间通信示例</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process,Queue</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">## 子进程执行的函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">q</span>):</span><br><span class="line">    <span class="string">"""子进程函数，想往父进程发送消息，就往这个队列里放"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"子进程启动"</span>)</span><br><span class="line">    <span class="comment"># 向队列中添加数据</span></span><br><span class="line">    q.put(<span class="string">"我是一个队列数据"</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>) <span class="comment"># 模拟任务执行</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"子进程结束"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    q = Queue() <span class="comment"># 父进程创建队列</span></span><br><span class="line">    <span class="comment"># 创建一个子进程对象</span></span><br><span class="line">    p = Process(target=worker, args=(q,))</span><br><span class="line">    <span class="comment"># 启动子进程</span></span><br><span class="line">    p.start()</span><br><span class="line">    <span class="comment"># 主进程从队列中获取数据</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"主进程等待子进程数据...."</span>)</span><br><span class="line">    message = q.get() <span class="comment"># 阻塞等待数据</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"主进程收到来自于子进程的消息：<span class="subst">{message}</span>"</span>)</span><br><span class="line">    <span class="comment"># 等待子进程结束</span></span><br><span class="line">    p.join()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"主进程结束"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="复杂进程通信示例"><a href="#复杂进程通信示例" class="headerlink" title="复杂进程通信示例"></a>复杂进程通信示例</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Queue, Lock, Value, Array</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 子进程执行的函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker_with_args</span>(<span class="params">q, lock, value, arr, sleep_num</span>):</span><br><span class="line">    <span class="string">"""带有共享资源的工作函数</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        q: 队列</span></span><br><span class="line"><span class="string">        lock: 锁</span></span><br><span class="line"><span class="string">        value: 值</span></span><br><span class="line"><span class="string">        arr: 数组</span></span><br><span class="line"><span class="string">        sleep_num: 休眠时间</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 获取进程id</span></span><br><span class="line">    pid = os.getpid()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程<span class="subst">{pid}</span>开始执行"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用锁来保证数据安全</span></span><br><span class="line">    <span class="keyword">with</span> lock:  <span class="comment"># 相当于lock.acquire()和lock.release()的组合</span></span><br><span class="line">        value.value += <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(arr)):</span><br><span class="line">            arr[i] **= <span class="number">2</span>  <span class="comment"># 安全的修改数组元素</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"进程<span class="subst">{pid}</span>修改数组元素<span class="subst">{i}</span>为<span class="subst">{arr[i]}</span>"</span>)</span><br><span class="line">    <span class="comment"># 向队列中添加数据</span></span><br><span class="line">    q.put(<span class="string">f"这是一条来自于进程<span class="subst">{pid}</span>的信息"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 休眠模拟工作</span></span><br><span class="line">    time.sleep(sleep_num)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程<span class="subst">{pid}</span>执行完毕"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    解释输出逻辑:</span></span><br><span class="line"><span class="string">    1. 创建了4个进程，它们共享同一个数组arr，初始值为[1,2,3,4,5]</span></span><br><span class="line"><span class="string">    2. 每个进程获取锁后，会将数组中的每个元素进行平方操作(arr[i] **= 2)</span></span><br><span class="line"><span class="string">    3. 由于进程是按顺序启动的，但执行顺序不确定，所以:</span></span><br><span class="line"><span class="string">       - 第一个获得锁的进程将[1,2,3,4,5]平方为[1,4,9,16,25]</span></span><br><span class="line"><span class="string">       - 第二个获得锁的进程将[1,4,9,16,25]平方为[1,16,81,256,625]</span></span><br><span class="line"><span class="string">       - 第三个获得锁的进程将[1,16,81,256,625]平方为[1,256,6561,65536,390625]</span></span><br><span class="line"><span class="string">       - 第四个获得锁的进程将[1,256,6561,65536,390625]平方，但由于整数溢出，</span></span><br><span class="line"><span class="string">         导致最后两个元素变成了0和负数</span></span><br><span class="line"><span class="string">    4. 进程完成的顺序取决于sleep_num参数(1,2,3,4)，所以最先完成的是第一个进程</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 创建队列</span></span><br><span class="line">    q = Queue()</span><br><span class="line">    <span class="comment"># 创建锁</span></span><br><span class="line">    lock = Lock()</span><br><span class="line">    <span class="comment"># 创建一个共享值</span></span><br><span class="line">    value = Value(<span class="string">"i"</span>, <span class="number">0</span>)  <span class="comment"># "i"表示int类型</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个共享数组</span></span><br><span class="line">    arr = Array(<span class="string">"i"</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建多个子进程</span></span><br><span class="line">    processes = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        p = Process(target=worker_with_args, args=(q, lock, value, arr, i + <span class="number">1</span>))</span><br><span class="line">        p.start()</span><br><span class="line">        processes.extend([p])</span><br></pre></td></tr></tbody></table></figure><h4 id="进程池详解"><a href="#进程池详解" class="headerlink" title="进程池详解"></a>进程池详解</h4><p>进程池是一种管理多个进程的方式，可以简化并行计算的编程。Python 的 <code>multiprocessing</code> 模块中的 <code>Pool</code> 类和 <code>concurrent.futures</code> 模块的 <code>ProcessPoolExecutor</code> 类都提供了进程池功能。</p><h5 id="进程池的主要方法"><a href="#进程池的主要方法" class="headerlink" title="进程池的主要方法"></a>进程池的主要方法</h5><table><thead><tr><th>方法</th><th>描述</th><th>使用场景</th></tr></thead><tbody><tr><td><code>Pool(processes=None)</code></td><td>创建进程池，进程数默认为 CPU 核数</td><td>初始化进程池</td></tr><tr><td><code>apply(func, args)</code></td><td>阻塞执行任务</td><td>需要顺序执行且等待结果的场景</td></tr><tr><td><code>apply_async(func, args)</code></td><td>非阻塞执行任务</td><td>需要异步执行的场景</td></tr><tr><td><code>map(func, iterable)</code></td><td>并行执行映射任务</td><td>对列表元素并行处理</td></tr><tr><td><code>close()</code></td><td>关闭进程池，不再接受新任务</td><td>完成任务提交后</td></tr><tr><td><code>terminate()</code></td><td>立即终止所有工作进程</td><td>需要强制停止时</td></tr><tr><td><code>join()</code></td><td>等待所有工作进程退出</td><td>在 close()后使用</td></tr></tbody></table><h5 id="ProcessPoolExecutor-示例"><a href="#ProcessPoolExecutor-示例" class="headerlink" title="ProcessPoolExecutor 示例"></a>ProcessPoolExecutor 示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker_function</span>(<span class="params">name,age</span>):</span><br><span class="line">    <span class="string">"""进程池工作函数"""</span></span><br><span class="line">    pid = os.getpid()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程<span class="subst">{pid}</span>：<span class="subst">{name}</span>，<span class="subst">{age}</span>岁"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f"我的父进程是<span class="subst">{os.getppid()}</span> 我结束进程了"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">with</span> ProcessPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">            <span class="comment"># submit方法提交任务到进程池，返回一个Future对象</span></span><br><span class="line">            <span class="comment"># submit参数: function, *args, **kwargs</span></span><br><span class="line">            <span class="comment"># 这里的i作为worker_function函数的第二个参数age传入</span></span><br><span class="line">            future = executor.submit(worker_function, <span class="string">f"小明<span class="subst">{i}</span>"</span>, i)</span><br><span class="line">            <span class="comment"># 等待future对象返回结果</span></span><br><span class="line">            result = future.result()</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br></pre></td></tr></tbody></table></figure><p>Pool 对象示例</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker_function</span>(<span class="params">args</span>):</span><br><span class="line">    <span class="string">"""工作进程函数"""</span></span><br><span class="line">    name,age = args</span><br><span class="line">    pid = os.getpid()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程<span class="subst">{pid}</span>：<span class="subst">{name}</span>，<span class="subst">{age}</span>岁"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f"我的父进程是<span class="subst">{os.getppid()}</span> 我结束进程了"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">with</span> Pool() <span class="keyword">as</span> pool:</span><br><span class="line">        <span class="comment"># 准备参数列表</span></span><br><span class="line">        args_list = [(<span class="string">f"张三<span class="subst">{i}</span>号"</span>, i+<span class="number">18</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>)]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># map方法将函数应用于参数列表，并返回结果列表</span></span><br><span class="line">        <span class="comment"># pool.map 的工作原理:</span></span><br><span class="line">        <span class="comment"># 1. 它接收两个参数：要执行的函数(worker_function)和可迭代的参数列表(args_list)</span></span><br><span class="line">        <span class="comment"># 2. 它会自动将参数列表中的每个元素分配给不同的进程来执行</span></span><br><span class="line">        <span class="comment"># 3. 每个进程会调用worker_function并传入args_list中的一个元素作为参数</span></span><br><span class="line">        <span class="comment"># 4. 所有进程执行完毕后，map会收集所有进程的返回值，并按原始参数的顺序返回结果列表</span></span><br><span class="line">        <span class="comment"># 5. 这样实现了并行处理，提高了计算效率</span></span><br><span class="line">        result_list = pool.<span class="built_in">map</span>(worker_function, args_list)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 打印每个进程的返回结果</span></span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> result_list:</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br></pre></td></tr></tbody></table></figure><h4 id="进程号与进程信息获取-1"><a href="#进程号与进程信息获取-1" class="headerlink" title="进程号与进程信息获取"></a>进程号与进程信息获取</h4><p>在多进程编程中，获取进程信息对于调试和管理至关重要。Python 的 <code>multiprocessing</code> 模块提供了 <code>current_process()</code> 方法来获取当前进程的信息。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_info</span>():</span><br><span class="line">    <span class="string">"""打印当前进程的信息"""</span></span><br><span class="line">    <span class="comment"># 获取当前进程对象</span></span><br><span class="line">    process = multiprocessing.current_process()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程名称: <span class="subst">{process.name}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程ID: <span class="subst">{process.pid}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"父进程ID: <span class="subst">{os.getppid()}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程授权键: <span class="subst">{process.authkey}</span>"</span>) <span class="comment"># 授权键用于在进程间通信时进行身份验证。</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程是否活跃: <span class="subst">{process.is_alive()}</span>"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    p = multiprocessing.Process(target=process_info, name=<span class="string">"自定义进程名"</span>)</span><br><span class="line">    p.start()</span><br><span class="line">    p.join()</span><br></pre></td></tr></tbody></table></figure><h5 id="进程状态特殊情况"><a href="#进程状态特殊情况" class="headerlink" title="进程状态特殊情况"></a>进程状态特殊情况</h5><h6 id="僵尸进程"><a href="#僵尸进程" class="headerlink" title="僵尸进程"></a>僵尸进程</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">子进程死后还会有一些资源占用(进程号，进程的运行状态，运行时间)，等待父进程通过系统调用</span></span><br><span class="line"><span class="string">进行资源回收</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">相当于子进程死了之后，需要父进程来给他"收尸"</span></span><br><span class="line"><span class="string">除了init进程之外，所有的进程最后都会步入僵尸进程</span></span><br><span class="line"><span class="string">在一种情况下是会带来危害的:</span></span><br><span class="line"><span class="string">子进程退出之后，父进程没有及时处理，僵尸进程就会一直占用资源</span></span><br><span class="line"><span class="string">如果产生了大量僵尸进程，资源过度使用，系统没有可用的进程号，导致系统不能产生新的进程</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>注意：在 Windows 中，子进程退出后会立即被系统回收，不会产生真正的僵尸进程，在 Windows 系统中，不需要显式调用 wait 来回收子进程资源</p></blockquote><h6 id="孤儿进程"><a href="#孤儿进程" class="headerlink" title="孤儿进程"></a>孤儿进程</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">子进程处于存活状态，父进程意外死亡，操作系统就会开设一个孤儿院（init进程），用来管理</span></span><br><span class="line"><span class="string">孤儿进程，回收孤儿进程相关资源</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>📝 <strong>知识点</strong>：操作系统会自动处理孤儿进程，将它们的父进程更改为 init 进程（PID 为 1），所以孤儿进程不会造成资源泄漏问题。</p></blockquote><h3 id="14-3-多线程编程深入解析"><a href="#14-3-多线程编程深入解析" class="headerlink" title="14.3 多线程编程深入解析"></a>14.3 多线程编程深入解析</h3><h4 id="线程基础"><a href="#线程基础" class="headerlink" title="线程基础"></a>线程基础</h4><p><strong>线程</strong> 是轻量级的进程，也是多任务编程的一种方式：</p><ul><li>一个进程中可以包含多个线程</li><li>线程也是一个运行行为，消耗计算机资源</li><li>一个进程中的所有线程共享这个进程的资源</li><li>线程的创建和销毁消耗资源远小于进程</li></ul><p>一个工厂至少有一个车间，一个车间中至少有一个工人，工人去利用车间的设备工作；</p><p>一个程序至少有一个进程，一个进程中至少有一个线程，线程去利用进程的资源工作。</p><h4 id="线程创建方法"><a href="#线程创建方法" class="headerlink" title="线程创建方法"></a>线程创建方法</h4><h5 id="方法一：使用-Thread-类创建线程"><a href="#方法一：使用-Thread-类创建线程" class="headerlink" title="方法一：使用 Thread 类创建线程"></a>方法一：使用 Thread 类创建线程</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker_function</span>(<span class="params">name,delay</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{name}</span>开始工作"</span>)</span><br><span class="line">    time.sleep(delay)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{name}</span>结束工作"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    t1 = Thread(target=worker_function,args=(<span class="string">"线程1"</span>,<span class="number">2</span>))</span><br><span class="line">    t2 = Thread(target=worker_function,args=(<span class="string">"线程2"</span>,<span class="number">4</span>))</span><br><span class="line">    <span class="comment"># 启动线程</span></span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br><span class="line">    <span class="comment"># 等待线程结束</span></span><br><span class="line">    t1.join()</span><br><span class="line">    t2.join()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"主线程结束"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="方法二：继承-Thread-类创建线程"><a href="#方法二：继承-Thread-类创建线程" class="headerlink" title="方法二：继承 Thread 类创建线程"></a>方法二：继承 Thread 类创建线程</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyThread</span>(<span class="title class_ inherited__">Thread</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,name,message</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.message = message</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{self.name}</span>开始执行"</span>)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{self.name}</span>执行完毕，消息：<span class="subst">{self.message}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    t1 = MyThread(name=<span class="string">"线程1"</span>,message=<span class="string">"子进程操作完毕"</span>)</span><br><span class="line">    t2 = MyThread(name=<span class="string">"线程2"</span>,message=<span class="string">"子进程操作完毕"</span>)</span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br><span class="line">    t1.join()</span><br><span class="line">    t2.join()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"主进程执行完毕"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="线程常用方法表"><a href="#线程常用方法表" class="headerlink" title="线程常用方法表"></a>线程常用方法表</h4><table><thead><tr><th>方法名</th><th>说明</th><th>实际应用场景</th></tr></thead><tbody><tr><td><code>start()</code></td><td>启动线程</td><td>开始执行线程任务</td></tr><tr><td><code>run()</code></td><td>定义线程执行的任务</td><td>重写该方法自定义线程行为</td></tr><tr><td><code>join()</code></td><td>等待线程结束</td><td>协调线程执行顺序</td></tr><tr><td><code>join(timeout)</code></td><td>等待线程结束，有超时时间</td><td>防止无限等待</td></tr><tr><td><code>is_alive()</code></td><td>检查线程是否活动</td><td>监控线程状态</td></tr><tr><td><code>getName()</code></td><td>获取线程名称</td><td>调试和日志记录</td></tr><tr><td><code>setName(name)</code></td><td>设置线程名称</td><td>便于识别不同线程</td></tr><tr><td><code>setDaemon(T/F)</code></td><td>设置为守护线程</td><td>随主线程结束而结束的后台任务</td></tr><tr><td><code>isDaemon()</code></td><td>检查是否为守护线程</td><td>确认线程类型</td></tr><tr><td><code>getId()</code></td><td>获取线程 ID</td><td>唯一标识线程</td></tr><tr><td><code>current_thread</code></td><td>获取当前线程对象</td><td>在函数中获取当前执行线程</td></tr></tbody></table><h4 id="线程使用实例"><a href="#线程使用实例" class="headerlink" title="线程使用实例"></a>线程使用实例</h4><h5 id="基本线程示例"><a href="#基本线程示例" class="headerlink" title="基本线程示例"></a>基本线程示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">url,session</span>):</span><br><span class="line">    <span class="string">"""访问网站下载文件"""</span></span><br><span class="line">    <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"读取<span class="subst">{url}</span> 长度为<span class="subst">{<span class="built_in">len</span>(response.content)}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_all_sites</span>(<span class="params">urls</span>):</span><br><span class="line">    <span class="string">"""单线程下载所有网站"""</span></span><br><span class="line">    <span class="keyword">with</span> requests.Session() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">            download_file(url,session)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_site_thread</span>(<span class="params">url,session</span>):</span><br><span class="line">    <span class="string">"""多线程下载网站"""</span></span><br><span class="line">    download_file(url,session)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_all_sites_thread</span>(<span class="params">urls</span>):</span><br><span class="line">    <span class="string">"""多线程下载所有网站"""</span></span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">with</span> requests.Session() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">            thread = Thread(target=download_site_thread, args=(url,session))</span><br><span class="line">            threads.append(thread)</span><br><span class="line">            thread.start()</span><br><span class="line">        <span class="comment"># 等待所有线程结束</span></span><br><span class="line">        <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">            thread.join()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 准备一些网站用于演示</span></span><br><span class="line">    sites = [</span><br><span class="line">        <span class="string">"https://www.baidu.com"</span>,</span><br><span class="line">        <span class="string">"https://www.sina.com.cn"</span>,</span><br><span class="line">        <span class="string">"https://www.qq.com"</span>,</span><br><span class="line">        <span class="string">"https://www.163.com"</span>,</span><br><span class="line">        <span class="string">"https://www.sohu.com"</span>,</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># 单线程下载</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"=======单线程下载开始========"</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    download_all_sites(sites)</span><br><span class="line">    end_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"单线程下载结束，耗时<span class="subst">{end_time-start_time}</span>秒"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n=======多线程下载开始========"</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    download_all_sites_thread(sites)</span><br><span class="line">    end_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"多线程下载结束，耗时<span class="subst">{end_time-start_time}</span>秒"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\nIO密集型任务（如网络请求）适合使用多线程，可以显著提高性能"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"这是因为当一个线程等待IO操作完成时，其他线程可以继续执行"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="守护线程示例"><a href="#守护线程示例" class="headerlink" title="守护线程示例"></a>守护线程示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker_function</span>(<span class="params">thread_name</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程 <span class="subst">{thread_name}</span> 启动"</span>)</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程 <span class="subst">{thread_name}</span> 结束"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    t1 = Thread(target=worker_function, args=(<span class="string">"Thread-1"</span>,))</span><br><span class="line">    t2 = Thread(target=worker_function, args=(<span class="string">"Thread-2"</span>,))</span><br><span class="line">    <span class="comment"># 设置t3为守护线程，主线程结束时，t3线程也会结束</span></span><br><span class="line">    t3 = Thread(target=worker_function, args=(<span class="string">"Thread-3"</span>,), daemon=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># t3.setDaemon(True) # 已经被废弃的API，现在使用daemon=True参数代替</span></span><br><span class="line">    <span class="comment"># 启动普通线程</span></span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br><span class="line">    <span class="comment"># 启动守护线程</span></span><br><span class="line">    t3.start()  <span class="comment"># 这里需要启动t3线程，否则t3不会执行</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待普通线程完成</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"等待线程<span class="subst">{t1.name}</span> + <span class="subst">{t2.name}</span>完成..."</span>)</span><br><span class="line">    t1.join()</span><br><span class="line">    t2.join()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检测线程状态</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{t1.name}</span>是否存活：<span class="subst">{t1.is_alive()}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{t2.name}</span>是否存活：<span class="subst">{t2.is_alive()}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{t3.name}</span>是否存活：<span class="subst">{t3.is_alive()}</span>"</span>)  <span class="comment"># True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主线程休眠一段时间，以便守护线程有机会执行</span></span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"主线程结束"</span>)</span><br></pre></td></tr></tbody></table></figure><blockquote><p>💡 <strong>守护线程特性</strong>：守护线程会随着主线程的结束而结束，不管它是否执行完成。适用于需要在后台运行但不要求必须完成的任务，如监控、日志记录等。</p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">'%(asctime)s %(levelname)s %(message)s'</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">system_monitor</span>(<span class="params">interval=<span class="number">1</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    守护线程：系统资源监控器</span></span><br><span class="line"><span class="string">    持续监控CPU使用率和内存使用情况，并记录到日志中</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    logging.info(<span class="string">'系统监控守护线程启动'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            cpu_usage = psutil.cpu_percent(interval=interval)</span><br><span class="line">            mem_usage = psutil.virtual_memory().percent</span><br><span class="line">            logging.info(<span class="string">f'CPU使用率：<span class="subst">{cpu_usage}</span>% 内存使用率：<span class="subst">{mem_usage}</span>%'</span>)</span><br><span class="line">            time.sleep(interval)</span><br><span class="line">            <span class="keyword">if</span> cpu_usage &gt; <span class="number">80</span> <span class="keyword">or</span> mem_usage &gt; <span class="number">80</span>:</span><br><span class="line">                logging.warning(<span class="string">'系统资源占用过高，请及时处理'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f'系统监控线程异常：<span class="subst">{e}</span>'</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        logging.info(<span class="string">'系统监控守护线程结束'</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 创建并启动系统监控守护线程</span></span><br><span class="line">    monitor_thread = Thread(target=system_monitor,args=(<span class="number">1</span>,),daemon=<span class="literal">True</span>,name=<span class="string">"MonitorThread"</span>)</span><br><span class="line">    monitor_thread.start()</span><br><span class="line">    <span class="comment"># 主线程继续执行一段时间，守护线程在后台运行</span></span><br><span class="line">    logging.info(<span class="string">"主线程运行中，监控守护线程在后台运行..."</span>)</span><br><span class="line">    time.sleep(<span class="number">30</span>)  <span class="comment"># 运行30秒后结束</span></span><br><span class="line">    <span class="comment"># 主线程结束，守护线程将自动终止</span></span><br><span class="line">    logging.info(<span class="string">f"监控守护线程是否存活: <span class="subst">{monitor_thread.is_alive()}</span>"</span>)</span><br><span class="line">    logging.info(<span class="string">"主线程结束，守护线程将自动终止"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="线程池详解"><a href="#线程池详解" class="headerlink" title="线程池详解"></a>线程池详解</h4><p>线程池是一种管理线程资源的方式，它预先创建一定数量的线程，然后复用这些线程来执行任务，避免了频繁创建和销毁线程的开销。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个耗时函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">time_consuming_task</span>(<span class="params">n</span>):</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> n * n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="comment"># 使用submit方法提交任务给线程池执行，返回Future对象列表</span></span><br><span class="line">        futures = [executor.submit(time_consuming_task, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">21</span>)]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"任务已提交，主线程继续执行........."</span>)</span><br><span class="line">        <span class="comment"># 等待所有任务完成，并获取结果</span></span><br><span class="line">        results = [future.result() <span class="keyword">for</span> future <span class="keyword">in</span> futures]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"任务执行完毕，结果为：<span class="subst">{results}</span>"</span>)</span><br><span class="line">    end_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"总共耗时：<span class="subst">{end_time - start_time}</span>秒"</span>)</span><br><span class="line">    <span class="comment">### 线程池在with语句结束时自动关闭</span></span><br></pre></td></tr></tbody></table></figure><h5 id="ThreadPoolExecutor-主要方法"><a href="#ThreadPoolExecutor-主要方法" class="headerlink" title="ThreadPoolExecutor 主要方法"></a>ThreadPoolExecutor 主要方法</h5><table><thead><tr><th>方法名</th><th>简洁解释</th><th>适用场景</th></tr></thead><tbody><tr><td><code>submit(fn, *args)</code></td><td>异步执行函数，返回 Future 对象</td><td>单独提交任务并获取结果</td></tr><tr><td><code>map(func, *iterables)</code></td><td>对每个输入并行执行函数</td><td>批量处理类似任务</td></tr><tr><td><code>shutdown(wait=True)</code></td><td>关闭执行器</td><td>资源释放</td></tr><tr><td><code>result()</code></td><td>获取任务执行结果</td><td>获取异步任务的返回值</td></tr><tr><td><code>add_done_callback(fn)</code></td><td>添加任务完成回调函数</td><td>任务完成后的后续处理</td></tr><tr><td><code>as_completed()</code></td><td>返回已完成任务的迭代器</td><td>先处理先完成的任务</td></tr><tr><td><code>wait()</code></td><td>等待任务完成</td><td>任务同步点</td></tr></tbody></table><blockquote><p>🔍 <strong>深入理解</strong>：线程池最大的好处是控制并发数量，防止系统资源被耗尽。在实际开发中，建议将线程数设置为 CPU 核心数的 1-5 倍，具体取决于任务是 I/O 密集型还是 CPU 密集型。</p></blockquote><h5 id="完整示例"><a href="#完整示例" class="headerlink" title="完整示例"></a>完整示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor,as_completed,wait</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">time_consuming_task</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="string">"""耗时任务"""</span></span><br><span class="line">    time.sleep(n % <span class="number">3</span> +<span class="number">1</span>) <span class="comment"># 不同的n值，耗时不同</span></span><br><span class="line">    <span class="keyword">return</span> n * n</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task_done_callback</span>(<span class="params">future</span>):</span><br><span class="line">    <span class="string">"""任务完成后触发的回调函数"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"任务完成，结果为<span class="subst">{future.result()}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"===== 1. submit方法示例 ====="</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">3</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        future_list = [executor.submit(time_consuming_task, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"提交任务完成，等待结果..."</span>)</span><br><span class="line">        <span class="comment"># result()：获取任务执行结果，会阻塞直到所有任务完成</span></span><br><span class="line">        <span class="comment"># as_completed(): 返回已完成任务的迭代器</span></span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> as_completed(future_list):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"任务<span class="subst">{future.result()}</span>完成"</span>)</span><br><span class="line">    end_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"总耗时：<span class="subst">{end_time - start_time}</span>秒"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n===== 2. map方法示例 ====="</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="comment"># map()：对每一个输入并行执行函数，返回结果迭代器</span></span><br><span class="line">        <span class="comment"># 与submit不同，map会自动收集结果并按输入顺序返回</span></span><br><span class="line">        <span class="comment"># 不需要手动调用future.result()</span></span><br><span class="line">        results = executor.<span class="built_in">map</span>(time_consuming_task, <span class="built_in">range</span>(<span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"任务提交完成，直接获取有序结果..."</span>)</span><br><span class="line">        <span class="comment"># 转换为列表时会按照输入顺序返回结果，如果任务未完成会在这里阻塞等待</span></span><br><span class="line">        results_list = <span class="built_in">list</span>(results)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"结果：<span class="subst">{results_list}</span>"</span>)</span><br><span class="line">    end_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"总耗时：<span class="subst">{end_time - start_time}</span>秒"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n===== 3. add_done_callback示例 ====="</span>)</span><br><span class="line">    <span class="comment"># add_done_callback(fn): 添加任务完成回调函数</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>):</span><br><span class="line">            future = executor.submit(time_consuming_task, i)</span><br><span class="line">            <span class="comment"># 添加回调函数，任务完成后自动调用</span></span><br><span class="line">            future.add_done_callback(task_done_callback)</span><br><span class="line">            futures.append(future)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"已添加回调函数，主线程继续执行..."</span>)</span><br><span class="line">        <span class="comment"># 等待所有任务完成</span></span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> futures:</span><br><span class="line">            future.result()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"耗时：<span class="subst">{time.time() - start_time}</span>秒"</span>)</span><br><span class="line">    <span class="comment"># 适用场景：任务完成后的后续处理，适合需要在任务完成时执行额外操作而不阻塞主线程</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n===== 4. wait示例 ====="</span>)</span><br><span class="line">    <span class="comment"># wait(): 等待任务完成</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = [executor.submit(time_consuming_task, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>)]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"任务已提交，等待所有任务完成..."</span>)</span><br><span class="line">        <span class="comment"># 等待所有任务完成</span></span><br><span class="line">        done, not_done = wait(futures)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"完成的任务数: <span class="subst">{<span class="built_in">len</span>(done)}</span>, 未完成的任务数: <span class="subst">{<span class="built_in">len</span>(not_done)}</span>"</span>)</span><br><span class="line">        results = [future.result() <span class="keyword">for</span> future <span class="keyword">in</span> done]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"所有任务执行完毕，结果为：<span class="subst">{results}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"耗时：<span class="subst">{time.time() - start_time}</span>秒"</span>)</span><br><span class="line">    <span class="comment"># 适用场景：任务同步点，适合需要等待一组任务全部或部分完成后再继续执行的情况</span></span><br></pre></td></tr></tbody></table></figure><h4 id="Event-事件同步机制"><a href="#Event-事件同步机制" class="headerlink" title="Event 事件同步机制"></a>Event 事件同步机制</h4><p>Event 是一种线程同步机制，用于协调多个线程的执行顺序。它本质上是一个内部的标志位，线程可以等待这个标志位被设置，也可以设置或清除这个标志位。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread, Event</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建一个事件对象</span></span><br><span class="line">event = Event()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 模拟公交车到站的函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bus_stop</span>():</span><br><span class="line">    <span class="string">"""模拟公交车到站过程"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'公交车即将到站'</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)  <span class="comment"># 模拟行驶时间</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'公交车已到站&lt;====&gt;'</span>*<span class="number">10</span>)</span><br><span class="line">    <span class="comment"># 设置事件，通知等待的乘客</span></span><br><span class="line">    event.<span class="built_in">set</span>()  <span class="comment"># 发射信号，让等车的人上车</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">passenger</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="string">"""模拟乘客等车</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        name: 乘客名称</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 等待公交车到站</span></span><br><span class="line">    <span class="built_in">print</span>(name, <span class="string">'等车中'</span>)</span><br><span class="line">    event.wait()  <span class="comment"># 阻塞等待信号</span></span><br><span class="line">    <span class="built_in">print</span>(name, <span class="string">'出发！！！！！！！！！！！！！！！！！！！！！！！！！！'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 创建公交车线程</span></span><br><span class="line">    t1 = Thread(target=bus_stop)</span><br><span class="line">    t1.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建多个乘客线程</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        t = Thread(target=passenger, args=(<span class="string">f'乘客<span class="subst">{i}</span>'</span>,))</span><br><span class="line">        t.start()</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)  <span class="comment"># 模拟乘客陆续到站</span></span><br></pre></td></tr></tbody></table></figure><h5 id="Event-主要方法"><a href="#Event-主要方法" class="headerlink" title="Event 主要方法"></a>Event 主要方法</h5><table><thead><tr><th>方法名</th><th>描述</th><th>使用场景</th></tr></thead><tbody><tr><td><code>set()</code></td><td>设置事件标志为 True</td><td>通知等待的线程继续执行</td></tr><tr><td><code>clear()</code></td><td>清除事件标志为 False</td><td>重置事件状态，使线程再次等待</td></tr><tr><td><code>is_set()</code></td><td>检查事件状态</td><td>判断事件是否已被设置</td></tr><tr><td><code>wait()</code></td><td>等待事件被设置</td><td>阻塞线程直到事件被设置或超时</td></tr></tbody></table><blockquote><p>🌟 <strong>应用场景</strong>：Event 适合实现一次性通知多个线程的场景，比如多个工作线程等待初始化完成、多个消费者等待数据准备就绪等。在 Web 开发中，可用于协调多个后台任务的启动时机。</p></blockquote><h4 id="定时器-Timer"><a href="#定时器-Timer" class="headerlink" title="定时器(Timer)"></a>定时器(Timer)</h4><p>定时器是线程的一个特殊应用，用于在指定时间后执行某个操作。Python 的 <code>threading</code> 模块提供了 <code>Timer</code> 类来实现这一功能。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Timer</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delayed_greeting</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="string">"""延迟执行的问候函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        name: 要问候的对象名称</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{name}</span>说: 哈哈，我是延迟1秒后才执行的!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建一个定时器，1秒后执行hello函数，参数为"小明"</span></span><br><span class="line">timer = Timer(<span class="number">1</span>, delayed_greeting, args=(<span class="string">"小明"</span>,))</span><br><span class="line"><span class="comment">## 启动定时器</span></span><br><span class="line">timer.start()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"定时器已启动，但greeting函数还未执行..."</span>)</span><br><span class="line"><span class="comment">## 主线程继续执行，不会被阻塞</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>💡 <strong>实用技巧</strong>：Timer 可用于实现超时处理、延迟重试、定时清理等场景。例如，在网络编程中，可以用 Timer 设置请求超时机制；在数据同步中，可以用 Timer 定期执行同步任务。</p></blockquote><h3 id="14-4-多进程-VS-多线程性能分析"><a href="#14-4-多进程-VS-多线程性能分析" class="headerlink" title="14.4 多进程 VS 多线程性能分析"></a>14.4 多进程 VS 多线程性能分析</h3><p>在 Python 中，由于 GIL(全局解释器锁)的存在，多线程并不能真正实现并行计算。因此，根据任务特性选择合适的并发模型十分重要。</p><h4 id="不同场景的最优选择"><a href="#不同场景的最优选择" class="headerlink" title="不同场景的最优选择"></a>不同场景的最优选择</h4><table><thead><tr><th>任务类型</th><th>多进程</th><th>多线程</th><th>推荐选择</th></tr></thead><tbody><tr><td>计算密集型</td><td>效率高，可利用多核</td><td>受 GIL 限制，效率相对较低</td><td>多进程</td></tr><tr><td>IO 密集型</td><td>资源占用大</td><td>资源占用小，效率与多进程相当</td><td>多线程</td></tr></tbody></table><blockquote><p>📊 <strong>实际应用建议</strong>：现代开发中，约 90%以上的程序属于 IO 密集型，适合使用多线程；对于数据分析、图像处理等计算密集型任务，则推荐使用多进程。也可以考虑混合使用：多进程下每个进程内再使用多线程。</p></blockquote><h4 id="计算密集型任务测试"><a href="#计算密集型任务测试" class="headerlink" title="计算密集型任务测试"></a>计算密集型任务测试</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">计算密集型任务对比测试</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task</span>():</span><br><span class="line">    <span class="string">"""计算密集型任务"""</span></span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000000</span>):  <span class="comment"># 执行大量计算</span></span><br><span class="line">        res += i</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    l = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        <span class="comment"># 使用多进程或多线程(取消相应的注释来测试)</span></span><br><span class="line">        p = Process(target=task)  <span class="comment"># 多进程：结果大概是1.65秒</span></span><br><span class="line">        <span class="comment"># p = Thread(target=task)   # 多线程：结果大概是4.18秒</span></span><br><span class="line">        </span><br><span class="line">        p.start()</span><br><span class="line">        l.append(p)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> l:</span><br><span class="line">        p.join()</span><br><span class="line"></span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"花费时间"</span>, end - start_time)</span><br></pre></td></tr></tbody></table></figure><h4 id="IO-密集型任务测试"><a href="#IO-密集型任务测试" class="headerlink" title="IO 密集型任务测试"></a>IO 密集型任务测试</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">IO密集型任务对比测试</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task</span>():</span><br><span class="line">    <span class="string">"""IO密集型任务，使用sleep模拟IO操作"""</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)  <span class="comment"># 模拟IO等待</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    l = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):  <span class="comment"># 创建100个任务</span></span><br><span class="line">        <span class="comment"># 使用多进程或多线程(取消相应的注释来测试)</span></span><br><span class="line">        <span class="comment"># p = Process(target=task)  # 多进程：结果约19.34秒</span></span><br><span class="line">        p = Thread(target=task)   <span class="comment"># 多线程：结果约1.01秒</span></span><br><span class="line">        </span><br><span class="line">        p.start()</span><br><span class="line">        l.append(p)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> l:</span><br><span class="line">        p.join()</span><br><span class="line"></span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"花费时间"</span>, end - start_time)</span><br></pre></td></tr></tbody></table></figure><blockquote><p>⚠️ <strong>性能陷阱</strong>：多线程在 IO 密集型任务中表现出色，但过多的线程可能导致线程切换开销增大，反而降低效率。经验值是控制线程数为 CPU 核心数的 2-4 倍。</p></blockquote><h3 id="14-5-协程技术详解"><a href="#14-5-协程技术详解" class="headerlink" title="14.5 协程技术详解"></a>14.5 协程技术详解</h3><h4 id="协程基础概念"><a href="#协程基础概念" class="headerlink" title="协程基础概念"></a>协程基础概念</h4><p><strong>协程</strong>（Coroutine）也称为微线程，是一种用户态内的上下文切换技术，可以在单线程下实现并发效果。协程通过巧妙的编程技巧实现了程序主动让出和恢复执行的能力，使得单线程内可以 “模拟” 出并发的效果。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">进程：资源单位 - 系统分配资源的基本单位，拥有独立的内存空间</span></span><br><span class="line"><span class="string">线程：执行单位 - CPU调度和执行的最小单位，共享所属进程的内存空间</span></span><br><span class="line"><span class="string">协程：根本不存在，它是程序员人为创造出来的(切换+保存状态)</span></span><br><span class="line"><span class="string">当程序遇到IO的时候，通过我们的代码，让我们的程序自动完成切换</span></span><br><span class="line"><span class="string">也就是通过代码监听IO，一旦程序遇到IO，就在代码层面自动切换，给CPU的感觉就是我们的程序没有IO</span></span><br><span class="line"><span class="string">换句话说也就是我们欺骗了CPU</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></tbody></table></figure><p>协程的核心原理是 “<strong>切换+保存状态</strong>“，即在多个任务之间来回切换，每次切换都保存当前任务的执行状态，下次切换回来继续执行。在 Python 中，可以通过 <code>yield</code> 关键字、<code>greenlet</code> 模块或 <code>asyncio</code> 库实现协程。</p><blockquote><p>🔍 <strong>深入理解</strong>：协程不是提升计算效率，而是提升 IO 效率。在 IO 密集型应用中，协程可以让 CPU 在等待 IO 的同时执行其他任务，从而提高资源利用率。协程的切换不需要操作系统参与，开销远小于线程切换。</p></blockquote><table><thead><tr><th>概念</th><th>资源占用</th><th>切换开销</th><th>实现方式</th><th>适用场景</th></tr></thead><tbody><tr><td>进程</td><td>高（独立内存空间）</td><td>高（涉及内存映射）</td><td>操作系统调度</td><td>CPU 密集型，需要隔离的任务</td></tr><tr><td>线程</td><td>中（共享内存但有独立栈）</td><td>中（上下文切换）</td><td>操作系统调度</td><td>混合型任务，兼顾计算与 IO</td></tr><tr><td>协程</td><td>低（共享线程内全部资源）</td><td>低（用户态切换）</td><td>程序自行控制</td><td>IO 密集型，高并发网络应用</td></tr></tbody></table><h4 id="协程效率对比"><a href="#协程效率对比" class="headerlink" title="协程效率对比"></a>协程效率对比</h4><p>对于计算密集型任务时，使用协程反而会降低效率！</p><h5 id="串行执行"><a href="#串行执行" class="headerlink" title="串行执行"></a>串行执行</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f1</span>():</span><br><span class="line">    <span class="string">"""计算密集型函数1"""</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000000</span>):</span><br><span class="line">        n += i  <span class="comment"># 执行简单累加计算</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f2</span>():</span><br><span class="line">    <span class="string">"""计算密集型函数2"""</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000000</span>):</span><br><span class="line">        n += i  <span class="comment"># 执行简单累加计算</span></span><br><span class="line"></span><br><span class="line">start_time = time.time()</span><br><span class="line">f1()  <span class="comment"># 顺序执行f1</span></span><br><span class="line">f2()  <span class="comment"># 然后执行f2</span></span><br><span class="line"><span class="comment">## 保留两位小数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"串行执行总共用时：%.2f秒"</span> % (time.time() - start_time))  <span class="comment"># 串行执行总共用时：0.84秒</span></span><br></pre></td></tr></tbody></table></figure><h5 id="使用-yield-实现协程切换"><a href="#使用-yield-实现协程切换" class="headerlink" title="使用 yield 实现协程切换"></a>使用 yield 实现协程切换</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f1</span>():</span><br><span class="line">    <span class="string">"""带yield的计算密集型函数1"""</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000000</span>):</span><br><span class="line">        n += i</span><br><span class="line">        <span class="keyword">yield</span>  <span class="comment"># 主动让出执行权，保存当前执行状态</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f2</span>():</span><br><span class="line">    <span class="string">"""使用f1的生成器进行交替执行"""</span></span><br><span class="line">    g = f1()  <span class="comment"># 创建生成器对象</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000000</span>):</span><br><span class="line">        n += i</span><br><span class="line">        <span class="built_in">next</span>(g)  <span class="comment"># 切换到f1执行一步，f1会执行到下一个yield后暂停</span></span><br><span class="line"></span><br><span class="line">start_time = time.time()</span><br><span class="line">f2()  <span class="comment"># 执行f2，内部会与f1交替执行</span></span><br><span class="line"><span class="comment">## 保留两位小数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"yield协程用时：%.2f秒"</span> % (time.time() - start_time))  <span class="comment"># 约1.45秒</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>⚠️ <strong>注意事项</strong>：对于计算密集型任务，协程切换反而会增加开销，降低效率；但对于 IO 密集型任务，协程切换可以显著提高效率。这是因为在 IO 等待期间，协程可以切换到其他任务继续执行，避免了 CPU 空闲。</p></blockquote><h4 id="greenlet-模块（了解）"><a href="#greenlet-模块（了解）" class="headerlink" title="greenlet 模块（了解）"></a>greenlet 模块（了解）</h4><p>greenlet 是一个轻量级的协程库，提供了基本的协程实现。它允许在不使用回调函数的情况下，在不同函数间来回切换执行，实现了所谓的 “确定性切换”。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> greenlet <span class="keyword">import</span> greenlet</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_a</span>():</span><br><span class="line">    <span class="string">"""协程函数a"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'函数a正在运行'</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)  <span class="comment"># 模拟某些操作</span></span><br><span class="line">        b.switch()  <span class="comment"># 主动切换到函数b执行</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_b</span>():</span><br><span class="line">    <span class="string">"""协程函数b"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'函数b正在运行'</span>)</span><br><span class="line">        time.sleep(<span class="number">2</span>)  <span class="comment"># 模拟某些操作</span></span><br><span class="line">        a.switch()  <span class="comment"># 切换回函数a执行</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 创建两个greenlet对象</span></span><br><span class="line">    a = greenlet(func_a)  <span class="comment"># 将函数封装为greenlet对象</span></span><br><span class="line">    b = greenlet(func_b)  <span class="comment"># 将函数封装为greenlet对象</span></span><br><span class="line">    <span class="comment"># 从函数a开始执行</span></span><br><span class="line">    a.switch()  <span class="comment"># 启动协程a</span></span><br></pre></td></tr></tbody></table></figure><h5 id="greenlet-核心方法与属性"><a href="#greenlet-核心方法与属性" class="headerlink" title="greenlet 核心方法与属性"></a>greenlet 核心方法与属性</h5><table><thead><tr><th>方法/属性名</th><th>描述</th><th>使用场景</th><th>示例</th></tr></thead><tbody><tr><td><code>greenlet.getcurrent()</code></td><td>获取当前正在执行的 greenlet 对象</td><td>在函数内获取当前协程</td><td><code>current = greenlet.getcurrent()</code></td></tr><tr><td><code>greenlet.switch(value=None)</code></td><td>将控制权切换到另一个 greenlet</td><td>协程间的主动切换</td><td><code>g.switch('传递参数')</code></td></tr><tr><td><code>greenlet.parent</code></td><td>获取当前 greenlet 的父 greenlet</td><td>协程层级管理</td><td><code>parent = g.parent</code></td></tr><tr><td><code>throw(type, value=None, tb=None)</code></td><td>向 greenlet 对象中抛出异常</td><td>协程异常处理</td><td><code>g.throw(ValueError, '错误信息')</code></td></tr><tr><td><code>dead</code></td><td>判断 greenlet 是否已经执行完毕</td><td>协程状态检查</td><td><code>if g.dead: print('已执行完毕')</code></td></tr><tr><td><code>gr_frame</code></td><td>获取 greenlet 当前的帧对象</td><td>调试和检查协程状态</td><td><code>frame = g.gr_frame</code></td></tr><tr><td><code>run</code></td><td>绑定到 greenlet 的可调用对象</td><td>查看协程的目标函数</td><td><code>func = g.run</code></td></tr></tbody></table><blockquote><p>💡 <strong>使用技巧</strong>：greenlet 适合实现简单的协程切换，但不支持自动在 IO 操作时切换，因此常与事件循环结合使用，如 gevent 库。greenlet 的优势在于它的轻量和灵活性，可以构建复杂的协程调度系统。</p></blockquote><h4 id="gevent-模块（了解）"><a href="#gevent-模块（了解）" class="headerlink" title="gevent 模块（了解）"></a>gevent 模块（了解）</h4><p>gevent 是基于 greenlet 的协程库，增加了事件循环和自动 IO 切换功能。它通过 “猴子补丁”（monkey patching）将标准库中的阻塞操作替换为非阻塞版本，使普通的同步代码能够以异步方式执行。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">gevent 是一个基于协程的 Python 网络库，它使用 greenlet 在 libev 或 libuv </span></span><br><span class="line"><span class="string">等事件循环之上提供高级同步 API。gevent 实现了python 标准库里面大部分的阻塞式系统调用，</span></span><br><span class="line"><span class="string">包括 socket、ssl、threading 和 select 等模块，</span></span><br><span class="line"><span class="string">可以使用 "猴子补丁" 将这些阻塞式调用变为协作式运行。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">猴子补丁的功能很强大，但是也带来了很多的风险，尤其是像 gevent 这种直接进行 API替换的补丁，</span></span><br><span class="line"><span class="string">整个 Python 进程所使用的模块都会被替换，可能自己的代码能 hold 住，</span></span><br><span class="line"><span class="string">但是其它第三方库，有时候问题并不好排查，即使排查出来也是很棘手，所以，</span></span><br><span class="line"><span class="string">就像松本建议的那样，如果要使用猴子补丁，那么只是做功能追加，</span></span><br><span class="line"><span class="string">尽量避免大规模的 API 覆盖。 虽然猴子补丁仍然是邪恶的(evil)，</span></span><br><span class="line"><span class="string">但在这种情况下它是 "有用的邪恶(useful evil)"。</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></tbody></table></figure><h5 id="gevent-基础操作"><a href="#gevent-基础操作" class="headerlink" title="gevent 基础操作"></a>gevent 基础操作</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line"></span><br><span class="line"><span class="comment">## 应用猴子补丁，将标准库的阻塞操作替换为非阻塞版本</span></span><br><span class="line"><span class="comment">## 必须在导入其他模块前调用，确保所有IO操作都被替换</span></span><br><span class="line">monkey.patch_all()  <span class="comment"># 替换所有可能的阻塞调用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    <span class="string">"""协程函数1"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'Running in foo'</span>)</span><br><span class="line">    gevent.sleep(<span class="number">0</span>)  <span class="comment"># 模拟IO操作，主动让出控制权</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'Explicit context switch to foo'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bar</span>():</span><br><span class="line">    <span class="string">"""协程函数2"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'Running in bar'</span>)</span><br><span class="line">    gevent.sleep(<span class="number">0</span>)  <span class="comment"># 模拟IO操作，主动让出控制权</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'Explicit context switch to bar'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">baz</span>():</span><br><span class="line">    <span class="string">"""协程函数3"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'Running in baz'</span>)</span><br><span class="line">    gevent.sleep(<span class="number">0</span>)  <span class="comment"># 模拟IO操作，主动让出控制权</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'Explicit context switch to baz'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建三个协程</span></span><br><span class="line">g1 = gevent.spawn(foo)  <span class="comment"># 创建协程但不立即执行</span></span><br><span class="line">g2 = gevent.spawn(bar)  <span class="comment"># 创建协程但不立即执行</span></span><br><span class="line">g3 = gevent.spawn(baz)  <span class="comment"># 创建协程但不立即执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 等待所有协程完成</span></span><br><span class="line">gevent.joinall([g1, g2, g3])  <span class="comment"># 类似于多线程中的join方法</span></span><br></pre></td></tr></tbody></table></figure><h5 id="gevent-常用-API-详解"><a href="#gevent-常用-API-详解" class="headerlink" title="gevent 常用 API 详解"></a>gevent 常用 API 详解</h5><table><thead><tr><th>方法/类名</th><th>描述</th><th>使用场景</th><th>实际应用示例</th></tr></thead><tbody><tr><td><code>gevent.spawn(function, *args, **kwargs)</code></td><td>创建并运行协程</td><td>启动异步任务</td><td>启动多个 HTTP 请求并行处理</td></tr><tr><td><code>gevent.joinall(greenlets, timeout=None, raise_error=False)</code></td><td>等待多个协程完成</td><td>同步点，等待所有任务完成</td><td>批量处理多个数据源</td></tr><tr><td><code>gevent.sleep(seconds=0)</code></td><td>协程休眠并让出控制权</td><td>模拟 IO 操作，主动让出控制权</td><td>测试协程调度，防止 CPU 密集任务阻塞</td></tr><tr><td><code>gevent.wait(objects=None, timeout=None, count=None)</code></td><td>等待对象(协程)完成</td><td>等待部分任务完成</td><td>等待最快完成的结果</td></tr><tr><td><code>gevent.kill(greenlet, exception=GreenletExit)</code></td><td>终止协程</td><td>取消不需要的任务</td><td>实现任务超时取消</td></tr><tr><td><code>gevent.monkey.patch_all(socket=True, dns=True, ...)</code></td><td>应用猴子补丁</td><td>将同步库变为异步兼容</td><td>使用前替换标准库函数</td></tr><tr><td><code>gevent.queue.Queue</code></td><td>协程安全的队列</td><td>协程间通信和数据传递</td><td>生产者-消费者模式实现</td></tr><tr><td><code>gevent.event.Event</code></td><td>事件通知机制</td><td>协程间同步和通知</td><td>完成信号传递</td></tr><tr><td><code>gevent.pool.Pool</code></td><td>协程池</td><td>限制并发数量</td><td>控制网络请求并发数</td></tr><tr><td><code>gevent.select.select()</code></td><td>IO 多路复用</td><td>监控多个文件描述符</td><td>自定义事件循环</td></tr></tbody></table><blockquote><p>⚠️ <strong>使用 gevent 注意事项</strong>：</p><ol><li>所有协程运行在同一线程中，不能跨线程同步数据</li><li>gevent.queue.Queue 是协程安全的，可以用于协程间通信</li><li>不能有长时间阻塞的 CPU 密集型操作，会阻塞整个事件循环</li><li>最好使用 gevent 自身的非阻塞库或已打补丁的标准库</li><li>猴子补丁会修改全局状态，可能影响第三方库的行为，应在所有导入前应用</li><li>调试协程比调试线程更困难，错误追踪可能会更复杂</li></ol></blockquote><h5 id="实际应用场景示例"><a href="#实际应用场景示例" class="headerlink" title="实际应用场景示例"></a>实际应用场景示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">## 替换标准库</span></span><br><span class="line">monkey.patch_all()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="string">"""获取URL内容的函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        url: 要获取的网址</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        tuple: (url, 响应状态码, 内容长度)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"开始请求: <span class="subst">{url}</span>"</span>)</span><br><span class="line">        start = time.time()</span><br><span class="line">        response = requests.get(url, timeout=<span class="number">5</span>)  <span class="comment"># 进行HTTP请求，IO操作会自动切换</span></span><br><span class="line">        elapsed = time.time() - start</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"完成请求: <span class="subst">{url}</span>, 耗时: <span class="subst">{elapsed:<span class="number">.2</span>f}</span>秒"</span>)</span><br><span class="line">        <span class="keyword">return</span> url, response.status_code, <span class="built_in">len</span>(response.content)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"请求 <span class="subst">{url}</span> 出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> url, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 要获取的URL列表</span></span><br><span class="line">urls = [</span><br><span class="line">    <span class="string">"https://www.python.org"</span>,</span><br><span class="line">    <span class="string">"https://www.github.com"</span>,</span><br><span class="line">    <span class="string">"https://www.stackoverflow.com"</span>,</span><br><span class="line">    <span class="string">"https://www.wikipedia.org"</span>,</span><br><span class="line">    <span class="string">"https://www.reddit.com"</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">start_time = time.time()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建协程任务</span></span><br><span class="line">tasks = [gevent.spawn(fetch_url, url) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 等待所有任务完成</span></span><br><span class="line">gevent.joinall(tasks)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 获取结果</span></span><br><span class="line">results = [task.value <span class="keyword">for</span> task <span class="keyword">in</span> tasks]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 打印结果</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n结果汇总:"</span>)</span><br><span class="line"><span class="keyword">for</span> url, status, length <span class="keyword">in</span> results:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"URL: <span class="subst">{url}</span>, 状态码: <span class="subst">{status}</span>, 内容长度: <span class="subst">{length}</span> 字节"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"\n总耗时: <span class="subst">{time.time() - start_time:<span class="number">.2</span>f}</span>秒"</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="greenlet-与-gevent-的区别与选择"><a href="#greenlet-与-gevent-的区别与选择" class="headerlink" title="greenlet 与 gevent 的区别与选择"></a>greenlet 与 gevent 的区别与选择</h4><table><thead><tr><th>特性</th><th>greenlet</th><th>gevent</th><th>实际应用建议</th></tr></thead><tbody><tr><td>基本原理</td><td>轻量级上下文切换</td><td>基于 greenlet，增加事件循环</td><td>简单任务用 greenlet，复杂系统用 gevent</td></tr><tr><td>IO 处理</td><td>不提供 IO 操作支持</td><td>提供自动 IO 切换机制</td><td>网络应用选择 gevent，自定义调度选择 greenlet</td></tr><tr><td>切换方式</td><td>需要显式调用 switch()</td><td>在 IO 操作时自动切换</td><td>手动控制流程用 greenlet，自动化处理用 gevent</td></tr><tr><td>复杂度</td><td>简单，仅提供基本切换</td><td>复杂，提供完整生态系统</td><td>小型项目用 greenlet，大型项目用 gevent</td></tr><tr><td>适用场景</td><td>简单协程调度</td><td>高并发网络应用</td><td>Web 爬虫、API 服务、代理服务器首选 gevent</td></tr><tr><td>性能</td><td>轻量，开销小</td><td>比 greenlet 略重，但实用性强</td><td>极致性能用 greenlet，平衡性能和开发效率用 gevent</td></tr><tr><td>学习曲线</td><td>简单，容易理解</td><td>较复杂，概念较多</td><td>入门协程从 greenlet 开始，再过渡到 gevent</td></tr><tr><td>社区支持</td><td>基础库，更新较少</td><td>活跃，有完整生态</td><td>长期项目建议使用 gevent</td></tr></tbody></table><blockquote><p>🌟 <strong>选择建议</strong>：如果只需要轻量级的上下文切换，可以使用 greenlet；如果需要处理 IO 密集型应用，特别是网络编程，建议使用 gevent。大多数实际项目中，gevent 是更好的选择，因为它提供了更完整的功能和自动化的 IO 处理。</p></blockquote><h4 id="asyncio-协程技术"><a href="#asyncio-协程技术" class="headerlink" title="asyncio 协程技术"></a>asyncio 协程技术</h4><p>随着 Python 的发展，协程技术已经有了显著进步。从 Python 3.4 引入的 <code>asyncio</code> 库开始，Python 对协程的原生支持不断增强。到 2025 年，Python 已经拥有更成熟、更高效的协程生态系统。</p><h5 id="asyncio-与原生协程"><a href="#asyncio-与原生协程" class="headerlink" title="asyncio 与原生协程"></a>asyncio 与原生协程</h5><p>Python 3.5 引入的 <code>async/await</code> 语法使得协程编程变得更加直观和强大，这是目前最推荐的协程实现方式：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_data</span>(<span class="params">url,delay</span>):</span><br><span class="line">    <span class="string">"""模拟从网络获取数据的异步函数"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"开始获取数据：<span class="subst">{url}</span>，延迟<span class="subst">{delay}</span>秒"</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(delay)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"成功获取数据长度：<span class="subst">{<span class="built_in">len</span>(url)}</span>"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f"数据<span class="subst">{url}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">"""异步操作的主函数"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"程序开始时间:<span class="subst">{time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>, time.localtime())}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n===== 串行执行示例 ====="</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="comment"># 串行执行 - 请求两个API数据</span></span><br><span class="line">    result1 = <span class="keyword">await</span> fetch_data(<span class="string">"https://www.baidu.com"</span>, <span class="number">2</span>)</span><br><span class="line">    result2 = <span class="keyword">await</span> fetch_data(<span class="string">"https://www.sina.com.cn"</span>,<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"串行执行结果：<span class="subst">{result1}</span>, <span class="subst">{result2}</span>"</span>)</span><br><span class="line">    end_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"程序结束时间:<span class="subst">{time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>, time.localtime())}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"程序耗时:<span class="subst">{end_time-start_time}</span>秒"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 并行执行 - 请求两个API数据</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n===== 并行执行示例 ====="</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    tasks = [</span><br><span class="line">        asyncio.create_task(fetch_data(<span class="string">"https://www.baidu.com"</span>, <span class="number">2</span>)),</span><br><span class="line">        asyncio.create_task(fetch_data(<span class="string">"https://www.sina.com.cn"</span>,<span class="number">3</span>)),</span><br><span class="line">    ]</span><br><span class="line">    results = <span class="keyword">await</span> asyncio.gather(*tasks) <span class="comment"># 批量等待所有任务完成</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"并行执行结果：<span class="subst">{results}</span>"</span>)</span><br><span class="line">    end_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"程序结束时间:<span class="subst">{time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>, time.localtime())}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"程序耗时:<span class="subst">{end_time-start_time}</span>秒"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 在Python 3.7+中，可以直接使用asyncio.run()运行主协程</span></span><br><span class="line">    asyncio.run(main())</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="asyncio-常用-API"><a href="#asyncio-常用-API" class="headerlink" title="asyncio 常用 API"></a>asyncio 常用 API</h5><table><thead><tr><th>方法/函数</th><th>描述</th><th>使用场景</th><th>示例</th></tr></thead><tbody><tr><td><code>asyncio.run()</code></td><td>运行协程</td><td>程序入口点</td><td><code>asyncio.run(main())</code></td></tr><tr><td><code>asyncio.create_task()</code></td><td>创建任务</td><td>并行执行协程</td><td><code>task = asyncio.create_task(coro())</code></td></tr><tr><td><code>asyncio.gather()</code></td><td>并行运行多个协程</td><td>批量并发任务</td><td><code>results = await asyncio.gather(coro1(), coro2())</code></td></tr><tr><td><code>asyncio.wait_for()</code></td><td>带超时的等待</td><td>实现超时控制</td><td><code>await asyncio.wait_for(coro(), timeout=1.0)</code></td></tr><tr><td><code>asyncio.sleep()</code></td><td>非阻塞睡眠</td><td>模拟 IO 延迟</td><td><code>await asyncio.sleep(1.0)</code></td></tr><tr><td><code>asyncio.Queue</code></td><td>协程安全的队列</td><td>协程间数据传递</td><td><code>queue = asyncio.Queue(); await queue.put(item)</code></td></tr><tr><td><code>asyncio.Future</code></td><td>低级异步原语</td><td>自定义异步操作</td><td><code>future = asyncio.Future(); future.set_result(value)</code></td></tr><tr><td><code>asyncio.shield()</code></td><td>防止取消传播</td><td>保护关键协程</td><td><code>await asyncio.shield(critical_coro())</code></td></tr><tr><td><code>asyncio.as_completed()</code></td><td>按完成顺序返回结果</td><td>处理最先完成的任务</td><td><code>for task in asyncio.as_completed([coro1(), coro2()]): result = await task</code></td></tr></tbody></table><h4 id="Task-对象"><a href="#Task-对象" class="headerlink" title="Task 对象"></a>Task 对象</h4><p><code>Task</code> 是 <code>asyncio</code> 中用于封装协程的对象，可以用于并发执行多个任务。可以通过 <code>Task</code> 对象等待协程完成。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">nested</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'进入 nested()'</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)  <span class="comment"># 模拟IO操作</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'离开 nested()'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'42'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    task = asyncio.create_task(nested())  <span class="comment"># 创建任务</span></span><br><span class="line">    result = <span class="keyword">await</span> task  <span class="comment"># 等待任务完成</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f'返回值：<span class="subst">{result}</span>'</span>)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></tbody></table></figure><h4 id="Future-对象"><a href="#Future-对象" class="headerlink" title="Future 对象"></a>Future 对象</h4><p><code>Future</code> 是 <code>Task</code> 的基类，表示一个未完成的结果。在底层异步操作中，<code>Future</code> 常常用来表示某些未决的操作结果。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个异步函数，用于设置future的结果</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">set_future_result</span>(<span class="params">future</span>):</span><br><span class="line">    <span class="comment"># 异步等待2秒，模拟耗时操作</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="comment"># 设置future的结果为"Hello, world!"</span></span><br><span class="line">    future.set_result(<span class="string">"Hello, world!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义主异步函数</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 获取当前正在运行的事件循环</span></span><br><span class="line">    loop = asyncio.get_running_loop()</span><br><span class="line">    <span class="comment"># 创建Future对象，它代表一个尚未完成的异步操作</span></span><br><span class="line">    future = loop.create_future()  <span class="comment"># 创建Future对象</span></span><br><span class="line">    <span class="comment"># 创建一个任务来执行set_future_result函数，不等待其完成立即返回</span></span><br><span class="line">    asyncio.create_task(set_future_result(future))</span><br><span class="line">    <span class="comment"># 等待future完成并获取其结果</span></span><br><span class="line">    result = <span class="keyword">await</span> future  <span class="comment"># 等待Future完成</span></span><br><span class="line">    <span class="comment"># 打印future的结果</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Future的结果: <span class="subst">{result}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行主异步函数</span></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></tbody></table></figure><h4 id="异步上下文管理器"><a href="#异步上下文管理器" class="headerlink" title="异步上下文管理器"></a>异步上下文管理器</h4><p>异步上下文管理器允许在进入和退出时执行异步操作，常用于异步资源管理。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncResource</span>:</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">__aenter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"资源获取"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">__aexit__</span>(<span class="params">self, exc_type, exc_value, traceback</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"资源释放"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> AsyncResource():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"执行任务中"</span>)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></tbody></table></figure><h3 id="14-6-GIL-锁与-Python-并发性能"><a href="#14-6-GIL-锁与-Python-并发性能" class="headerlink" title="14.6 GIL 锁与 Python 并发性能"></a>14.6 GIL 锁与 Python 并发性能</h3><p>GIL(Global Interpreter Lock，全局解释器锁)是 CPython 解释器的一个特性，它确保同一时刻只有一个线程可以执行 Python 字节码。这个特性对 Python 多线程编程有着深远影响，也是导致 Python 速度慢的两大原因之一，其另外一个原因是因为 Python 是 <code>解释形</code> 语言，但后续可通过 <code>pypy</code> 技术实现 Python 的预编译，但唯独这个原因 Python 没有解决，Python 在早期开发时为解决垃圾回收机制内部问题采用了 GIL 锁，所以 Python 程序无法直接利用多核 CPU 的优势</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">GIL全局解释器锁(Global Interpreter Lock)，是CPython特有的一个物件，</span></span><br><span class="line"><span class="string">作用是让一个进程中同一时刻只能有一个线程可以被CPU调用</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">如果程序想利用计算机的多核优势，让CPU同时处理一些任务，适合用多进程开发（即使资源开销大）</span></span><br><span class="line"><span class="string">如果程序不想利用计算机的多核优势，适合用多线程开发</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></tbody></table></figure><h4 id="GIL-的本质与工作原理"><a href="#GIL-的本质与工作原理" class="headerlink" title="GIL 的本质与工作原理"></a>GIL 的本质与工作原理</h4><p>GIL 本质上是一把互斥锁，用于保护 Python 解释器的内部状态，主要解决了 Python 对象的内存管理问题。</p><table><thead><tr><th>GIL 特性</th><th>描述</th></tr></thead><tbody><tr><td>实现方式</td><td>互斥锁(mutex)</td></tr><tr><td>作用对象</td><td>Python 解释器进程</td></tr><tr><td>控制范围</td><td>Python 字节码执行</td></tr><tr><td>释放时机</td><td>I/O 操作、执行固定字节码数量后</td></tr><tr><td>影响范围</td><td>仅影响 CPython，PyPy、Jython、IronPython 不受影响</td></tr></tbody></table><blockquote><p>🔍 <strong>深入理解</strong>：GIL 并非 Python 语言本身的特性，而是 CPython 实现的产物。它解决了 CPython 简单引用计数式内存管理的线程安全问题，但也限制了多线程程序利用多核性能的能力。</p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## GIL工作示意伪代码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">thread_execution</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        acquire_GIL()       <span class="comment"># 获取GIL锁</span></span><br><span class="line">        execute_bytecodes() <span class="comment"># 执行一定数量的字节码</span></span><br><span class="line">        release_GIL()       <span class="comment"># 释放GIL锁以允许其他线程运行</span></span><br><span class="line">        wait_for_GIL()      <span class="comment"># 等待再次获取GIL</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 这也就导致了每一个线程都需要在执行获取字节码时都要经历拿锁-&gt;解锁的过程</span></span><br></pre></td></tr></tbody></table></figure><h4 id="并发与并行的区别"><a href="#并发与并行的区别" class="headerlink" title="并发与并行的区别"></a>并发与并行的区别</h4><p>并发(Concurrency)和并行(Parallelism)是两个在计算机科学中经常出现的概念，虽然常被混用，但有着本质区别：</p><table><thead><tr><th>特性</th><th>并发(Concurrency)</th><th>并行(Parallelism)</th></tr></thead><tbody><tr><td>定义</td><td>多个任务在同一时间间隔内发生</td><td>多个任务在同一时刻发生</td></tr><tr><td>重点</td><td>任务切换与调度</td><td>任务的同时执行</td></tr><tr><td>资源需求</td><td>可以在单处理器上通过时间片轮转实现</td><td>需要多个处理器或核心</td></tr><tr><td>执行方式</td><td>任务交替执行，共享处理器时间</td><td>每个任务有独立的处理器同时执行</td></tr><tr><td>适用场景</td><td>I/O 密集型任务，如网络请求、文件读写</td><td>计算密集型任务，如图像处理、科学计算</td></tr><tr><td>实现难度</td><td>相对简单，关注任务调度</td><td>相对复杂，需考虑数据分割、同步和合并</td></tr><tr><td>Python 实现</td><td>多线程、协程</td><td>多进程</td></tr></tbody></table><blockquote><p>🌟 <strong>关键理解</strong>：由于 GIL 的存在，Python 的多线程实际上只能实现并发，而不能实现真正的并行。要实现并行，需要使用多进程或依赖不受 GIL 限制的扩展库（如使用 C 扩展的 NumPy）。</p></blockquote><h4 id="线程安全与并发控制"><a href="#线程安全与并发控制" class="headerlink" title="线程安全与并发控制"></a>线程安全与并发控制</h4><p>线程安全指在多线程环境下，程序能够正确地处理共享资源，不会因为多线程同时访问而导致数据不一致。尽管 Python 的 GIL 能减轻一些并发问题，但并不能完全保证线程安全。</p><h5 id="线程安全问题示例"><a href="#线程安全问题示例" class="headerlink" title="线程安全问题示例"></a>线程安全问题示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment">### 共享的全局变量</span></span><br><span class="line">counter = <span class="number">0</span></span><br><span class="line">start_time = time.time()</span><br><span class="line">iterations_completed = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">increment_counter</span>():</span><br><span class="line">    <span class="string">"""增加计数器，但使用了非原子操作的方式"""</span></span><br><span class="line">    <span class="keyword">global</span> counter, iterations_completed</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">        <span class="comment"># 模拟线程安全问题：读取-修改-写入过程中可能被中断</span></span><br><span class="line">        local_counter = counter  <span class="comment"># 读取当前值</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 模拟线程在读取后被切换的情况</span></span><br><span class="line">        <span class="comment"># 随机休眠一个很小的时间，增加线程切换的可能性</span></span><br><span class="line">        <span class="keyword">if</span> random.random() &lt; <span class="number">0.00001</span>:</span><br><span class="line">            time.sleep(<span class="number">0.00001</span>)</span><br><span class="line">            </span><br><span class="line">        local_counter += <span class="number">1</span>  <span class="comment"># 在本地修改</span></span><br><span class="line">        counter = local_counter  <span class="comment"># 写回全局变量</span></span><br><span class="line">        iterations_completed += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_concurrent_threads</span>(<span class="params">num_threads</span>):</span><br><span class="line">    <span class="string">"""运行多个线程同时增加计数器"""</span></span><br><span class="line">    <span class="keyword">global</span> counter, iterations_completed</span><br><span class="line">    counter = <span class="number">0</span></span><br><span class="line">    iterations_completed = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_threads):</span><br><span class="line">        t = Thread(target=increment_counter)</span><br><span class="line">        threads.append(t)</span><br><span class="line">        t.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 理论上应该等于 num_threads * 1000000</span></span><br><span class="line">    expected = num_threads * <span class="number">1000000</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"预期结果: <span class="subst">{expected}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"实际结果: <span class="subst">{counter}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"丢失的增量: <span class="subst">{expected - counter}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"完成的迭代次数: <span class="subst">{iterations_completed}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f'开始时间为: <span class="subst">{time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime())}</span>'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行4个线程，每个线程增加计数器1000000次</span></span><br><span class="line">    <span class="comment"># 理论上最终结果应该是4000000，但由于线程安全问题，实际结果会小于这个值</span></span><br><span class="line">    run_concurrent_threads(<span class="number">4</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"累计用时: <span class="subst">{<span class="built_in">round</span>(time.time() - start_time, <span class="number">1</span>)}</span>秒"</span>)</span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="使用线程锁解决安全问题"><a href="#使用线程锁解决安全问题" class="headerlink" title="使用线程锁解决安全问题"></a>使用线程锁解决安全问题</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread, Lock</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment">### 共享的全局变量</span></span><br><span class="line">counter = <span class="number">0</span></span><br><span class="line">start_time = time.time()</span><br><span class="line">iterations_completed = <span class="number">0</span></span><br><span class="line"><span class="comment"># 创建一个线程锁</span></span><br><span class="line">counter_lock = Lock()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">increment_counter</span>():</span><br><span class="line">    <span class="string">"""增加计数器，使用线程锁确保线程安全"""</span></span><br><span class="line">    <span class="keyword">global</span> counter, iterations_completed</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">        <span class="comment"># 使用线程锁保护临界区</span></span><br><span class="line">        <span class="keyword">with</span> counter_lock:</span><br><span class="line">            counter += <span class="number">1</span>  <span class="comment"># 在锁的保护下直接修改全局变量</span></span><br><span class="line">            iterations_completed += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_concurrent_threads</span>(<span class="params">num_threads</span>):</span><br><span class="line">    <span class="string">"""运行多个线程同时增加计数器"""</span></span><br><span class="line">    <span class="keyword">global</span> counter, iterations_completed</span><br><span class="line">    counter = <span class="number">0</span></span><br><span class="line">    iterations_completed = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_threads):</span><br><span class="line">        t = Thread(target=increment_counter)</span><br><span class="line">        threads.append(t)</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 理论上应该等于 num_threads * 1000000</span></span><br><span class="line">    expected = num_threads * <span class="number">1000000</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"预期结果: <span class="subst">{expected}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"实际结果: <span class="subst">{counter}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"丢失的增量: <span class="subst">{expected - counter}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"完成的迭代次数: <span class="subst">{iterations_completed}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f'开始时间为: <span class="subst">{time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime())}</span>'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 运行4个线程，每个线程增加计数器1000000次</span></span><br><span class="line">    <span class="comment"># 使用线程锁后，最终结果应该正确等于4000000</span></span><br><span class="line">    run_concurrent_threads(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"累计用时: <span class="subst">{<span class="built_in">round</span>(time.time() - start_time, <span class="number">1</span>)}</span>秒"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><blockquote><p>🔒 <strong>线程锁作用与注意事项</strong>：</p><ul><li>锁确保同一时刻只有一个线程能访问共享资源</li><li>锁会影响性能，特别是在竞争激烈的情况下</li><li>锁的粒度需要权衡：粒度太细会增加锁操作开销，太粗会降低并发度</li><li>锁可能引发死锁问题，需谨慎设计锁的获取顺序</li></ul></blockquote><h4 id="Python-中的锁机制全面解析"><a href="#Python-中的锁机制全面解析" class="headerlink" title="Python 中的锁机制全面解析"></a>Python 中的锁机制全面解析</h4><p>Python 的 <code>threading</code> 模块提供了多种锁和同步原语，用于不同并发控制场景。深入理解这些锁的特性和适用场景，对于开发可靠的并发程序至关重要。</p><h5 id="Python-锁类型及其特性"><a href="#Python-锁类型及其特性" class="headerlink" title="Python 锁类型及其特性"></a>Python 锁类型及其特性</h5><table><thead><tr><th>锁类型</th><th>描述</th><th>独占性</th><th>可重入性</th><th>公平性</th><th>注意事项</th></tr></thead><tbody><tr><td><code>threading.Lock</code></td><td>基本互斥锁</td><td>是</td><td>否</td><td>非公平</td><td>最简单的锁，同一线程不能重复获取</td></tr><tr><td><code>threading.RLock</code></td><td>可重入锁</td><td>是</td><td>是</td><td>非公平</td><td>同一线程可多次获取，必须对应释放相同次数</td></tr><tr><td><code>threading.Condition</code></td><td>条件变量</td><td>-</td><td>-</td><td>非公平</td><td>基于锁实现，提供 wait/notify 机制</td></tr><tr><td><code>threading.Semaphore</code></td><td>信号量</td><td>否</td><td>-</td><td>非公平</td><td>限制资源访问线程数量</td></tr><tr><td><code>threading.BoundedSemaphore</code></td><td>有界信号量</td><td>否</td><td>-</td><td>非公平</td><td>限制资源数量，防止过度释放</td></tr><tr><td><code>threading.Event</code></td><td>事件对象</td><td>-</td><td>-</td><td>-</td><td>用于线程间通知而非资源控制</td></tr><tr><td><code>threading.Barrier</code></td><td>栅栏对象</td><td>-</td><td>-</td><td>-</td><td>使多个线程同步到达某点再继续</td></tr><tr><td><code>queue.Queue</code></td><td>线程安全队列</td><td>-</td><td>-</td><td>先进先出</td><td>内部带锁，用于线程间数据传递</td></tr><tr><td><code>multiprocessing.Lock</code></td><td>进程锁</td><td>是</td><td>否</td><td>非公平</td><td>用于进程间同步的锁</td></tr><tr><td><code>asyncio.Lock</code></td><td>异步锁</td><td>是</td><td>否</td><td>-</td><td>用于协程间的同步</td></tr></tbody></table><h5 id="互斥锁-Lock"><a href="#互斥锁-Lock" class="headerlink" title="互斥锁(Lock)"></a>互斥锁(Lock)</h5><p>互斥锁是最基本的锁类型，它确保同一时刻只有一个线程可以访问受保护的资源。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> concurrent</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line">lock = threading.Lock()</span><br><span class="line">shared_data = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shared_resource</span>(<span class="params">thread_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">"""访问共享资源的函数</span></span><br><span class="line"><span class="string">    Args:thread_id: 线程ID，用于标识不同线程</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 尝试获取锁</span></span><br><span class="line">    <span class="keyword">if</span> lock.acquire(timeout=<span class="number">1</span>):  <span class="comment"># 添加超时参数，防止无限等待</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{thread_id}</span>获取锁"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">global</span> shared_data</span><br><span class="line">            <span class="comment"># 读取-修改-写入操作需要原子性保护</span></span><br><span class="line">            current = shared_data</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)  <span class="comment"># 模拟处理延时，增加竞争概率</span></span><br><span class="line">            shared_data = current + <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{thread_id}</span>修改共享数据，当前值为<span class="subst">{shared_data}</span>"</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># 释放锁</span></span><br><span class="line">            lock.release()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{thread_id}</span>释放锁"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{thread_id}</span>获取锁失败"</span>)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shared_resource2</span>(<span class="params">thread_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">"""访问共享资源的函数</span></span><br><span class="line"><span class="string">    使用with语句，自动释放锁简化代码</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">with</span> lock:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{thread_id}</span>获取锁"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">global</span> shared_data</span><br><span class="line">            <span class="comment"># 读取-修改-写入操作需要原子性保护</span></span><br><span class="line">            current = shared_data</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)  <span class="comment"># 模拟处理延时，增加竞争概率</span></span><br><span class="line">            shared_data = current + <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{thread_id}</span>修改共享数据，当前值为<span class="subst">{shared_data}</span>"</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"线程<span class="subst">{thread_id}</span>释放锁"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 使用线程池创建多个线程</span></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">10</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = [executor.submit(shared_resource, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>)]</span><br><span class="line">        <span class="comment"># 等待所有线程完成</span></span><br><span class="line">        concurrent.futures.wait(futures)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"最终共享数据值为<span class="subst">{shared_data}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>Lock 方法</th><th>描述</th><th>参数</th><th>返回值</th></tr></thead><tbody><tr><td><code>acquire(blocking=True, timeout=-1)</code></td><td>获取锁</td><td>blocking: 是否阻塞, timeout: 超时时间(秒)</td><td>布尔值，表示是否获取成功</td></tr><tr><td><code>release()</code></td><td>释放锁</td><td>无</td><td>无，如果当前线程未持有锁则抛出 RuntimeError</td></tr><tr><td><code>locked()</code></td><td>检查锁状态</td><td>无</td><td>布尔值，表示锁是否被某个线程持有</td></tr><tr><td><code>__enter__()</code></td><td>支持 with 语句</td><td>无</td><td>锁对象自身</td></tr><tr><td><code>__exit__()</code></td><td>with 语句退出时调用</td><td>异常信息</td><td>无，自动释放锁</td></tr></tbody></table><h5 id="可重入锁-RLock"><a href="#可重入锁-RLock" class="headerlink" title="可重入锁(RLock)"></a>可重入锁(RLock)</h5><p>可重入锁允许同一个线程多次获取该锁，而不会导致自我死锁。这在递归调用或者嵌套加锁场景中特别有用。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建可重入锁</span></span><br><span class="line">rlock = threading.RLock()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 嵌套列表数据结构</span></span><br><span class="line">data = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_data</span>(<span class="params">item, depth: <span class="built_in">int</span> = <span class="number">0</span></span>):</span><br><span class="line">    <span class="string">"""递归处理数据</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        item: 要处理的数据项，可以是列表或单个元素</span></span><br><span class="line"><span class="string">        depth: 当前递归深度，用于缩进显示</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 获取锁</span></span><br><span class="line">    rlock.acquire()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 创建缩进效果，增强可读性</span></span><br><span class="line">        indent = <span class="string">" "</span> * depth * <span class="number">2</span>  <span class="comment"># 增加缩进量使层次更明显</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 打印当前处理的数据项和深度</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f'<span class="subst">{indent}</span>线程 <span class="subst">{threading.current_thread().name}</span> 处理: <span class="subst">{item}</span> (深度: <span class="subst">{depth}</span>)'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 递归处理逻辑</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">list</span>):</span><br><span class="line">            <span class="comment"># 列表节点处理 - 继续向下递归</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f'<span class="subst">{indent}</span>├── 发现列表，开始遍历子元素...'</span>)</span><br><span class="line">            <span class="keyword">for</span> i, sub_item <span class="keyword">in</span> <span class="built_in">enumerate</span>(item):</span><br><span class="line">                <span class="comment"># 显示子项的索引，增强结构可视化</span></span><br><span class="line">                prefix = <span class="string">"└── "</span> <span class="keyword">if</span> i == <span class="built_in">len</span>(item) - <span class="number">1</span> <span class="keyword">else</span> <span class="string">"├── "</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f'<span class="subst">{indent}</span><span class="subst">{prefix}</span>处理子项 <span class="subst">{i+<span class="number">1</span>}</span>/<span class="subst">{<span class="built_in">len</span>(item)}</span>: <span class="subst">{sub_item}</span>'</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 递归调用，这里会再次获取同一个锁</span></span><br><span class="line">                process_data(sub_item, depth + <span class="number">1</span>)</span><br><span class="line">                time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 叶子节点处理 - 递归终止条件</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f'<span class="subst">{indent}</span>└── 发现元素，进行处理...'</span>)</span><br><span class="line">            time.sleep(<span class="number">0.5</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f'<span class="subst">{indent}</span>    处理结果: <span class="subst">{item * <span class="number">2</span>}</span>'</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 释放锁</span></span><br><span class="line">        rlock.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment">## 创建多个线程访问嵌套数据</span></span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        <span class="comment"># 每个线程处理完整的数据结构</span></span><br><span class="line">        t = threading.Thread(name=<span class="string">f"Thread-<span class="subst">{i}</span>"</span>, target=process_data, args=(data,))</span><br><span class="line">        threads.append(t)</span><br><span class="line">        t.start()</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)  <span class="comment"># 错开线程启动时间</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">## 等待所有线程结束</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"所有线程都结束了"</span>)</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>RLock 方法</th><th>描述</th><th>与 Lock 的区别</th></tr></thead><tbody><tr><td><code>acquire(blocking=True, timeout=-1)</code></td><td>获取锁</td><td>记录获取线程 ID 和次数</td></tr><tr><td><code>release()</code></td><td>释放锁</td><td>计数器减 1，只有为 0 时才真正释放</td></tr><tr><td><code>_is_owned()</code></td><td>检查当前线程是否持有锁</td><td>Lock 没有此方法</td></tr></tbody></table><blockquote><p>💡 <strong>使用建议</strong>：一般推荐使用 RLock 而非 Lock，因为它更安全、更灵活，即使在不需要重入功能的场景下也不会有明显性能损失。</p></blockquote><h5 id="条件变量-Condition-根据条件控制锁"><a href="#条件变量-Condition-根据条件控制锁" class="headerlink" title="条件变量(Condition) - 根据条件控制锁"></a>条件变量(Condition) - 根据条件控制锁</h5><p>条件变量是一种高级的 <code>同步原语(同步原语就是让多个线程能够"和谐相处"的机制)</code>，它允许线程等待特定条件满足后再继续执行。条件变量内部包含一个锁，用于控制对共享状态的访问。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Buffer</span>:</span><br><span class="line">    <span class="string">"""线程安全的缓冲区，使用条件变量控制生产者消费者模型"""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_size: <span class="built_in">int</span> = <span class="number">5</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""初始化缓冲区"""</span></span><br><span class="line">        <span class="variable language_">self</span>.buffer: <span class="type">List</span>[<span class="type">Any</span>] = []  <span class="comment"># 共享数据缓冲区</span></span><br><span class="line">        <span class="variable language_">self</span>.max_size: <span class="built_in">int</span> = max_size  <span class="comment"># 最大容量</span></span><br><span class="line">        <span class="comment"># 创建条件变量，基于RLock</span></span><br><span class="line">        <span class="variable language_">self</span>.condition: threading.Condition = threading.Condition()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">produce</span>(<span class="params">self, item: <span class="type">Any</span>, producer_id: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""生产者方法，向缓冲区添加数据"""</span></span><br><span class="line">        <span class="comment"># 使用条件变量的with语句自动获取和释放锁</span></span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.condition:</span><br><span class="line">            <span class="comment"># 当缓冲区已满时，等待消费者处理</span></span><br><span class="line">            <span class="keyword">while</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.buffer) &gt;= <span class="variable language_">self</span>.max_size:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"生产者 <span class="subst">{producer_id}</span>: 缓冲区已满，等待消费者..."</span>)</span><br><span class="line">                <span class="comment"># 等待唤醒通知，自动释放锁，让其他线程能访问缓冲区</span></span><br><span class="line">                <span class="variable language_">self</span>.condition.wait()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 添加数据到缓冲区</span></span><br><span class="line">            <span class="variable language_">self</span>.buffer.append(item)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"生产者 <span class="subst">{producer_id}</span>: 添加 <span class="subst">{item}</span> 到缓冲区，当前大小: <span class="subst">{<span class="built_in">len</span>(self.buffer)}</span>"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 通知所有等待的消费者有新数据可用</span></span><br><span class="line">            <span class="variable language_">self</span>.condition.notify_all()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">consume</span>(<span class="params">self, consumer_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">"""消费者方法，从缓冲区获取数据"""</span></span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.condition:</span><br><span class="line">            <span class="comment"># 当缓冲区为空时，等待生产者添加数据</span></span><br><span class="line">            <span class="keyword">while</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.buffer) == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"消费者 <span class="subst">{consumer_id}</span>: 缓冲区为空，等待生产者..."</span>)</span><br><span class="line">                <span class="variable language_">self</span>.condition.wait()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 从缓冲区取出数据</span></span><br><span class="line">            item = <span class="variable language_">self</span>.buffer.pop(<span class="number">0</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"消费者 <span class="subst">{consumer_id}</span>: 从缓冲区取出 <span class="subst">{item}</span>，当前大小: <span class="subst">{<span class="built_in">len</span>(self.buffer)}</span>"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 通知所有等待的生产者缓冲区有空间</span></span><br><span class="line">            <span class="variable language_">self</span>.condition.notify_all()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">producer_task</span>(<span class="params">buffer: Buffer, producer_id: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""生产者任务"""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):  <span class="comment"># 生产10个产品</span></span><br><span class="line">        item = <span class="string">f"产品-<span class="subst">{producer_id}</span>-<span class="subst">{i}</span>"</span></span><br><span class="line">        <span class="comment"># 模拟生产时间</span></span><br><span class="line">        time.sleep(random.uniform(<span class="number">0.1</span>, <span class="number">0.5</span>))  </span><br><span class="line">        buffer.produce(item, producer_id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consumer_task</span>(<span class="params">buffer: Buffer, consumer_id: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""消费者任务"""</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):  <span class="comment"># 每个消费者消费7个产品</span></span><br><span class="line">        <span class="comment"># 模拟消费时间</span></span><br><span class="line">        time.sleep(random.uniform(<span class="number">0.2</span>, <span class="number">0.7</span>))  </span><br><span class="line">        item = buffer.consume(consumer_id)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"消费者 <span class="subst">{consumer_id}</span> 处理 <span class="subst">{item}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""主函数，创建并启动生产者和消费者线程"""</span></span><br><span class="line">    <span class="comment"># 创建共享缓冲区</span></span><br><span class="line">    shared_buffer = Buffer(max_size=<span class="number">3</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建生产者和消费者线程</span></span><br><span class="line">    producer_threads = [</span><br><span class="line">        threading.Thread(target=producer_task, args=(shared_buffer, i), name=<span class="string">f"Producer-<span class="subst">{i}</span>"</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)  <span class="comment"># 3个生产者</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    consumer_threads = [</span><br><span class="line">        threading.Thread(target=consumer_task, args=(shared_buffer, i), name=<span class="string">f"Consumer-<span class="subst">{i}</span>"</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)  <span class="comment"># 3个消费者</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动所有线程</span></span><br><span class="line">    all_threads = producer_threads + consumer_threads</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> all_threads:</span><br><span class="line">        thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待所有线程完成</span></span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> all_threads:</span><br><span class="line">        thread.join()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"所有生产和消费任务已完成"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>Condition 方法</th><th>描述</th><th>参数</th><th>注意事项</th></tr></thead><tbody><tr><td><code>__init__(lock=None)</code></td><td>初始化条件变量</td><td>lock: 可选的 Lock 或 RLock</td><td>不指定则创建 RLock</td></tr><tr><td><code>acquire(*args)</code></td><td>获取底层锁</td><td>同底层锁的 acquire 方法</td><td>一般通过 with 语句使用</td></tr><tr><td><code>release()</code></td><td>释放底层锁</td><td>无</td><td>一般通过 with 语句自动释放</td></tr><tr><td><code>wait(timeout=None)</code></td><td>等待条件</td><td>timeout: 超时时间(秒)</td><td>调用前必须已获得锁</td></tr><tr><td><code>wait_for(predicate, timeout=None)</code></td><td>等待直到条件为真</td><td>predicate: 条件函数, timeout: 超时时间</td><td>简化循环等待模式</td></tr><tr><td><code>notify(n=1)</code></td><td>唤醒 n 个等待的线程</td><td>n: 要唤醒的线程数</td><td>不会立即释放锁</td></tr><tr><td><code>notify_all()</code></td><td>唤醒所有等待的线程</td><td>无</td><td>适用于广播通知</td></tr></tbody></table><blockquote><p>⚠️ <strong>使用注意</strong>：</p><ol><li>调用 <code>wait()</code> 会释放锁，允许其他线程修改条件状态</li><li>使用 <code>wait_for()</code> 可以避免虚假唤醒问题</li><li>调用 <code>notify()</code> 后锁不会立即释放，需要当前线程退出 with 块</li><li>使用 <code>notify_all()</code> 而非 <code>notify()</code> 可以避免信号丢失问题</li></ol></blockquote><h5 id="信号量-Semaphore-控制并发数量"><a href="#信号量-Semaphore-控制并发数量" class="headerlink" title="信号量(Semaphore) - 控制并发数量"></a>信号量(Semaphore) - 控制并发数量</h5><p>信号量是一种计数器，用于控制同时访问特定资源的线程数量，常用于限制并发访问数。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建信号量，限制最多三个线程同时访问资源</span></span><br><span class="line">pool_semaphore = threading.Semaphore(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 模拟优先的资源池</span></span><br><span class="line">resource_pool = [<span class="string">'资源A'</span>, <span class="string">'资源B'</span>, <span class="string">'资源C'</span>]</span><br><span class="line">resource_in_use = {}  <span class="comment"># 跟踪资源使用情况</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 保护资源分配的锁</span></span><br><span class="line">resource_lock = threading.RLock()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">worker_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">"""工作线程函数，模拟使用受限资源"""</span></span><br><span class="line">    <span class="comment"># 尝试获取信号量</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> 等待获取资源..."</span>)</span><br><span class="line">    <span class="keyword">with</span> pool_semaphore:  <span class="comment"># 等同于acquire()和finally中release()</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> 获取资源信号量"</span>)</span><br><span class="line">        <span class="keyword">with</span> resource_lock:</span><br><span class="line">            <span class="comment"># 检查resource_pool中的每个资源，如果该资源不在resource_in_use字典的值中，则认为是可用的</span></span><br><span class="line">            available_resources = [r <span class="keyword">for</span> r <span class="keyword">in</span> resource_pool <span class="keyword">if</span> r <span class="keyword">not</span> <span class="keyword">in</span> resource_in_use.values()]</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> available_resources:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> 没有找到可用资源，理论上不应该发生！"</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            resource_name = available_resources[<span class="number">0</span>]</span><br><span class="line">            resource_in_use[worker_id] = resource_name  <span class="comment"># 记录资源使用情况</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> 分配到资源: <span class="subst">{resource_name}</span>, 当前使用情况: <span class="subst">{resource_in_use}</span>"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 模拟使用资源</span></span><br><span class="line">            work_time = random.uniform(<span class="number">0.5</span>, <span class="number">2.0</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> 使用资源 <span class="subst">{resource_name}</span> 时间: <span class="subst">{work_time}</span> 秒"</span>)</span><br><span class="line">            time.sleep(work_time)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># 释放资源</span></span><br><span class="line">            <span class="keyword">with</span> resource_lock:</span><br><span class="line">                released_resource = resource_in_use.pop(worker_id)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> 释放资源: <span class="subst">{released_resource}</span>, 当前使用情况: <span class="subst">{resource_in_use}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 创建线程池，并启动三个线程</span></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">3</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = [executor.submit(worker, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> futures:</span><br><span class="line">            future.result()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>Semaphore 方法</th><th>描述</th><th>参数</th><th>返回值</th></tr></thead><tbody><tr><td><code>__init__(value=1)</code></td><td>初始化信号量</td><td>value: 初始计数器值</td><td>无</td></tr><tr><td><code>acquire(blocking=True, timeout=None)</code></td><td>获取信号量</td><td>blocking: 是否阻塞, timeout: 超时时间</td><td>布尔值，表示是否获取成功</td></tr><tr><td><code>release(n=1)</code></td><td>释放信号量</td><td>n: 释放的数量</td><td>无</td></tr><tr><td><code>__enter__()</code></td><td>支持 with 语句</td><td>无</td><td>信号量对象自身</td></tr><tr><td><code>__exit__()</code></td><td>with 语句退出时调用</td><td>异常信息</td><td>无，自动释放信号量</td></tr></tbody></table><h5 id="有界信号量-BoundedSemaphore-详解"><a href="#有界信号量-BoundedSemaphore-详解" class="headerlink" title="有界信号量(BoundedSemaphore)详解"></a>有界信号量(BoundedSemaphore)详解</h5><p>有界信号量是信号量的一个变种，它会检查释放操作是否会导致计数器超过初始值，如果超过则抛出异常。这可以帮助检测程序中的信号量使用错误。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建有界信号量，初始值为3</span></span><br><span class="line">bounded_semaphore = threading.BoundedSemaphore(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">semaphore_demo</span>():</span><br><span class="line">    <span class="string">"""演示有界信号量与普通信号量的区别"""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"获取信号量1次"</span>)</span><br><span class="line">        bounded_semaphore.acquire()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"获取信号量2次"</span>)</span><br><span class="line">        bounded_semaphore.acquire()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"获取信号量3次"</span>)</span><br><span class="line">        bounded_semaphore.acquire()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"信号量已用完，再获取将阻塞"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 释放全部信号量</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"释放信号量1次"</span>)</span><br><span class="line">        bounded_semaphore.release()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"释放信号量2次"</span>)</span><br><span class="line">        bounded_semaphore.release()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"释放信号量3次"</span>)</span><br><span class="line">        bounded_semaphore.release()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 超出初始值的释放将抛出异常</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"尝试额外释放一次"</span>)</span><br><span class="line">            bounded_semaphore.release()  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"这一行不会执行"</span>)</span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"捕获预期异常: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"意外错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line">semaphore_demo()</span><br></pre></td></tr></tbody></table></figure><blockquote><p>🔍 <strong>Semaphore vs BoundedSemaphore</strong>：</p><ul><li><code>Semaphore</code> 允许无限制地调用 <code>release()</code>，即使计数器超过初始值</li><li><code>BoundedSemaphore</code> 在计数器超过初始值时会抛出 <code>ValueError</code> 异常</li><li>生产环境推荐使用 <code>BoundedSemaphore</code>，或安全的使用 with 语句，保证程序安全</li></ul></blockquote><h5 id="事件对象-Event"><a href="#事件对象-Event" class="headerlink" title="事件对象(Event)"></a>事件对象(Event)</h5><p>事件对象是最简单的线程通信机制之一，它允许一个线程发送信号给其他线程，适合简单的 “一次性通知” 场景。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建事件对象</span></span><br><span class="line">start_event = threading.Event()</span><br><span class="line">results: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line">results_lock = threading.RLock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">worker_id:<span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""工作线程函数，等待开始信号"""</span></span><br><span class="line">    prep_time = random.uniform(<span class="number">0.5</span>, <span class="number">1.5</span>)</span><br><span class="line">    time.sleep(prep_time)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"工作线程<span class="subst">{worker_id}</span>准备完毕，等待开始信号"</span>)</span><br><span class="line">    <span class="comment"># 等待开始信号</span></span><br><span class="line">    start_event.wait()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 收到信号开始工作</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"工作线程<span class="subst">{worker_id}</span>开始工作"</span>)</span><br><span class="line">    work_time = random.uniform(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    time.sleep(work_time)</span><br><span class="line">    <span class="comment"># 记录结果</span></span><br><span class="line">    <span class="keyword">with</span> results_lock:</span><br><span class="line">        results.append(<span class="string">f"工作线程<span class="subst">{worker_id}</span>完成工作"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"工作线程<span class="subst">{worker_id}</span>完成工作，用时<span class="subst">{work_time:<span class="number">.2</span>f}</span>秒"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 创建线程池</span></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">3</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = [executor.submit(worker, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line">        <span class="comment"># 等待所有线程准备完毕</span></span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># 发送开始信号</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"发送开始信号"</span>)</span><br><span class="line">        start_event.<span class="built_in">set</span>()</span><br><span class="line">        <span class="comment"># 等待所有线程完成工作</span></span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> futures:</span><br><span class="line">            future.result()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"所有工作线程完成"</span>)</span><br><span class="line">    <span class="built_in">print</span>(results)</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>Event 方法</th><th>描述</th><th>参数</th><th>返回值</th></tr></thead><tbody><tr><td><code>set()</code></td><td>设置事件，唤醒所有等待的线程</td><td>无</td><td>无</td></tr><tr><td><code>clear()</code></td><td>清除事件标志</td><td>无</td><td>无</td></tr><tr><td><code>is_set()</code></td><td>判断事件是否已设置</td><td>无</td><td>布尔值</td></tr><tr><td><code>wait(timeout=None)</code></td><td>等待事件被设置</td><td>timeout: 超时时间</td><td>如果超时返回 False，否则返回 True</td></tr></tbody></table><blockquote><p>💡 <strong>使用场景</strong>：</p><ul><li>启动信号：所有线程等待统一开始</li><li>停止信号：通知所有线程停止工作</li><li>一次性通知：当某条件满足时通知等待线程</li></ul></blockquote><h5 id="栅栏对象-Barrier"><a href="#栅栏对象-Barrier" class="headerlink" title="栅栏对象(Barrier)"></a>栅栏对象(Barrier)</h5><p>栅栏是一种同步原语，它要求固定数量的线程都到达栅栏点后，才允许所有线程继续执行。这对于分阶段任务的同步特别有用。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment">## 定义参与方数量</span></span><br><span class="line">num_parties = <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建栅栏对象，当4个线程都到达时才继续</span></span><br><span class="line">barrier = threading.Barrier(num_parties)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">worker_id</span>):</span><br><span class="line">    <span class="string">"""工作线程函数，模拟多阶段工作</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        worker_id: 工作线程ID</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> 开始第一阶段工作"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 模拟第一阶段工作</span></span><br><span class="line">    work_time = random.uniform(<span class="number">0.5</span>, <span class="number">2.0</span>)</span><br><span class="line">    time.sleep(work_time)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> 完成第一阶段，用时 <span class="subst">{work_time:<span class="number">.2</span>f}</span> 秒，等待其他线程..."</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 等待所有线程完成第一阶段</span></span><br><span class="line">        barrier.wait()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> 通过第一个栅栏，开始第二阶段"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 模拟第二阶段工作</span></span><br><span class="line">        work_time = random.uniform(<span class="number">0.5</span>, <span class="number">2.0</span>)</span><br><span class="line">        time.sleep(work_time)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> 完成第二阶段，用时 <span class="subst">{work_time:<span class="number">.2</span>f}</span> 秒，等待其他线程..."</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 等待所有线程完成第二阶段</span></span><br><span class="line">        barrier.wait()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> 通过第二个栅栏，工作全部完成"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> threading.BrokenBarrierError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> 检测到栅栏被破坏"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建工作线程</span></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_parties):</span><br><span class="line">    t = threading.Thread(target=worker, args=(i,))</span><br><span class="line">    threads.append(t)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 等待所有线程完成</span></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"所有工作阶段已完成"</span>)</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>Barrier 方法</th><th>描述</th><th>参数</th><th>返回值</th></tr></thead><tbody><tr><td><code>__init__(parties, action=None, timeout=None)</code></td><td>初始化栅栏</td><td>parties: 参与方数量, action: 所有线程到达时执行的回调, timeout: 等待超时</td><td>无</td></tr><tr><td><code>wait(timeout=None)</code></td><td>等待所有参与方到达</td><td>timeout: 覆盖默认超时时间</td><td>线程的到达序号(0 ~ n-1)</td></tr><tr><td><code>reset()</code></td><td>将栅栏重置到初始状态</td><td>无</td><td>无，正在等待的线程会抛出 BrokenBarrierError</td></tr><tr><td><code>abort()</code></td><td>将栅栏置于损坏状态</td><td>无</td><td>无，所有等待线程会抛出 BrokenBarrierError</td></tr><tr><td><code>parties</code></td><td>参与方数量(属性)</td><td>无</td><td>整数</td></tr><tr><td><code>n_waiting</code></td><td>当前等待的线程数(属性)</td><td>无</td><td>整数</td></tr><tr><td><code>broken</code></td><td>栅栏是否处于损坏状态(属性)</td><td>无</td><td>布尔值</td></tr></tbody></table><blockquote><p>⚠️ <strong>注意事项</strong>：</p><ul><li>如果等待超时，栅栏会进入损坏状态</li><li>如果等待时的线程被中断，栅栏也会损坏</li><li>可以通过 <code>reset()</code> 方法重新使用已损坏的栅栏</li></ul></blockquote><h5 id="线程安全队列-Queue"><a href="#线程安全队列-Queue" class="headerlink" title="线程安全队列(Queue)"></a>线程安全队列(Queue)</h5><p><code>queue</code> 模块提供的 <code>Queue</code> 类是一个线程安全的队列实现，通常用于线程间的数据传递和任务分发。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建线程安全队列</span></span><br><span class="line">task_queue = queue.Queue(maxsize=<span class="number">10</span>)  <span class="comment"># 最多容纳10个任务</span></span><br><span class="line">result_queue = queue.Queue()  <span class="comment"># 结果队列，无大小限制</span></span><br><span class="line"><span class="comment">## 用于通知工作线程结束的标志</span></span><br><span class="line">exit_flag = threading.Event()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">producer</span>():</span><br><span class="line">    <span class="string">"""生产者线程，产生任务"""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        task = <span class="string">f"任务-<span class="subst">{i}</span>"</span></span><br><span class="line">        <span class="comment"># 将任务放入队列</span></span><br><span class="line">        task_queue.put(task)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"生产者: 添加 <span class="subst">{task}</span> 到队列，当前队列大小: <span class="subst">{task_queue.qsize()}</span>"</span>)</span><br><span class="line">        time.sleep(random.uniform(<span class="number">0.1</span>, <span class="number">0.3</span>))  <span class="comment"># 随机延迟</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加结束标记</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"生产者: 所有任务已产生，设置退出标志"</span>)</span><br><span class="line">    exit_flag.<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consumer</span>(<span class="params">consumer_id</span>):</span><br><span class="line">    <span class="string">"""消费者线程，处理任务"""</span></span><br><span class="line">    <span class="comment"># 直到所有任务都处理完毕或有新任务到来</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> exit_flag.is_set() <span class="keyword">or</span> <span class="keyword">not</span> task_queue.empty():</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 从队列获取任务，最多等待1秒</span></span><br><span class="line">            task = task_queue.get(timeout=<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># 模拟处理任务</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"消费者 <span class="subst">{consumer_id}</span>: 开始处理 <span class="subst">{task}</span>"</span>)</span><br><span class="line">            process_time = random.uniform(<span class="number">0.5</span>, <span class="number">1.5</span>)</span><br><span class="line">            time.sleep(process_time)</span><br><span class="line">            <span class="comment"># 将处理结果放入结果队列</span></span><br><span class="line">            result = <span class="string">f"结果-<span class="subst">{task}</span>-耗时<span class="subst">{process_time:<span class="number">.2</span>f}</span>秒"</span></span><br><span class="line">            result_queue.put((consumer_id, result))</span><br><span class="line">            <span class="comment"># 标记任务完成</span></span><br><span class="line">            task_queue.task_done()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"消费者 <span class="subst">{consumer_id}</span>: 完成处理 <span class="subst">{task}</span>"</span>)</span><br><span class="line">        <span class="keyword">except</span> queue.Empty:</span><br><span class="line">            <span class="comment"># 队列为空且设置了退出标志时结束循环</span></span><br><span class="line">            <span class="keyword">if</span> exit_flag.is_set():</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"消费者 <span class="subst">{consumer_id}</span>: 队列暂时为空，等待任务..."</span>)</span><br><span class="line">            time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"消费者 <span class="subst">{consumer_id}</span>: 退出"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 创建生产者线程和消费者线程</span></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="comment"># 创建生产者线程</span></span><br><span class="line">        producers = [executor.submit(producer) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>)]</span><br><span class="line">        <span class="comment"># 创建消费者线程</span></span><br><span class="line">        consumers = [executor.submit(consumer, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>)]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 等待所有线程结束</span></span><br><span class="line">        all_futures = producers + consumers</span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> all_futures:</span><br><span class="line">            future.result()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 打印结果队列中的所有结果</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n处理结果:"</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> result_queue.empty():</span><br><span class="line">        consumer_id, result = result_queue.get()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"消费者 <span class="subst">{consumer_id}</span> 的结果: <span class="subst">{result}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>Queue 方法/属性</th><th>描述</th><th>参数</th><th>返回值/特性</th></tr></thead><tbody><tr><td><code>__init__(maxsize=0)</code></td><td>初始化队列</td><td>maxsize: 队列最大大小，0 表示无限</td><td>无</td></tr><tr><td><code>put(item, block=True, timeout=None)</code></td><td>放入元素</td><td>item: 元素, block: 是否阻塞, timeout: 超时时间</td><td>无，队列满时可能阻塞或抛出 Full 异常</td></tr><tr><td><code>get(block=True, timeout=None)</code></td><td>获取元素</td><td>block: 是否阻塞, timeout: 超时时间</td><td>队列元素，队列空时可能阻塞或抛出 Empty 异常</td></tr><tr><td><code>task_done()</code></td><td>标记任务完成</td><td>无</td><td>无</td></tr><tr><td><code>join()</code></td><td>等待队列中所有任务处理完成</td><td>无</td><td>无</td></tr><tr><td><code>qsize()</code></td><td>返回队列大小</td><td>无</td><td>整数</td></tr><tr><td><code>empty()</code></td><td>检查队列是否为空</td><td>无</td><td>布尔值</td></tr><tr><td><code>full()</code></td><td>检查队列是否已满</td><td>无</td><td>布尔值</td></tr><tr><td><code>put_nowait(item)</code></td><td>非阻塞版本的 put</td><td>item: 元素</td><td>无，队列满时抛出 Full 异常</td></tr><tr><td><code>get_nowait()</code></td><td>非阻塞版本的 get</td><td>无</td><td>队列元素，队列空时抛出 Empty 异常</td></tr></tbody></table><blockquote><p>💡 <strong>Queue 变种</strong>：</p><ul><li><code>queue.LifoQueue</code>: 后进先出队列(栈)</li><li><code>queue.PriorityQueue</code>: 优先级队列，元素为(优先级, 数据)元组</li><li><code>queue.SimpleQueue</code>: 简单的无界队列，不支持 task_done 和 join</li></ul></blockquote><h5 id="死锁问题分析与解决"><a href="#死锁问题分析与解决" class="headerlink" title="死锁问题分析与解决"></a>死锁问题分析与解决</h5><p>死锁是指两个或多个线程互相等待对方释放资源，导致程序无法继续执行的情况。</p><h6 id="死锁示例"><a href="#死锁示例" class="headerlink" title="死锁示例"></a>死锁示例</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建两个锁</span></span><br><span class="line">lock_1 = threading.Lock()</span><br><span class="line">lock_2 = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task1</span>():</span><br><span class="line">    <span class="string">"""第一个任务，先获取lock_1，再获取lock_2"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"任务1开始尝试获取锁..."</span>)</span><br><span class="line">    lock_1.acquire()  <span class="comment"># 获取1号锁</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"任务1获取到lock_1"</span>)</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)  <span class="comment"># 等待一会，让任务2有机会获取lock_2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"任务1尝试获取lock_2"</span>)</span><br><span class="line">    lock_2.acquire()  <span class="comment"># 尝试获取2号锁，但可能永远阻塞于此</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"任务1同时获取了两把锁"</span>)</span><br><span class="line">        <span class="comment"># 使用两把锁保护的代码</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 释放锁</span></span><br><span class="line">        lock_2.release()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"任务1释放了lock_2"</span>)</span><br><span class="line">        lock_1.release()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"任务1释放了lock_1"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task2</span>():</span><br><span class="line">    <span class="string">"""第二个任务，先获取lock_2，再获取lock_1"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"任务2开始尝试获取锁..."</span>)</span><br><span class="line">    lock_2.acquire()  <span class="comment"># 获取2号锁</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"任务2获取到lock_2"</span>)</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)  <span class="comment"># 等待一会</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"任务2尝试获取lock_1"</span>)</span><br><span class="line">    lock_1.acquire()  <span class="comment"># 尝试获取1号锁，但可能永远阻塞于此</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"任务2同时获取了两把锁"</span>)</span><br><span class="line">        <span class="comment"># 使用两把锁保护的代码</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 释放锁</span></span><br><span class="line">        lock_1.release()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"任务2释放了lock_1"</span>)</span><br><span class="line">        lock_2.release()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"任务2释放了lock_2"</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment">## 创建两个线程</span></span><br><span class="line">    t1 = threading.Thread(target=task1)</span><br><span class="line">    t2 = threading.Thread(target=task2)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## 启动线程</span></span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment">## 等待一段时间后检查是否发生死锁</span></span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## 检查线程是否还活着</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程1状态: <span class="subst">{<span class="string">'活跃'</span> <span class="keyword">if</span> t1.is_alive() <span class="keyword">else</span> <span class="string">'已结束'</span>}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程2状态: <span class="subst">{<span class="string">'活跃'</span> <span class="keyword">if</span> t2.is_alive() <span class="keyword">else</span> <span class="string">'已结束'</span>}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> t1.is_alive() <span class="keyword">and</span> t2.is_alive():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"检测到可能的死锁情况!"</span>)</span><br></pre></td></tr></tbody></table></figure><blockquote><p>⚠️ <strong>死锁的四个必要条件</strong>：</p><ol><li><strong>互斥条件</strong>：资源不能被共享，一次只能被一个线程使用</li><li><strong>请求与保持条件</strong>：线程已获得资源，但又提出新的资源请求</li><li><strong>不剥夺条件</strong>：线程已获得的资源不能强制被剥夺</li><li><strong>循环等待条件</strong>：线程之间形成头尾相接的循环等待资源关系</li></ol></blockquote><h6 id="死锁解决方案"><a href="#死锁解决方案" class="headerlink" title="死锁解决方案"></a>死锁解决方案</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建两个锁</span></span><br><span class="line">lock_1 = threading.Lock()</span><br><span class="line">lock_2 = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">acquire_locks_safe</span>(<span class="params">lock_a, lock_b, thread_name</span>):</span><br><span class="line">    <span class="string">"""安全地获取两个锁，使用超时机制避免死锁</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        lock_a: 第一个锁</span></span><br><span class="line"><span class="string">        lock_b: 第二个锁</span></span><br><span class="line"><span class="string">        thread_name: 线程名称</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        bool: 是否成功获取两个锁</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># 尝试获取第一个锁</span></span><br><span class="line">        got_lock_a = lock_a.acquire(timeout=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> got_lock_a:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"<span class="subst">{thread_name}</span>: 获取到第一个锁"</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 尝试获取第二个锁</span></span><br><span class="line">                got_lock_b = lock_b.acquire(timeout=<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> got_lock_b:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{thread_name}</span>: 获取到第二个锁"</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span>  <span class="comment"># 成功获取两个锁</span></span><br><span class="line">                <span class="comment"># 获取第二个锁失败，释放第一个锁，避免死锁</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"<span class="subst">{thread_name}</span>: 获取第二个锁失败，释放第一个锁并重试"</span>)</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> got_lock_b:</span><br><span class="line">                    lock_a.release()</span><br><span class="line">                    <span class="comment"># 短暂休眠，减少活锁可能性</span></span><br><span class="line">                    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"<span class="subst">{thread_name}</span>: 获取第一个锁失败，重试"</span>)</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)  <span class="comment"># 短暂休眠避免CPU忙等</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task1_fixed</span>():</span><br><span class="line">    <span class="string">"""修复死锁的任务1 - 使用安全获取锁函数"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"任务1开始执行..."</span>)</span><br><span class="line">    <span class="keyword">if</span> acquire_locks_safe(lock_1, lock_2, <span class="string">"任务1"</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"任务1: 同时持有两把锁，执行关键代码"</span>)</span><br><span class="line">            time.sleep(<span class="number">0.5</span>)  <span class="comment"># 模拟工作</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># 释放锁</span></span><br><span class="line">            lock_2.release()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"任务1: 释放lock_2"</span>)</span><br><span class="line">            lock_1.release()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"任务1: 释放lock_1"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"任务1: 无法获取所需的锁，任务取消"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task2_fixed</span>():</span><br><span class="line">    <span class="string">"""修复死锁的任务2 - 使用一致的锁获取顺序"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"任务2开始执行..."</span>)</span><br><span class="line">    <span class="comment"># 按与任务1相同的顺序获取锁，避免死锁</span></span><br><span class="line">    <span class="keyword">if</span> acquire_locks_safe(lock_1, lock_2, <span class="string">"任务2"</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"任务2: 同时持有两把锁，执行关键代码"</span>)</span><br><span class="line">            time.sleep(<span class="number">0.5</span>)  <span class="comment"># 模拟工作</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># 释放锁</span></span><br><span class="line">            lock_2.release()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"任务2: 释放lock_2"</span>)</span><br><span class="line">            lock_1.release()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"任务2: 释放lock_1"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"任务2: 无法获取所需的锁，任务取消"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建两个线程</span></span><br><span class="line">t1 = threading.Thread(target=task1_fixed)</span><br><span class="line">t2 = threading.Thread(target=task2_fixed)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动线程</span></span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 等待线程结束</span></span><br><span class="line">t1.join()</span><br><span class="line">t2.join()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"所有线程执行完毕，没有死锁"</span>)</span><br></pre></td></tr></tbody></table></figure><blockquote><p>🛠️ <strong>死锁预防方法</strong>：</p><ol><li><strong>按顺序获取锁</strong>：使所有线程按相同顺序获取锁</li><li><strong>超时机制</strong>：使用 <code>acquire(timeout=N)</code> 设置获取锁的超时时间</li><li><strong>一次性获取所有锁</strong>：创建更高级别的锁来同时获取多个锁</li><li><strong>使用显式资源分级</strong>：为资源分配层级，只允许按层级顺序获取</li><li><strong>避免嵌套锁</strong>：设计简化的锁策略，减少同时持有多个锁的情况</li><li><strong>使用 <code>with</code> 语句</strong>：确保锁在异常情况下也能被释放</li></ol></blockquote><h4 id="原子操作与锁优化"><a href="#原子操作与锁优化" class="headerlink" title="原子操作与锁优化"></a>原子操作与锁优化</h4><p>在并发编程中，原子操作是指不可被中断的操作，它们要么完全执行，要么完全不执行。Python 提供了一些原子操作工具，可以减少对锁的依赖。</p><h5 id="threading-local-对象-线程本地存储"><a href="#threading-local-对象-线程本地存储" class="headerlink" title="threading.local 对象 - 线程本地存储"></a><code>threading.local</code> 对象 - 线程本地存储</h5><p>线程本地存储提供了一种每个线程拥有自己独立数据副本的机制，避免了共享状态带来的并发问题。</p><blockquote><p>我们可以往 threading.local()上挂载对象，这样我们的每一个线程就会有属于自己的独立数据</p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建线程本地存储对象</span></span><br><span class="line">thread_local_data = threading.local()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_request</span>(<span class="params">request_id: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""处理请求的工作函数"""</span></span><br><span class="line">    <span class="comment"># 为当前线程设置上下文信息</span></span><br><span class="line">    thread_local_data.user_id = <span class="string">f"user-<span class="subst">{random.randint(<span class="number">1000</span>, <span class="number">9999</span>)}</span>"</span></span><br><span class="line">    thread_local_data.request = request_id</span><br><span class="line">    thread_local_data.start_time = time.time()</span><br><span class="line">    <span class="comment"># 模拟处理请求的各个阶段</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"请求 <span class="subst">{request_id}</span>: 开始处理 [线程: <span class="subst">{threading.current_thread().name}</span>, 用户: <span class="subst">{thread_local_data.user_id}</span>]"</span>)</span><br><span class="line">    process_stage(<span class="string">"验证"</span>)</span><br><span class="line">    process_stage(<span class="string">"处理"</span>)</span><br><span class="line">    process_stage(<span class="string">"响应"</span>)</span><br><span class="line">    <span class="comment"># 计算总处理时间</span></span><br><span class="line">    elapsed = time.time() - thread_local_data.start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"请求 <span class="subst">{request_id}</span>: 完成处理，总耗时 <span class="subst">{elapsed:<span class="number">.2</span>f}</span>秒 [线程: <span class="subst">{threading.current_thread().name}</span>]"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_stage</span>(<span class="params">stage_name: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">"""处理请求的某个阶段"""</span></span><br><span class="line">    <span class="comment"># 访问线程本地变量，无需传递参数</span></span><br><span class="line">    request_id = thread_local_data.request</span><br><span class="line">    user_id = thread_local_data.user_id</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 模拟阶段处理</span></span><br><span class="line">    time.sleep(random.uniform(<span class="number">0.1</span>, <span class="number">0.5</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"请求 <span class="subst">{request_id}</span>: <span class="subst">{stage_name}</span>阶段完成 [用户: <span class="subst">{user_id}</span>]"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">10</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = [executor.submit(process_request, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> futures:</span><br><span class="line">            future.result()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"所有请求处理完成"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="functools-lru-cache-带锁的缓存"><a href="#functools-lru-cache-带锁的缓存" class="headerlink" title="functools.lru_cache 带锁的缓存"></a><code>functools.lru_cache</code> 带锁的缓存</h5><p><code>functools.lru_cache</code> 装饰器提供了一个线程安全的缓存机制，当一个函数的计算逻辑十分复杂，我们就可以采用缓存来优化这一点</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== LRU缓存演示 ==========</span></span><br><span class="line"><span class="meta">@functools.lru_cache(<span class="params">maxsize=<span class="number">128</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fibonacci</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="string">"""计算斐波那契数列的第n个数，使用LRU缓存优化性能"""</span></span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    <span class="keyword">return</span> fibonacci(n-<span class="number">1</span>) + fibonacci(n-<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demonstrate_lru_cache</span>():</span><br><span class="line">    <span class="string">"""演示LRU缓存的效果"""</span></span><br><span class="line">    <span class="comment"># 不使用缓存的计算时间</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fibonacci_no_cache</span>(<span class="params">n</span>):</span><br><span class="line">        <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> n</span><br><span class="line">        <span class="keyword">return</span> fibonacci_no_cache(n-<span class="number">1</span>) + fibonacci_no_cache(n-<span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">    n = <span class="number">35</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试无缓存版本</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    result1 = fibonacci_no_cache(n)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"无缓存计算fibonacci(<span class="subst">{n}</span>) = <span class="subst">{result1}</span>，耗时: <span class="subst">{end - start:<span class="number">.4</span>f}</span>秒"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试有缓存版本</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    result2 = fibonacci(n)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"首次使用缓存计算fibonacci(<span class="subst">{n}</span>) = <span class="subst">{result2}</span>，耗时: <span class="subst">{end - start:<span class="number">.4</span>f}</span>秒"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 再次调用，应该直接从缓存获取结果</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    result3 = fibonacci(n)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"再次使用缓存计算fibonacci(<span class="subst">{n}</span>) = <span class="subst">{result3}</span>，耗时: <span class="subst">{end - start:<span class="number">.8</span>f}</span>秒"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 显示缓存信息</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"缓存信息: <span class="subst">{fibonacci.cache_info()}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    demonstrate_lru_cache()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="锁的高级应用模式"><a href="#锁的高级应用模式" class="headerlink" title="锁的高级应用模式"></a>锁的高级应用模式</h4><h5 id="读写锁模式"><a href="#读写锁模式" class="headerlink" title="读写锁模式"></a>读写锁模式</h5><p>Python 中的读写锁（Read-Write Lock）主要用于在多线程环境中控制对共享资源的访问。它允许多个线程同时读取共享数据，但在写操作时，其他线程不能进行读或写操作。具体的应用场景包括：</p><ol><li><strong>数据共享与并发读取</strong>：当多个线程需要读取同一份数据时，使用读锁可以提高并发性，允许多个线程同时访问数据，而不需要每次访问都加锁。</li><li><strong>写操作的独占性</strong>：当有线程进行写操作时，需要获取写锁，这样可以确保写操作的独占性，避免数据竞争和不一致性。</li><li><strong>性能优化</strong>：在读多写少的场景下，读写锁能提高性能，因为它允许多个线程并行读取数据，而只有在写入时才会阻塞其他线程。</li></ol><p>我们先从 Python 原生实现读写锁来作为演示，掌握了原生的方式，我们可以使用 <code>readerwriterlock</code> 第三方库来帮我们快速实现读写锁</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReadWriteLock</span>:</span><br><span class="line">    <span class="string">"""读写锁实现</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    允许多个读取者同时访问，或单个写入者独占访问</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""初始化读写锁"""</span></span><br><span class="line">        <span class="variable language_">self</span>._read_ready = threading.Condition(threading.RLock())</span><br><span class="line">        <span class="variable language_">self</span>._readers = <span class="number">0</span>  <span class="comment"># 当前读取者数量</span></span><br><span class="line">        <span class="variable language_">self</span>._writers = <span class="number">0</span>  <span class="comment"># 当前写入者数量</span></span><br><span class="line">        <span class="variable language_">self</span>._write_waiting = <span class="number">0</span>  <span class="comment"># 等待写入的线程数</span></span><br><span class="line">        <span class="variable language_">self</span>._writer = <span class="literal">None</span>  <span class="comment"># 当前持有写锁的线程ID</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire_read</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""获取读锁"""</span></span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>._read_ready:</span><br><span class="line">            <span class="comment"># 当有写入者或正在等待的写入者时，读取者需要等待</span></span><br><span class="line">            <span class="keyword">while</span> <span class="variable language_">self</span>._writers &gt; <span class="number">0</span> <span class="keyword">or</span> <span class="variable language_">self</span>._write_waiting &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="variable language_">self</span>._read_ready.wait()</span><br><span class="line">            <span class="variable language_">self</span>._readers += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">release_read</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""释放读锁"""</span></span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>._read_ready:</span><br><span class="line">            <span class="variable language_">self</span>._readers -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>._readers == <span class="number">0</span>:  <span class="comment"># 最后一个读取者通知所有等待的线程</span></span><br><span class="line">                <span class="variable language_">self</span>._read_ready.notify_all()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire_write</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""获取写锁"""</span></span><br><span class="line">        me = threading.get_ident()  <span class="comment"># 获取当前线程ID</span></span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>._read_ready:</span><br><span class="line">            <span class="variable language_">self</span>._write_waiting += <span class="number">1</span>  <span class="comment"># 增加等待写入计数</span></span><br><span class="line">            <span class="comment"># 等待没有读取者和写入者</span></span><br><span class="line">            <span class="keyword">while</span> <span class="variable language_">self</span>._readers &gt; <span class="number">0</span> <span class="keyword">or</span> <span class="variable language_">self</span>._writers &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="variable language_">self</span>._read_ready.wait()</span><br><span class="line">            <span class="variable language_">self</span>._write_waiting -= <span class="number">1</span>  <span class="comment"># 减少等待写入计数</span></span><br><span class="line">            <span class="variable language_">self</span>._writers += <span class="number">1</span></span><br><span class="line">            <span class="variable language_">self</span>._writer = me</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">release_write</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""释放写锁"""</span></span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>._read_ready:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>._writer != threading.get_ident():</span><br><span class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">"释放未持有的写锁"</span>)</span><br><span class="line">            <span class="variable language_">self</span>._writers -= <span class="number">1</span></span><br><span class="line">            <span class="variable language_">self</span>._writer = <span class="literal">None</span></span><br><span class="line">            <span class="variable language_">self</span>._read_ready.notify_all()  <span class="comment"># 通知所有等待的线程</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 支持with语句的上下文管理器</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ReadLock</span>:</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, rw_lock</span>):</span><br><span class="line">            <span class="variable language_">self</span>.rw_lock = rw_lock</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">            <span class="variable language_">self</span>.rw_lock.acquire_read()</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">            <span class="variable language_">self</span>.rw_lock.release_read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">WriteLock</span>:</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, rw_lock</span>):</span><br><span class="line">            <span class="variable language_">self</span>.rw_lock = rw_lock</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">            <span class="variable language_">self</span>.rw_lock.acquire_write()</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">            <span class="variable language_">self</span>.rw_lock.release_write()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取读锁和写锁的方法</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_lock</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""获取读锁上下文管理器"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.ReadLock(<span class="variable language_">self</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_lock</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""获取写锁上下文管理器"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.WriteLock(<span class="variable language_">self</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 共享数据和读写锁</span></span><br><span class="line">shared_data = {<span class="string">'count'</span>: <span class="number">0</span>, <span class="string">'values'</span>: []}</span><br><span class="line">rw_lock = ReadWriteLock()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reader</span>(<span class="params">reader_id</span>):</span><br><span class="line">    <span class="string">"""读取者线程</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        reader_id: 读取者ID</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        <span class="comment"># 获取读锁</span></span><br><span class="line">        <span class="keyword">with</span> rw_lock.read_lock():</span><br><span class="line">            <span class="comment"># 读取共享数据</span></span><br><span class="line">            count = shared_data[<span class="string">'count'</span>]</span><br><span class="line">            values = shared_data[<span class="string">'values'</span>].copy()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 模拟读取操作</span></span><br><span class="line">            time.sleep(random.uniform(<span class="number">0.05</span>, <span class="number">0.1</span>))</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"读取者 <span class="subst">{reader_id}</span>: 读取到 count=<span class="subst">{count}</span>, values=<span class="subst">{values}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 读取者之间的休息</span></span><br><span class="line">        time.sleep(random.uniform(<span class="number">0.1</span>, <span class="number">0.3</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">writer</span>(<span class="params">writer_id</span>):</span><br><span class="line">    <span class="string">"""写入者线程</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        writer_id: 写入者ID</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        <span class="comment"># 准备新数据</span></span><br><span class="line">        new_value = writer_id * <span class="number">100</span> + i</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取写锁</span></span><br><span class="line">        <span class="keyword">with</span> rw_lock.write_lock():</span><br><span class="line">            <span class="comment"># 修改共享数据</span></span><br><span class="line">            shared_data[<span class="string">'count'</span>] += <span class="number">1</span></span><br><span class="line">            shared_data[<span class="string">'values'</span>].append(new_value)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 模拟写入操作</span></span><br><span class="line">            time.sleep(random.uniform(<span class="number">0.1</span>, <span class="number">0.2</span>))</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"写入者 <span class="subst">{writer_id}</span>: 更新为 count=<span class="subst">{shared_data[<span class="string">'count'</span>]}</span>, values=<span class="subst">{shared_data[<span class="string">'values'</span>]}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 写入者之间的休息</span></span><br><span class="line">        time.sleep(random.uniform(<span class="number">0.3</span>, <span class="number">0.7</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建读取者和写入者线程</span></span><br><span class="line">readers = [threading.Thread(target=reader, args=(i,)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">writers = [threading.Thread(target=writer, args=(i,)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment">### 启动所有线程</span></span><br><span class="line">all_threads = readers + writers</span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> all_threads:</span><br><span class="line">    thread.start()</span><br><span class="line"></span><br><span class="line"><span class="comment">### 等待所有线程完成</span></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> all_threads:</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"最终数据: count=<span class="subst">{shared_data[<span class="string">'count'</span>]}</span>, values=<span class="subst">{shared_data[<span class="string">'values'</span>]}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="使用-readerwriterlock-库实现读写锁"><a href="#使用-readerwriterlock-库实现读写锁" class="headerlink" title="使用 readerwriterlock 库实现读写锁"></a>使用 <code>readerwriterlock</code> 库实现读写锁</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">读写锁实现示例</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">readerwriterlock库提供了三种读写锁实现：</span></span><br><span class="line"><span class="string">- RWLockRead：读者优先（第一读者-写者问题）</span></span><br><span class="line"><span class="string">- RWLockWrite：写者优先（第二读者-写者问题）</span></span><br><span class="line"><span class="string">- RWLockFair：公平优先（第三读者-写者问题）</span></span><br><span class="line"><span class="string">每种锁都有对应的可降级版本（带D后缀），允许将锁从写模式降级到读模式</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> readerwriterlock <span class="keyword">import</span> rwlock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个公平优先的读写锁</span></span><br><span class="line">rw_lock = rwlock.RWLockFairD()</span><br><span class="line"><span class="comment"># 共享数据</span></span><br><span class="line">shared_data = {<span class="string">'count'</span>: <span class="number">0</span>, <span class="string">'values'</span>: []}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_demo</span>(<span class="params">reader_id, sleep_time=<span class="number">0.5</span></span>):</span><br><span class="line">    <span class="string">"""用于演示的读取函数"""</span></span><br><span class="line">    read_lock = rw_lock.gen_rlock()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> read_lock:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"读取者 <span class="subst">{reader_id}</span>: 获得读锁"</span>)</span><br><span class="line">            time.sleep(sleep_time)  <span class="comment"># 模拟读取操作</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"读取者 <span class="subst">{reader_id}</span>: 完成读取"</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"读取者 <span class="subst">{reader_id}</span>: 释放读锁"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_demo</span>(<span class="params">writer_id, sleep_time=<span class="number">0.5</span></span>):</span><br><span class="line">    <span class="string">"""用于演示的写入函数"""</span></span><br><span class="line">    write_lock = rw_lock.gen_wlock()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> write_lock:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"写入者 <span class="subst">{writer_id}</span>: 获得写锁"</span>)</span><br><span class="line">            time.sleep(sleep_time)  <span class="comment"># 模拟写入操作</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"写入者 <span class="subst">{writer_id}</span>: 完成写入"</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"写入者 <span class="subst">{writer_id}</span>: 释放写锁"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demonstrate_read_read_nonblocking</span>():</span><br><span class="line">    <span class="string">"""演示读读不互斥"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n=== 演示：读读不互斥 ==="</span>)</span><br><span class="line">    </span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        thread = threading.Thread(target=read_demo, args=(i, <span class="number">0.5</span>))</span><br><span class="line">        threads.append(thread)</span><br><span class="line">        thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">        thread.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demonstrate_read_write_blocking</span>():</span><br><span class="line">    <span class="string">"""演示读写互斥"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n=== 演示：读写互斥 ==="</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 先启动一个长时间的读取线程</span></span><br><span class="line">    read_thread = threading.Thread(target=read_demo, args=(<span class="number">0</span>, <span class="number">2</span>))</span><br><span class="line">    read_thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 给读取线程一点时间获取锁</span></span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 尝试启动写入线程，应该被阻塞直到读取完成</span></span><br><span class="line">    write_thread = threading.Thread(target=write_demo, args=(<span class="number">0</span>, <span class="number">0.5</span>))</span><br><span class="line">    write_thread.start()</span><br><span class="line"></span><br><span class="line">    read_thread.join()</span><br><span class="line">    write_thread.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demonstrate_write_write_blocking</span>():</span><br><span class="line">    <span class="string">"""演示写写互斥"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n=== 演示：写写互斥 ==="</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 先启动一个长时间的写入线程</span></span><br><span class="line">    write_thread1 = threading.Thread(target=write_demo, args=(<span class="number">0</span>, <span class="number">2</span>))</span><br><span class="line">    write_thread1.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 给第一个写入线程一点时间获取锁</span></span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 尝试启动另一个写入线程，应该被阻塞直到第一个写入完成</span></span><br><span class="line">    write_thread2 = threading.Thread(target=write_demo, args=(<span class="number">1</span>, <span class="number">0.5</span>))</span><br><span class="line">    write_thread2.start()</span><br><span class="line"></span><br><span class="line">    write_thread1.join()</span><br><span class="line">    write_thread2.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demonstrate_timeout</span>():</span><br><span class="line">    <span class="string">"""演示锁获取超时"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n=== 演示：锁获取超时 ==="</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 先启动一个长时间的写入线程</span></span><br><span class="line">    write_thread = threading.Thread(target=write_demo, args=(<span class="number">0</span>, <span class="number">3</span>))</span><br><span class="line">    write_thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 给写入线程一点时间获取锁</span></span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 尝试获取读锁，但设置较短的超时时间</span></span><br><span class="line">    read_lock = rw_lock.gen_rlock()</span><br><span class="line">    <span class="keyword">if</span> read_lock.acquire(blocking=<span class="literal">True</span>, timeout=<span class="number">0.5</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"读取者: 成功获得读锁（不应该发生）"</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            read_lock.release()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"读取者: 获取读锁超时（预期行为）"</span>)</span><br><span class="line"></span><br><span class="line">    write_thread.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 演示读读不互斥</span></span><br><span class="line">    demonstrate_read_read_nonblocking()</span><br><span class="line">    <span class="comment"># 演示读写互斥</span></span><br><span class="line">    demonstrate_read_write_blocking()</span><br><span class="line">    <span class="comment"># 演示写写互斥</span></span><br><span class="line">    demonstrate_write_write_blocking()</span><br><span class="line">    <span class="comment"># 演示锁获取超时</span></span><br><span class="line">    demonstrate_timeout()</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>读写锁特性</th><th>描述</th><th>优势</th><th>适用场景</th></tr></thead><tbody><tr><td>读共享/写独占</td><td>多个读取可并发，写入需独占</td><td>提高读多写少场景的并发性</td><td>配置数据、缓存系统、数据集</td></tr><tr><td>读写优先级</td><td>可以设置读优先或写优先</td><td>根据应用需求调整性能特性</td><td>根据读写比例调整策略</td></tr><tr><td>升级/降级</td><td>支持锁的升级(读 → 写)或降级(写 → 读)</td><td>灵活处理复杂访问模式</td><td>先检查后修改的操作</td></tr></tbody></table><blockquote><p>💡 <strong>使用建议</strong>：</p><ul><li>读多写少的场景推荐使用读写锁</li><li>注意防止 “写饥饿”，即读取者太多导致写入者长时间等待</li></ul></blockquote><h6 id="锁排序（解决死锁）"><a href="#锁排序（解决死锁）" class="headerlink" title="锁排序（解决死锁）"></a>锁排序（解决死锁）</h6><p>为避免死锁，一个常用的技术是确保所有线程按照相同的顺序获取多个锁。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Account</span>:</span><br><span class="line">    <span class="string">"""模拟银行账户"""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name: <span class="built_in">str</span>, balance: <span class="built_in">int</span> = <span class="number">0</span></span>):</span><br><span class="line">        <span class="string">"""初始化账户"""</span></span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.balance = balance</span><br><span class="line">        <span class="variable language_">self</span>.lock = threading.RLock()</span><br><span class="line">        <span class="comment"># 用于账户排序的唯一ID</span></span><br><span class="line">        <span class="variable language_">self</span>.<span class="built_in">id</span> = <span class="built_in">id</span>(<span class="variable language_">self</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"账户<span class="subst">{self.name}</span>[余额=<span class="subst">{self.balance}</span>]"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transfer_money</span>(<span class="params">from_account: Account, to_account: Account, amount: <span class="built_in">int</span>, thread_name: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    在账户间转账，使用账户ID排序策略避免死锁</span></span><br><span class="line"><span class="string">    from_account: 转出账户</span></span><br><span class="line"><span class="string">    to_account: 转入账户</span></span><br><span class="line"><span class="string">    amount: 转账金额</span></span><br><span class="line"><span class="string">    thread_name: 线程名称</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 按照账户ID从小到大的顺序获取锁，确保所有线程获取锁的顺序一致</span></span><br><span class="line">    first, second = <span class="built_in">sorted</span>([from_account, to_account], key=<span class="keyword">lambda</span> x: x.<span class="built_in">id</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{thread_name}</span>: 尝试锁定账户 <span class="subst">{first.name}</span>"</span>)</span><br><span class="line">    <span class="keyword">with</span> first.lock:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{thread_name}</span>: 已锁定账户 <span class="subst">{first.name}</span>"</span>)</span><br><span class="line">        <span class="comment"># 模拟网络延迟</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{thread_name}</span>: 尝试锁定账户 <span class="subst">{second.name}</span>"</span>)</span><br><span class="line">        <span class="keyword">with</span> second.lock:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"<span class="subst">{thread_name}</span>: 已锁定账户 <span class="subst">{second.name}</span>"</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 执行转账操作</span></span><br><span class="line">            from_account.balance -= amount</span><br><span class="line">            to_account.balance += amount</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"<span class="subst">{thread_name}</span>: 已从<span class="subst">{from_account.name}</span>转账<span class="subst">{amount}</span>元到<span class="subst">{to_account.name}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 创建两个账户</span></span><br><span class="line">    alice = Account(<span class="string">"Alice"</span>, <span class="number">1000</span>)</span><br><span class="line">    bob = Account(<span class="string">"Bob"</span>, <span class="number">1000</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"初始状态: <span class="subst">{alice}</span>, <span class="subst">{bob}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建两个线程，同时进行相反方向的转账</span></span><br><span class="line">    t1 = threading.Thread(</span><br><span class="line">        name=<span class="string">"Thread-1"</span>,</span><br><span class="line">        target=transfer_money,</span><br><span class="line">        args=(alice, bob, <span class="number">500</span>, <span class="string">"转账线程1"</span>)</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    t2 = threading.Thread(</span><br><span class="line">        name=<span class="string">"Thread-2"</span>,</span><br><span class="line">        target=transfer_money,</span><br><span class="line">        args=(bob, alice, <span class="number">300</span>, <span class="string">"转账线程2"</span>)</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动线程</span></span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待线程结束</span></span><br><span class="line">    t1.join()</span><br><span class="line">    t2.join()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"最终状态: <span class="subst">{alice}</span>, <span class="subst">{bob}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="两阶段锁定"><a href="#两阶段锁定" class="headerlink" title="两阶段锁定"></a>两阶段锁定</h6><p>两阶段锁定是一种事务并发控制协议，分为获取阶段和释放阶段，可以保证事务的可串行化。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TwoPhaseLockDatabase</span>:</span><br><span class="line">    <span class="string">"""演示两阶段锁定协议的简单数据库"""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""初始化数据库"""</span></span><br><span class="line">        <span class="variable language_">self</span>.data = {<span class="string">'A'</span>: <span class="number">100</span>, <span class="string">'B'</span>: <span class="number">200</span>}  <span class="comment"># 简单的数据项</span></span><br><span class="line">        <span class="variable language_">self</span>.locks = {<span class="string">'A'</span>: threading.RLock(), <span class="string">'B'</span>: threading.RLock()}  <span class="comment"># 每个数据项的锁</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">transaction</span>(<span class="params">self, items_to_read, items_to_write, operation</span>):</span><br><span class="line">        <span class="string">"""执行两阶段锁定事务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            items_to_read: 需要读取的数据项列表</span></span><br><span class="line"><span class="string">            items_to_write: 需要写入的数据项列表</span></span><br><span class="line"><span class="string">            operation: 事务操作函数</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 事务是否成功</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 按字母顺序排序所有需要锁定的项，避免死锁</span></span><br><span class="line">        all_items = <span class="built_in">sorted</span>(<span class="built_in">set</span>(items_to_read + items_to_write))</span><br><span class="line">        acquired_locks = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 阶段1: 获取锁阶段（增长阶段）</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"事务 <span class="subst">{threading.current_thread().name}</span>: 开始获取锁"</span>)</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> all_items:</span><br><span class="line">                <span class="comment"># 对于读取项获取共享锁，对于写入项获取排他锁</span></span><br><span class="line">                <span class="comment"># 这里简化为都使用排他锁</span></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.locks[item].acquire(timeout=<span class="number">1</span>):</span><br><span class="line">                    acquired_locks.append(item)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f"事务 <span class="subst">{threading.current_thread().name}</span>: 已锁定 <span class="subst">{item}</span>"</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span> TimeoutError(<span class="string">f"获取 <span class="subst">{item}</span> 的锁超时"</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 执行事务操作</span></span><br><span class="line">            result = operation(<span class="variable language_">self</span>.data)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"事务 <span class="subst">{threading.current_thread().name}</span>: 操作完成"</span>)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"事务 <span class="subst">{threading.current_thread().name}</span>: 错误 - <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># 阶段2: 释放锁阶段（收缩阶段）</span></span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> acquired_locks:</span><br><span class="line">                <span class="variable language_">self</span>.locks[item].release()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"事务 <span class="subst">{threading.current_thread().name}</span>: 已释放 <span class="subst">{item}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transfer_money</span>(<span class="params">db, from_account, to_account, amount</span>):</span><br><span class="line">    <span class="string">"""转账事务"""</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">operation</span>(<span class="params">data</span>):</span><br><span class="line">        <span class="keyword">if</span> data[from_account] &lt; amount:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"账户 <span class="subst">{from_account}</span> 余额不足"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 模拟操作耗时</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 执行转账</span></span><br><span class="line">        data[from_account] -= amount</span><br><span class="line">        data[to_account] += amount</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"已从 <span class="subst">{from_account}</span> 转账 <span class="subst">{amount}</span> 到 <span class="subst">{to_account}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> db.transaction([from_account, to_account], [from_account, to_account], operation)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_transaction</span>(<span class="params">db, thread_id, from_acc, to_acc, amount</span>):</span><br><span class="line">    <span class="string">"""执行事务的线程函数"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程 <span class="subst">{thread_id}</span>: 尝试转账 <span class="subst">{amount}</span> 从 <span class="subst">{from_acc}</span> 到 <span class="subst">{to_acc}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    start_time = time.time()</span><br><span class="line">    success = transfer_money(db, from_acc, to_acc, amount)</span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    </span><br><span class="line">    status = <span class="string">"成功"</span> <span class="keyword">if</span> success <span class="keyword">else</span> <span class="string">"失败"</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程 <span class="subst">{thread_id}</span>: 转账<span class="subst">{status}</span>，耗时 <span class="subst">{elapsed:<span class="number">.2</span>f}</span>秒"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库实例</span></span><br><span class="line">db = TwoPhaseLockDatabase()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"初始账户状态: <span class="subst">{db.data}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建并启动多个线程</span></span><br><span class="line">threads = []</span><br><span class="line">transactions = [</span><br><span class="line">    (<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="number">30</span>),  <span class="comment"># 从A转30到B</span></span><br><span class="line">    (<span class="string">"B"</span>, <span class="string">"A"</span>, <span class="number">50</span>),  <span class="comment"># 从B转50到A</span></span><br><span class="line">    (<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="number">20</span>)   <span class="comment"># 从A转20到B</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, (from_acc, to_acc, amount) <span class="keyword">in</span> <span class="built_in">enumerate</span>(transactions):</span><br><span class="line">    t = threading.Thread(</span><br><span class="line">        name=<span class="string">f"Transaction-<span class="subst">{i}</span>"</span>,</span><br><span class="line">        target=run_transaction,</span><br><span class="line">        args=(db, i, from_acc, to_acc, amount)</span><br><span class="line">    )</span><br><span class="line">    threads.append(t)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待所有线程完成</span></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"最终账户状态: <span class="subst">{db.data}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"总金额: <span class="subst">{<span class="built_in">sum</span>(db.data.values())}</span>"</span>)  <span class="comment"># 总金额应该不变</span></span><br></pre></td></tr></tbody></table></figure><h6 id="超时重试模式"><a href="#超时重试模式" class="headerlink" title="超时重试模式"></a>超时重试模式</h6><p>在并发环境中，有时获取锁可能会失败。超时重试模式可以增加获取锁的成功概率，同时避免永久阻塞。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment">### 共享资源</span></span><br><span class="line">resource_value = <span class="number">0</span></span><br><span class="line">resource_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_resource</span>(<span class="params">worker_id, max_retries=<span class="number">3</span></span>):</span><br><span class="line">    <span class="string">"""更新共享资源，使用超时重试模式</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        worker_id: 工作线程ID</span></span><br><span class="line"><span class="string">        max_retries: 最大重试次数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        bool: 是否成功更新</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">global</span> resource_value</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 随机生成操作标识，用于跟踪</span></span><br><span class="line">    operation_id = random.randint(<span class="number">10000</span>, <span class="number">99999</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> [操作:<span class="subst">{operation_id}</span>]: 尝试更新资源"</span>)</span><br><span class="line">    </span><br><span class="line">    retry_count = <span class="number">0</span></span><br><span class="line">    backoff = <span class="number">0.1</span>  <span class="comment"># 初始回退时间</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> retry_count &lt; max_retries:</span><br><span class="line">        <span class="comment"># 尝试获取锁，设置超时时间</span></span><br><span class="line">        <span class="keyword">if</span> resource_lock.acquire(timeout=<span class="number">0.5</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> [操作:<span class="subst">{operation_id}</span>]: 获取到锁，当前值: <span class="subst">{resource_value}</span>"</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 模拟资源更新操作</span></span><br><span class="line">                local_value = resource_value</span><br><span class="line">                <span class="comment"># 随机决定操作时间，有时可能很长</span></span><br><span class="line">                work_time = random.uniform(<span class="number">0.1</span>, <span class="number">1.0</span>)</span><br><span class="line">                time.sleep(work_time)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 更新资源</span></span><br><span class="line">                resource_value = local_value + <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> [操作:<span class="subst">{operation_id}</span>]: 更新成功，新值: <span class="subst">{resource_value}</span>，耗时: <span class="subst">{work_time:<span class="number">.2</span>f}</span>秒"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                <span class="comment"># 释放锁</span></span><br><span class="line">                resource_lock.release()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> [操作:<span class="subst">{operation_id}</span>]: 释放锁"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            retry_count += <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> [操作:<span class="subst">{operation_id}</span>]: 获取锁超时，重试 <span class="subst">{retry_count}</span>/<span class="subst">{max_retries}</span>"</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> retry_count &lt; max_retries:</span><br><span class="line">                <span class="comment"># 使用指数退避策略，每次重试间隔加长</span></span><br><span class="line">                time.sleep(backoff)</span><br><span class="line">                backoff *= <span class="number">2</span>  <span class="comment"># 指数增长</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span> [操作:<span class="subst">{operation_id}</span>]: 达到最大重试次数，放弃操作"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker_thread</span>(<span class="params">worker_id, operations</span>):</span><br><span class="line">    <span class="string">"""工作线程函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        worker_id: 工作线程ID</span></span><br><span class="line"><span class="string">        operations: 要执行的操作次数</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    success_count = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(operations):</span><br><span class="line">        <span class="comment"># 尝试更新资源</span></span><br><span class="line">        <span class="keyword">if</span> update_resource(worker_id):</span><br><span class="line">            success_count += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 线程之间的间隔</span></span><br><span class="line">        time.sleep(random.uniform(<span class="number">0.1</span>, <span class="number">0.5</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"工作线程 <span class="subst">{worker_id}</span>: 完成 <span class="subst">{success_count}</span>/<span class="subst">{operations}</span> 次成功更新"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建多个工作线程</span></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    t = threading.Thread(target=worker_thread, args=(i, <span class="number">3</span>))</span><br><span class="line">    threads.append(t)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line"><span class="comment">### 等待所有线程完成</span></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"最终资源值: <span class="subst">{resource_value}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="多进程与多线程结合的混合模型"><a href="#多进程与多线程结合的混合模型" class="headerlink" title="多进程与多线程结合的混合模型"></a>多进程与多线程结合的混合模型</h5><p>对于复杂应用，常常需要结合多进程和多线程的优势：多进程跨越 GIL 限制利用多核心，每个进程内使用多线程处理 I/O 任务。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">io_task</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="string">"""模拟I/O密集型任务：发送HTTP请求并处理响应"""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(url, timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"线程 <span class="subst">{threading.current_thread().name}</span> 完成请求 <span class="subst">{url}</span>, 状态码: <span class="subst">{response.status_code}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> response.status_code</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"线程 <span class="subst">{threading.current_thread().name}</span> 请求 <span class="subst">{url}</span> 失败: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cpu_task</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""模拟CPU密集型任务：处理CSV数据"""</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 模拟CPU密集型计算</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">        result += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 解析CSV数据</span></span><br><span class="line">    csv_data = StringIO(data)</span><br><span class="line">    reader = csv.reader(csv_data)</span><br><span class="line">    rows = <span class="built_in">list</span>(reader)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程 <span class="subst">{os.getpid()}</span> 处理了 <span class="subst">{<span class="built_in">len</span>(rows)}</span> 行数据"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(rows)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_worker</span>(<span class="params">process_id, urls</span>):</span><br><span class="line">    <span class="string">"""每个进程的工作函数，使用线程池处理I/O任务"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程 <span class="subst">{os.getpid()}</span> (ID: <span class="subst">{process_id}</span>) 启动"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建线程池处理I/O任务</span></span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="comment"># 提交所有URL请求任务到线程池</span></span><br><span class="line">        future_to_url = {executor.submit(io_task, url): url <span class="keyword">for</span> url <span class="keyword">in</span> urls}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 收集结果</span></span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(future_to_url):</span><br><span class="line">            url = future_to_url[future]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                status_code = future.result()</span><br><span class="line">                results.append((url, status_code))</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"处理 <span class="subst">{url}</span> 时出错: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 模拟一些CSV数据处理（CPU密集型任务）</span></span><br><span class="line">    sample_csv = <span class="string">"col1,col2,col3\n1,2,3\n4,5,6\n7,8,9"</span></span><br><span class="line">    cpu_result = cpu_task(sample_csv)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"进程 <span class="subst">{os.getpid()}</span> (ID: <span class="subst">{process_id}</span>) 完成所有任务"</span>)</span><br><span class="line">    <span class="keyword">return</span> results, cpu_result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 测试URL列表</span></span><br><span class="line">    all_urls = [</span><br><span class="line">        <span class="string">f"https://httpbin.org/delay/<span class="subst">{i%<span class="number">3</span>}</span>"</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>)</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将URL分成4组，每个进程处理4个URL</span></span><br><span class="line">    url_chunks = [all_urls[i:i+<span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(all_urls), <span class="number">4</span>)]</span><br><span class="line">    </span><br><span class="line">    start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建进程池</span></span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ProcessPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> process_executor:</span><br><span class="line">        <span class="comment"># 提交任务到进程池</span></span><br><span class="line">        futures = [process_executor.submit(process_worker, i, urls) </span><br><span class="line">                  <span class="keyword">for</span> i, urls <span class="keyword">in</span> <span class="built_in">enumerate</span>(url_chunks)]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 收集所有进程的结果</span></span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(futures):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                io_results, cpu_result = future.result()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"进程返回结果: <span class="subst">{<span class="built_in">len</span>(io_results)}</span> 个URL请求, CPU任务处理了 <span class="subst">{cpu_result}</span> 行数据"</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"进程执行出错: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    elapsed_time = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"总执行时间: <span class="subst">{elapsed_time:<span class="number">.2</span>f}</span> 秒"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>这种混合模型充分利用了 Python 的并发性能：</p><ol><li><strong>多进程并行</strong>：跨越 GIL 限制，在多个 CPU 核心上同时执行 Python 代码</li><li><strong>每进程多线程</strong>：处理进程内的 I/O 密集型任务，提高 I/O 并发性</li><li><strong>任务队列</strong>：有效分配和管理工作负载，平衡资源利用</li></ol><h5 id="细粒度锁与粗粒度锁"><a href="#细粒度锁与粗粒度锁" class="headerlink" title="细粒度锁与粗粒度锁"></a>细粒度锁与粗粒度锁</h5><p>锁的粒度指锁保护资源的范围大小。细粒度锁保护小范围资源，提高并发度；粗粒度锁保护大范围资源，简化编程但可能降低并发度。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 共享资源</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BankAccount</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, balance</span>):</span><br><span class="line">        <span class="variable language_">self</span>.balance = balance</span><br><span class="line">        <span class="comment"># 粗粒度锁 - 用于整个账户操作</span></span><br><span class="line">        <span class="variable language_">self</span>.coarse_lock = threading.Lock()</span><br><span class="line">        <span class="comment"># 细粒度锁 - 分别用于读取和写入操作</span></span><br><span class="line">        <span class="variable language_">self</span>.read_lock = threading.Lock()</span><br><span class="line">        <span class="variable language_">self</span>.write_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 粗粒度锁示例 - 锁定整个账户操作</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transfer_coarse</span>(<span class="params">account, amount</span>):</span><br><span class="line">    <span class="keyword">with</span> account.coarse_lock:</span><br><span class="line">        <span class="comment"># 模拟读取余额操作</span></span><br><span class="line">        current_balance = account.balance</span><br><span class="line">        <span class="comment"># 模拟网络延迟或处理时间</span></span><br><span class="line">        time.sleep(random.uniform(<span class="number">0.001</span>, <span class="number">0.005</span>))</span><br><span class="line">        <span class="comment"># 模拟更新余额操作</span></span><br><span class="line">        account.balance = current_balance + amount</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"粗粒度锁: 转账 <span class="subst">{amount}</span>，当前余额 <span class="subst">{account.balance}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 细粒度锁示例 - 分别锁定读取和写入操作</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transfer_fine</span>(<span class="params">account, amount</span>):</span><br><span class="line">    <span class="comment"># 锁定读取操作</span></span><br><span class="line">    <span class="keyword">with</span> account.read_lock:</span><br><span class="line">        current_balance = account.balance</span><br><span class="line">        <span class="comment"># 模拟处理时间</span></span><br><span class="line">        time.sleep(random.uniform(<span class="number">0.001</span>, <span class="number">0.005</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里可以执行一些不需要锁定的计算</span></span><br><span class="line">    time.sleep(random.uniform(<span class="number">0.001</span>, <span class="number">0.002</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 锁定写入操作</span></span><br><span class="line">    <span class="keyword">with</span> account.write_lock:</span><br><span class="line">        account.balance = current_balance + amount</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"细粒度锁: 转账 <span class="subst">{amount}</span>，当前余额 <span class="subst">{account.balance}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 创建共享账户</span></span><br><span class="line">    account = BankAccount(<span class="number">1000</span>)</span><br><span class="line">    threads = []</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"=== 测试粗粒度锁 ==="</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建10个使用粗粒度锁的线程</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        amount = random.randint(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">        t = threading.Thread(target=transfer_coarse, args=(account, amount))</span><br><span class="line">        threads.append(t)</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待所有线程完成</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line">    coarse_time = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"粗粒度锁总耗时: <span class="subst">{coarse_time:<span class="number">.4</span>f}</span>秒"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重置账户和线程列表</span></span><br><span class="line">    account.balance = <span class="number">1000</span></span><br><span class="line">    threads = []</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n=== 测试细粒度锁 ==="</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建10个使用细粒度锁的线程</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        amount = random.randint(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">        t = threading.Thread(target=transfer_fine, args=(account, amount))</span><br><span class="line">        threads.append(t)</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待所有线程完成</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line">    fine_time = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"细粒度锁总耗时: <span class="subst">{fine_time:<span class="number">.4</span>f}</span>秒"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n性能比较: 细粒度锁比粗粒度锁快 <span class="subst">{(coarse_time / fine_time):<span class="number">.2</span>f}</span> 倍"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>锁粒度</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>粗粒度锁</td><td>简单、易维护、不易死锁</td><td>并发性能低、可能导致线程等待</td><td>简单应用、对性能要求不高的场景</td></tr><tr><td>细粒度锁</td><td>并发性能高、资源利用率高</td><td>实现复杂、可能造成死锁</td><td>高性能要求、资源访问模式明确的场景</td></tr></tbody></table><h3 id="14-7-消息队列与进程通信"><a href="#14-7-消息队列与进程通信" class="headerlink" title="14.7 消息队列与进程通信"></a>14.7 消息队列与进程通信</h3><p>在并发编程中，队列是一种常用的数据结构。它遵循 <strong>先进先出（FIFO）</strong> 的原则，适合用于线程或进程间的通信，而堆栈则遵循 <strong>后进先出（LIFO）</strong> 的原则。Python 中的 <code>queue</code> 和 <code>multiprocessing</code> 模块提供了多种类型的队列，每种队列适用于不同的场景。</p><h4 id="队列基础知识"><a href="#队列基础知识" class="headerlink" title="队列基础知识"></a>队列基础知识</h4><p>Python 的 <code>queue</code> 模块和 <code>multiprocessing</code> 模块提供了多种队列类型，主要包括：</p><table><thead><tr><th>队列类型</th><th>模块</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td>Queue</td><td>queue</td><td>线程安全的 FIFO 队列</td><td>线程间通信</td></tr><tr><td>LifoQueue</td><td>queue</td><td>线程安全的 LIFO 队列(堆栈)</td><td>需要后进先出的场景</td></tr><tr><td>PriorityQueue</td><td>queue</td><td>优先级队列</td><td>任务具有优先级的场景</td></tr><tr><td>Queue</td><td>multiprocessing</td><td>进程安全的 FIFO 队列</td><td>进程间通信</td></tr><tr><td>JoinableQueue</td><td>multiprocessing</td><td>带有任务完成通知机制的队列</td><td>生产者-消费者模型</td></tr></tbody></table><h4 id="队列使用示例"><a href="#队列使用示例" class="headerlink" title="队列使用示例"></a>队列使用示例</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生产者进程函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">producer</span>(<span class="params">q: Queue</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""生产者函数，负责生产数据并放入队列"""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        item = <span class="string">f"小吃<span class="subst">{i}</span>"</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"生产者生产了<span class="subst">{item}</span>"</span>)</span><br><span class="line">        q.put(item)  <span class="comment"># 放入队列</span></span><br><span class="line">        time.sleep(random.uniform(<span class="number">0.1</span>, <span class="number">0.5</span>))  <span class="comment"># 模拟耗时操作</span></span><br><span class="line">    q.put(<span class="literal">None</span>)  <span class="comment"># 生产结束信号</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"生产者结束"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 消费者进程函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consumer</span>(<span class="params">q: Queue</span>):</span><br><span class="line">    <span class="string">"""消费者函数，负责从队列中获取数据并消费"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        item = q.get()  <span class="comment"># 从队列中获取项目</span></span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">is</span> <span class="literal">None</span>:  <span class="comment"># 若获取到结束信号，则退出循环</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"消费者消费了<span class="subst">{item}</span>"</span>)</span><br><span class="line">        time.sleep(random.uniform(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"消费者结束"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 创建一个队列对象</span></span><br><span class="line">    q = Queue()</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">2</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="comment"># 启动生产者进程</span></span><br><span class="line">        executor.submit(producer, q)</span><br><span class="line">        <span class="comment"># 启动消费者进程</span></span><br><span class="line">        executor.submit(consumer, q)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="优先级队列示例"><a href="#优先级队列示例" class="headerlink" title="优先级队列示例"></a>优先级队列示例</h4><p>优先级队列按任务的优先级顺序处理任务。数字越小优先级越高。以下是如何使用 <code>PriorityQueue</code> 的示例：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建优先级队列</span></span><br><span class="line"><span class="comment"># 优先级队列的元素是元组，第一个元素是优先级，第二个元素是任务</span></span><br><span class="line">pq = queue.PriorityQueue()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_tasks</span>():</span><br><span class="line">    <span class="string">"""按照优先级处理任务"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            priority,task = pq.get(timeout=<span class="number">3</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"处理任务:[优先级<span class="subst">{priority}</span>] <span class="subst">{task}</span>"</span>)</span><br><span class="line">            pq.task_done()</span><br><span class="line">        <span class="keyword">except</span> queue.Empty:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"队列为空，任务处理完毕"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 添加任务到优先级队列</span></span><br><span class="line">pq.put((<span class="number">3</span>, <span class="string">"普通任务"</span>))</span><br><span class="line">pq.put((<span class="number">1</span>, <span class="string">"紧急任务"</span>))</span><br><span class="line">pq.put((<span class="number">2</span>, <span class="string">"中等优先级任务"</span>))</span><br><span class="line">pq.put((<span class="number">1</span>, <span class="string">"另一个紧急任务"</span>))</span><br><span class="line">pq.put((<span class="number">5</span>, <span class="string">"低优先级任务"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建任务处理线程</span></span><br><span class="line">worker = threading.Thread(target=process_tasks)</span><br><span class="line">worker.start()</span><br><span class="line"></span><br><span class="line">pq.join()  <span class="comment"># 等待所有任务处理完毕</span></span><br><span class="line">worker.join()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"所有任务处理完毕"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/16/684f747174bc3.webp" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/16/684f747174bc3.webp" title="头像" alt="头像"></a><div class="post-copyright__author_name">Prorise</div><div class="post-copyright__author_desc">这聒噪的世界让沉默的人显得另类</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://prorise-cool.github.io/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl(&quot;https://prorise-cool.github.io/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/&quot;)">Python教程：Python知识点前篇速览</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/bYMH/418X445/ef9a3f68-d36a-441a-95fe-8179b1a25992.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/bYMH/418X445/ef9a3f68-d36a-441a-95fe-8179b1a25992.png" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/cYu3/347X390/zfb.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/cYu3/347X390/zfb.png" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display:none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://prorise-cool.github.io/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Python教程：Python知识点前篇速览&amp;url=https://prorise-cool.github.io/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/&amp;pic=https://bu.dusays.com/2025/06/17/685113b7c39b1.webp" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Prorise-cool.github.io" target="_blank">格物致知</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Python/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>Python<span class="tagsPageCount">3</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2025/06/17/685113b7c7d81.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c5e0c.webp" onerror="onerror=null,src=&quot;/img/404.jpg&quot;" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Python教程：深入其境</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/" title="Python教程：深入其境"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c5e0c.webp" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-06-18</div><div class="title">Python教程：深入其境</div></div></a></div><div><a href="/2025/06/19/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%8B%E7%AF%87/" title="Python教程：应用之巅"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c7d81.webp" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-06-19</div><div class="title">Python教程：应用之巅</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" rel="external nofollow noreferrer">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Waline</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/16/684f747174bc3.webp" onerror="this.onerror=null,this.src=&quot;/img/friend_404.gif&quot;" alt="avatar"><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/user/status.png" alt="status"></div></div><div class="author-info__description"><div style="line-height:1.4;color:rgba(255,255,255,.9);text-align:center">🚀 全栈开发者，专注于构建优雅高效的数字解决方案<br><span style="color:#fff;font-weight:700">前端 · 后端 · 架构 · 优化</span><br>📚 分享实战经验，一起探索技术边界</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Prorise</h1><div class="author-info__desc">这聒噪的世界让沉默的人显得另类</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/361040115?spm_id_from=333.1387.0.0" rel="external nofollow noreferrer" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background:url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center/100% no-repeat"></div><div class="back face" style="background:url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center/100% no-repeat"></div></div></div></div><div class="card-widget card-latest-comments"><div class="item-headline"><i class="fas fa-comments"></i><span>最新评论</span></div><div class="item-content"><a href="/messages/" class="headline-right" title="查看更多"><i class="fas fa-angle-right"></i></a><div class="aside-list" id="latest-comments"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Python-%E8%AF%AD%E8%A8%80%E7%89%B9%E6%80%A7"><span class="toc-number">1.</span> <span class="toc-text">Python 语言特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%9E%8B-vs-%E8%A7%A3%E9%87%8A%E5%9E%8B"><span class="toc-number">1.1.</span> <span class="toc-text">编译型 vs 解释型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%BA%E7%B1%BB%E5%9E%8B-vs-%E5%BC%B1%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">强类型 vs 弱类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%9E%8B-vs-%E9%9D%99%E6%80%81%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text">动态型 vs 静态型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E6%8F%90%E7%A4%BA"><span class="toc-number">1.4.</span> <span class="toc-text">类型提示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0%EF%BC%9A%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%89%93%E5%8D%B0%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%8EPyCharm%E6%A8%A1%E6%9D%BF%E5%8F%98%E9%87%8F"><span class="toc-number">2.</span> <span class="toc-text">第一章：字符串打印格式化与PyCharm模板变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%89%93%E5%8D%B0%E6%A0%BC%E5%BC%8F%E5%8C%96-ANSI-%E8%BD%AC%E4%B9%89%E5%BA%8F%E5%88%97"><span class="toc-number">2.1.</span> <span class="toc-text">字符串打印格式化 (ANSI 转义序列)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">2.1.1.</span> <span class="toc-text">基本语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ANSI-%E8%BD%AC%E4%B9%89%E7%A0%81%E8%A1%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">ANSI 转义码表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.1.3.</span> <span class="toc-text">实用示例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E9%A2%9C%E8%89%B2%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">基本颜色设置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%84%E5%90%88%E4%BD%BF%E7%94%A8"><span class="toc-number">2.1.3.2.</span> <span class="toc-text">组合使用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-%E5%B0%81%E8%A3%85%E4%B8%BA-print-utils-py-%E5%B7%A5%E5%85%B7%E6%A8%A1%E5%9D%97"><span class="toc-number">2.1.4.</span> <span class="toc-text">实际应用场景 (封装为 print_utils.py 工具模块)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PyCharm-Live-Templates-%E6%8F%90%E5%8D%87%E7%BC%96%E7%A0%81%E6%95%88%E7%8E%87"><span class="toc-number">2.2.</span> <span class="toc-text">PyCharm Live Templates 提升编码效率</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E5%BE%AA%E7%8E%AF"><span class="toc-number">2.2.1.</span> <span class="toc-text">1. 基本循环</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a-for-in-%E5%BE%AA%E7%8E%AF-%E9%81%8D%E5%8E%86%E5%BA%8F%E5%88%97"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">a. for...in 循环 (遍历序列)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b-for-in-enumerate-%E5%BE%AA%E7%8E%AF-%E5%B8%A6%E7%B4%A2%E5%BC%95%E9%81%8D%E5%8E%86"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">b. for...in enumerate 循环 (带索引遍历)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#c-for-in-range-%E5%BE%AA%E7%8E%AF-%E6%8C%89%E6%AC%A1%E6%95%B0"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">c. for...in range 循环 (按次数)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD"><span class="toc-number">2.2.2.</span> <span class="toc-text">2. 条件判断</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a-if-%E8%AF%AD%E5%8F%A5"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">a. if 语句</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b-if-else-%E8%AF%AD%E5%8F%A5"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">b. if-else 语句</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#c-if-elif-else-%E8%AF%AD%E5%8F%A5"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">c. if-elif-else 语句</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%89%93%E5%8D%B0%E4%B8%8E%E6%97%A5%E5%BF%97"><span class="toc-number">2.2.3.</span> <span class="toc-text">3. 打印与日志</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a-print-f-f-string-%E6%89%93%E5%8D%B0"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">a. print(f"...") (f-string 打印)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b-logger-info-%E5%BF%AB%E9%80%9F%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95-%E5%81%87%E8%AE%BE-logger-%E5%AF%B9%E8%B1%A1%E5%B7%B2%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">b. logger.info (快速日志记录 - 假设 logger 对象已配置)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-Python-%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AE%9A%E4%B9%89"><span class="toc-number">2.2.4.</span> <span class="toc-text">4. Python 结构与定义</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#c-%E7%B1%BB%E5%AE%9A%E4%B9%89-%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">c. 类定义 (基本结构)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#d-dataclass-%E7%B1%BB%E5%AE%9A%E4%B9%89"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">d. @dataclass 类定义</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">2.2.5.</span> <span class="toc-text">5. 异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a-try-except-%E5%9F%BA%E6%9C%AC%E5%9D%97"><span class="toc-number">2.2.5.1.</span> <span class="toc-text">a. try-except 基本块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b-try-except-else-finally-%E5%AE%8C%E6%95%B4%E5%9D%97"><span class="toc-number">2.2.5.2.</span> <span class="toc-text">b. try-except-else-finally 完整块</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">2.2.6.</span> <span class="toc-text">6. 文件操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a-with-open-%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">2.2.6.1.</span> <span class="toc-text">a. with open(...) 上下文管理器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E6%8E%A8%E5%AF%BC%E5%BC%8F"><span class="toc-number">2.2.7.</span> <span class="toc-text">7. 推导式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a-%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%BC%8F-List-Comprehension"><span class="toc-number">2.2.7.1.</span> <span class="toc-text">a. 列表推导式 (List Comprehension)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b-%E5%AD%97%E5%85%B8%E6%8E%A8%E5%AF%BC%E5%BC%8F-Dictionary-Comprehension"><span class="toc-number">2.2.7.2.</span> <span class="toc-text">b. 字典推导式 (Dictionary Comprehension)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E5%85%B6%E4%BB%96"><span class="toc-number">2.2.8.</span> <span class="toc-text">8. 其他</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a-lambda-%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.8.1.</span> <span class="toc-text">a. lambda 匿名函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#b-%E6%B3%A8%E9%87%8A%E6%A0%87%E8%AE%B0"><span class="toc-number">2.2.8.2.</span> <span class="toc-text">b. 注释标记</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A%E8%BD%AC%E4%B9%89%E5%AD%97%E7%AC%A6"><span class="toc-number">3.</span> <span class="toc-text">第二章：转义字符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0%EF%BC%9A%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">4.</span> <span class="toc-text">第三章：运算符</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%AE%97%E7%AC%A6%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">4.1.</span> <span class="toc-text">运算符优先级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%AE%97%E7%AC%A6%E8%A1%A8"><span class="toc-number">4.2.</span> <span class="toc-text">运算符表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%8B%E5%80%BC%E6%8A%80%E5%B7%A7"><span class="toc-number">4.3.</span> <span class="toc-text">赋值技巧</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0%EF%BC%9A%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E8%AF%A6%E8%A7%A3"><span class="toc-number">5.</span> <span class="toc-text">第四章：类型转换详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="toc-number">5.1.</span> <span class="toc-text">4.1 基本数据类型转换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E5%9E%8B%E8%BD%AC%E6%8D%A2-int"><span class="toc-number">5.1.1.</span> <span class="toc-text">整型转换 int()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%AE%E7%82%B9%E5%9E%8B%E8%BD%AC%E6%8D%A2-float"><span class="toc-number">5.1.2.</span> <span class="toc-text">浮点型转换 float()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E6%8D%A2-str"><span class="toc-number">5.1.3.</span> <span class="toc-text">字符串转换 str()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E5%80%BC%E8%BD%AC%E6%8D%A2-bool"><span class="toc-number">5.1.4.</span> <span class="toc-text">布尔值转换 bool()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="toc-number">5.2.</span> <span class="toc-text">4.2 集合类型转换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%97%E8%A1%A8%E8%BD%AC%E6%8D%A2-list"><span class="toc-number">5.2.1.</span> <span class="toc-text">列表转换 list()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%83%E7%BB%84%E8%BD%AC%E6%8D%A2-tuple"><span class="toc-number">5.2.2.</span> <span class="toc-text">元组转换 tuple()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E8%BD%AC%E6%8D%A2-set"><span class="toc-number">5.2.3.</span> <span class="toc-text">集合转换 set()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E5%85%B8%E8%BD%AC%E6%8D%A2-dict"><span class="toc-number">5.2.4.</span> <span class="toc-text">字典转换 dict()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E8%BF%9B%E9%98%B6%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="toc-number">5.3.</span> <span class="toc-text">4.3 进阶类型转换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%BD%AC%E6%8D%A2-bytes-%E5%92%8C-bytearray"><span class="toc-number">5.3.1.</span> <span class="toc-text">字节转换 bytes() 和 bytearray()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E5%AE%9E%E7%94%A8%E8%BD%AC%E6%8D%A2%E5%9C%BA%E6%99%AF%E4%B8%8E%E6%8A%80%E5%B7%A7"><span class="toc-number">5.4.</span> <span class="toc-text">4.4 实用转换场景与技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E5%AD%97%E5%92%8C%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B9%8B%E9%97%B4%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="toc-number">5.4.1.</span> <span class="toc-text">数字和字符串之间的转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%B5%8B%E4%B8%8E%E5%AE%89%E5%85%A8%E8%BD%AC%E6%8D%A2"><span class="toc-number">5.4.2.</span> <span class="toc-text">数据类型检测与安全转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E4%B8%8E%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81"><span class="toc-number">5.4.3.</span> <span class="toc-text">类型转换与数据验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E9%99%B7%E9%98%B1%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">5.5.</span> <span class="toc-text">4.5 类型转换陷阱与最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1"><span class="toc-number">5.5.1.</span> <span class="toc-text">常见陷阱</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0%EF%BC%9A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.</span> <span class="toc-text">第五章：数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B-str"><span class="toc-number">6.1.</span> <span class="toc-text">5.1 字符串类型(str)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BE%93%E5%87%BA%E6%96%B9%E5%BC%8F"><span class="toc-number">6.1.1.</span> <span class="toc-text">字符串输出方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.2.</span> <span class="toc-text">字符串常用方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%88%97%E8%A1%A8%E7%B1%BB%E5%9E%8B-list"><span class="toc-number">6.2.</span> <span class="toc-text">5.2 列表类型(list)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%85%83%E7%B4%A0"><span class="toc-number">6.2.1.</span> <span class="toc-text">添加元素</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%85%83%E7%B4%A0"><span class="toc-number">6.2.2.</span> <span class="toc-text">删除元素</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E5%85%83%E7%B4%A0"><span class="toc-number">6.2.3.</span> <span class="toc-text">查找元素</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F"><span class="toc-number">6.2.4.</span> <span class="toc-text">排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%B5%8C%E5%A5%97%E5%88%97%E8%A1%A8"><span class="toc-number">6.2.5.</span> <span class="toc-text">访问嵌套列表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E5%85%83%E7%BB%84%E7%B1%BB%E5%9E%8B-tuple"><span class="toc-number">6.3.</span> <span class="toc-text">5.3 元组类型(tuple)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%83%E7%BB%84%E7%9A%84%E5%88%9B%E5%BB%BA%E6%96%B9%E5%BC%8F"><span class="toc-number">6.3.1.</span> <span class="toc-text">元组的创建方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%83%E7%BB%84%E7%9A%84%E7%89%B9%E6%80%A7%E4%B8%8E%E6%93%8D%E4%BD%9C"><span class="toc-number">6.3.2.</span> <span class="toc-text">元组的特性与操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%80%A7"><span class="toc-number">6.3.2.1.</span> <span class="toc-text">不可变性</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E4%B8%8E%E5%88%87%E7%89%87"><span class="toc-number">6.3.3.</span> <span class="toc-text">访问与切片</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%83%E7%BB%84%E8%A7%A3%E5%8C%85"><span class="toc-number">6.3.4.</span> <span class="toc-text">元组解包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%83%E7%BB%84%E6%96%B9%E6%B3%95%E5%92%8C%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="toc-number">6.3.5.</span> <span class="toc-text">元组方法和内置函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%83%E7%BB%84%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">6.3.6.</span> <span class="toc-text">元组的应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E4%B8%BA%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">6.3.6.1.</span> <span class="toc-text">作为函数的返回值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E4%B8%BA%E4%B8%8D%E5%8F%AF%E5%8F%98%E9%9B%86%E5%90%88"><span class="toc-number">6.3.6.2.</span> <span class="toc-text">作为不可变集合</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A1%AE%E4%BF%9D%E6%95%B0%E6%8D%AE%E4%B8%8D%E8%A2%AB%E4%BF%AE%E6%94%B9"><span class="toc-number">6.3.6.3.</span> <span class="toc-text">确保数据不被修改</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#postchat_postcontent"><span class="toc-number">6.3.6.4.</span> <span class="toc-text"></span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E5%AD%97%E5%85%B8%E7%B1%BB%E5%9E%8B-dict"><span class="toc-number">6.4.</span> <span class="toc-text">5.4 字典类型(dict)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E5%85%B8%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">6.4.1.</span> <span class="toc-text">字典常用方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B-set"><span class="toc-number">6.5.</span> <span class="toc-text">5.5 集合类型(set)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C"><span class="toc-number">6.5.1.</span> <span class="toc-text">集合操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0%EF%BC%9A%E6%9D%A1%E4%BB%B6%E5%BE%AA%E7%8E%AF%E5%88%86%E6%94%AF"><span class="toc-number">7.</span> <span class="toc-text">第六章：条件循环分支</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5%E7%9A%84%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95"><span class="toc-number">7.1.</span> <span class="toc-text">条件语句的高级用法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE%E5%BC%8F%E6%AF%94%E8%BE%83"><span class="toc-number">7.1.1.</span> <span class="toc-text">链式比较</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%AD%E8%B7%AF%E9%80%BB%E8%BE%91%E8%AF%84%E4%BC%B0"><span class="toc-number">7.1.2.</span> <span class="toc-text">短路逻辑评估</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%B5%8C%E5%A5%97"><span class="toc-number">7.1.3.</span> <span class="toc-text">条件表达式的嵌套</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D%EF%BC%88Python-3-10-%EF%BC%89"><span class="toc-number">7.1.4.</span> <span class="toc-text">模式匹配（Python 3.10+）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E7%9A%84%E9%AB%98%E7%BA%A7%E6%8A%80%E5%B7%A7"><span class="toc-number">7.2.</span> <span class="toc-text">循环的高级技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E4%B8%8E%E8%BF%AD%E4%BB%A3%E5%99%A8%E5%8D%8F%E8%AE%AE"><span class="toc-number">7.2.1.</span> <span class="toc-text">循环与迭代器协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%BB%A3%E6%9B%BF%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%BC%8F"><span class="toc-number">7.2.2.</span> <span class="toc-text">生成器表达式代替列表推导式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-enumerate-%E8%8E%B7%E5%8F%96%E7%B4%A2%E5%BC%95"><span class="toc-number">7.2.3.</span> <span class="toc-text">使用 enumerate 获取索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B6%E8%A1%8C%E8%BF%AD%E4%BB%A3%E5%A4%9A%E4%B8%AA%E5%BA%8F%E5%88%97"><span class="toc-number">7.2.4.</span> <span class="toc-text">并行迭代多个序列</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E7%9A%84%E9%AB%98%E7%BA%A7%E6%A8%A1%E5%BC%8F"><span class="toc-number">7.3.</span> <span class="toc-text">流程控制的高级模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B5%8C%E5%A5%97%E5%BE%AA%E7%8E%AF%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">7.3.1.</span> <span class="toc-text">嵌套循环的优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%92%E5%BD%92%E4%B8%8E%E5%BE%AA%E7%8E%AF"><span class="toc-number">7.3.2.</span> <span class="toc-text">递归与循环</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0%EF%BC%9A-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">8.</span> <span class="toc-text">第七章： 文件操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E6%96%87%E4%BB%B6%E6%89%93%E5%BC%80%E6%A8%A1%E5%BC%8F"><span class="toc-number">8.1.</span> <span class="toc-text">7.1 文件打开模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%9F%BA%E6%9C%AC%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">8.2.</span> <span class="toc-text">7.2 基本文件操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-1-%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%93%8D%E4%BD%9C"><span class="toc-number">8.2.1.</span> <span class="toc-text">7.2.1 文件读取操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-2-%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E6%93%8D%E4%BD%9C"><span class="toc-number">8.2.2.</span> <span class="toc-text">7.2.2 文件写入操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-3-%E5%A4%9A%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">8.2.3.</span> <span class="toc-text">7.2.3 多文件操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-4-%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9%E7%A4%BA%E4%BE%8B"><span class="toc-number">8.2.4.</span> <span class="toc-text">7.2.4 文件修改示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E6%96%87%E4%BB%B6%E6%8C%87%E9%92%88%E6%8E%A7%E5%88%B6"><span class="toc-number">8.3.</span> <span class="toc-text">7.3 文件指针控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-1-seek-%E5%92%8C-tell-%E5%87%BD%E6%95%B0"><span class="toc-number">8.3.1.</span> <span class="toc-text">7.3.1 seek() 和 tell() 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-2-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">8.3.2.</span> <span class="toc-text">7.3.2 实际应用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E7%BC%93%E5%86%B2%E5%8C%BA%E7%AE%A1%E7%90%86"><span class="toc-number">8.4.</span> <span class="toc-text">7.4 缓冲区管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-4-1-%E7%BC%93%E5%86%B2%E8%AE%BE%E7%BD%AE%E4%B8%8E%E5%88%B7%E6%96%B0"><span class="toc-number">8.4.1.</span> <span class="toc-text">7.4.1 缓冲设置与刷新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-4-2-%E7%BC%93%E5%86%B2%E5%8C%BA%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="toc-number">8.4.2.</span> <span class="toc-text">7.4.2 缓冲区触发条件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%E6%93%8D%E4%BD%9C"><span class="toc-number">8.5.</span> <span class="toc-text">7.5 文件路径操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-5-1-%E4%BD%BF%E7%94%A8-os-path-%E6%A8%A1%E5%9D%97"><span class="toc-number">8.5.1.</span> <span class="toc-text">7.5.1 使用 os.path 模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-5-2-%E4%BD%BF%E7%94%A8-pathlib-%E6%A8%A1%E5%9D%97-Python-3-4"><span class="toc-number">8.5.2.</span> <span class="toc-text">7.5.2 使用 pathlib 模块 (Python 3.4+)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-%E9%AB%98%E7%BA%A7%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">8.6.</span> <span class="toc-text">7.6 高级文件操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-6-1-%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">8.6.1.</span> <span class="toc-text">7.6.1 二进制文件操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-6-2-%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">8.6.2.</span> <span class="toc-text">7.6.2 临时文件操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C"><span class="toc-number">8.7.</span> <span class="toc-text">7.7 目录操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-7-1-%E5%9F%BA%E6%9C%AC%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C"><span class="toc-number">8.7.1.</span> <span class="toc-text">7.7.1 基本目录操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-7-2-%E4%BD%BF%E7%94%A8-pathlib-%E8%BF%9B%E8%A1%8C%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C"><span class="toc-number">8.7.2.</span> <span class="toc-text">7.7.2 使用 pathlib 进行目录操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-7-3-%E9%80%92%E5%BD%92%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95%E6%A0%91"><span class="toc-number">8.7.3.</span> <span class="toc-text">7.7.3 递归遍历目录树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-7-4-%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E3%80%81%E7%A7%BB%E5%8A%A8%E5%92%8C%E5%88%A0%E9%99%A4%E6%93%8D%E4%BD%9C"><span class="toc-number">8.7.4.</span> <span class="toc-text">7.7.4 文件复制、移动和删除操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-8-%E6%96%87%E4%BB%B6%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%8F%98%E6%9B%B4%E6%A3%80%E6%B5%8B"><span class="toc-number">8.8.</span> <span class="toc-text">7.8 文件监控与变更检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-8-1-%E5%9F%BA%E7%A1%80%E6%96%87%E4%BB%B6%E7%9B%91%E6%8E%A7"><span class="toc-number">8.8.1.</span> <span class="toc-text">7.8.1 基础文件监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-8-2-%E4%BD%BF%E7%94%A8-watchdog-%E5%BA%93%E8%BF%9B%E8%A1%8C%E9%AB%98%E7%BA%A7%E6%96%87%E4%BB%B6%E7%9B%91%E6%8E%A7"><span class="toc-number">8.8.2.</span> <span class="toc-text">7.8.2 使用 watchdog 库进行高级文件监控</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-9-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%E7%A4%BA%E4%BE%8B"><span class="toc-number">8.9.</span> <span class="toc-text">7.9 实际应用场景示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-9-1-%E6%96%87%E4%BB%B6%E5%A4%87%E4%BB%BD%E5%B7%A5%E5%85%B7"><span class="toc-number">8.9.1.</span> <span class="toc-text">7.9.1 文件备份工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-9-2-%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="toc-number">8.9.2.</span> <span class="toc-text">7.9.2 日志分析工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-9-3-%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7"><span class="toc-number">8.9.3.</span> <span class="toc-text">7.9.3 文件同步工具</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0%EF%BC%9A-%E5%87%BD%E6%95%B0%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93"><span class="toc-number">9.</span> <span class="toc-text">第八章： 函数知识总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="toc-number">9.1.</span> <span class="toc-text">8.1 内置函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E5%AD%A6%E5%92%8C%E6%95%B0%E5%80%BC%E8%AE%A1%E7%AE%97"><span class="toc-number">9.1.1.</span> <span class="toc-text">数学和数值计算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2"><span class="toc-number">9.1.2.</span> <span class="toc-text">进制转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81"><span class="toc-number">9.1.3.</span> <span class="toc-text">字符编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E5%87%BD%E6%95%B0"><span class="toc-number">9.1.4.</span> <span class="toc-text">反射函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%B8%B8%E7%94%A8%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="toc-number">9.1.5.</span> <span class="toc-text">其他常用内置函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%E4%B8%8E%E8%B0%83%E7%94%A8"><span class="toc-number">9.2.</span> <span class="toc-text">8.2 函数定义与调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0"><span class="toc-number">9.3.</span> <span class="toc-text">8.3 函数参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="toc-number">9.3.1.</span> <span class="toc-text">位置参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%82%E6%95%B0"><span class="toc-number">9.3.2.</span> <span class="toc-text">关键字参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0"><span class="toc-number">9.3.3.</span> <span class="toc-text">默认参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0"><span class="toc-number">9.3.4.</span> <span class="toc-text">可变参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%8E%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">9.4.</span> <span class="toc-text">8.4 作用域与命名空间</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4"><span class="toc-number">9.4.1.</span> <span class="toc-text">名称空间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LEGB-%E8%A7%84%E5%88%99"><span class="toc-number">9.4.2.</span> <span class="toc-text">LEGB 规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%BF%AE%E9%A5%B0"><span class="toc-number">9.4.3.</span> <span class="toc-text">作用域修饰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0%E7%89%B9%E6%80%A7"><span class="toc-number">9.5.</span> <span class="toc-text">8.5 高阶函数特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92"><span class="toc-number">9.5.1.</span> <span class="toc-text">函数作为参数传递</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E4%BD%9C%E4%B8%BA%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">9.5.2.</span> <span class="toc-text">函数作为返回值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%AD%98%E5%82%A8%E5%9C%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%AD"><span class="toc-number">9.5.3.</span> <span class="toc-text">函数存储在数据结构中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">9.5.4.</span> <span class="toc-text">高阶函数设计模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F"><span class="toc-number">9.5.5.</span> <span class="toc-text">函数组合模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E5%BA%94%E7%94%A8"><span class="toc-number">9.5.6.</span> <span class="toc-text">部分应用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0-lambda"><span class="toc-number">9.6.</span> <span class="toc-text">8.6 匿名函数(lambda)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-7-%E9%97%AD%E5%8C%85%E5%87%BD%E6%95%B0"><span class="toc-number">9.7.</span> <span class="toc-text">8.7 闭包函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-8-%E9%80%92%E5%BD%92%E5%87%BD%E6%95%B0"><span class="toc-number">9.8.</span> <span class="toc-text">8.8 递归函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%92%E5%BD%92%E7%9A%84%E5%85%B3%E9%94%AE%E8%A6%81%E7%B4%A0"><span class="toc-number">9.8.1.</span> <span class="toc-text">递归的关键要素</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%92%E5%BD%92%E6%B7%B1%E5%BA%A6%E9%99%90%E5%88%B6"><span class="toc-number">9.8.2.</span> <span class="toc-text">递归深度限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%92%E5%BD%92%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%88%97%E8%A1%A8%E6%89%81%E5%B9%B3%E5%8C%96"><span class="toc-number">9.8.3.</span> <span class="toc-text">递归案例：列表扁平化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1"><span class="toc-number">9.8.4.</span> <span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-9-%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">9.9.</span> <span class="toc-text">8.9 装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">9.9.1.</span> <span class="toc-text">基本装饰器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%A6%E5%8F%82%E6%95%B0%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">9.9.2.</span> <span class="toc-text">带参数的装饰器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E7%95%99%E5%8E%9F%E5%87%BD%E6%95%B0%E5%85%83%E6%95%B0%E6%8D%AE"><span class="toc-number">9.9.3.</span> <span class="toc-text">保留原函数元数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A3%85%E9%A5%B0%E5%99%A8%E5%8F%A0%E5%8A%A0"><span class="toc-number">9.9.4.</span> <span class="toc-text">装饰器叠加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A3%85%E9%A5%B0%E5%99%A8%E5%B7%A5%E5%8E%82"><span class="toc-number">9.9.5.</span> <span class="toc-text">装饰器工厂</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0%EF%BC%9A%E8%BF%AD%E4%BB%A3%E5%99%A8%E3%80%81%E7%94%9F%E6%88%90%E5%99%A8%E4%B8%8E%E6%8E%A8%E5%AF%BC%E5%BC%8F"><span class="toc-number">10.</span> <span class="toc-text">第九章：迭代器、生成器与推导式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-number">10.1.</span> <span class="toc-text">9.1 迭代器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-number">10.1.1.</span> <span class="toc-text">自定义迭代器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#for-%E5%BE%AA%E7%8E%AF%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">10.1.2.</span> <span class="toc-text">for 循环的工作原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">10.2.</span> <span class="toc-text">9.2 生成器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F-%E6%8E%A8%E5%AF%BC%E5%BC%8F"><span class="toc-number">10.2.1.</span> <span class="toc-text">生成器表达式(推导式)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="toc-number">10.2.2.</span> <span class="toc-text">生成器的优势</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">10.2.3.</span> <span class="toc-text">生成器应用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-%E6%8E%A8%E5%AF%BC%E5%BC%8F"><span class="toc-number">10.3.</span> <span class="toc-text">9.3 推导式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%BC%8F"><span class="toc-number">10.3.1.</span> <span class="toc-text">列表推导式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E5%85%B8%E6%8E%A8%E5%AF%BC%E5%BC%8F"><span class="toc-number">10.3.2.</span> <span class="toc-text">字典推导式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E6%8E%A8%E5%AF%BC%E5%BC%8F"><span class="toc-number">10.3.3.</span> <span class="toc-text">集合推导式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">10.3.4.</span> <span class="toc-text">生成器表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E5%85%83%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">10.3.5.</span> <span class="toc-text">三元表达式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E7%AB%A0%EF%BC%9A-%E6%A8%A1%E5%9D%97%E4%B8%8E%E5%8C%85"><span class="toc-number">11.</span> <span class="toc-text">第十章： 模块与包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-%E6%A8%A1%E5%9D%97%E5%88%86%E7%B1%BB"><span class="toc-number">11.1.</span> <span class="toc-text">10.1 模块分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-%E6%A8%A1%E5%9D%97%E5%AF%BC%E5%85%A5%E6%96%B9%E5%BC%8F"><span class="toc-number">11.2.</span> <span class="toc-text">10.2 模块导入方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-1-%E5%AF%BC%E5%85%A5%E6%95%B4%E4%B8%AA%E6%A8%A1%E5%9D%97"><span class="toc-number">11.2.1.</span> <span class="toc-text">10.2.1 导入整个模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-2-%E4%BB%8E%E6%A8%A1%E5%9D%97%E5%AF%BC%E5%85%A5%E7%89%B9%E5%AE%9A%E5%86%85%E5%AE%B9"><span class="toc-number">11.2.2.</span> <span class="toc-text">10.2.2 从模块导入特定内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-3-%E5%AF%BC%E5%85%A5%E6%97%B6%E9%87%8D%E5%91%BD%E5%90%8D"><span class="toc-number">11.2.3.</span> <span class="toc-text">10.2.3 导入时重命名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-4-%E5%AF%BC%E5%85%A5%E6%89%80%E6%9C%89%E5%86%85%E5%AE%B9%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">11.2.4.</span> <span class="toc-text">10.2.4 导入所有内容（不推荐）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-%E6%8E%A7%E5%88%B6%E6%A8%A1%E5%9D%97%E5%AF%BC%E5%85%A5"><span class="toc-number">11.3.</span> <span class="toc-text">10.3 控制模块导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-%E6%A8%A1%E5%9D%97%E7%9A%84%E7%89%B9%E6%AE%8A%E5%B1%9E%E6%80%A7"><span class="toc-number">11.4.</span> <span class="toc-text">10.4 模块的特殊属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-4-1-name-%E5%B1%9E%E6%80%A7"><span class="toc-number">11.4.1.</span> <span class="toc-text">10.4.1 __name__ 属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-4-2-From-%E6%A8%A1%E5%9D%97%E6%97%A0%E6%B3%95%E8%AF%86%E5%88%AB%E9%97%AE%E9%A2%98"><span class="toc-number">11.4.2.</span> <span class="toc-text">10.4.2 From 模块无法识别问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-%E5%8C%85%E7%9A%84%E6%A6%82%E5%BF%B5%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-number">11.5.</span> <span class="toc-text">10.5 包的概念与使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-5-1-%E5%8C%85%E7%9A%84%E7%BB%93%E6%9E%84%E7%A4%BA%E4%BE%8B"><span class="toc-number">11.5.1.</span> <span class="toc-text">10.5.1 包的结构示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-5-2-init-py-%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">11.5.2.</span> <span class="toc-text">10.5.2 __init__.py 文件的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-5-3-%E5%8C%85%E7%9A%84%E5%AF%BC%E5%85%A5%E6%96%B9%E5%BC%8F"><span class="toc-number">11.5.3.</span> <span class="toc-text">10.5.3 包的导入方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#10-5-3-1-%E5%AF%BC%E5%85%A5%E5%8C%85%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="toc-number">11.5.3.1.</span> <span class="toc-text">10.5.3.1 导入包中的模块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10-5-3-2-%E5%AF%BC%E5%85%A5%E5%8C%85%E4%B8%AD%E7%89%B9%E5%AE%9A%E5%86%85%E5%AE%B9"><span class="toc-number">11.5.3.2.</span> <span class="toc-text">10.5.3.2 导入包中特定内容</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-5-4-%E7%9B%B8%E5%AF%B9%E5%AF%BC%E5%85%A5%E4%B8%8E%E7%BB%9D%E5%AF%B9%E5%AF%BC%E5%85%A5"><span class="toc-number">11.5.4.</span> <span class="toc-text">10.5.4 相对导入与绝对导入</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#10-5-4-1-%E7%BB%9D%E5%AF%B9%E5%AF%BC%E5%85%A5"><span class="toc-number">11.5.4.1.</span> <span class="toc-text">10.5.4.1 绝对导入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10-5-4-2-%E7%9B%B8%E5%AF%B9%E5%AF%BC%E5%85%A5"><span class="toc-number">11.5.4.2.</span> <span class="toc-text">10.5.4.2 相对导入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-6-%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8%E6%8A%80%E5%B7%A7"><span class="toc-number">11.6.</span> <span class="toc-text">10.6 高级应用技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-6-1-%E5%8A%A8%E6%80%81%E5%AF%BC%E5%85%A5"><span class="toc-number">11.6.1.</span> <span class="toc-text">10.6.1 动态导入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-6-2-%E5%BB%B6%E8%BF%9F%E5%AF%BC%E5%85%A5"><span class="toc-number">11.6.2.</span> <span class="toc-text">10.6.2 延迟导入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-6-3-%E4%BD%BF%E7%94%A8-slots-%E4%BC%98%E5%8C%96%E5%86%85%E5%AD%98"><span class="toc-number">11.6.3.</span> <span class="toc-text">10.6.3 使用 __slots__ 优化内存</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-7-%E5%8C%85%E7%9A%84%E5%8F%91%E5%B8%83%E4%B8%8E%E5%AE%89%E8%A3%85"><span class="toc-number">11.7.</span> <span class="toc-text">10.7 包的发布与安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-7-1-%E5%88%9B%E5%BB%BA-setup-py-%E6%96%87%E4%BB%B6"><span class="toc-number">11.7.1.</span> <span class="toc-text">10.7.1 创建 setup.py 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-7-2-%E6%89%93%E5%8C%85%E4%B8%8E%E4%B8%8A%E4%BC%A0"><span class="toc-number">11.7.2.</span> <span class="toc-text">10.7.2 打包与上传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-7-3-%E5%AE%89%E8%A3%85%E5%8C%85"><span class="toc-number">11.7.3.</span> <span class="toc-text">10.7.3 安装包</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-8-PyCharm-%E4%B8%AD%E7%9A%84%E5%8C%85%E7%AE%A1%E7%90%86"><span class="toc-number">11.8.</span> <span class="toc-text">10.8 PyCharm 中的包管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-8-1-%E4%BD%BF%E7%94%A8-Python-Packages-%E5%B7%A5%E5%85%B7"><span class="toc-number">11.8.1.</span> <span class="toc-text">10.8.1 使用 Python Packages 工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-8-2-%E6%9B%B4%E6%94%B9-PyCharm-%E7%9A%84-pip-%E6%BA%90"><span class="toc-number">11.8.2.</span> <span class="toc-text">10.8.2 更改 PyCharm 的 pip 源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-8-3-%E4%BD%BF%E7%94%A8-Project-Interpreter-%E7%AE%A1%E7%90%86%E5%8C%85"><span class="toc-number">11.8.3.</span> <span class="toc-text">10.8.3 使用 Project Interpreter 管理包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-8-4-%E5%AF%BC%E5%87%BA%E5%92%8C%E5%AF%BC%E5%85%A5%E9%A1%B9%E7%9B%AE%E4%BE%9D%E8%B5%96"><span class="toc-number">11.8.4.</span> <span class="toc-text">10.8.4 导出和导入项目依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#10-8-4-1-%E5%AF%BC%E5%87%BA%E4%BE%9D%E8%B5%96"><span class="toc-number">11.8.4.1.</span> <span class="toc-text">10.8.4.1 导出依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10-8-4-2-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">11.8.4.2.</span> <span class="toc-text">10.8.4.2 导入依赖</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-8-5-%E4%BD%BF%E7%94%A8%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83"><span class="toc-number">11.8.5.</span> <span class="toc-text">10.8.5 使用虚拟环境</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#10-8-5-1-%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83%E5%B7%A5%E5%85%B7%E5%AF%B9%E6%AF%94"><span class="toc-number">11.8.5.1.</span> <span class="toc-text">10.8.5.1 虚拟环境工具对比</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-9-%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">11.9.</span> <span class="toc-text">10.9 模块开发最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-9-1-%E6%A8%A1%E5%9D%97%E7%BB%84%E7%BB%87"><span class="toc-number">11.9.1.</span> <span class="toc-text">10.9.1 模块组织</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-9-2-%E5%AF%BC%E5%85%A5%E9%A1%BA%E5%BA%8F"><span class="toc-number">11.9.2.</span> <span class="toc-text">10.9.2 导入顺序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-9-3-%E6%96%87%E6%A1%A3%E5%8C%96%E6%A8%A1%E5%9D%97%E5%92%8C%E5%8C%85"><span class="toc-number">11.9.3.</span> <span class="toc-text">10.9.3 文档化模块和包</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0%EF%BC%9A%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B"><span class="toc-number">12.</span> <span class="toc-text">第十一章：面向对象编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">12.1.</span> <span class="toc-text">对象的本质</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AF%B9%E8%B1%A1"><span class="toc-number">12.1.1.</span> <span class="toc-text">为什么需要对象</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#init-%E6%96%B9%E6%B3%95"><span class="toc-number">12.2.</span> <span class="toc-text">__init__ 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E4%B8%89%E5%A4%A7%E7%89%B9%E6%80%A7"><span class="toc-number">12.3.</span> <span class="toc-text">面向对象的三大特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%B0%81%E8%A3%85"><span class="toc-number">12.3.1.</span> <span class="toc-text">1. 封装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E9%9A%90%E8%97%8F"><span class="toc-number">12.3.1.1.</span> <span class="toc-text">属性隐藏</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">12.3.1.2.</span> <span class="toc-text">属性访问控制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-property-%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">12.3.1.3.</span> <span class="toc-text">使用@property 装饰器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BB%A7%E6%89%BF"><span class="toc-number">12.3.2.</span> <span class="toc-text">2. 继承</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E7%BB%A7%E6%89%BF%E5%92%8C%E5%A4%9A%E7%BB%A7%E6%89%BF"><span class="toc-number">12.3.2.1.</span> <span class="toc-text">单继承和多继承</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E9%87%8D%E5%86%99%E5%92%8C%E8%B0%83%E7%94%A8%E7%88%B6%E7%B1%BB%E6%96%B9%E6%B3%95"><span class="toc-number">12.3.2.2.</span> <span class="toc-text">方法重写和调用父类方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF%E7%9A%84%E5%B1%9E%E6%80%A7%E6%9F%A5%E6%89%BE%E9%A1%BA%E5%BA%8F-MRO"><span class="toc-number">12.3.2.3.</span> <span class="toc-text">继承的属性查找顺序 (MRO)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8F%B1%E5%BD%A2%E7%BB%A7%E6%89%BF%E9%97%AE%E9%A2%98"><span class="toc-number">12.3.2.4.</span> <span class="toc-text">菱形继承问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MixIn-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.3.2.5.</span> <span class="toc-text">MixIn 设计模式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%A4%9A%E6%80%81"><span class="toc-number">12.3.3.</span> <span class="toc-text">3. 多态</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%B8%AD%E5%AD%90%E7%B1%BB%E5%9E%8B"><span class="toc-number">12.3.3.1.</span> <span class="toc-text">鸭子类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%9F%BA%E7%B1%BB"><span class="toc-number">12.3.3.2.</span> <span class="toc-text">抽象基类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E6%96%B9%E6%B3%95%E4%B8%8E%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="toc-number">12.4.</span> <span class="toc-text">类方法与静态方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E7%B1%BB%E5%9E%8B%E6%AF%94%E8%BE%83"><span class="toc-number">12.4.1.</span> <span class="toc-text">方法类型比较</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%B1%BB%E6%96%B9%E6%B3%95%EF%BC%88-classmethod%EF%BC%89"><span class="toc-number">12.4.2.</span> <span class="toc-text">2. 类方法（@classmethod）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%EF%BC%88-staticmethod%EF%BC%89"><span class="toc-number">12.4.3.</span> <span class="toc-text">3. 静态方法（@staticmethod）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6"><span class="toc-number">12.5.</span> <span class="toc-text">反射机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%8F%8D%E5%B0%84%E5%87%BD%E6%95%B0"><span class="toc-number">12.5.1.</span> <span class="toc-text">常用反射函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-hasattr-%E2%80%94-%E6%A3%80%E6%9F%A5%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%90%A6%E6%9C%89%E6%8C%87%E5%AE%9A%E5%B1%9E%E6%80%A7"><span class="toc-number">12.5.2.</span> <span class="toc-text">1. hasattr() — 检查对象是否有指定属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-getattr-%E2%80%94-%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">12.5.3.</span> <span class="toc-text">2. getattr() — 获取对象的属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-setattr-%E2%80%94-%E8%AE%BE%E7%BD%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">12.5.4.</span> <span class="toc-text">3. setattr() — 设置对象的属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-delattr-%E2%80%94-%E5%88%A0%E9%99%A4%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">12.5.5.</span> <span class="toc-text">4. delattr() — 删除对象的属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-dir-%E2%80%94-%E5%88%97%E5%87%BA%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%80%E6%9C%89%E5%B1%9E%E6%80%A7"><span class="toc-number">12.5.6.</span> <span class="toc-text">5. dir() — 列出对象的所有属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-type-%E2%80%94-%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">12.5.7.</span> <span class="toc-text">6. type() — 获取对象的类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-isinstance-%E2%80%94-%E6%A3%80%E6%9F%A5%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%90%A6%E4%B8%BA%E7%B1%BB%E7%9A%84%E5%AE%9E%E4%BE%8B"><span class="toc-number">12.5.8.</span> <span class="toc-text">7. isinstance() — 检查对象是否为类的实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-issubclass-%E2%80%94-%E6%A3%80%E6%9F%A5%E7%B1%BB%E6%98%AF%E5%90%A6%E4%B8%BA%E5%8F%A6%E4%B8%80%E4%B8%AA%E7%B1%BB%E7%9A%84%E5%AD%90%E7%B1%BB"><span class="toc-number">12.5.9.</span> <span class="toc-text">8. issubclass() — 检查类是否为另一个类的子类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-callable-%E2%80%94-%E6%A3%80%E6%9F%A5%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%90%A6%E5%8F%AF%E8%B0%83%E7%94%A8"><span class="toc-number">12.5.10.</span> <span class="toc-text">9. callable() — 检查对象是否可调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-vars-%E2%80%94-%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%B1%A1%E7%9A%84-dict"><span class="toc-number">12.5.11.</span> <span class="toc-text">10. vars() — 获取对象的 __dict__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E7%A4%BA%E4%BE%8B"><span class="toc-number">12.5.12.</span> <span class="toc-text">反射示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E6%9E%9A%E4%B8%BE%E4%BB%A5%E5%8F%8A%E6%8A%BD%E8%B1%A1%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">12.6.</span> <span class="toc-text">通用枚举以及抽象接口定义</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#enum-%E6%A8%A1%E5%9D%97%EF%BC%9A%E5%AE%9E%E7%8E%B0%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B"><span class="toc-number">12.6.0.1.</span> <span class="toc-text">enum 模块：实现枚举类型</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#enum-%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="toc-number">12.6.0.1.1.</span> <span class="toc-text">enum 常用功能</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#enum-%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">12.6.0.1.2.</span> <span class="toc-text">enum 模块代码示例</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#abc-%E6%A8%A1%E5%9D%97%EF%BC%9A%E5%AE%9A%E4%B9%89%E6%8A%BD%E8%B1%A1%E5%9F%BA%E7%B1%BB-Abstract-Base-Classes"><span class="toc-number">12.6.0.2.</span> <span class="toc-text">abc 模块：定义抽象基类 (Abstract Base Classes)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#abc-%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="toc-number">12.6.0.2.1.</span> <span class="toc-text">abc 常用功能</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#abc-%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">12.6.0.2.2.</span> <span class="toc-text">abc 模块代码示例</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E7%B1%BB%E7%BC%96%E7%A8%8B"><span class="toc-number">12.7.</span> <span class="toc-text">元类编程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%83%E7%B1%BB%E7%9A%84%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95"><span class="toc-number">12.7.1.</span> <span class="toc-text">元类的核心方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-type-%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E7%B1%BB"><span class="toc-number">12.7.2.</span> <span class="toc-text">使用 type 动态创建类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%83%E7%B1%BB"><span class="toc-number">12.7.3.</span> <span class="toc-text">自定义元类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%83%E7%B1%BB%E7%9A%84-new-%E6%96%B9%E6%B3%95"><span class="toc-number">12.7.4.</span> <span class="toc-text">元类的 __new__ 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%83%E7%B1%BB%E7%9A%84-call-%E6%96%B9%E6%B3%95%E5%AE%9E%E4%BE%8B"><span class="toc-number">12.7.5.</span> <span class="toc-text">元类的 __call__ 方法实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%83%E7%B1%BB%E9%93%BE%E5%92%8C%E7%B1%BB%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-number">12.7.6.</span> <span class="toc-text">元类链和类创建过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E7%9A%84%E5%85%83%E7%B1%BB%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%E8%A1%A8"><span class="toc-number">12.7.7.</span> <span class="toc-text">内置的元类属性和方法表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Python-%E7%89%B9%E6%AE%8A%E6%96%B9%E6%B3%95%EF%BC%88%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%EF%BC%89"><span class="toc-number">12.8.</span> <span class="toc-text">Python 特殊方法（魔术方法）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E4%B8%8E%E9%94%80%E6%AF%81"><span class="toc-number">12.8.0.1.</span> <span class="toc-text">1. 对象创建与销毁</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A"><span class="toc-number">12.8.0.1.1.</span> <span class="toc-text">实际应用场景：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%AF%B9%E8%B1%A1%E8%A1%A8%E7%A4%BA"><span class="toc-number">12.8.0.2.</span> <span class="toc-text">2. 对象表示</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A-1"><span class="toc-number">12.8.0.2.1.</span> <span class="toc-text">实际应用场景：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E9%9B%86%E5%90%88%E7%B1%BB%E6%93%8D%E4%BD%9C"><span class="toc-number">12.8.0.3.</span> <span class="toc-text">3. 集合类操作</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E5%95%86%E5%93%81%E8%B4%AD%E7%89%A9%E8%BD%A6"><span class="toc-number">12.8.0.3.1.</span> <span class="toc-text">实际应用场景：自定义商品购物车</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E8%B0%83%E7%94%A8%E4%B8%8E%E6%AF%94%E8%BE%83%E6%93%8D%E4%BD%9C"><span class="toc-number">12.8.0.4.</span> <span class="toc-text">4. 调用与比较操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">12.8.0.5.</span> <span class="toc-text">实际应用场景：数据分析器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E7%AE%97%E6%9C%AF%E8%BF%90%E7%AE%97%E6%93%8D%E4%BD%9C"><span class="toc-number">12.8.0.6.</span> <span class="toc-text">5. 算术运算操作</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A%E5%90%91%E9%87%8F%E8%BF%90%E7%AE%97"><span class="toc-number">12.8.0.6.1.</span> <span class="toc-text">实际应用场景：向量运算</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-%E5%B1%9E%E6%80%A7%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">12.8.0.7.</span> <span class="toc-text">6. 属性访问控制</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A%E5%B1%9E%E6%80%A7%E9%AA%8C%E8%AF%81%E4%B8%8E%E4%BF%9D%E6%8A%A4"><span class="toc-number">12.8.0.7.1.</span> <span class="toc-text">实际应用场景：属性验证与保护</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%EF%BC%88with-%E8%AF%AD%E5%8F%A5%EF%BC%89"><span class="toc-number">12.8.0.8.</span> <span class="toc-text">7. 上下文管理（with 语句）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86"><span class="toc-number">12.8.0.8.1.</span> <span class="toc-text">实际应用场景：数据库连接管理</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-%E6%8F%8F%E8%BF%B0%E7%AC%A6%E4%B8%8E%E5%B1%9E%E6%80%A7%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">12.8.0.9.</span> <span class="toc-text">8. 描述符与属性装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%8D%8F%E8%AE%AE%E6%96%B9%E6%B3%95"><span class="toc-number">12.8.0.9.1.</span> <span class="toc-text">描述符协议方法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">12.8.0.9.2.</span> <span class="toc-text">实际应用场景：数据验证描述符</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E8%A3%85%E9%A5%B0%E5%99%A8-property-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8"><span class="toc-number">12.8.0.9.3.</span> <span class="toc-text">属性装饰器(@property)实际应用</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10-%E5%B8%B8%E8%A7%81%E7%89%B9%E6%AE%8A%E6%96%B9%E6%B3%95%E4%BD%BF%E7%94%A8%E9%99%B7%E9%98%B1%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">12.8.0.10.</span> <span class="toc-text">10. 常见特殊方法使用陷阱与最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%99%B7%E9%98%B1%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">12.8.0.10.1.</span> <span class="toc-text">陷阱与注意事项</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#11-%E6%80%BB%E7%BB%93%EF%BC%9A%E7%89%B9%E6%AE%8A%E6%96%B9%E6%B3%95%E7%9A%84%E9%80%89%E6%8B%A9%E6%8C%87%E5%8D%97"><span class="toc-number">12.8.0.11.</span> <span class="toc-text">11. 总结：特殊方法的选择指南</span></a></li></ol></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E4%B8%8E%E7%B1%BB%E7%9A%84%E9%AB%98%E7%BA%A7%E6%A6%82%E5%BF%B5"><span class="toc-number">12.9.</span> <span class="toc-text">对象与类的高级概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%AE%9E%E4%BE%8B%E3%80%81%E7%B1%BB%E5%92%8C%E5%85%83%E7%B1%BB%E5%85%B3%E7%B3%BB"><span class="toc-number">12.9.1.</span> <span class="toc-text">深入理解实例、类和元类关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E6%9F%A5%E6%89%BE%E7%9A%84%E5%A4%8D%E6%9D%82%E6%83%85%E5%86%B5"><span class="toc-number">12.9.2.</span> <span class="toc-text">属性查找的复杂情况</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B8%8E%E5%AF%B9%E8%B1%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">12.10.</span> <span class="toc-text">内存管理与对象生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E5%92%8C%E9%94%80%E6%AF%81%E7%9A%84%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B"><span class="toc-number">12.10.1.</span> <span class="toc-text">对象创建和销毁的完整过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E5%92%8C%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8"><span class="toc-number">12.10.2.</span> <span class="toc-text">引用计数和循环引用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E5%B8%B8%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.11.</span> <span class="toc-text">高级常用设计模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.11.1.</span> <span class="toc-text">单例模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%87%92%E6%B1%89%E5%BC%8F%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">12.11.1.1.</span> <span class="toc-text">懒汉式单例模式的使用场景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A5%BF%E6%B1%89%E5%BC%8F%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">12.11.1.2.</span> <span class="toc-text">饿汉式单例模式的使用场景</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.11.2.</span> <span class="toc-text">工厂模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.11.3.</span> <span class="toc-text">观察者模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.11.4.</span> <span class="toc-text">代理模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0"><span class="toc-number">12.11.4.1.</span> <span class="toc-text">1.静态代理实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0"><span class="toc-number">12.11.4.2.</span> <span class="toc-text">2.动态代理实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E4%BF%9D%E6%8A%A4%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0"><span class="toc-number">12.11.4.3.</span> <span class="toc-text">3.保护代理实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E8%99%9A%E6%8B%9F%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0"><span class="toc-number">12.11.4.4.</span> <span class="toc-text">4.虚拟代理实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SOLID-%E5%8E%9F%E5%88%99"><span class="toc-number">12.12.</span> <span class="toc-text">SOLID 原则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SOLID-%E5%8E%9F%E5%88%99%E6%A6%82%E8%BF%B0"><span class="toc-number">12.12.1.</span> <span class="toc-text">SOLID 原则概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E5%8E%9F%E5%88%99-SRP"><span class="toc-number">12.12.2.</span> <span class="toc-text">1. 单一职责原则 (SRP)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-%E5%8E%9F%E5%88%99%E8%A7%A3%E6%9E%90"><span class="toc-number">12.12.2.1.</span> <span class="toc-text">1.1 原则解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">12.12.2.2.</span> <span class="toc-text">1.2 电商系统中的应用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-%E9%81%B5%E5%BE%AA-SRP-%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">12.12.2.3.</span> <span class="toc-text">1.3 遵循 SRP 的实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%BC%80%E6%94%BE%E5%B0%81%E9%97%AD%E5%8E%9F%E5%88%99-OCP"><span class="toc-number">12.12.3.</span> <span class="toc-text">2. 开放封闭原则 (OCP)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-%E5%8E%9F%E5%88%99%E8%A7%A3%E6%9E%90"><span class="toc-number">12.12.3.1.</span> <span class="toc-text">2.1 原则解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">12.12.3.2.</span> <span class="toc-text">2.2 电商系统中的应用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-%E9%81%B5%E5%BE%AA-OCP-%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">12.12.3.3.</span> <span class="toc-text">2.3 遵循 OCP 的实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%87%8C%E6%B0%8F%E6%9B%BF%E6%8D%A2%E5%8E%9F%E5%88%99-LSP"><span class="toc-number">12.12.4.</span> <span class="toc-text">3. 里氏替换原则 (LSP)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-%E5%8E%9F%E5%88%99%E8%A7%A3%E6%9E%90"><span class="toc-number">12.12.4.1.</span> <span class="toc-text">3.1 原则解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">12.12.4.2.</span> <span class="toc-text">3.2 电商系统中的应用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-%E9%81%B5%E5%BE%AA-LSP-%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">12.12.4.3.</span> <span class="toc-text">3.3 遵循 LSP 的实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99-ISP"><span class="toc-number">12.12.5.</span> <span class="toc-text">4. 接口隔离原则 (ISP)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-%E5%8E%9F%E5%88%99%E8%A7%A3%E6%9E%90"><span class="toc-number">12.12.5.1.</span> <span class="toc-text">4.1 原则解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">12.12.5.2.</span> <span class="toc-text">4.2 电商系统中的应用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-%E9%81%B5%E5%BE%AA-ISP-%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">12.12.5.3.</span> <span class="toc-text">4.3 遵循 ISP 的实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E4%BE%9D%E8%B5%96%E5%80%92%E7%BD%AE%E5%8E%9F%E5%88%99-DIP"><span class="toc-number">12.12.6.</span> <span class="toc-text">5. 依赖倒置原则 (DIP)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-%E5%8E%9F%E5%88%99%E8%A7%A3%E6%9E%90"><span class="toc-number">12.12.6.1.</span> <span class="toc-text">5.1 原则解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">12.12.6.2.</span> <span class="toc-text">5.2 电商系统中的应用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-%E9%81%B5%E5%BE%AA-DIP-%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">12.12.6.3.</span> <span class="toc-text">5.3 遵循 DIP 的实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Python-%E4%B8%AD%E7%9A%84-slots"><span class="toc-number">12.13.</span> <span class="toc-text">Python 中的 __slots__</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#slots-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8A%BF"><span class="toc-number">12.13.1.</span> <span class="toc-text">__slots__ 的工作原理与性能优势</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#slots-%E7%9A%84%E9%99%90%E5%88%B6%E5%92%8C%E7%BB%A7%E6%89%BF%E8%A1%8C%E4%B8%BA"><span class="toc-number">12.13.2.</span> <span class="toc-text">__slots__ 的限制和继承行为</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0%EF%BC%9A-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">13.</span> <span class="toc-text">第十二章： 异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1-%E5%9F%BA%E6%9C%AC%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">13.1.</span> <span class="toc-text">12.1 基本异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12-1-1-%E5%BC%82%E5%B8%B8%E7%9A%84%E6%A6%82%E5%BF%B5%E4%B8%8E%E6%84%8F%E4%B9%89"><span class="toc-number">13.1.1.</span> <span class="toc-text">12.1.1 异常的概念与意义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-1-2-%E5%9F%BA%E7%A1%80-try-except-%E7%BB%93%E6%9E%84"><span class="toc-number">13.1.2.</span> <span class="toc-text">12.1.2 基础 try-except 结构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-%E5%AE%8C%E6%95%B4%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%BB%93%E6%9E%84"><span class="toc-number">13.2.</span> <span class="toc-text">12.2 完整的异常处理结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12-2-1-try-except-else-finally-%E5%AE%8C%E6%95%B4%E7%BB%93%E6%9E%84"><span class="toc-number">13.2.1.</span> <span class="toc-text">12.2.1 try-except-else-finally 完整结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-2-2-%E5%90%84%E4%BB%A3%E7%A0%81%E5%9D%97%E6%89%A7%E8%A1%8C%E6%9D%A1%E4%BB%B6%E6%80%BB%E7%BB%93"><span class="toc-number">13.2.2.</span> <span class="toc-text">12.2.2 各代码块执行条件总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8"><span class="toc-number">13.3.</span> <span class="toc-text">12.3 自定义异常</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12-3-1-%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E7%B1%BB"><span class="toc-number">13.3.1.</span> <span class="toc-text">12.3.1 创建自定义异常类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-3-2-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8"><span class="toc-number">13.3.2.</span> <span class="toc-text">12.3.2 使用自定义异常</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-4-%E5%BC%82%E5%B8%B8%E7%9A%84%E4%BC%A0%E6%92%AD%E4%B8%8E%E9%87%8D%E6%96%B0%E6%8A%9B%E5%87%BA"><span class="toc-number">13.4.</span> <span class="toc-text">12.4 异常的传播与重新抛出</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12-4-1-%E5%BC%82%E5%B8%B8%E4%BC%A0%E6%92%AD%E6%9C%BA%E5%88%B6"><span class="toc-number">13.4.1.</span> <span class="toc-text">12.4.1 异常传播机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-4-2-%E9%87%8D%E6%96%B0%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8"><span class="toc-number">13.4.2.</span> <span class="toc-text">12.4.2 重新抛出异常</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-5-%E4%BD%BF%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">13.5.</span> <span class="toc-text">12.5 使用上下文管理器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12-5-1-with-%E8%AF%AD%E5%8F%A5%E5%92%8C%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="toc-number">13.5.1.</span> <span class="toc-text">12.5.1 with 语句和资源管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-5-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">13.5.2.</span> <span class="toc-text">12.5.2 自定义上下文管理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-5-3-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">13.5.3.</span> <span class="toc-text">12.5.3 实际应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-5-4-%E4%BD%BF%E7%94%A8-contextlib-%E7%AE%80%E5%8C%96%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8%E5%88%9B%E5%BB%BA"><span class="toc-number">13.5.4.</span> <span class="toc-text">12.5.4 使用 contextlib 简化上下文管理器创建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-6-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">13.6.</span> <span class="toc-text">12.6 异常处理最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12-6-1-%E4%B8%8D%E8%89%AF%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%94%B9%E8%BF%9B"><span class="toc-number">13.6.1.</span> <span class="toc-text">12.6.1 不良实践与改进</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-6-2-%E5%AE%9E%E9%99%85%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-number">13.6.2.</span> <span class="toc-text">12.6.2 实际开发中的异常处理策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-7-%E9%AB%98%E7%BA%A7%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%8A%80%E6%9C%AF"><span class="toc-number">13.7.</span> <span class="toc-text">12.7 高级异常处理技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12-7-1-%E4%BD%BF%E7%94%A8%E8%A3%85%E9%A5%B0%E5%99%A8%E7%AE%80%E5%8C%96%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">13.7.1.</span> <span class="toc-text">12.7.1 使用装饰器简化异常处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-7-2-%E5%BC%82%E5%B8%B8%E9%93%BE%E4%B8%8E%E5%BC%82%E5%B8%B8%E7%BB%84"><span class="toc-number">13.7.2.</span> <span class="toc-text">12.7.2 异常链与异常组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-7-3-EAFP-vs-LBYL-%E7%BC%96%E7%A8%8B%E9%A3%8E%E6%A0%BC"><span class="toc-number">13.7.3.</span> <span class="toc-text">12.7.3 EAFP vs LBYL 编程风格</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%89%E7%AB%A0%EF%BC%9A-%E9%AB%98%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-number">14.</span> <span class="toc-text">第十三章： 高级数据处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-JSON-%E5%A4%84%E7%90%86"><span class="toc-number">14.1.</span> <span class="toc-text">13.1 JSON 处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-1-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">14.1.1.</span> <span class="toc-text">13.1.1 基本操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-2-%E9%87%8D%E8%A6%81%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">14.1.2.</span> <span class="toc-text">13.1.2 重要参数说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AF%B9%E8%B1%A1%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">14.1.3.</span> <span class="toc-text">13.1.3 自定义对象序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-4-JSON-%E8%A7%A3%E7%A0%81%E4%B8%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AF%B9%E8%B1%A1"><span class="toc-number">14.1.4.</span> <span class="toc-text">13.1.4 JSON 解码为自定义对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-5-%E5%A4%84%E7%90%86%E5%A4%8D%E6%9D%82-JSON-%E6%95%B0%E6%8D%AE"><span class="toc-number">14.1.5.</span> <span class="toc-text">13.1.5 处理复杂 JSON 数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-6-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">14.1.6.</span> <span class="toc-text">13.1.6 性能优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-7-JSON-Schema-%E9%AA%8C%E8%AF%81"><span class="toc-number">14.1.7.</span> <span class="toc-text">13.1.7 JSON Schema 验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-CSV-%E5%A4%84%E7%90%86"><span class="toc-number">14.2.</span> <span class="toc-text">13.2 CSV 处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-1-%E5%9F%BA%E6%9C%AC%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C"><span class="toc-number">14.2.1.</span> <span class="toc-text">13.2.1 基本读写操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-2-%E4%BD%BF%E7%94%A8%E5%AD%97%E5%85%B8%E5%A4%84%E7%90%86-CSV-%E6%96%87%E4%BB%B6"><span class="toc-number">14.2.2.</span> <span class="toc-text">13.2.2 使用字典处理 CSV 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-3-CSV-%E6%96%B9%E8%A8%80%E4%B8%8E%E6%A0%BC%E5%BC%8F%E5%8C%96%E9%80%89%E9%A1%B9"><span class="toc-number">14.2.3.</span> <span class="toc-text">13.2.3 CSV 方言与格式化选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-4-%E5%A4%84%E7%90%86%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5"><span class="toc-number">14.2.4.</span> <span class="toc-text">13.2.4 处理特殊情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-5-CSV-%E6%96%87%E4%BB%B6%E7%9A%84%E9%AB%98%E7%BA%A7%E6%93%8D%E4%BD%9C"><span class="toc-number">14.2.5.</span> <span class="toc-text">13.2.5 CSV 文件的高级操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-3-XML-%E5%A4%84%E7%90%86"><span class="toc-number">14.3.</span> <span class="toc-text">13.3 XML 处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#13-3-1-%E5%88%9B%E5%BB%BA%E5%92%8C%E5%86%99%E5%85%A5-XML"><span class="toc-number">14.3.1.</span> <span class="toc-text">13.3.1 创建和写入 XML</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-3-2-%E8%A7%A3%E6%9E%90%E5%92%8C%E8%AF%BB%E5%8F%96-XML"><span class="toc-number">14.3.2.</span> <span class="toc-text">13.3.2 解析和读取 XML</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-3-3-%E4%BF%AE%E6%94%B9-XML"><span class="toc-number">14.3.3.</span> <span class="toc-text">13.3.3 修改 XML</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-3-4-%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%A4%84%E7%90%86"><span class="toc-number">14.3.4.</span> <span class="toc-text">13.3.4 命名空间处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-4-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86"><span class="toc-number">14.4.</span> <span class="toc-text">13.4 配置文件处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-1-INI-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86"><span class="toc-number">14.4.1.</span> <span class="toc-text">13.4.1 INI 配置文件处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-2-YAML-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86"><span class="toc-number">14.4.2.</span> <span class="toc-text">13.4.2 YAML 配置文件处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-3-%E4%BD%BF%E7%94%A8%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">14.4.3.</span> <span class="toc-text">13.4.3 使用环境变量作为配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-4-JSON-%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">14.4.4.</span> <span class="toc-text">13.4.4 JSON 作为配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-5-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">14.5.</span> <span class="toc-text">13.5 正则表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#13-5-1-%E5%B8%B8%E7%94%A8%E5%85%83%E5%AD%97%E7%AC%A6%E5%92%8C%E8%AF%AD%E6%B3%95"><span class="toc-number">14.5.1.</span> <span class="toc-text">13.5.1 常用元字符和语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-5-2-%E7%89%B9%E6%AE%8A%E5%BA%8F%E5%88%97-%E9%A2%84%E5%AE%9A%E4%B9%89%E5%AD%97%E7%AC%A6%E9%9B%86"><span class="toc-number">14.5.2.</span> <span class="toc-text">13.5.2 特殊序列 (预定义字符集)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-5-3-%E8%B4%AA%E5%A9%AA%E6%A8%A1%E5%BC%8F-vs-%E9%9D%9E%E8%B4%AA%E5%A9%AA%E6%A8%A1%E5%BC%8F"><span class="toc-number">14.5.3.</span> <span class="toc-text">13.5.3 贪婪模式 vs. 非贪婪模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-5-4-%E5%88%86%E7%BB%84%E4%B8%8E%E6%8D%95%E8%8E%B7"><span class="toc-number">14.5.4.</span> <span class="toc-text">13.5.4 分组与捕获</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-5-5-re-%E6%A8%A1%E5%9D%97%E6%A0%B8%E5%BF%83%E5%87%BD%E6%95%B0"><span class="toc-number">14.5.5.</span> <span class="toc-text">13.5.5 re 模块核心函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-5-6-Match-%E5%AF%B9%E8%B1%A1%E8%AF%A6%E8%A7%A3"><span class="toc-number">14.5.6.</span> <span class="toc-text">13.5.6 Match 对象详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-5-7-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A0%87%E5%BF%97-Flags"><span class="toc-number">14.5.7.</span> <span class="toc-text">13.5.7 正则表达式标志 (Flags)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-5-8-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%E7%A4%BA%E4%BE%8B"><span class="toc-number">14.5.8.</span> <span class="toc-text">13.5.8 实际应用场景示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E5%9B%9B%E7%AB%A0%EF%BC%9A%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B"><span class="toc-number">15.</span> <span class="toc-text">第十四章：深入解析并发编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#14-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">15.1.</span> <span class="toc-text">14. 并发编程基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90"><span class="toc-number">15.1.1.</span> <span class="toc-text">进程调度机制解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E4%B8%89%E5%A4%A7%E7%8A%B6%E6%80%81%E4%B8%8E%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">15.1.2.</span> <span class="toc-text">进程的三大状态与生命周期</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-1-%E5%90%8C%E6%AD%A5%E4%B8%8E%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">15.2.</span> <span class="toc-text">14.1 同步与异步编程模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%92%8C%E5%BC%82%E6%AD%A5"><span class="toc-number">15.2.1.</span> <span class="toc-text">同步和异步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E"><span class="toc-number">15.2.2.</span> <span class="toc-text">阻塞和非阻塞</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-2-%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF"><span class="toc-number">15.3.</span> <span class="toc-text">14.2 多进程编程技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%9F%BA%E7%A1%80"><span class="toc-number">15.3.1.</span> <span class="toc-text">进程基础</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95"><span class="toc-number">15.3.2.</span> <span class="toc-text">进程创建方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E4%BD%BF%E7%94%A8-Process-%E7%B1%BB%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B"><span class="toc-number">15.3.2.1.</span> <span class="toc-text">方法一：使用 Process 类创建进程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A%E7%BB%A7%E6%89%BF-Process-%E7%B1%BB%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B"><span class="toc-number">15.3.2.2.</span> <span class="toc-text">方法二：继承 Process 类创建进程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95%E8%A1%A8"><span class="toc-number">15.3.3.</span> <span class="toc-text">多进程常用方法表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%8F%B7%E4%B8%8E%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF%E8%8E%B7%E5%8F%96"><span class="toc-number">15.3.4.</span> <span class="toc-text">进程号与进程信息获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E7%A4%BA%E4%BE%8B"><span class="toc-number">15.3.5.</span> <span class="toc-text">进程间通信示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1%E7%A4%BA%E4%BE%8B"><span class="toc-number">15.3.6.</span> <span class="toc-text">复杂进程通信示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%B1%A0%E8%AF%A6%E8%A7%A3"><span class="toc-number">15.3.7.</span> <span class="toc-text">进程池详解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%B1%A0%E7%9A%84%E4%B8%BB%E8%A6%81%E6%96%B9%E6%B3%95"><span class="toc-number">15.3.7.1.</span> <span class="toc-text">进程池的主要方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ProcessPoolExecutor-%E7%A4%BA%E4%BE%8B"><span class="toc-number">15.3.7.2.</span> <span class="toc-text">ProcessPoolExecutor 示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%8F%B7%E4%B8%8E%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF%E8%8E%B7%E5%8F%96-1"><span class="toc-number">15.3.8.</span> <span class="toc-text">进程号与进程信息获取</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5"><span class="toc-number">15.3.8.1.</span> <span class="toc-text">进程状态特殊情况</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B"><span class="toc-number">15.3.8.1.1.</span> <span class="toc-text">僵尸进程</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AD%A4%E5%84%BF%E8%BF%9B%E7%A8%8B"><span class="toc-number">15.3.8.1.2.</span> <span class="toc-text">孤儿进程</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-3-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90"><span class="toc-number">15.4.</span> <span class="toc-text">14.3 多线程编程深入解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80"><span class="toc-number">15.4.1.</span> <span class="toc-text">线程基础</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95"><span class="toc-number">15.4.2.</span> <span class="toc-text">线程创建方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E4%BD%BF%E7%94%A8-Thread-%E7%B1%BB%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B"><span class="toc-number">15.4.2.1.</span> <span class="toc-text">方法一：使用 Thread 类创建线程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A%E7%BB%A7%E6%89%BF-Thread-%E7%B1%BB%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B"><span class="toc-number">15.4.2.2.</span> <span class="toc-text">方法二：继承 Thread 类创建线程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95%E8%A1%A8"><span class="toc-number">15.4.3.</span> <span class="toc-text">线程常用方法表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B"><span class="toc-number">15.4.4.</span> <span class="toc-text">线程使用实例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%BA%BF%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="toc-number">15.4.4.1.</span> <span class="toc-text">基本线程示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="toc-number">15.4.4.2.</span> <span class="toc-text">守护线程示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%AF%A6%E8%A7%A3"><span class="toc-number">15.4.5.</span> <span class="toc-text">线程池详解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ThreadPoolExecutor-%E4%B8%BB%E8%A6%81%E6%96%B9%E6%B3%95"><span class="toc-number">15.4.5.1.</span> <span class="toc-text">ThreadPoolExecutor 主要方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B"><span class="toc-number">15.4.5.2.</span> <span class="toc-text">完整示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Event-%E4%BA%8B%E4%BB%B6%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6"><span class="toc-number">15.4.6.</span> <span class="toc-text">Event 事件同步机制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Event-%E4%B8%BB%E8%A6%81%E6%96%B9%E6%B3%95"><span class="toc-number">15.4.6.1.</span> <span class="toc-text">Event 主要方法</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8-Timer"><span class="toc-number">15.4.7.</span> <span class="toc-text">定时器(Timer)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-4-%E5%A4%9A%E8%BF%9B%E7%A8%8B-VS-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">15.5.</span> <span class="toc-text">14.4 多进程 VS 多线程性能分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E5%9C%BA%E6%99%AF%E7%9A%84%E6%9C%80%E4%BC%98%E9%80%89%E6%8B%A9"><span class="toc-number">15.5.1.</span> <span class="toc-text">不同场景的最优选择</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B%E4%BB%BB%E5%8A%A1%E6%B5%8B%E8%AF%95"><span class="toc-number">15.5.2.</span> <span class="toc-text">计算密集型任务测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-%E5%AF%86%E9%9B%86%E5%9E%8B%E4%BB%BB%E5%8A%A1%E6%B5%8B%E8%AF%95"><span class="toc-number">15.5.3.</span> <span class="toc-text">IO 密集型任务测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-5-%E5%8D%8F%E7%A8%8B%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3"><span class="toc-number">15.6.</span> <span class="toc-text">14.5 协程技术详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-number">15.6.1.</span> <span class="toc-text">协程基础概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B%E6%95%88%E7%8E%87%E5%AF%B9%E6%AF%94"><span class="toc-number">15.6.2.</span> <span class="toc-text">协程效率对比</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%B2%E8%A1%8C%E6%89%A7%E8%A1%8C"><span class="toc-number">15.6.2.1.</span> <span class="toc-text">串行执行</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-yield-%E5%AE%9E%E7%8E%B0%E5%8D%8F%E7%A8%8B%E5%88%87%E6%8D%A2"><span class="toc-number">15.6.2.2.</span> <span class="toc-text">使用 yield 实现协程切换</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#greenlet-%E6%A8%A1%E5%9D%97%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">15.6.3.</span> <span class="toc-text">greenlet 模块（了解）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#greenlet-%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95%E4%B8%8E%E5%B1%9E%E6%80%A7"><span class="toc-number">15.6.3.1.</span> <span class="toc-text">greenlet 核心方法与属性</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gevent-%E6%A8%A1%E5%9D%97%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">15.6.4.</span> <span class="toc-text">gevent 模块（了解）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#gevent-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C"><span class="toc-number">15.6.4.1.</span> <span class="toc-text">gevent 基础操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#gevent-%E5%B8%B8%E7%94%A8-API-%E8%AF%A6%E8%A7%A3"><span class="toc-number">15.6.4.2.</span> <span class="toc-text">gevent 常用 API 详解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%E7%A4%BA%E4%BE%8B"><span class="toc-number">15.6.4.3.</span> <span class="toc-text">实际应用场景示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#greenlet-%E4%B8%8E-gevent-%E7%9A%84%E5%8C%BA%E5%88%AB%E4%B8%8E%E9%80%89%E6%8B%A9"><span class="toc-number">15.6.5.</span> <span class="toc-text">greenlet 与 gevent 的区别与选择</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#asyncio-%E5%8D%8F%E7%A8%8B%E6%8A%80%E6%9C%AF"><span class="toc-number">15.6.6.</span> <span class="toc-text">asyncio 协程技术</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#asyncio-%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8D%8F%E7%A8%8B"><span class="toc-number">15.6.6.1.</span> <span class="toc-text">asyncio 与原生协程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#asyncio-%E5%B8%B8%E7%94%A8-API"><span class="toc-number">15.6.6.2.</span> <span class="toc-text">asyncio 常用 API</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Task-%E5%AF%B9%E8%B1%A1"><span class="toc-number">15.6.7.</span> <span class="toc-text">Task 对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Future-%E5%AF%B9%E8%B1%A1"><span class="toc-number">15.6.8.</span> <span class="toc-text">Future 对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">15.6.9.</span> <span class="toc-text">异步上下文管理器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-6-GIL-%E9%94%81%E4%B8%8E-Python-%E5%B9%B6%E5%8F%91%E6%80%A7%E8%83%BD"><span class="toc-number">15.7.</span> <span class="toc-text">14.6 GIL 锁与 Python 并发性能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GIL-%E7%9A%84%E6%9C%AC%E8%B4%A8%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">15.7.1.</span> <span class="toc-text">GIL 的本质与工作原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">15.7.2.</span> <span class="toc-text">并发与并行的区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="toc-number">15.7.3.</span> <span class="toc-text">线程安全与并发控制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E7%A4%BA%E4%BE%8B"><span class="toc-number">15.7.3.1.</span> <span class="toc-text">线程安全问题示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%BA%BF%E7%A8%8B%E9%94%81%E8%A7%A3%E5%86%B3%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="toc-number">15.7.3.2.</span> <span class="toc-text">使用线程锁解决安全问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Python-%E4%B8%AD%E7%9A%84%E9%94%81%E6%9C%BA%E5%88%B6%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90"><span class="toc-number">15.7.4.</span> <span class="toc-text">Python 中的锁机制全面解析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E9%94%81%E7%B1%BB%E5%9E%8B%E5%8F%8A%E5%85%B6%E7%89%B9%E6%80%A7"><span class="toc-number">15.7.4.1.</span> <span class="toc-text">Python 锁类型及其特性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%94%81-Lock"><span class="toc-number">15.7.4.2.</span> <span class="toc-text">互斥锁(Lock)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81-RLock"><span class="toc-number">15.7.4.3.</span> <span class="toc-text">可重入锁(RLock)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F-Condition-%E6%A0%B9%E6%8D%AE%E6%9D%A1%E4%BB%B6%E6%8E%A7%E5%88%B6%E9%94%81"><span class="toc-number">15.7.4.4.</span> <span class="toc-text">条件变量(Condition) - 根据条件控制锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F-Semaphore-%E6%8E%A7%E5%88%B6%E5%B9%B6%E5%8F%91%E6%95%B0%E9%87%8F"><span class="toc-number">15.7.4.5.</span> <span class="toc-text">信号量(Semaphore) - 控制并发数量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%89%E7%95%8C%E4%BF%A1%E5%8F%B7%E9%87%8F-BoundedSemaphore-%E8%AF%A6%E8%A7%A3"><span class="toc-number">15.7.4.6.</span> <span class="toc-text">有界信号量(BoundedSemaphore)详解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E5%AF%B9%E8%B1%A1-Event"><span class="toc-number">15.7.4.7.</span> <span class="toc-text">事件对象(Event)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%85%E6%A0%8F%E5%AF%B9%E8%B1%A1-Barrier"><span class="toc-number">15.7.4.8.</span> <span class="toc-text">栅栏对象(Barrier)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%98%9F%E5%88%97-Queue"><span class="toc-number">15.7.4.9.</span> <span class="toc-text">线程安全队列(Queue)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3"><span class="toc-number">15.7.4.10.</span> <span class="toc-text">死锁问题分析与解决</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">15.7.4.10.1.</span> <span class="toc-text">死锁示例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">15.7.4.10.2.</span> <span class="toc-text">死锁解决方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96"><span class="toc-number">15.7.5.</span> <span class="toc-text">原子操作与锁优化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#threading-local-%E5%AF%B9%E8%B1%A1-%E7%BA%BF%E7%A8%8B%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8"><span class="toc-number">15.7.5.1.</span> <span class="toc-text">threading.local 对象 - 线程本地存储</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#functools-lru-cache-%E5%B8%A6%E9%94%81%E7%9A%84%E7%BC%93%E5%AD%98"><span class="toc-number">15.7.5.2.</span> <span class="toc-text">functools.lru_cache 带锁的缓存</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%81%E7%9A%84%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">15.7.6.</span> <span class="toc-text">锁的高级应用模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E9%94%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">15.7.6.1.</span> <span class="toc-text">读写锁模式</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-readerwriterlock-%E5%BA%93%E5%AE%9E%E7%8E%B0%E8%AF%BB%E5%86%99%E9%94%81"><span class="toc-number">15.7.6.1.1.</span> <span class="toc-text">使用 readerwriterlock 库实现读写锁</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%94%81%E6%8E%92%E5%BA%8F%EF%BC%88%E8%A7%A3%E5%86%B3%E6%AD%BB%E9%94%81%EF%BC%89"><span class="toc-number">15.7.6.1.2.</span> <span class="toc-text">锁排序（解决死锁）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%A4%E9%98%B6%E6%AE%B5%E9%94%81%E5%AE%9A"><span class="toc-number">15.7.6.1.3.</span> <span class="toc-text">两阶段锁定</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E9%87%8D%E8%AF%95%E6%A8%A1%E5%BC%8F"><span class="toc-number">15.7.6.1.4.</span> <span class="toc-text">超时重试模式</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BB%93%E5%90%88%E7%9A%84%E6%B7%B7%E5%90%88%E6%A8%A1%E5%9E%8B"><span class="toc-number">15.7.6.2.</span> <span class="toc-text">多进程与多线程结合的混合模型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%86%E7%B2%92%E5%BA%A6%E9%94%81%E4%B8%8E%E7%B2%97%E7%B2%92%E5%BA%A6%E9%94%81"><span class="toc-number">15.7.6.3.</span> <span class="toc-text">细粒度锁与粗粒度锁</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-7-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1"><span class="toc-number">15.8.</span> <span class="toc-text">14.7 消息队列与进程通信</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">15.8.1.</span> <span class="toc-text">队列基础知识</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">15.8.2.</span> <span class="toc-text">队列使用示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%85%88%E7%BA%A7%E9%98%9F%E5%88%97%E7%A4%BA%E4%BE%8B"><span class="toc-number">15.8.3.</span> <span class="toc-text">优先级队列示例</span></a></li></ol></li></ol></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/06/19/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%8B%E7%AF%87/" title="Python教程：应用之巅"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c7d81.webp" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" alt="Python教程：应用之巅"></a><div class="content"><a class="title" href="/2025/06/19/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%8B%E7%AF%87/" title="Python教程：应用之巅">Python教程：应用之巅</a><time datetime="2025-06-19T06:00:00.000Z" title="发表于 2025-06-19 14:00:00">2025-06-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/" title="Python教程：深入其境"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c5e0c.webp" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" alt="Python教程：深入其境"></a><div class="content"><a class="title" href="/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/" title="Python教程：深入其境">Python教程：深入其境</a><time datetime="2025-06-18T02:00:00.000Z" title="发表于 2025-06-18 10:00:00">2025-06-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/" title="Python教程：Python知识点前篇速览"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c39b1.webp" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" alt="Python教程：Python知识点前篇速览"></a><div class="content"><a class="title" href="/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/" title="Python教程：Python知识点前篇速览">Python教程：Python知识点前篇速览</a><time datetime="2025-06-17T07:05:54.000Z" title="发表于 2025-06-17 15:05:54">2025-06-17</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:3381292732@qq.com" rel="external nofollow noreferrer" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://weibo.com/u/7484736298?tabtype=home" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/16/684f745b722d7.webp" size="50px"><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Prorise-cool" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://space.bilibili.com/361040115?spm_id_from=333.788.0.0" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div id="workboard"><div id="runtimeTextTip"></div></div><div class="footer_custom_text">这是我的个人博客，分享技术与生活点滴。</div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener external nofollow noreferrer" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.foreverblog.cn/">十年之约</a></div></div><div class="footer-group"><div class="footer-title">主题</div><div class="footer-links"><a class="footer-item" title="文档" href="/docs/">文档</a><a class="footer-item" title="源码" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu">源码</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" rel="external nofollow noreferrer" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="博客框架为Hexo7.0" title="博客框架为Hexo7.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo7.0"></a><a class="github-badge" target="_blank" href="https://www.dogecloud.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站使用多吉云为静态资源提供CDN加速" title="本站使用多吉云为静态资源提供CDN加速"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/CDN-多吉云-3693F3.svg" alt="本站使用多吉云为静态资源提供CDN加速"></a><a class="github-badge" target="_blank" href="https://github.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站采用CC BY-NC-SA 4.0协议" title="本站采用CC BY-NC-SA 4.0协议"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用CC BY-NC-SA 4.0协议"></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">©2025 By <a class="footer-bar-link" href="/about/" title="Prorise" target="_blank">Prorise</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = ["生活明朗, 万物可爱, 人间值得, 未来可期.","愿你眼里的星星，永远亮晶晶。","愿我们每个人都能被世界温柔以待。"]
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/typed.js/2.0.12/typed.min.js').then(subtitleType)
  }
} else {
  subtitleType()
}</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Prorise-cool?tab=repositories" title="网站源码">网站源码</a><a class="footer-bar-link" target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn/" title="湘ICP备23041-302号">湘ICP备23041-302号</a><a class="footer-bar-link cc" href="/copyright" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">2</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" rel="external nofollow noreferrer" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="后续项目..."><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="后续项目..."><span class="back-menu-item-text">后续项目...</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>个人</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="fas fa-check-double faa-tada"></i><span> 代办清单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>预览</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?server=netease&amp;id=3117791189"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/messages/"><i class="fas fa-comments faa-tada"></i><span> 评论总览</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 即刻短文</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Python/" style="font-size:.88rem">Python<sup>3</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight,500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="anzhiyufont anzhiyu-icon-comment-sms"></i></button><button id="to_comment" type="button" title="直达评论" onclick="FixedCommentBtn()"><i class="anzhiyufont anzhiyu-icon-comments"></i></button><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" rel="external nofollow noreferrer" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="3117791189" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=3117791189&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async="" src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>//- 从这里开始的所有JS代码，都必须有缩进（例如2个空格）
// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("06/10/2025 00:00:00"); // 此处读取您配置中的建站时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  
  // --- 已将您的专属LOGO和个人信息集成到这里 ---
  const ascll = [
    `欢迎访问 Prorise 的数字空间!`,
    `代码构建世界，思想驱动未来`,
    // 这里的反引号和所有ASCII art行，都必须有正确的缩进
    `
     ____                      _             
    |  _ \\  _ __   ___   _ __  (_) ___   ___  
    | |_) || '__| / _ \\ | '__| | |/ __| / _ \\ 
    |  __/ | |   | (_) || |    | |\\__ \\|  __/ 
    |_|    |_|    \\___/ |_|    |_||___/ \\___| 
                                             
    `,
    "已稳定运行",
    dnum,
    "天",
    `©2025 By Prorise 1.0.0`,
  ];
  
  const ascll2 = [`SYS-INFO`, `前置摄像头拍照成功`, `您的帅气脸庞为：`, `😎`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c${ascll[2]} \n%c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF; font-family:monospace;",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );

  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，朋友.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Created by Prorise %c 你正在访问 Prorise 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 注意，你的所有操作已被记录.", "color:white; background-color:#d9534f", "")
  );
});</script><script async="" src="/anzhiyu/random.js"></script><script async="">(function () {
  var grt = new Date("06/10/2025 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "";
        img.title = "下班了就该开开心心的玩耍，嘿嘿~";
        img.alt = "下班了就该开开心心的玩耍，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js').then(runMermaid)
  }

  anzhiyu.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.prorise666.site/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.prorise666.site/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  let initFn = window.walineFn || null

  const initWaline = (Fn) => {
    const waline = Fn(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://waline.prorise666.site',
      pageview: true,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: true,
      imageUploader: true,
    }, null))

    const destroyWaline = () => {
      waline.destroy()
    }

    anzhiyu.addGlobalFn('pjax', destroyWaline, 'destroyWaline')
  }

  const loadWaline = async () => {
    if (initFn) initWaline(initFn)
    else {
      await getCSS('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline.css')
      if (true) await getCSS('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline-meta.css')
      const { init } = await import('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline.js')
      initFn = init || Waline.init
      initWaline(initFn)
      window.walineFn = initFn
    }
  }

  if ('Twikoo' === 'Waline' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async="" src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.prorise666.site/',
        region: 'ap-shanghai',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async="" data-pjax="" src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail=""</script><script async="" data-pjax="" src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="/js/load-on-demand.js"></script><script defer="" id="fluttering_ribbon" mobile="false" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="" color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script id="click-heart" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="" mobile="false"></script><script src="//code.tidio.co//tk571vck0ua2wjoalfbp8wyrlsdaunmz.js" async=""></script><script>(() => {
  const isChatBtn = true
  const isChatHideShow = true

  if (isChatBtn) {
    let isShow = false
    const close = () => {
      window.tidioChatApi.hide()
      isShow = false
      document.body.style.position = 'relative';
      document.documentElement.style.overflow = 'auto'
    }
    
    const open = () => {
      window.tidioChatApi.open()
      window.tidioChatApi.show()
      isShow = true
    }

    const onTidioChatApiReady = () => {
      window.tidioChatApi.hide()
      window.tidioChatApi.on("close", close)
    }
    if (window.tidioChatApi) {
      window.tidioChatApi.on("ready", onTidioChatApiReady)
    } else {
      document.addEventListener("tidioChat-ready", onTidioChatApiReady)
    }

    window.chatBtnFn = () => {
      if (!window.tidioChatApi) return
      isShow ? close() : open()
    }
  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => {
        window.tidioChatApi && window.tidioChatApi.hide()
      },
      show: () => {
        window.tidioChatApi && window.tidioChatApi.show()
      }
    }
  }
})()</script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://npm.elemecdn.com/meting@2.0.1/dist/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '[object Object]', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div>
    <link rel="stylesheet" href="https://ai.tianli0.top/static/public/postChatUser_summary.min.css">
    <script>
        let tianliGPT_key = '';
        let tianliGPT_postSelector = '#post-container .post-content';
        let tianliGPT_Title = '✨ AI 文章摘要';
        let tianliGPT_postURL = '/^https?:\/\/[^\/]+\/[0-9]{4}\/[0-9]{2}\/[0-9]{2}\/';
        let tianliGPT_blacklist = '';
        let tianliGPT_wordLimit = '1000';
        let tianliGPT_typingAnimate = true;
        let tianliGPT_theme = 'default';
        var postChatConfig = {
          backgroundColor: "#4d648d",
          bottom: "76px",
          left: "16px",
          fill: "#FFFFFF",
          width: "50px",
          frameWidth: "380px",
          frameHeight: "600px",
          defaultInput: true,
          upLoadWeb: true,
          showInviteLink: true,
          userTitle: "💬 智能助手",
          userDesc: "我是 Prorise 博客的 AI 助手，有任何关于网站内容的问题都可以问我哦～",
          addButton: true,
          beginningText: "这篇文章介绍了",
          userIcon: "https://ai.tianli0.top/static/img/PostChat.webp",
          userMode: "magic",
          defaultChatQuestions: ["你好","你是谁"],
          defaultSearchQuestions: ["视频压缩","设计"]
        };
    </script>
    <script data-postchat_key="" src="https://ai.tianli0.top/static/public/tianli_gpt.min.js"></script>
  </body></html>