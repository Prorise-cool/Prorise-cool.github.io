<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Python教程：深入其境 | 格物致知</title><meta name="keywords" content="Python函数, Python类, 面向对象, 文件操作, 模块"><meta name="author" content="Prorise"><meta name="copyright" content="Prorise"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#cee8ff"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Python教程：深入其境"><meta name="application-name" content="Python教程：深入其境"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#cee8ff"><meta property="og:type" content="article"><meta property="og:title" content="Python教程：深入其境"><meta property="og:url" content="https://prorise-cool.github.io/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/index.html"><meta property="og:site_name" content="格物致知"><meta property="og:description" content="Python系列教程进阶篇：深入其境。本篇将聚焦Python的核心应用，详细讲解Python在实际运用上的便利之处"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2025/06/17/685113b7c5e0c.webp"><meta property="article:author" content="Prorise"><meta property="article:tag" content="全栈, Full Stack, 前端, 后端, Node.js, Vue, React, 数据库, Linux, Docker, 个人博客, 技术分享"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2025/06/17/685113b7c5e0c.webp"><meta name="description" content="Python系列教程进阶篇：深入其境。本篇将聚焦Python的核心应用，详细讲解Python在实际运用上的便利之处"><link rel="shortcut icon" href="/img/icons/favicon.ico"><link rel="canonical" href="https://prorise-cool.github.io/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="code-xxx"><meta name="msvalidate.01" content="xxx"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media=&quot;all&quot;"><script async="" src="https://www.googletagmanager.com/gtag/js?id=[object Object]"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","[object Object]")</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"与数百名博主无限进步","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"Prorise","mode":"tianli","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"S-DNA1JM95BX2F9L0N","Referer":"https://xx.xx/"},
  diytitle: undefined,
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo.prorise666.site/',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":4000,"accessToken":"b39753735ed0ed5ffeb771bc108e3158","mailMd5":"ec3291d59a8d7d3675df8a0537fcbc979f0fa611c8df55841fb7f4fd162bd07a"},
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"both","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["🤣 全栈开发工程师","🙂 前端架构设计师","🙃 后端服务构建者","🤩 移动端应用开发","🤯 数据库设计专家","🥳 DevOps运维实践者","🤭 技术栈多面手","😎 性能优化达人"]},
  algolia: {"appId":"K8Y7M0RMXQ","apiKey":"11fa7380e2694483a44b143044e69e6e","indexName":"prorise_blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":3,"position":"top","messagePrev":"距离上次更新已经过了","messageNext":"天，文章内容可能已经过时。"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Prorise","link":"链接: ","source":"来源: 格物致知","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"格物致知",title:"Python教程：深入其境",postAI:"true",pageFillDescription:"第十五章：Python 网络编程全解析, 15.1 网络编程基础, 15.2 Socket 编程详解, 15.2.1 TCP 套接字, TCP 套接字特性, Python 中的 TCP 客户端示例, Python 中的 TCP 服务器示例, 15.2.2 UDP 套接字, UDP 套接字特性, Python 中的 UDP 客户端示例, Python 中的 UDP 服务器示例, 15.2.3 TCP 与 UDP 对比, 15.3 通用网络协议与 Python 实现, 15.3.1 HTTPx2FHTTPS 协议, HTTPx2FHTTPS 协议特性, Python 标准库 HTTP 客户端, 推荐的第三方 HTTP 库, requests 库示例, aiohttp 异步 HTTP 示例, 15.3.2 FTPx2FSFTP 协议, FTPx2FSFTP 协议特性, Python 标准库 FTP 客户端, 快速搭建一个本地的 FTP 服务器, 实现 FTP 文件上传下载, 推荐的 FTPx2FSFTP 第三方库, 15.3.3 WebSocket 协议, WebSocket 协议特性, 推荐的 WebSocket 第三方库, websockets 库示例, 使用 websockets 实现在线聊天室, 15.3.4 MQTT 协议, MQTT 应用场景, 1.物联网 (IoT) - 核心领域, 2.工业物联网 (IIoT) 与 SCADA, 3.车联网 (IoV) 与远程信息处理 (Telematics), MQTT 协议特性, 推荐的 MQTT 第三方库, paho-mqtt 示例, 15.3.5 WebRTC 协议, 1.WebRTC 协议特性, 2.P2P 通信原理, 3.常用 API, 4. 项目实践 (Vue3 + Flask-SocketIO), 1.项目初始化, 2.实现连接与房间加入, 3.实现呼叫信令 (请求x2F接受x2F挂断), 4.获取媒体流、创建 PeerConnection 并交换 SDP, 5.实现 ICE Candidate 交换与显示远端流, 最终完整后端代码 (server_flask.py), 最终完整前端代码 (src/App.vue), 5.进阶实现+调优, 实战  通过 aiortc 做一个超低延迟摄像头转播, 前端代码（采用 VUE3+daisyui+tailwindcss 实现）, 后端, 15.3.6 视频流协议(RTMPx2FRTSPx2FHLS), 主要视频流协议对比, 认识必要的两个库, 读取 RTSP 视频流 (使用 opencv-python), EasyRTSPServer Simulator 工具使用, 15.3.7.2 推送 RTMP 直播流 (使用 ffmpeg-python), 15.4 网络安全与加密, 15.4.1 TLSx2FSSL 加密通信：保障传输通道安全, TLSx2FSSL 的关键特性与安全意义, Python 中的 TLSx2FSSL 支持：ssl 模块, 示例 1：创建一个安全的 TLSx2FSSL 客户端, 示例 2：创建一个基础的 TLSx2FSSL 服务器, 15.4.2 数据摘要与哈希函数 (Hashing)：验证数据完整性, Python 中的哈希支持：hashlib 模块, 常用哈希算法对比与选择, 示例 1：计算数据的哈希值, 示例 2：安全的密码存储（加盐哈希）, HMAC：带密钥的哈希用于消息认证, Python 中的 HMAC 支持：hmac 模块, 15.4.3 数据编码 (Data Encoding)：安全传输的变形术, Base64 编码：, URL 编码 (Percent-Encoding)：, 15.4.4 对称加密 (Symmetric Encryption)：共享同一把钥匙的保险箱, DES 和 3DES (Data Encryption Standard)：昔日标准【绝对避免】, AES (Advanced Encryption Standard)：现代对称加密的基石, 15.4.4.1 AES 块加密操作模式 - 【使用 AES 的关键！】, ECB (Electronic Codebook) 模式：【极其危险禁止使用！】, CBC (Cipher Block Chaining) 模式：【常用需正确管理 IV】, GCM (Galois/Counter Mode) 模式：【强烈推荐认证加密】, 其他模式, 15.4.4.2 Python 实现 AES 加密 (使用 cryptography 库), 示例 1：使用 AES-GCM (推荐模式), 示例 2：使用 AES-CBC (如果必须使用且理解其局限性), 15.4.5 非对称加密 (Asymmetric Encryption)：公钥与私钥的世界, RSA (Rivest–Shamir–Adleman)：应用最广泛的非对称算法, Python 实现 RSA (使用 cryptography 库), 其他重要非对称算法：ECC (椭圆曲线密码学), 第十六章 操作数据库, 16.1 SQLite 数据库：构建一个分层操作框架, 16.1.1 项目结构设置, 16.1.2 核心层实现 (core/), 数据库管理器 (core/db_manager.py), 表管理器 (core/table_manager.py), 16.1.3 数据模型层实现 (models/), 前置知识：使用 @dataclass 简化 Python 类定义, 任务模型 (models/task.py - 使用 @dataclass), 16.1.4 数据访问层实现 (repositories/), 任务仓库 (repositories/task_repository.py ), 16.1.5 业务逻辑层实现 (services/), 任务服务 (services/task_service.py ), 16.1.7 使用示例 (examples/), 16.1.7.1 基本操作示例 (examples/basic_operations.py), 16.1.7.2 高级查询示例 (examples/advanced_queries.py), 16.2 MySQL 数据库 (使用 PyMySQL 驱动), 16.2.5 数据库操作：CRUD 与查询详解, 16.2.5.1 插入数据 (INSERT), 插入单行记录, 批量插入记录 (executemany), 16.2.5.2 更新数据 (UPDATE), 16.2.5.3 删除数据 (DELETE), 16.2.5.4 查询数据 (SELECT) - 基础, 查询所有列 (*), 查询指定列, 16.2.5.5 查询数据 (SELECT) - 条件过滤 (WHERE), 等于 (x3D), 比较运算符 (gt ltx3D), BETWEEN … AND …区间查询, IN (…), LIKE (模糊匹配), IS NULL x2F IS NOT NULL, 组合条件 (AND OR NOT), 16.2.5.6 查询数据 (SELECT) - 排序 (ORDER BY), 单列排序 (ASCx2FDESC), 多列排序, 16.2.5.7 查询数据 (SELECT) - 去重 (DISTINCT), 16.2.5.8 查询数据 (SELECT) - 聚合函数, 16.2.5.9 查询数据 (SELECT) - 分组 (GROUP BY), 16.2.5.10 查询数据 (SELECT) - 分组过滤 (HAVING), 16.2.5.11 查询数据 (SELECT) - 分页 (LIMITx2FOFFSET), 16.2.5.12 查询数据 (SELECT) - 连接查询 (JOIN), 内连接 (INNER JOIN), 左连接 (LEFT JOIN), 16.2.5.13 查询数据 (SELECT) - CASE 表达式, 16.2.5.14 查询数据 (SELECT) - 子查询 (Subquery), 16.3 SQLAlchemy Core SQL 表达式语言, 16.3.1 引擎 (Engine) 数据库连接的入口, 16.3.2. 元数据与表定义, 16.3.3. 执行 SQL 表达式语句, 插入单行记录, 批量插入记录 (INSERT Multiple), 更新数据 (UPDATE), 批量更新记录 (UPDATE Multiple), 删除数据 (DELETE), 批量删除记录 (DELETE Multiple), 查询数据 (SELECT - 基础), 查询数据 (SELECT - 条件过滤 WHERE), 查询数据 (SELECT - 排序 ORDER BY), 查询数据 (SELECT - 去重 DISTINCT), 查询数据 (SELECT - 聚合函数), 查询数据 (SELECT - 分组 GROUP BY), 查询数据 (SELECT - 分页 LIMITx2FOFFSET), 查询数据 (SELECT - 连接查询 JOIN), 查询数据 (SELECT - CASE 表达式), 查询数据 (SELECT - 子查询 Subquery), SQLAlchemy 数据库函数 (func), 16.3.4 SQLAlchemy ORM 对象关系映射, 16.3.3.1. Session ORM 的数据库交互句柄, 16.3.3.2. 声明式映射 (Declarative Mapping) 定义模型, 16.3.3.3. 定义关系 (relationship), 16.3.3.4. ORM CRUD 操作 (使用 Session 和 select), 16.3.3.5 运行示例测试, 16.4 mybatis-py 轻量级 Python SQL 映射器, 16.4.1 核心知识, 16.4.2 实战 (Flask Integration), 第十七章 音视频处理, 17.1 FFmpeg 介绍、核心概念、安装与 Python 交互方式, 17.1.1 FFmpeg：音视频领域的瑞士军刀, ffmpeg (命令行工具), ffprobe (命令行工具), ffplay (命令行工具), 核心库 (libav*), 17.1.2 音视频基础概念, 17.1.3 安装 FFmpeg 命令行工具 (重要前提！), Windows 安装与配置, macOS 安装, Linux 安装, 17.1.4 Python 交互方式的选择与 ffmpeg-python 安装, subprocess 模块 (基础方式), ffmpeg-python 库 (推荐), 17.2 FFmpeg 命令行结构, 17.2.1 FFmpeg 命令行结构详解, 选项的作用域与顺序, 全局选项 (Global Options), 输入选项 (Input Options), 输出选项 (Output Options), 复杂滤镜（-filter_complex）, 17.2.2 **常用滤镜 (-vf -af) **, (1) 模糊 (boxblur), (2) 变色, (a) colorbalance, (b) colorchannelmixer, (d) lutyuv x2F lutrgb, 参数说明, 命令行示例 (lutyuv), 效果图, 重要说明：基于表达式的 LUT vs 加载 LUT 预设文件, (3) 裁剪 (crop), (4) 去 Logo (delogo), (5) 加边框 (drawbox), (6) 画网格 (drawgrid), (7) 添加字幕 (subtitles 或 drawtext), (8) 画边缘 (edgedetect), (9) EQ 效果 (eq), (10) 缩放 (scale), (11) 等比放大 (hqx), (12) 横向倒置 (hflip), (13) 纵向倒置 (vflip), (14) 加噪音 (noise), (15) 加水印 (overlay), (16) 加底板x2F画布扩展 (pad), (17) 旋转 (rotate), (18) 光晕x2F晕影 (vignette), (19) 淡入淡出 (fade afade), (20) 旋转 90x2F180x2F270 度 (transpose), (21) 改变播放速度 (setpts atempo), (22) 绘制文本 (drawtext) 详解, (23) 视频堆叠 (hstack vstack xstack), (24) 锐化 (unsharp smartblur), 17.2.3 流标识符 (Stream Specifiers) 详解, 17.2.4 FFmpeg 自身能力查询命令, 查看编解码器 (-encoders -decoders), 查看协议 (-protocols), 查看格式 (-formats), 查看和学习滤镜 (-filters -h filter=lt滤镜名gt), 获取完整帮助 (-h full), 17.2.5 ffprobe 获取文件信息详解 (深度解读), format 对象 (容器x2F文件级别信息), streams 列表 (流级别信息), Python 解析 ffprobe JSON 示例 (增强版), 17.3 ffmpeg-python 核心 API, 17.3.1 API ffmpeg.probe() - 探测媒体文件信息, 17.3.2 输入节点 (ffmpeg.input), 17.3.3 流 (Stream) 的概念与选择, 17.3.4 应用滤镜 (Stream.filter), 17.3.5 输出节点 (ffmpeg.output) 与输出选项详解 (表格优化版), 17.3.6 全局选项与调试工具 (.compile .view global_args), API Node.compile() - 查看生成的命令, API Node.view() - 可视化处理图, API 全局选项 (global_args in .run() x2F .run_async())第十五章网络编程全解析网络编程基础网络编程是强大的应用领域之一它使开发者能够创建通过网络通信的应用程序从简单的客户端服务器模型到复杂的分布式系统提供了丰富的标准库和第三方库来简化网络编程任务网络编程基本概念协议通信规则和格式的约定套接字网络通信的端点客户端服务器模型最常见的网络通信模式端口区分主机上不同应用程序的数字标识符地址标识网络上设备的地址网络编程的优势简洁的降低开发复杂度丰富的标准库和第三方库支持跨平台兼容性好适合快速原型开发和生产级应用在深入具体的协议和实现之前理解以下基础概念非常重要概念描述重要性七层模型网络通信的概念框架从物理层到应用层理解不同协议的位置和作用模型互联网的实际实现模型包括链路层网络层传输层和应用层掌握实际网络通信的基础套接字编程通过套接字进行网络通信的编程模型网络编程的基础阻塞与非阻塞不同的模型对网络编程效率的影响影响程序架构和性能深入理解网络编程中的不同层次使用不同的协议传输层常见的是和而应用层则有等提供了所有这些协议的编程接口编程详解套接字是网络编程的基础它提供了进程间通信的端点的模块实现了套接字标准套接字传输控制协议是一种面向连接的可靠的基于字节流的传输层通信协议套接字特性特性描述优点缺点连接导向使用前需要建立连接确保通信双方都准备好传输数据可靠传输通过确认机制保证数据传输保证数据完整性但增加延迟流控制通过滑动窗口机制控制发送速率防止接收方缓冲区溢出拥塞控制监测网络拥塞状态并调整发送速率防止网络拥塞崩溃字节流数据作为连续字节流处理需要自己定义消息边界中的客户端示例简单的客户端示例创建套接字连接服务器已连接到服务器发送请求接收响应收到字节的响应只显示前个字符连接已关闭调用客户端函数中的服务器示例处理客户端连接客户端套接字客户端地址接受来自的连接接收客户端数据处理数据收到字节的数据发送响应关闭连接与的连接已关闭简单的多线程服务器创建服务器套接字设置地址重用防止地址已在使用错误绑定地址和端口开始监听服务器启动监听端口接受客户端连接为每个客户端创建新线程服务器关闭中调用服务器函数套接字用户数据报协议是一种无连接的传输层协议它不保证数据传输的可靠性但具有较低的延迟套接字特性特性描述优点缺点无连接无需建立连接即可发送数据降低延迟但无法确保对方准备好不可靠传输不保证数据到达或顺序丢包风险但降低延迟数据报方式数据作为独立的包进行处理保留消息边界但有大小限制无流控制发送方可以任意速率发送数据可能导致网络拥塞和接收方缓冲区溢出低开销没有连接管理和可靠性保证的开销适合实时应用如视频流和游戏中的客户端示例简单的客户端示例创建套接字服务器地址发送消息已发送消息接收响应设置超时收到来自的响应接收响应超时套接字已关闭调用客户端函数中的服务器示例简单的服务器示例创建套接字绑定地址和端口服务器启动监听接收数据收到来自的字节数据处理接收到的数据收到消息发送响应服务器已收到服务器关闭中调用服务器函数与对比特性最适用场景连接需要建立连接无连接适合需要可靠通信的应用可靠性高确认重传排序低无保证适合文件传输网页浏览性能较低连接开销拥塞控制高低延迟适合实时多媒体游戏数据流字节流无边界数据报有边界适合流式传输适合消息传输头部大小字节选项字节适合小数据包场景流控拥塞控制有无适合防止网络拥塞的场景通用网络协议与实现本章节中我们会学习常见的协议其中较为常见的协议会比较简略带过仅提供示例以及推荐常用的第三方库等对于一些不常见而在我们开发中需要进阶使用的协议我们会进行详解协议超文本传输协议和安全的超文本传输协议是万维网的基础协议特性特性描述传输安全数据加密无加密加密默认端口服务器监听端口证书验证服务器身份验证无数字证书请求响应模式通信模式客户端请求服务器响应客户端请求服务器响应无状态不保存会话信息是是数据格式传输格式文本二进制加密的文本二进制标准库客户端使用标准库的客户端创建连接设置请求头发送请求获取响应状态码读取响应体解析响应用户名个人主页关闭连接运行示例推荐的第三方库库名特性适用场景安装命令重点简化的丰富的功能可读性强一般客户端需求重点异步客户端服务器高性能异步应用支持同步和异步和现代客户端需求低级客户端连接池重试需要细粒度控制的场景的绑定高性能复杂的客户端需求库示例使用库的示例设置请求参数发送请求自动检查错误解析响应用户名个人主页公开仓库数获取响应头信息响应头信息错误连接错误请求超时请求异常运行示例异步示例异步获取用户信息用户名获取用户失败主函数并发执行所有任务打印结果用户姓名仓库数运行异步函数协议文件传输协议和安全文件传输协议用于在网络中传输文件协议特性特性注意事项安全性不加密明文传输加密通道不适合传输敏感数据认证用户名密码明文认证机制支持密钥认证复杂性需要控制连接和数据连接单一连接需要处理主动被动模式防火墙兼容性较差需要多个端口良好单一端口可能需要特殊配置标准化无正式基于是协议的扩展默认端口控制数据端口端口数据端口不固定标准库客户端以下是中客户端常用的简洁总结使用表格展示方法描述使用场景创建一个对象用于连接到服务器登录到服务器进行身份验证改变当前目录切换服务器上的工作目录以二进制模式下载文件下载文件例如图片视频等以二进制模式上传文件上传文件例如图片视频等以文本模式获取文件内容获取文件内容并输出到控制台以文本模式上传文件上传文本文件例如配置文件创建目录在服务器上创建新目录删除目录删除服务器上的目录删除文件删除服务器上的文件退出连接断开与服务器的连接快速搭建一个本地的服务器配置服务器控制面板找到程序并打开程序界面找到启用或关闭功能并打开从启用或关闭功能弹窗中找到或者中文版信息服务并打开配置并点击确定第二步配置站点开始菜单搜索并点击进入管理器新建站点新增服务器根目录文件夹查看本机地址后续访问地址需要用到打开输入网站管理器界面左边导航栏找到网站右键弹出菜单配置网站测试站点先在物理路径随便放一个文件在浏览器访问就能看到预期的文件我们很有可能会遇到三个问题无论怎么输入都没有反应详细见下图在浏览器的浏览器设置中调整配置即可需要强制打开某某浏览器才能打开更换默认应用打开方式实现文件上传下载创建连接的上下文管理器确保连接正确关闭服务器地址服务器端口默认为用户名默认为匿名登录密码默认为服务器编码默认为连接超时时间秒默认为已连接的对象上传本地文件到服务器本地文件的完整路径服务器上的目标路径上传后的文件名服务器地址默认为服务器端口默认为用户名默认为匿名登录密码默认为上传成功返回否则返回切换至目标路径上传文件文件上传成功文件上传失败从服务器下载文件到本地服务器上的文件路径要下载的文件名本地保存路径服务器地址默认为服务器端口默认为用户名默认为匿名登录密码默认为下载成功返回否则返回切换至目标路径下载文件文件下载成功文件下载失败列出服务器上指定目录中的文件服务器上的目录路径服务器地址默认为服务器端口默认为用户名默认为匿名登录密码默认为文件名列表会对每一行调用传入的回调函数将每行内容作为参数传递给回调函数由于前三个字符为时间所以只取最后一个字段文件列表获取失败示例上传文件当前目录下的文件服务器上的目标目录上传后的文件名示例下载文件将刚上传的文件下载回来使用不同的名称以便比较示例列出目录中的文件服务器上的文件列表推荐的第三方库库名特性适用场景安装命令客户端服务器实现需要安全文件传输基于的高级客户端简化的操作客户端类似文件系统复杂的操作异步客户端服务器高性能异步文件传输基于的简单文件复制简单文件传输需求协议协议提供了在单个连接上进行全双工通信的能力特别适用于需要实时通信的应用协议特性特性描述优势全双工通信客户端和服务器可以同时发送和接收数据减少延迟提高实时性持久连接建立一次连接后长期保持减少连接建立的开销低延迟无需为每个消息建立新连接适合实时应用如聊天游戏基于在可靠传输之上构建保证消息可靠送达支持二进制和文本可传输任何类型的数据适用范围广泛标准化定义广泛支持客户端兼容性好推荐的第三方库库名特性适用场景安装命令纯异步实现异步应用免费简单的连接调用全面的应用网络搜索库示例方法描述使用场景创建应用实例用于初始化客户端启动客户端并保持连接用于运行连接保持客户端在线发送消息到服务器向服务器发送数据接收来自服务器的消息从服务器接收消息关闭连接关闭连接处理接收到的消息事件用于定义接收到消息时的回调函数处理错误事件用于定义错误发生时的回调函数处理连接关闭事件用于定义连接关闭时的回调函数处理连接打开事件用于定义连接建立时的回调函数使用实现在线聊天室前端实现可以不用理解直接复制到文件即可聊天应用消息动画系统消息样式标题栏聊天应用用户头像个人信息用户名输入用户名选择头像在线用户在线用户列表在线用户我消息区域若没有消息显示空状态暂无消息开始聊天吧若有消息则显示消息列表系统消息聊天消息输入区域请输入你要发送的内容发送连接服务器断开连接连接状态提示数据连接状态消息列表新消息内容我当前用户消息容器引用连接错误信息用户头像客户端在线用户列表计算属性已连接未连接监听属性变化监听消息列表变化自动滚动到底部方法判断是否是自己发送的消息更新用户信息发送用户信息错误选择头像连接连接出错请检查服务器是否运行连接失败处理心跳信息用户主动断开连接消息处理处理欢迎消息保存客户端更新在线用户列表更新用户信息处理聊天消息处理系统消息处理错误消息消息处理错误关闭连接连接意外关闭连接已关闭发送消息消息发送错误组件挂载后自动连接自动连接可选取消注释下行开启配置日志服务器类处理客户端连接和消息通信初始化服务器服务器主机名或地址服务器端口号使用字典存储客户端连接键为客户端存储客户端信息如用户名和头像定义消息处理器映射处理从客户端接收到的消息客户端收到的消息内容消息格式不是有效的处理消息时出错服务器处理消息时出错处理解析后的消息数据验证消息格式消息格式错误缺少字段获取并执行对应的处理器不支持的消息类型处理用户信息更新用户信息不完整需要和字段更新用户信息通知所有客户端有用户信息更新用户信息更新处理聊天消息消息缺少字段匿名用户添加发送者广播消息来自处理消息发送错误消息到客户端发送消息到特定客户端广播消息给所有客户端要广播的消息要排除的客户端可选处理连接的主函数客户端连接生成客户端添加新的客户端连接用户客户端连接连接处理出错处理新客户端连接发送客户端和欢迎消息已连接到服务器发送当前在线用户列表匿名用户通知所有客户端有新用户加入只有当有多个客户端时才广播匿名用户用户加入聊天当前共有名用户处理客户端消息流处理客户端断开连接获取用户名以便在通知中使用匿名用户从集合中移除断开的客户端通知其他客户端有用户离开只有当还有其他客户端时才广播用户离开聊天当前共有名用户启动服务器启动服务器无限期运行服务器运行服务器阻塞调用服务器已通过键盘中断信号停止服务器出错创建并运行服务器实例协议是一种基于发布订阅模式的轻量级消息传输协议它专门为低带宽高延迟或不可靠的网络环境下的资源受限设备如传感器嵌入式设备设计最初由开发现已成为国际标准为什么选择轻量高效协议开销极小最小报文仅字节显著降低网络带宽消耗适合物联网场景中电池供电或蜂窝网络连接的设备低功耗协议设计有助于减少客户端设备的能耗可靠传输提供三种服务质量等级确保在不稳定网络下的消息传输可靠性发布订阅模式发送者和接收者通过中心代理解耦无需知道对方的存在甚至可以不同时在线取决于和会话设置易于扩展设计上支持大量客户端并发连接与常见协议对比对于请求响应模式更简单但头部开销大每次通信通常需要建立新连接尤其对于频繁的小数据包且服务器主动推送数据给客户端长轮询相对复杂或效率不高选择的场景频繁小数据量的传输低功耗低带宽环境需要服务端主动推送消息受限应用协议同样面向资源受限设备基于常被视为在领域的竞争者或补充更偏向风格提供基于单个连接的全双工通信适合需要实时交互的应用但协议本身可能比更重应用场景物联网核心领域传感器数据采集环境监测智能楼宇智慧城市中的温度湿度空气质量光照强度等传感器数据上传农业物联网土壤湿度温度作物生长环境监测可穿戴设备智能手环手表收集用户的步数心率睡眠数据并上传到云端远程控制与状态同步智能家居控制智能灯泡开关亮度颜色智能插座空调窗帘等获取门锁状态家电运行状态保留消息在此场景中非常有用用于获取设备当前状态共享单车充电宝实时上报位置信息电量状态开关锁状态工业物联网与设备远程监控与预警工厂生产线设备如机器人运行状态能耗数据故障代码的实时上传与监控石油天然气管道压力流量温度等参数监测电力系统智能电表数据采集与远程控制预测性维护收集设备振动温度等数据利用大数据分析预测潜在故障提前进行维护系统集成作为一种轻量级协议越来越多地被用于连接传统的系统和现代的云平台或移动应用车联网与远程信息处理车辆状态监控实时上传车辆位置速度油耗发动机转速电池电压故障码数据等远程控制远程锁车解锁启动空调鸣笛闪灯等驾驶行为分析收集急加速急刹车急转弯等数据用于保险或车队管理信息推送推送路况信息导航更新软件更新通知更新通常结合处理大文件下载用于触发和状态同步为什么这些场景适合大量连接车联网通常涉及海量设备连接低带宽不稳定网络很多设备通过蜂窝网络或连接网络条件可能不佳资源受限许多设备是电池供电的嵌入式系统实时性要求需要及时获取设备状态或数据数据驱动主要是设备向云端上报数据或云端向设备下发指令协议特性特性描述优势级别提供三种服务质量级别可根据需要平衡可靠性与资源消耗保留消息服务器保存最后一条消息给新订阅者确保新连接设备能获得最新状态持久会话客户端断开后可恢复订阅提高系统稳定性和容错性遗嘱消息客户端异常断开时发布的特定消息便于检测设备异常离线小型客户端代码占用空间小适合嵌入式设备和应用推荐的第三方库库名特性适用场景安装命令完整客户端实现通用应用异步客户端基于的应用纯实现的客户端服务器需要轻量级服务器异步服务器和客户端需要高性能服务器示例建议添加编码声明用于生成更唯一的用于替代输出日志配置日志记录器使用的客户端封装示例带注释和改进建议官方文档添加证书参数明确控制会话类型允许传入用户数据初始化客户端地址端口常见客户端如果为或空字符串会自动生成但不利于持久会话对于持久会话必须提供一个固定且唯一的建议使用设备序列号或其他唯一标识符默认自动生成一个是否启用加密连接默认为连接所需的用户名默认为连接所需的密码默认为证书文件路径用于验证证书默认为客户端证书文件路径用于双向认证默认为客户端私钥文件路径用于双向认证默认为控制会话类型清洁会话断开连接时清除所有会话信息订阅离线消息持久会话断开连接时保留订阅和离线消息需要固定默认为传递给回调函数的用户自定义数据客户端处理如果未提供生成一个基于的更不容易冲突未提供自动生成注意这不利于使用持久会话对于自动生成的隐含用于跟踪已订阅的主题创建客户端实例是默认值也可选设置认证信息检查是否也提供了提供了用户名但未提供密码配置端口通常需要改为或指定的端口启用但端口仍为通常非端口请确认配置常用端口为更精细的配置强制验证服务器证书建议指定安全的版本如果提供了证书则需要验证推荐使用或更高如果需要忽略主机名验证不推荐有安全风险证书文件未找到重新抛出异常阻止后续连接尝试配置错误注册回调函数增加取消订阅回调增加日志回调用于调试日志回调方便调试内部信息可以根据过滤日志级别只记录警告及以上级别连接回调连接结果代码连接成功连接被拒绝不可接受的协议版本连接被拒绝标识符被拒绝例如无效或已被使用连接被拒绝服务器不可用连接被拒绝错误的用户名或密码连接被拒绝未授权成功连接到最佳实践在连接成功后重新订阅之前的主题特别是对于非持久会话重新订阅之前的主题调用封装的方法连接失败返回码未知错误可以在这里添加重连逻辑也可以抛出异常断开连接回调已主动断开与的连接非表示意外断开与的连接意外断开返回码可能需要重连实践在这里实现自动重连逻辑带退避策略消息接收回调尝试使用解码这是最常见的文本编码收到消息主题原始载荷记录原始字节消息内容尝试解析如果你的应用主要使用解析后内容在这里处理你的业务逻辑例如如果载荷不是有效的按普通字符串处理或根据业务逻辑处理消息载荷不是有效的格式处理消息时发生错误记录详细错误堆栈如果载荷不是编码例如二进制数据收到无法以解码的消息主题消息载荷在这里处理二进制数据或其他编码的数据处理回调时发生严重错误消息发布回调和会触发与方法返回的对应消息已发布成功注意这只表示消息已成功发送给不代表订阅者已收到尤其是订阅回调消息与返回的对应实际授予的等级列表可能低于请求的例如请求返回可能是订阅成功授予的注意是一个元组即使只订阅一个主题取消订阅回调取消订阅成功连接到心跳间隔秒数客户端会以此间隔发送若在内未收到任何消息会认为客户端断开默认秒设置为表示禁用心跳不推荐绑定本地网络接口地址默认为空客户端已连接无需重复连接设置遗嘱消息建议使用格式包含状态和时间戳遗嘱消息的建议为或已设置遗嘱消息主题载荷设置遗嘱消息失败尝试连接到是阻塞的直到连接完成或失败是非阻塞的需要配合或启动后台网络循环线程会启动一个新线程来处理网络流量收发消息心跳重连等这是最常用的方式因为它不会阻塞主线程后台网络循环已启动另一种方式是它会阻塞当前线程直到调用适用于简单的脚本或主线程无其他任务的情况网络循环启动将阻塞主线程也可以手动调用或在自己的循环中处理网络事件较少用处理一次网络事件最多等待秒连接错误请检查是否启用了以及端口是否正确通常是连接被拒绝请检查地址端口是否正确以及服务是否运行网络错误例如无法解析主机名或网络不可达连接过程中发生未知错误确保停止可能已启动的循环主动正常地断开与的连接客户端未连接无需断开准备主动断开连接最佳实践在主动断开前发布一个表示正常离线的状态消息如果需要这与遗嘱消息不同遗嘱表示意外离线使用确保送达更新最终状态已发布正常离线状态主题可能需要短暂等待确保消息发出发布离线状态失败停止后台网络循环线程必须在之前或之后调用后台网络循环已停止主动断开连接调用后回调会被触发发布消息到指定主题目标主题消息内容如果是会自动转换为字符串其他类型会尝试转换为字符串再编码为可以直接传入服务质量等级默认为是否将此消息设置为保留消息默认为包含消息和返回码的对象为表示成功加入发送队列为表示未连接为表示发送队列已满如果无效如果类型无法处理发布失败客户端未连接到可以选择抛出异常或返回错误状态返回一个模拟的失败结果通常表示失败字典转换为失败不支持的消息类型请提供或检查大小可选取决于限制示例发布失败消息载荷大小超过限制返回错误或抛出异常准备发布消息主题载荷只显示部分载荷检查发布结果消息已成功加入发送队列主题对于发布几乎立即完成没有回调确认对于回调会在收到确认后触发发布失败未连接到这通常发生在或消息发送过快网络处理不过来时发布警告发送队列已满消息可能延迟或丢失请考虑降低发送频率或检查网络发布失败未知错误代码返回对象例如不是发布失败无效参数发布过程中发生未知错误重新抛出订阅一个主题要订阅的主题可以包含通配符或匹配单层通配符匹配多层通配符必须在末尾请求的等级可能授予较低的表示成功其他表示失败消息如果无效如果客户端未连接订阅失败客户端未连接到尝试订阅主题订阅请求已发送将成功订阅的主题记录下来用于重连时恢复订阅请求失败错误代码订阅失败无效参数订阅过程中发生未知错误重新抛出取消订阅一个主题要取消订阅的主题表示成功其他表示失败消息如果客户端未连接取消订阅失败客户端未连接到尝试取消订阅主题取消订阅请求已发送从记录中移除注意这里移除逻辑比较复杂因为未知简单实现是移除所有匹配的记录取消订阅请求失败错误代码取消订阅过程中发生未知错误重新抛出使用示例客户端使用示例配置建议从配置文件或环境变量读取公共测试每次运行生成新的对于公共测试通常不需要或需要特定配置如果需要认证或常用端口双向认证时需要双向认证时需要创建客户端实例如果需要认证取消注释以启用取消注释以启用取消注释以启用取消注释以启用取消注释以启用使用清洁会话连接到会启动后台循环等待连接成功可以稍微等待一下确保连接和可能的重订阅完成更健壮的方式是检查状态或使用信号量事件最多等待秒连接超时无法继续执行示例或者订阅主题订阅一个通配符主题接收所有下的消息请求返回订阅失败这里可以根据需要处理订阅失败的情况发布消息准备要发布的数据字典模拟一点变化模拟一点变化发布消息到具体主题使用不保留返回对象传递字典方法会处理转换消息已发布消息发布失败发布一条纯文本消息保持运行以接收消息因为在后台运行主线程可以做其他事情或等待示例运行中等待接收消息按退出让主线程保持活动状态例如等待用户输入或无限循环可以在这里做其他主线程任务收到退出信号连接错误发生未知错误断开连接确保无论如何都尝试断开连接并停止循环示例结束断开连接检查是否已成功初始化运行示例协议是一种开放标准和允许网页浏览器和移动应用程序之间无需复杂的服务器中介或插件即可进行实时通信它主要支持点对点的语音通话视频通话和任意数据传输作为一项开放的实时通信标准为开发者提供了快速构建实时音视频通话系统的能力协议特性特性描述优势点对点通信在客户端之间直接传输数据减少服务器负载降低延迟实时音视频支持高质量的音频和视频传输适合视频会议直播场景数据通道支持任意二进制数据传输适合游戏协作编辑等应用穿透通过机制穿透防火墙可在复杂网络环境下工作端到端加密使用加密通信内容保障通信安全性带宽自适应根据网络条件调整传输质量提供流畅的用户体验通信原理传统通信方式需要通过客户端服务器客户端进行通信而通信则可以通过信令来交换数据要实现两个客户端的实时音视频通话并且两个客户端可能处于不同网络环境使用不同的设备都需要解决以下三个问题如何发现对方不同的音视频解码能力如何沟通如何联系对方进行通信如何发现对方在通信的过程中双方需要交换一些元数据比如媒体信息网络数据等等信息我们通常称这一过程叫做信令对应的服务器即信令服务器通常也有人将之称为房间服务器因为它不仅可以交换彼此的媒体信息和网络信息同样也可以管理房间信息比如通知彼此谁加入了房间谁离开了房间告诉第三方房间是否已满或是否可以加入房间为避免出现冗余并最大限度的提高与已有技术的兼容性标准并没有规定信令方法和协议所以我们尽可能的使用学习过的协议来搭建一个信令服务器不同的音视频解码能力如何沟通不同浏览器对于音视频的编码能力是不同的比如以生活的例子来讲小李会讲汉语和英语而小王会讲法语和汉语为了保证双方都可以正确理解对方的意思最简单的就是取他们都会的语言也就是汉语来沟通在中有一个专门的协议称作可以用于描述上述这类信息因此参与音视频通讯的双方想要了解对方支持的媒体格式必须交换信息而交换的过程通常称为媒体协商如何联系上对方其实就是网络协商的过程也就是参与音视频实时通信的双方要了解彼此的网络情况这样才有可能找到一条相互通讯的链路理想的网络情况是每个客户端都有自己的私网公网地址这样就可以直接进行点对点连接实际上呢处于网络安全和其他原因考虑大多数客户端之间是在某个局域网内需要网络地址转换在中我们使用机制建立网络连接协议通过一系列技术如服务器帮助通信双方发现和协商可用的公共网络地址实现穿越的工作原理如下首先通信双方收集本地网络地址包括私有和公共地址以及通过和服务器获取的候选地址接下来双方通过信令服务器交换这些候选地址通信双方使用这些候选地址进行连接测试确定最佳的可用地址一旦找到可用的地址通信双方就可以开始实时音视频通话在中网络信息通常用来描述针对上面三个问题的总结就是通过提供的获取各端的媒体信息以及网络信息并通过信令服务器交换进而建立两端连接通道完成实时音视频通话主要会用到如下的几个方法媒体协商方法由发起方调用创建一个包含其媒体能力和网络信息的用于启动连接协商由接收方在收到后调用创建一个响应对方的将本地生成的或应用到并开始收集本地候选地址将从远端通过信令接收到的或应用到重要事件当本地代理找到一个网络候选地址端口协议时触发此事件你需要将这个候选地址通过信令发送给对方已废弃旧版中当接收到远端的媒体流时触发推荐使用的现代当接收到远端的媒体轨道时触发此事件这是当前标准接收音视频的方式整个媒体协商过程可以简化为三个步骤对应上述的四个媒体协商方法发起调用创建包含她的信息她用保存这个然后通过信令服务器发给回应收到后用保存它然后他调用创建回应包含他的信息接着他用保存这个再通过信令服务器发回给确认收到后用保存它至此双方的信息交换完毕经过这三个步骤则就完成了通信过程中的媒体协商部分实际上在呼叫端以及接收端调用的同时也开始了收集各端自己的网络信息然后各端通过监听事件拿到对方的视频流进而完成了整个视频通常用名描述用于请求访问用户的媒体输入设备如摄像头和麦克风它会提示用户授权成功后返回一个该解析为一个对象包含了请求的音视频轨道可以通过参数指定请求的媒体类型音频视频以及具体要求如分辨率帧率示例代码期望宽度期望高度期望帧率可选请求音频成功获取本地媒体流将媒体流显示在元素上如果需要将轨道添加到可以在这里获取错误无法访问媒体设备调用示例名描述的核心接口用于建立和管理两个对等端之间的连接通过创建实例对象可以包含列表服务器信息等设置它提供了创建设置本地远端描述添加移除媒体轨道添加候选者创建数据通道等方法并提供了监听连接状态候选者媒体轨道等事件的接口示例代码可以添加更多或服务器已创建监听事件生成本地通过信令服务器将发送给对方收集完成监听远端媒体轨道事件收到远端媒体轨道关联的流将收到的流附加到远端元素已将远端流附加到元素监听连接状态变化连接状态变为在这里可以根据状态更新监听协商需求事件可选用于完美协商模式需要进行协商触发在完美协商模式下这里可以自动创建并发送通过信令发送协商处理失败监听数据通道事件如果对方创建了数据通道收到远端数据通道设置接收通道的回调创建失败调用示例名描述由发起连接的一方调用用于创建一个包含本地媒体能力和网络地址信息的返回一个该解析为一个对象包含和字符串通常在调用此方法前需要先通过添加好要发送的媒体轨道示例代码不存在创建可选指定选项例如是否需要接收音视频已创建设置本地描述将设置为本地描述本地描述已设置通过信令发送通过信令服务器将发送给对方创建或设置本地描述失败前提已创建且可能已添加本地轨道调用示例名描述由接收的一方调用用于创建一个来回应收到的它会根据本地媒体能力和收到的内容生成应答返回一个该解析为一个对象包含和字符串在调用此方法前必须先调用将收到的设置为远端描述示例代码假设是从信令服务器收到的包含和的对象不存在收到设置远端描述在设置远端后添加本地媒体轨道如果需要发送远端描述已设置创建已创建设置本地描述将设置为本地描述本地描述已设置通过信令发送通过信令服务器将发送给对方处理或创建设置失败前提已创建调用示例名描述将一个描述或设置为本地端的描述这会启动开始收集本地网络候选地址它接受一个对象作为参数并返回一个通常在或之后调用示例代码已包含在和示例中在后在后名描述将从远端对等方通过信令收到的描述或设置为远端描述这对于连接协商过程至关重要它接受一个对象作为参数并返回一个接收时在之前调用接收时在和之后调用示例代码接收时在前接收时在和后名描述将一个本地通常来自返回的添加到中以便将其发送给对等方需要传入对象和它所属的对象此操作通常需要在创建之前完成这样中才能包含相应的媒体描述示例代码或媒体流不存在将本地轨道添加到轨道已添加添加轨道失败前提已创建已通过获取调用示例名描述将在信令通道上从对等方收到的候选者添加到的中使用这些远端候选者与本地候选者进行连通性检查以寻找最佳的通信路径接受一个对象或符合其结构的字典作为参数并返回一个示例代码假设是从信令服务器收到的包含信息的对象不存在无法添加有时会收到表示对方收集结束后端需要判断前端通常直接忽略收到忽略在添加前检查信令状态避免在连接关闭后添加成功添加远端已关闭忽略收到的忽略添加旧或格式错误的时可能出现的错误添加时忽略错误添加远端失败前提已创建调用示例通常是的结果名描述创建一个用于在对等方之间传输任意数据字符串或二进制发起方调用此方法创建通道接收方则通过监听的事件来获取对方创建的通道可以指定一个标签字符串和一些选项如是否保证顺序最大重传次数等示例代码创建方不存在无法创建数据通道保证消息顺序可选设置最大重传次数数据通道已创建设置事件处理创建数据通道失败数据通道已打开数据通道已连接更新状态通道打开后可以发送消息收到数据通道消息处理收到的数据数据通道已关闭数据通道已关闭更新状态数据通道错误数据通道错误前提已创建通常在发起前创建调用示例示例代码接收方在的回调中在函数内收到远端数据通道重要需要为接收到的通道设置回调函数同上名描述通过已建立的发送数据给对等方可以发送字符串或示例代码通过数据通道发送消息发送数据失败数据通道未打开无法发送消息前提已创建并通过事件确认已打开调用示例这是一条测试消息项目实践项目初始化项目采用运行如下命令创建项目例如安装和作为开发依赖初始化配置文件注意根据你的注释以上版本可能无需执行此命令如果执行成功会创建和如果报错或你使用的版本不需要请直接创建或修改这些文件配置用以下内容覆盖文件确保扫描文件你自定义的颜色修正键名加载插件主题配置你的自定义主题名也包含内置的主题默认暗色模式时使用的主题开发时显示日志创建基础文件在目录下创建或其他名称如文件添加以下内容在中引入修改文件确保引入了上述文件确保路径和文件名正确安装前端基础组件用以下内容完全替换文件的内容响应式状态实例当前用户是否是接收方当前用户是否是发起方是否处于呼叫中状态是否正在视频通话中本地视频元素引用远端视频元素引用当前主题错误信息房间空闲连接状态统计信息配置状态组用于计算属性已连接通话中连接中连接信令服务器正在连接呼叫中收到呼叫邀请对方已接受正准备连接错误计算属性默认空闲已断开等状态生命周期钩子组件已挂载组件即将卸载业务方法发起视频待实现同意视频邀请待实现挂断视频待实现辅助函数清理待实现重置状态待实现标题卡片简单易用的视频通话解决方案使用技术实现高质量的视频通话状态房间号视频区域本地视频远程视频等待对方接听弹窗等待对方接听请耐心等待对方接受您的视频邀请取消关闭接听邀请界面收到视频邀请拒绝接受控制按钮发起视频挂断统计信息统计请确保信令服务器正在运行基础布局样式视频容器样式视频元素共用样式后端基础设置安装依赖在你的后端项目目录中例如激活虚拟环境运行创建初始代码创建文件并写入以下初始代码初始基础代码引入和对象用于获取仅引入需要的用于设置密钥日志设置创建应用实例生成一个随机密钥创建实例明确指定使用需要已安装允许所有来源跨域开发方便服务器准备就绪事件处理初始处理新的客户端连接客户端已连接发送连接成功事件给当前客户端使用指定接收者已向发送事件向发送时出错处理客户端断开连接客户端已断开连接后续步骤将添加离开房间的逻辑主程序入口准备启动服务器使用来启动服务器允许局域网访问现在项目的基本骨架已经搭建完毕前端有了界面模板和初始状态后端有了一个可以接受连接的基础服务器实现连接与房间加入目标前端连接到后端处理连接错误断开事件连接成功后前端自动发送事件后端处理事件管理房间成员后端在客户端断开时处理其离开房间的逻辑后端修改新增添加了用于存储房间信息的和全局字典新增添加了处理客户端事件的函数修改更新了函数加入了客户端离开房间的清理逻辑请在中添加或修改以下代码定义保持不变引入函数新增用于管理房间和客户端的数据结构事件处理处理器保持不变新增处理事件处理客户端加入房间的请求缺少离开旧房间逻辑如果需要切换房间正在离开旧房间房间已移除空处理离开旧房间出错确保移除旧映射加入新房间逻辑只有当用户不在这个房间时才执行核心加入操作正在加入新房间加入房间加入我们自己的跟踪集合更新映射已成功加入房间通知其他人处理加入新房间出错已在房间中修改完善事件处理处理客户端断开连接客户端准备断开连接查找该客户端所在的房间从映射中移除并获取房间客户端正在从房间断开会自动处理离开房间从我们的数据结构中清理从房间成员列表中移除已从移除如果房间变空清理房间记录房间已移除空通知房间内其他人该用户已离开向房间广播事件来自通知其他人离开处理离开房间时出错块不再需要因为已经处理了映射移除客户端断开连接时不在任何已记录的房间中客户端清理完成保持不变前端修改修改更新钩子在连接成功后发送事件并添加必要的错误和断开连接处理添加可选的和监听器修改更新钩子确保断开连接新增添加和辅助函数或确保它们已定义请在的部分替换或添加以下代码添加清理的辅助函数清理连接移除所有监听器已断开添加或更新重置状态的辅助函数重置状态错误已连接信令服务器空闲添加或更新设置状态的辅助函数状态更新错误添加或更新挂断清理逻辑执行本地挂断清理用户操作清理资源当前为空后续实现重置界面状态变量错误触发时保留错误信息错误已挂断错误对方已挂断区分状态短暂显示后恢复已挂断对方已挂断已连接信令服务器空闲修改组件已挂载开始连接信令服务器替换之前的连接逻辑连接到后端推荐指定使用标准的事件连接成功已连接信令服务器使用辅助函数更新状态连接成功后立即发送加入房间事件使用保存后的已发送加入房间请求实例未就绪无法加入房间仍然可以监听自定义确认事件收到来自服务器的确认连接错误错误无法连接信令服务器清理实例与服务器断开连接错误已挂断已断开错误如果是因错误断开保留错误信息清理新增监听房间成员变化事件可选通知对等端加入了房间可在此处更新通知对等端离开了房间可在此处更新或处理通话中断如果正在通话中对方离开了通话中的对方已离开房间触发本地挂断清理对方已离开保留后续步骤将使用的事件监听器占位符第步实现第步实现第步实现第步实现第步实现第步实现关键保存实例到修改组件即将卸载断开连接并清理尝试清理通话状态和资源确保关闭相关占位函数占位符如果上面没实现完整版清理待实现其他函数占位符待实现待实现的占位符保持不变它们会在下一步被完整实现发起视频待实现同意视频邀请待实现挂断视频待实现测试重启后端用两个浏览器窗口打开前端页面检查后端日志确认两个客户端都连接成功并且都加入了检查第一个窗口的控制台应该能看到第二个窗口加入房间的通知关闭第二个窗口检查后端日志确认第二个客户端断开连接并已从房间移除检查第一个窗口的控制台应该能看到第二个窗口离开房间的通知现在基本的连接和房间管理功能已经完成并且前后端能够正确交互了实现呼叫信令请求接受挂断目标用户点击发起视频按钮时前端发送事件房间内其他用户收到事件更新显示收到呼叫邀请收到邀请的用户点击接受按钮前端发送事件发起方收到事件更新显示对方已接受任何一方点击挂断或收到事件都能结束当前呼叫通话状态并清理后端修改在的事件处理部分添加以下三个新的事件处理器用于转发呼叫相关的信令在和之间或之后添加新增处理呼叫相关信令事件处理发起呼叫请求并转发给同房间其他人前端发送时应包含收到来自的请求房间将呼叫请求事件转发给房间内的其他人并附带发起者前端应监听事件已将事件转发给房间除外无法转发房间无效或用户不在房间内处理接受呼叫请求并转发给发起方或其他同房间的人收到来自的请求房间将接受事件转发给房间内的其他人并附带接受者前端应监听事件已将事件转发给房间除外无法转发房间无效或用户不在房间内处理挂断请求并转发给同房间其他人收到来自的请求房间将挂断事件转发给房间内的其他人并附带挂断者前端应监听事件已将事件转发给房间除外无法转发房间无效或用户不在房间内前端修改在内部新增辅助函数替换的占位实现加入状态更新和调用替换和的占位实现在的事件监听器中替换的占位监听器添加处理逻辑请在的部分添加或替换以下代码新增辅助函数统一设置状态和错误信息如果上一步没加请加上状态更新错误统一处理异步操作中的错误如果上一步没加请加上出错错误失败出错时挂断统一发送信令消息新增自动添加发送信令第一个参数是事件名第二个是数据对象无法发送信令未连接错误信令服务器连接已断开实现更新清理函数保持之前的空实现或基础实现保持之前的实现实现更新状态重置函数重置状态错误已连接信令服务器空闲实现更新挂断清理函数执行本地挂断清理用户操作清理下一步会完善重置状态已挂断对方已挂断错误检查状态是否仍是挂断状态已连接信令服务器空闲替换用户交互方法的占位实现标记为供后续使用发起视频请求错误未连接到信令服务器已在通话或呼叫中下一步获取本地流模拟获取本地流更新本地状态呼叫中发送呼叫信令使用辅助函数标记为供后续使用接受视频邀请错误未连接到信令服务器状态不符无法接受下一步获取本地流模拟获取本地流下一步创建更新本地状态结束响铃正在连接进入连接协商状态发送接受信令请求挂断视频发送挂断信令执行本地清理标记为用户主动在的事件监听中填充逻辑辅助函数或直接的连接逻辑这里包含连接和基础事件监听连接成功已连接信令服务器使用辅助函数发送收到确认连接使用与服务器断开错误已挂断已断开断开时尝试清理通知加入通知离开对方已离开服务器信令未知错误监听服务器错误替换填充呼叫相关事件监听器收到呼叫请求来自忙线中忽略呼叫收到呼叫邀请对方已接受呼叫来自确保是发起方且在呼叫中对方已接受正准备连接下一步触发流程下一步创建并发送待实现收到但状态不符收到对方挂断通知来自执行本地清理标记为非用户主动保留监听器占位收到待处理收到待处理收到待处理调用连接函数保持不变调用和组件即将卸载断开连接并清理调用挂断逻辑会尝试发信令并清理本地会在时自动触发或在后被调用测试重复上一步的测试流程重启后端用两个浏览器窗口打开前端窗口点击发起视频检查状态和日志窗口收到邀请点击接受检查双方状态和日志任一窗口点击挂断检查双方状态是否正确重置以及日志现在应用应该能够正确地处理发起接受和挂断通话的信令流程了并且状态会随之更新获取媒体流创建并交换目标获取媒体在发起或接受呼叫时通过请求摄像头和麦克风权限获取本地创建连接对象初始化添加轨道将本地中的音视频轨道添加到交换发起方收到对方接受后创建设为本地描述发送给对方接收方收到后设为远端描述创建设为本地描述发送给对方发起方收到后设为远端描述后端修改在的事件处理部分添加用于转发和消息的事件处理器在和之间或之后添加新增处理转发处理收到的并转发给同房间其他人获取前端发送的类型收到来自的房间将事件和转发给房间内的其他人已将事件转发给房间除外无法转发房间无效用户不在房间或缺少处理收到的并转发给同房间其他人获取前端发送的类型收到来自的房间将事件和转发给房间内的其他人已将事件转发给房间除外无法转发房间无效用户不在房间或缺少其他事件处理器和主程序入口保持不变前端修改在内部替换的占位实现替换的占位实现包含事件监听器框架修改和方法以调用和对于新增三个辅助函数修改中的监听器使其调用新增和事件的监听器修改函数以确保停止本地流以下是需要替换或添加到中部分的代码核心逻辑替换占位符实现获取本地媒体流尝试获取本地媒体流请求摄像头权限如果本地媒体流存在先停止所有轨道请求摄像头权限成功获取本地媒体流如果视频元素有值则设置对应的属性本地视频播放失败本地视频已就绪即使视频元素不存在也返回流获取媒体流使用同一错误处理替换占位符实现创建和添加轨道的辅助函数创建并添加轨道创建本地流无效清理旧连接设置事件监听器内部逻辑将在下一步完善步骤将处理发送本地本地收集完成步骤将处理收到远端轨道连接状态改变连接中已连接已断开连接连接失败错误已挂断对方已挂断已断开添加本地轨道添加本地轨道失败本地轨道已添加保存到创建新增发起方创建并发送的逻辑准备创建并发送创建未创建创建设置本地描述检查状态避免错误设置创建时信令状态异常通过信令服务器发送创建或发送新增接收方处理并创建发送的逻辑准备处理并创建确保已在中创建处理未创建设置远端描述设置远端时信令状态异常创建设置本地描述通过信令服务器发送处理或创建发送新增发起方处理的逻辑准备处理处理不存在收到但信令状态为忽略设置远端描述远端已设置连接即将通过建立设置远端修改用户交互方法更新方法添加获取流发起视频请求错误未连接到信令服务器已在通话或呼叫中获取本地流获取失败则中止更新状态并发起呼叫呼叫中发送呼叫信号已发送事件等待对方接受创建将在收到后进行更新方法添加获取流和创建接受视频邀请错误未连接到信令服务器状态不符无法接受获取本地流创建并添加本地轨道创建失败通知对方挂断更新状态并发送接受信令正在连接已发送事件准备接收修改函数清理资源清理时出错已关闭并清理确认停止本地流轨道清除引用本地媒体流已停止媒体元素已清理修改中的监听器不变修改监听器调用对方已接受呼叫来自确保是发起方且尚未创建对方已接受正准备连接调用异步函数创建并发送收到但状态不符新增修改监听器收到来自确保是被叫方且已在中创建好并且还未开始通信处理并创建收到但状态不符新增修改监听器收到来自确保是发起方且存在处理收到但状态不符监听器保持占位步骤将处理收到保存实例其他函数等和保持不变测试重启后端用两个浏览器窗口打开前端窗口点击发起视频同意权限本地预览出现状态呼叫中窗口收到邀请点击接受同意权限本地预览出现状态正在连接观察控制台日志双方成功获取媒体流创建添加轨道的日志窗口在收到后应看到创建设置本地发送的日志窗口应看到收到设置远端创建设置本地发送的日志窗口应看到收到设置远端的日志此时协商完成但视频仍不会通因为网络路径还未交换状态可能停留在已连接实现交换与显示远端流目标在生成时通过信令服务器发送给对方接收并添加对方发送的到本地在事件触发时获取远端媒体流并显示在元素中同时更新通话状态可选实现并启动统计信息获取后端修改在的事件处理部分添加用于转发消息的事件处理器在和之间或之后添加新增处理转发处理收到的并转发给同房间其他人前端发送时键名为收到来自的房间时可取消注释将事件和信息转发给房间内的其他人不包括发送者前端应监听事件已将事件转发给房间除外无法转发房间无效用户不在房间或缺少信息其他事件处理器和主程序入口保持不变前端修改在内部完成函数中和的内部逻辑新增辅助函数完成中对事件的处理逻辑实现函数更新函数以清除统计定时器请在的部分替换或添加完成以下代码更新完成函数监听本地生成完成发送逻辑检查是否存在发送本地使用辅助函数发送事件本地收集完成为表示收集完毕监听远端媒体轨道添加完成处理逻辑收到远端轨道所属流将收到的第一个流附加到元素上播放避免重复设置同一个流远端视频播放失败已将远端流附加到元素确认进入通话状态不再是呼叫中响铃中正式进入通话中通话中更新状态连接成功开始获取统计信息无法附加远端流到元素监听连接状态变化保持不变新增处理远端的辅助函数尝试添加远端确保实例存在并且收到的有效且连接未关闭使用收到的信息创建对象并添加到已添加远端忽略添加候选者时可能出现的常见错误例如重复添加状态不对等添加时忽略错误添加远端失败收到对方收集完成收到但状态异常在的事件监听中完成监听器保持不变完成监听器逻辑标记为收到来自调用处理函数保存实例实现统计获取函数清除旧的定时器开始获取统计信息确保存在且处于连接状态获取所有统计信息存储我们关心的统计数据临时存储远端候选信息筛选常用的统计信息收到的包数抖动丢失的包数数数本地候选远端候选秒地址端口类型远端候选成功远端候选远端候选更新响应式获取统计信息失败如果连接断开或不存在停止获取连接非状态停止获取统计信息每秒获取一次更新函数以清除定时器清理资源确保清除定时器清空统计显示统计定时器已清除关闭和轨道停止本地流媒体元素已清理其他函数和生命周期钩子保持不变测试最终完整流程重启后端用两个浏览器窗口打开前端页面窗口点击发起视频同意权限窗口收到邀请点击接受同意权限观察双方的本地视频预览出现状态经历呼叫中收到呼叫邀请对方已接受正在连接等变化控制台会打印以及大量的交换日志关键等待几秒钟双方的右下角小窗口应该会成功显示对方的摄像头画面状态最终变为通话中下方的统计信息区域开始显示数据如果启用了任一窗口点击挂断双方视频通话结束状态恢复可选调试如果视频没有出现检查浏览器控制台是否有错误在中打开查找当前连接检查候选对是否有成功的以及音视频流的收发包情况最终完整后端代码使用和引入和对象用于获取引入相关组件用于设置密钥引入日志设置创建应用实例生成一个随机密钥创建实例服务器准备就绪用于管理房间和客户端的数据结构存储每个房间有哪些客户端存储每个当前在哪个房间方便断开时查找事件处理获取客户端已连接响应前端的事件使用或发送给特定客户端向发送时出错修改完善事件处理客户端已断开连接后续步骤在这里处理离开房间的逻辑查找该客户端所在的房间客户端正在从房间断开通常会自动处理但显式调用更清晰从我们的数据结构中移除已从移除如果房间空了清理字典房间已移除空通知房间内其他人该用户已离开向房间广播事件来自这里不需要因为自己已断开链接处理离开房间时出错从映射中移除客户端未在任何房间中客户端断开连接处理完成新增处理事件处理客户端加入房间的请求请求加入房间但未提供可以选择发送一个错误事件回客户端未提供房间号如果客户端已在某个房间先让其离开旧房间调用提供的离开房间函数让离开房间从数据结构中移除已离开旧房间如果房间空了清理字典房间已移除空可选通知旧房间其他人该用户已离开处理离开旧房间时出错如果他在新房间则我们需要去掉对于旧房间的引用从映射中移除加入信访件让加入房间如果房间时新的则创建创建将添加到中将和房间号建立映射已加入房间可选通知新房间其他人该用户已加入使用避免给自己发送通知处理加入房间时出错新增处理呼叫相关信令事件处理发起呼叫请求并转发给同房间其他人收到来自的请求房间将呼叫请求事件转发给房间内的其他人已将事件转发给房间除外无法转发房间无效或不存在处理接受呼叫请求并转发给发起方收到来自的请求房间将接受事件转发给房间内的其他人理论上主要是发起方会处理已将事件转发给房间除外无法转发房间无效或不存在处理挂断请求并转发给同房间其他人收到来自的请求房间将挂断事件转发给房间内的其他人已将事件转发给房间除外无法转发房间无效或不存在新增处理信令消息转发处理收到的并转发给房间内其他人前端发送时调用了收到来自的房间将转发给房间内的其他人已将事件转发给房间除外无法转发房间无效用户不在房间或缺少处理收到的并转发给同房间其他人前端发送时用了收到来自的房间将事件和转发给房间内的其他人已将事件转发给房间除外无法转发房间无效用户不在房间或缺少处理收到的并转发给同房间其他人前端发送时用了收到来自的房间日志将事件和信息转发给房间内的其他人已将事件转发给房间除外无法转发房间无效用户不在房间或缺少信息准备启动服务器使用启动服务器使用最终完整前端代码响应式状态实例当前用户是否是接收方收到呼叫当前用户是否是发起方是否正处于呼叫中等待接听的状态是否正在视频通话中本地视频元素引用远端视频元素引用主题名称实例本地媒体流用于在界面上显示错误信息示例房间空闲连接状态显示存储统计信息存储统计定时器的连接状态连接状态计算属性用于样式已连接通话中连接中连接信令服务器正在连接呼叫中收到呼叫邀请对方已接受正在建立连接错误已断开已挂断空闲更新后的函数清理资源清理时出错已关闭并清理清理本地媒体流本地媒体流已停止媒体元素已清理重置所有与通话相关的状态变量重置状态保留和的当前值由调用者决定后续状态开始获取统计信息每秒更新一次停止视频通话流用于错误处理和主动挂断更新函数监听本地生成步骤实现发送本地将通过发送给信令服务器发送事件发送格式本地收集完成结束步骤实现监听远端媒体轨道添加替代旧的步骤实现收到远端轨道所属流将收到的第一个流附加到元素上播放避免重复设置同一个流远端视频播放失败已将远端流附加到元素确认进入通话状态不再是呼叫中响铃中正式进入通话中通话中更新状态开始获取统计信息结束步骤实现监听连接状态变化保持不变连接状态改变连接中连接成功但等后再确认状态已连接已断开连接已断开错误连接失败已断开连接已关闭更新后的方法发起视频请求未连接到信令服务器错误已在通话或呼叫中获取本地媒体流这是新增的关键部分无法获取本地媒体流无法发起呼叫错误获取失败则不继续更新状态并发送呼叫信令呼叫中已发送事件等待对方接受的创建和发送现在移动到收到事件后更新后的方法接受视频邀请未连接到信令服务器错误没有收到呼叫或不在呼叫状态无法接受获取本地媒体流这是新增的关键部分无法获取本地媒体流无法接听错误获取失败则不继续更新状态结束响铃状态正在连接进入连接协商状态创建并添加本地轨道这是新增的关键部分创建失败错误信息已在辅助函数中设置发送接受信令给服务器已发送事件并准备好接收此时接收方准备好接收了点击挂断按钮或需要主动结束通话时调用请求挂断视频发送挂断信令给服务器转发如果还在线已发送事件执行本地的清理操作本地清理逻辑挂断或收到对方挂断时调用执行本地挂断清理清理相关资源后续实现重置界面状态变量可以根据情况设置最终状态比如已挂断或空闲错误避免覆盖错误状态已挂断短暂显示已挂断后可以变回空闲或已连接信令服务器已挂断已连接信令服务器空闲核心逻辑实现获取本地媒体流尝试获取本地媒体流清除旧错误如果已有流先停止已停止之前的本地媒体轨道开启音频请求视频成功获取本地媒体流保存流引用返回最好一下可能的错误例如用户未互动本地视频自动播放失败返回获取到的流处理获取媒体流失败的情况错误无法访问媒体设备向用户显示错误错误返回表示失败实现创建和添加轨道的辅助函数创建并添加轨道创建实例设置事件监听器将本地流的轨道添加到已添加本地轨道添加本地轨道失败无法添加轨道本地流无效本地摄像头麦克风流无效错误创建失败保存到创建失败创建连接失败错误连接连接与事件监听连接成功已连接信令服务器已发送加入房间请求连接失败连接失败断开连接已断开新增监听呼叫相关事件收到呼叫请求收到呼叫请求来自检查是否已在通话或呼叫中避免冲突正在通话或呼叫中忽略新的呼叫请求可以选择给对方发送一个信号标记为被呼叫方进入响铃状态收到呼叫邀请标记为对方已接受呼叫来自只有发起方处理对方已接受正在建立连接触发流程确保已创建并添加了轨道注意在时我们已经获取了流但在这里创建创建设置本地描述通过信令服务器发送发送事件使用区分创建或发送失败创建失败错误出错时挂断收到对方挂断信号收到对方挂断通知来自执行本地清理对方已挂断对方已挂断可选的用户提示新增监听器标记为收到来自确保是被叫方且实例已在中创建设置远端描述创建设置本地描述通过信令服务器发送发送事件使用区分处理或创建发送失败创建失败错误收到但状态不符非接收方无或已通话新增监听器标记为收到来自确保是发起方且实例存在检查状态是否适合设置设置远端描述远端已设置连接即将建立设置远端失败设置失败错误收到但当前信令状态为忽略更新事件处理标记为确保实例存在并且收到的有效使用收到的信息创建对象并添加到已添加远端忽略添加候选者时可能出现的常见错误例如重复添加状态不对等添加时忽略错误添加远端失败收到对方收集完成收到但不存在或已关闭通知加入房间通知离开房间组件卸载时清理资源确保也被清理使用技术实现高质量的视频通话状态房间号等待对方接听请耐心等待对方接受您的视频邀请取消关闭收到视频邀请拒绝接受发起视频挂断统计示例让按钮区域和状态信息在底部调整内边距确保子元素绝对定位是相对于此容器占据可用宽度可以限制最大宽度保持比例背景设为黑色移除固定的用于本地视频充满容器避免底部空隙覆盖整个区域可能裁剪用于远端视频小窗效果样式已在属性中定义给小窗加个背景色运行与测试启动后端启动前端测试使用两个浏览器窗口或设备进行完整的呼叫接听显示视频查看统计挂断流程使用浏览器开发者工具和后端的日志进行调试这份代码整合了所有步骤并进行了一些优化和错误处理的改进形成了一个功能更完整代码结构更清晰的版本进阶实现调优实战通过做一个超低延迟摄像头转播前端代码采用实现摄像头实时流优化可选添加一些基本的样式让元素默认背景为黑色减少白屏闪烁摄像头状态开始推流停止推流建议使用访问或访问查看连接详情统计示例从全局对象解构所需函数创建应用使用响应式状态空闲状态空闲连接中已连接已断开错误是否正在连接是否已连接错误消息用于持有元素的引用实例实例用于显示统计信息可选存储统计定时器的计算属性根据状态动态计算类名已连接连接中错误已断开空闲配置加入服务器你可以添加更多的服务器或你自己的服务器方法清理资源清理资源清除统计定时器统计定时器已清除关闭所有发送器和接收器更彻底的清理停止轨道如果是本地轨道停止接收到的轨道关闭已关闭并清理停止视频流的所有轨道清空元素的源元素已清理清理资源清理资源关闭已关闭状态为无需关闭连接判断协议或假设服务器在同一主机不同端口如果需要请调整使用可能比更可靠尤其是在某些系统配置下尝试连接到连接中清空之前的错误清理可能存在的旧连接创建实例连接已建立连接成功后继续流程连接成功解析处理从服务器收到的信令消息解析收到的消息失败收到无效的服务器消息处理关闭事件已关闭代码原因无原因是否正常关闭错误空闲不要覆盖错误空闲状态已断开如果关闭也清理清理实例处理错误错误连接错误请检查服务器是否运行以及网络连接错误出错时拒绝出错时清理清理实例开始推流过程防止重复点击已在连接中或已连接开始推流处理优化版首先连接等待成功连接设置设置优化版清理可能存在的旧创建处理候选者当本地生成候选者时通过发送给服务器发送候选者缩短日志输出发送格式收集完成未打开或不存在无法发送候选者处理传入的轨道当收到远端服务器的视频轨道时收到远端轨道将收到的流附加到元素上进行播放检查是否已经设置避免重复设置或冲突已将流分配给元素连接成功且轨道已附加后开始获取统计信息无法将流分配给元素元素不存在或流无效处理连接状态变化监控的连接状态触发时已清理忽略防止在清理后触发状态改变连接中更新状态已连接更新状态清除错误信息连接断开可能可以恢复保持已断开不再是正在连接状态连接已断开可能尝试自动重连这里可以选择不调用可能会自动尝试恢复如果需要手动停止可以在这里调用连接失败无法恢复错误连接失败请检查网络或服务器配置失败时彻底停止并清理连接已关闭已断开或者空闲取决于预期通常是调用导致的这里无需再调用连接已关闭创建并发送创建优化版我们只发送视频不接收音频我们要接收视频如果需要强制重新进行协商可以设置此项设置本地描述本地描述已设置发送给服务器通过发送给服务器获取获取类型未连接无法发送启动推流失败启动失败错误出错时尝试清理停止推流过程停止推流清理清理只有当状态不是错误时才重置为空闲否则保持错误状态错误空闲保留错误信息除非是用户手动停止可以取消注释这一行如果希望停止时总是清除错误信息处理从收到的信令消息在处理或前检查是否存在收到信令消息但不存在或已清理处理信令消息收到服务器的收到但当前信令状态为忽略设置远端描述远端描述已设置收到服务器的候选者在添加前检查状态避免在状态下添加添加候选者添加来自服务器的候选者已关闭忽略收到的候选者收到来自服务器的候选者收集结束处理服务器发送的错误消息收到来自服务器的错误消息服务器错误未知错误错误收到服务器错误时停止可以添加其他信令消息类型处理处理信令消息时出错消息类型处理信令失败错误处理信令出错时停止统计开始定时获取统计信息清除旧的定时器确保存在且处于连接状态获取所有统计信息存储我们关心的统计数据筛选一些常用的统计信息入站视频流统计收到的包数收到的字节数解码的帧数抖动抖动网络延迟变化丢失的包数丢包数时间戳请求数发送否定确认的次数表示丢包请求数发送图像丢失指示的次数表示需要关键帧成功建立连接的候选对统计本地候选远端候选当前往返时延关键延迟指标秒可用出向比特率估计的可用带宽成功配对的远端候选者信息远端候选地址和端口协议类型服务器反射中继对等反射更新响应式以显示在界面上获取统计信息失败获取失败时停止如果连接断开或不存在停止获取统计连接非状态停止获取统计信息清空显示每秒获取一次统计信息生命周期钩子组件挂载后调用组件已挂载可以在这里自动连接或者等待用户点击按钮如果想自动开始取消此行注释组件卸载前调用组件即将卸载清理资源确保清理所有资源返回需要在模板中使用的数据和方法将暴露给模板以便可以关联暴露统计信息注意和是内部逻辑通常不需要暴露给模板将应用挂载到元素上后端优化后的完整后端代码用于干净地管理引入和日志设置单独的摄像头日志记录器全局变量用于存储活动的集合存储以便在需要时将其与关联或仅用于管理使用避免套接字意外关闭时产生悬空引用摄像头处理优化类锁用于控制单例实例化单例模式确保只有一个实例标记为未初始化确保初始化只执行一次获取锁后再次检查防止并发初始化优化点尝试指定后端选择其中一个或者都不用来使用默认值进行测试尝试较新尝试较旧有时兼容性性能更好使用默认后端尝试使用后端使用默认后端结束优化点无法打开视频源尝试设置较低的分辨率和目标可以根据需要调整尝试禁用缓存效果取决于摄像头和驱动读取实际应用的摄像头配置请求摄像头实际配置使用实际读取的或默认值帧锁用于保护的访问存储最新帧使用确保主程序退出时线程也退出控制捕获循环的标志启动捕获线程标记为已初始化摄像头帧捕获循环在单独线程中运行摄像头捕获线程已启动使用时钟更适合测量间隔读取一帧无法从摄像头抓取帧频繁打印可能影响性能短暂等待再重试获取帧锁更新最新帧每秒记录一次实际捕获帧率摄像头实际捕获帧率减少休眠时间让线程尽可能快地再次读取如果是阻塞的这个可能不是主要瓶颈休眠给其他线程机会摄像头捕获线程已停止释放摄像头资源获取最新的摄像头帧获取帧锁返回帧的副本避免多线程问题停止摄像头设备单例模式下正在停止摄像头设备设置停止标志缩短等待时间确保摄像头被释放摄像头设备已停止重置单例允许下次重新创建全局初始化摄像头单例模式尝试创建获取摄像头实例严重启动时初始化摄像头失败服务器可能无法传输视频如果失败确保其值为视频轨道优化一个从全局读取帧的视频流轨道缓存最后一帧有效帧帧率监控每秒记录一次发送帧率调用此方法获取下一帧处理摄像头初始化失败的情况摄像头未初始化发送黑屏创建黑屏帧使用当前时间估算时基保持一个默认间隔获取最新帧计算获取帧实际花费的时间如果当前无法获取帧例如摄像头刚启动或暂时出问题需要更新重用帧的和即使重用也大致按目标帧率等待如果从未收到任何帧则发送黑屏帧无可用帧且无历史帧发送黑屏黑屏帧优化点减少或移除发送端的等待尽快处理新帧并发送将平滑交给接收端缓冲区缓存有效帧帧率监控逻辑不变发送帧率注释掉或使用极小的以降低延迟可选给予事件循环一点喘息时间直接返回追求最低延迟结束优化点服务器与信令处理优化处理根路径请求返回处理连接请求准备响应连接已建立添加到活动集合中配置加入服务器使用的公共服务器创建时传入配置创建一个易于识别的添加到活动集合中已为创建带配置将和关联起来简单方式当生成候选者时调用如果有候选者将其发送给对端浏览器发送候选者为表示收集完成收集完成当连接状态改变时调用连接状态为如果连接失败关闭或断开检查是否还在集合中避免重复关闭正在关闭关闭从集合中移除已关闭并移除同时关闭关联的如果它还开着关闭关联的如果摄像头设备可用则添加视频轨道添加视频轨道到已添加摄像头视频轨道无可用摄像头设备无法添加视频轨道循环监听来自的消息处理文本消息解析收到消息类型收到来自浏览器的设置远端描述远端描述已设置创建设置本地描述本地描述已设置将发送回浏览器已发送到收到来自浏览器的候选者使用更安全有时浏览器会发送表示结束优雅地处理显式提取所需参数忽略其他参数如确保传递的是字符串添加一些检查确保提取的值有效添加候选者已添加来自客户端的候选者收到无效或不完整的字典捕获创建或添加候选者时可能出现的任何错误处理时出错收到表示客户端收集完成收到来自客户端的候选者表示收集结束不需要显式调用收到未知消息类型收到无效处理的消息时出错添加获取更详细的回溯信息为安全起见在出错时关闭连接处理消息出错处理错误连接因异常关闭处理任务被取消的情况例如服务器关闭时任务被取消连接关闭后的清理工作连接已关闭从活动集合中移除确保关联的被清理正在关闭与已关闭关联的清理与主程序服务器关闭时的清理函数服务器正在关闭关闭所有活动的并发关闭忽略单个错误所有已关闭关闭所有活动的连接服务器关闭所有已关闭停止摄像头设备关闭完成注册关闭处理函数添加根路径路由服务添加路由在没有的情况下运行用于本地测试监听所有接口的端口服务器已启动于启动服务器让服务器无限期运行直到被中断运行主异步函数处理收到正在关闭确保即使主循环意外退出摄像头也能被清理视频流协议三个协议在直播推流中都占据重要的角色推流将直播源摄像头屏幕录制本地文件发送到流媒体服务器的过程由于对低延迟的要求较高主播需要尽快看到观众反馈或了解传输状态是这个阶段最常用的协议有时也用于摄像头的推流推流也在兴起拉流分发流媒体服务器将直播内容分发给大量观众的过程考虑到兼容性可伸缩性和网络适应性和另一种基于的自适应流协议是这个阶段的主流选择虽然延迟较高但可以通过轻松分发给全球观众并能在不同网络条件下自动调整清晰度当然我们也会同样的学习其余两种协议主要视频流协议对比特性适用场景全称实时消息传输协议实时流协议直播流开发者传输层协议延迟低秒最低秒高秒适合直播互动适合点播自适应比特率有限不支持支持适合不稳定网络客户端兼容性需要或专用播放器需要专用播放器几乎所有浏览器兼容性最好穿透防火墙能力一般较差最佳适合严格网络环境内容加密可选可选内置支持适合对安全性要求高的场景由于其较低的延迟历史上广泛用于直播推流即把直播源摄像头桌面画面发送到流媒体服务器虽然已被淘汰但仍然是许多直播平台接收推流的主要协议之一它不太适合大规模分发给观众主要设计用于控制媒体流的播放类似控制并配合传输数据它的延迟可以非常低因此广泛应用于摄像头监控视频会议系统以及作为流媒体服务器的内容源直接在浏览器中播放比较困难由开发基于它将视频流切分成一系列小的文件片段并提供一个索引文件优点兼容性极好几乎所有设备和浏览器都能通过播放可以轻松利用进行大规模分发支持自适应比特率根据网速自动切换清晰度容易穿透防火墙缺点延迟较高通常是多个切片时长之和不适合需要实时互动的场景近些年有低延迟标准出现可以将延迟降低到秒是目前互联网视频点播和大规模直播分发最主流的技术认识必要的两个库主要简化和流的打包创建过程提供了高级也包含一些相关的功能封装虽然是计算机视觉库但它的函数能够非常方便地读取流以及其他支持的视频源逐帧进行处理读取时非常常用环境准备安装命令行工具如果尚未安装参考第章安装核心库读取视频流使用场景与用途协议广泛应用于摄像头和安防监控系统库提供了一个非常简洁的接口来读取流以及其他支持的视频源它会自动处理底层的连接和解码让你能够方便地逐帧获取视频画面作为数组进行分析处理或显示这对于需要对摄像头画面进行实时计算机视觉任务如目标检测人脸识别的应用来说非常方便面临的问题在开发和测试需要处理实时视频流尤其是协议的应用时我们经常面临一个挑战手边没有现成的稳定的源摄像头可能尚未部署或配置复杂而去网上搜索公开的测试地址会发现它们大多已经失效或极其不稳定这给开发调试带来了很大不便解决方案使用模拟器为了解决这个问题我们可以使用模拟器这是一种软件工具它可以在你的本地计算机上运行将本地视频文件图片序列甚至其他网络流如或另一个流作为输入源然后通过标准的协议将这些内容模拟成一个摄像头实时流向外提供服务这样就有了一个稳定可靠随时可用的源用于开发和测试完全摆脱了对物理设备或不稳定公网地址的依赖工具使用下载链接第一步下载解压运行注意保证端口没有被占用第二步放一个视频文件到同目录例如第三步用等播放器请求核心方法属性描述参数返回值效果创建一个视频捕获对象视频源文件路径摄像头索引对象检查视频源是否成功打开无成功或失败从视频源读取下一帧无元组是否成功读取数组格式或失败时释放视频捕获对象关闭视频源连接无无获取视频属性如等属性整数常量属性值浮点数设置视频属性并非所有属性都可设置或所有摄像头都支持属性要设置的值成功或失败不支持代码示例读取并显示流配置将这里的替换为你的有效流地址或者你的摄像头地址格式类似连接失败或中断后的重连延迟秒循环读取并显示流尝试连接到流创建对象检查连接是否成功打开错误无法打开流将在秒后重试确保释放资源继续下一次循环尝试连接流连接成功开始读取帧循环读取帧检查是否成功读取到帧错误无法读取帧或视频流结束准备重新连接跳出内层循环触发重连在这里可以对数组进行处理例如获取帧尺寸在帧上绘制时间戳显示帧计算并打印可选检测按键如果按下则退出用户请求退出释放资源关闭窗口结束函数如果内层循环读取失败或流结束释放当前对象当前连接已断开将在秒后尝试重新连接捕获到正在退出确保所有窗口都关闭优点代码简洁使用非常方便几行代码就能开始读取帧直接获取数组无缝对接中其他的图像处理机器学习库缺点对底层的连接参数如选择缓冲大小超时设置控制能力较弱错误处理相对基础对于网络不稳定或摄像头异常的情况可能需要更复杂的重连和错误恢复逻辑推送直播流使用场景与用途将本地视频文件摄像头画面屏幕录制或其他视频源实时地以协议推送到流媒体服务器如或直播平台如直播的接收地址这是直播推流最常用的方式之一核心概念命令基本的推流命令结构如下输入源编码选项推流地址输入选项要求以输入源的自然帧率读取数据这对于直播推流非常重要可以防止因为处理速度过快而瞬间将整个文件推完输入源指定你的视频来源本地文件路径摄像头设备标识符等编码选项控制推流的音视频编码或如果输入源的编码格式通常是视频音频协议和目标服务器直接支持使用可以避免重新编码大大降低消耗延迟也可能更低如果需要转码例如来源不是或者需要调整码率分辨率帧率则需要指定编码器和参数直播推流通常选用较快的输出选项强制指定输出格式为这是推流必需的容器格式推流地址你的流媒体服务器或直播平台提供的地址通常格式为服务器地址端口应用名流密钥实现我们可以使用来构建并执行上述命令代码示例将本地文件推送到服务器配置替换为你的本地视频文件路径将这里的替换为你的有效推流地址本地测试服务器示例其他平台示例需要替换假设在中使用将视频文件推送到服务器错误输入文件不存在开始推送到定义输入节点使用来添加标志读取文件应按原始速率对于直播设备输入可能不需要会自动按设备速率读对应输入节点已定义带定义输出节点将作为输出文件名设置必要的输出选项将所有自动选择的流通常是视频和音频传递给输出输出目标是必需指定输出格式为编码选项根据需要选择选项直接复制流如果源是且服务器支持效率最高等同于或选项重新编码如果需要转码或调整参数直播常用较快预设针对低延迟优化可选控制视频码率设置关键帧间隔通常为推流帧率的倍左右音频采样率有时需要指定可能需要比特流过滤器如果源是封装的并使用如果使用从复制流到有时需要添加比特流过滤器中可以用但如果重新编码如用则不需要这个查看命令调试生成的命令执行推流这是一个持续的过程直到文件读完或被中断开始执行推流对于推流通常包含连接和发送状态捕获它很有用使用获取进程对象可以读取并打印来监控状态进程结束读取时出错等待进程结束推流正常结束推流异常结束返回码推流失败错误输入文件或命令未找到执行推流时发生未知错误运行关键参数知识点作用备注输出文件名必需设置为你的推流地址如必需强制指定输出格式为协议基于容器可选直接复制所有流推荐优先尝试如果源编码兼容效率最高占用最低可选如果不指定视频编码器直播通常用可选如果不指定音频编码器直播常用可选编码时编码预设直播常用或可选编码时编码器调优可能有助于降低编码延迟可选编码时控制视频码率可选编码时控制音频码率可选编码时设置关键帧间隔对直播流很重要建议设为帧率的倍如假设帧率可选仅时比特流过滤器如从复制时需要输入选项在中使用按源帧率读取直播推流必需注意你需要一个正在运行的服务器来接收推流可以使用模块等自行搭建或者使用直播平台提供的推流地址如果推流来源是摄像头等实时设备需要在中使用正确的设备名和格式参数如并且通常不需要输入选项网络安全与加密在现代软件开发中网络通信无处不在无论是构建应用服务移动后端还是分布式系统数据在网络中的传输都面临着被窃听篡改或伪造的风险因此网络安全和数据加密成为了保护用户信息维护系统完整性和确保业务连续性的基石凭借其丰富的标准库和第三方库生态系统为开发者提供了强大的工具来实现安全的网络通信和数据保护本章将深入探讨网络安全的核心概念特别是协议以及常用的数据摘要哈希编码和加密技术并结合代码示例进行实战讲解帮助你理解其原理应用场景和最佳实践规避常见陷阱加密通信保障传输通道安全当你通过浏览器访问网站或者当你的应用程序通过网络与服务器安全地交换数据时及其前身协议就在幕后默默工作它们是保障网络通信通道安全的事实标准想象一下没有的互联网通信就像是在大街上用明信片传递非常私密的信息谁都能看无保密性任何在网络路径上的中间节点你的网络提供商同一下的其他人黑客控制的路由器等都能轻易读取你的数据比如用户名密码银行卡号聊天内容谁都能改无完整性中间人可以截获你的数据修改后再发给对方而接收方可能毫无察觉比如把转账金额改掉或者在网页里注入恶意脚本你不知道对方是谁无身份认证你连接一个网站或服务时无法确定对方真的是你想连接的目标攻击者可以伪造一个看起来一模一样的网站钓鱼网站来骗取你的信息这就是所谓的中间人攻击本小结的代码核心不是教你模块的语法而是强调网络通信默认不安全必须主动采取措施使用来保障数据传输的机密性完整性和通信双方的身份真实性的模块提供了实现这些安全保障的标准工具理解并正确使用这些工具对于开发任何需要网络交互的安全应用都至关重要的关键特性与安全意义理解提供的安全保障对于正确使用它至关重要特性描述安全意义日常场景举例加密通信数据在客户端和服务器之间传输时使用协商好的对称密钥进行加密防止网络中间的窃听者如热点上的攻击者读取敏感信息在线银行交易登录凭据提交数据传输身份验证通常客户端会验证服务器提供的数字证书以确认服务器的真实身份防止中间人攻击确保你连接的是目标服务器而非冒名顶替者浏览器验证网站证书显示安全锁标志数据完整性使用消息认证码或类似机制确保数据在传输过程中没有被修改防止数据在传输途中被篡改例如修改交易金额或注入恶意内容确保下载的文件未被损坏或植入病毒前向保密可选但推荐即使服务器的长期私钥泄露过去的会话密钥也无法被解密即使发生最坏情况私钥泄露也能保护历史通信的机密性增强长期安全现代服务器如通常默认启用注释虽然是早期版本且存在已知漏洞现在应始终优先使用当前推荐版本为和的模块默认会尝试使用安全的协议版本中的支持模块的内置模块提供了创建安全连接的接口可以包装标准的对象示例创建一个安全的客户端这个例子演示了如何连接到一个公共网站验证其证书并进行简单的请求用于更美观地打印证书信息演示创建一个安全的客户端连接目标服务器主机名目标服务器端口号默认为开始连接到创建上下文指定此上下文用于验证服务器证书使用系统推荐的安全设置推荐做法可选配置更严格的设置强制最低版本设置密码套件安全级别具体依赖版本可选加载客户端证书如果服务器要求客户端认证较少见于公共网站加载客户端证书失败根据需要处理错误可能是证书文件问题或密码错误创建标准套接字使用地址族使用协议包含解析和连接设置超时错误无法解析主机名错误连接超时错误无法建立连接到使用上下文包装套接字将普通包装成必须提供用于服务器名称指示和证书主机名验证允许多个站点共享同一地址主机名验证确保证书匹配我们连接的主机踩坑点忘记或错误设置是导致连接失败或安全风险的常见原因成功建立连接到错误服务器证书验证失败验证失败必须关闭原始错误握手失败捕获其他可能的错误错误包装套接字时发生未知错误成功连接后获取和检查连接信息连接详情获取并打印使用的版本和密码套件版本密码套件密码套件名称协议版本使用的协议密钥位数对称加密密钥位数获取服务器证书信息服务器证书信息使用格式化输出复杂的证书结构提取并格式化关键信息主要信息提取主题颁发者解析证书有效期注意日期格式可能变化添加健壮性常见格式成功解析则跳出格式不匹配尝试下一个有效期至有效期无法解析日期格式检查证书是否即将过期或已过期警告证书已过期警告证书将在天内过期有效期证书信息中缺少日期字段有效期解析日期时出错通过安全通道发送和接收数据示例请求发送请求使用确保所有数据发送请求已发送接收响应接收数据块服务器关闭连接接收完毕非阻塞模式下可能出现这里是阻塞模式理论上不应频繁触发等待更多数据错误接收响应超时错误接收数据时发生错误错误接收数据时发生套接字错误收到字节的响应尝试解码并打印部分响应头和内容使用处理可能的解码错误响应预览前字符解码响应时出错原始响应前字节捕获通信过程中的错误错误在通信期间发生错误错误在通信期间发生套接字错误捕获任何其他意外错误错误发生意外错误关闭连接重要务必在块中关闭套接字确保资源被释放关闭会自动处理关闭握手发送关闭连接套接字已关闭关闭套接字时出错运行客户端示例尝试连接其他网站尝试连接一个使用自签名证书或无效证书的地址预期会失败示例创建一个基础的服务器这个例子需要你自己生成一个服务器证书和私钥文件前提生成自签名证书和私钥在你的项目目录下使用命令行工具执行生成一个新的私钥和一个自签名的证书有效期天不加密私钥方便测试生产环境通常会加密并使用密码生成新的证书请求和私钥输出自签名证书而不是证书请求证书有效期输出证书文件输出私钥文件提供一些主题信息对某些客户端验证很重要这里设为服务器代码用于检查证书文件是否存在处理单个安全客户端连接的线程函数线程处理来自的连接显示连接的加密信息客户端版本客户端使用密码套件接收数据客户端未发送数据提前关闭连接如果客户端连接后立即关闭则不发送响应收到字节数据打印部分接收内容构造并发送一个简单的响应注意和之间必须有空行或已向发送响应错误与客户端通信时发生错误错误与客户端通信时发生套接字错误错误处理客户端时发生意外错误关闭与该客户端的连接尝试优雅关闭忽略关闭中的错误线程与的连接已关闭创建并运行一个基础的多线程服务器服务器绑定的主机地址表示监听所有网络接口服务器监听的端口号服务器证书文件路径服务器私钥文件路径检查证书和密钥文件是否存在错误证书文件或密钥文件不存在请先使用生成创建上下文表明这是服务器端上下文会自动选择合适的最高协议版本加载服务器证书和私钥踩坑点证书和私钥文件路径必须正确并且程序需要有读取权限踩坑点如果私钥被密码保护需要提供参数服务器证书和私钥加载成功错误加载证书密钥失败请确保证书和密钥文件有效且格式正确错误找不到证书文件或密钥文件可选配置服务器端的设置定义允许的密码套件禁用不安全的旧协议创建绑定和监听普通套接字设置选项允许服务器快速重启并重新绑定到之前的地址设置连接队列大小安全服务器启动正在监听错误无法绑定或监听端口端口可能已被占用或者没有权限绑定到该地址错误服务器套接字设置失败循环接受客户端连接等待新的客户端连接接受普通连接接受来自的连接警告接受连接时出错继续等待发生错误继续等待下一个连接包装客户端套接字为表明这是服务器端包装默认包装时自动执行握手踩坑点握手可能失败例如客户端不支持服务器的协议密码套件或证书问题与的握手成功为每个客户端连接创建一个新线程进行处理避免阻塞主循环可以同时处理多个客户端注意对于高并发场景线程模型可能不是最高效的可考虑异步设置为守护线程主线程退出时它们也会退出错误与的握手失败握手失败关闭原始处理包装或握手期间可能的套接字错误错误在包装套接字或与握手期间发生错误错误处理新连接时发生未知错误检测到服务器正在关闭服务器主循环发生意外错误关闭监听套接字关闭服务器监听套接字运行服务器示例需要先生成和用于检查证书文件是否存在处理单个安全客户端连接的线程函数线程处理来自的连接显示连接的加密信息客户端版本客户端使用密码套件接收数据客户端未发送数据提前关闭连接如果客户端连接后立即关闭则不发送响应收到字节数据打印部分接收内容构造并发送一个简单的响应注意和之间必须有空行或已向发送响应错误与客户端通信时发生错误错误与客户端通信时发生套接字错误错误处理客户端时发生意外错误关闭与该客户端的连接尝试优雅关闭忽略关闭中的错误线程与的连接已关闭创建并运行一个基础的多线程服务器服务器绑定的主机地址表示监听所有网络接口服务器监听的端口号服务器证书文件路径服务器私钥文件路径检查证书和密钥文件是否存在错误证书文件或密钥文件不存在请先使用生成创建上下文表明这是服务器端上下文会自动选择合适的最高协议版本加载服务器证书和私钥踩坑点证书和私钥文件路径必须正确并且程序需要有读取权限踩坑点如果私钥被密码保护需要提供参数服务器证书和私钥加载成功错误加载证书密钥失败请确保证书和密钥文件有效且格式正确错误找不到证书文件或密钥文件可选配置服务器端的设置定义允许的密码套件禁用不安全的旧协议创建绑定和监听普通套接字设置选项允许服务器快速重启并重新绑定到之前的地址设置连接队列大小安全服务器启动正在监听错误无法绑定或监听端口端口可能已被占用或者没有权限绑定到该地址错误服务器套接字设置失败循环接受客户端连接等待新的客户端连接接受普通连接接受来自的连接警告接受连接时出错继续等待发生错误继续等待下一个连接包装客户端套接字为表明这是服务器端包装默认包装时自动执行握手踩坑点握手可能失败例如客户端不支持服务器的协议密码套件或证书问题与的握手成功为每个客户端连接创建一个新线程进行处理避免阻塞主循环可以同时处理多个客户端注意对于高并发场景线程模型可能不是最高效的可考虑异步设置为守护线程主线程退出时它们也会退出错误与的握手失败握手失败关闭原始处理包装或握手期间可能的套接字错误错误在包装套接字或与握手期间发生错误错误处理新连接时发生未知错误检测到服务器正在关闭服务器主循环发生意外错误关闭监听套接字关闭服务器监听套接字运行服务器示例需要先生成和如何测试服务器确保和在同一目录运行包含的脚本打开浏览器访问你会看到一个安全警告这是因为浏览器不信任你的自签名证书它不是由受信任的证书颁发机构签发的你需要手动选择高级或继续前往具体措辞因浏览器而异才能访问成功访问后你应该能看到服务器返回的页面你也可以使用或修改上面的连接到来测试使用时需要加上或选项来忽略证书验证修改客户端连接时如果客户端默认验证证书也会失败你需要配置客户端信任你的自签名证书高级或暂时禁用验证仅用于测试数据摘要与哈希函数验证数据完整性哈希函数也称散列函数或摘要函数是一种将任意长度的输入数据通过一个数学算法转换成一个固定长度的输出哈希值或摘要的过程核心特性单向性从哈希值几乎不可能反向推导出原始输入数据确定性相同的输入总是产生相同的输出哈希值固定长度输出无论输入多大输出的哈希值长度总是固定的例如输出总是位抗碰撞性弱抗碰撞性给定一个输入难以找到另一个输入使得强抗碰撞性难以找到任意两个不同的输入和使得主要应用场景数据完整性校验计算文件的哈希值传输或存储后再次计算哈希值进行比较判断文件是否被篡改例如软件下载网站提供的校验码密码存储不直接存储用户密码明文而是存储密码的哈希值通常加盐处理用户登录时计算输入密码的哈希值与存储的哈希值比较数据索引查找哈希表如的字典使用哈希函数快速定位数据数字签名对消息的哈希值进行签名而非整个消息提高效率中的哈希支持模块的内置模块提供了对多种安全哈希和消息摘要算法的接口包括系列以及系列和等常用哈希算法对比与选择算法输出长度位安全性评估推荐场景构造器不安全已发现严重碰撞漏洞绝对禁止用于安全目的仅限于非安全相关的文件校验和例如检查下载是否完整不安全已被攻破禁止用于安全目的遗留系统兼容非常不推荐当前安全标准广泛应用数据完整性密码存储需加盐数字签名更安全在位系统上可能更快需要更高安全性的场景性能要求不高时可变标准不同于的内部结构提供替代方案新项目可选尚未如般普及可变通常比更快且同样安全高性能哈希计算强烈建议对于新的安全应用至少使用绝对避免使用和示例计算数据的哈希值计算给定字节数据的多种哈希值需要计算哈希的原始数据必须是类型包含不同算法哈希值十六进制字符串的字典输入数据必须是类型仅作演示不推荐安全场景使用可以多次调用处理大文件分块获取十六进制表示的哈希值仅作演示不推荐安全场景使用推荐更强使用示例这是一个需要计算哈希值的示例文本必须将字符串编码为字节串如原始消息计算得到的哈希值演示对文件的哈希计算假设当前目录有一个名为的文件创建一个示例文件计算文件的哈希值缓冲区避免一次性加载大文件到内存以二进制读取模式打开文件读取完毕逐块更新哈希对象文件的清理示例文件错误文件未找到跳过文件哈希示例处理文件时出错示例安全的密码存储加盐哈希直接存储密码的哈希值是不够的因为攻击者可以使用彩虹表预先计算好的常见密码哈希值列表来快速破解为了防御彩虹表攻击我们需要为每个密码添加一个随机盐然后将密码和盐一起哈希基本流程注册时为新用户生成一个唯一的随机的盐值将用户输入的密码和盐值拼接或其他组合方式使用安全的哈希算法如计算拼接后结果的哈希值将盐值和哈希值一起存储在数据库中绝不能存储明文密码登录时根据用户名从数据库中取出对应的盐值和存储的哈希值将用户输入的密码和取出的盐值以相同的方式拼接计算拼接后结果的哈希值将计算出的哈希值与数据库中存储的哈希值进行比较如果相同则密码正确用于生成安全的随机盐生成一个指定长度的安全随机盐值使用操作系统提供的加密级随机源一般来说盐可以选择写死也可以选择动态生成使用和给定的盐来哈希密码确保密码是字节串盐值必须是类型将密码和盐组合简单拼接计算哈希值获取原始字节哈希值验证提供的密码是否与存储的哈希值匹配使用相同的盐使用相同的盐和提供的密码计算哈希值使用安全的方式比较哈希值避免时序攻击某些版本中可能没有改用模块中的方法检查用户名和密码是否匹配登录成功密码匹配登录失败密码错误模拟用户注册为该用户生成唯一的盐模拟用户注册用户密码生成的盐值十六进制显示方便查看存储的哈希值在实际应用中你会将和存储在数据库中模拟用户登录假设从数据库中获取了该用户的和模拟用户登录尝试登录密码调用函数检查登录结果进阶与替代方案虽然上述加盐哈希比简单哈希好得多但现代密码存储更推荐使用专为密码哈希设计的算法如最佳这些算法是计算密集型的可以调整工作因子使得即使有盐暴力破解的成本也极高中可以通过库或库使用它们也提供了它是一种密钥派生函数也可用于密码哈希允许配置迭代次数带密钥的哈希用于消息认证结合了哈希函数和一个秘密密钥用于同时验证数据完整性和消息来源的真实性工作原理简化发送方和接收方共享一个秘密密钥发送方使用该密钥和哈希函数如计算消息的值发送方将原始消息和计算出的值一起发送给接收方接收方使用相同的密钥和哈希函数对收到的原始消息独立计算值接收方比较自己计算的值与收到的值如果相同则消息未被篡改并且确实来自持有共享密钥的发送方共享密钥发送方计算发送消息接收方收到消息计算是验证通过否验证失败与普通哈希的区别普通哈希只能验证完整性任何人都可以计算哈希不能验证来源因为需要秘密密钥所以可以验证来源只有持有密钥的人才能计算出正确的应用场景确保请求未被篡改且来自合法客户端验证请求的来源安全协议中的消息认证中的支持模块使用和给定密钥计算消息的创建对象需要密钥消息和摘要算法例如返回十六进制表示的值验证接收到的是否与基于密钥和消息计算出的匹配重新计算使用进行安全比较防止时序攻击共享的秘密密钥必须保密实际应用中应使用更随机更长的密钥发送方发送方消息密钥生成的发送方将和发送给接收方接收方假设接收方也知道接收方收到的消息收到的使用的密钥消息验证成功数据完整且来源可信消息验证失败数据可能被篡改或来源不可信模拟篡改模拟篡改篡改后的消息使用原始篡改后的消息验证失败预期结果模拟使用错误密钥模拟错误密钥使用原始消息和但密钥错误使用错误密钥验证失败预期结果踩坑点的安全性严重依赖于密钥的保密性如果密钥泄露就失去了验证来源的作用密钥管理是使用的关键挑战数据编码安全传输的变形术在深入探讨加密以保护数据机密性之前我们先来理解一个相关但不同的概念编码编码加密核心区别目的不同编码主要目的是转换数据格式使其适应特定的传输协议存储系统或媒介确保数据能够被正确无损地处理它不提供保密性加密主要目的是保护数据内容防止未经授权的访问保密性它通常还需要保证数据的完整性和来源真实性可逆性与密钥编码算法是公开的过程通常是完全可逆的不需要密钥知道编码算法就能解码加密算法可以是公开的但必须使用密钥只有持有正确密钥的人才能解密简单来说编码是为了让数据说目标系统能听懂的语言而加密是为了让数据说只有授权者能听懂的密语本节我们重点介绍两种在网络开发中极其常见的编码方式和编码编码为什么需要想象一下你想在一段数据纯文本格式中包含一张小图片二进制数据或者通过电子邮件发送一个程序文件很多基于文本的协议或格式无法直接处理原始的二进制字节流因为二进制数据可能包含控制字符如字节这些字符在某些文本处理系统中可能有特殊含义或导致截断文本协议通常基于特定的字符集如直接嵌入任意二进制数据可能导致解析错误就是为了解决这个问题而设计的它定义了一种方法可以将任何二进制数据映射为仅包含个安全可打印的字符的序列字符集个个个加号斜杠总计个另外还有用于填充的字符第和个字符在某些场景如或文件名中不安全因此存在一个安全的变种它使用减号替换使用下划线替换工作原理简述将输入的二进制数据按每个字节位分组然后将这位再拆分成个位的单元每个位的单元可以表示个不同的值正好对应字符集中的一个字符如果原始数据字节数不是的倍数会在末尾进行填充通常用字符表示填充了多少字节应用场景嵌入数据在等文本格式中嵌入二进制内容在或中直接嵌入小型资源如图片字体格式为例如邮件传输编码邮件附件将字符串进行编码后放入请求头证书文件格式的证书文件如中间的内容就是编码的二进制证书数据格式安全警示加密这是最重要的提醒编码是完全公开可逆的转换任何知道数据是编码的人都可以轻松地将其解码回原始二进制内容绝对不能用来隐藏或保护任何敏感信息如密码私钥等它仅仅是一种格式转换工具不提供任何机密性保障中的支持模块内置的模块提供了方便的函数来进行标准和安全的编解码核心函数函数描述输入类型输出类型注意事项对字节串进行标准编码对标准编码的字节串进行解码输入必须是有效的格式否则抛异常对字节串进行安全的编码使用和替代和对安全的编码的字节串进行解码代码示例原始数据编码解码编码为什么需要编码的设计有着严格的字符限制根据标准允许的字符字母数字以及这些字符可以直接出现在中不需要编码保留字符这些字符在中有特殊的语法含义例如分隔协议和主机分隔路径段分隔路径和查询分隔查询参数等如果想在路径或查询参数值中表示这些字符本身而不是它们的特殊含义就必须进行编码不安全字符空格引号等字符以及所有控制字符和非字符都不允许直接出现在中必须进行编码编码或称百分号编码就是将这些需要编码的字符表示为其或其他指定编码字节序列的形式其中是该字节的两位十六进制表示应用场景构建查询字符串当你需要将用户输入或其他动态数据放入的查询参数时必须对这些数据进行编码以防特殊字符破坏结构或引起歧义表单提交当浏览器以方式提交表单时会对表单字段名和值进行编码路径中包含特殊字符虽然不太常见但如果路径段本身需要包含保留字符如也需要编码中的编码支持模块模块提供了处理各部分的函数包括编码和解码核心函数函数描述对空格的处理适用场景一般对字符串进行编码默认情况下字符不会被编码因为常用于路径可以传入参数指定哪些字符不编码编码为路径部分对编码的字符串进行解码解码为空格解码路径或查询部分类似于但默认会将空格编码为号它不接受参数所有保留字符都会编码除了编码为查询部分类似于但会将号解码为空格解码为空格解码查询部分接收一个字典或对列表将其编码成查询字符串如默认使用对键和值进行编码内部使用方便地构建整个查询字符串代码示例场景对路径部分进行编码假设文件名包含特殊字符我们希望在路径中使用它但要保留作为路径分隔符表示对所有保留字符都编码注意上面的做法会把也编码为如果想保留应该用默认的默认对路径编码原始文件名编码编码默认解码解码后场景对查询参数值进行编码搜索使用编码查询参数值对查询参数编码原始参数值编码后解码解码后场景使用构建完整查询字符串网络安全加密包含特殊字符也包含空格会自动处理字典并使用使用构建查询字符串参数字典生成的查询字符串输出模拟服务器端解析常用框架会自动完成会自动服务器端解析结果输出网络安全加密构建完整最终对称加密共享同一把钥匙的保险箱对称加密顾名思义就是指在加密将明文数据转换为不可读的密文和解密将密文还原为明文这两个过程中使用完全相同的密钥核心思想与流程可以把它想象成一个保险箱和一把物理钥匙共享钥匙发送方和接收方必须在通信开始前通过某种安全的方式获得并保管好同一把钥匙锁上加密使用钥匙锁上保险箱使用对称加密算法和密钥对明文进行加密得到密文运输将锁上的保险箱密文通过普通快递不安全的网络发送给打开解密收到保险箱后使用他手中那把相同的钥匙打开保险箱使用相同的对称解密算法和密钥对密文进行解密恢复出明文优点速度快计算效率高适合加密大量数据缺点密钥分发困难如何安全地共享密钥是核心难题密钥管理复杂密钥的生成存储分发轮换销毁等环节都需要极其小心和昔日标准绝对避免位密钥极其不安全已被完全破解禁止使用的改良版速度慢分组大小有缺陷也被认为过时且不安全禁止在新系统中使用核心建议彻底忘记和它们在现代密码学中没有位置现代对称加密的基石高级加密标准算法原名是当前最广泛使用最受信任的对称加密行业标准分组大小固定为位字节密钥长度支持位位位速度最快安全性足够应对当前绝大多数场景安全性更高目前最高安全级别用于长期或极高安全要求安全性算法本身极为健壮安全性依赖于密钥保密和正确的使用方式操作模式与管理块加密操作模式使用的关键本身一次只能处理位的数据块要加密更长的数据必须采用一种操作模式来定义如何链接这些块的加密过程错误的选择或使用模式将彻底摧毁的安全性模式极其危险禁止使用原理每个位明文块都使用相同的密钥独立加密致命缺陷相同的明文块产生相同的密文块这会暴露数据的内在模式想象一下加密一张图片相同颜色的区域加密后依然会呈现出相同的加密色块导致图片轮廓可见结论绝对不要使用模式进行任何需要保密的加密模式常用需正确管理原理在加密当前明文块前先将其与前一个密文块进行异或第一个明文块与一个初始化向量进行异或必须随机且唯一对于使用相同密钥的每一次加密操作必须生成一个新的随机的不可预测的重复使用会严重破坏安全性无需保密可以公开传输通常放在密文的前面解密时需要使用这个填充由于要求明文是块大小字节的整数倍如果原始数据长度不足需要在最后一个块尾部填充字节解密后需要移除填充优点隐藏了明文模式相同明文块在不同位置密文不同缺点加密过程是串行的不能并行化不提供内置的完整性认证保护仅仅是加密攻击者可能在不知道密钥的情况下篡改密文例如比特翻转攻击导致解密出损坏或被恶意修改的数据而接收方可能无法察觉除非结合适用场景过去广泛用于文件和数据库加密但现在更推荐使用等认证加密模式模式强烈推荐认证加密原理是一种认证加密模式它不仅提供数据机密性加密还同时提供数据完整性和来源真实性认证类似于将加密如模式和消息认证码如高效地结合在一起必须唯一对于使用相同密钥的每一次加密操作必须使用唯一的的长度通常推荐为位字节重复使用会导致灾难性的安全问题可能暴露密钥无需保密通常与密文一起传输可以包含附加的不需要加密但需要保护其完整性的数据例如消息头元数据协议版本号等会参与认证标签的计算认证标签在加密结束后会生成一个固定长度通常位字节的认证标签这个标签必须与密文以及如果使用的话一起传输解密时接收方不仅需要密钥密文还需要这个标签解密过程会重新计算标签并与收到的标签比较只有标签匹配解密才会成功这证明了数据在传输中未被篡改并且确实是由持有相同密钥和的发送方生成的优点一体化安全同时解决机密性完整性真实性高性能加密和解密的核心操作基于模式可以并行化通常无需填充缺点实现相对复杂一些但好的库如会封装好对的唯一性要求极高是使用的关键安全点适用场景现代安全通信如网络协议需要高保障的数据加密等的首选模式其他模式将计数器加密后与明文异或可并行无需填充常作为的基础本身不提供认证也是流式处理模式各有特点相对使用较少实现加密使用库标准库不直接提供易用的功能强烈推荐使用现代维护良好且功能强大的库安装示例使用推荐模式用于捕获验证失败辅助函数生成指定位数的随机密钥密钥大小必须是位返回随机字节串这里是为了将比特转换为字节因为密钥大小是以比特为单位的如位位而函数需要的参数是字节数字节比特所以需要用除以来得到对应的字节数例如位密钥需要字节的随机数据生成指定字节数的随机推荐字节位确保数据是字节类型如果不是则转换为字节类型加密解密函数使用模式加密数据加密密钥应为或位或字节需要加密的明文数据关联数据可选不会被加密但会被包含在认证中成功时返回一个包含三个元素的元组随机数密文认证标签均为字节类型失败时返回为本次加密生成唯一的关键准备加密器指定加密算法为并提供密钥提供可选添加附加认证数据执行加密返回加密后的密文和认证标签获取认证标签加密后自动生成返回所有需要传输存储的部分加密过程出错解密函数使用模式解密数据加密密钥应为或位或字节加密时使用的随机数应为字节位加密后的密文数据加密后的认证标签加密时提供的关联数据可选成功时返回解密后的明文数据失败时返回准备解密器同时提供和用于认证指定加密算法为并提供密钥解密时必须提供可选添加附加认证数据执行解密内部会先验证如果不匹配或数据卷被穿该此处将会引发异常解密错误解密失败认证标签无效数据可能被篡改或密钥不匹配解密错误解密时发生其他错误使用示例示例生成密钥仅用于演示实际应用需安全管理使用位密钥使用的密钥准备明文和这是需要高度保密和完整性保护的数据假设是字符串紧凑的字符串作为原始明文附加数据加密加密成功认证标签密文模拟传输存储通常需要将组合例如简单拼接模拟接收方接收到数据并解密开始解密假设接收到和解密成功解密后明文断言为真说明解密成功解密后字节如果原始不是字符串解密失败模拟攻击篡改密文模拟攻击篡改密文修改第一个字节解密肯定会失败模拟攻击使用错误的解密模拟使用错误解密被篡改预期结果解密失败因为是基于原始计算的加密失败示例使用如果必须使用且理解其局限性辅助函数用于填充生成指定位数的随机密钥密钥大小必须是位返回随机字节串这里是为了将比特转换为字节因为密钥大小是以比特为单位的如位位而函数需要的参数是字节数字节比特所以需要用除以来得到对应的字节数例如位密钥需要字节的随机数据为生成随机必须与块大小相同加密解密函数使用加密密钥为为本次加密生成随机最关键创建加密器进行填充块大小固定为位加密数据将附加到密文前面常用做法加密错误加密失败解密函数解密数据假设位于密文前面解密错误密文必须是字节串提取和密文前字节为后面的字节为密文准备解密器去除填充返回解密结果解密错误解密失败使用示例示例生成密钥密钥待加密数据这是用模式加密的数据需要注意完整性问题待加密数据加密数据加密后数据解密数据解密后数据重点不提供内置完整性保护模拟密文篡改确保能修改密文部分修改密文的第一个字节之后篡改后解密成功但数据已损坏损坏的明文尝试解码篡改后解密失败可能是填充错误结论需要额外的来保证的完整性非对称加密公钥与私钥的世界非对称加密也称为公钥加密是密码学领域的一项革命性发明它与对称加密最根本的区别在于加密和解密使用不同的密钥核心概念密钥对非对称加密系统基于一个密钥对包含两个在数学上相关联但又不同的密钥公钥可以也应该公开发布任何人都可以获取用于加密数据发送给私钥持有者或验证签名验证是否由私钥持有者签名私钥必须由所有者严格保密绝不能泄露用于解密由对应公钥加密的数据或创建数字签名这两个密钥是配对生成的通过公钥几乎不可能推导出私钥这是非对称加密安全性的数学基础工作流程类比加密通信像信箱生成一对密钥公钥私钥并将公钥公开想要给发送机密消息她使用的公钥对消息进行加密得到密文将密文发送给网络上的任何人都可以截获但没有的私钥是无法解密的收到密文后使用他自己保密的私钥进行解密恢复出明文数字签名像印章生成一对密钥公钥私钥并将公钥公开写了一份文件她想证明这份文件确实是她写的且未被篡改她使用自己的私钥对文件通常是文件的哈希值进行签名生成一个数字签名将文件和签名一起发送出去任何人比如收到和后可以使用的公钥对签名和文件进行验证如果验证通过就能确信这份文件确实来自且内容未被修改过优点解决了密钥分发问题这是非对称加密最核心的优势公钥可以安全地通过任何渠道分发网站邮件目录服务等无需担心被窃听发送方只需获取接收方的公钥即可加密信息大大简化了密钥管理实现数字签名私钥的唯一性使得非对称加密能够提供身份认证验证消息来源数据完整性确保消息未被篡改不可否认性发送方无法否认自己发送过经过签名的消息缺点速度极慢非对称加密算法涉及复杂的数学运算如大数模幂运算椭圆曲线运算其加密和解密速度比对称加密算法如慢几个数量级通常是到倍甚至更多不适合加密大量数据由于速度慢直接使用非对称加密来加密大文件或长时间的通信流是不现实的标准实践混合加密为了兼顾非对称加密的密钥管理便利性和对称加密的高效率实际应用中如等普遍采用混合加密方案生成临时对称密钥发送方为本次通信随机生成一个一次性的对称密钥例如一个密钥用对称密钥加密数据使用快速的对称算法如和密钥加密主要数据得到密文用非对称密钥加密对称密钥使用接收方的公钥加密这个一次性对称密钥得到加密后的密钥由于通常很短如或位非对称加密的性能开销可以接受传输将加密后的对称密钥和用对称密钥加密的数据一起发送给接收方解密接收方使用自己的私钥解密得到一次性对称密钥接收方再使用恢复出的对称密钥解密得到原始数据发送方生成临时对称密钥大数据使用加密密文接收方的公钥使用加密加密的密钥传输传输接收方的私钥使用解密得到使用解密得到数据应用最广泛的非对称算法是第一个实用且至今仍在广泛使用的公钥加密算法数学基础其安全性依赖于大整数分解的困难性即给定两个大素数和计算它们的乘积很容易但给定想反向分解出和则极其困难密钥生成涉及生成两个大素数并进行一系列模幂运算来得到公钥和私钥对密钥长度的安全性直接取决于密钥模数的长度位数安全警告随着计算能力的提升较短的密钥已不再安全位绝对不安全已被证明可以被破解位当前推荐的最低长度用于一般性需求位或位推荐用于需要更高更长期安全的场景使用过短的密钥是常见的安全风险填充方案极其重要原始的算法教科书式本身存在严重的安全缺陷容易受到多种攻击如选择密文攻击绝对不能直接使用原始必须结合安全的填充方案来使用填充是在加密签名前对原始数据进行处理加入随机性或特定结构以抵抗各种攻击用于加密推荐通常结合或更强的哈希函数弃用警告填充较旧的标准用于加密时存在已知的安全漏洞不应再用于新的加密应用用于签名推荐通常结合或更强的哈希函数提供了更强的理论安全证明抗选择消息攻击兼容性填充用于签名目前仍被广泛使用且相对安全不像用于加密时那么脆弱但是更现代更受推荐的选择常见用途密钥交换在混合加密中加密对称会话密钥数字签名验证软件文档证书等的来源和完整性实现使用库库提供了对密钥生成管理加密解密带填充和签名验证带填充的全面支持重命名避免与对称填充混淆用于密钥的保存和加载用于捕获签名验证失败密钥对生成生成公私钥对公共指数通常固定为密钥长度通常为或后端提供密码学操作的具体实现使用系统默认的密码学后端实现负责处理底层的密码学计算生成公钥密钥序列化保存加载将私钥以格式保存到文件可选密码保护编码格式为推荐使用格式选择密码加密或不加密私钥已保存到已加密未加密从文件加载私钥可选密码解密使用已读取的内容而不是再次调用选择密码解密或不解密后端将公钥以格式保存到文件标准格式公钥已保存到从文件加载公钥加密解密使用填充注意仅适合加密少量数据如对称密钥或短消息使用公钥加密数据使用填充掩码生成函数哈希算法标签通常为空加密失败使用私钥和填充解密少量数据掩码生成函数哈希算法标签通常为空解密失败签名验证使用填充使用私钥和填充对消息进行签名实际签的是哈希可以直接签消息内部会做哈希如果是旧版本或想明确控制可以先然后签推荐最大盐长度以增强安全性指定签名使用的哈希算法签名错误签名失败使用公钥和填充验证签名推荐最大盐长度以增强安全性指定签名使用的哈希算法签名错误签名验证失败示例生成或加载密钥对为避免每次运行都生成可以保存后加载用于加密私钥文件检测到已有密钥对加载已有密钥对已加载密钥对加载密钥对失败重新生成密钥对未检测到密钥对生成新密钥对保存密钥以便下次使用私钥使用密码加密演示加密和解密少量数据比如一个对称密钥加密解密示例假设这是我们要安全传输的密钥位要加密的对称密钥加密后的密钥前字节加密后长度通常等于密钥字节数尝试解密解密后的密钥解密验证成功解密失败加密失败其他重要非对称算法椭圆曲线密码学除了椭圆曲线密码学是另一大类非常重要的非对称算法优势最大的优点在于它能用更短的密钥长度达到与相同的安全级别例如位的密钥提供的安全性位的密钥位的密钥提供的安全性位的密钥结果性能更高更短的密钥意味着更快的计算速度加密解密签名验证带宽和存储更少密钥和签名都更小应用在性能和资源受限的环境如移动设备物联网设备智能卡中特别有优势并且越来越多地被用于数字签名是常用的标准密钥协商用于安全地生成共享密钥中广泛使用比特币等加密货币也大量使用库支持的库也提供了对密钥对生成密钥交换和签名验证的支持例如注释虽然仍非常流行但代表了现代非对称加密的一个重要发展方向尤其是在性能和效率方面第十六章操作数据库本章核心通过实现一个分层架构的操作框架深入学习数据库交互的最佳实践我们将涵盖从数据库连接管理模型定义数据访问到业务逻辑的完整流程数据库构建一个分层操作框架核心特性内置无服务器单文件数据库遵循规范常用参考表描述连接数据库文件返回对象创建对象执行单条用占位符批量执行提交事务回滚事务获取下一行结果元组或对象无结果时获取所有剩余行结果元组或对象的列表属性最后的行的属性最后操作影响的行数表示不确定或不适用关闭连接设置让查询结果可以通过列名访问类似字典用于封装要存入字段的二进制数据推荐使用上下文管理器自动处理连接关闭和基本事务框架实现步骤项目结构设置我们创建以下目录结构并在每个目录中放入文件使其成为包核心功能模块数据库连接管理表结构管理数据模型任务数据模型数据访问层任务数据访问业务逻辑层任务业务逻辑工具类日期处理工具被删减了示例代码基本操作示例高级查询示例项目说明文档要点每个目录下的文件可以是空文件是必需的它告诉这个目录应该被视为一个包从而允许我们使用点号来导入其中的模块例如这种结构实现了关注点分离只关心数据长什么样只关心如何从数据库存取这些数据只关心如何使用这些数据来完成业务目标提供底层的数据库连接等基础服务核心层实现数据库管理器此类负责管理数据库连接提供连接关闭及上下文管理语句支持任务数据模型模块定义相关的数据结构任务数据模型类使用简化代码任务标题必填优先级默认是否完成默认任务可选若不指定则由数据库自动生成截止日期可选附件可选创建时间可选任务描述可选最后更新时间可选提供的初始化后自动执行的函数用于设置默认值如果没有提供当前创建时间则使用当前时间将对象转换为字典用于数据库操作包含任务数据的字典使用获取基础字典中布尔值以存储需要转换如果为从字典中移除它从数据库行创建对象这个方法的作用是将数据库查询结果行数据转换为对象看起来复杂是因为它需要处理多种可能的输入格式对象有方法的字典类对象元组或列表形式的结果虽然简化了类定义但不能自动处理从外部数据源如数据库创建对象的过程尤其是当数据需要类型转换时如整数到布尔值这种复杂性是为了提高代码的健壮性确保从不同来源的数据都能正确转换为对象如果确定数据库始终返回同一格式的结果可以简化此方法对象或类似字典序列的对象创建的对象创建一个包含所有可能属性的字典检查中是否有每个属性并添加到使用方法避免如果有方法如使用它否则尝试按照索引获取如果索引访问失败返回具有默认值的处理布尔值转换创建并返回对象表管理器表管理模块负责数据库表的创建和基础操作提供表结构定义创建修改等功能表管理类负责数据库表的创建和操作初始化表管理器数据库连接对象数据库游标对象创建数据库表表名表列定义字典格式为列名列类型表创建是否成功确保连接和游标有效数据库连接或游标无效构建列定义字符串表已检查创建创建表时出错向已有表添加新列表名列名列类型和约束添加列是否成功已向表添加列向表添加列时出错检查表是否存在表名表是否存在检查表是否存在时出错获取表结构信息表名包含列信息的字典列表获取表信息时出错数据模型层实现前置知识使用简化类定义在定义模型之前我们先了解一下引入的一个非常有用的工具装饰器它能极大地简化用于存储数据的类的编写是从版本开始作为标准库中的模块被引入的随着版本的不断更新也逐步发展和完善为开发者提供了更加便捷的数据类创建和管理方式的主要功能在于帮助我们简化数据类的定义过程本文总结了几个我们在此框架中会用到的技巧传统的类定义方式回顾一下如果不用定义一个简单的类包含交易交易对价格是否成功地址列表大致如下传统方式定义类为了方便打印需要自己实现或通常返回更详细无歧义的表示使用传统类需要实现或才能得到有意义的打印输出如你所见我们需要编写方法来初始化所有属性还需要编写或方法才能方便地打印对象内容使用装饰器定义类现在看看用有多简单导入和使用进行类型提示使用装饰器只需声明属性及其类型提示使用提供更精确的类型提示使用自动生成了和方法运行结果会直接打印出易于阅读的对象表示关键优势自动生成方法会自动为你生成等值比较等常用方法大大减少样板代码类型提示它强制或强烈推荐使用类型提示有助于代码清晰度和静态分析默认值与设置默认值很简单直接在属性后面赋值即可但对于可变类型如作为默认值直接赋值会引发因为所有实例会共享同一个可变对象这通常不是我们想要的需要使用函数和来指定一个工厂函数一个无参可调用对象返回默认值工厂函数用于生成默认的列表调用了工厂函数演示工厂函数何时被调用字符串默认值字符串默认值数值默认值布尔默认值对于可变类型使用指定生成函数另一个例子默认空列表使用带默认值的默认值示例不提供参数将使用默认值创建第一个实例再创建一个实例验证列表是独立的创建第二个实例修改第一个实例的列表不应影响第二个修改第一个实例的后实例实例实例的列表未受影响隐藏敏感信息如果你不希望某些字段出现在即的输出中例如密码密钥等可以在中设置不希望出现在输出中也可以给设置默认值或隐藏字段示例输出中不会包含但仍然可以访问该属性访问隐藏的只读对象如果你希望创建的对象是不可变的创建后其属性值不能被修改可以在装饰器中设置这对于表示常量数据或确保数据不被意外篡改很有用设置为只读只读对象示例尝试修改属性会抛出尝试修改只读对象失败转换为元组和字典模块提供了和函数可以方便地将实例转换为元组或字典这在与其他库或模块交互时非常方便转换示例转换为元组转换为元组转换为字典转换为字典总结在中数据类主要用于存储数据定义数据类时通常需要编写一些重复性的代码如构造函数字符串表示等装饰器的出现使得这些通用方法的生成变得自动化从而极大地简化了数据类的定义过程提高了开发效率是我们在数据建模时非常有用的工具现在我们将使用来定义我们的模型任务模型使用任务数据模型模块定义相关的数据结构任务数据模型类使用简化代码任务标题必填任务描述可选优先级默认为截止日期可选是否完成默认为附件可选创建时间可选最后更新时间可选任务由数据库生成对象初始化后运行的方法用于设置默认值如果没有提供创建时间设置为当前时间将对象转换为字典用于数据库操作包含任务数据的字典中布尔值以存储只有在存在时才添加到字典中从数据库行创建对象对象或类似字典的对象创建的对象创建一个包含所有可能属性的字典检查中是否有每个属性并添加到使用方法避免如果有方法如使用它否则尝试按照索引获取如果索引访问失败返回具有默认值的处理布尔值转换创建并返回对象知识点解释版装饰器应用在类定义之前自动添加等方法属性定义与类型提示直接在类级别声明属性及其类型表示该属性可以是类型或默认值直接在属性声明后赋值即可为非可变类型设置默认值函数可选用于更精细地控制字段行为如设置用于可变默认值本例未使用但已在知识点中介绍不在打印输出中显示不由初始化不在等值比较中考虑等方法方便将对象状态转换为字典特别用于准备插入或更新到数据库的数据注意这里手动处理了从到的转换以匹配的存储方式这是一个类方法第一个参数是类本身而不是实例专门用于从数据库返回的行数据这里是对象创建类的实例这是将数据库数据映射回对象的常用模式它负责处理列名到属性的映射和必要的数据类型转换如增加了错误处理确保输入有效数据访问层实现任务仓库此类封装所有与表相关的操作并使用进行数据交互任务数据访问层模块实现对数据的操作任务数据访问类实现对表的增删改查操作表名创建任务表任务任务标题任务描述优先级默认截止日期是否完成默认附件用于存储文件创建时间最后更新时间调用的方法创建任务表向任务表添加新列新列名新列类型获取任务表结构信息包含列信息的字典列表插入新任务对象新任务的如果插入失败返回将对象转换为字典如果存在则从字典中移除因为它是自增的构建语句的执行逻辑类似于下方的代码输出执行插入操作获取新插入记录的成功插入任务任务插入失败批量插入任务记录要插入的对象列表成功插入的记录数如果插入失败则返回确保有任务要插入没有任务要插入将所有对象转换为字典移除所有因为它们是自增的确保所有任务的字段相同构建语句准备批量插入的值这段代码使用列表推导式创建一个包含所有任务数据的列表外层循环遍历每个任务字典中的每个内层循环按照中定义的列顺序提取每个任务字典中的值使用将每个任务的值转换为元组确保与方法兼容最终生成的是一个元组列表每个元组包含一个任务的所有字段值例如任务的值任务的值任务的值任务的值准备批量插入条任务执行批量插入获取新插入记录的数量成功插入条任务任务插入失败更新任务记录要更新的对象必须包含是否更新成功检查是否存在无法更新任务缺少将对象转换为字典从字典中移除他讲在子句中使用构建字句这将生成类似于下面的语句检查中是否已包含字段如果没有包含字段则使用的函数这样可以确保字段使用数据库服务器的当前时间构建语句准备参数值执行更新操作检查是否有行被更新成功更新任务未找到要更新的任务任务更新失败删除任务记录要删除的任务是否删除成功构建语句执行删除操作检查是否有行被删除成功删除任务未找到要删除的任务任务删除失败根据任务查找任务记录构建语句执行查询操作获取查询结果如果未找到返回将结果转换为对象任务查找失败查找所有任务记录构建语句执行查询操作获取所有结果将结果转换为对象列表任务查找失败根据条件查找任务查询条件字典格式为列名值符合条件的对象列表确保有条件要查询构建子句用于占位符用于条件例如查询条件若有多个条件则用连接构建语句执行查询操作获取所有结果奖结果转换为对象列表任务查找失败根据标题部分查找任务构建语句使用模糊查询执行查询使用作为通配符获取所有结果将结果转换为对象列表任务查找失败知识点解释适配与协作和方法现在接收实例它们使用来获取需要持久化的数据而不是手动从对象属性中提取的使用等查询方法现在依赖这个类方法来将数据库行数据对象转换回实例这使得模型转换逻辑集中在模型类自身布尔值处理在时将转换为数据库的在时将数据库的转换回动态构建需谨慎和方法中动态构建了语句的列名和占位符部分这样做可以使代码适应模型的变化但必须极其小心确保列名不是来自用户输入以防范注入这里列名来自是安全的错误处理继续保持了对和的捕获以及事务回滚查询方法在出错时返回空列表或职责将创建表的逻辑放在初始化时执行确保操作前表结构一定存在这是一种常见的实践模式业务逻辑层实现任务服务服务层的代码通常与底层数据模型是还是普通类关系不大因为它主要通过提供的接口接收和返回对象来工作因此之前的代码基本可以直接使用或者做少量调整以利用的特性如果需要的话任务服务模块提供业务逻辑层功能负责处理任务相关的业务规则和操作任务服务类处理任务相关的业务逻辑初始化任务服务任务数据访问对象创建新任务任务标题任务描述优先级默认为截止日期格式为是否已完成附件数据新创建任务的失败则返回验证优先级范围优先级超出范围将使用默认值验证日期格式尝试解析日期格式日期格式无效应为将设为空验证标题不为空任务标题不能为空创建任务对象保存任务批量创建任务包含任务数据的字典列表成功创建的任务数量失败则返回没有任务数据需要创建验证必要字段跳过缺少标题的任务创建任务对象没有有效的任务需要创建批量保存任务更新任务要更新的任务要更新的字段和值更新是否成功查找现有任务未找到要更新的任务更新字段忽略未知字段保存更新将任务标记为已完成要标记的任务操作是否成功删除任务要删除的任务删除是否成功获取指定的任务任务任务对象未找到则返回获取所有任务任务对象列表获取指定优先级的任务优先级任务对象列表获取未完成的任务任务对象列表中布尔值存储为获取已逾期的任务任务对象列表获取所有任务筛选出截止日期已过且未完成的任务搜索标题包含指定字符串的任务标题中要搜索的文本符合条件的任务对象列表获取指定天数内到期的任务天数任务对象列表获取所有任务筛选出在指定日期范围内到期的任务知识点解释适配由于返回的是实例层的方法如可以直接操作这些对象的属性代码更简洁业务规则体现中增加了对和格式的校验增加了对任务是否已完成的检查避免重复操作增加了对不可修改字段的保护并对传入的字段和值进行基本检查中日期的解析和比较逻辑清晰地放在服务层调用所有与数据库的交互都委托给使用示例现在我们已经构建了框架的各个组件模型接下来将通过几个具体的示例脚本来演示如何使用这个框架完成不同的数据库操作任务注意运行这些示例脚本时请确保环境中已经安装了必要的库虽然是内置的但未来章节可能需要等脚本能够正确导入我们之前创建的模块这通常意味着你需要从这个项目的根目录来运行这些示例脚本或者确保目录位于的模块搜索路径中示例代码中会包含尝试处理路径的代码每个示例脚本可能会创建自己的数据库文件如这些文件会出现在脚本运行的目录下或指定的子目录中基本操作示例这个脚本演示了最核心的创建读取更新删除操作展示了如何通过来与数据库交互基本数据库操作示例模块展示数据库的基本操作包括连接创建表增删改查等基本功能基本操作示例类实现单例模式确保类只有一个实例初始化示例类避免重复初始化初始化数据库和表结构初始化是否成功若数据库文件存在则删除原有数据库创建任务表初始化数据库失败清理数据库文件清理是否成功插入示例任务数据成功插入的任务数量插入示例任务数据任务这是任务的描述任务这是任务的描述任务这是任务的描述任务这是任务的描述任务这是任务的描述插入单个任务要插入的任务对象插入的任务失败则返回查询所有任务任务列表根据查询任务任务任务对象未找到则返回根据条件查询任务查询条件字典符合条件的任务列表根据标题模糊查询任务标题包含的文本符合条件的任务列表更新任务要更新的任务对象更新是否成功删除任务要删除的任务删除是否成功关闭数据库连接实例化示例类初始化示例插入示例任务数据插入示例任务数据查询所有任务查询所有任务查询单个任务查询单个任务查询任务列表查询高优先级任务查询任务标题包含某些字符的任务查询标题包含任务的任务任务更新任务更新任务任务更新这是任务的更新描述查询更新后的任务查询更新后的任务删除任务删除任务查询删除后的任务查询删除后的任务关闭数据库连接关闭数据库连接代码解释目的专注于演示框架的基本功能流程按照连接初始化创建表插入查询更新查询删除查询关闭的逻辑顺序进行交互主要通过实例的方法来完成数据库操作模型使用创建对象用于插入和更新接收对象列表作为查询结果连接管理示例中使用了手动的和来展示如何接收和在实际应用或更复杂的示例如下面的事务示例中使用语句通常是更好的选择错误处理在主流程外层添加了来捕获可能的数据库错误或其他异常并确保连接最终被关闭高级查询示例此脚本展示了更复杂的查询场景包括直接执行和通过框架的层进行查询高级查询示例模块面向对象重构版使用类封装演示流程遵循面向对象原则使用彩色输出展示数据库的高级查询功能通过调用分层框架实现导入引入类型提示导入框架组件辅助类用于彩色样式化打印定义转义码常量用于彩色输出紫色用于标题蓝色用于或代码青色用于提示信息绿色用于成功信息黄色用于警告红色用于错误加粗下划线重置所有格式打印辅助函数打印带样式的标题打印带样式的子标题打印普通信息打印成功信息打印警告信息打印错误信息打印格式化的语句打印格式化的查询结果项使用的自动生成支持或字典主演示类面向对象的高级查询演示类封装了演示的设置执行和清理逻辑类属性定义数据库文件路径初始化演示类实例初始化高级查询演示创建实例但不立即连接初始化依赖对象为执行数据库清理私有方法清理旧的数据库文件旧数据库文件已清理清理数据库文件失败清理失败可能导致后续问题可以选择退出或继续私有方法建立数据库连接初始化框架组件并填充测试数据设置数据库和框架组件在中已创建使用语句管理连接注意这里我们将和存储在上以便后续方法使用这在简单演示类中可行但在多线程或长期运行应用中需谨慎管理状态直接调用未能获取数据库连接或游标初始化依赖初始化时会尝试创建表初始化依赖和初始化成功新建数据表填充测试数据填充测试数据失败如果填充失败抛出异常获取未来日期字符串向后推的天数日期格式默认为未来日期字符串私有方法向数据库填充测试数据防御性检查填充测试数据完成项目设计文档项目需求和架构设计修复关键修复用户报告的登录问题制定项目计划项目时间线和里程碑规划紧急会议准备代码重构重构认证模块的代码单元测试编写为核心功能编写单元测试文档更新更新文档中期报告撰写性能优化优化数据库查询性能学习新技术学习技术代码审查审查团队成员的代码环境搭建搭建开发环境需求分析分析用户需求旧项目归档已尝试插入条测试数据成功条填充测试数据过程中发生错误私有方法演示直接执行原生查询演示直接执行原生查询数据库游标无效按优先级统计任务数量连接查询示例语法演示仅演示语法表不存在使用表达式统计任务状态复杂条件查询一周内到期的高优先级未完成任务找到条分页查询获取第页数据每页条第页每页条子查询查找所有今天到期的任务使用今天到期的任务条执行原生查询时出错私有方法演示使用方法进行查询演示使用方法进行查询未初始化查找优先级为的任务找到条查找已完成的任务找到条搜索标题中包含代码的任务代码找到条组合条件查询优先级且未完成找到条使用查询时出错私有方法演示使用方法进行业务查询演示使用层进行业务查询未初始化获取未完成的任务找到条及其他条获取未来天内到期的任务找到条获取已逾期的未完成任务找到条使用查询时出错执行完整的演示流程设置填充数据各种查询演示清理使用确保数据库连接总是被关闭步骤设置数据库和框架使用语句确保连接在完成后也可用同时在方法结束时通过关闭或者让返回步骤执行各种查询演示所有查询演示执行完毕数据库连接错误捕获中可能抛出的错误运行时错误可能在设置或填充数据时数据库操作错误发生意外错误步骤清理无论方法中发生什么都确保关闭连接高级查询演示流程结束脚本入口创建演示类的实例运行演示代码解释目的展示更复杂的查询以及如何在不同层次原生执行它们创建了多样化的任务数据包括不同的优先级截止日期和完成状态为后续复杂查询提供基础直接使用执行这展示了聚合函数和用于统计分析表达式在中实现条件逻辑复杂子句结合比较运算符和内建日期函数多列排序和实现分页子查询进行基于关联的条件判断优点可以利用数据库特定的高级功能或编写难以表达的优化查询缺点绕过了框架的封装代码与数据库耦合容易出错且有注入风险如果不是硬编码的话使用提供的和方法展示了通过抽象接口进行条件查询使用提供的面向业务的方法如这体现了层封装业务逻辑查询的优势主函数负责初始化框架组件使用调用数据填充函数然后依次调用三种查询方式的演示函数数据库使用驱动简介是一个非常流行的开源关系型数据库管理系统广泛用于各种规模的应用程序尤其是应用它采用客户端服务器架构需要独立的服务器进程是一个让程序能够连接并操作数据库的纯驱动库它实现了的规范提供了一套标准的数据库操作接口前提在使用前你需要确保本地或远程有一个正在运行的服务器版本或更高你拥有连接该服务器所需的主机地址端口号用户名密码服务器上已经创建了你要操作的数据库安装与主要不同需要网络连接到服务器连接时参数更多参数占位符是需要特别注意字符集和游标类型的设置连接管理关闭连接池更为重要建立连接连接是与服务器交互的第一步我们把上一章的打印工具给拿过来放置在根目录打印工具模块提供彩色和结构化的打印函数彩色打印工具彩色打印工具当我们需要使用时直接导入并像调用函数一样调用即可连接示例导入字典游标类类型提示数据库连接配置警告生产环境中绝不应硬编码密码应使用更安全的方式管理凭证服务器主机名或地址默认端口替换为你的用户名替换为你的密码替换为你要连接的数据库名需预先创建强烈推荐支持完整包括强烈推荐让查询结果以字典形式返回推荐关闭自动提交显式控制事务可选连接超时时间秒获取数据库连接的函数尝试建立到数据库的连接尝试连接到成功连接到数据库数据库连接失败请检查配置服务器状态及网络连接连接参数关键点确保可以正确处理各种字符包括表情符号数据库表列也应使用此字符集使返回字典返回字典列表可通过访问数据比元组索引更易读禁用自动提交所有操作都需要显式调用才生效便于事务管理安全绝不在代码中硬编码生产环境的密码使用环境变量配置文件等安全机制核心概览遵循规范核心与类似但注意占位符和游标类型描述注意事项连接返回对象参数多需网络创建对象推荐返回字典执行单条用占位符返回受影响行数占位符批量执行用返回受影响总行数可能不精确占位符提交当前事务时必需回滚当前事务显式开始事务若可选但更清晰获取下一行结果字典或元组无结果时依赖获取所有剩余行结果字典或元组的列表依赖属性最后操作的自增列属性最后操作影响的行数对可能不同数据库行为有差异必须调用关闭网络连接极其重要推荐游标上下文管理器自动关闭游标检查连接活性可选重连用于长连接场景准备工作创建表与填充数据为了演示查询我们创建和表表列名数据类型是否允许键默认值额外注释产品类别主键类别名称类别描述表列名数据类型是否允许键默认值额外注释产品产品名称价格库存外键关联上架日期创建时间更新时间这两个函数仅是一次性的用于创建表与插入数据可以看看语法也可以不看简单的而已连接示例导入字典游标类类型提示数据库连接配置警告生产环境中绝不应硬编码密码应使用更安全的方式管理凭证服务器主机名或地址默认端口替换为你的用户名替换为你的密码替换为你要连接的数据库名需预先创建强烈推荐支持完整包括强烈推荐让查询结果以字典形式返回推荐关闭自动提交显式控制事务可选连接超时时间秒创建连接尝试连接到连接成功数据库连接失败请检查配置服务器状态及网络连接表结构定义与创建创建演示所需的和表开始创建表先删除依赖表再删除主表旧表和已删除如果存在创建表类别名称类别描述产品类别表表创建成功创建表包含外键产品产品名称价格库存外键关联表上架日期创建时间更新时间名称前缀索引删除类别时产品类别设为更新类别时产品自动更新产品信息表表创建成功提交更改创建表失败数据填充向和表填充测试数据开始填充测试数据插入类别电子产品手机电脑配件等图书音像各类实体书籍和数字媒体服装鞋包男女服装鞋子和箱包家居生活家具厨具家纺等插入了个类别获取类别用于关联注意更可靠的方式是按名称查询获取这里简化插入产品智能手机电子产品蓝牙耳机电子产品深度指南图书音像算法导论原版图书音像纯棉印花恤服装鞋包透气运动跑鞋服装鞋包北欧风实木餐桌家居生活乳胶记忆棉枕头家居生活游戏本电子产品科幻短篇小说集图书音像速干运动短裤无类别咖啡机家居生活查询的艺术图书音像插入了个产品提交所有插入测试数据填充完成填充数据失败连接数据库创建表结构填充测试数据查询数据查询数据数据库操作与查询详解插入数据插入单行记录插入单个产品记录数据库连接产品名称产品价格产品库存产品分类可选产品添加日期可选新插入的产品若插入失败则返回获取自增主键值成功插入产品插入产品失败连接数据库新插入的产品插入产品失败批量插入记录批量插入产品记录数据库连接产品列表列表项为元组包含五个字段新插入的产品列表若插入失败则返回获取自增主键值成功插入个产品插入产品失败使用创建数据库连接演示插入多个产品华为小米新插入的产品列表注意在使用的时候时不能存储以上的由于我们上面插入的外键最高为若需要更新为类别的则需要增加的数量更新数据更新指定产品的库存增加或减少注意在真实应用中直接加减可能导致并发问题应使用更安全的更新方式例如这里仅作基本演示获取当前库存更新库存失败未找到产品为的记录计算新库存更新库存失败库存不足当前库存增加数量执行更新成功更新产品为的库存为为可能是不存在或值未改变更新库存失败未找到影响行数更新库存失败创建数据库连接更新商品库存库存更新成功库存更新失败删除数据根据删除产品成功删除产品删除产品时未找到匹配记录删除产品失败使用创建数据库连接测试删除产品删除产品成功删除产品失败查询数据基础查询所有列演示查询演示查询核心知识点获取全部结果集查询结果条结果查询失败查询指定列演示查询查询所有产品的名称和价格前条核心知识点核心知识点查询到条记录查询失败查询数据条件过滤等于演示查询查询商品分类为的产品假设要查询分类为的产品核心知识点查询到条记录查询失败比较运算符演示查询查询商品价钱大于的所商品名和价格查询到条记录查询失败区间查询演示查询查询商品价格在之间的商品且通过商品价格降序排序查询到条记录查询失败演示查询查询类别为或电子产品或家居生活的产品有几个参数就有几个占位符查询到条记录查询失败模糊匹配演示查询查询名称包含运动的产品运动注意需要在参数中传递而不是直接放在字符串里查询到条记录查询失败演示查询查询没有上架日期的产品查询到条记录查询失败组合条件演示查询查询图书音像类或价格低于元且库存大于的产品查询到条记录查询失败查询数据排序单列排序演示查询按库存数量降序排列产品前查询到条记录查询失败多列排序演示查询按类别升序价格降序排列产品前确保先按排序相同的再按降序查询到条记录查询失败查询数据去重演示查询查询现有的所有产品分类的查询到条记录查询失败查询数据聚合函数演示查询计算产品统计信息总数总库存平均价最高价最低价查询到条记录查询失败查询数据分组演示查询按类别名称分组统计各类别的产品数量和平均价格从表获取分类名称统计每个分类下产品数量统计每个分类下产品平均价格左连接表按照类别名称分组按产品数量倒序排列查询到条记录查询失败查询数据分组过滤演示查询按类别分组并找出平均价格高于元的类别使用外键关联分类使用过滤分组结果按平均价格降序排序查询到条记录查询失败查询数据分页分页查询获取第页数据每页条第页每页条获取条记录查询失败查询数据连接查询内连接必须要两边表都有匹配的数据才会出现在结果中演示查询内连接查询获取产品及其对应的类别名称只显示有类别的产品只返回两个表都能匹配上的行限制输出查询到条记录查询失败左连接左连接保留左表所有行右表无匹配则补空演示查询左连接查询获取所有产品及其类别名称没有类别的产品也会显示这里换成就会少一条记录没有类别的产品返回左表的所有行查询到条记录查询失败查询数据表达式演示查询使用表达式根据价格给产品分类入门级标准级进阶级旗舰级给结果起别名限制输出查询到条记录查询失败查询数据子查询演示查询子查询查找价格高于平均价格的产品查询到条记录查询失败更详细的语法详见篇章表达式语言提供了一种使用对象构建语句的方式避免直接拼接字符串从而提高代码的安全性和可维护性本节将核心概念和常用通过表格和简洁示例进行介绍首先你需要安装库本身不包含数据库驱动程序它依赖于第三方驱动来与具体的数据库进行通信因此你还需要根据你使用的数据库安装相应的驱动通过驱动实现与数据库的连接和交互常用数据库及其推荐驱动数据库连接方言推荐驱动安装命令示例内置无需额外安装选择驱动对于是最常用且功能最全的选择包含了预编译的扩展安装更方便对于是一个性能较好的扩展驱动但可能需要编译环境是纯实现安装简单兼容性好在许多场景下性能也足够连接中需要指定驱动如或的驱动是内置的本章我们还是使用作为核心驱动引擎数据库连接的入口是应用与数据库交互的起点负责管理连接池和数据库方言创建引擎使用函数创建参数类型描述示例文件必需数据库连接格式为具体格式见下方说明可选默认为设为时打印执行的所有语句调试时非常有用可选连接池保持的最小连接数可选超出后允许额外创建的最大连接数可选连接在连接池中保持多少秒后被回收防止数据库服务器因超时关闭连接小时可选传递给底层方法的额外参数某些驱动可选设置执行选项如事务隔离级别可选用于序列化数据可选用于反序列化数据数据库连接详解格式数据库类型等可选使用的库等如果省略会尝试默认驱动示例文件注意三个内存或者仅创建不同数据库的示例创建示例文件数据库三个斜杠表示相对或绝对路径会打印执行的语句非常适合学习和调试创建文件数据库引擎成功带日志可以在这里测试连接可选文件数据库连接测试成功内存数据库四个斜杠或仅创建内存数据库引擎成功使用驱动替换为你的实际配置连接池中保持的最小连接数超出后允许临时创建的最大连接数连接示例请替换为实际配置创建引擎配置示例使用驱动推荐在中指定创建引擎配置示例创建引擎失败缺少必要的数据库驱动请安装相应的库错误创建引擎时发生意外错误元数据与表定义使用对象在代码中定义数据库模式核心类与概念类概念描述表和其他模式对象的容器通常一个数据库一个实例代表数据库中的一张表关联到代表表中的一列包含名称类型和约束独立于数据库的类型如等约束条件如主键外键唯一非空检查约束索引简单来说中的对象就是一个数据库结构蓝图的登记簿它主要干两件事记录信息它收集并保存了你在代码里定义的所有数据库表对象列索引外键等这些蓝图信息操作数据库结构当你需要根据这些蓝图在实际数据库中创建表时你会用到它比如调用就能把所有登记在册的表都建出来构造函数关键参数参数类型描述必需表名必需关联的对象等对象必需定义表的列和表级约束特定数据库方言的选项如构造函数关键参数参数类型描述列名通常省略会使用属性名必需列的数据类型如是否为主键是否允许为空默认为级别的默认值或数据库级别的默认值如或是否唯一是否为此列创建索引对象定义外键约束指向目标表名目标列名或更新行时自动设置的值常用于时间戳或等数据库级别的更新触发器列注释部分数据库支持主键唯一索引默认值非空等示例数据库默认值级默认值外键约束示例表级约束与索引示例定义名为的表表名为关联的对象主键列整数类型自动增长产品名称列字符串最大长度库存单位列字符串最大长度表级唯一约束确保值在整个表中唯一在列上创建索引加快查询速度例如根据产品名称搜索常用类型类型映射的常见类型示例需要数据库支持用于数据库配置创建数据库如果不存在连接到不指定数据库检查数据库是否存在如果数据库不存在则创建数据库不存在正在创建数据库创建成功数据库已存在创建数据库时出错定义表结构示例创建对象对象已创建定义表表名关联的对象类别主键自增类别名称非空唯一注释指定存储引擎指定字符集指定排序规则指定行格式定义表产品主键自增产品名称价格类别外键中常用类型并设置自动更新创建时间更新时间是否激活指定存储引擎支持事务和外键指定字符集支持中文指定排序规则支持中文指定行格式支持动态行创建表表创建完成中包含的表表的列信息列名类型主键外键先确保数据库存在创建数据库连接创建表结构定义创建表检查表结构执行表达式语句定义好表之后就可以使用构建并执行语句了核心执行流程获取连接使用或推荐自动事务管理构建语句使用添加子句链式调用等方法执行处理结果对于事务管理如果使用操作后需或如果使用事务自动处理常用语句构建函数方法函数方法用途示例构建语句构建语句参数是列对象或表对象构建语句构建语句指定要插入或更新的列和值指定过滤条件指定排序方式限制返回结果数量跳过指定数量的结果用于分页连接其他表参数通常是目标表和连接条件给列或表达式设置别名用于执行原生字符串配合参数绑定使用常用条件操作符函数操作符函数用途示例基本比较逻辑与逻辑或逻辑非操作通配符不区分大小写的某些数据库操作操作函数如结果处理返回一个结果对象用于获取数据方法描述获取所有行返回对象列表获取下一行返回对象或获取指定数量的行返回对象列表获取结果的第一行第一列的值无结果或多列时行为可能变化或报错返回迭代产生每行第一列的值获取第一行对象无结果返回常用获取唯一一行无结果或多于一行时报错获取唯一一行无结果返回多于一行时报错返回迭代产生字典形式的行直接迭代结果对象每次迭代返回一个对象属性操作影响的行数属性操作的自增主键元组可能只包含第一个插入行的主键属性返回结果的列名列表对象访问按索引按列名或按列对象转字典或旧版用于固定的代码请放在最上面插入单行记录插入类别表数据类别表插入示例插入单条记录插入单个产品记录书籍类打印生成的自动事务管理获取自增主键成功插入类别书籍类成功插入类别书籍类无法获取主键插入类别书籍类时不为插入类别书籍类时出错插入产品表数据产品表插入示例先获取已插入的类别书籍类未找到书籍类类别获取实际的值使用具体的值插入产品书籍使用具体的值打印生成的自动事务管理获取自增主键成功插入产品书籍成功插入产品书籍无法获取主键插入产品书籍时不为插入单个产品时出错先执行类别表插入批量插入记录批量插入示例批量插入多个产品记录编程教程大话西游之月光宝盒使用事务成功插入条记录插入失败更新数据更新示例更新商品价格成功更新条记录更新失败批量更新记录批量更新示例价格提高构建语句成功更新条记录更新失败删除数据删除示例成功删除条记录删除失败批量删除记录批量删除示例批量删除数据例如成功删除条记录删除失败在进入最重要的查询的基础前我们可以看到代码有很多是重复的每一次都要进行捕获这个繁杂的过程会导致代码冗余我们可以采用的思想去实现一个事务的装饰器如下添加事务装饰器思想实现使用思想实现的事务装饰器可以直接应用于函数上无需手动管理事务用法使用默认引擎执行操作自动事务管理使用自定义引擎执行操作自动事务管理如果未指定引擎使用全局引擎创建参数如果已经有连接传入则使用该连接注入到被装饰函数的中事务执行失败处理和两种调用方式通过这个装饰器我们就可以实现代码的优雅性使用事务装饰器实现的方法使用事务装饰器实现的批量插入批量插入示例使用事务装饰器编程版教程版大话西游之月光宝盒版不需要手动管理事务直接执行成功插入条记录查询数据基础查询所有产品的所有列查询所有产品的前条查询数据条件过滤导入逻辑操作符用于基础查询查询所有产品的前条条件查询查询类别为的产品查询价格大于的产品名称和价格降序查询价格在到之间的产品名称和价格升序查询类别在中的产品查询名称包含的产品增加字段到表查询类别为且价格小于或库存大于的产品基础查询示例条件查询示例查询数据排序查询数据排序按价格降序排列产品前条使用指定降序按类别升序价格降序排列产品前条先按类别升序同类别内按价格降序查询数据去重查询所有类别并去重查询数据聚合函数计算产品统计信息总数总库存平均价最高价最低价计算产品总数并取别名计算总库存并取别名计算平均价格并取别名计算最高价格并取别名计算最低价格并取别名聚合查询通常只有一行元组结果未能获取产品统计信息查询数据分组按类别分组计算产品统计信息未能获取产品统计信息按类别分组计算产品统计信息产品数量大于的类别类别产品数量价格总和产品数量大于价格总和大于未能获取产品统计信息查询数据分页分页查询产品数据每页条第页当前页码每页显示条偏移量获取总记录数分页查询总记录数总页数当前页数据演示分页效果查询数据连接查询内连接查询获取产品及其对应的类别名称只显示有类别的产品使用设置别名指定要连接的表指定连接条件指定过滤条件如果已定义通常能自动推断条件查询数据表达式使用表达式根据价格给产品分类白金级进阶级标准级入门级未知查询数据子查询子查询方法快速参考为了方便快速选择合适的子查询构建方式这里根据核心使用场景进行了归纳方法概念核心场景一句话概括关键点提示中与单个预期值比较子查询应返回单行单列用于等比较或中像表一样使用子查询结果像操作普通一样操作它用访问列聚合列需用命名直接用中与列表比较如子查询应返回单列多行如常与配合中检查是否存在满足条件的关联行只关心有没有不关心是什么或有多少需要在同一查询中区分同一个表的多次引用时相关子查询和自连接的必备工具较少用显式声明子查询依赖的外部表主要用于非子句的子查询或自动关联失效时需数据库支持子查询引用同中之前的表用于行级计算或复杂的查询选择思路小结需要子查询返回一个值来比较需要把子查询的结果当作一张表来连接或从中选择需要判断某个东西是否在子查询返回的列表里直接用配合只需要判断有没有符合条件的关联数据不在乎具体内容查询中涉及自己和自己比相关子查询自连接子查询用在子句中子查询查找价格高于平均价格的产品构建子查询计算平均价格返回一个标量值而不是一个结果集用于子句中比较构建主查询在子句中使用子查询结果子查询用在子句中子查询查找每个类别中价格最高的产品使用派生表构建子查询找出每个对应的最高价格表示一个子查询可以作为主查询的一部分也可以作为一个用来的对象将主表与子查询连接找出价格等于该类别最高价的产品将主表与子查询连接指定连接条件价格等于该类别最高价子查询用在子句中子查询查找价格在到之间的产品以及这些产品所属的类别构建子查询找出价格在指定范围内的产品使用子句查询符合条件的产品及其类别信息子查询用于自连接比较子查询查找比同类别平均价格高的产品创建产品表的别名用于自连接表示一个子查询可以作为主查询的一部分也可以作为一个用来的对象构建主查询连接原表和子查询数据库函数通过这个特殊对象提供了一种与数据库无关的方式来调用内置函数这意味着你可以用统一的语法如来生成对应数据库如的特定函数调用如的方言会负责进行正确的语法转换常用函数调用参考表下表列出了一些常用的函数及其通过调用的方式调用示例对应函数常见用途说明分类计数指定列或所有行聚合求和聚合平均值聚合最大值聚合最小值聚合计算非重复值的数量聚合获取当前日期时间时间戳日期时间获取当前日期日期时间获取当前时间日期时间提取日期时间部分日期时间字符串转小写字符串字符串转大写字符串获取字符串长度字符串字符串拼接字符串提取子字符串字符串绝对值数学四舍五入数学生成随机数具体行为看数据库其他注意某些函数特别是日期时间函数的具体名称和行为可能因数据库方言而异但通过调用通常能提供较好的兼容性代码示例完整版数据库函数示例展示中各种数据库函数的使用方法包括聚合函数字符串函数日期时间函数数学函数和条件函数使用调用数据库函数完整示例演示聚合函数演示字符串函数演示日期时间函数演示数学函数演示条件函数展示聚合函数的使用聚合函数示例产品统计聚合统计结果未能获取产品统计信息执行聚合查询时出错展示日期时间函数的使用日期时间函数示例数据库当前时间和日期部分提取日期时间函数结果函数名值展示数学函数的使用数学函数示例数学运算绝对值向上取整向下取整符号平方根幂运算取模四舍五入数学函数结果函数名值执行数学函数查询时出错对象关系映射将数据库表映射为类允许通过对象进行数据库操作它是的核心功能构建于之上核心概念类表对象行属性列建议项目结构用于示例根目录和设置使用模型定义操作示例类打印工具主运行脚本创建表调用示例的数据库交互句柄是与数据库交互的接口管理对象状态和事务文件知识点创建工厂配置好的类实例配置必需默认推荐默认生命周期作用域短期存在非线程安全应用模式每请求一严禁全局共享实例上下文管理自动管理核心方法快速参考方法用途说明添加新对象实例标记为待添加多个新对象实例标记持久化对象为待挂起更改并提交事务回滚事务撤销更改将更改同步到不提交事务获取自增等通过主键高效获取单个对象执行语句查询主要方式代码示例和设置使用核心配置模块此模块包含数据库连接引擎和会话的配置提供了创建数据库引擎和会话工厂的功能用于整个应用程序的数据库交互主要组件数据库连接引擎本地会话工厂用于创建数据库会话数据库引擎会话工厂打印工具数据库连接配置使用生产环境应使用更安全的方式管理密码确保此数据库已创建数据库连接打印时隐藏密码创建针对打印语句启用新特性连接池大小连接池溢出时最多创建的连接数连接池中连接的最大空闲时间超过此时间的连接会被自动关闭数据库引擎创建成功创建工厂自动提交推荐关闭自动刷新绑定引擎会话在提交后过期会话工厂创建成功使用示例通常在其他模块中声明式映射定义模型使用带类型注解的类映射数据库表风格文件知识点模型基类包含模式信息定义表名类型注解定义列属性类型约束在此定义定义不映射到表的抽象模型基类普通类用于通过多重继承共享属性或方法代码示例和定义基础模型模块此模块定义了应用程序中所有模型的基类和类主要组件所有模型的基类各种可复用的类如提供时间戳功能与是做什么用的例如类型注解工具这是引入的主要用于类型提示它告诉开发者和其他工具如静态类型检查器这个类属性是一个被映射的字段并且它在代码中的期望类型是什么提高可读性让模型定义更清晰易懂例如列定义函数这是实际用来定义数据库列属性的函数您可以在这里指定该列在数据库中的具体类型如是否为主键是否允许为空默认值或索引外键注释等它是中声明模型列的首选方式用于替代旧版本中直接使用的方式定义继承后会得到什么声明式能力继承后基类就获得了将类定义直接映射到数据库表的能力属性这个类会自动拥有一个名为的对象所有继承自的模型类其表结构信息都会自动注册到这个中操作基础使得后续可以通过来自动创建所有定义的数据库表所有模型的基类可选可以定义一个对象来控制行为定义用于共享字段逻辑提供时间戳功能的类使用和选项可以利用数据库能力自动管理时间戳创建时间更新时间定义抽象基类可选用于共享等基础字段包含通用和逻辑删除标记的抽象基类不会创建对应的表主键中常用来存储布尔值中可以用类型他会自动映射为逻辑删除标记已定义定义关系在模型间建立关联映射数据库外键文件在模型类中添加修改定义知识点核心必须用于双向关系值是对方模型的关系属性名加载策略默认易适合推荐可在查询时用覆盖指定多对多关联表控制级联操作等模型定义模块此模块包含具体的模型类定义用于映射到数据库表主要模型映射到表的分类模型映射到表的产品模型与有关联关系导入从同目录的导入绝对导入定义具体模型继承和产品类型模型类别名称类别描述添加关系见下一节目标模型类名指向类的属性级联操作删除时同时删除关联的延迟加载仅在需要时才加载数据打印对象信息产品模型产品名称使用作为类型提示数据库类型由指定产品价格和用于设置默认值用于设置数据库默认值库存数量是否上架外键定义关联表的列删除时设置为类别所属添加关系具体模型含关系占位已定义创建表的函数通常在应用启动或脚本中调用尝试创建所有模型对应的表表已创建如果尚不存在创建表时出错操作使用和主要通过结合语句或直接操作管理的对象文件代码示例操作模块此模块演示了的基本创建读取更新删除操作主要功能创建创建新的类别和产品记录读取按条件筛选和排序查询记录更新更新现有记录的属性删除从数据库中删除记录导入语句构造模块导入异常处理模块导入会话模块导入会话工厂导入模型定义封装示例的类依赖注入对象记录最后一个插入的类别记录最后一个插入的产品创建对象创建和对象并插入到数据库中创建对象开启事务创建对象书籍类书籍类产品包含各类图书将对象添加到会话中刷新会话以便获取新插入对象的记录最后一个插入的类别创建并关联编程指南将对象添加到会话中刷新会话以便获取新插入对象的记录最后一个插入的产品创建对象成功创建对象失败查询对象查询对象按主键查询使用查询查询结果查询结果未找到的对象条件查询获取第一个条件查询查询结果查询结果未找到符合条件的对象查询失败更新对象更新对象开启事务方法一修改对象属性修改的价格直接修改属性查询结果未找到的对象方法二级语句批量批量降低书籍类的库存书籍类批量修改库存重要更新后刷新中的对象执行后受影响行以更新最安全但可能慢尝试在中评估更新效果快但可能不精确不更新中的对象状态最快但可能与不一致受影响的行数更新操作已暂存待外层更新失败删除对象删除对象事务方法一删除单个对象删除标记删除已标记删除未找到方法二级语句批量批量删除类别为的产品批量删除影响了行删除操作已暂存待外层删除对象时出错在中如何使用决定是否执行删除提交所有操作主事务已提交主流程出错主事务已回滚运行示例测试主运行脚本此脚本作为项目的入口点创建数据库表并运行各个示例模块的功能演示主要功能初始化数据库创建所有所需的表运行示例按顺序调用各个模块的示例功能演示工作流展示完整的使用流程和最佳实践创建数据库表创建数据库表创建所有模型对应的表所有表已创建如果尚不存在打印创建的表信息数据库中的表创建表时出错运行操作示例运行操作示例使用会话上下文管理器创建操作执行器创建对象创建对象失败跳过后续操作查询对象更新对象删除对象可选取消注释下一行以执行删除操作提交所有操作所有操作已成功提交执行操作时出错所有操作已回滚创建表结构运行示例程序执行完毕轻量级映射器是一个为开发者设计的轻量级映射框架其核心理念与领域知名的框架相近它旨在提供一种方式让开发者能够更直接地控制语句的编写和执行同时又通过映射机制简化代码与数据库之间的交互对于既想利用的全部能力进行性能调优或处理复杂逻辑又希望避免直接操作原生数据库驱动如时繁琐的模板代码的场景是一个值得考虑的工具核心知识核心定位半自动化映射器强调控制权主要功能特性概览特性编号功能描述详细说明与开发者价值半自动化的提供方法到语句的映射以及结果集到字典或简单对象的转换简化数据访问代码但开发者仍需编写支持动态核心特性之一允许在文件中使用等标签根据传入参数动态构建和调整语句实现复杂查询逻辑装饰器提供了类似注解的装饰器等可直接在方法上绑定语句适用于简单固定的操作缓存及过期机制内置基于算法的查询缓存可配置缓存池大小和条目过期时间对不经常变动但查询频繁的数据能有效提升性能支持当使用语法时优先使用预编译语句将结构与数据分离这是防御注入攻击的关键手段预防大对象机制内置机制通过参数限制从数据库拉取并处理的数据总量旨在避免因查询结果集过大导致的应用程序内存溢出问题多数据库支持目前明确支持和可以通过指定不同的安装库数据库及表示例准备确保服务已启动并已创建相应数据库用户及授权以下用于创建本节演示所需的库和表创建数据库如果不存在使用字符集以支持更广泛的字符创建用户并授权请务必将替换为强密码刷新权限使之立即生效切换到目标数据库创建示例表水果类别表类别主键类别名称唯一类别描述水果类别表创建示例表水果信息表并设置外键关联水果主键水果名称类别外键允许为表示未分类价格单位分使用整数存储以避免浮点精度问题水果描述可选如果关联的类别被删除此水果的设为如果关联的类别的更新此水果的自动更新水果信息表清空表数据并插入初始记录方便重复运行示例临时禁用外键检查方便清空重新启用外键检查温带水果如苹果梨等热带水果如香蕉芒果菠萝等浆果类如草莓蓝莓树莓等红富士苹果温带水果脆甜多汁的红富士苹果香芽蕉热带水果口感软糯的香芽蕉奶油草莓浆果类大颗香甜的奶油草莓建议项目结构用于示例为当前完整重写版本创建新目录数据库连接参数装饰器使用示例主程序使用装饰器的水果仓库类存放文件使成为一个包使用动态的核心模块使用示例主程序集成示例在后续提供打印工具模块数据库配置文件数据库连接配置模块此模块包含数据库连接的配置参数用于建立与数据库的连接数据库连接参数实例通用配置缓存分钟缓存有效期毫秒最大结果集字节数用于类核心基于提供的源码分析以下是对源码中类的核心构造函数主要方法及其参数的总结构造函数参数参数类型描述源码默认说明必需已建立的数据库连接对象通常通过获取必需文件所在的目录路径或包路径例如或库会在此路径下查找并加载所有后缀的文件可选缓存的内存限制字节如果为源码中对象以初始化可能表示不启用或使用不同逻辑默认源码中可选缓存条目的最大存活时间毫秒默认即秒可选方法返回的结果列表允许占用的最大总字节数用于防止默认即调用方法实例方法方法参数返回类型用途说明中语句的或全局唯一传递给的参数字典执行语句预期返回单条记录字典或会使用缓存中语句的或全局唯一传递给的参数字典执行语句返回多条记录字典列表或若无结果会使用缓存及限制中语句的或全局唯一传递给的参数字典执行语句返回受影响的行数会清空整个缓存中语句的或全局唯一传递给的参数字典执行语句返回受影响的行数会清空整个缓存中语句的或全局唯一参数字典可选用于的子句指定主键列名执行语句返回值是通常用于获取自增会清空整个缓存字典可能被中的修改装饰器方法装饰器方法装饰器参数装饰的函数签名示例用途及内部行为说明原始字符串将函数映射到给定的预期返回单条记录作为参数传递给占位符内部处理解析参数绑定缓存结果转换原始字符串将函数映射到给定的返回多条记录处理同上并应用主键列名通常返回将函数映射到主要用于的中通常返回清空缓存原始字符串返回受影响行数将函数映射到返回受影响行数清空缓存原始字符串返回受影响行数将函数映射到返回受影响行数清空缓存辅助函数内部在和装饰器内部使用用于分批从数据库游标获取数据将每批获取的行数据通常是元组转换为字典列表键为列名使用以生成器方式逐条返回字典这使得调用方如可以在迭代过程中检查限制缓存键用于在缓存中唯一标识一个查询它基于经过内部处理和参数绑定后的语句和实际绑定的参数列表生成确保相同但参数不同的查询会有不同的缓存条目方法一使用装饰器适用于语句相对固定且逻辑简单的场景文件封装操作装饰器使用示例模块此模块演示了如何使用的装饰器功能进行数据库操作水果数据仓库类封装对水果表的所有数据库操作初始化水果仓库映射文件目录缓存大小默认初始化数据库操作方法获取一个水果记录返回一个字典获取多个水果记录返回一个列表插入水果记录返回插入的删除水果记录返回删除的行数更新水果记录返回更新的行数将所有操作绑定到实例上关闭数据库连接主函数用于测试类的功能装饰器使用示例面向对象版创建仓库实例测试查询功能测试查询单个水果查询到水果价格未找到为的水果测试查询多个水果测试查询某分类下的所有水果分类下有个水果测试插入操作测试插入新水果蓝莓新鲜蓝莓富含抗氧化物质插入成功新水果测试更新操作测试更新水果使用刚插入的有机蓝莓有机认证蓝莓无农药更新了行记录验证更新结果更新后的水果价格测试删除操作测试删除水果删除了行记录操作失败关闭连接测试完成已关闭数据库连接方法二使用文件对于包含动态逻辑或较为复杂的语句文件提供了更强大的表达能力文件定义一个插入新水果记录的映射语句这是对应接口中方法的名称如表示使用数据库自动生成的主键例如的表示将生成的主键值赋给实体类中的属性表示数据库中自动生成的主键列名是代码使用操作水果数据的数据仓库类初始化水果仓库映射文件目录缓存大小默认插入水果数据使用删除水果数据使用将单个参数转换为字典格式以符合的参数要求更新水果数据使用更新水果数据成功影响行数更新水果数据失败影响行数根据查询水果详细信息使用根据条件查询水果列表使用查询参数字典可包含以下键分类最低价格最高价格水果名称支持模糊查询排序字段如排序方向如返回记录数量限制分页偏移量符合条件的水果列表直接将传递给不再额外包装测试查询水果列表测试查询水果列表苹水果名称价格实战将集成到应用中提供接口项目结构应用可复用或创建新的配置文件打印工具应用代码用于捕获错误类导入可选的高性能动态路径设置确保能导入同级和父级模块的父目录允许从导入插入到最前面优先查找集成示例完整版数据库和实例管理简化版生产环境需更健壮全局变量在多线程多进程环境中存在风险有更好的上下文管理机制如对象获取或初始化用于当前请求的实例警告此简单实现仍使用全局变量未完全适配请求生命周期在真实应用中推荐使用的对象或检查现有连接是否有效尝试如果断开则重连确保状态如果成功清除错误标记标记错误关闭无效连接清除旧实例如果实例不存在或连接出错丢失则创建新实例非常重要手动控制事务目录路径相对于此文件数据库操作装饰器请求装饰器统一处理实例获取事务和错误注入实例更具体的数据库驱动错误打印完整堆栈到服务器日志路由定义默认端点获取所有水果假设已定义确保空列表也是有效端点根据获取单个水果写操作成功后提交端点添加新水果假设这些是必需的可选尝试获取由设置的对于如果行为不符合预期可能在上但封装了这里简化处理端点更新指定的水果信息确保至少有一些数据用于更新对应中的对应中的清理掉值为的参数以便中的能正确工作至少要更新一个字段端点删除指定的水果应用关闭时的清理在应用上下文销毁时关闭数据库连接确保标记为已关闭启动开发服务器示例确保目录存在于文件的同级并且其中包含文件使用新端口避免冲突重点提示此函数尝试管理实例在生产级应用中强烈建议使用的对象结合和或来管理每个请求的数据库连接和实例以避免全局状态和并发问题此装饰器封装了获取实例执行视图函数事务提交回滚以及统一的错误处理逻辑这是一种简化视图函数代码的常用模式事务管理写操作通过在视图函数成功执行后提交事务读操作则不需要路径构造函数中的需要正确指向包含的目录示例中假设它在当前应用文件同级的目录下错误响应端点在发生错误时返回适当的状态码和错误信息第十七章音视频处理本章节我们将学习如何使用来调用强大的工具包以处理常见的音视频文件操作功能极其丰富虽然它本身是语言开发的但通过调用其命令行工具是实现自动化处理集成到后端或脚本中的常用且高效的方法我们的重点是学习如何处理音视频而不是从零实现编解码器我们将主要使用这个库来简化调用过程让代码更符合的风格介绍核心概念安装与交互方式目标深入理解是什么它的重要性以及核心组成掌握音视频处理中的基本术语容器流编解码器等在你的操作系统上成功安装命令行工具并配置好环境变量了解与交互的几种方式并安装好我们将主要使用的库音视频领域的瑞士军刀什么是不仅仅是一个简单的程序它是一个完整的跨平台的开源的音视频处理解决方案如果你需要对音频或视频文件进行几乎任何你能想到的操作包括但不限于录制转换格式转码编辑裁剪合并旋转提取信息添加滤镜特效水印调色降噪压缩以及进行网络流传输推流拉流都是这个领域内最强大最通用使用最广泛的工具集从大型视频网站的后台转码系统到你电脑上的视频播放器剪辑软件再到各种流媒体服务背后都极有可能有的身影的重要性功能全面支持海量的音视频格式容器和编解码器算法无论是常见的还是较新的甚至很多生僻格式大多都能处理跨平台无缝运行在等主流操作系统上开源免费遵循或等开源协议取决于编译选项可以自由使用修改和分发性能优异核心代码使用语言编写并针对性能进行了深度优化利用了多核和指令集等技术处理效率高命令行驱动提供了极其灵活和强大的命令行接口可以通过参数组合实现复杂的操作流程非常适合编写脚本进行自动化处理或在服务器后端调用的核心组成是一整个庞大的项目他其中含有大量的工具虽然我们最常用的是这个命令但了解其主要组成部分有助于理解它的工作方式命令行工具这是最核心最常用的工具它负责读取输入文件流根据用户指定的参数进行解码滤镜处理编码封装等一系列操作最终输出结果文件流我们后续的大部分操作都是通过构建不同的命令来实现的命令行工具这是一个多媒体流分析工具它可以读取音视频文件或流提取并显示其中非常详细的元数据和技术信息例如文件格式容器类型包含的数据流视频音频字幕等每个流的编解码器比特率时长帧率视频分辨率视频采样率音频声道数音频等文件的元数据标签标题作者专辑等在进行任何处理之前使用了解输入文件的属性往往是必要的第一步这对于编写健壮的处理脚本至关重要命令行工具一个基于库和一个跨平台多媒体库的简单媒体播放器它主要用于快速预览音视频文件测试的解码能力实时查看应用滤镜的效果它功能相对简单不如专门的播放器强大但在开发调试时非常方便核心库这些是以开头的语言库是所有功能的基石也是许多其他播放器编辑器转码软件甚至包括浏览器使用的底层库包含了海量的音频视频编解码器负责处理各种多媒体容器格式的解复用和复用提供了丰富的音频和视频滤镜用于实现各种特效和处理包含了一些基础的通用工具函数如数学运算数据结构日志等用于进行高效的图像缩放和色彩空间转换用于进行音频重采样格式转换和声道布局处理用于访问操作系统提供的多媒体设备如摄像头麦克风屏幕录制音视频基础概念理解以下术语对于使用至关重要术语英文比喻作用与解释常见示例容器格式文件盒子定义文件结构规定如何将音视频流元数据打包存储决定文件扩展名数据流文件内容容器内实际的连续的数据序列如视频数据音频数据字幕数据视频流音频流字幕流编解码器压缩解压算法用于压缩编码原始音视频数据以减小体积或解压缩解码数据以便播放或编辑相关处理过程编码将未压缩或已解码的音视频数据使用特定的编解码器压缩成目标格式的数据流这是有损或无损压缩的过程解码将已编码的音视频数据流使用对应的编解码器解压缩成原始的可播放或可处理的数据如图像帧序列音频样本转码先将输入文件解码然后对解码后的数据进行处理可选如加滤镜最后重新编码成目标格式参数这是一个解码编码的过程通常比较耗时和消耗资源封装转换重封装不经过解码和重新编码直接将一个容器中的音视频流原封不动地提取出来再放入另一个类型的容器中例如将文件中的视频和音频直接放入文件这个过程非常快几乎不损失质量但前提是目标容器必须支持源文件中的音视频编码格式复用封装将多个单独的编码后的流如一个视频流一个音频流合并到一个容器文件中解复用分离从一个容器文件中提取出单个的流如只提取音频流安装命令行工具重要前提库本身不包含的可执行程序你必须首先独立地在你的操作系统中安装并确保和命令可以在你的终端或命令行中直接运行安装与配置下载访问官网下载页面下载链接推荐从或下载预编译的版本建议选择版本下的构建如它包含了较全面的编解码器支持解压将下载的文件解压到一个固定且路径不含中文或特殊字符的位置例如或解压后你会看到等文件夹关键的可执行文件在目录中配置环境变量关键步骤在搜索栏搜索环境变量并打开编辑系统环境变量在弹出的系统属性窗口中点击高级选项卡下的环境变量按钮在下方的系统变量列表中找到名为的变量选中它点击编辑在编辑环境变量窗口中点击新建然后将你刚才解压后文件夹下目录的完整路径例如粘贴进去点击确定关闭所有打开的设置窗口验证必须重新打开一个新的或窗口旧窗口不会加载新的环境变量输入以下命令并回车如果能成功显示和的版本信息则安装和配置成功如果提示不是内部或外部命令请仔细检查你的环境变量设置是否正确路径是否包含目录以及是否重新打开了命令行窗口有时需要重启电脑才能使环境变量完全生效安装使用是最推荐的方式验证打开新的终端窗口输入安装通常需要先启用和仓库如果尚未启用根据你的具体发行版和版本启用仓库的命令可能略有不同例如例如验证输入交互方式的选择与安装在中与交互主要有两种方式模块基础方式这是内置的标准库可以用来启动和管理子进程执行任何命令行程序包括用于安全处理带空格或特殊字符的参数推荐将命令构造成列表避免注入风险将要执行打印命令方便查看如果返回非退出码表示错误则抛出捕获标准输出和标准错误将输出解码为文本命令成功执行的详细进度和信息通常输出到输出命令执行失败命令执行失败返回码错误输出错误找不到命令请确认已安装并添加到系统执行命令时发生未知错误优点无需额外库灵活可以直接执行任何命令缺点当命令参数复杂尤其是涉及滤镜或时包含大量引号逗号分号时手动构建命令列表非常繁琐且极易出错需要手动解析的输出以获取进度或判断具体错误库推荐这是一个非常流行的库它封装了调用命令行的过程你使用的函数和链式调用来定义输入输出滤镜等操作会自动为你生成对应的复杂的命令行参数并替你调用来执行需要注意的是下载需要下载的是这个库而不是单使用库将要使用库处理使用库的流式创建输入流设置输出选项使用相同的视频编解码器设置打印将要执行的命令等效的命令执行处理处理成功完成注意使用库时输出信息被库内部处理处理错误处理失败错误输出错误找不到库请使用安装注意这个库需要系统中已安装命令行工具处理视频时发生未知错误优点代码更更易读使用函数调用和链式操作构建流程比拼接字符串或列表清晰简化复杂命令特别是对于包含多个滤镜输入输出的复杂操作能大大简化命令构建过程减少引用转义错误库会自动处理参数的引用和转义问题缺点仍然依赖外部它只是一个包装器不是的重新实现所以一定要保证自己的环境变量存在可能无法覆盖所有参数对于非常规或最新的参数库可能没有直接对应的函数或关键字参数但通常提供传递原生参数的方式错误调试虽然它捕获了但有时理解错误原因仍需结合本身的知识命令行结构目标深入理解命令行的组成选项类型作用顺序和流指定符了解如何使用获取媒体文件的详细信息全面掌握库的核心语法包括如何定义输入输出滤镜以及如何执行处理和获取信息建立命令行参数与函数参数之间的对应关系命令行结构详解要精确控制理解其命令行结构至关重要其基本模式为全局选项输入选项输入文件输出选项输出文件选项的作用域与顺序理解选项的作用域和顺序是正确使用的关键选项通常会影响紧随其后的文件或操作全局选项这些选项位于命令之后第一个输入文件之前它们控制整个进程的行为自动覆盖同名输出文件无需确认如果输出文件已存在则不执行防止覆盖通常默认开启显示处理进度统计信息或设置日志记录的详细程度常用的包括静默几乎不输出只输出严重错误输出警告和错误输出标准信息默认输出更详细的调试信息隐藏启动时打印的版本号库信息和编译配置等横幅示例覆盖输出文件并隐藏版本信息自动覆盖不显示版本等信息示例只显示警告及以上级别的日志只输出警告和错误信息输入选项这些选项放在特定的之前并且只对紧随其后的那个输入文件生效格式强制以指定的容器格式来解析输入文件通常能自动检测但在处理原始数据流或特殊格式时需要帧率强制指定输入视频的帧率例如用于帧率信息丢失的原始视频流或图像序列宽高强制指定输入视频的分辨率例如主要用于原始视频流时间放在之前表示输入定位会尝试快速跳转到接近指定时间点可以使用秒或格式的关键帧开始处理优点是速度快缺点是定位可能不完全精确到帧次数设置输入流循环次数表示无限循环常用于将单张图片或短做成循环背景视频表示不循环默认要求以源文件固有的帧率读取输入如果不加此参数会尽可能快地读取文件该选项主要用于模拟直播推流或处理实时输入设备以匹配源的自然速率示例提取视频的前五秒转换为图片序列指定你的输入视频文件告诉只处理输入视频的前秒使用视频滤镜设置输出图片的帧率为帧秒这样秒的视频会生成张图片这个帧率与你后面要测试的命令中的相匹配指定输出图片的位置和命名规则图片的命名规则示例将图片序列合成为视频指定输入帧率和开始时间点对应的图片假设图片序列是从时间点秒对应的帧开始即大约第帧明确输入是图像序列输入文件模式代码实现与最佳实践如下使用函数封装命令定义形参以便后续调整值使用列表构造命令防止注入攻击当你用运行一个外部命令比如时如果不特别指定和参数那么这个外部命令子进程的标准输出和标准错误会直接连接到你的脚本父进程的标准输出和标准错误简单来说就是打印的任何信息无论是正常信息还是错误信息都会直接显示在你的脚本运行的那个终端窗口里当你给传递这个参数时你是在告诉请不要让子进程的标准输出直接打印到终端而是创建一个管道把子进程的标准输出重定向到这个管道里这样一来我这个父进程脚本后续就可以从这个管道里读取子进程的输出了在及更高版本中提供了一个更方便的参数设置等同于同时设置和这也是我们第一个示例使用的值确保输出目录存在创建输出目录构建命令执行命令视频帧提取成功执行命令失败错误输出发生错误将图片序列转换回视频文件输入图片序列的模式例如输出视频文件路径帧率默认为开始时间秒默认为操作是否成功确保输出目录存在创建输出目录构建命令执行命令从图片序列创建视频成功执行命令失败错误输出发生错误示例使用从视频提取帧输入视频文件路径输出图片路径模式从帧创建视频输入图片序列输出视频文件输出选项这些选项位于某个输出文件名之前并且只对紧随其后的那个输出文件生效这是控制输出文件特性最关键最丰富的一类选项视频编码器选择或选择合适的视频编码器是平衡画质文件大小编码速度和兼容性的关键编码器值常用库名类型压缩效率编码速度兼容性主要用途备注有损良好快中等极好最通用移动端流媒体广泛支持质量和效率良好有损优异中等慢好压缩率比高约但编码更耗时部分旧设备不支持有损优异中等慢好开发开源免费容器常用使用效率类似有损顶尖极慢增长中最新一代开放标准压缩率最高但编码非常非常慢解码要求也高有损一般快较好较旧的标准兼容性尚可效率不如无损复制极快取决于容器特殊值不重新编码直接复制原始视频流仅用于改变容器或截取其他特定编码器如编辑用硬编等选择建议追求兼容性通用性首选追求最高压缩率不计时间选其次或仅改变容器或截取优先尝试以获得最快速度和无损质量硬件加速如果你的硬件支持且编译时包含支持如的可以尝试使用通常能大幅提高编码速度但质量控制方式和效果可能与软编码略有不同音频编码器选择或编码器值常用库名类型压缩效率兼容性主要用途备注有损良好极好最通用流媒体常用是平台标准质量良好有损优异好开放免费特别适合语音和网络传输低延迟低码率下表现好标准有损一般极好历史悠久兼容性最好但同等码率下效率不如有损良好好开放免费常用于容器无损较高较好无损压缩保留原始音频质量文件较大适合存档或对音质要求极高无损复制取决于容器特殊值直接复制原始音频流其他如未压缩无损等选择建议通用兼容性好首选网络传输语音低码率高质量首选需要无损压缩选仅改变容器或截取尝试字幕编码器选择或字幕相对简单常用选项输出为格式通常作为单独文件或封装在中输出为兼容的内嵌文本字幕直接复制原始字幕流如果目标容器支持质量与比特率控制这是影响输出文件大小和视觉听觉感受的关键主要有两种策略比特率就是每秒钟用多少数据来记录或传输声音和图像这个数值直接决定了音视频的清晰程度和文件的大小控制方式对应参数常用描述优点缺点恒定质量值视频推荐用于视频让编码器根据画面复杂度动态调整比特率以维持感知质量恒定值越低质量越好文件越大对常用高低类似但相同值压缩率更高文件大小更可控质量相对稳定最终比特率和文件大小不固定平均比特率值视频值音频推荐用于音频也可用于视频指定输出文件的目标平均比特率如编码器会尽量使最终平均速率接近此值文件大小更容易预测和控制简单画面可能浪费码率复杂画面可能码率不足导致质量下降最大最小比特率值值值通常与配合限制比特率波动范围用于流媒体兼容性定义解码器缓冲区大小兼容性好码率波动可控配置复杂可能影响质量选择建议视频优先使用控制质量选择一个你能接受的质量和文件大小平衡点如只有在对输出文件大小有严格限制时才使用音频通常使用指定目标比特率如编码速度编码器通常提供预设参数集用于在编码速度和压缩效率同等质量下文件大小之间做权衡值速度压缩效率质量消耗最快最低最低很快较低较低较快较低较低稍快一般一般快较好较高默认值好中等慢更好高较慢优异较高最慢最佳最高极慢几乎无提升极高选择建议从或开始尝试如果追求极致压缩率且不介意时间可选或如果速度是首要考虑可选或但文件会大很多时间控制选项位置作用精度速度时间输入前输入定位从输入源的指定时间点开始读取不精确快时间输出前输出定位解码到指定时间点才开始输出精确慢时长输出前限制输出的总时长时间输出前指定输出的结束时间点相对于输入开始时间选择建议快速截取大致片段放在前精确截取片段放在输出文件前会解码前面所有内容或者先用输入前定位到大概位置再用或输出前精确控制结束点只截取开头部分只用或场景快速截取大致片段目标快速从视频大约分钟秒处开始截取秒长度的片段优先考虑速度不强求帧级别的精确方法将放在输入文件之前输入定位并使用指定输出时长可以尝试使用以获得最快速度输入定位快速跳转到中接近第秒的位置通常是前面的关键帧输入文件输出选项从定位到的点开始截取秒的时长输出选项直接复制音视频流不重新编码速度最快如果格式兼容场景精确截取片段目标精确地从视频的第分秒开始截取到第分秒结束总时长秒将放在输出文件之前并配合或会解码之前的所有内容通常不能使用输入文件输出定位精确地从解码后的第分秒开始编码输出输出定位精确地在解码后的第分秒结束编码输出注意是绝对时间点需要重新编码视频和音频以保证精确切割注意这种方式非常精确但因为需要解码前面的内容所以速度很慢尤其当的时间点靠后时若我们一个视频很长的情况下而我们需要截取的片段而又在非常的末尾这时候选择这种精确片段的语法就不好了所以我们换一种思路先用输入前快速定位到大概位置再用精确控制截取时长输入定位快速跳转到接近分钟的位置输入文件输出选项从实际定位到的点开始精确地截取秒的时长这种方式下起始点可能略早于分钟但输出时长是准确的秒速度比纯输出定位快得多场景只截取开头部分目标只保留视频的前秒使用指定时长从开头截取秒时长使用指定结束时间点从开头截取到第秒结束注意和在只截取开头时效果类似都比较快且通常可以使用复杂滤镜在我们接下来需要介绍的滤镜篇十分重要他是实现复杂的滤镜效果的核心关键点为什么需要我们用的视频滤镜和音频滤镜适用于简单的线性的处理流程一个输入流经过一个或多个滤镜用逗号分隔一个输出流但如果你需要做更复杂的操作比如处理多个输入流例如把一个图片叠加到视频上视频是输入是输入一个滤镜产生多个输出例如滤镜可以把一个视频流复制成两份分别进行不同处理合并多个流例如把两个视频左右拼接或者把处理过的视频流和处理过的音频流合并输出这些情况就需要用到来定义一个滤镜图的基本语法结构可以把它想象成用文字描述一个数据流管道系统输入流标签输入流标签滤镜参数输出流标签输入流标签滤镜参数输出流标签标签标签滤镜最终输出标签对应如下命令行核心组成部分解释方括号流标签这就像是给在滤镜图内部流动的临时数据流视频流音频流起名字引用输入文件流通常用文件索引流标识符的形式例如指的是第一个输入文件后面第一个的视频流通常是第一个视频流指的是第一个输入文件的第一个音频流指的是第二个输入文件的视频流自定义标签你可以给一个滤镜处理后的输出流起一个自定义的名字比如这个名字可以被后续的滤镜或最后的指令引用的配合因为处理后的输出流是带有自定义标签的比如上面例子中的不会自动将它映射到最终的输出文件你需要使用选项来明确告诉使用哪个标签的流作为输出文件的视频流哪个作为音频流等将标签为的流映射为输出文件的第一个视频流通常是这样将标签为的流映射为输出文件的第一个音频流你仍然可以用这样的方式来映射未经滤镜图处理的原始输入流比如直接复制原始音频简单示例叠加回顾我们再看一下这个例子体会一下标签和分号的作用内和是输入标签分别代表的视频流和的视频流是作用于这两个输入流的滤镜是滤镜处理完成后的输出标签这里只有一个滤镜链所以没有用到分号将带有标签的视频流叠加结果指定为输出视频将原始视频的音频如果存在也指定到输出常用滤镜的滤镜系统是其最强大的功能之一它允许你对音视频流进行各种精密的修改和处理你可以将滤镜想象成一个个处理单元音视频数据流过这些单元时会被修改像这些图形界面工具非常强大对于单张图片或单个视频的精细创意性编辑它们通常更直观效率更高因为你可以实时看到效果并进行微调但假设思考这么一些场景你就能够理解的强大之处网站后台自动处理用户上传的图片统一尺寸加水印视频网站自动生成不同清晰度的版本等用户上传视频到你的网站后端服务器自动调用进行转码截图添加片头片尾等一个监控系统当检测到特定事件时自动调用截取相关录像片段并进行压缩或格式转换作用修改或分析音视频流的内容常见的操作包括调整尺寸裁剪旋转翻转叠加图像文字调色降噪改变速度调整音量混音等等分类视频滤镜处理视频帧数据音频滤镜处理音频采样数据数量庞大内置了数百种滤镜覆盖了绝大部分常见的处理需求你可以通过命令查看所有支持的滤镜在进行滤镜处理之前我们给出三张好看的原图作为参考模糊参数用于实现均匀模糊效果命令行示例注示例命令中的通常在下表示当前目录的可执行文件下或配置好后直接用即可以下示例统一使用说明值越大越模糊以下是值分别为的效果变色提供了多种变色方法通过调整三个颜色通道在不同亮度区域阴影中间调高光的权重来实现色彩平衡调整参数说明选项有三组分别对应阴影中间调高光调整阴影部分的红绿蓝调整中间调的红绿蓝调整高光的红绿蓝每个选项的值范围为正数表示增强该颜色在该区域的影响力偏向该色负数表示减弱远离该色命令行示例增强阴影中的红色增强中间调的红色增强高光中的红色稍微增加阴影和中间调的红色和绿色略微减少蓝色使整体偏暖轻微增加阴影中的红绿色稍多增加中间调的红绿色轻微减少中间调的蓝色效果图通过一个或矩阵对四个通道进行线性组合重新计算每个输出通道的值可以实现灰度各种色调如棕褐色等复杂效果参数说明需要提供个用于输出或个用于输出用冒号分隔的权重值顺序为计算公式为以红色输出为例同理权重值通常在范围内命令行示例灰度效果一种近似计算棕褐色调效果图与调整图像的色相和饱和度参数说明角度色相角度单位度在色轮上旋转颜色范围循环默认数值饱和度范围默认大于增强饱和度小于降低为灰度负数为补色效果弧度同但单位是弧度数值亮度范围默认有关色相饱和度亮度请详见色彩三要素命令行示例改变色相到度饱和度不变降低饱和度接近黑白但略带反色这两个滤镜应用查找表的概念来进行颜色转换但它们的主要工作方式是基于你提供的数学表达式来计算每个颜色分量的输出值在颜色空间操作亮度色度在颜色空间操作红绿蓝亮度有多亮蓝色色度差颜色有多偏蓝黄红色色度差颜色有多偏红青视频压缩和传输常常使用或类似的而不是我们屏幕显示常用的红绿蓝主要是符合人眼特性与压缩效率高两个优点它们的核心是通过表达式根据输入像素各分量的当前值来计算输出像素各分量的新值参数说明你需要为想要修改的颜色分量指定一个计算表达式例如对于你可以指定表达式表达式表达式表达式中可用的常用变量包括变量名含义示例用法当前正在处理的颜色分量的输入值亮度翻倍输入值的反转值等于亮度反转同但其值会被自动限制在对应分量的有效范围内当前颜色分量允许的最小值例如中的或中的当前颜色分量允许的最大值例如中的或中的图像视频的宽度和高度像素归一化坐标当前正在处理的像素的坐标从开始当前帧的时间戳秒表达式支持常见的数学运算符和函数等命令行示例底片效果反转三个分量使用变量更简洁黑白效果移除色度信息将设为中间值亮度分量保持不变是默认值提升亮度值翻倍注意可能过曝导致细节丢失计算结果会自动到有效范围调整色度示例增加分量略微增加分量效果图重要说明基于表达式的加载预设文件常识来说被描述为一种可以保存和加载的滤镜效果文件通常是等格式这种用法在视频编辑和调色领域非常普遍这两种关于的描述都是正确的但指向的是不同的概念和功能预设文件等存储了一个预先计算好的庞大的颜色映射表定义了各种输入颜色如何精确地转换为输出颜色常用于应用复杂的色彩风格如电影感复古色调或进行色彩空间转换如转在中加载和应用这类文件主要使用滤镜对于如或滤镜对于的滤镜基于表达式如上所述这些滤镜允许你使用数学表达式来实时定义颜色转换规则它们非常灵活适合进行程序化的基于像素值或坐标的颜色调整例如上面示例中的反相去色亮度调整但它们不直接加载等外部预设文件如何使用加载常见的文件你需要使用滤镜示例将这个文件应用到视频上你的文件路径这里的参数就是你的或其他支持的格式文件的路径附个文件模板下载裁剪从视频或图像中裁剪出指定尺寸和位置的矩形区域基于图片大小参数说明或输出宽度和高度可用输入宽高裁剪区域左上角坐标默认居中命令行示例从裁剪从中心裁剪省略去在指定矩形区域内应用像素插值或模糊尝试去除静态效果有限如下图此图片携带站的水印参数说明区域设为时显示处理区域的绿色边框用于调试对于调试来说建议使用在线图片坐标拾取工具在线工具左上角右下角我们可以计算出滤镜需要的宽度和高度宽度右下角左上角高度右下角左上角命令行示例效果图如下请注意的实际效果取决于水印周围的背景复杂度它主要是基于边缘像素进行插值填充可能不会完美去除或产生理想的模糊效果有时看起来会有些涂抹感加边框在图像或视频上绘制矩形边框参数说明边框位置和尺寸默认整个画面或边框颜色可以是颜色名或十六进制可以用透明度指定透明度如默认黑色或边框线宽像素表示填充整个矩形默认命令行示例绘制默认黑色实心边框充满边界在绘制的半透明红色边框线宽默认在绘制的半透明粉色边框线宽效果图画网格在视频上绘制网格线参数说明或网格单元的宽度可用输入宽或网格单元的高度可用输入高或网格线的厚度或网格线颜色和透明度命令行示例绘制九宫格单元宽高为输入宽高除以白色半透明线宽绘制单元格为的红色半透明网格线宽效果图添加字幕或对于视频在线转字幕推荐离线语音转文字魔改版自带种语言安装包滤镜用于烧录硬编码或等格式的字幕文件到视频帧上烧录字幕使用默认样式烧录字幕并强制使用文件内定义的样式滤镜用于在视频上绘制动态或静态文本可以设置字体大小颜色位置滚动等非常灵活但配置复杂在左上角显示时间码画边缘作用此滤用于检测并绘制图像或视频中的边缘即像素亮度颜色发生剧烈变化的地方它通常基于边缘检测算法参数说明算法的低阈值和高阈值范围且这两个阈值共同决定了哪些变化被识别为边缘阈值越高检测到的边缘越少只有非常明显的边缘才会被保留阈值越低检测到的边缘越多可能会包含一些噪音或不重要的细节需要根据具体图像和需求调整控制输出的模式常用的有默认输出一个黑色背景白色线条表示边缘的图像这就是你看到的线稿效果将检测到的边缘通常为白色与原始图像的颜色进行混合产生一种带有彩色边缘描边的效果输出算法中间过程产生的灰度边缘强度图的实际用途你可能会问只是得到一个线稿有什么用实际上边缘检测是许多更复杂任务的基础或辅助步骤计算机视觉预处理在进行目标识别特征提取图像分割等高级计算机视觉任务前边缘检测可以提取图像的关键结构信息减少需要处理的数据量并突出对象的轮廓艺术风格化效果可以故意使用模式来创造素描卡通技术绘图等艺术风格结合其他滤镜如与原图叠加调整颜色等可以产生更多样的视觉效果命令行示例不同模式示例模式默认线稿效果使用不同的阈值组合观察边缘检测的敏感度变化较低阈值检测更多边缘细节较高阈值只保留较强边缘效果图示例模式彩色边缘描边将边缘信息白色与原图颜色混合这个命令会生成一个保留了原图大概颜色但在边缘处有明显白色或受原色影响的亮色描边的图像视觉效果与完全不同效果调整视频的亮度对比度饱和度和参数说明亮度范围默认对比度范围默认饱和度范围默认值整体亮度调整范围默认分别调整红绿蓝通道的应用的权重命令行示例增加亮度增加降低亮度降低增加对比度设置为降低对比度设置为增加饱和度设置为颜色更鲜艳降低饱和度设置为颜色变淡增加设置为中间调变亮降低红色通道减少红色在高光和中间调的影响画面偏青蓝增加蓝色通道增加蓝色在高光和中间调的影响画面偏蓝冷效果图增加亮度降低亮度增加对比度降低对比度增加饱和度降低饱和度增加降低红色通道增加蓝色通道缩放调整视频或图像的分辨率尺寸参数说明目标宽度和高度可以使用输入宽高进行计算或表示按比例自动计算保证结果为偶数缩放算法如等影响速度和质量命令行示例缩放到固定可能变形缩放到宽度高度按比例自动计算效果图等比放大使用算法进行高质量的整数倍放大参数说明放大倍数必须是或命令行示例放大倍横向倒置水平翻转图像或视频镜像效果参数说明无命令行示例效果图纵向倒置垂直翻转图像或视频参数说明无命令行示例效果图加噪音为视频添加不同类型的噪音其中分别指的是亮度蓝色度差红色度差透明度分量的噪音强度一般会使用或指全部色彩参数说明或指定分量和或噪音强度范围默认或噪音标志类型可以是随时间变化的噪音空间上均匀但不随时间变化的噪音随时间重复的图案噪音时间上平滑平均的图案噪音可以组合如命令行示例添加强度为的临时统一噪音添加强度为的平滑平均噪音添加强度为的随机图案噪音效果图加水印作用滤镜是中非常常用的一个功能它的作用是将一个视频流或图片流图片会被当作单帧视频叠加到另一个视频流的上方就像给视频添加图层一样这常用于添加水印画中画等效果核心概念至少需要两个输入一个是主视频流背景另一个是要叠加的视频图片流前景水印复杂滤镜因为涉及多个输入流通常在中使用坐标定位你可以精确控制叠加层水印在背景视频上的位置时间控制可以控制叠加层何时出现何时消失主要参数参数名命令行描述常用值表达式示例表达式叠加层左上角的水平坐标左边距右边距水平居中表达式叠加层左上角的垂直坐标上边距下边距垂直居中当较短的那个输入流结束时如何处理默认对静态图片水印常用会保持最后一帧结束整个处理移除叠加层保留主视频流布尔值或注意这个通常作为输出选项使用命令行指定内部处理时使用的像素格式影响是否支持透明度等表达式中可用的变量主视频流背景的宽度主视频流背景的高度叠加层水印的宽度叠加层水印的高度当前时间戳秒命令行示例示例添加静态图片水印带透明度到右下角假设是主视频是带透明背景的水印图片对于来说无法使用换行符执行指令所以只能混在一行在这里我们还限制了一下图片的大小避免图片太大指定两个输入文件代表第一个输入视频的视频流代表第二个输入的视频流图片被当作单帧视频应用滤镜设置坐标为主视频宽度宽度像素右边距设置坐标为主视频高度高度像素下边距将处理后的视频流标记为将标记为的视频流映射到输出将第一个输入文件中的音频流如果存在映射到输出对视频进行重新编码烧录水印需要重编码使用较快的预设直接复制原始音频流输出文件名示例添加动态水印循环播放到左上角假设是主视频是动态水印注意作为输入时需要特殊的输入选项来控制循环对于来说无法使用换行符执行指令所以只能混在一行输入选项针对告诉不要忽略文件内部定义的循环次数如果本身只循环几次这个选项会让它按原样播放如果本身是无限循环的此选项影响不大输入选项针对告诉在播放完一次后无限循环地重新读取输入流这确保了即使本身时长很短它也会在整个视频时长内持续显示如果想让只播放一次然后消失可以将设为并且不使用或者结合输出选项将放在左上角边距当流结束时如果不是保持其最后一帧由于我们用了这个参数在这里影响不大其他参数同上这个选项告诉当所有输入流中最短的那个流结束时就结束整个输出文件在你的例子中是有限时长的比如分多钟而无限循环的被视为无限时长所以会让输出在播放完毕时自动停止示例三添加固定尺寸且位置随机飘动的动态水印加底板画布扩展扩展视频或图像的画布尺寸并可以用指定颜色填充新增区域常用于需要固定输出尺寸或添加边框背景的场景参数说明输出画布的总宽度和总高度必须大于等于输入尺寸输入图像在输出画布上的左上角坐标默认居中填充扩展区域的颜色默认黑色命令行示例将放到一个的紫色底板上原图放在的位置效果图旋转按指定角度旋转视频围绕中心点参数说明或旋转角度注意单位是弧度可以使用常量和数学表达式顺时针为负逆时针为正例如度度要使用角度需转换可选输出的宽度和高度默认与输入相同旋转后图像可能会超出原边界可以用来设置足够大的画布是否使用双线性插值或默认使用命令行示例逆时针旋转弧度度顺时针旋转度效果图光晕晕影在图像或视频边缘添加暗角或亮角效果参数说明或控制光晕形状的角度表达式单位弧度常用圆形或光晕中心的相对坐标到默认中心模式评估模式命令行示例添加一个圆形暗角效果图淡入淡出作用为视频或音频添加淡入或淡出效果这在视频开头结尾或者场景切换时非常常用主要参数或指定淡入淡出类型淡入效果淡出效果或效果开始的时间点单位秒对于淡入通常是对于淡出需要计算好视频总时长淡出时长或效果持续的时长单位秒或仅指定淡入淡出的目标颜色默认是黑色例如可以实现淡入自白色或淡出至白色值为时只对透明通道应用淡入淡出可用于实现透明度的渐变默认命令行示例示例视频前秒从黑色淡入最后秒淡出到黑色假设视频总长秒应用视频滤镜链第一个滤镜类型为淡入从第秒开始持续秒滤镜链分隔符第二个滤镜类型为淡出从第秒开始持续秒音频直接复制示例音频在最后秒淡出假设音频总长秒应用音频滤镜音频淡出从秒开始持续秒旋转度作用对视频进行精确的度倍数旋转或翻转相比于滤镜它允许任意角度旋转但可能涉及复杂的插值和画布调整对于标准的度旋转更简单更常用且通常效率更高主要参数方向值逆时针旋转度并垂直翻转或顺时针旋转度常用或逆时针旋转度常用或顺时针旋转度并垂直翻转还有等命令行示例将视频顺时针旋转度例如竖屏拍的视频转成横屏应用滤镜参数表示顺时针旋转度将视频逆时针旋转度参数表示逆时针旋转度改变播放速度作用改变视频或音频的播放速度实现快放或慢放效果表达式视频通过修改视频帧的显示时间戳来改变速度倍数音频调整音频的播放速度同时尽量保持音高不变这是它与简单地改变采样率或的主要区别主要参数表达式表达式将播放速度提高倍例如是倍速将播放速度减慢倍例如是倍速让时间戳从开始有时用于修复时间码问题倍数是原速是倍速是倍速慢放注意滤镜接受的倍数范围有限制通常在到之间对于超出范围的速度调整可以链式调用多个滤镜例如实现倍速重要改变视频速度时通常需要同时改变音频速度以保持音画同步因此和常常在中配合使用命令行示例示例将视频和音频都加速到倍速定义复杂滤镜图将输入视频流的除以加速标记输出为将输入音频流的速度提高倍标记输出为将处理后的音视频流映射到输出示例将视频和音频都减慢到倍速将乘以约实现倍慢放音频速度变为倍绘制文本详解作用在视频帧上绘制静态或动态文本功能非常强大可以控制字体大小颜色位置背景框滚动时间显示等主要参数非常多仅列举常用字体文件路径必需除非系统配置了默认字体且能找到指定或字体文件的路径路径中若有特殊字符或空格需要恰当引用或转义文本内容要绘制的文本字符串可以包含变量如时间码帧号元数据和表达式例如或显示格式时间码特殊字符需要转义表达式文本左上角的水平坐标可以使用视频宽高文本宽高行高等变量例如水平居中表达式文本左上角的垂直坐标例如下边距大小字体大小像素颜色字体颜色颜色名如或十六进制或表达式或是否绘制背景框表示绘制默认不绘制颜色透明度背景框颜色和可选透明度如宽度背景框边框的宽度文字阴影的偏移阴影颜色表达式条件渲染只有当表达式求值为非零时才绘制文本例如表示只在视频时间到秒之间显示文本命令行示例来自你的笔记示例左右滚动的字幕需要根据你的字体路径修改这个表达式实现了从右向左滚动的效果控制速度关注广州小程提升专业技能注表达式中的表示在时不绘制移出画面示例固定位置的两行字幕需要根据你的字体路径修改关注广州小程提升专业技能注用逗号分隔两个滤镜实例来实现多行多样式文本视频堆叠作用将多个视频输入水平垂直或按自定义网格布局拼接在一起形成一个更大的视频画面这在制作对比视频画中画另一种方式或多画面监控展示时非常有用这需要使用主要参数指定要堆叠的视频输入流的数量必需设为时输出时长以最短的那个输入流为准默认更复杂用于网格布局输入流数量布局字符串定义网格布局例如表示网格同上颜色当布局尺寸大于输入流总尺寸时用指定颜色填充空白区域注意默认情况下要求所有输入视频具有相同的高度对于或相同的宽度对于如果尺寸不同你需要先用滤镜统一尺寸则会自动将所有输入缩放到网格单元允许的最大尺寸命令行示例示例水平并排拼接两个视频左右排列假设和分辨率相同选择两个输入的视频流应用水平堆叠滤镜指明有两个输入标记输出视频流映射处理后的视频和第一个输入的音频示例垂直上下拼接两个视频需要先统一宽度先用将两个视频宽度统一为高度自适应偶数再用将缩放后的流垂直堆叠示例将四个视频排列成网格指定个输入定义布局第一个视频放在左上角第二个视频放在第一个视频右边第一个视频宽度第三个视频放在第一个视频下方第一个视频高度第四个视频放在右下角锐化作用提高图像或视频的清晰度突出细节有多种锐化滤镜反锐化掩模是其中常用的一种效果比较自然则可以在模糊的同时保留边缘也可用于轻微锐化主要参数或亮度矩阵的水平大小奇数默认或矩阵的垂直大小奇数默认或锐化模糊的强度正值锐化负值模糊范围默认轻微锐化值越大锐化越强对应色度通道的参数用法同通常调整即可命令行示例示例应用中等强度的锐化使用矩阵亮度强度使用的分析矩阵设置亮度锐化强度为比默认稍弱示例应用更强的锐化使用矩阵亮度强度使用更大的分析矩阵可能影响更多细节设置更高的锐化强度注意过度锐化会导致图像出现噪点光晕和不自然的边缘需要适度调整参数流标识符详解为了精确地对多媒体文件中的特定流进行操作需要使用流标识符标识符含义示例用法对应概念文件中所有的视频流禁用视频通常指第一个文件中所有的音频流禁用音频通常指第一个文件中所有的字幕流禁用字幕通常指第一个数字文件中绝对索引为的流从开始映射文件的流文件中第个视频流索引从开始设置第个视频流编码或文件中第个音频流索引从开始设置第个音频流码率文件中第个字幕流索引从开始映射文件的第个字幕较新版本根据流的唯一选择需手动过滤较新版本根据节目选择用于流等或需手动过滤根据流的元数据选择需手动过滤在中我们主要通过字典访问方式如来选择流想象一下一个多媒体文件比如一个或文件就像一个大包裹这个包裹里可能装了很多东西这些东西就是流可能有一段视频画面可能不止一段音频比如一条是电影原声普通话一条是粤语配音还有一条是导演评论音轨可能还有几条字幕一条是中文字幕一条是英文字幕的默认行为没有流标识符时如果你只给一个简单的命令比如它会尝试自己做决定从里选一些流放到里它通常会选一个它认为最好的视频流比如分辨率最高的那个选一个它认为最好的音频流比如声道数最多的那个可能还会选一个字幕流比如第一个问题来了如果里有国语和粤语两条音轨但默认选了粤语而你其实想要国语的怎么办如果你想把国语和粤语两条音轨都保留在输出文件里怎么办如果你只想提取视频完全不要任何音频和字幕怎么办如果你有两个输入文件想用第一个文件的视频配上第二个文件的音频怎么办流标识符的作用精确的指名道姓这时候流标识符就派上用场了它就像给包裹里的每一样东西每个流都编上号或者打上标签让你能够精确地告诉你要对哪个具体的东西进行操作它最常用的地方是配合输出选项的作用这个选项用来手动指定哪些流应该被包含在输出文件中一旦你使用了就不再使用默认规则去猜了只有你明确指定的流才会被输出配合流标识符告诉选择第一个输入文件的第一个视频流告诉选择第一个输入文件的第二个音频流假设这是粤语音轨直接复制选中的流结果就只包含指定的那个视频流和粤语音轨选择第一个输入的所有视频流选择第一个输入的所有音频流结果会包含原文件所有的视频和音频流选择第一个输入的视频流选择第二个输入的音频流结果就是用第一个视频配上第二个音频先选择第一个输入的所有流然后取消选择第一个输入的所有字幕流号表示取消结果包含原视频和音频但不含字幕流标识符的其他用途除了配合流标识符还可以用来给特定的流指定选项对第一个音频流使用编码比特率为对第二个音频流使用编码为第一个音频流设置语言元数据为英语在中像这样的标签实际上也是基于流标识符来引用特定的输入流中的对应使用库时选择流的方式更或通常选择第一个视频流选择第二个音频流选择第一个流不区分类型库在底层会将这些选择转换成合适的命令行参数或滤镜图标签自身能力查询命令为何要查询的能力在你编写任何调用的脚本或程序之前了解你所使用的版本究竟能做什么至关重要功能极其强大但并非所有安装版本都包含全部功能例如某些编解码器特别是需要额外授权或有专利问题的可能在默认编译中未被包含或者你可能需要确认是否支持特定的网络协议或滤镜因此执行信息查询命令的主要作用和价值在于避免运行时错误提前确认支持你将要使用的编码器格式滤镜或协议可以避免在脚本执行到一半时才发现功能缺失而导致失败例如你想编码为但查询后发现它不在列表中你就需要换用内置的编码器确保兼容性与选择最佳方案查看支持列表可以帮助你选择最适合你需求的且当前环境支持的最佳工具比如检查是否有硬件加速编码器如可用或者对比几种可选的音频编码器辅助调试特别是当你自行编译或遇到奇怪问题时检查编译时链接的库和启用的功能可以通过或查询相关组件可以帮助诊断问题根源发现新功能浏览支持列表也是学习强大功能寻找特定处理方案的途径常用查询命令详解查看编解码器命令会列出所有当前版本编译支持的编码器编码器用于将原始音视频数据压缩输出会标明编码器名称如类型视频音频字幕和简短描述类似地列出所有支持的解码器用于解压缩了解这些列表可以让你确定输出兼容性你能否使用或来编码你的输出文件输入兼容性当你拿到一个不常见的视频文件时是否内置了对应的解码器来读取它硬件加速列表中是否包含如等硬件加速编解码器查看协议命令显示支持的输入和输出协议这决定了能从哪些来源读取数据以及能将数据发送到哪些目的地常见的协议包括本地文件以及流媒体常用的管道等在你需要处理网络流如拉取流进行处理或将处理结果推送到服务器或与其他进程通过管道交互时确认协议支持是前提查看格式命令列出支持的所有容器格式容器格式定义了音视频流如何打包存储输出中列表示支持解复用读取这种格式的文件列表示支持复用写入这种格式的文件常见的格式如用于图像序列等在你需要进行格式转换或者使用参数强制指定格式时需要确保目标格式是被支持的有标记查看和学习滤镜滤镜名命令会打印出当前版本支持的所有滤镜的列表这个列表通常非常长它对于快速浏览有哪些可用的处理功能很有帮助但更实用的是滤镜名命令例如你想了解如何精确地缩放视频可以运行这个命令会输出滤镜的详细文档包括它接受的所有参数如等每个参数的含义可接受的值范围默认值甚至可能有使用示例在你使用任何不熟悉的滤镜之前通过来查阅其用法是避免参数错误的关键步骤获取完整帮助命令会输出所有可用的命令行选项的极其详尽的帮助信息内容非常多适合在需要查找非常规或底层参数时作为最终参考获取文件信息详解深度解读为何要探测文件信息是套件中的媒体文件侦探在你对音视频文件进行任何修改或处理之前使用深入了解它的底细至关重要其作用和价值体现在制定处理策略获取文件的精确属性如分辨率帧率时长编码格式比特率音频声道数采样率像素格式等是决定后续操作的基础例如只有当视频分辨率大于时才执行缩小操作只有当音频编码不是时才进行音频转码根据获取的视频时长来计算截取片段的起止时间或判断是否需要处理根据帧率来设置输出帧率或进行帧率转换检查像素格式以确保后续滤镜或编码器兼容检测是否有音频流来决定是否需要处理或复制音频读取旋转元数据以便在必要时进行反向旋转校正动态参数计算在脚本中你可以用获取的值来动态计算命令的参数例如使用探测到的宽度和高度来计算缩放或裁剪的目标尺寸或者使用探测到的时长来设置滤镜效果的时间参数错误预检查与调试可以用来检查输入文件是否有效是否损坏是否包含预期的流类型如果一个文件处理失败的输出可以帮助判断问题是出在文件本身还是处理命令上内容分析与质量评估查看文件的编码器比特率等信息可以大致评估源文件的质量并据此选择合适的处理参数推荐的命令及其详解对于脚本化处理获取格式的输出是最方便的设置日志级别为这样在执行时不会打印版本信息库信息等额外的日志只输出纯净的数据或错误信息便于程序解析明确指定输出格式为是一种结构化的数据格式的模块可以轻松地将其解析为字典和列表指示在输出中包含关于容器格式的信息这部分信息描述了整个文件的属性指示在输出中包含文件中每一个数据流的详细信息包括视频音频字幕等深入理解输出结构输出的是一个字典其中最重要的两个键是和对象容器文件级别信息这个字典包含了文件的整体信息文件的完整路径文件中包含的流的总数容器格式的名称通常是逗号分隔的列表如容器格式的更详细名称文件播放的起始时间戳通常是文件的总时长单位秒字符串形式极其常用文件总大小单位字节字符串形式文件的平均总比特率单位字符串形式对探测到的格式的置信度通常不用太关心一个字典包含了容器级别的元数据标签例如编码这个文件的软件信息等列表流级别信息这是一个列表列表中的每个元素都是一个字典详细描述了文件中的一个流你需要遍历这个列表并通过来判断是视频流音频流还是其他类型的流通用关键字段流的索引号从开始流类型值为等用于区分不同流编解码器的短名称如编解码器的完整名称编码时使用的配置文件如的时间戳的基本单位分数形式如表示时间戳的单位是秒此流的起始时间秒此流的持续时间秒可能与中的总时长略有不同此流的平均比特率此流的总帧数对某些编码可能是估计值一个字典包含布尔标志指示流的用途如是否为默认流是否为配音强制字幕等此流特有的元数据如视频旋转角度等视频流特有关键字段视频解码后的宽度和高度像素视频编码时的宽度和高度可能因编码要求而与不同像素格式如编码级别如的代表详细的色彩空间信息像素宽高比和显示宽高比容器中标称的基础帧率分数如平均帧率分数如表示常用音频流特有关键字段音频采样格式如浮点平面采样率如常用声道数如常用声道布局描述如常用每个采样点的位数对于某些格式可能为解析示例增强版使用处理路径更健壮使用获取媒体文件的详细信息格式假设在系统中检查文件是否存在错误输入文件不存在构建命令列表抑制日志输出只输出或错误指定输出格式为要求包含容器格式信息要求包含所有流的信息将对象转换为字符串路径执行命令打印将要执行的命令方便调试执行命令并捕获输出捕获和将输出解码为文本如果返回非零退出码则抛出异常指定编码忽略解码中的小错误解析输出处理命令执行失败的情况执行失败返回码命令打印执行的命令错误输出打印错误信息处理命令未找到的情况错误命令未找到请确保已安装并将其添加到系统处理解析失败的情况错误解析输出失败错误打印原始输出可能有助于诊断的问题原始输出捕获其他未知错误获取媒体信息时发生未知错误使用示例替换为你需要分析的文件路径或者你电脑上的其他音视频文件文件的详细信息安全地访问信息容器信息格式时长秒时长大小大小总比特率总比特率流数量元数据标签流信息安全地访问列表流编码分辨率像素格式帧率采样率声道流时长秒流时长流比特率流比特率流标签未能获取文件的信息请检查文件路径和安装详细信息流如下文件的详细信息容器信息格式时长秒大小总比特率流数量元数据标签流信息流编码分辨率像素格式帧率流时长秒流比特率流标签流编码采样率声道流时长秒流比特率流标签核心的核心思想与其他库直接绑定的不同它并不直接执行编解码或滤镜操作而是提供了一套的接口让你像用代码描述流程一样来构建一个媒体处理的有向无环图在这个图中节点代表一个处理单元比如一个输入文件一个滤镜操作或者一个输出文件边代表在节点之间流动的媒体流可以是视频流音频流等你通过调用的函数如来创建节点并通过链式调用或将流作为参数传递来连接这些节点形成处理图这个图仅仅是一个处理流程的描述只有当你调用最终输出节点的或方法时才会将这个图编译成一个等效的可能非常复杂的命令行参数列表然后调用你系统上安装的可执行程序通过的模块来实际执行这个命令这种方式的主要优点是代码可读性高符合习惯并且能优雅地处理复杂的滤镜链和多输入多输出场景避免了手动拼接命令行字符串的痛苦和易错性探测媒体文件信息作用调用系统中的命令行工具分析指定的媒体文件并将其详细信息解析为一个结构化的字典返回这是在进行任何处理之前了解文件属性的关键步骤语法参数详解字符串必需要分析的媒体文件的路径或建议使用处理路径并传入字符串可选指定可执行文件的路径如果已经在系统环境变量中则保持默认值即可可选关键字参数对应传递给命令行的额外选项需要去掉选项前的例如对应表示只探测视频流的信息对应表示只在输出中包含指定的条目减少输出量对应标志用于计算流的总帧数可能较慢代码示例用于退出配置路径如果需要调用并打印关键信息错误文件不存在使用探测调用函数探测成功是一个包含详细信息的字典探测成功解析信息如下解析容器信息容器时长秒更高精度格式总比特率流数量解析流信息数据流流编码获取视频信息平均帧率更常用计算帧率的数值分数形式转小数分辨率像素格式帧率获取音频信息采样率声道打印流的比特率和时长流比特率流比特率流时长秒流时长执行出错打印原始错误输出错误命令未找到探测过程中发生未知错误使用示例确保存在一个可供探测的文件警告测试文件不存在请准备一个视频文件或运行之前的示例代码创建它如果需要可以在这里添加创建测试文件的逻辑返回值成功时返回一个字典包含了从获取并解析的媒体信息失败时抛出或其他异常知识点表格参数类型作用备注调用分析媒体文件并返回信息字典是进行处理前获取属性的关键必需文件路径可选可执行文件路径默认可选传递给的额外选项如返回值媒体信息字典异常执行失败时抛出可通过获取原始错误信息输入节点作用在构建的处理图中创建输入节点代表一个媒体文件设备或网络流来源这是所有处理流程的起点语法获取的文件列表使用的图像序列模式用于验证文件是否存在找到以下图像文件使用的图像序列模式未找到的文件参数详解字符串必需输入来源的标识符可以是本地文件路径设备名称依赖编译和系统支持例如上的需要或上的需要图像序列模式匹配滤镜源创建一个秒的黑色视频源可选关键字参数对应命令行中放在之前的输入选项键名通常与命令行选项相同去掉常用输入选项输入定位从指定时间点开始读取输入可以是秒数或格式比输出定位快但不精确到帧从输入源最多读取指定时长的数据从输入源读取数据直到达到指定的时间点强制使用指定的输入格式解复用器例如读取摄像头时可能需要或读取图像序列时用读取源时用强制指定输入的帧率主要用于本身没有帧率信息的输入如图形序列强制指定输入的分辨率主要用于本身没有分辨率信息的原始视频流强制指定输入的像素格式主要用于原始视频流用于无限循环单个输入图像通常和配合生成持续时间的视频用于视频等循环读取整个输入流指定的次数表示无限循环代码示例基本文件输入输入节点视频文件显示节点信息输入文件的一部分从第秒开始处理秒输入节点视频片段输入图像序列假设文件名为参数的意义决定了将图像序列转换为视频时的播放速度每秒显示张图片影响输出视频的流畅度和文件大小帧率越高越流畅但文件更大确定了时间轴的刻度例如第张图片将在第秒出现对于动画或视觉效果是电影行业的标准帧率给人流畅的视觉体验输入节点图像序列循环输入一个输入节点循环返回值函数返回一个代表输入源的节点对象这个对象包含了关于输入流的信息并且可以用流选择器来获取具体的对象用于后续处理知识点表格参数类型作用备注在处理图中创建输入节点处理流程的起点必需输入源路径或标识符可选对应的输入选项如等返回值代表输入源的节点对象可用于选择流等流的概念与选择作用一个媒体文件如通常包含多个数据流例如一个视频流一个或多个音频流不同语言一个或多个字幕流等函数返回的是一个代表整个输入源的节点对象为了对特定的数据流比如只对视频进行缩放或只选择英语音轨进行操作你需要从输入节点中精确地选择出你想要的那个流选择流会得到一个对象这个对象是后续应用滤镜的主体语法主要使用类似字典的方括号访问方式或者使用便捷属性只适用于第一个默认流等同于或等同于或等同于或参数详解是一个字符串其格式与命令行中的流标识符非常相似用于指定要选择哪个流等效含义或或第一个视频流或或第一个音频流或或第一个字幕流整数第个流绝对索引从开始不区分类型第个视频流索引从开始第个音频流索引从开始第个字幕流索引从开始其他其他标识符对更复杂的标识符如的直接支持可能有限通常通过先获取信息再按选择更可靠代码示例选择不同的流假设文件包含流视频流音频英语立体声流音频日语声道流字幕英语流字幕中文字幕创建输入节点替换为你的多流文件路径选择流选择第一个视频流最常用效果相同选择的默认视频流选择第一个音频流英语效果相同选择的默认音频流英语按类型和索引选择第二个音频流日语选择的第二个音频流日语按绝对索引选择第四个流这里是第一个字幕流注意索引从开始所以第个流的索引是选择的第个流索引英语字幕按类型和索引选择第二个字幕流中文选择的第二个字幕流中文后续可以将选择的流用于处理例如只输出视频和日语音频执行需要处理出错错误输入文件或命令未找到错误尝试选择的流索引不存在请用确认文件流信息发生未知错误返回值成功选择流会返回一个对象这个对象代表了处理图中的一个特定数据流可以对其调用方法或将其传递给如果指定的流不存在例如文件只有一个音频流但你尝试选择通常会在后续构建图或执行时取决于库的实现细节引发错误知识点流选择语法属性作用返回值备注主要方式使用流标识符选择流如等便捷属性选择第一个视频流等同于或便捷属性选择第一个音频流等同于或便捷属性选择第一个字幕流等同于或应用滤镜作用在中获取到一个代表特定流的对象后例如通过或你可以对这个流应用一个或多个滤镜来进行处理这是修改音视频内容的核心步骤比如调整大小裁剪调色调整音量等每次调用都会在处理图中添加一个滤镜节点并返回一个代表滤镜处理后输出的新对象语法参数详解字符串必需你想要应用的滤镜的名称例如等你可以通过查看所有可用滤镜可选位置参数传递给滤镜的位置参数某些简单的滤镜可以直接按顺序接收参数值例如滤镜可以接受宽度和高度作为前两个位置参数可选关键字参数推荐使用使用键值的形式传递滤镜的选项键名通常与滤镜文档中定义的选项名一致使用关键字参数通常更清晰易读不易出错例如注意如果滤镜选项名包含特殊字符或与关键字冲突虽然不常见你可能需要用字典解包的方式传递链式调用由于返回一个新的对象你可以方便地进行链式调用将多个滤镜按顺序应用到同一个流上形成一个简单的滤镜链对应命令行中用逗号分隔多个滤镜代码示例缩放视频流在系统变量中获取视频时长秒获取视频时长失败打印进度条获取视频时长创建输入节点选择视频流对视频流应用滤镜创建输出节点表示如果存在银平流则选择第一个不存在也不会报错音频直接复制查看命令调试生成的命令执行并显示进度条开始执行缩放使用代替直接以便捕获实时输出正则表达式用于从输出中提取时间信息初始化进度条读取的输出并更新进度条等待进程完成完成进度条缩放完成缩放失败发生错误代码示例链式调用调整音量并改变速度输入并选择音频流链式调用滤镜调整音量调整播放速度处理视频流添加速度调整调整视频播放速度定义输出视频不再使用编码因为需要处理视频速度使用处理后的视频流不再使用让自动选择合适的编码器查看命令生成的命令执行命令开始执行命令执行完成执行出错返回值方法返回一个新的对象代表应用了该滤镜之后的输出流你可以继续对这个新的对象调用或将它传递给知识点表格参数类型作用备注对当前流应用一个滤镜返回一个新的对象允许链式调用必需滤镜名称如可选滤镜的位置参数顺序必须与文档一致可选推荐滤镜的关键字参数键名通常同选项名返回值代表应用滤镜后的输出流输出节点与输出选项详解表格优化版作用函数用于在处理图中定义一个输出节点它指定了处理流程的终点即生成的输出文件并且包含了将输入流编码封装到这个输出文件时所需的所有配置如使用的编码器比特率格式时长限制等语法或者更清晰地分开写参数详解位置参数必需一个或多个对象代表要包含在输出文件中的数据流字符串必需最后一个位置参数指定输出文件的路径和名称扩展名如有助于推断默认格式可选关键字参数核心这些参数是控制输出文件属性的关键它们直接映射到命令中放在输出文件名前的输出选项下面表格列出了最常用的常用关键字参数描述示例值内为字符串强制指定输出文件的容器格式或指定视频编码器或指定音频编码器或指定字幕编码器或设置视频平均比特率与通常不同时使用或设置音频平均比特率恒定速率因子用于等控制视频质量值越低质量越好推荐使用编码器预设平衡速度与压缩率指定输出视频的像素格式影响颜色和兼容性常用应用简单的视频滤镜链字符串形式注意推荐使用方法构建应用简单的音频滤镜链字符串形式注意推荐使用方法构建限制输出文件的持续时长秒指定输出文件的结束时间点相对于输入开始时间主要用于设置的标志强烈推荐用于网络播放布尔值当有多个输入流时长不同时使输出时长等于最短的输入流字符串列表手动指定流映射注意通常直接传递对象给更一般无需此参数传递没有直接关键字参数对应的原生选项代码示例假设已经有输入节点和处理后的流假设处理过假设在中示例输出为指定编码器和质量示例输出处理后的视频流原始音频流输出文件名视频编码器视频质量控制编码速度音频编码器音频比特率像素格式优化命令输出完成注释掉了执行错误发生错误示例输出为指定比特率示例输出通常根据扩展名可推断视频编码视频目标比特率音频编码音频目标比特率命令输出完成注释掉了执行错误发生错误示例仅提取音频并转换为设置时长示例提取音频前秒只传入音频流编码器只输出前秒命令输出完成注释掉了执行错误发生错误示例改变容器格式直接复制流示例转换容器流复制假设此文件存在直接传入输入节点自动选择流对所有流使用命令输出完成注释掉了执行错误错误未找到发生错误返回值函数返回一个代表输出操作的对象你需要调用这个对象的或方法来最终执行整个处理流程知识点表格参数类型作用备注创建输出节点定义输出文件和编码格式选项处理流程的终点必需一个或多个要写入的流对象来自或的结果必需输出文件的路径和名称扩展名用于推断格式可选对应的输出选项控制编码质量格式时长等返回值代表输出操作的节点对象可以调用等全局选项与调试工具当你构建的处理流程变得复杂或者执行结果不符合预期时提供了一些工具来帮助你理解和调试发生了什么查看生成的命令作用这个方法不会执行任何命令它的唯一作用是将你通过构建的处理图从输入到输出编译成最终将要传递给可执行程序的命令行参数列表这对于以下情况极其有用调试当报错时你可以先看看生成的具体命令是什么然后将这个命令手动复制到你的终端里执行这样可以更直接地看到的原始输出和错误信息更容易定位问题学习通过观察代码如何转换为命令行参数可以加深对命令和库本身的理解集成在某些特殊情况下你可能只想用来构建命令参数列表然后用自己定制的调用或其他方式来执行它语法参数详解字符串可选指定可执行文件的路径这应该与你传递给的参数保持一致默认是代码示例构建一个稍微复杂点的处理流程仅用于演示输入从第秒开始缩放叠加处理后的视频原始音频输出文件输出时长秒调用获取参数列表打印生成的参数列表为了更直观可以尝试将其拼接成命令行字符串注意空格和引号注意直接可能对包含空格的参数处理不当仅作演示在实际执行时推荐直接将列表传递给构建图或编译时出错运行上述代码假设输入文件存在你将在控制台看到一个列表其中包含了为你生成的所有命令行参数例如你可以把这个列表去掉的方括号和引号加上开头的组合成一个完整的命令行字符串在终端里运行来验证返回值方法返回一个字符串列表代表将要传递给可执行程序的参数知识点表格参数类型作用备注将处理图编译为命令行参数列表不执行主要用于调试和学习可选可执行文件路径通常不需要指定返回值代表命令行参数的字符串列表可视化处理图作用对于非常复杂的滤镜图文本描述可能不够直观方法可以利用工具自动生成处理图的可视化流程图通常是或格式并尝试用系统默认程序打开它这有助于你理解数据流是如何在不同的滤镜节点之间传递和连接的重要前提要使用你必须安装库安装软件本身这是一个独立的开源图形可视化软件你需要根据你的操作系统进行安装并确保其命令可以在系统的环境变量中被找到从官网下载安装包并安装务必在安装过程中勾选或类似选项或语法参数详解字符串可选生成的图形文件的基本名称不含扩展名默认为字符串可选输出图形的文件格式默认为可以是命令支持的任何格式如代码示例假设是之前构建好的复杂输出节点尝试生成并查看处理图需要正确安装尝试生成并显示处理流程图这会生成和或你指定的格式文件并尝试用系统默认程序打开文件图形文件已生成或尝试打开请查找和错误无法执行命令请确保已正确安装并已添加到系统错误需要安装库生成图形时发生错误返回值方法通常返回它的主要作用是产生副作用生成文件和尝试打开查看器知识点表格参数类型作用备注使用生成处理流程图的可视化文件依赖软件和库可选输出图形文件的基本名称默认可选输出图形的文件格式默认支持等返回值主要产生副作用生成文件打开查看器全局选项作用有时候你需要传递的全局选项即放在命令之后第一个之前的选项例如来输出进度信息或者生成详细日志文件或者覆盖默认日志级别允许你在执行或时通过参数来传递这些选项语法参数详解列表可选一个包含全局选项及其值的字符串列表每个选项和它的值如果需要值的话应该作为列表中的独立元素代码示例确保进度文件不存在以免混淆示例使用传递使用选项将详细进度写入文件注意需要一个目标这里是协议传递全局选项执行完成进度信息已写入如果成功你可以在这里读取并解析的内容进度文件内容只打印部分执行失败执行时发生错误知识点表格用于参数名类型作用备注可选传递给的全局选项列表每个选项及其值是列表中的独立字符串元素",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-06-18 15:30:00",postMainColor:"#2C5A7F"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0F1C2E')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#cee8ff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/index_media.css" media="(max-width:0),screen and (prefers-reduced-motion:reduce)" onload="this.media=`screen`"><link rel="stylesheet" href="/css/post-ui.css"><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://bu.dusays.com/2025/06/16/684f747174bc3.webp"><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async="" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="博客"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="博客"><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="后续项目..."><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="后续项目..."><span class="back-menu-item-text">后续项目...</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">格物致知</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)" rel="external nofollow noreferrer">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>个人</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="fas fa-check-double faa-tada"></i><span> 代办清单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>预览</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?server=netease&amp;id=3117791189"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/messages/"><i class="fas fa-comments faa-tada"></i><span> 评论总览</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 即刻短文</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="background-change-button"><a class="site-page" onclick="toggleWinbox()" title="切换背景" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-palette"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/bYMH/418X445/ef9a3f68-d36a-441a-95fe-8179b1a25992.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/bYMH/418X445/ef9a3f68-d36a-441a-95fe-8179b1a25992.png"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/cYu3/347X390/zfb.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/cYu3/347X390/zfb.png"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">音乐</div><span class="author-content-item-title">灵魂的碰撞💥</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li></ul></div></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);" rel="external nofollow noreferrer"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/" itemprop="url">后端技术</a><i class="anzhiyufont anzhiyu-icon-angle-right post-meta-separator"></i><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Python/" itemprop="url">Python</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Python/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>Python</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Python教程：深入其境</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-06-18T02:00:00.000Z" title="发表于 2025-06-18 10:00:00">2025-06-18</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-06-18T07:30:00.000Z" title="更新于 2025-06-18 15:30:00">2025-06-18</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span data-flag-title="Python教程：深入其境"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为广东"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>广东</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://bu.dusays.com/2025/06/17/685113b7c5e0c.webp"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">Tianli GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax="" src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope="" itemtype="https://prorise-cool.github.io/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/"><header><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/" itemprop="url">后端技术</a><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/Python/" itemprop="url">Python</a><a href="/tags/Python/" tabindex="-1" itemprop="url">Python</a><h1 id="CrawlerTitle" itemprop="name headline">Python教程：深入其境</h1><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">Prorise</span><time itemprop="dateCreated datePublished" datetime="2025-06-18T02:00:00.000Z" title="发表于 2025-06-18 10:00:00">2025-06-18</time><time itemprop="dateCreated datePublished" datetime="2025-06-18T07:30:00.000Z" title="更新于 2025-06-18 15:30:00">2025-06-18</time></header><div id="postchat_postcontent"><h2 id="第十五章：Python-网络编程全解析"><a href="#第十五章：Python-网络编程全解析" class="headerlink" title="第十五章：Python 网络编程全解析"></a>第十五章：Python 网络编程全解析</h2><h3 id="15-1-网络编程基础"><a href="#15-1-网络编程基础" class="headerlink" title="15.1 网络编程基础"></a>15.1 网络编程基础</h3><p><strong>网络编程</strong> 是 Python 强大的应用领域之一，它使开发者能够创建通过网络通信的应用程序，从简单的客户端-服务器模型到复杂的分布式系统。Python 提供了丰富的标准库和第三方库来简化网络编程任务。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">网络编程基本概念:</span></span><br><span class="line"><span class="string">- 协议(Protocol): 通信规则和格式的约定</span></span><br><span class="line"><span class="string">- 套接字(Socket): 网络通信的端点</span></span><br><span class="line"><span class="string">- 客户端-服务器模型: 最常见的网络通信模式</span></span><br><span class="line"><span class="string">- 端口(Port): 区分主机上不同应用程序的数字标识符</span></span><br><span class="line"><span class="string">- IP地址: 标识网络上设备的地址</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Python网络编程的优势:</span></span><br><span class="line"><span class="string">- 简洁的API，降低开发复杂度</span></span><br><span class="line"><span class="string">- 丰富的标准库和第三方库支持</span></span><br><span class="line"><span class="string">- 跨平台兼容性好</span></span><br><span class="line"><span class="string">- 适合快速原型开发和生产级应用</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></tbody></table></figure><p>在深入具体的协议和实现之前，理解以下基础概念非常重要：</p><table><thead><tr><th>概念</th><th>描述</th><th>重要性</th></tr></thead><tbody><tr><td>OSI 七层模型</td><td>网络通信的概念框架，从物理层到应用层</td><td>理解不同协议的位置和作用</td></tr><tr><td>TCP/IP 模型</td><td>互联网的实际实现模型，包括链路层、网络层、传输层和应用层</td><td>掌握实际网络通信的基础</td></tr><tr><td>套接字编程</td><td>通过套接字 API 进行网络通信的编程模型</td><td>Python 网络编程的基础</td></tr><tr><td>阻塞与非阻塞 IO</td><td>不同的 IO 模型对网络编程效率的影响</td><td>影响程序架构和性能</td></tr></tbody></table><blockquote><p>🔍 <strong>深入理解</strong>：网络编程中的不同层次使用不同的协议。传输层常见的是 TCP 和 UDP，而应用层则有 HTTP、FTP、SMTP 等。Python 提供了所有这些协议的编程接口。</p></blockquote><h3 id="15-2-Socket-编程详解"><a href="#15-2-Socket-编程详解" class="headerlink" title="15.2 Socket 编程详解"></a>15.2 Socket 编程详解</h3><p>套接字(Socket)是网络编程的基础，它提供了进程间通信的端点。Python 的 <code>socket</code> 模块实现了 BSD 套接字标准。</p><h4 id="15-2-1-TCP-套接字"><a href="#15-2-1-TCP-套接字" class="headerlink" title="15.2.1 TCP 套接字"></a>15.2.1 TCP 套接字</h4><p>TCP(传输控制协议)是一种面向连接的、可靠的、基于字节流的传输层通信协议。</p><h5 id="TCP-套接字特性"><a href="#TCP-套接字特性" class="headerlink" title="TCP 套接字特性"></a>TCP 套接字特性</h5><table><thead><tr><th>特性</th><th>描述</th><th>优点/缺点</th></tr></thead><tbody><tr><td>连接导向</td><td>使用前需要建立连接</td><td>确保通信双方都准备好传输数据</td></tr><tr><td>可靠传输</td><td>通过确认机制保证数据传输</td><td>保证数据完整性，但增加延迟</td></tr><tr><td>流控制</td><td>通过滑动窗口机制控制发送速率</td><td>防止接收方缓冲区溢出</td></tr><tr><td>拥塞控制</td><td>监测网络拥塞状态并调整发送速率</td><td>防止网络拥塞崩溃</td></tr><tr><td>字节流</td><td>数据作为连续字节流处理</td><td>需要自己定义消息边界</td></tr></tbody></table><h5 id="Python-中的-TCP-客户端示例"><a href="#Python-中的-TCP-客户端示例" class="headerlink" title="Python 中的 TCP 客户端示例"></a>Python 中的 TCP 客户端示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tcp_client</span>():</span><br><span class="line">    <span class="string">"""简单的TCP客户端示例"""</span></span><br><span class="line">    <span class="comment"># 创建TCP套接字</span></span><br><span class="line">    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 连接服务器</span></span><br><span class="line">        client.connect((<span class="string">'example.com'</span>, <span class="number">80</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"已连接到服务器"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 发送HTTP请求</span></span><br><span class="line">        request = <span class="string">"GET / HTTP/1.1\r\nHost: example.com\r\n\r\n"</span></span><br><span class="line">        client.sendall(request.encode())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 接收响应</span></span><br><span class="line">        response = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            chunk = client.recv(<span class="number">4096</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            response += chunk</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"收到 <span class="subst">{<span class="built_in">len</span>(response)}</span> 字节的响应："</span>)</span><br><span class="line">        <span class="built_in">print</span>(response.decode()[:<span class="number">200</span>] + <span class="string">"..."</span>)  <span class="comment"># 只显示前200个字符</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        client.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"连接已关闭"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 调用客户端函数</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    tcp_client()</span><br></pre></td></tr></tbody></table></figure><h5 id="Python-中的-TCP-服务器示例"><a href="#Python-中的-TCP-服务器示例" class="headerlink" title="Python 中的 TCP 服务器示例"></a>Python 中的 TCP 服务器示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_client</span>(<span class="params">client_socket, address</span>):</span><br><span class="line">    <span class="string">"""处理客户端连接</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        client_socket: 客户端套接字</span></span><br><span class="line"><span class="string">        address: 客户端地址</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"接受来自 <span class="subst">{address}</span> 的连接"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 接收客户端数据</span></span><br><span class="line">    data = client_socket.recv(<span class="number">1024</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 处理数据</span></span><br><span class="line">    response = <span class="string">f"收到 <span class="subst">{<span class="built_in">len</span>(data)}</span> 字节的数据"</span>.encode()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 发送响应</span></span><br><span class="line">    client_socket.send(response)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 关闭连接</span></span><br><span class="line">    client_socket.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"与 <span class="subst">{address}</span> 的连接已关闭"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tcp_server</span>():</span><br><span class="line">    <span class="string">"""简单的多线程TCP服务器"""</span></span><br><span class="line">    <span class="comment"># 创建服务器套接字</span></span><br><span class="line">    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设置地址重用，防止"地址已在使用"错误</span></span><br><span class="line">    server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 绑定地址和端口</span></span><br><span class="line">    server.bind((<span class="string">'0.0.0.0'</span>, <span class="number">8888</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 开始监听</span></span><br><span class="line">    server.listen(<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"服务器启动，监听端口 8888..."</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># 接受客户端连接</span></span><br><span class="line">            client, address = server.accept()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 为每个客户端创建新线程</span></span><br><span class="line">            client_thread = threading.Thread(</span><br><span class="line">                target=handle_client,</span><br><span class="line">                args=(client, address)</span><br><span class="line">            )</span><br><span class="line">            client_thread.daemon = <span class="literal">True</span></span><br><span class="line">            client_thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"服务器关闭中..."</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        server.close()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 调用服务器函数</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    tcp_server()</span><br></pre></td></tr></tbody></table></figure><h4 id="15-2-2-UDP-套接字"><a href="#15-2-2-UDP-套接字" class="headerlink" title="15.2.2 UDP 套接字"></a>15.2.2 UDP 套接字</h4><p>UDP(用户数据报协议)是一种无连接的传输层协议，它不保证数据传输的可靠性，但具有较低的延迟。</p><h5 id="UDP-套接字特性"><a href="#UDP-套接字特性" class="headerlink" title="UDP 套接字特性"></a>UDP 套接字特性</h5><table><thead><tr><th>特性</th><th>描述</th><th>优点/缺点</th></tr></thead><tbody><tr><td>无连接</td><td>无需建立连接即可发送数据</td><td>降低延迟，但无法确保对方准备好</td></tr><tr><td>不可靠传输</td><td>不保证数据到达或顺序</td><td>丢包风险，但降低延迟</td></tr><tr><td>数据报方式</td><td>数据作为独立的包进行处理</td><td>保留消息边界，但有大小限制</td></tr><tr><td>无流控制</td><td>发送方可以任意速率发送数据</td><td>可能导致网络拥塞和接收方缓冲区溢出</td></tr><tr><td>低开销</td><td>没有连接管理和可靠性保证的开销</td><td>适合实时应用如视频流和游戏</td></tr></tbody></table><h5 id="Python-中的-UDP-客户端示例"><a href="#Python-中的-UDP-客户端示例" class="headerlink" title="Python 中的 UDP 客户端示例"></a>Python 中的 UDP 客户端示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">udp_client</span>():</span><br><span class="line">    <span class="string">"""简单的UDP客户端示例"""</span></span><br><span class="line">    <span class="comment"># 创建UDP套接字</span></span><br><span class="line">    client = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 服务器地址</span></span><br><span class="line">    server_address = (<span class="string">'localhost'</span>, <span class="number">9999</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 发送消息</span></span><br><span class="line">        message = <span class="string">"Hello, UDP Server!"</span></span><br><span class="line">        client.sendto(message.encode(), server_address)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"已发送消息: <span class="subst">{message}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 接收响应</span></span><br><span class="line">        client.settimeout(<span class="number">5</span>)  <span class="comment"># 设置超时</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data, server = client.recvfrom(<span class="number">4096</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"收到来自 <span class="subst">{server}</span> 的响应: <span class="subst">{data.decode()}</span>"</span>)</span><br><span class="line">        <span class="keyword">except</span> socket.timeout:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"接收响应超时"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        client.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"套接字已关闭"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 调用客户端函数</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    udp_client()</span><br></pre></td></tr></tbody></table></figure><h5 id="Python-中的-UDP-服务器示例"><a href="#Python-中的-UDP-服务器示例" class="headerlink" title="Python 中的 UDP 服务器示例"></a>Python 中的 UDP 服务器示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">udp_server</span>():</span><br><span class="line">    <span class="string">"""简单的UDP服务器示例"""</span></span><br><span class="line">    <span class="comment"># 创建UDP套接字</span></span><br><span class="line">    server = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 绑定地址和端口</span></span><br><span class="line">    server_address = (<span class="string">'0.0.0.0'</span>, <span class="number">9999</span>)</span><br><span class="line">    server.bind(server_address)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"UDP服务器启动，监听 <span class="subst">{server_address}</span>..."</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># 接收数据</span></span><br><span class="line">            data, client_address = server.recvfrom(<span class="number">4096</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"收到来自 <span class="subst">{client_address}</span> 的 <span class="subst">{<span class="built_in">len</span>(data)}</span> 字节数据"</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 处理接收到的数据</span></span><br><span class="line">            message = data.decode()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"收到消息: <span class="subst">{message}</span>"</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 发送响应</span></span><br><span class="line">            response = <span class="string">f"服务器已收到: <span class="subst">{message}</span>"</span></span><br><span class="line">            server.sendto(response.encode(), client_address)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"服务器关闭中..."</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        server.close()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 调用服务器函数</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    udp_server()</span><br></pre></td></tr></tbody></table></figure><h4 id="15-2-3-TCP-与-UDP-对比"><a href="#15-2-3-TCP-与-UDP-对比" class="headerlink" title="15.2.3 TCP 与 UDP 对比"></a>15.2.3 TCP 与 UDP 对比</h4><table><thead><tr><th>特性</th><th>TCP</th><th>UDP</th><th>最适用场景</th></tr></thead><tbody><tr><td>连接</td><td>需要建立连接</td><td>无连接</td><td>TCP 适合需要可靠通信的应用</td></tr><tr><td>可靠性</td><td>高（确认、重传、排序）</td><td>低（无保证）</td><td>TCP 适合文件传输、网页浏览</td></tr><tr><td>性能</td><td>较低（连接开销、拥塞控制）</td><td>高（低延迟）</td><td>UDP 适合实时多媒体、游戏</td></tr><tr><td>数据流</td><td>字节流（无边界）</td><td>数据报（有边界）</td><td>TCP 适合流式传输，UDP 适合消息传输</td></tr><tr><td>头部大小</td><td>20 字节+选项</td><td>8 字节</td><td>UDP 适合小数据包场景</td></tr><tr><td>流控/拥塞控制</td><td>有</td><td>无</td><td>TCP 适合防止网络拥塞的场景</td></tr></tbody></table><h3 id="15-3-通用网络协议与-Python-实现"><a href="#15-3-通用网络协议与-Python-实现" class="headerlink" title="15.3 通用网络协议与 Python 实现"></a>15.3 通用网络协议与 Python 实现</h3><p>本章节中，我们会学习常见的协议（其中较为常见的协议会比较简略带过，仅提供示例 demo）以及推荐常用的第三方库等，对于一些不常见，而在我们开发中需要进阶使用的协议，我们会进行详解</p><h4 id="15-3-1-HTTP-HTTPS-协议"><a href="#15-3-1-HTTP-HTTPS-协议" class="headerlink" title="15.3.1 HTTP/HTTPS 协议"></a>15.3.1 HTTP/HTTPS 协议</h4><p>HTTP(超文本传输协议)和 HTTPS(安全的超文本传输协议)是万维网的基础。</p><h5 id="HTTP-HTTPS-协议特性"><a href="#HTTP-HTTPS-协议特性" class="headerlink" title="HTTP/HTTPS 协议特性"></a>HTTP/HTTPS 协议特性</h5><table><thead><tr><th>特性</th><th>描述</th><th>HTTP</th><th>HTTPS</th></tr></thead><tbody><tr><td>传输安全</td><td>数据加密</td><td>无加密</td><td>TLS/SSL 加密</td></tr><tr><td>默认端口</td><td>服务器监听端口</td><td>80</td><td>443</td></tr><tr><td>证书验证</td><td>服务器身份验证</td><td>无</td><td>数字证书</td></tr><tr><td>请求/响应模式</td><td>通信模式</td><td>客户端请求，服务器响应</td><td>客户端请求，服务器响应</td></tr><tr><td>无状态</td><td>不保存会话信息</td><td>是</td><td>是</td></tr><tr><td>数据格式</td><td>传输格式</td><td>文本/二进制</td><td>加密的文本/二进制</td></tr></tbody></table><h5 id="Python-标准库-HTTP-客户端"><a href="#Python-标准库-HTTP-客户端" class="headerlink" title="Python 标准库 HTTP 客户端"></a>Python 标准库 HTTP 客户端</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http.client</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">http_client_standard</span>():</span><br><span class="line">    <span class="string">"""使用标准库的HTTP客户端"""</span></span><br><span class="line">    <span class="comment"># 创建连接</span></span><br><span class="line">    conn = http.client.HTTPSConnection(<span class="string">"api.github.com"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设置请求头</span></span><br><span class="line">    headers = {</span><br><span class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Python HTTP Client'</span>,</span><br><span class="line">        <span class="string">'Accept'</span>: <span class="string">'application/json'</span></span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 发送GET请求</span></span><br><span class="line">        conn.request(<span class="string">"GET"</span>, <span class="string">"/users/octocat"</span>, headers=headers)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取响应</span></span><br><span class="line">        response = conn.getresponse()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"状态码: <span class="subst">{response.status}</span> <span class="subst">{response.reason}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 读取响应体</span></span><br><span class="line">        data = response.read().decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解析JSON响应</span></span><br><span class="line">        user_data = json.loads(data)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"用户名: <span class="subst">{user_data.get(<span class="string">'login'</span>)}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"个人主页: <span class="subst">{user_data.get(<span class="string">'html_url'</span>)}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 关闭连接</span></span><br><span class="line">        conn.close()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 运行示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    http_client_standard()</span><br></pre></td></tr></tbody></table></figure><h5 id="推荐的第三方-HTTP-库"><a href="#推荐的第三方-HTTP-库" class="headerlink" title="推荐的第三方 HTTP 库"></a>推荐的第三方 HTTP 库</h5><table><thead><tr><th>库名</th><th>特性</th><th>适用场景</th><th>安装命令</th></tr></thead><tbody><tr><td><code>requests（重点）</code></td><td>简化的 API，丰富的功能，可读性强</td><td>一般 HTTP 客户端需求</td><td><code>pip install requests</code></td></tr><tr><td><code>aiohttp（重点）</code></td><td>异步 HTTP 客户端/服务器</td><td>高性能异步应用</td><td><code>pip install aiohttp</code></td></tr><tr><td><code>httpx</code></td><td>支持同步和异步，HTTP/1.1 和 HTTP/2</td><td>现代 HTTP 客户端需求</td><td><code>pip install httpx</code></td></tr><tr><td><code>urllib3</code></td><td>低级 HTTP 客户端，连接池，重试</td><td>需要细粒度控制的场景</td><td><code>pip install urllib3</code></td></tr><tr><td><code>pycurl</code></td><td>libcurl 的 Python 绑定，高性能</td><td>复杂的 HTTP 客户端需求</td><td><code>pip install pycurl</code></td></tr></tbody></table><h5 id="requests-库示例"><a href="#requests-库示例" class="headerlink" title="requests 库示例"></a>requests 库示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">requests_example</span>():</span><br><span class="line">    <span class="string">"""使用requests库的示例"""</span></span><br><span class="line">    <span class="comment"># 设置请求参数</span></span><br><span class="line">    url = <span class="string">"https://api.github.com/users/octocat"</span></span><br><span class="line">    headers = {</span><br><span class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Python Requests'</span>,</span><br><span class="line">        <span class="string">'Accept'</span>: <span class="string">'application/json'</span></span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 发送GET请求</span></span><br><span class="line">        response = requests.get(url, headers=headers)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 自动检查HTTP错误</span></span><br><span class="line">        response.raise_for_status()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解析JSON响应</span></span><br><span class="line">        user_data = response.json()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"用户名: <span class="subst">{user_data.get(<span class="string">'login'</span>)}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"个人主页: <span class="subst">{user_data.get(<span class="string">'html_url'</span>)}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"公开仓库数: <span class="subst">{user_data.get(<span class="string">'public_repos'</span>)}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取响应头信息</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n响应头信息:"</span>)</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> response.headers.items():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"<span class="subst">{key}</span>: <span class="subst">{value}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"HTTP错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"连接错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.Timeout <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"请求超时: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"请求异常: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 运行示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    requests_example()</span><br></pre></td></tr></tbody></table></figure><h5 id="aiohttp-异步-HTTP-示例"><a href="#aiohttp-异步-HTTP-示例" class="headerlink" title="aiohttp 异步 HTTP 示例"></a>aiohttp 异步 HTTP 示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_user</span>(<span class="params">username</span>):</span><br><span class="line">    <span class="string">"""异步获取用户信息</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        username: GitHub用户名</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = <span class="string">f"https://api.github.com/users/<span class="subst">{username}</span>"</span></span><br><span class="line">    headers = {</span><br><span class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Python aiohttp'</span>,</span><br><span class="line">        <span class="string">'Accept'</span>: <span class="string">'application/json'</span></span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, headers=headers) <span class="keyword">as</span> response:</span><br><span class="line">            <span class="keyword">if</span> response.status == <span class="number">200</span>:</span><br><span class="line">                data = <span class="keyword">await</span> response.json()</span><br><span class="line">                <span class="keyword">return</span> {</span><br><span class="line">                    <span class="string">'username'</span>: data.get(<span class="string">'login'</span>),</span><br><span class="line">                    <span class="string">'name'</span>: data.get(<span class="string">'name'</span>),</span><br><span class="line">                    <span class="string">'repos'</span>: data.get(<span class="string">'public_repos'</span>)</span><br><span class="line">                }</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"获取用户 <span class="subst">{username}</span> 失败: <span class="subst">{response.status}</span>"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">"""主函数"""</span></span><br><span class="line">    usernames = [<span class="string">"octocat"</span>, <span class="string">"torvalds"</span>, <span class="string">"gvanrossum"</span>]</span><br><span class="line">    tasks = [fetch_user(username) <span class="keyword">for</span> username <span class="keyword">in</span> usernames]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 并发执行所有任务</span></span><br><span class="line">    results = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 打印结果</span></span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> results:</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"用户: <span class="subst">{user[<span class="string">'username'</span>]}</span>, 姓名: <span class="subst">{user[<span class="string">'name'</span>]}</span>, 仓库数: <span class="subst">{user[<span class="string">'repos'</span>]}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 运行异步函数</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></tbody></table></figure><h4 id="15-3-2-FTP-SFTP-协议"><a href="#15-3-2-FTP-SFTP-协议" class="headerlink" title="15.3.2 FTP/SFTP 协议"></a>15.3.2 FTP/SFTP 协议</h4><p>FTP(文件传输协议)和 SFTP(安全文件传输协议)用于在网络中传输文件。</p><h5 id="FTP-SFTP-协议特性"><a href="#FTP-SFTP-协议特性" class="headerlink" title="FTP/SFTP 协议特性"></a>FTP/SFTP 协议特性</h5><table><thead><tr><th>特性</th><th>FTP</th><th>SFTP</th><th>注意事项</th></tr></thead><tbody><tr><td>安全性</td><td>不加密（明文传输）</td><td>SSH 加密通道</td><td>FTP 不适合传输敏感数据</td></tr><tr><td>认证</td><td>用户名/密码（明文）</td><td>SSH 认证机制</td><td>SFTP 支持密钥认证</td></tr><tr><td>复杂性</td><td>需要控制连接和数据连接</td><td>单一连接</td><td>FTP 需要处理主动/被动模式</td></tr><tr><td>防火墙兼容性</td><td>较差（需要多个端口）</td><td>良好（单一端口）</td><td>FTP 可能需要特殊配置</td></tr><tr><td>标准化</td><td>RFC 959</td><td>无正式 RFC，基于 SSH</td><td>SFTP 是 SSH 协议的扩展</td></tr><tr><td>默认端口</td><td>21（控制）+ 数据端口</td><td>22（SSH 端口）</td><td>FTP 数据端口不固定</td></tr></tbody></table><h5 id="Python-标准库-FTP-客户端"><a href="#Python-标准库-FTP-客户端" class="headerlink" title="Python 标准库 FTP 客户端"></a>Python 标准库 FTP 客户端</h5><p>以下是 Python 中 FTP 客户端常用 API 的简洁总结，使用表格展示：</p><table><thead><tr><th>方法</th><th>描述</th><th>使用场景</th></tr></thead><tbody><tr><td><code>ftplib.FTP()</code></td><td>创建一个 FTP 对象</td><td>用于连接到 FTP 服务器</td></tr><tr><td><code>ftp.login()</code></td><td>登录到 FTP 服务器</td><td>进行身份验证</td></tr><tr><td><code>ftp.cwd()</code></td><td>改变当前目录</td><td>切换服务器上的工作目录</td></tr><tr><td><code>ftp.retrbinary()</code></td><td>以二进制模式下载文件</td><td>下载文件（例如图片、视频等）</td></tr><tr><td><code>ftp.storbinary()</code></td><td>以二进制模式上传文件</td><td>上传文件（例如图片、视频等）</td></tr><tr><td><code>ftp.retrlines()</code></td><td>以文本模式获取文件内容</td><td>获取文件内容并输出到控制台</td></tr><tr><td><code>ftp.storlines()</code></td><td>以文本模式上传文件</td><td>上传文本文件（例如配置文件）</td></tr><tr><td><code>ftp.mkd()</code></td><td>创建目录</td><td>在 FTP 服务器上创建新目录</td></tr><tr><td><code>ftp.rmd()</code></td><td>删除目录</td><td>删除 FTP 服务器上的目录</td></tr><tr><td><code>ftp.delete()</code></td><td>删除文件</td><td>删除 FTP 服务器上的文件</td></tr><tr><td><code>ftp.quit()</code></td><td>退出 FTP 连接</td><td>断开与 FTP 服务器的连接</td></tr></tbody></table><h5 id="快速搭建一个本地的-FTP-服务器"><a href="#快速搭建一个本地的-FTP-服务器" class="headerlink" title="快速搭建一个本地的 FTP 服务器"></a>快速搭建一个本地的 FTP 服务器</h5><p>【1】配置 IIS Web 服务器</p><pre><code>【1.1】控制面板找到“程序”并打开
</code></pre><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428173744061.png" alt="image-20250428173744061"></p><pre><code>【1.2】程序界面找到“启用或关闭 Windows 功能”并打开
</code></pre><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428173819331.png" alt="image-20250428173819331"></p><p>【1.3】从“启用或关闭 Windows 功能”弹窗中找到 Internet Information Services(或者中文版 Internet 信息服务)并打开</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428173955073.png" alt="image-20250428173955073"></p><p>【1.4】配置 IIS 并点击确定</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428174047982.png" alt="image-20250428174047982"></p><p>【2】第二步：配置 IIS web 站点</p><pre><code>【2.1】 开始菜单搜索“IIS”并点击进入 IIS 管理器
</code></pre><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428174339662.png" alt="image-20250428174339662"></p><p>【2.2】新建 FTP 站点、新增 FTP 服务器根目录文件夹</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428174440134.png" alt="image-20250428174440134"></p><p>【2.3】查看本机 ip 地址，后续访问 Ftp 地址需要用到（打开 cmd 输入 ipconfig）</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428174535742.png" alt="image-20250428174535742"></p><p>【2.4】IIS 网站管理器界面左边导航栏找到“网站”，右键弹出菜单</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428174640479.png" alt="image-20250428174640479"></p><p>【2.5】配置网站</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428174752526.png" alt="image-20250428174752526"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428174833223.png" alt="image-20250428174833223"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428174908689.png" alt="image-20250428174908689"></p><p>【3】测试 FTP 站点（先在物理路径：E:\ftpserver 随便放一个文件）</p><p>在浏览器访问 ftp：ip 就能看到预期的文件</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428180832484.png" alt="image-20250428180832484"></p><p>我们很有可能会遇到三个问题：</p><ul><li><p>1.无论怎么输入都没有反应 – 详细见下图，在浏览器的浏览器设置中调整配置即可</p></li><li><p>2.需要强制打开某某浏览器才能打开 – 更换默认应用打开方式</p></li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250428180725577.png" alt="image-20250428180725577"></p><h5 id="实现-FTP-文件上传下载"><a href="#实现-FTP-文件上传下载" class="headerlink" title="实现 FTP 文件上传下载"></a>实现 FTP 文件上传下载</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> ftplib <span class="keyword">import</span> FTP</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ftp_connection</span>(<span class="params">host, port=<span class="number">21</span>, user=<span class="literal">None</span>, passwd=<span class="literal">None</span>, encoding=<span class="string">"GB18030"</span>, timeout=<span class="number">30</span></span>):</span><br><span class="line">    <span class="string">"""创建 FTP 连接的上下文管理器，确保连接正确关闭</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        host: FTP 服务器地址</span></span><br><span class="line"><span class="string">        port: FTP 服务器端口，默认为 21</span></span><br><span class="line"><span class="string">        user: FTP 用户名，默认为 None（匿名登录）</span></span><br><span class="line"><span class="string">        passwd: FTP 密码，默认为 None</span></span><br><span class="line"><span class="string">        encoding: 服务器编码，默认为 GB18030</span></span><br><span class="line"><span class="string">        timeout: 连接超时时间（秒），默认为 30</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Yields:</span></span><br><span class="line"><span class="string">        ftplib.FTP: 已连接的 FTP 对象</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    ftp = FTP()</span><br><span class="line">    ftp.encoding = encoding</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ftp.connect(host, port, timeout)</span><br><span class="line">        ftp.login(user, passwd)</span><br><span class="line">        <span class="keyword">yield</span> ftp</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> ftp:</span><br><span class="line">            ftp.quit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>(<span class="params">local_path, remote_path, filename, host=<span class="string">"172.17.115.3"</span>, port=<span class="number">21</span>,</span></span><br><span class="line"><span class="params">                user=<span class="literal">None</span>, passwd=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""上传本地文件到 FTP 服务器</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        local_path: 本地文件的完整路径</span></span><br><span class="line"><span class="string">        remote_path: FTP 服务器上的目标路径</span></span><br><span class="line"><span class="string">        filename: 上传后的文件名</span></span><br><span class="line"><span class="string">        host: FTP 服务器地址，默认为 172.17.115.3</span></span><br><span class="line"><span class="string">        port: FTP 服务器端口，默认为 21</span></span><br><span class="line"><span class="string">        user: FTP 用户名，默认为 None（匿名登录）</span></span><br><span class="line"><span class="string">        passwd: FTP 密码，默认为 None</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        bool: 上传成功返回 True，否则返回 False</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> ftp_connection(host, port, user, passwd) <span class="keyword">as</span> ftp:</span><br><span class="line">            ftp.cwd(remote_path)  <span class="comment"># 切换至目标路径</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(local_path, <span class="string">"rb"</span>) <span class="keyword">as</span> local_file:</span><br><span class="line">                ftp.storbinary(<span class="string">"STOR "</span> + filename, local_file)  <span class="comment"># 上传文件</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"文件上传成功！"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"文件上传失败！"</span>, e)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">remote_path, remote_filename, local_path, host=<span class="string">"172.17.115.3"</span>, port=<span class="number">21</span>,</span></span><br><span class="line"><span class="params">                  user=<span class="literal">None</span>, passwd=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""从 FTP 服务器下载文件到本地</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        remote_path: FTP 服务器上的文件路径</span></span><br><span class="line"><span class="string">        remote_filename: 要下载的文件名</span></span><br><span class="line"><span class="string">        local_path: 本地保存路径</span></span><br><span class="line"><span class="string">        host: FTP 服务器地址，默认为 172.17.115.3</span></span><br><span class="line"><span class="string">        port: FTP 服务器端口，默认为 21</span></span><br><span class="line"><span class="string">        user: FTP 用户名，默认为 None（匿名登录）</span></span><br><span class="line"><span class="string">        passwd: FTP 密码，默认为 None</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        bool: 下载成功返回 True，否则返回 False</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> ftp_connection(host, port, user, passwd) <span class="keyword">as</span> ftp:</span><br><span class="line">            ftp.cwd(remote_path)  <span class="comment"># 切换至目标路径</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(local_path, <span class="string">"wb"</span>) <span class="keyword">as</span> local_file:</span><br><span class="line">                ftp.retrbinary(<span class="string">"RETR "</span> + remote_filename, local_file.write)  <span class="comment"># 下载文件</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"文件下载成功！"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"文件下载失败！"</span>, e)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">list_files</span>(<span class="params">remote_path, host=<span class="string">"172.17.115.3"</span>, port=<span class="number">21</span>, user=<span class="literal">None</span>, passwd=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""列出 FTP 服务器上指定目录中的文件</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        remote_path: FTP 服务器上的目录路径</span></span><br><span class="line"><span class="string">        host: FTP 服务器地址，默认为 172.17.115.3</span></span><br><span class="line"><span class="string">        port: FTP 服务器端口，默认为 21</span></span><br><span class="line"><span class="string">        user: FTP 用户名，默认为 None（匿名登录）</span></span><br><span class="line"><span class="string">        passwd: FTP 密码，默认为 None</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        list: 文件名列表</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    files = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> ftp_connection(host, port, user, passwd) <span class="keyword">as</span> ftp:</span><br><span class="line">            ftp.cwd(remote_path)</span><br><span class="line">            <span class="comment"># ftp.retrlines会对每一行调用传入的回调函数，将每行内容作为参数传递给回调函数</span></span><br><span class="line">            ftp.retrlines(<span class="string">"LIST"</span>, <span class="keyword">lambda</span> x: files.append(x.split()[-<span class="number">1</span>])) <span class="comment"># 由于前三个字符为时间，所以只取最后一个字段</span></span><br><span class="line">        <span class="keyword">return</span> files</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"文件列表获取失败！"</span>, e)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 示例：上传文件</span></span><br><span class="line">    upload_file(</span><br><span class="line">        local_path=<span class="string">r"test3.txt"</span>,  <span class="comment"># 当前目录下的test3.txt文件</span></span><br><span class="line">        remote_path=<span class="string">"/upload"</span>,  <span class="comment"># FTP服务器上的目标目录</span></span><br><span class="line">        filename=<span class="string">"test3.txt"</span>,  <span class="comment"># 上传后的文件名</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 示例：下载文件 - 将刚上传的文件下载回来（使用不同的名称以便比较）</span></span><br><span class="line">    download_file(</span><br><span class="line">        remote_path=<span class="string">"/upload"</span>,</span><br><span class="line">        remote_filename=<span class="string">"test3.txt"</span>,</span><br><span class="line">        local_path=<span class="string">r"test3_downloaded.txt"</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 示例：列出目录中的文件</span></span><br><span class="line">    files = list_files(</span><br><span class="line">        remote_path=<span class="string">"/upload"</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"FTP服务器上的文件列表:"</span>, files)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="推荐的-FTP-SFTP-第三方库"><a href="#推荐的-FTP-SFTP-第三方库" class="headerlink" title="推荐的 FTP/SFTP 第三方库"></a>推荐的 FTP/SFTP 第三方库</h5><table><thead><tr><th>库名</th><th>特性</th><th>适用场景</th><th>安装命令</th></tr></thead><tbody><tr><td><code>paramiko</code></td><td>SFTP 客户端/服务器，SSH 实现</td><td>需要安全文件传输</td><td><code>pip install paramiko</code></td></tr><tr><td><code>pysftp</code></td><td>基于 paramiko 的高级 SFTP 客户端</td><td>简化的 SFTP 操作</td><td><code>pip install pysftp</code></td></tr><tr><td><code>ftputil</code></td><td>FTP 客户端，类似文件系统 API</td><td>复杂的 FTP 操作</td><td><code>pip install ftputil</code></td></tr><tr><td><code>aioftp</code></td><td>异步 FTP 客户端/服务器</td><td>高性能异步文件传输</td><td><code>pip install aioftp</code></td></tr><tr><td><code>scp</code></td><td>基于 SSH 的简单文件复制</td><td>简单文件传输需求</td><td><code>pip install scp</code></td></tr></tbody></table><h4 id="15-3-3-WebSocket-协议"><a href="#15-3-3-WebSocket-协议" class="headerlink" title="15.3.3 WebSocket 协议"></a>15.3.3 WebSocket 协议</h4><p>WebSocket 协议提供了在单个 TCP 连接上进行全双工通信的能力，特别适用于需要实时通信的应用。</p><h5 id="WebSocket-协议特性"><a href="#WebSocket-协议特性" class="headerlink" title="WebSocket 协议特性"></a>WebSocket 协议特性</h5><table><thead><tr><th>特性</th><th>描述</th><th>优势</th></tr></thead><tbody><tr><td>全双工通信</td><td>客户端和服务器可以同时发送和接收数据</td><td>减少延迟，提高实时性</td></tr><tr><td>持久连接</td><td>建立一次连接后长期保持</td><td>减少连接建立的开销</td></tr><tr><td>低延迟</td><td>无需为每个消息建立新连接</td><td>适合实时应用如聊天、游戏</td></tr><tr><td>基于 TCP</td><td>在可靠传输之上构建</td><td>保证消息可靠送达</td></tr><tr><td>支持二进制和文本</td><td>可传输任何类型的数据</td><td>适用范围广泛</td></tr><tr><td>标准化</td><td>RFC 6455 定义</td><td>广泛支持，客户端兼容性好</td></tr></tbody></table><h5 id="推荐的-WebSocket-第三方库"><a href="#推荐的-WebSocket-第三方库" class="headerlink" title="推荐的 WebSocket 第三方库"></a>推荐的 WebSocket 第三方库</h5><table><thead><tr><th>库名</th><th>特性</th><th>适用场景</th><th>安装命令</th></tr></thead><tbody><tr><td><code>websockets</code></td><td>纯 Python 异步 WebSocket 实现</td><td>异步 WebSocket 应用</td><td><code>pip install websockets</code></td></tr><tr><td><code>GoEazy</code></td><td>免费简单的 API 连接调用</td><td>全面的 Websocket 应用</td><td>网络搜索 GoEazy</td></tr></tbody></table><h5 id="websockets-库示例"><a href="#websockets-库示例" class="headerlink" title="websockets 库示例"></a>websockets 库示例</h5><table><thead><tr><th>方法</th><th>描述</th><th>使用场景</th></tr></thead><tbody><tr><td><code>websocket.WebSocketApp()</code></td><td>创建 WebSocket 应用实例</td><td>用于初始化 WebSocket 客户端</td></tr><tr><td><code>ws.run_forever()</code></td><td>启动 WebSocket 客户端并保持连接</td><td>用于运行 WebSocket 连接，保持客户端在线</td></tr><tr><td><code>ws.send()</code></td><td>发送消息到 WebSocket 服务器</td><td>向服务器发送数据</td></tr><tr><td><code>ws.recv()</code></td><td>接收来自 WebSocket 服务器的消息</td><td>从服务器接收消息</td></tr><tr><td><code>ws.close()</code></td><td>关闭 WebSocket 连接</td><td>关闭 WebSocket 连接</td></tr><tr><td><code>ws.on_message()</code></td><td>处理接收到的消息事件</td><td>用于定义接收到消息时的回调函数</td></tr><tr><td><code>ws.on_error()</code></td><td>处理错误事件</td><td>用于定义错误发生时的回调函数</td></tr><tr><td><code>ws.on_close()</code></td><td>处理连接关闭事件</td><td>用于定义 WebSocket 连接关闭时的回调函数</td></tr><tr><td><code>ws.on_open()</code></td><td>处理连接打开事件</td><td>用于定义 WebSocket 连接建立时的回调函数</td></tr></tbody></table><h5 id="使用-websockets-实现在线聊天室"><a href="#使用-websockets-实现在线聊天室" class="headerlink" title="使用 websockets 实现在线聊天室"></a>使用 websockets 实现在线聊天室</h5><p>前端实现（VUE3 + tailwindcss + daisyUi） – 可以不用理解，直接复制到 HTML 文件即可</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebSocket聊天应用<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Tailwind CSS --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.tailwindcss.com"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Daisy UI --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Vue 3 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/vue@3/dist/vue.global.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 消息动画 */</span></span></span><br><span class="line"><span class="language-css">        <span class="keyword">@keyframes</span> fadeIn {</span></span><br><span class="line"><span class="language-css">            <span class="selector-tag">from</span> {</span></span><br><span class="line"><span class="language-css">                <span class="attribute">opacity</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">transform</span>: <span class="built_in">translateY</span>(<span class="number">10px</span>);</span></span><br><span class="line"><span class="language-css">            }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">            <span class="selector-tag">to</span> {</span></span><br><span class="line"><span class="language-css">                <span class="attribute">opacity</span>: <span class="number">1</span>;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">transform</span>: <span class="built_in">translateY</span>(<span class="number">0</span>);</span></span><br><span class="line"><span class="language-css">            }</span></span><br><span class="line"><span class="language-css">        }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.message-animation</span> {</span></span><br><span class="line"><span class="language-css">            <span class="attribute">animation</span>: fadeIn <span class="number">0.3s</span> ease-out forwards;</span></span><br><span class="line"><span class="language-css">        }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 系统消息样式 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.system-message</span> {</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">0.5rem</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0.5rem</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#f3f4f6</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">0.5rem</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#6b7280</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">0.875rem</span>;</span></span><br><span class="line"><span class="language-css">        }</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span> <span class="attr">class</span>=<span class="string">"container mx-auto px-4 py-8 max-w-4xl"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">"flex justify-between items-center mb-4 bg-gray-100 p-4 rounded-lg"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 标题栏 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"flex items-center gap-4"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"text-2xl font-bold text-center"</span>&gt;</span>WebSocket聊天应用<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"dropdown dropdown-hover"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">tabindex</span>=<span class="string">"0"</span> <span class="attr">class</span>=<span class="string">"btn btn-ghost btn-circle avatar"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"w-10 rounded-full"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">"userAvatar"</span> <span class="attr">alt</span>=<span class="string">"用户头像"</span> /&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">tabindex</span>=<span class="string">"0"</span> <span class="attr">class</span>=<span class="string">"dropdown-content z-[1] card card-compact w-64 p-2 shadow bg-base-100"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card-body"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"font-bold text-lg"</span>&gt;</span>个人信息<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-control"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"label"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"label-text"</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"currentUser"</span> <span class="attr">placeholder</span>=<span class="string">"输入用户名"</span></span></span><br><span class="line"><span class="tag">                                    <span class="attr">class</span>=<span class="string">"input input-bordered w-full"</span> @<span class="attr">change</span>=<span class="string">"updateUserInfo"</span> /&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-control mt-2"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"label"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"label-text"</span>&gt;</span>选择头像<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"grid grid-cols-3 gap-2"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"(avatar, index) in avatarOptions"</span> <span class="attr">:key</span>=<span class="string">"index"</span></span></span><br><span class="line"><span class="tag">                                        @<span class="attr">click</span>=<span class="string">"selectAvatar(avatar)"</span></span></span><br><span class="line"><span class="tag">                                        <span class="attr">class</span>=<span class="string">"w-12 h-12 rounded-full cursor-pointer hover:ring-2 hover:ring-primary"</span></span></span><br><span class="line"><span class="tag">                                        <span class="attr">:class</span>=<span class="string">"{'ring-2 ring-primary': userAvatar === avatar}"</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">"avatar"</span> <span class="attr">class</span>=<span class="string">"w-full h-full rounded-full object-cover"</span> /&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"flex flex-col items-end gap-1"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"badge badge-outline"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">:class</span>=<span class="string">"isConnected ? 'badge-success text-white' : 'badge-error text-white'"</span>&gt;</span></span><br><span class="line">                    {{ connectionStatus }}</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"text-xs text-gray-500"</span> <span class="attr">v-if</span>=<span class="string">"isConnected"</span>&gt;</span></span><br><span class="line">                    在线用户: {{ onlineUsersCount }}</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 在线用户列表 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"flex mb-4"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"w-1/4 mr-4 card bg-base-100 shadow-md"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card-body p-4"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"card-title text-lg mb-2"</span>&gt;</span>在线用户<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"divider my-1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"overflow-y-auto max-h-80"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"user in onlineUsers"</span> <span class="attr">:key</span>=<span class="string">"user.client_id"</span> <span class="attr">class</span>=<span class="string">"flex items-center gap-2 mb-2"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"avatar"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"w-8 h-8 rounded-full"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">"user.avatar"</span> <span class="attr">alt</span>=<span class="string">"User avatar"</span> /&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"font-medium"</span> <span class="attr">:class</span>=<span class="string">"{'text-primary': user.client_id === clientId}"</span>&gt;</span></span><br><span class="line">                                {{ user.username }}</span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-if</span>=<span class="string">"user.client_id === clientId"</span>&gt;</span>(我)<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 消息区域 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"w-3/4 card bg-base-100 shadow-md"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card-body h-96 overflow-y-auto"</span> <span class="attr">ref</span>=<span class="string">"messageContainer"</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- 若没有消息，显示空状态 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"messages.length === 0"</span> <span class="attr">class</span>=<span class="string">"h-full flex items-center justify-center text-gray-400"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"flex flex-col gap-4 items-center"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">fill</span>=<span class="string">"none"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 24 24"</span> <span class="attr">stroke-width</span>=<span class="string">"1.5"</span> <span class="attr">stroke</span>=<span class="string">"currentColor"</span> <span class="attr">class</span>=<span class="string">"w-12 h-12"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">path</span> <span class="attr">stroke-linecap</span>=<span class="string">"round"</span> <span class="attr">stroke-linejoin</span>=<span class="string">"round"</span> <span class="attr">d</span>=<span class="string">"M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.444 3 12c0 2.104.859 4.023 2.273 5.48.432.447.74 1.04.586 1.641a4.483 4.483 0 01-.923 1.785A5.969 5.969 0 006 21c1.282 0 2.47-.402 3.445-1.087.81.22 1.668.337 2.555.337z"</span> /&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">p</span>&gt;</span>暂无消息，开始聊天吧！<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- 若有消息，则显示消息列表 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"(message, index) in messages"</span> <span class="attr">:key</span>=<span class="string">"index"</span> <span class="attr">class</span>=<span class="string">"message-animation mb-2"</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 系统消息 --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"message.type === 'system'"</span> <span class="attr">class</span>=<span class="string">"system-message"</span>&gt;</span></span><br><span class="line">                                {{ message.content }}</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 聊天消息 --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else</span> <span class="attr">:class</span>=<span class="string">"isSelfMessage(message) ? 'chat chat-end' : 'chat chat-start'"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-header"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-title"</span>&gt;</span>{{ message.sender }}<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-image avatar"</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"w-10 rounded-full"</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">img</span> <span class="attr">alt</span>=<span class="string">"User avatar"</span> <span class="attr">:src</span>=<span class="string">"message.avatar"</span> /&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-bubble"</span> <span class="attr">:class</span>=<span class="string">"{'chat-bubble-primary': isSelfMessage(message)}"</span>&gt;</span></span><br><span class="line">                                    {{ message.content }}</span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"chat-footer opacity-50 text-xs"</span>&gt;</span>{{ message.timestamp }}<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 输入区域 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card bg-base-100 shadow-md rounded-lg"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card-body"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-control"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"flex flex-row justify-between items-center gap-2"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"请输入你要发送的内容"</span> <span class="attr">v-model</span>=<span class="string">"newMessage"</span> </span></span><br><span class="line"><span class="tag">                            <span class="attr">class</span>=<span class="string">"input input-bordered flex-grow"</span></span></span><br><span class="line"><span class="tag">                            @<span class="attr">keyup.enter</span>=<span class="string">"sendMessage"</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">:disabled</span>=<span class="string">"!isConnected"</span> /&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> @<span class="attr">click</span>=<span class="string">"sendMessage"</span> <span class="attr">:disabled</span>=<span class="string">"!isConnected || !newMessage.trim()"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">fill</span>=<span class="string">"none"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 24 24"</span> <span class="attr">stroke-width</span>=<span class="string">"1.5"</span> <span class="attr">stroke</span>=<span class="string">"currentColor"</span> <span class="attr">class</span>=<span class="string">"w-6 h-6"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">path</span> <span class="attr">stroke-linecap</span>=<span class="string">"round"</span> <span class="attr">stroke-linejoin</span>=<span class="string">"round"</span> <span class="attr">d</span>=<span class="string">"M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"</span> /&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">                            发送</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">v-if</span>=<span class="string">"!isConnected"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary mt-2"</span> @<span class="attr">click</span>=<span class="string">"connectWebSocket"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">fill</span>=<span class="string">"none"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 24 24"</span> <span class="attr">stroke-width</span>=<span class="string">"1.5"</span> <span class="attr">stroke</span>=<span class="string">"currentColor"</span> <span class="attr">class</span>=<span class="string">"w-6 h-6"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">path</span> <span class="attr">stroke-linecap</span>=<span class="string">"round"</span> <span class="attr">stroke-linejoin</span>=<span class="string">"round"</span> <span class="attr">d</span>=<span class="string">"M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">                    连接服务器</span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">v-else</span> <span class="attr">class</span>=<span class="string">"btn btn-error mt-2"</span> @<span class="attr">click</span>=<span class="string">"disconnectWebSocket"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">fill</span>=<span class="string">"none"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 24 24"</span> <span class="attr">stroke-width</span>=<span class="string">"1.5"</span> <span class="attr">stroke</span>=<span class="string">"currentColor"</span> <span class="attr">class</span>=<span class="string">"w-6 h-6"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">path</span> <span class="attr">stroke-linecap</span>=<span class="string">"round"</span> <span class="attr">stroke-linejoin</span>=<span class="string">"round"</span> <span class="attr">d</span>=<span class="string">"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">                    断开连接</span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 连接状态提示 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"connectionError"</span> <span class="attr">class</span>=<span class="string">"alert alert-error mt-4"</span>&gt;</span></span><br><span class="line">            {{ connectionError }}</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> { createApp, ref, computed, nextTick, onMounted, watch } = <span class="title class_">Vue</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">createApp</span>({</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">setup</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// =============================数据==========================</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> isConnected = <span class="title function_">ref</span>(<span class="literal">false</span>); <span class="comment">// 连接状态</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> messages = <span class="title function_">ref</span>([]); <span class="comment">// 消息列表</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> newMessage = <span class="title function_">ref</span>(<span class="string">''</span>); <span class="comment">// 新消息内容</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> currentUser = <span class="title function_">ref</span>(<span class="string">'我'</span>); <span class="comment">// 当前用户</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> messageContainer = <span class="title function_">ref</span>(<span class="literal">null</span>); <span class="comment">// 消息容器引用</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> connectionError = <span class="title function_">ref</span>(<span class="string">''</span>); <span class="comment">// 连接错误信息</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> socket = <span class="title function_">ref</span>(<span class="literal">null</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> userAvatar = <span class="title function_">ref</span>(<span class="string">'./images/1.png'</span>); <span class="comment">// 用户头像</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> avatarOptions = <span class="title function_">ref</span>([</span></span><br><span class="line"><span class="language-javascript">                <span class="string">'./images/1.png'</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="string">'./images/2.png'</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="string">'./images/3.png'</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="string">'./images/4.png'</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="string">'./images/5.png'</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="string">'./images/6.png'</span></span></span><br><span class="line"><span class="language-javascript">            ]);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> clientId = <span class="title function_">ref</span>(<span class="string">''</span>); <span class="comment">// 客户端ID</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> onlineUsers = <span class="title function_">ref</span>([]); <span class="comment">// 在线用户列表</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> heartbeatInterval = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// =============================计算属性==========================</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> connectionStatus = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> isConnected.<span class="property">value</span> ? <span class="string">'已连接'</span> : <span class="string">'未连接'</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> onlineUsersCount = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> onlineUsers.<span class="property">value</span>.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// =============================监听属性变化==========================</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 监听消息列表变化，自动滚动到底部</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">watch</span>(messages, <span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (messageContainer.<span class="property">value</span>) {</span></span><br><span class="line"><span class="language-javascript">                        messageContainer.<span class="property">value</span>.<span class="property">scrollTop</span> = messageContainer.<span class="property">value</span>.<span class="property">scrollHeight</span>;</span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript">                });</span></span><br><span class="line"><span class="language-javascript">            }, { <span class="attr">deep</span>: <span class="literal">true</span> });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// =============================方法==========================</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 判断是否是自己发送的消息</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> <span class="title function_">isSelfMessage</span> = (<span class="params">message</span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> message.<span class="property">client_id</span> === clientId.<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">            };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 更新用户信息</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> <span class="title function_">updateUserInfo</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (!isConnected.<span class="property">value</span>) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">                    socket.<span class="property">value</span>.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>({</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">type</span>: <span class="string">"user_info"</span>,</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">username</span>: currentUser.<span class="property">value</span>,</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">avatar</span>: userAvatar.<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">                    }));</span></span><br><span class="line"><span class="language-javascript">                } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'发送用户信息错误:'</span>, error);</span></span><br><span class="line"><span class="language-javascript">                }</span></span><br><span class="line"><span class="language-javascript">            };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 选择头像</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> <span class="title function_">selectAvatar</span> = (<span class="params">avatar</span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                userAvatar.<span class="property">value</span> = avatar;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">updateUserInfo</span>();</span></span><br><span class="line"><span class="language-javascript">            };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 连接WebSocket</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> <span class="title function_">connectWebSocket</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">                    socket.<span class="property">value</span> = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">'ws://localhost:8765'</span>);</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    socket.<span class="property">value</span>.<span class="property">onopen</span> = <span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                        isConnected.<span class="property">value</span> = <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">                        connectionError.<span class="property">value</span> = <span class="string">''</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">startHeartbeat</span>();</span></span><br><span class="line"><span class="language-javascript">                    };</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    socket.<span class="property">value</span>.<span class="property">onmessage</span> = handleMessage;</span></span><br><span class="line"><span class="language-javascript">                    socket.<span class="property">value</span>.<span class="property">onclose</span> = handleClose;</span></span><br><span class="line"><span class="language-javascript">                    socket.<span class="property">value</span>.<span class="property">onerror</span> = <span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                        connectionError.<span class="property">value</span> = <span class="string">'连接出错，请检查服务器是否运行'</span>;</span></span><br><span class="line"><span class="language-javascript">                    };</span></span><br><span class="line"><span class="language-javascript">                } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">                    connectionError.<span class="property">value</span> = <span class="string">'连接失败: '</span> + error.<span class="property">message</span>;</span></span><br><span class="line"><span class="language-javascript">                    isConnected.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                }</span></span><br><span class="line"><span class="language-javascript">            };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 处理心跳信息</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> <span class="title function_">startHeartbeat</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                heartbeatInterval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (socket.<span class="property">value</span>?.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) {</span></span><br><span class="line"><span class="language-javascript">                        socket.<span class="property">value</span>.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>({ <span class="attr">type</span>: <span class="string">'ping'</span> }));</span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript">                }, <span class="number">30000</span>);</span></span><br><span class="line"><span class="language-javascript">            };</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> <span class="title function_">stopHeartbeat</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (heartbeatInterval) {</span></span><br><span class="line"><span class="language-javascript">                    <span class="built_in">clearInterval</span>(heartbeatInterval);</span></span><br><span class="line"><span class="language-javascript">                    heartbeatInterval = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                }</span></span><br><span class="line"><span class="language-javascript">            };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> <span class="title function_">disconnectWebSocket</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (socket.<span class="property">value</span>?.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) {</span></span><br><span class="line"><span class="language-javascript">                    socket.<span class="property">value</span>.<span class="title function_">close</span>(<span class="number">1000</span>, <span class="string">'用户主动断开连接'</span>);</span></span><br><span class="line"><span class="language-javascript">                }</span></span><br><span class="line"><span class="language-javascript">            };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 消息处理</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> <span class="title function_">handleMessage</span> = (<span class="params">event</span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(event.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">switch</span> (data.<span class="property">type</span>) {</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">case</span> <span class="string">'welcome'</span>:</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 处理欢迎消息，保存客户端ID</span></span></span><br><span class="line"><span class="language-javascript">                            clientId.<span class="property">value</span> = data.<span class="property">client_id</span>;</span></span><br><span class="line"><span class="language-javascript">                            messages.<span class="property">value</span>.<span class="title function_">push</span>({</span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">type</span>: <span class="string">'system'</span>,</span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">content</span>: data.<span class="property">content</span></span></span><br><span class="line"><span class="language-javascript">                            });</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">                            </span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">case</span> <span class="string">'users_list'</span>:</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 更新在线用户列表</span></span></span><br><span class="line"><span class="language-javascript">                            onlineUsers.<span class="property">value</span> = data.<span class="property">users</span>;</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">                            </span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">case</span> <span class="string">'user_update'</span>:</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 更新用户信息</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">const</span> userIndex = onlineUsers.<span class="property">value</span>.<span class="title function_">findIndex</span>(<span class="function"><span class="params">u</span> =&gt;</span> u.<span class="property">client_id</span> === data.<span class="property">client_id</span>);</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">if</span> (userIndex !== -<span class="number">1</span>) {</span></span><br><span class="line"><span class="language-javascript">                                onlineUsers.<span class="property">value</span>[userIndex].<span class="property">username</span> = data.<span class="property">username</span>;</span></span><br><span class="line"><span class="language-javascript">                                onlineUsers.<span class="property">value</span>[userIndex].<span class="property">avatar</span> = data.<span class="property">avatar</span>;</span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">                            </span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">case</span> <span class="string">'chat'</span>:</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 处理聊天消息</span></span></span><br><span class="line"><span class="language-javascript">                            messages.<span class="property">value</span>.<span class="title function_">push</span>({</span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">type</span>: <span class="string">'chat'</span>,</span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">client_id</span>: data.<span class="property">client_id</span>,</span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">sender</span>: data.<span class="property">sender</span>,</span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">content</span>: data.<span class="property">content</span>,</span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">timestamp</span>: data.<span class="property">timestamp</span>,</span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">avatar</span>: data.<span class="property">avatar</span></span></span><br><span class="line"><span class="language-javascript">                            });</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">                            </span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">case</span> <span class="string">'system'</span>:</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 处理系统消息</span></span></span><br><span class="line"><span class="language-javascript">                            messages.<span class="property">value</span>.<span class="title function_">push</span>({</span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">type</span>: <span class="string">'system'</span>,</span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">content</span>: data.<span class="property">content</span></span></span><br><span class="line"><span class="language-javascript">                            });</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">                            </span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">case</span> <span class="string">'error'</span>:</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 处理错误消息</span></span></span><br><span class="line"><span class="language-javascript">                            connectionError.<span class="property">value</span> = data.<span class="property">message</span>;</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript">                } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'消息处理错误:'</span>, error);</span></span><br><span class="line"><span class="language-javascript">                }</span></span><br><span class="line"><span class="language-javascript">            };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 关闭连接</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> <span class="title function_">handleClose</span> = (<span class="params">event</span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                isConnected.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">stopHeartbeat</span>();</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (!event.<span class="property">wasClean</span>) {</span></span><br><span class="line"><span class="language-javascript">                    connectionError.<span class="property">value</span> = <span class="string">'连接意外关闭'</span>;</span></span><br><span class="line"><span class="language-javascript">                } <span class="keyword">else</span> {</span></span><br><span class="line"><span class="language-javascript">                    connectionError.<span class="property">value</span> = <span class="string">'连接已关闭'</span>;</span></span><br><span class="line"><span class="language-javascript">                }</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">                clientId.<span class="property">value</span> = <span class="string">''</span>;</span></span><br><span class="line"><span class="language-javascript">                socket.<span class="property">value</span> = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                onlineUsers.<span class="property">value</span> = [];</span></span><br><span class="line"><span class="language-javascript">            };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 发送消息</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> <span class="title function_">sendMessage</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (!isConnected.<span class="property">value</span> || !newMessage.<span class="property">value</span>.<span class="title function_">trim</span>()) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> message = {</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">type</span>: <span class="string">"chat"</span>,</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">content</span>: newMessage.<span class="property">value</span>,</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toLocaleString</span>()</span></span><br><span class="line"><span class="language-javascript">                    };</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    socket.<span class="property">value</span>.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(message));</span></span><br><span class="line"><span class="language-javascript">                    newMessage.<span class="property">value</span> = <span class="string">''</span>;</span></span><br><span class="line"><span class="language-javascript">                } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'消息发送错误:'</span>, error);</span></span><br><span class="line"><span class="language-javascript">                }</span></span><br><span class="line"><span class="language-javascript">            };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 组件挂载后自动连接WebSocket</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 自动连接可选，取消注释下行开启</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// connectWebSocket();</span></span></span><br><span class="line"><span class="language-javascript">            });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> {</span></span><br><span class="line"><span class="language-javascript">                isConnected,</span></span><br><span class="line"><span class="language-javascript">                connectionStatus,</span></span><br><span class="line"><span class="language-javascript">                messages,</span></span><br><span class="line"><span class="language-javascript">                newMessage,</span></span><br><span class="line"><span class="language-javascript">                messageContainer,</span></span><br><span class="line"><span class="language-javascript">                currentUser,</span></span><br><span class="line"><span class="language-javascript">                userAvatar,</span></span><br><span class="line"><span class="language-javascript">                avatarOptions,</span></span><br><span class="line"><span class="language-javascript">                connectionError,</span></span><br><span class="line"><span class="language-javascript">                clientId,</span></span><br><span class="line"><span class="language-javascript">                onlineUsers,</span></span><br><span class="line"><span class="language-javascript">                onlineUsersCount,</span></span><br><span class="line"><span class="language-javascript">                isSelfMessage,</span></span><br><span class="line"><span class="language-javascript">                selectAvatar,</span></span><br><span class="line"><span class="language-javascript">                updateUserInfo,</span></span><br><span class="line"><span class="language-javascript">                connectWebSocket,</span></span><br><span class="line"><span class="language-javascript">                disconnectWebSocket,</span></span><br><span class="line"><span class="language-javascript">                sendMessage,</span></span><br><span class="line"><span class="language-javascript">            };</span></span><br><span class="line"><span class="language-javascript">        },</span></span><br><span class="line"><span class="language-javascript">    }).<span class="title function_">mount</span>(<span class="string">'#app'</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> websockets.asyncio.server <span class="keyword">import</span> ServerConnection, serve</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Set</span>, <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WebSocketServer</span>:</span><br><span class="line">    <span class="string">"""WebSocket服务器类，处理客户端连接和消息通信"""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host: <span class="built_in">str</span> = <span class="string">"localhost"</span>, port: <span class="built_in">int</span> = <span class="number">8765</span></span>):</span><br><span class="line">        <span class="string">"""初始化WebSocket服务器</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            host: 服务器主机名或IP地址</span></span><br><span class="line"><span class="string">            port: 服务器端口号</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="variable language_">self</span>.host = host</span><br><span class="line">        <span class="variable language_">self</span>.port = port</span><br><span class="line">        <span class="variable language_">self</span>.clients: <span class="type">Dict</span>[<span class="built_in">str</span>, ServerConnection] = {}  <span class="comment"># 使用字典存储客户端连接，键为客户端ID</span></span><br><span class="line">        <span class="variable language_">self</span>.client_info: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]] = {}  <span class="comment"># 存储客户端信息，如用户名和头像</span></span><br><span class="line">        <span class="variable language_">self</span>.logger = logging.getLogger(<span class="string">'websocket_server'</span>)</span><br><span class="line">        <span class="comment"># 定义消息处理器映射</span></span><br><span class="line">        <span class="variable language_">self</span>.message_handlers = {</span><br><span class="line">            <span class="string">'chat'</span>: <span class="variable language_">self</span>._handle_chat_message,</span><br><span class="line">            <span class="string">'ping'</span>: <span class="variable language_">self</span>._handle_ping_message,</span><br><span class="line">            <span class="string">'user_info'</span>: <span class="variable language_">self</span>._handle_user_info</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_message</span>(<span class="params">self, client_id: <span class="built_in">str</span>, message: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""处理从客户端接收到的消息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            client_id: 客户端ID</span></span><br><span class="line"><span class="string">            message: 收到的消息内容</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = json.loads(message)</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._process_message(client_id, data)</span><br><span class="line">        <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._send_error(client_id, <span class="string">"消息格式不是有效的JSON"</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.logger.error(<span class="string">f"处理消息时出错: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._send_error(client_id, <span class="string">f"服务器处理消息时出错: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_process_message</span>(<span class="params">self, client_id: <span class="built_in">str</span>, data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""处理解析后的消息数据"""</span></span><br><span class="line">        <span class="comment"># 验证消息格式</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'type'</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._send_error(client_id, <span class="string">"消息格式错误，缺少type字段"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取并执行对应的处理器</span></span><br><span class="line">        message_type = data[<span class="string">'type'</span>]</span><br><span class="line">        handler = <span class="variable language_">self</span>.message_handlers.get(message_type)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> handler:</span><br><span class="line">            <span class="keyword">await</span> handler(client_id, data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._send_error(client_id, <span class="string">f"不支持的消息类型: <span class="subst">{message_type}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_user_info</span>(<span class="params">self, client_id: <span class="built_in">str</span>, data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""处理用户信息更新"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'username'</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">'avatar'</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._send_error(client_id, <span class="string">"用户信息不完整，需要username和avatar字段"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 更新用户信息</span></span><br><span class="line">        <span class="variable language_">self</span>.client_info[client_id][<span class="string">'username'</span>] = data[<span class="string">'username'</span>]</span><br><span class="line">        <span class="variable language_">self</span>.client_info[client_id][<span class="string">'avatar'</span>] = data[<span class="string">'avatar'</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 通知所有客户端有用户信息更新</span></span><br><span class="line">        user_info_message = json.dumps({</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"user_update"</span>,</span><br><span class="line">            <span class="string">"client_id"</span>: client_id,</span><br><span class="line">            <span class="string">"username"</span>: data[<span class="string">'username'</span>],</span><br><span class="line">            <span class="string">"avatar"</span>: data[<span class="string">'avatar'</span>]</span><br><span class="line">        })</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>._broadcast_message(user_info_message)</span><br><span class="line">        <span class="variable language_">self</span>.logger.info(<span class="string">f"用户信息更新: <span class="subst">{data[<span class="string">'username'</span>]}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_chat_message</span>(<span class="params">self, client_id: <span class="built_in">str</span>, data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""处理聊天消息"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'content'</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._send_error(client_id, <span class="string">"消息缺少content字段"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        username = <span class="variable language_">self</span>.client_info.get(client_id, {}).get(<span class="string">'username'</span>, <span class="string">'匿名用户'</span>)</span><br><span class="line">        avatar = <span class="variable language_">self</span>.client_info.get(client_id, {}).get(<span class="string">'avatar'</span>, <span class="string">'./images/1.png'</span>)</span><br><span class="line">        timestamp = data.get(<span class="string">'timestamp'</span>, datetime.now().strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>))</span><br><span class="line"></span><br><span class="line">        broadcast_message = json.dumps({</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"chat"</span>,</span><br><span class="line">            <span class="string">"client_id"</span>: client_id,  <span class="comment"># 添加发送者ID</span></span><br><span class="line">            <span class="string">"sender"</span>: username,</span><br><span class="line">            <span class="string">"content"</span>: data[<span class="string">'content'</span>],</span><br><span class="line">            <span class="string">"timestamp"</span>: timestamp,</span><br><span class="line">            <span class="string">"avatar"</span>: avatar</span><br><span class="line">        })</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>._broadcast_message(broadcast_message)</span><br><span class="line">        <span class="variable language_">self</span>.logger.info(<span class="string">f"广播消息: <span class="subst">{data[<span class="string">'content'</span>]}</span> (来自: <span class="subst">{username}</span>)"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_ping_message</span>(<span class="params">self, client_id: <span class="built_in">str</span>, data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""处理ping消息"""</span></span><br><span class="line">        <span class="keyword">if</span> client_id <span class="keyword">in</span> <span class="variable language_">self</span>.clients:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>.clients[client_id].send(json.dumps({<span class="string">"type"</span>: <span class="string">"pong"</span>}))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_send_error</span>(<span class="params">self, client_id: <span class="built_in">str</span>, message: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""发送错误消息到客户端"""</span></span><br><span class="line">        <span class="keyword">if</span> client_id <span class="keyword">in</span> <span class="variable language_">self</span>.clients:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>.clients[client_id].send(json.dumps({</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"error"</span>,</span><br><span class="line">                <span class="string">"message"</span>: message</span><br><span class="line">            }))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_send_to_client</span>(<span class="params">self, client_id: <span class="built_in">str</span>, message: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""发送消息到特定客户端"""</span></span><br><span class="line">        <span class="keyword">if</span> client_id <span class="keyword">in</span> <span class="variable language_">self</span>.clients:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>.clients[client_id].send(message)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_broadcast_message</span>(<span class="params">self, message: <span class="built_in">str</span>, exclude_client: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""广播消息给所有客户端</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            message: 要广播的消息</span></span><br><span class="line"><span class="string">            exclude_client: 要排除的客户端ID（可选）</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        tasks = []</span><br><span class="line">        <span class="keyword">for</span> cid, conn <span class="keyword">in</span> <span class="variable language_">self</span>.clients.items():</span><br><span class="line">            <span class="keyword">if</span> exclude_client <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> cid != exclude_client:</span><br><span class="line">                tasks.append(conn.send(message))</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> tasks:</span><br><span class="line">            <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">connection_handler</span>(<span class="params">self, websocket: ServerConnection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""处理WebSocket连接的主函数</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            websocket: 客户端WebSocket连接</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 生成客户端ID</span></span><br><span class="line">        client_id = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加新的客户端连接</span></span><br><span class="line">        <span class="variable language_">self</span>.clients[client_id] = websocket</span><br><span class="line">        <span class="variable language_">self</span>.client_info[client_id] = {</span><br><span class="line">            <span class="string">"username"</span>: <span class="string">f"用户<span class="subst">{<span class="built_in">len</span>(self.clients)}</span>"</span>,</span><br><span class="line">            <span class="string">"avatar"</span>: <span class="string">"./images/1.png"</span></span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        client_info = <span class="string">f"<span class="subst">{websocket.remote_address[<span class="number">0</span>]}</span>:<span class="subst">{websocket.remote_address[<span class="number">1</span>]}</span>"</span></span><br><span class="line">        <span class="variable language_">self</span>.logger.info(<span class="string">f"客户端连接: <span class="subst">{client_info}</span> (ID: <span class="subst">{client_id}</span>)"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._handle_new_connection(client_id)</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._process_client_messages(client_id, websocket)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.logger.error(<span class="string">f"连接处理出错: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._handle_disconnection(client_id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_new_connection</span>(<span class="params">self, client_id: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""处理新客户端连接"""</span></span><br><span class="line">        <span class="comment"># 发送客户端ID和欢迎消息</span></span><br><span class="line">        welcome_message = json.dumps({</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"welcome"</span>,</span><br><span class="line">            <span class="string">"client_id"</span>: client_id,</span><br><span class="line">            <span class="string">"content"</span>: <span class="string">"已连接到WebSocket服务器"</span>,</span><br><span class="line">            <span class="string">"user_count"</span>: <span class="built_in">len</span>(<span class="variable language_">self</span>.clients)</span><br><span class="line">        })</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>._send_to_client(client_id, welcome_message)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 发送当前在线用户列表</span></span><br><span class="line">        users_list = []</span><br><span class="line">        <span class="keyword">for</span> cid, info <span class="keyword">in</span> <span class="variable language_">self</span>.client_info.items():</span><br><span class="line">            users_list.append({</span><br><span class="line">                <span class="string">"client_id"</span>: cid,</span><br><span class="line">                <span class="string">"username"</span>: info.get(<span class="string">"username"</span>, <span class="string">"匿名用户"</span>),</span><br><span class="line">                <span class="string">"avatar"</span>: info.get(<span class="string">"avatar"</span>, <span class="string">"./images/1.png"</span>)</span><br><span class="line">            })</span><br><span class="line">            </span><br><span class="line">        users_message = json.dumps({</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"users_list"</span>,</span><br><span class="line">            <span class="string">"users"</span>: users_list</span><br><span class="line">        })</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>._send_to_client(client_id, users_message)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 通知所有客户端有新用户加入</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.clients) &gt; <span class="number">1</span>:  <span class="comment"># 只有当有多个客户端时才广播</span></span><br><span class="line">            username = <span class="variable language_">self</span>.client_info[client_id].get(<span class="string">"username"</span>, <span class="string">"匿名用户"</span>)</span><br><span class="line">            connect_message = json.dumps({</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"system"</span>,</span><br><span class="line">                <span class="string">"content"</span>: <span class="string">f"用户 <span class="subst">{username}</span> 加入聊天，当前共有 <span class="subst">{<span class="built_in">len</span>(self.clients)}</span> 名用户"</span></span><br><span class="line">            })</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._broadcast_message(connect_message, exclude_client=client_id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_process_client_messages</span>(<span class="params">self, client_id: <span class="built_in">str</span>, websocket: ServerConnection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""处理客户端消息流"""</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">for</span> message <span class="keyword">in</span> websocket:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>.handle_message(client_id, message)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_disconnection</span>(<span class="params">self, client_id: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""处理客户端断开连接"""</span></span><br><span class="line">        <span class="comment"># 获取用户名以便在通知中使用</span></span><br><span class="line">        username = <span class="variable language_">self</span>.client_info.get(client_id, {}).get(<span class="string">"username"</span>, <span class="string">"匿名用户"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 从集合中移除断开的客户端</span></span><br><span class="line">        <span class="keyword">if</span> client_id <span class="keyword">in</span> <span class="variable language_">self</span>.clients:</span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>.clients[client_id]</span><br><span class="line">        <span class="keyword">if</span> client_id <span class="keyword">in</span> <span class="variable language_">self</span>.client_info:</span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>.client_info[client_id]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 通知其他客户端有用户离开</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.clients:  <span class="comment"># 只有当还有其他客户端时才广播</span></span><br><span class="line">            disconnect_message = json.dumps({</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"system"</span>,</span><br><span class="line">                <span class="string">"content"</span>: <span class="string">f"用户 <span class="subst">{username}</span> 离开聊天，当前共有 <span class="subst">{<span class="built_in">len</span>(self.clients)}</span> 名用户"</span></span><br><span class="line">            })</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._broadcast_message(disconnect_message)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""启动WebSocket服务器"""</span></span><br><span class="line">        <span class="variable language_">self</span>.logger.info(<span class="string">f"启动WebSocket服务器 - ws://<span class="subst">{self.host}</span>:<span class="subst">{self.port}</span>"</span>)</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> serve(<span class="variable language_">self</span>.connection_handler, <span class="variable language_">self</span>.host, <span class="variable language_">self</span>.port):</span><br><span class="line">            <span class="keyword">await</span> asyncio.Future()  <span class="comment"># 无限期运行服务器</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""运行WebSocket服务器(阻塞调用)"""</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            asyncio.run(<span class="variable language_">self</span>.start())</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            <span class="variable language_">self</span>.logger.info(<span class="string">"服务器已通过键盘中断信号停止"</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.logger.error(<span class="string">f"服务器出错: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 创建并运行WebSocket服务器实例</span></span><br><span class="line">    server = WebSocketServer(host=<span class="string">"localhost"</span>, port=<span class="number">8765</span>)</span><br><span class="line">    server.run()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="15-3-4-MQTT-协议"><a href="#15-3-4-MQTT-协议" class="headerlink" title="15.3.4 MQTT 协议"></a>15.3.4 MQTT 协议</h4><p>MQTT (Message Queuing Telemetry Transport) 是一种基于 <strong>发布/订阅 (Publish/Subscribe)</strong> 模式的轻量级消息传输协议。它专门为 <strong>低带宽、高延迟或不可靠的网络</strong> 环境下的 <strong>资源受限设备</strong> (如传感器、嵌入式设备) 设计。最初由 IBM 开发，现已成为 OASIS 国际标准。</p><p><strong>为什么选择 MQTT?</strong></p><ul><li><strong>轻量高效:</strong> 协议开销极小 (最小报文仅 2 字节)，显著降低网络带宽消耗，适合物联网 (IoT) 场景中电池供电或蜂窝网络连接的设备。</li><li><strong>低功耗:</strong> 协议设计有助于减少客户端设备的能耗。</li><li><strong>可靠传输:</strong> 提供三种 <strong>服务质量 (QoS)</strong> 等级，确保在不稳定网络下的消息传输可靠性。</li><li><strong>发布/订阅模式:</strong> 发送者 (Publisher) 和接收者 (Subscriber) 通过中心 <strong>代理 (Broker)</strong> 解耦，无需知道对方的存在，甚至可以不同时在线 (取决于 QoS 和会话设置)。</li><li><strong>易于扩展:</strong> 设计上支持大量客户端并发连接。</li></ul><p><strong>与常见协议对比:</strong></p><ul><li><strong>HTTP:</strong> 对于请求/响应模式更简单，但头部开销大，每次通信通常需要建立新连接 (尤其对于频繁的小数据包)，且服务器主动推送数据给客户端（长轮询、SSE）相对复杂或效率不高。 <strong>选择 MQTT 的场景:</strong> 频繁、小数据量的传输；低功耗/低带宽环境；需要服务端主动推送消息。</li><li><strong>CoAP (受限应用协议):</strong> 同样面向资源受限设备，基于 UDP。常被视为 MQTT 在 IoT 领域的竞争者或补充，更偏向 RESTful 风格。</li><li><strong>WebSockets:</strong> 提供基于单个 TCP 连接的全双工通信。适合需要实时交互的 Web 应用，但协议本身可能比 MQTT 更重。</li></ul><h5 id="MQTT-应用场景"><a href="#MQTT-应用场景" class="headerlink" title="MQTT 应用场景"></a>MQTT 应用场景</h5><h6 id="1-物联网-IoT-核心领域"><a href="#1-物联网-IoT-核心领域" class="headerlink" title="1.物联网 (IoT) - 核心领域"></a>1.物联网 (IoT) - 核心领域</h6><ul><li><strong>传感器数据采集:</strong><ul><li><strong>环境监测:</strong> 智能楼宇、智慧城市中的温度、湿度、空气质量 (PM2.5)、光照强度等传感器数据上传。</li><li><strong>农业物联网:</strong> 土壤湿度、温度、作物生长环境监测。</li><li><strong>可穿戴设备:</strong> 智能手环、手表收集用户的步数、心率、睡眠数据并上传到云端。</li></ul></li><li><strong>远程控制与状态同步:</strong><ul><li><strong>智能家居:</strong> 控制智能灯泡开关/亮度/颜色、智能插座、空调、窗帘等；获取门锁状态、家电运行状态。<code>保留消息</code> 在此场景中非常有用，用于获取设备当前状态。</li><li><strong>共享单车/充电宝:</strong> 实时上报位置信息、电量状态、开关锁状态。</li></ul></li></ul><h6 id="2-工业物联网-IIoT-与-SCADA"><a href="#2-工业物联网-IIoT-与-SCADA" class="headerlink" title="2.工业物联网 (IIoT) 与 SCADA"></a>2.工业物联网 (IIoT) 与 SCADA</h6><ul><li><strong>设备远程监控与预警:</strong><ul><li>工厂生产线设备 (如 PLC、机器人) 运行状态、能耗数据、故障代码的实时上传与监控。</li><li>石油、天然气管道压力、流量、温度等参数监测。</li><li>电力系统 (智能电表) 数据采集与远程控制。</li></ul></li><li><strong>预测性维护:</strong> 收集设备振动、温度等数据，利用大数据分析预测潜在故障，提前进行维护。</li><li><strong>SCADA 系统集成:</strong> MQTT 作为一种轻量级协议，越来越多地被用于连接传统的 SCADA 系统和现代的云平台或移动应用。</li></ul><h6 id="3-车联网-IoV-与远程信息处理-Telematics"><a href="#3-车联网-IoV-与远程信息处理-Telematics" class="headerlink" title="3.车联网 (IoV) 与远程信息处理 (Telematics)"></a>3.车联网 (IoV) 与远程信息处理 (Telematics)</h6><ul><li><strong>车辆状态监控:</strong> 实时上传车辆 GPS 位置、速度、油耗、发动机转速、电池电压、故障码 (OBD 数据) 等。</li><li><strong>远程控制:</strong> 远程锁车/解锁、启动空调、鸣笛闪灯等。</li><li><strong>驾驶行为分析:</strong> 收集急加速、急刹车、急转弯等数据用于保险 UBI (Usage-Based Insurance) 或车队管理。</li><li><strong>信息推送:</strong> 推送路况信息、导航更新、软件更新通知 (OTA 更新通常结合 HTTP/HTTPS 处理大文件下载，MQTT 用于触发和状态同步)。</li></ul><p><strong>为什么这些场景适合 MQTT?</strong></p><ul><li><strong>大量连接:</strong> IoT、车联网通常涉及海量设备连接。</li><li><strong>低带宽/不稳定网络:</strong> 很多设备通过蜂窝网络 (2G/3G/4G/NB-IoT) 或 Wi-Fi 连接，网络条件可能不佳。</li><li><strong>资源受限:</strong> 许多设备是电池供电的嵌入式系统。</li><li><strong>实时性要求:</strong> 需要及时获取设备状态或数据。</li><li><strong>数据驱动:</strong> 主要是设备向云端上报数据，或云端向设备下发指令。</li></ul><h5 id="MQTT-协议特性"><a href="#MQTT-协议特性" class="headerlink" title="MQTT 协议特性"></a>MQTT 协议特性</h5><table><thead><tr><th>特性</th><th>描述</th><th>优势</th></tr></thead><tbody><tr><td>QoS 级别</td><td>提供三种服务质量级别(0,1,2)</td><td>可根据需要平衡可靠性与资源消耗</td></tr><tr><td>保留消息</td><td>服务器保存最后一条消息给新订阅者</td><td>确保新连接设备能获得最新状态</td></tr><tr><td>持久会话</td><td>客户端断开后可恢复订阅</td><td>提高系统稳定性和容错性</td></tr><tr><td>遗嘱消息</td><td>客户端异常断开时发布的特定消息</td><td>便于检测设备异常离线</td></tr><tr><td>小型客户端</td><td>代码占用空间小</td><td>适合嵌入式设备和 IoT 应用</td></tr></tbody></table><h5 id="推荐的-MQTT-第三方库"><a href="#推荐的-MQTT-第三方库" class="headerlink" title="推荐的 MQTT 第三方库"></a>推荐的 MQTT 第三方库</h5><table><thead><tr><th>库名</th><th>特性</th><th>适用场景</th><th>安装命令</th></tr></thead><tbody><tr><td><code>paho-mqtt</code></td><td>完整 MQTT 客户端实现</td><td>通用 MQTT 应用</td><td><code>pip install paho-mqtt</code></td></tr><tr><td><code>gmqtt</code></td><td>异步 MQTT 客户端</td><td>基于 asyncio 的应用</td><td><code>pip install gmqtt</code></td></tr><tr><td><code>hbmqtt</code></td><td>纯 Python 实现的 MQTT 客户端/服务器</td><td>需要轻量级 MQTT 服务器</td><td><code>pip install hbmqtt</code></td></tr><tr><td><code>amqtt</code></td><td>异步 MQTT 服务器和客户端</td><td>需要高性能 MQTT 服务器</td><td><code>pip install amqtt</code></td></tr></tbody></table><h5 id="paho-mqtt-示例"><a href="#paho-mqtt-示例" class="headerlink" title="paho-mqtt 示例"></a>paho-mqtt 示例</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># 建议添加编码声明</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> paho.mqtt.client <span class="keyword">as</span> mqtt</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> uuid <span class="comment"># 用于生成更唯一的 Client ID</span></span><br><span class="line"><span class="keyword">import</span> logging <span class="comment"># 用于替代 print 输出日志</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志记录器</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">'%(asctime)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MQTTClient</span>:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    使用 paho-mqtt 的 MQTT 客户端封装示例 (带注释和改进建议)</span></span><br><span class="line"><span class="string">    官方文档: [https://eclipse.dev/paho/files/paho.mqtt.python/html/index.html](https://eclipse.dev/paho/files/paho.mqtt.python/html/index.html)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, broker=<span class="string">"broker.emqx.io"</span>, port=<span class="number">1883</span>, client_id=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 use_tls=<span class="literal">False</span>, username=<span class="literal">None</span>, password=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 ca_certs=<span class="literal">None</span>, certfile=<span class="literal">None</span>, keyfile=<span class="literal">None</span>, <span class="comment"># 添加 TLS 证书参数</span></span></span><br><span class="line"><span class="params">                 clean_session=<span class="literal">True</span>, <span class="comment"># 明确控制会话类型</span></span></span><br><span class="line"><span class="params">                 userdata=<span class="literal">None</span></span>): <span class="comment"># 允许传入用户数据</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        初始化MQTT客户端</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            broker (str): MQTT Broker 地址.</span></span><br><span class="line"><span class="string">            port (int): MQTT Broker 端口 (常见: 1883 for TCP, 8883 for TLS, 8083/8084 for WebSocket).</span></span><br><span class="line"><span class="string">            client_id (str, optional): 客户端 ID. 如果为 None 或空字符串，Broker 会自动生成 (但不利于持久会话).</span></span><br><span class="line"><span class="string">                                       对于持久会话 (clean_session=False)，必须提供一个固定且唯一的 ID.</span></span><br><span class="line"><span class="string">                                       建议使用设备序列号或其他唯一标识符. 默认自动生成一个.</span></span><br><span class="line"><span class="string">            use_tls (bool, optional): 是否启用 TLS 加密连接. 默认为 False.</span></span><br><span class="line"><span class="string">            username (str, optional): 连接 Broker 所需的用户名. 默认为 None.</span></span><br><span class="line"><span class="string">            password (str, optional): 连接 Broker 所需的密码. 默认为 None.</span></span><br><span class="line"><span class="string">            ca_certs (str, optional): CA 证书文件路径 (用于验证 Broker 证书). 默认为 None.</span></span><br><span class="line"><span class="string">            certfile (str, optional): 客户端证书文件路径 (用于双向认证). 默认为 None.</span></span><br><span class="line"><span class="string">            keyfile (str, optional): 客户端私钥文件路径 (用于双向认证). 默认为 None.</span></span><br><span class="line"><span class="string">            clean_session (bool, optional): 控制会话类型 (MQTT v3.1.1).</span></span><br><span class="line"><span class="string">                                           True: 清洁会话。断开连接时，Broker 清除所有会话信息 (订阅、离线消息)。</span></span><br><span class="line"><span class="string">                                           False: 持久会话。断开连接时，Broker 保留订阅和 QoS 1/2 离线消息。需要固定 client_id.</span></span><br><span class="line"><span class="string">                                           默认为 True.</span></span><br><span class="line"><span class="string">            userdata: 传递给回调函数的用户自定义数据.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 客户端 ID 处理</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> client_id:</span><br><span class="line">            <span class="comment"># 如果未提供 client_id，生成一个基于 UUID 的，更不容易冲突</span></span><br><span class="line">            <span class="variable language_">self</span>.client_id = <span class="string">f"python-mqtt-<span class="subst">{uuid.uuid4()}</span>"</span></span><br><span class="line">            logging.warning(<span class="string">f"未提供 client_id，自动生成: <span class="subst">{self.client_id}</span>。注意：这不利于使用持久会话。"</span>)</span><br><span class="line">            <span class="comment"># 对于 MQTT v3.1.1, Broker 自动生成的 ID 隐含 clean_session=True</span></span><br><span class="line">            clean_session = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.client_id = client_id</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.broker = broker</span><br><span class="line">        <span class="variable language_">self</span>.port = port</span><br><span class="line">        <span class="variable language_">self</span>.connected = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>._subscribed_topics = <span class="built_in">set</span>() <span class="comment"># 用于跟踪已订阅的主题</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建客户端实例</span></span><br><span class="line">        <span class="comment"># protocol=mqtt.MQTTv311 是默认值，也可选 MQTTv5</span></span><br><span class="line">        <span class="variable language_">self</span>.client = mqtt.Client(client_id=<span class="variable language_">self</span>.client_id, clean_session=clean_session, userdata=userdata, protocol=mqtt.MQTTv311)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 设置认证信息</span></span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 检查 password 是否也提供了</span></span><br><span class="line">            <span class="keyword">if</span> password <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                logging.warning(<span class="string">"提供了用户名但未提供密码"</span>)</span><br><span class="line">            <span class="variable language_">self</span>.client.username_pw_set(username, password)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 配置 TLS</span></span><br><span class="line">        <span class="keyword">if</span> use_tls:</span><br><span class="line">            <span class="comment"># 端口通常需要改为 8883 或 Broker 指定的 TLS 端口</span></span><br><span class="line">            <span class="keyword">if</span> port == <span class="number">1883</span>:</span><br><span class="line">                logging.warning(<span class="string">f"启用 TLS 但端口仍为 <span class="subst">{port}</span> (通常非 TLS 端口)，请确认 Broker 配置。常用 TLS 端口为 8883。"</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 更精细的 TLS 配置</span></span><br><span class="line">                <span class="comment"># cert_reqs=ssl.CERT_REQUIRED: 强制验证服务器证书</span></span><br><span class="line">                <span class="comment"># tls_version=ssl.PROTOCOL_TLSv1_2: 建议指定安全的 TLS 版本</span></span><br><span class="line">                <span class="variable language_">self</span>.client.tls_set(ca_certs=ca_certs,</span><br><span class="line">                                     certfile=certfile,</span><br><span class="line">                                     keyfile=keyfile,</span><br><span class="line">                                     cert_reqs=ssl.CERT_REQUIRED <span class="keyword">if</span> ca_certs <span class="keyword">else</span> ssl.CERT_NONE, <span class="comment"># 如果提供了 CA 证书，则需要验证</span></span><br><span class="line">                                     tls_version=ssl.PROTOCOL_TLSv1_2) <span class="comment"># 推荐使用 TLS 1.2 或更高</span></span><br><span class="line">                <span class="comment"># 如果需要忽略主机名验证 (不推荐，有安全风险)</span></span><br><span class="line">                <span class="comment"># self.client.tls_insecure_set(True)</span></span><br><span class="line">            <span class="keyword">except</span> FileNotFoundError <span class="keyword">as</span> e:</span><br><span class="line">                logging.error(<span class="string">f"TLS 证书文件未找到: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                <span class="keyword">raise</span> <span class="comment"># 重新抛出异常，阻止后续连接尝试</span></span><br><span class="line">            <span class="keyword">except</span> ssl.SSLError <span class="keyword">as</span> e:</span><br><span class="line">                logging.error(<span class="string">f"TLS 配置错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 注册回调函数</span></span><br><span class="line">        <span class="variable language_">self</span>.client.on_connect = <span class="variable language_">self</span>._on_connect</span><br><span class="line">        <span class="variable language_">self</span>.client.on_disconnect = <span class="variable language_">self</span>._on_disconnect</span><br><span class="line">        <span class="variable language_">self</span>.client.on_message = <span class="variable language_">self</span>._on_message</span><br><span class="line">        <span class="variable language_">self</span>.client.on_publish = <span class="variable language_">self</span>._on_publish</span><br><span class="line">        <span class="variable language_">self</span>.client.on_subscribe = <span class="variable language_">self</span>._on_subscribe</span><br><span class="line">        <span class="variable language_">self</span>.client.on_unsubscribe = <span class="variable language_">self</span>._on_unsubscribe <span class="comment"># 增加取消订阅回调</span></span><br><span class="line">        <span class="variable language_">self</span>.client.on_log = <span class="variable language_">self</span>._on_log <span class="comment"># 增加日志回调，用于调试</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_log</span>(<span class="params">self, client, userdata, level, buf</span>):</span><br><span class="line">        <span class="string">"""日志回调，方便调试 paho 内部信息"""</span></span><br><span class="line">        <span class="comment"># 可以根据 level 过滤日志级别</span></span><br><span class="line">        <span class="comment"># MQTT_LOG_INFO, MQTT_LOG_NOTICE, MQTT_LOG_WARNING, MQTT_LOG_ERR, MQTT_LOG_DEBUG</span></span><br><span class="line">        <span class="keyword">if</span> level &gt;= mqtt.MQTT_LOG_WARNING: <span class="comment"># 只记录警告及以上级别</span></span><br><span class="line">             logging.log(logging.INFO <span class="keyword">if</span> level == mqtt.MQTT_LOG_INFO <span class="keyword">else</span></span><br><span class="line">                        logging.WARNING <span class="keyword">if</span> level == mqtt.MQTT_LOG_WARNING <span class="keyword">else</span></span><br><span class="line">                        logging.ERROR <span class="keyword">if</span> level == mqtt.MQTT_LOG_ERR <span class="keyword">else</span></span><br><span class="line">                        logging.DEBUG, <span class="string">f"[PAHO-LOG] <span class="subst">{buf}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_connect</span>(<span class="params">self, client, userdata, flags, rc</span>):</span><br><span class="line">        <span class="string">"""连接回调"""</span></span><br><span class="line">        <span class="comment"># rc (Return Code) 连接结果代码</span></span><br><span class="line">        connect_rc_codes = {</span><br><span class="line">            <span class="number">0</span>: <span class="string">"连接成功"</span>,</span><br><span class="line">            <span class="number">1</span>: <span class="string">"连接被拒绝 - 不可接受的协议版本"</span>,</span><br><span class="line">            <span class="number">2</span>: <span class="string">"连接被拒绝 - 标识符被拒绝 (例如 client_id 无效或已被使用)"</span>,</span><br><span class="line">            <span class="number">3</span>: <span class="string">"连接被拒绝 - 服务器不可用"</span>,</span><br><span class="line">            <span class="number">4</span>: <span class="string">"连接被拒绝 - 错误的用户名或密码"</span>,</span><br><span class="line">            <span class="number">5</span>: <span class="string">"连接被拒绝 - 未授权"</span>,</span><br><span class="line">            <span class="comment"># 6-255: Undefined</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> rc == <span class="number">0</span>:</span><br><span class="line">            <span class="variable language_">self</span>.connected = <span class="literal">True</span></span><br><span class="line">            logging.info(<span class="string">f"成功连接到 Broker <span class="subst">{self.broker}</span>:<span class="subst">{self.port}</span>"</span>)</span><br><span class="line">            <span class="comment"># 💡 最佳实践: 在连接成功后重新订阅之前的主题 (特别是对于非持久会话 clean_session=True)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>._subscribed_topics:</span><br><span class="line">                logging.info(<span class="string">"重新订阅之前的主题..."</span>)</span><br><span class="line">                <span class="keyword">for</span> topic, qos <span class="keyword">in</span> <span class="variable language_">self</span>._subscribed_topics:</span><br><span class="line">                    <span class="variable language_">self</span>.subscribe(topic, qos) <span class="comment"># 调用封装的 subscribe 方法</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.connected = <span class="literal">False</span></span><br><span class="line">            logging.error(<span class="string">f"连接 Broker 失败, 返回码: <span class="subst">{rc}</span> - <span class="subst">{connect_rc_codes.get(rc, <span class="string">'未知错误'</span>)}</span>"</span>)</span><br><span class="line">            <span class="comment"># 可以在这里添加重连逻辑</span></span><br><span class="line">            <span class="comment"># raise ConnectionError(f"MQTT Connection failed with code {rc}") # 也可以抛出异常</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_disconnect</span>(<span class="params">self, client, userdata, rc</span>):</span><br><span class="line">        <span class="string">"""断开连接回调"""</span></span><br><span class="line">        <span class="variable language_">self</span>.connected = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> rc == <span class="number">0</span>:</span><br><span class="line">            logging.info(<span class="string">"已主动断开与 Broker 的连接"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># rc 非 0 表示意外断开</span></span><br><span class="line">            logging.warning(<span class="string">f"与 Broker 的连接意外断开, 返回码: <span class="subst">{rc}</span>. 可能需要重连。"</span>)</span><br><span class="line">            <span class="comment"># 💡 实践: 在这里实现自动重连逻辑 (带退避策略)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_message</span>(<span class="params">self, client, userdata, msg</span>):</span><br><span class="line">        <span class="string">"""消息接收回调"""</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            topic = msg.topic</span><br><span class="line">            <span class="comment"># 尝试使用 UTF-8 解码，这是最常见的文本编码</span></span><br><span class="line">            payload_str = msg.payload.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">            qos = msg.qos</span><br><span class="line">            retain = msg.retain</span><br><span class="line"></span><br><span class="line">            logging.info(<span class="string">f"收到消息: 主题='<span class="subst">{topic}</span>', QoS=<span class="subst">{qos}</span>, Retain=<span class="subst">{retain}</span>"</span>)</span><br><span class="line">            logging.debug(<span class="string">f"原始载荷 (bytes): <span class="subst">{msg.payload}</span>"</span>) <span class="comment"># 记录原始字节</span></span><br><span class="line">            logging.info(<span class="string">f"消息内容 (str): <span class="subst">{payload_str}</span>"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 尝试解析 JSON (如果你的应用主要使用 JSON)</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data = json.loads(payload_str)</span><br><span class="line">                logging.info(<span class="string">f"解析后 JSON 内容: <span class="subst">{data}</span>"</span>)</span><br><span class="line">                <span class="comment"># 在这里处理你的业务逻辑，例如:</span></span><br><span class="line">                <span class="comment"># self.process_sensor_data(data)</span></span><br><span class="line">            <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">                <span class="comment"># 如果载荷不是有效的 JSON，按普通字符串处理或根据业务逻辑处理</span></span><br><span class="line">                logging.debug(<span class="string">"消息载荷不是有效的 JSON 格式"</span>)</span><br><span class="line">                <span class="comment"># self.process_plain_text(payload_str)</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logging.error(<span class="string">f"处理消息时发生错误: <span class="subst">{e}</span>"</span>, exc_info=<span class="literal">True</span>) <span class="comment"># 记录详细错误堆栈</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            <span class="comment"># 如果载荷不是 UTF-8 编码 (例如二进制数据)</span></span><br><span class="line">            logging.warning(<span class="string">f"收到无法以 UTF-8 解码的消息: 主题='<span class="subst">{topic}</span>', QoS=<span class="subst">{qos}</span>, Retain=<span class="subst">{retain}</span>"</span>)</span><br><span class="line">            logging.info(<span class="string">f"消息载荷 (bytes): <span class="subst">{msg.payload}</span>"</span>)</span><br><span class="line">            <span class="comment"># 在这里处理二进制数据或其他编码的数据</span></span><br><span class="line">            <span class="comment"># self.process_binary_data(msg.payload)</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f"处理 `on_message` 回调时发生严重错误: <span class="subst">{e}</span>"</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_publish</span>(<span class="params">self, client, userdata, mid</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        消息发布回调 (QoS 1 和 2 会触发)</span></span><br><span class="line"><span class="string">        mid (Message ID): 与 publish() 方法返回的 mid 对应。</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        logging.debug(<span class="string">f"消息 (MID: <span class="subst">{mid}</span>) 已发布成功"</span>)</span><br><span class="line">        <span class="comment"># 注意: 这只表示消息已成功发送给 Broker，不代表订阅者已收到 (尤其是 QoS 0)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_subscribe</span>(<span class="params">self, client, userdata, mid, granted_qos</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        订阅回调</span></span><br><span class="line"><span class="string">        mid: 消息 ID, 与 subscribe() 返回的 mid 对应.</span></span><br><span class="line"><span class="string">        granted_qos: Broker 实际授予的 QoS 等级列表 (可能低于请求的 QoS).</span></span><br><span class="line"><span class="string">                     例如，请求 (("topic1", 1), ("topic2", 2)), 返回可能是 (1, 1)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        logging.info(<span class="string">f"订阅成功 (MID: <span class="subst">{mid}</span>), Broker 授予的 QoS: <span class="subst">{granted_qos}</span>"</span>)</span><br><span class="line">        <span class="comment"># 注意: granted_qos 是一个元组，即使只订阅一个主题</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_unsubscribe</span>(<span class="params">self, client, userdata, mid</span>):</span><br><span class="line">        <span class="string">"""取消订阅回调"""</span></span><br><span class="line">        logging.info(<span class="string">f"取消订阅成功 (MID: <span class="subst">{mid}</span>)"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self, keepalive=<span class="number">60</span>, bind_address=<span class="string">""</span></span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        连接到 MQTT Broker。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            keepalive (int): 心跳间隔秒数。客户端会以此间隔发送 PINGREQ，</span></span><br><span class="line"><span class="string">                             Broker 若在 1.5 * keepalive 内未收到任何消息，会认为客户端断开。</span></span><br><span class="line"><span class="string">                             默认 60 秒。设置为 0 表示禁用心跳 (不推荐)。</span></span><br><span class="line"><span class="string">            bind_address (str): 绑定本地网络接口地址。默认为空。</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.connected:</span><br><span class="line">            logging.warning(<span class="string">"客户端已连接，无需重复连接"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 设置遗嘱消息 (Last Will and Testament)</span></span><br><span class="line">        <span class="comment"># 建议使用 JSON 格式，包含状态和时间戳</span></span><br><span class="line">        <span class="comment"># 遗嘱消息的 QoS 建议为 1 或 2，retain=True</span></span><br><span class="line">        will_topic = <span class="string">f"clients/<span class="subst">{self.client_id}</span>/status"</span></span><br><span class="line">        will_payload = json.dumps({<span class="string">"status"</span>: <span class="string">"offline_unexpected"</span>, <span class="string">"timestamp"</span>: time.time()})</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.client.will_set(will_topic, payload=will_payload, qos=<span class="number">1</span>, retain=<span class="literal">True</span>)</span><br><span class="line">            logging.info(<span class="string">f"已设置遗嘱消息: 主题='<span class="subst">{will_topic}</span>', 载荷='<span class="subst">{will_payload}</span>'"</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f"设置遗嘱消息失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">f"尝试连接到 Broker <span class="subst">{self.broker}</span>:<span class="subst">{self.port}</span>..."</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># connect() 是阻塞的，直到连接完成或失败</span></span><br><span class="line">            <span class="comment"># connect_async() 是非阻塞的，需要配合 loop_start() 或 loop_forever()</span></span><br><span class="line">            <span class="variable language_">self</span>.client.connect(<span class="variable language_">self</span>.broker, <span class="variable language_">self</span>.port, keepalive=keepalive, bind_address=bind_address)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 启动后台网络循环线程</span></span><br><span class="line">            <span class="comment"># loop_start() 会启动一个新线程来处理网络流量 (收发消息、心跳、重连等)</span></span><br><span class="line">            <span class="comment"># 这是最常用的方式，因为它不会阻塞主线程</span></span><br><span class="line">            <span class="variable language_">self</span>.client.loop_start()</span><br><span class="line">            logging.info(<span class="string">"后台网络循环已启动 (loop_start)"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 另一种方式是 loop_forever()，它会阻塞当前线程，直到调用 disconnect()</span></span><br><span class="line">            <span class="comment"># 适用于简单的脚本或主线程无其他任务的情况</span></span><br><span class="line">            <span class="comment"># self.client.loop_forever()</span></span><br><span class="line">            <span class="comment"># logging.info("网络循环启动 (loop_forever) - 将阻塞主线程")</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 也可以手动调用 loop() 或 loop_misc() 在自己的循环中处理网络事件，较少用</span></span><br><span class="line">            <span class="comment"># while not self.connected:</span></span><br><span class="line">            <span class="comment">#     self.client.loop(timeout=1.0) # 处理一次网络事件，最多等待 1 秒</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> mqtt.WebsocketConnectionError <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f"WebSocket 连接错误: <span class="subst">{e}</span>. 请检查 Broker 是否启用了 WebSocket 以及端口是否正确 (通常是 8083/8084)。"</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">except</span> ConnectionRefusedError <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f"连接被拒绝: <span class="subst">{e}</span>. 请检查 Broker 地址、端口是否正确，以及 Broker 服务是否运行。"</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">             logging.error(<span class="string">f"网络错误 (例如无法解析主机名或网络不可达): <span class="subst">{e}</span>"</span>)</span><br><span class="line">             <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f"连接过程中发生未知错误: <span class="subst">{e}</span>"</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">            <span class="comment"># 确保停止可能已启动的循环</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.client.is_connected():</span><br><span class="line">                <span class="variable language_">self</span>.client.loop_stop()</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">disconnect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""主动、正常地断开与 Broker 的连接"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.connected:</span><br><span class="line">            logging.warning(<span class="string">"客户端未连接，无需断开"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">"准备主动断开连接..."</span>)</span><br><span class="line">        <span class="comment"># 💡 最佳实践: 在主动断开前，发布一个表示“正常离线”的状态消息 (如果需要)</span></span><br><span class="line">        <span class="comment"># 这与“遗嘱消息”不同，遗嘱表示“意外离线”</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            status_topic = <span class="string">f"clients/<span class="subst">{self.client_id}</span>/status"</span></span><br><span class="line">            status_payload = json.dumps({<span class="string">"status"</span>: <span class="string">"offline_clean"</span>, <span class="string">"timestamp"</span>: time.time()})</span><br><span class="line">            <span class="comment"># 使用 QoS 1 确保送达，retain=True 更新最终状态</span></span><br><span class="line">            <span class="variable language_">self</span>.publish(status_topic, status_payload, qos=<span class="number">1</span>, retain=<span class="literal">True</span>)</span><br><span class="line">            logging.info(<span class="string">f"已发布正常离线状态: 主题='<span class="subst">{status_topic}</span>'"</span>)</span><br><span class="line">            <span class="comment"># 可能需要短暂等待确保消息发出</span></span><br><span class="line">            time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f"发布离线状态失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 停止后台网络循环线程 (必须在 disconnect() 之前或之后调用)</span></span><br><span class="line">        <span class="variable language_">self</span>.client.loop_stop()</span><br><span class="line">        logging.info(<span class="string">"后台网络循环已停止 (loop_stop)"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 主动断开连接</span></span><br><span class="line">        <span class="variable language_">self</span>.client.disconnect()</span><br><span class="line">        <span class="comment"># disconnect() 调用后，on_disconnect 回调会被触发 (rc=0)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">publish</span>(<span class="params">self, topic, message, qos=<span class="number">0</span>, retain=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        发布消息到指定主题。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            topic (str): 目标主题.</span></span><br><span class="line"><span class="string">            message (str | bytes | dict | int | float | bool): 消息内容.</span></span><br><span class="line"><span class="string">                                如果是 dict，会自动转换为 JSON 字符串.</span></span><br><span class="line"><span class="string">                                其他类型会尝试转换为字符串再编码为 bytes (UTF-8).</span></span><br><span class="line"><span class="string">                                可以直接传入 bytes.</span></span><br><span class="line"><span class="string">            qos (int): 服务质量等级 (0, 1, or 2). 默认为 0.</span></span><br><span class="line"><span class="string">            retain (bool): 是否将此消息设置为保留消息. 默认为 False.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            mqtt.MQTTMessageInfo: 包含消息 ID (mid) 和返回码 (rc) 的对象.</span></span><br><span class="line"><span class="string">                                  rc 为 MQTT_ERR_SUCCESS 表示成功加入发送队列.</span></span><br><span class="line"><span class="string">                                  rc 为 MQTT_ERR_NO_CONN 表示未连接.</span></span><br><span class="line"><span class="string">                                  rc 为 MQTT_ERR_QUEUE_SIZE 表示发送队列已满 (QoS 1/2).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Raises:</span></span><br><span class="line"><span class="string">            ValueError: 如果 QoS 无效.</span></span><br><span class="line"><span class="string">            TypeError: 如果 message 类型无法处理.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.connected:</span><br><span class="line">            logging.error(<span class="string">"发布失败：客户端未连接到 Broker"</span>)</span><br><span class="line">            <span class="comment"># 可以选择抛出异常或返回错误状态</span></span><br><span class="line">            <span class="comment"># raise ConnectionError("Client not connected")</span></span><br><span class="line">            <span class="comment"># 返回一个模拟的失败结果</span></span><br><span class="line">            <span class="keyword">return</span> mqtt.MQTTMessageInfo(<span class="number">0</span>) <span class="comment"># mid=0 通常表示失败</span></span><br><span class="line"></span><br><span class="line">        payload = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(message, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                payload = json.dumps(message).encode(<span class="string">'utf-8'</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logging.error(<span class="string">f"字典转换为 JSON 失败: <span class="subst">{e}</span>"</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">"Failed to serialize dictionary to JSON"</span>) <span class="keyword">from</span> e</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(message, <span class="built_in">str</span>):</span><br><span class="line">            payload = message.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(message, <span class="built_in">bytes</span>):</span><br><span class="line">            payload = message</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(message, (<span class="built_in">int</span>, <span class="built_in">float</span>, <span class="built_in">bool</span>)):</span><br><span class="line">             payload = <span class="built_in">str</span>(message).encode(<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">f"不支持的消息类型: <span class="subst">{<span class="built_in">type</span>(message)}</span>. 请提供 str, bytes, dict, int, float 或 bool."</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查 payload 大小 (可选，取决于 Broker 限制)</span></span><br><span class="line">        <span class="comment"># max_payload_size = 1024 * 256 # 示例：256KB</span></span><br><span class="line">        <span class="comment"># if len(payload) &gt; max_payload_size:</span></span><br><span class="line">        <span class="comment">#     logging.error(f"发布失败：消息载荷大小 ({len(payload)} bytes) 超过限制 ({max_payload_size} bytes)")</span></span><br><span class="line">        <span class="comment">#     # 返回错误或抛出异常</span></span><br><span class="line">        <span class="comment">#     return mqtt.MQTTMessageInfo(0)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logging.debug(<span class="string">f"准备发布消息: 主题='<span class="subst">{topic}</span>', QoS=<span class="subst">{qos}</span>, Retain=<span class="subst">{retain}</span>, 载荷(bytes)=<span class="subst">{payload[:<span class="number">100</span>]}</span>..."</span>) <span class="comment"># 只显示部分载荷</span></span><br><span class="line">            result = <span class="variable language_">self</span>.client.publish(topic, payload=payload, qos=qos, retain=retain)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 检查发布结果 (rc)</span></span><br><span class="line">            <span class="keyword">if</span> result.rc == mqtt.MQTT_ERR_SUCCESS:</span><br><span class="line">                logging.debug(<span class="string">f"消息 (MID: <span class="subst">{result.mid}</span>) 已成功加入发送队列 (主题: '<span class="subst">{topic}</span>')"</span>)</span><br><span class="line">                <span class="comment"># 对于 QoS 0, 发布几乎立即完成 (没有回调确认)</span></span><br><span class="line">                <span class="comment"># 对于 QoS 1/2, on_publish 回调会在收到 Broker 确认后触发</span></span><br><span class="line">            <span class="keyword">elif</span> result.rc == mqtt.MQTT_ERR_NO_CONN:</span><br><span class="line">                logging.error(<span class="string">f"发布失败 (MID: <span class="subst">{result.mid}</span>): 未连接到 Broker"</span>)</span><br><span class="line">            <span class="keyword">elif</span> result.rc == mqtt.MQTT_ERR_QUEUE_SIZE:</span><br><span class="line">                <span class="comment"># 这通常发生在 QoS 1 或 2 消息发送过快，网络处理不过来时</span></span><br><span class="line">                logging.warning(<span class="string">f"发布警告 (MID: <span class="subst">{result.mid}</span>): 发送队列已满，消息可能延迟或丢失。请考虑降低发送频率或检查网络。"</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                 logging.error(<span class="string">f"发布失败 (MID: <span class="subst">{result.mid}</span>): 未知错误代码 <span class="subst">{result.rc}</span>"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result <span class="comment"># 返回 MQTTMessageInfo 对象</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># 例如 QoS 不是 0, 1, 2</span></span><br><span class="line">            logging.error(<span class="string">f"发布失败: 无效参数 - <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f"发布过程中发生未知错误: <span class="subst">{e}</span>"</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">raise</span> <span class="comment"># 重新抛出</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">subscribe</span>(<span class="params">self, topic, qos=<span class="number">0</span></span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        订阅一个主题。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            topic (str): 要订阅的主题 (可以包含通配符 '+' 或 '#').</span></span><br><span class="line"><span class="string">                         '+': 匹配单层通配符, e.g., `sensor/+/temperature`.</span></span><br><span class="line"><span class="string">                         '#': 匹配多层通配符 (必须在末尾), e.g., `sensor/livingroom/#`.</span></span><br><span class="line"><span class="string">            qos (int): 请求的 QoS 等级 (0, 1, or 2). Broker 可能授予较低的 QoS.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            tuple[int, int]: (result, mid)</span></span><br><span class="line"><span class="string">                             result: MQTT_ERR_SUCCESS (0) 表示成功，其他表示失败.</span></span><br><span class="line"><span class="string">                             mid: 消息 ID.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Raises:</span></span><br><span class="line"><span class="string">            ValueError: 如果 QoS 无效.</span></span><br><span class="line"><span class="string">            ConnectionError: 如果客户端未连接.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.connected:</span><br><span class="line">            logging.error(<span class="string">"订阅失败：客户端未连接到 Broker"</span>)</span><br><span class="line">            <span class="comment"># raise ConnectionError("Client not connected")</span></span><br><span class="line">            <span class="keyword">return</span> (mqtt.MQTT_ERR_NO_CONN, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logging.info(<span class="string">f"尝试订阅主题: '<span class="subst">{topic}</span>' (QoS: <span class="subst">{qos}</span>)"</span>)</span><br><span class="line">            result, mid = <span class="variable language_">self</span>.client.subscribe(topic, qos)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> result == mqtt.MQTT_ERR_SUCCESS:</span><br><span class="line">                logging.debug(<span class="string">f"订阅请求已发送 (MID: <span class="subst">{mid}</span>)"</span>)</span><br><span class="line">                <span class="comment"># 将成功订阅的主题记录下来，用于重连时恢复</span></span><br><span class="line">                <span class="variable language_">self</span>._subscribed_topics.add((topic, qos))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logging.error(<span class="string">f"订阅请求失败，错误代码: <span class="subst">{result}</span>"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result, mid</span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f"订阅失败: 无效参数 - <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">             logging.error(<span class="string">f"订阅过程中发生未知错误: <span class="subst">{e}</span>"</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">             <span class="keyword">raise</span> <span class="comment"># 重新抛出</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">unsubscribe</span>(<span class="params">self, topic</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        取消订阅一个主题。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            topic (str): 要取消订阅的主题.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            tuple[int, int]: (result, mid)</span></span><br><span class="line"><span class="string">                             result: MQTT_ERR_SUCCESS (0) 表示成功，其他表示失败.</span></span><br><span class="line"><span class="string">                             mid: 消息 ID.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Raises:</span></span><br><span class="line"><span class="string">            ConnectionError: 如果客户端未连接.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.connected:</span><br><span class="line">            logging.error(<span class="string">"取消订阅失败：客户端未连接到 Broker"</span>)</span><br><span class="line">            <span class="comment"># raise ConnectionError("Client not connected")</span></span><br><span class="line">            <span class="keyword">return</span> (mqtt.MQTT_ERR_NO_CONN, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">f"尝试取消订阅主题: '<span class="subst">{topic}</span>'"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result, mid = <span class="variable language_">self</span>.client.unsubscribe(topic)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> result == mqtt.MQTT_ERR_SUCCESS:</span><br><span class="line">                logging.debug(<span class="string">f"取消订阅请求已发送 (MID: <span class="subst">{mid}</span>)"</span>)</span><br><span class="line">                <span class="comment"># 从记录中移除</span></span><br><span class="line">                <span class="comment"># 注意：这里移除逻辑比较复杂，因为 qos 未知，简单实现是移除所有匹配 topic 的记录</span></span><br><span class="line">                <span class="variable language_">self</span>._subscribed_topics = {(t, q) <span class="keyword">for</span> t, q <span class="keyword">in</span> <span class="variable language_">self</span>._subscribed_topics <span class="keyword">if</span> t != topic}</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logging.error(<span class="string">f"取消订阅请求失败，错误代码: <span class="subst">{result}</span>"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result, mid</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">             logging.error(<span class="string">f"取消订阅过程中发生未知错误: <span class="subst">{e}</span>"</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">             <span class="keyword">raise</span> <span class="comment"># 重新抛出</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 使用示例 ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mqtt_example_usage</span>():</span><br><span class="line">    <span class="string">"""MQTT 客户端使用示例"""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 配置 (建议从配置文件或环境变量读取) ---</span></span><br><span class="line">    BROKER_ADDRESS = <span class="string">"broker.emqx.io"</span> <span class="comment"># 公共测试 Broker</span></span><br><span class="line">    BROKER_PORT = <span class="number">1883</span></span><br><span class="line">    CLIENT_ID = <span class="string">f"python-mqtt-example-<span class="subst">{uuid.uuid4()}</span>"</span> <span class="comment"># 每次运行生成新的 ID</span></span><br><span class="line">    USE_TLS = <span class="literal">False</span> <span class="comment"># 对于公共测试 Broker，通常不需要 TLS 或需要特定配置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果需要认证或 TLS</span></span><br><span class="line">    <span class="comment"># USERNAME = "your_username"</span></span><br><span class="line">    <span class="comment"># PASSWORD = "your_password"</span></span><br><span class="line">    <span class="comment"># USE_TLS = True</span></span><br><span class="line">    <span class="comment"># BROKER_PORT = 8883 # TLS 常用端口</span></span><br><span class="line">    <span class="comment"># CA_CERTS_PATH = "path/to/ca.crt"</span></span><br><span class="line">    <span class="comment"># CERTFILE_PATH = "path/to/client.crt" # (双向认证时需要)</span></span><br><span class="line">    <span class="comment"># KEYFILE_PATH = "path/to/client.key"  # (双向认证时需要)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 创建客户端实例 ---</span></span><br><span class="line">    <span class="comment"># client = MQTTClient(broker=BROKER_ADDRESS, port=BROKER_PORT, client_id=CLIENT_ID, use_tls=USE_TLS)</span></span><br><span class="line">    <span class="comment"># 如果需要认证/TLS:</span></span><br><span class="line">    client = MQTTClient(</span><br><span class="line">        broker=BROKER_ADDRESS,</span><br><span class="line">        port=BROKER_PORT,</span><br><span class="line">        client_id=CLIENT_ID,</span><br><span class="line">        use_tls=USE_TLS,</span><br><span class="line">        <span class="comment"># username=USERNAME, # 取消注释以启用</span></span><br><span class="line">        <span class="comment"># password=PASSWORD, # 取消注释以启用</span></span><br><span class="line">        <span class="comment"># ca_certs=CA_CERTS_PATH, # 取消注释以启用</span></span><br><span class="line">        <span class="comment"># certfile=CERTFILE_PATH, # 取消注释以启用</span></span><br><span class="line">        <span class="comment"># keyfile=KEYFILE_PATH, # 取消注释以启用</span></span><br><span class="line">        clean_session=<span class="literal">True</span> <span class="comment"># 使用清洁会话</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># --- 连接到 Broker ---</span></span><br><span class="line">        client.connect(keepalive=<span class="number">60</span>) <span class="comment"># connect() 会启动后台循环</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 等待连接成功 ---</span></span><br><span class="line">        <span class="comment"># 可以稍微等待一下确保连接和可能的重订阅完成</span></span><br><span class="line">        <span class="comment"># 更健壮的方式是检查 client.connected 状态或使用信号量/事件</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>): <span class="comment"># 最多等待 5 秒</span></span><br><span class="line">            <span class="keyword">if</span> client.connected:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> client.connected:</span><br><span class="line">             logging.error(<span class="string">"连接超时，无法继续执行示例。"</span>)</span><br><span class="line">             <span class="keyword">return</span> <span class="comment"># 或者 raise Exception("Connection timeout")</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 订阅主题 ---</span></span><br><span class="line">        <span class="comment"># 订阅一个通配符主题，接收所有 test/topic/ 下的消息，请求 QoS 1</span></span><br><span class="line">        <span class="comment"># 返回 (result, mid)</span></span><br><span class="line">        sub_result, sub_mid = client.subscribe(<span class="string">"test/topic/#"</span>, qos=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> sub_result != mqtt.MQTT_ERR_SUCCESS:</span><br><span class="line">            logging.error(<span class="string">"订阅失败!"</span>)</span><br><span class="line">            <span class="comment"># 这里可以根据需要处理订阅失败的情况</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 发布消息 ---</span></span><br><span class="line">        <span class="comment"># 准备要发布的数据 (字典)</span></span><br><span class="line">        message_data = {</span><br><span class="line">            <span class="string">"device_id"</span>: CLIENT_ID,</span><br><span class="line">            <span class="string">"sensor_type"</span>: <span class="string">"environment"</span>,</span><br><span class="line">            <span class="string">"location"</span>: <span class="string">"living_room"</span>,</span><br><span class="line">            <span class="string">"temperature"</span>: <span class="number">23.5</span> + (time.time() % <span class="number">5</span> - <span class="number">2.5</span>), <span class="comment"># 模拟一点变化</span></span><br><span class="line">            <span class="string">"humidity"</span>: <span class="number">55</span> + (time.time() % <span class="number">10</span> - <span class="number">5</span>),    <span class="comment"># 模拟一点变化</span></span><br><span class="line">            <span class="string">"timestamp"</span>: time.time()</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 发布消息到具体主题 test/topic/data，使用 QoS 1，不保留</span></span><br><span class="line">        <span class="comment"># 返回 MQTTMessageInfo 对象</span></span><br><span class="line">        pub_info = client.publish(</span><br><span class="line">            topic=<span class="string">"test/topic/data"</span>,</span><br><span class="line">            message=message_data, <span class="comment"># 传递字典，publish 方法会处理 JSON 转换</span></span><br><span class="line">            qos=<span class="number">1</span>,</span><br><span class="line">            retain=<span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> pub_info.rc == mqtt.MQTT_ERR_SUCCESS:</span><br><span class="line">             logging.info(<span class="string">f"消息已发布 (MID: <span class="subst">{pub_info.mid}</span>)"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">             logging.error(<span class="string">"消息发布失败!"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 发布一条纯文本消息，QoS 0</span></span><br><span class="line">        client.publish(<span class="string">"test/topic/log"</span>, <span class="string">"Client script started."</span>, qos=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 保持运行以接收消息 ---</span></span><br><span class="line">        <span class="comment"># 因为 loop_start() 在后台运行，主线程可以做其他事情或等待</span></span><br><span class="line">        logging.info(<span class="string">"示例运行中，等待接收消息 (按 Ctrl+C 退出)..."</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 让主线程保持活动状态，例如等待用户输入或无限循环</span></span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="comment"># 可以在这里做其他主线程任务</span></span><br><span class="line">                time.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            logging.info(<span class="string">"收到退出信号 (Ctrl+C)"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f"MQTT 连接错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f"发生未知错误: <span class="subst">{e}</span>"</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># --- 断开连接 ---</span></span><br><span class="line">        <span class="comment"># 确保无论如何都尝试断开连接并停止循环</span></span><br><span class="line">        logging.info(<span class="string">"示例结束，断开连接..."</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'client'</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> client: <span class="comment"># 检查 client 是否已成功初始化</span></span><br><span class="line">             client.disconnect()</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 运行示例 ---</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    mqtt_example_usage()</span><br></pre></td></tr></tbody></table></figure><h4 id="15-3-5-WebRTC-协议"><a href="#15-3-5-WebRTC-协议" class="headerlink" title="15.3.5 WebRTC 协议"></a>15.3.5 WebRTC 协议</h4><p>WebRTC (Web Real-Time Communication) 是一种开放标准和 API，允许网页浏览器和移动应用程序之间无需复杂的服务器中介或插件即可进行实时通信。它主要支持点对点的语音通话、视频通话和任意数据传输，作为一项开放的实时通信标准，为开发者提供了快速构建实时音视频通话系统的能力</p><h5 id="1-WebRTC-协议特性"><a href="#1-WebRTC-协议特性" class="headerlink" title="1.WebRTC 协议特性"></a>1.WebRTC 协议特性</h5><table><thead><tr><th>特性</th><th>描述</th><th>优势</th></tr></thead><tbody><tr><td>点对点通信</td><td>在客户端之间直接传输数据</td><td>减少服务器负载，降低延迟</td></tr><tr><td>实时音视频</td><td>支持高质量的音频和视频传输</td><td>适合视频会议、直播场景</td></tr><tr><td>数据通道</td><td>支持任意二进制数据传输</td><td>适合游戏、协作编辑等应用</td></tr><tr><td>NAT 穿透</td><td>通过 STUN/TURN/ICE 机制穿透防火墙</td><td>可在复杂网络环境下工作</td></tr><tr><td>端到端加密</td><td>使用 DTLS/SRTP 加密通信内容</td><td>保障通信安全性</td></tr><tr><td>带宽自适应</td><td>根据网络条件调整传输质量</td><td>提供流畅的用户体验</td></tr></tbody></table><h5 id="2-P2P-通信原理"><a href="#2-P2P-通信原理" class="headerlink" title="2.P2P 通信原理"></a>2.P2P 通信原理</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250429221902185.png" alt="image-20250429221902185"></p><p>传统通信方式需要通过客户端 A =&gt; 服务器 &lt;== 客户端 B 进行通信，而 P2P 通信则可以通过 <code>信令</code> 来交换数据</p><p>要实现两个客户端的实时音视频通话，并且两个客户端可能处于不同网络环境，使用不同的设备，都需要解决以下三个问题：</p><ul><li>如何发现对方？</li><li>不同的音视频解码能力如何沟通？</li><li>如何联系对方进行通信？</li></ul><p><strong><span style="color:#c00;background:#fff">【1】如何发现对方？</span></strong></p><p>在 P2P 通信的过程中，双方需要交换一些元数据比如媒体信息、网络数据等等信息，我们通常称这一过程叫做 <code>信令</code>。对应的服务器即信令服务器, 通常也有人将之称为“房间服务器 “，因为它不仅可以交换彼此的媒体信息和网络信息，同样也可以管理房间信息。</p><p>比如：</p><ul><li>1.通知彼此 [谁] 加入了房间</li><li>2.[谁] 离开了房间</li><li>3.告诉第三方房间是否已满或是否可以加入房间</li></ul><p>为避免出现冗余，并最大限度的提高与已有技术的兼容性，WebRTC 标准并没有规定信令方法和协议，所以我们尽可能的使用学习过的 websocket 协议来搭建一个信令服务器</p><p><strong><span style="color:#c00">【2】不同的音视频解码能力如何沟通？</span></strong></p><p>不同浏览器对于音视频的编码能力是不同的</p><p>比如：以生活的例子来讲，小李会讲汉语和英语，而小王会讲法语和汉语，为了保证双方都可以正确理解对方的意思，最简单的就是取他们都会的语言，也就是汉语来沟通</p><blockquote><p>在 WebRTC 中有一个专门的协议，称作 <code>Session Description Protocol（SDP）</code>，可以用于描述上述这类信息。</p></blockquote><p>因此：参与音视频通讯的双方想要了解对方支持的媒体格式，必须交换 SDP 信息，而交换 SDP 的过程，通常称为媒体协商</p><p><strong><span style="color:#c00">【3】如何联系上对方</span></strong></p><p>其实就是网络协商的过程，也就是参与音视频实时通信的双方要了解彼此的网络情况，这样才有可能找到一条相互通讯的链路</p><p>理想的网络情况是每个客户端都有自己的私网公网 IP 地址，这样就可以直接进行点对点连接。实际上呢，处于网络安全和其他原因考虑，大多数客户端之间是在某个局域网内，需要网络地址转换（NAT）。</p><p>在 WebRTC 中我们使用 <code>ICE</code> 机制建立网络连接。<code>ICE</code> 协议通过一系列技术如（<code>STUN/TURN</code> 服务器）帮助通信双方发现和协商可用的公共网络地址，实现 NAT 穿越</p><p><code>ICE</code> 的工作原理如下：</p><ul><li>1.首先，通信双方收集本地网络地址（包括私有和公共地址）以及通过 <code>STUN</code> 和 <code>TURN</code> 服务器获取的候选地址</li><li>2.接下来，双方通过信令服务器交换这些候选地址</li><li>3.通信双方使用这些候选地址进行连接测试，确定最佳的可用地址</li><li>4.一旦找到可用的地址，通信双方就可以开始实时音视频通话</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250429225830213.png" alt="image-20250429225830213"></p><p>在 WebRTC 中网络信息通常用 <code>candidate</code> 来描述</p><p>针对上面三个问题的总结：就是通过 WebRTC 提供的 API 获取各端的媒体信息 <code>SDP</code> 以及网络信息 <code>candidate</code> 并通过信令服务器交换，进而建立两端连接通道完成实时音视频通话</p><blockquote><p>主要会用到如下的几个方法：</p></blockquote><p><strong>媒体协商方法：</strong></p><ul><li><code>createOffer</code>: 由发起方调用，创建一个包含其媒体能力和网络信息的 SDP Offer，用于启动连接协商。</li><li><code>createAnswer</code>: 由接收方在收到 Offer 后调用，创建一个响应对方 Offer 的 SDP Answer。</li><li><code>setLocalDescription</code>: 将本地生成的 Offer 或 Answer 应用到 <code>RTCPeerConnection</code>，并开始收集本地 ICE 候选地址。</li><li><code>setRemoteDescription</code>: 将从远端通过信令接收到的 Offer 或 Answer 应用到 <code>RTCPeerConnection</code>。</li></ul><p><strong>重要事件：</strong></p><ul><li><code>onicecandidate</code>: 当本地 ICE 代理找到一个网络候选地址（IP、端口、协议）时触发此事件，你需要将这个候选地址通过信令发送给对方。</li><li><code>onaddstream</code> (已废弃): <strong>旧版 API</strong> 中，当接收到远端的媒体流 (<code>MediaStream</code>) 时触发。</li><li><code>ontrack</code> (<strong>推荐使用的现代 API</strong>): 当接收到远端的媒体轨道 (<code>MediaStreamTrack</code>) 时触发此事件。这是当前标准接收音视频的方式。</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250430104449908.png" alt="image-20250430104449908"> 整个媒体协商过程可以简化为三个步骤对应上述的四个媒体协商方法：</p><ul><li><ol><li>Annie 发起:</li></ol><p>Annie 调用 <code>createOffer()</code> 创建（包含她的信息）。她用 <code>setLocalDescription()</code> 保存这个 Offer，然后通过信令服务器发给 Steve。</p></li><li><ol start="2"><li>Steve 回应:</li></ol><p>Steve 收到 Offer 后，用 <code>setRemoteDescription()</code> 保存它。然后，他调用 <code>createAnswer()</code> 创建回应 (Answer)（包含他的信息）。接着，他用 <code>setLocalDescription()</code> 保存这个 Answer，再通过信令服务器发回给 Annie。</p></li><li><ol start="3"><li>Annie 确认:</li></ol><p>Annie 收到 Answer 后，用 <code>setRemoteDescription()</code> 保存它。至此，双方的信息交换完毕。</p></li></ul><p>经过这三个步骤，则就完成了 P2P 通信过程中的媒体协商部分，实际上在呼叫端以及接收端调用 <code>setLocalDescription</code> 的同时也开始了收集各端自己的网络信息(candidate)，然后各端通过监听 <code>ontrack</code> 事件拿到对方的视频流进而完成了整个视频通</p><h5 id="3-常用-API"><a href="#3-常用-API" class="headerlink" title="3.常用 API"></a>3.常用 API</h5><hr><p><strong>API 名:</strong> <code>navigator.mediaDevices.getUserMedia()</code></p><p>描述:</p><p>用于请求访问用户的媒体输入设备（如摄像头和麦克风）。它会提示用户授权。成功后，返回一个 Promise，该 Promise 解析为一个 MediaStream 对象，包含了请求的音视频轨道。可以通过 constraints 参数指定请求的媒体类型（音频/视频）以及具体要求（如分辨率、帧率）。</p><p><strong>示例代码:</strong></p><p>JavaScript</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> videoElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'localVideo'</span>);</span><br><span class="line"><span class="keyword">let</span> localStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">startCamera</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">const</span> constraints = {</span><br><span class="line">      <span class="attr">video</span>: {</span><br><span class="line">        <span class="attr">width</span>: { <span class="attr">ideal</span>: <span class="number">640</span> }, <span class="comment">// 期望宽度</span></span><br><span class="line">        <span class="attr">height</span>: { <span class="attr">ideal</span>: <span class="number">480</span> }, <span class="comment">// 期望高度</span></span><br><span class="line">        <span class="comment">// frameRate: { ideal: 30 } // 期望帧率 (可选)</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">audio</span>: <span class="literal">true</span> <span class="comment">// 请求音频</span></span><br><span class="line">    };</span><br><span class="line">    localStream = <span class="keyword">await</span> navigator.<span class="property">mediaDevices</span>.<span class="title function_">getUserMedia</span>(constraints);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'成功获取本地媒体流:'</span>, localStream);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将媒体流显示在 video 元素上</span></span><br><span class="line">    <span class="keyword">if</span> (videoElement) {</span><br><span class="line">      videoElement.<span class="property">srcObject</span> = localStream;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果需要将轨道添加到 RTCPeerConnection，可以在这里获取</span></span><br><span class="line">    <span class="comment">// const videoTracks = localStream.getVideoTracks();</span></span><br><span class="line">    <span class="comment">// const audioTracks = localStream.getAudioTracks();</span></span><br><span class="line"></span><br><span class="line">  } <span class="keyword">catch</span> (error) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'getUserMedia 错误:'</span>, error);</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">`无法访问媒体设备: <span class="subst">${error.name}</span> - <span class="subst">${error.message}</span>`</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用示例</span></span><br><span class="line"><span class="comment">// startCamera();</span></span><br></pre></td></tr></tbody></table></figure><hr><p><strong>API 名:</strong> <code>RTCPeerConnection</code></p><p>描述:</p><p>WebRTC 的核心接口，用于建立和管理两个对等端之间的连接。通过 new RTCPeerConnection(configuration) 创建实例。configuration 对象可以包含 iceServers 列表（STUN/TURN 服务器信息）等设置。它提供了创建 Offer/Answer、设置本地/远端描述、添加/移除媒体轨道、添加 ICE 候选者、创建数据通道等方法，并提供了监听连接状态、ICE 候选者、媒体轨道等事件的接口。</p><p><strong>示例代码:</strong></p><p>JavaScript</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> peerConnection;</span><br><span class="line"><span class="keyword">const</span> configuration = {</span><br><span class="line">  <span class="attr">iceServers</span>: [</span><br><span class="line">    { <span class="attr">urls</span>: <span class="string">'stun:stun.l.google.com:19302'</span> },</span><br><span class="line">    <span class="comment">// 可以添加更多 STUN 或 TURN 服务器</span></span><br><span class="line">  ]</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createPeerConnection</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    peerConnection = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>(configuration);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'RTCPeerConnection 已创建'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听 ICE Candidate 事件</span></span><br><span class="line">    peerConnection.<span class="property">onicecandidate</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">candidate</span>) {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'生成本地 ICE Candidate:'</span>, event.<span class="property">candidate</span>);</span><br><span class="line">        <span class="comment">// 通过信令服务器将 event.candidate.toJSON() 发送给对方</span></span><br><span class="line">        <span class="comment">// signalingChannel.send({ type: 'ice', candidate: event.candidate.toJSON() });</span></span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'ICE Candidate 收集完成'</span>);</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听远端媒体轨道事件</span></span><br><span class="line">    peerConnection.<span class="property">ontrack</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'收到远端媒体轨道:'</span>, event.<span class="property">track</span>, <span class="string">'关联的流:'</span>, event.<span class="property">streams</span>[<span class="number">0</span>]);</span><br><span class="line">      <span class="keyword">const</span> remoteVideo = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'remoteVideo'</span>);</span><br><span class="line">      <span class="keyword">if</span> (remoteVideo &amp;&amp; event.<span class="property">streams</span> &amp;&amp; event.<span class="property">streams</span>[<span class="number">0</span>]) {</span><br><span class="line">        <span class="comment">// 将收到的流附加到远端 video 元素</span></span><br><span class="line">        <span class="keyword">if</span> (remoteVideo.<span class="property">srcObject</span> !== event.<span class="property">streams</span>[<span class="number">0</span>]) {</span><br><span class="line">             remoteVideo.<span class="property">srcObject</span> = event.<span class="property">streams</span>[<span class="number">0</span>];</span><br><span class="line">             <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'已将远端流附加到 video 元素'</span>);</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听连接状态变化</span></span><br><span class="line">    peerConnection.<span class="property">onconnectionstatechange</span> = <span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (peerConnection) {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`PeerConnection 连接状态变为: <span class="subst">${peerConnection.connectionState}</span>`</span>);</span><br><span class="line">        <span class="comment">// 在这里可以根据状态更新 UI (e.g., 'connected', 'disconnected', 'failed', 'closed')</span></span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 监听协商需求事件 (可选，用于完美协商模式)</span></span><br><span class="line">     peerConnection.<span class="property">onnegotiationneeded</span> = <span class="title function_">async</span> () =&gt; {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"需要进行协商 (onnegotiationneeded 触发)"</span>);</span><br><span class="line">        <span class="comment">// 在完美协商模式下，这里可以自动创建并发送 Offer</span></span><br><span class="line">        <span class="comment">// try {</span></span><br><span class="line">        <span class="comment">//   await peerConnection.setLocalDescription(await peerConnection.createOffer());</span></span><br><span class="line">        <span class="comment">//   // 通过信令发送 peerConnection.localDescription</span></span><br><span class="line">        <span class="comment">// } catch (err) {</span></span><br><span class="line">        <span class="comment">//   console.error("协商处理失败:", err);</span></span><br><span class="line">        <span class="comment">// }</span></span><br><span class="line">     };</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 监听数据通道事件 (如果对方创建了数据通道)</span></span><br><span class="line">     peerConnection.<span class="property">ondatachannel</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'收到远端数据通道:'</span>, event.<span class="property">channel</span>.<span class="property">label</span>);</span><br><span class="line">        <span class="keyword">const</span> receiveChannel = event.<span class="property">channel</span>;</span><br><span class="line">        <span class="title function_">setupDataChannelHandlers</span>(receiveChannel); <span class="comment">// 设置接收通道的回调</span></span><br><span class="line">     };</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  } <span class="keyword">catch</span> (error) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'创建 RTCPeerConnection 失败:'</span>, error);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用示例</span></span><br><span class="line"><span class="comment">// createPeerConnection();</span></span><br></pre></td></tr></tbody></table></figure><hr><p><strong>API 名:</strong> <code>RTCPeerConnection.createOffer()</code></p><p>描述:</p><p>由发起连接的一方调用，用于创建一个包含本地媒体能力和网络地址信息的 SDP (Session Description Protocol) Offer。返回一个 Promise，该 Promise 解析为一个 RTCSessionDescription 对象（包含 type: ‘offer’ 和 sdp 字符串）。通常在调用此方法前需要先通过 addTrack() 添加好要发送的媒体轨道。</p><p><strong>示例代码:</strong></p><p>JavaScript</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">makeOffer</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">if</span> (!peerConnection) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'PeerConnection 不存在'</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'创建 Offer...'</span>);</span><br><span class="line">    <span class="comment">// 可选：指定 Offer 选项，例如是否需要接收音视频</span></span><br><span class="line">    <span class="keyword">const</span> offerOptions = {</span><br><span class="line">        <span class="attr">offerToReceiveAudio</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">offerToReceiveVideo</span>: <span class="literal">true</span></span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">const</span> offer = <span class="keyword">await</span> peerConnection.<span class="title function_">createOffer</span>(offerOptions);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'Offer 已创建, 设置本地描述...'</span>);</span><br><span class="line">    <span class="keyword">await</span> peerConnection.<span class="title function_">setLocalDescription</span>(offer); <span class="comment">// 将 Offer 设置为本地描述</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'本地描述已设置, 通过信令发送 Offer:'</span>);</span><br><span class="line">    <span class="comment">// console.log(peerConnection.localDescription);</span></span><br><span class="line">    <span class="comment">// 通过信令服务器将 peerConnection.localDescription 发送给对方</span></span><br><span class="line">    <span class="comment">// signalingChannel.send({ type: 'offer', sdp: offer.sdp, type: offer.type });</span></span><br><span class="line"></span><br><span class="line">  } <span class="keyword">catch</span> (error) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'创建 Offer 或设置本地描述失败:'</span>, error);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前提：peerConnection 已创建，且可能已添加本地轨道</span></span><br><span class="line"><span class="comment">// 调用示例</span></span><br><span class="line"><span class="comment">// makeOffer();</span></span><br></pre></td></tr></tbody></table></figure><hr><p><strong>API 名:</strong> <code>RTCPeerConnection.createAnswer()</code></p><p>描述:</p><p>由接收 Offer 的一方调用，用于创建一个 SDP Answer 来回应收到的 Offer。它会根据本地媒体能力和收到的 Offer 内容生成应答。返回一个 Promise，该 Promise 解析为一个 RTCSessionDescription 对象（包含 type: ‘answer’ 和 sdp 字符串）。在调用此方法前，必须先调用 setRemoteDescription() 将收到的 Offer 设置为远端描述。</p><p><strong>示例代码:</strong></p><p>JavaScript</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设 offerData 是从信令服务器收到的包含 sdp 和 type 的对象</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleOfferAndCreateAnswer</span>(<span class="params">offerData</span>) {</span><br><span class="line">  <span class="keyword">if</span> (!peerConnection) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'PeerConnection 不存在'</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'收到 Offer, 设置远端描述...'</span>);</span><br><span class="line">    <span class="keyword">const</span> offerDescription = <span class="keyword">new</span> <span class="title class_">RTCSessionDescription</span>(offerData);</span><br><span class="line">    <span class="keyword">await</span> peerConnection.<span class="title function_">setRemoteDescription</span>(offerDescription);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在设置远端 Offer 后，添加本地媒体轨道 (如果需要发送)</span></span><br><span class="line">    <span class="comment">// localStream.getTracks().forEach(track =&gt; peerConnection.addTrack(track, localStream));</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'远端描述 (Offer) 已设置, 创建 Answer...'</span>);</span><br><span class="line">    <span class="keyword">const</span> answer = <span class="keyword">await</span> peerConnection.<span class="title function_">createAnswer</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'Answer 已创建, 设置本地描述...'</span>);</span><br><span class="line">    <span class="keyword">await</span> peerConnection.<span class="title function_">setLocalDescription</span>(answer); <span class="comment">// 将 Answer 设置为本地描述</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'本地描述 (Answer) 已设置, 通过信令发送 Answer:'</span>);</span><br><span class="line">    <span class="comment">// console.log(peerConnection.localDescription);</span></span><br><span class="line">    <span class="comment">// 通过信令服务器将 peerConnection.localDescription 发送给对方</span></span><br><span class="line">    <span class="comment">// signalingChannel.send({ type: 'answer', sdp: answer.sdp, type: answer.type });</span></span><br><span class="line"></span><br><span class="line">  } <span class="keyword">catch</span> (error) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'处理 Offer 或创建/设置 Answer 失败:'</span>, error);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前提：peerConnection 已创建</span></span><br><span class="line"><span class="comment">// 调用示例</span></span><br><span class="line"><span class="comment">// handleOfferAndCreateAnswer({ type: 'offer', sdp: '...' });</span></span><br></pre></td></tr></tbody></table></figure><hr><p><strong>API 名:</strong> <code>RTCPeerConnection.setLocalDescription()</code></p><p>描述:</p><p>将一个 SDP 描述（Offer 或 Answer）设置为本地端的描述。这会启动 ICE Agent 开始收集本地网络候选地址。它接受一个 RTCSessionDescription 对象作为参数，并返回一个 Promise。通常在 createOffer() 或 createAnswer() 之后调用。</p><p><strong>示例代码:</strong> (已包含在 <code>createOffer</code> 和 <code>createAnswer</code> 示例中)</p><p>JavaScript</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 createOffer 后:</span></span><br><span class="line"><span class="comment">// const offer = await peerConnection.createOffer();</span></span><br><span class="line"><span class="comment">// await peerConnection.setLocalDescription(offer);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 createAnswer 后:</span></span><br><span class="line"><span class="comment">// const answer = await peerConnection.createAnswer();</span></span><br><span class="line"><span class="comment">// await peerConnection.setLocalDescription(answer);</span></span><br></pre></td></tr></tbody></table></figure><hr><p><strong>API 名:</strong> <code>RTCPeerConnection.setRemoteDescription()</code></p><p>描述:</p><p>将从远端对等方通过信令收到的 SDP 描述（Offer 或 Answer）设置为远端描述。这对于连接协商过程至关重要。它接受一个 RTCSessionDescription 对象作为参数，并返回一个 Promise。接收 Offer 时在 createAnswer() 之前调用；接收 Answer 时在 createOffer() 和 setLocalDescription() 之后调用。</p><p><strong>示例代码:</strong></p><p>JavaScript</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接收 Offer 时 (在 createAnswer 前):</span></span><br><span class="line"><span class="comment">// const offerDescription = new RTCSessionDescription(receivedOfferData);</span></span><br><span class="line"><span class="comment">// await peerConnection.setRemoteDescription(offerDescription);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收 Answer 时 (在 createOffer 和 setLocalDescription 后):</span></span><br><span class="line"><span class="comment">// const answerDescription = new RTCSessionDescription(receivedAnswerData);</span></span><br><span class="line"><span class="comment">// await peerConnection.setRemoteDescription(answerDescription);</span></span><br></pre></td></tr></tbody></table></figure><hr><p><strong>API 名:</strong> <code>RTCPeerConnection.addTrack()</code></p><p>描述:</p><p>将一个本地 MediaStreamTrack (通常来自 getUserMedia 返回的 MediaStream) 添加到 RTCPeerConnection 中，以便将其发送给对等方。需要传入 track 对象和它所属的 stream 对象。此操作通常需要在创建 Offer 之前完成，这样 Offer SDP 中才能包含相应的媒体描述。</p><p><strong>示例代码:</strong></p><p>JavaScript</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addLocalTracksToPeerConnection</span>(<span class="params">stream</span>) {</span><br><span class="line">  <span class="keyword">if</span> (!peerConnection || !stream) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'PeerConnection 或媒体流不存在'</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'将本地轨道添加到 PeerConnection...'</span>);</span><br><span class="line">  stream.<span class="title function_">getTracks</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">track</span> =&gt;</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      peerConnection.<span class="title function_">addTrack</span>(track, stream);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`轨道 <span class="subst">${track.kind}</span> (<span class="subst">${track.id}</span>) 已添加`</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`添加轨道 <span class="subst">${track.kind}</span> 失败:`</span>, error);</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前提：peerConnection 已创建, localStream 已通过 getUserMedia 获取</span></span><br><span class="line"><span class="comment">// 调用示例</span></span><br><span class="line"><span class="comment">// addLocalTracksToPeerConnection(localStream);</span></span><br></pre></td></tr></tbody></table></figure><hr><p><strong>API 名:</strong> <code>RTCPeerConnection.addIceCandidate()</code></p><p>描述:</p><p>将在信令通道上从对等方收到的 ICE 候选者添加到 RTCPeerConnection 的 ICE Agent 中。ICE Agent 使用这些远端候选者与本地候选者进行连通性检查，以寻找最佳的通信路径。接受一个 RTCIceCandidate 对象或符合其结构的字典作为参数，并返回一个 Promise。</p><p><strong>示例代码:</strong></p><p>JavaScript</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设 candidateData 是从信令服务器收到的包含 ICE Candidate 信息的对象</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleRemoteIceCandidate</span>(<span class="params">candidateData</span>) {</span><br><span class="line">  <span class="keyword">if</span> (!peerConnection) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">'PeerConnection 不存在，无法添加 ICE Candidate'</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 有时会收到 null candidate 表示对方收集结束，aiortc 后端需要判断，前端通常直接忽略 null</span></span><br><span class="line">  <span class="keyword">if</span> (!candidateData) {</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"收到 null ICE candidate，忽略。"</span>);</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">const</span> candidate = <span class="keyword">new</span> <span class="title class_">RTCIceCandidate</span>(candidateData);</span><br><span class="line">    <span class="comment">// 在添加前检查信令状态，避免在连接关闭后添加</span></span><br><span class="line">    <span class="keyword">if</span> (peerConnection.<span class="property">signalingState</span> !== <span class="string">'closed'</span>) {</span><br><span class="line">        <span class="keyword">await</span> peerConnection.<span class="title function_">addIceCandidate</span>(candidate);</span><br><span class="line">        <span class="comment">// console.log('成功添加远端 ICE Candidate');</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"PeerConnection 已关闭，忽略收到的 ICE candidate。"</span>);</span><br><span class="line">    }</span><br><span class="line">  } <span class="keyword">catch</span> (error) {</span><br><span class="line">    <span class="comment">// 忽略添加旧 candidate 或格式错误的 candidate 时可能出现的错误</span></span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">name</span> === <span class="string">'OperationError'</span> || error.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">'candidate type'</span>)) {</span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`添加 ICE Candidate 时忽略错误: <span class="subst">${error.message}</span>`</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'添加远端 ICE Candidate 失败:'</span>, error, <span class="string">'Candidate:'</span>, candidateData);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前提：peerConnection 已创建</span></span><br><span class="line"><span class="comment">// 调用示例 (candidateData 通常是 candidate.toJSON() 的结果)</span></span><br><span class="line"><span class="comment">// handleRemoteIceCandidate({ candidate: "candidate:...", sdpMid: "0", sdpMLineIndex: 0 });</span></span><br></pre></td></tr></tbody></table></figure><hr><p><strong>API 名:</strong> <code>RTCPeerConnection.createDataChannel()</code></p><p>描述:</p><p>创建一个 RTCDataChannel，用于在对等方之间传输任意数据（字符串或二进制）。发起方调用此方法创建通道。接收方则通过监听 RTCPeerConnection 的 ondatachannel 事件来获取对方创建的通道。可以指定一个标签（字符串）和一些选项（如 ordered：是否保证顺序，maxRetransmits：最大重传次数等）。</p><p><strong>示例代码 (创建方):</strong></p><p>JavaScript</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dataChannel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setupDataChannel</span>(<span class="params"></span>) {</span><br><span class="line">   <span class="keyword">if</span> (!peerConnection) {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"PeerConnection 不存在，无法创建数据通道"</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">const</span> dataChannelOptions = {</span><br><span class="line">          <span class="attr">ordered</span>: <span class="literal">true</span>, <span class="comment">// 保证消息顺序</span></span><br><span class="line">          <span class="comment">// maxRetransmits: 30 // 可选：设置最大重传次数</span></span><br><span class="line">      };</span><br><span class="line">      dataChannel = peerConnection.<span class="title function_">createDataChannel</span>(<span class="string">"myDataChannel"</span>, dataChannelOptions);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`数据通道 "<span class="subst">${dataChannel.label}</span>" 已创建`</span>);</span><br><span class="line"></span><br><span class="line">      <span class="title function_">setupDataChannelHandlers</span>(dataChannel); <span class="comment">// 设置事件处理</span></span><br><span class="line"></span><br><span class="line">   } <span class="keyword">catch</span>(e) {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"创建数据通道失败:"</span>, e);</span><br><span class="line">   }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setupDataChannelHandlers</span>(<span class="params">channel</span>) {</span><br><span class="line">   channel.<span class="property">onopen</span> = <span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`数据通道 "<span class="subst">${channel.label}</span>" 已打开`</span>);</span><br><span class="line">      status.<span class="property">value</span> = <span class="string">'数据通道已连接'</span>; <span class="comment">// 更新UI状态</span></span><br><span class="line">      <span class="comment">// 通道打开后可以发送消息</span></span><br><span class="line">      <span class="comment">// channel.send("Hello from the initiator!");</span></span><br><span class="line">   };</span><br><span class="line"></span><br><span class="line">   channel.<span class="property">onmessage</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`收到数据通道消息:`</span>, event.<span class="property">data</span>);</span><br><span class="line">      <span class="comment">// 处理收到的数据 (event.data)</span></span><br><span class="line">      <span class="comment">// displayMessage(event.data);</span></span><br><span class="line">   };</span><br><span class="line"></span><br><span class="line">   channel.<span class="property">onclose</span> = <span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`数据通道 "<span class="subst">${channel.label}</span>" 已关闭`</span>);</span><br><span class="line">      status.<span class="property">value</span> = <span class="string">'数据通道已关闭'</span>; <span class="comment">// 更新UI状态</span></span><br><span class="line">   };</span><br><span class="line"></span><br><span class="line">   channel.<span class="property">onerror</span> = <span class="function">(<span class="params">error</span>) =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`数据通道 "<span class="subst">${channel.label}</span>" 错误:`</span>, error);</span><br><span class="line">      errorMessage.<span class="property">value</span> = <span class="string">`数据通道错误: <span class="subst">${error}</span>`</span>;</span><br><span class="line">   };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 前提：peerConnection 已创建</span></span><br><span class="line"><span class="comment">// 通常在发起 Offer 前创建 DataChannel</span></span><br><span class="line"><span class="comment">// 调用示例</span></span><br><span class="line"><span class="comment">// setupDataChannel();</span></span><br></pre></td></tr></tbody></table></figure><p><strong>示例代码 (接收方，在 <code>createPeerConnection</code> 的 <code>ondatachannel</code> 回调中):</strong></p><p>JavaScript</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 createPeerConnection 函数内:</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">peerConnection.ondatachannel = (event) =&gt; {</span></span><br><span class="line"><span class="comment">   console.log('收到远端数据通道:', event.channel.label);</span></span><br><span class="line"><span class="comment">   const receiveChannel = event.channel;</span></span><br><span class="line"><span class="comment">   // !!! 重要：需要为接收到的通道设置回调 !!!</span></span><br><span class="line"><span class="comment">   setupDataChannelHandlers(receiveChannel);</span></span><br><span class="line"><span class="comment">};</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// setupDataChannelHandlers 函数同上</span></span><br></pre></td></tr></tbody></table></figure><hr><p><strong>API 名:</strong> <code>RTCDataChannel.send()</code></p><p>描述:</p><p>通过已建立的 RTCDataChannel 发送数据给对等方。可以发送字符串、Blob、ArrayBuffer 或 ArrayBufferView。</p><p><strong>示例代码:</strong></p><p>JavaScript</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sendDataChannelMessage</span>(<span class="params">message</span>) {</span><br><span class="line">  <span class="keyword">if</span> (dataChannel &amp;&amp; dataChannel.<span class="property">readyState</span> === <span class="string">'open'</span>) {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      dataChannel.<span class="title function_">send</span>(message);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'通过数据通道发送消息:'</span>, message);</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"发送数据失败:"</span>, error);</span><br><span class="line">    }</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">'数据通道未打开，无法发送消息。'</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前提：dataChannel 已创建并通过 onopen 事件确认已打开</span></span><br><span class="line"><span class="comment">// 调用示例</span></span><br><span class="line"><span class="comment">// sendDataChannelMessage("这是一条测试消息");</span></span><br><span class="line"><span class="comment">// const binaryData = new Uint8Array([1, 2, 3]);</span></span><br><span class="line"><span class="comment">// sendDataChannelMessage(binaryData);</span></span><br></pre></td></tr></tbody></table></figure><hr><h5 id="4-项目实践-Vue3-Flask-SocketIO"><a href="#4-项目实践-Vue3-Flask-SocketIO" class="headerlink" title="4. 项目实践 (Vue3 + Flask-SocketIO)"></a>4. 项目实践 (Vue3 + Flask-SocketIO)</h5><h6 id="1-项目初始化"><a href="#1-项目初始化" class="headerlink" title="1.项目初始化"></a>1.项目初始化</h6><ol><li><p>项目采用 <code>vue3+ts</code>，运行如下命令创建项目（例如 <code>webrtc-client</code>）：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm create vite@latest webrtc-client -- --template vue-ts</span><br><span class="line"><span class="built_in">cd</span> webrtc-client</span><br></pre></td></tr></tbody></table></figure><p>安装 Tailwind CSS, PostCSS, Autoprefixer 和 DaisyUI (作为开发依赖):</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D tailwindcss postcss autoprefixer daisyui</span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>初始化 Tailwind CSS 配置文件:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意：根据你的注释，Tailwind CSS 4.0 以上版本可能无需执行此命令</span></span><br><span class="line">npx tailwindcss init -p</span><br></pre></td></tr></tbody></table></figure><p>如果执行成功，会创建 <code>tailwind.config.js</code> 和 <code>postcss.config.js</code>。如果报错或你使用的版本不需要，请直接创建或修改这些文件。</p></li><li><p>配置 tailwind.config.js:</p><p>用以下内容覆盖 tailwind.config.js 文件：</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@type</span> {<span class="type">import('tailwindcss').Config</span>} */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">content</span>: [</span><br><span class="line">    <span class="string">"./index.html"</span>,</span><br><span class="line">    <span class="string">"./src/**/*.{vue,js,ts,jsx,tsx}"</span>, <span class="comment">// 确保扫描 Vue/TS 文件</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">theme</span>: {</span><br><span class="line">    <span class="attr">extend</span>: {</span><br><span class="line">      <span class="attr">colors</span>: { <span class="comment">// 你自定义的颜色</span></span><br><span class="line">        <span class="attr">tropical</span>: {</span><br><span class="line">          <span class="attr">primary</span>: <span class="string">'#00C9A7'</span>,</span><br><span class="line">          <span class="attr">secondary</span>: <span class="string">'#FFC75F'</span>,</span><br><span class="line">          <span class="attr">accent</span>: <span class="string">'#FF6B6B'</span>,</span><br><span class="line">          <span class="attr">neutral</span>: <span class="string">'#845EC2'</span>,</span><br><span class="line">          <span class="string">'base-100'</span>: <span class="string">'#F9F9F9'</span>, <span class="comment">// 修正 base 键名</span></span><br><span class="line">          <span class="string">'base-200'</span>: <span class="string">'#eeeeee'</span>,</span><br><span class="line">          <span class="string">'base-300'</span>: <span class="string">'#dddddd'</span>,</span><br><span class="line">          <span class="attr">info</span>: <span class="string">'#4D8076'</span>,</span><br><span class="line">          <span class="attr">success</span>: <span class="string">'#7BBA7A'</span>,</span><br><span class="line">          <span class="attr">warning</span>: <span class="string">'#FFB347'</span>,</span><br><span class="line">          <span class="attr">error</span>: <span class="string">'#FF6B6B'</span>,</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="built_in">require</span>(<span class="string">"daisyui"</span>)], <span class="comment">// 加载 DaisyUI 插件</span></span><br><span class="line">  <span class="attr">daisyui</span>: { <span class="comment">// DaisyUI 主题配置</span></span><br><span class="line">    <span class="attr">themes</span>: [{</span><br><span class="line">        <span class="attr">tropicalLight</span>: { <span class="comment">// 你的自定义主题名</span></span><br><span class="line">          <span class="string">"primary"</span>: <span class="string">"#00C9A7"</span>,</span><br><span class="line">          <span class="string">"secondary"</span>: <span class="string">"#FFC75F"</span>,</span><br><span class="line">          <span class="string">"accent"</span>: <span class="string">"#FF6B6B"</span>,</span><br><span class="line">          <span class="string">"neutral"</span>: <span class="string">"#845EC2"</span>,</span><br><span class="line">          <span class="string">"base-100"</span>: <span class="string">"#F9F9F9"</span>,</span><br><span class="line">          <span class="string">"base-200"</span>: <span class="string">"#eeeeee"</span>,</span><br><span class="line">          <span class="string">"base-300"</span>: <span class="string">"#dddddd"</span>,</span><br><span class="line">          <span class="string">"info"</span>: <span class="string">"#4D8076"</span>,</span><br><span class="line">          <span class="string">"success"</span>: <span class="string">"#7BBA7A"</span>,</span><br><span class="line">          <span class="string">"warning"</span>: <span class="string">"#FFB347"</span>,</span><br><span class="line">          <span class="string">"error"</span>: <span class="string">"#FF6B6B"</span>,</span><br><span class="line">        },</span><br><span class="line">      },</span><br><span class="line">      <span class="string">"light"</span> <span class="comment">// 也包含内置的 light 主题</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">darkTheme</span>: <span class="string">"light"</span>, <span class="comment">// 默认暗色模式时使用的主题</span></span><br><span class="line">    <span class="attr">logs</span>: <span class="literal">true</span>, <span class="comment">// 开发时显示日志</span></span><br><span class="line">  },</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li><li><p>创建 Tailwind CSS 基础文件:</p><p>在 src/assets/style/ 目录下创建 common.css (或其他名称如 main.css) 文件，添加以下内容：</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/assets/style/common.css */</span></span><br><span class="line"><span class="keyword">@tailwind</span> base;</span><br><span class="line"><span class="keyword">@tailwind</span> components;</span><br><span class="line"><span class="keyword">@tailwind</span> utilities;</span><br></pre></td></tr></tbody></table></figure></li><li><p>在 main.ts 中引入 CSS:</p><p>修改 src/main.ts 文件，确保引入了上述 CSS 文件：</p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.ts</span></span><br><span class="line"><span class="keyword">import</span> { createApp } <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./assets/style/common.css'</span> <span class="comment">// 确保路径和文件名正确</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">mount</span>(<span class="string">'#app'</span>)</span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>安装 <code>socket.io-client</code>:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install socket.io-client</span><br></pre></td></tr></tbody></table></figure></li></ol><p>####### 前端基础组件 (App.vue)</p><p>用以下内容 <strong>完全替换</strong> <code>src/App.vue</code> 文件的内容：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">&lt;script lang="ts" setup&gt;</span><br><span class="line">import { ref, onMounted, onUnmounted, computed } from 'vue'</span><br><span class="line">import { Socket } from 'socket.io-client'</span><br><span class="line"></span><br><span class="line">// --- 响应式状态 ---</span><br><span class="line">const socket = ref&lt;Socket | undefined&gt;()    // Socket.IO 实例</span><br><span class="line">const called = ref(false)                   // 当前用户是否是接收方</span><br><span class="line">const caller = ref(false)                   // 当前用户是否是发起方</span><br><span class="line">const calling = ref(false)                  // 是否处于"呼叫中"状态</span><br><span class="line">const communicating = ref(false)            // 是否正在视频通话中</span><br><span class="line">const localVideo = ref&lt;HTMLVideoElement | null&gt;(null)  // 本地视频元素引用</span><br><span class="line">const remoteVideo = ref&lt;HTMLVideoElement | null&gt;(null) // 远端视频元素引用</span><br><span class="line">const currentTheme = ref('tropicalLight')   // 当前主题</span><br><span class="line">const errorMessage = ref('')                // 错误信息</span><br><span class="line">const roomId = ref('room001')               // 房间ID</span><br><span class="line">const status = ref('空闲')                  // 连接状态</span><br><span class="line">const stats = ref&lt;any&gt;(null)                // WebRTC 统计信息</span><br><span class="line"></span><br><span class="line">// WebRTC 配置</span><br><span class="line">const iceServers = [</span><br><span class="line">  'stun:stun.l.google.com:19302',</span><br><span class="line">  'stun:stun1.l.google.com:19302',</span><br><span class="line">  'stun:stun2.l.google.com:19302',</span><br><span class="line">  'stun:stun3.l.google.com:19302',</span><br><span class="line">  'stun:stun4.l.google.com:19302'</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">// --- 状态组 - 用于计算属性 ---</span><br><span class="line">const successStates = ['已连接', '通话中']</span><br><span class="line">const infoStates = ['连接中', '连接信令服务器...', '正在连接...', '呼叫中...',</span><br><span class="line">  '收到呼叫邀请', '对方已接受，正准备连接...']</span><br><span class="line">const errorStates = ['错误']</span><br><span class="line"></span><br><span class="line">// --- 计算属性 ---</span><br><span class="line">const statusClass = computed(() =&gt; {</span><br><span class="line">  if (successStates.includes(status.value)) return 'badge-success'</span><br><span class="line">  if (infoStates.includes(status.value)) return 'badge-info'</span><br><span class="line">  if (errorStates.includes(status.value)) return 'badge-error'</span><br><span class="line">  return 'badge-neutral' // 默认（空闲、已断开等状态）</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">// --- 生命周期钩子 ---</span><br><span class="line">onMounted(() =&gt; {</span><br><span class="line">  console.log("App 组件已挂载")</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">onUnmounted(() =&gt; {</span><br><span class="line">  console.log("App 组件即将卸载")</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">// --- 业务方法 ---</span><br><span class="line">function callRemote() {</span><br><span class="line">  console.log('发起视频 (待实现)')</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">function acceptCall() {</span><br><span class="line">  console.log('同意视频邀请 (待实现)')</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">function hangUp() {</span><br><span class="line">  console.log('挂断视频 (待实现)')</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// --- 辅助函数 ---</span><br><span class="line">function cleanupRTC() {</span><br><span class="line">  console.log("清理 WebRTC (待实现)")</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">function resetStates() {</span><br><span class="line">  console.log("重置状态 (待实现)")</span><br><span class="line">}</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="min-h-screen bg-base-100 transition-colors duration-300 font-sans" :data-theme="currentTheme"&gt;</span><br><span class="line">    &lt;div class="flex flex-col items-center justify-between p-4 md:p-8 min-h-screen"&gt;</span><br><span class="line">      &lt;!-- 标题卡片 --&gt;</span><br><span class="line">      &lt;div class="card w-full max-w-3xl bg-base-200 shadow-xl mb-4"&gt;</span><br><span class="line">        &lt;div class="card-body items-center text-center"&gt;</span><br><span class="line">          &lt;h2 class="card-title text-xl md:text-2xl"&gt;简单易用的视频通话解决方案&lt;/h2&gt;</span><br><span class="line">          &lt;p class="text-sm md:text-base"&gt;使用WebRTC技术，实现高质量的视频通话&lt;/p&gt;</span><br><span class="line">          &lt;p class="mt-2"&gt;</span><br><span class="line">            状态: &lt;span :class="statusClass" class="font-semibold badge badge-md md:badge-lg text-white"&gt;{{ status</span><br><span class="line">            }}&lt;/span&gt;</span><br><span class="line">          &lt;/p&gt;</span><br><span class="line">          &lt;p v-if="errorMessage" class="text-error text-sm mt-1"&gt;{{ errorMessage }}&lt;/p&gt;</span><br><span class="line">          &lt;p class="text-sm mt-1 text-gray-500"&gt;房间号: {{ roomId }}&lt;/p&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- 视频区域 --&gt;</span><br><span class="line">      &lt;div class="relative w-full max-w-3xl aspect-video bg-black rounded-lg overflow-hidden shadow-lg"&gt;</span><br><span class="line">        &lt;!-- 本地视频 --&gt;</span><br><span class="line">        &lt;video ref="localVideo" autoplay playsinline muted</span><br><span class="line">          class="absolute inset-0 w-full h-full object-cover z-0 main-video"&gt;&lt;/video&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 远程视频 --&gt;</span><br><span class="line">        &lt;video ref="remoteVideo" autoplay playsinline</span><br><span class="line">          class="w-1/4 max-w-[160px] h-auto absolute bottom-4 right-4 object-cover border-2 border-base-300 rounded shadow-md z-10 transition-opacity duration-300 remote-video"</span><br><span class="line">          :class="{ 'opacity-0 pointer-events-none': !communicating }"&gt;&lt;/video&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 等待对方接听弹窗 --&gt;</span><br><span class="line">        &lt;dialog id="waiting_modal" class="modal" :open="caller &amp;&amp; calling"&gt;</span><br><span class="line">          &lt;div class="modal-box"&gt;</span><br><span class="line">            &lt;h3 class="text-lg font-bold"&gt;等待对方接听...&lt;/h3&gt;</span><br><span class="line">            &lt;p class="py-4"&gt;请耐心等待对方接受您的视频邀请&lt;/p&gt;</span><br><span class="line">            &lt;div class="modal-action"&gt;</span><br><span class="line">              &lt;button class="btn btn-error" @click="hangUp"&gt;取消&lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;form method="dialog" class="modal-backdrop"&gt;&lt;button @click="hangUp"&gt;关闭&lt;/button&gt;&lt;/form&gt;</span><br><span class="line">        &lt;/dialog&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 接听邀请界面 --&gt;</span><br><span class="line">        &lt;div v-if="called &amp;&amp; calling"</span><br><span class="line">          class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-70 text-white z-20"&gt;</span><br><span class="line">          &lt;p class="mb-4 text-lg"&gt;收到视频邀请...&lt;/p&gt;</span><br><span class="line">          &lt;div class="flex gap-4"&gt;</span><br><span class="line">            &lt;button @click="hangUp" class="btn btn-circle btn-error btn-lg" aria-label="拒绝"&gt;✗&lt;/button&gt;</span><br><span class="line">            &lt;button @click="acceptCall" class="btn btn-circle btn-success btn-lg" aria-label="接受"&gt;✓&lt;/button&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- 控制按钮 --&gt;</span><br><span class="line">      &lt;div class="flex gap-4 mt-4"&gt;</span><br><span class="line">        &lt;button class="btn btn-primary text-white" @click="callRemote"</span><br><span class="line">          &gt;</span><br><span class="line">          发起视频</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">        &lt;button class="btn btn-error btn-outline" @click="hangUp" &gt;</span><br><span class="line">          挂断</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- 统计信息 --&gt;</span><br><span class="line">      &lt;div v-if="stats" class="mt-4 p-2 bg-base-300 rounded shadow w-full max-w-3xl"&gt;</span><br><span class="line">        &lt;h3 class="text-sm font-semibold mb-1"&gt;WebRTC 统计&lt;/h3&gt;</span><br><span class="line">        &lt;pre class="text-xs overflow-auto max-h-24 bg-base-100 p-1 rounded"&gt;{{ JSON.stringify(stats, null, 2) }}&lt;/pre&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;footer class="mt-auto pt-4 text-center text-xs text-base-content/70"&gt;</span><br><span class="line">        请确保 Python 信令服务器正在运行。</span><br><span class="line">      &lt;/footer&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">/* 基础布局样式 */</span><br><span class="line">.content-container {</span><br><span class="line">  display: flex;</span><br><span class="line">  flex-direction: column;</span><br><span class="line">  align-items: center;</span><br><span class="line">  justify-content: flex-start;</span><br><span class="line">  padding: 1rem;</span><br><span class="line">  min-height: 100vh;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">/* 视频容器样式 */</span><br><span class="line">.video-container {</span><br><span class="line">  position: relative;</span><br><span class="line">  width: 100%;</span><br><span class="line">  aspect-ratio: 16 / 9;</span><br><span class="line">  background-color: #000;</span><br><span class="line">  margin-bottom: 1rem;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">/* 视频元素共用样式 */</span><br><span class="line">.main-video,</span><br><span class="line">.remote-video {</span><br><span class="line">  display: block;</span><br><span class="line">  background-color: #222;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.main-video {</span><br><span class="line">  width: 100%;</span><br><span class="line">  height: 100%;</span><br><span class="line">  object-fit: cover;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.remote-video {</span><br><span class="line">  width: 25%;</span><br><span class="line">  height: auto;</span><br><span class="line">  max-width: 180px;</span><br><span class="line">  position: absolute;</span><br><span class="line">  bottom: 1rem;</span><br><span class="line">  right: 1rem;</span><br><span class="line">  border: 2px solid rgba(255, 255, 255, 0.5);</span><br><span class="line">  border-radius: 0.375rem;</span><br><span class="line">  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);</span><br><span class="line">  z-index: 10;</span><br><span class="line">  transition: opacity 0.3s ease-in-out;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.remote-video.hidden {</span><br><span class="line">  opacity: 0;</span><br><span class="line">  pointer-events: none;</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><p><strong>后端基础设置(server_flask.py)</strong></p><ol><li><p>安装依赖:</p><p>在你的 Python 后端项目目录中（例如 python-flask-server），激活虚拟环境，运行：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install Flask Flask-SocketIO eventlet</span><br></pre></td></tr></tbody></table></figure></li><li><p>创建 server_flask.py (初始代码):</p><p>创建 server_flask.py 文件，并写入以下初始代码：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server_flask.py (初始基础代码)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request <span class="comment"># 引入 Flask 和 request 对象 (用于获取 sid)</span></span><br><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> SocketIO, emit <span class="comment"># 仅引入需要的</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os <span class="comment"># 用于设置密钥</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 日志设置 ---</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">'%(asctime)s %(levelname)s:%(name)s: %(message)s'</span>)</span><br><span class="line">logger = logging.getLogger(<span class="string">"flask_socketio_server"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 创建 Flask 应用实例 ---</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = os.urandom(<span class="number">24</span>) <span class="comment"># 生成一个随机密钥</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 创建 Flask-SocketIO 实例 ---</span></span><br><span class="line"><span class="comment"># async_mode='eventlet' 明确指定使用 eventlet (需要已安装)</span></span><br><span class="line"><span class="comment"># cors_allowed_origins="*" 允许所有来源跨域 (开发方便)</span></span><br><span class="line">socketio = SocketIO(app, cors_allowed_origins=<span class="string">"*"</span>, async_mode=<span class="string">'eventlet'</span>)</span><br><span class="line"></span><br><span class="line">logger.info(<span class="string">"Flask-SocketIO 服务器准备就绪..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Socket.IO 事件处理 (初始) ---</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'connect'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_connect</span>():</span><br><span class="line">    <span class="string">"""处理新的客户端连接"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    logger.info(<span class="string">f"客户端已连接: sid=<span class="subst">{sid}</span>"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 发送连接成功事件给当前客户端</span></span><br><span class="line">        emit(<span class="string">'connectionSuccess'</span>, room=sid) <span class="comment"># 使用 room=sid 指定接收者</span></span><br><span class="line">        logger.info(<span class="string">f"已向 sid=<span class="subst">{sid}</span> 发送 connectionSuccess 事件"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f"向 sid=<span class="subst">{sid}</span> 发送 connectionSuccess 时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'disconnect'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_disconnect</span>():</span><br><span class="line">    <span class="string">"""处理客户端断开连接"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    logger.info(<span class="string">f"客户端已断开连接: sid=<span class="subst">{sid}</span>"</span>)</span><br><span class="line">    <span class="comment"># 后续步骤将添加离开房间的逻辑</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 主程序入口 ---</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    logger.info(<span class="string">"准备启动 Flask-SocketIO 服务器 on port 3000..."</span>)</span><br><span class="line">    <span class="comment"># 使用 socketio.run() 来启动服务器</span></span><br><span class="line">    <span class="comment"># host='0.0.0.0' 允许局域网访问</span></span><br><span class="line">    socketio.run(app, host=<span class="string">'0.0.0.0'</span>, port=<span class="number">3000</span>, debug=<span class="literal">True</span>, allow_unsafe_werkzeug=<span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure></li></ol><p>现在，项目的基本骨架已经搭建完毕。前端有了界面模板和初始状态，后端有了一个可以接受 Socket.IO 连接的基础服务器。</p><hr><h6 id="2-实现连接与房间加入"><a href="#2-实现连接与房间加入" class="headerlink" title="2.实现连接与房间加入"></a>2.实现连接与房间加入</h6><p><strong>目标:</strong></p><ul><li>前端连接到 Flask-SocketIO 后端，处理连接/错误/断开事件。</li><li>连接成功后，前端自动发送 <code>joinRoom</code> 事件。</li><li>后端处理 <code>joinRoom</code> 事件，管理房间成员。</li><li>后端在客户端断开时，处理其离开房间的逻辑。</li></ul><p><strong>1. 后端修改 (<code>server_flask.py</code>)</strong></p><ul><li><strong>新增:</strong> 添加了用于存储房间信息的 <code>rooms_data</code> 和 <code>sid_room</code> 全局字典。</li><li><strong>新增:</strong> 添加了处理客户端 <code>joinRoom</code> 事件的 <code>handle_join_room</code> 函数。</li><li><strong>修改:</strong> 更新了 <code>handle_disconnect</code> 函数，加入了客户端离开房间的清理逻辑。</li></ul><p><strong>请在 <code>server_flask.py</code> 中添加或修改以下代码：</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## server_flask.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ... (import, logger, app, socketio 定义保持不变) ...</span></span><br><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> SocketIO, emit, leave_room,join_room  <span class="comment"># 引入leave/join_room函数</span></span><br><span class="line"><span class="comment">## --- 新增：用于管理房间和客户端的数据结构 ---</span></span><br><span class="line">rooms_data: <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">set</span>[<span class="built_in">str</span>]] = {}</span><br><span class="line">sid_room: <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>] = {}</span><br><span class="line"><span class="comment">## -------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## --- Socket.IO 事件处理 ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## @socketio.on('connect') 处理器保持不变</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## --- 新增：处理 'joinRoom' 事件 ---</span></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'joinRoom'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_join_room</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理客户端加入房间的请求"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">'roomId'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> room_id: <span class="keyword">return</span> logger.warning(<span class="string">f"sid=<span class="subst">{sid}</span> joinRoom缺少roomId"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 离开旧房间逻辑 (如果需要切换房间)</span></span><br><span class="line">    <span class="keyword">if</span> sid <span class="keyword">in</span> sid_room:</span><br><span class="line">        old_room_id = sid_room[sid]</span><br><span class="line">        <span class="keyword">if</span> old_room_id != room_id:</span><br><span class="line">             logger.info(<span class="string">f"sid=<span class="subst">{sid}</span> 正在离开旧房间: <span class="subst">{old_room_id}</span>"</span>)</span><br><span class="line">             <span class="keyword">try</span>:</span><br><span class="line">                 leave_room(old_room_id, sid=sid)</span><br><span class="line">                 <span class="keyword">if</span> old_room_id <span class="keyword">in</span> rooms_data <span class="keyword">and</span> sid <span class="keyword">in</span> rooms_data[old_room_id]:</span><br><span class="line">                     rooms_data[old_room_id].discard(sid)</span><br><span class="line">                     <span class="keyword">if</span> <span class="keyword">not</span> rooms_data[old_room_id]: <span class="keyword">del</span> rooms_data[old_room_id]; logger.info(<span class="string">f"房间已移除(空): <span class="subst">{old_room_id}</span>"</span>)</span><br><span class="line">                 socketio.emit(<span class="string">'peerLeft'</span>, {<span class="string">'peerId'</span>: sid}, room=old_room_id)</span><br><span class="line">             <span class="keyword">except</span> Exception <span class="keyword">as</span> e: logger.error(<span class="string">f"处理sid=<span class="subst">{sid}</span>离开旧房间<span class="subst">{old_room_id}</span>出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">             <span class="keyword">if</span> sid <span class="keyword">in</span> sid_room: <span class="keyword">del</span> sid_room[sid] <span class="comment"># 确保移除旧映射</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加入新房间逻辑 (只有当用户不在这个房间时才执行核心加入操作)</span></span><br><span class="line">    <span class="keyword">if</span> sid <span class="keyword">not</span> <span class="keyword">in</span> sid_room <span class="keyword">or</span> sid_room[sid] != room_id:</span><br><span class="line">        logger.info(<span class="string">f"sid=<span class="subst">{sid}</span> 正在加入新房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            join_room(room_id, sid=sid) <span class="comment"># 加入 Socket.IO 房间</span></span><br><span class="line">            <span class="keyword">if</span> room_id <span class="keyword">not</span> <span class="keyword">in</span> rooms_data: rooms_data[room_id] = <span class="built_in">set</span>()</span><br><span class="line">            rooms_data[room_id].add(sid) <span class="comment"># 加入我们自己的跟踪集合</span></span><br><span class="line">            sid_room[sid] = room_id <span class="comment"># 更新映射</span></span><br><span class="line">            logger.info(<span class="string">f"sid=<span class="subst">{sid}</span> 已成功加入房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">            socketio.emit(<span class="string">'peerJoined'</span>, {<span class="string">'peerId'</span>: sid}, room=room_id, skip_sid=sid) <span class="comment"># 通知其他人</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e: logger.error(<span class="string">f"处理sid=<span class="subst">{sid}</span>加入新房间<span class="subst">{room_id}</span>出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.info(<span class="string">f"sid=<span class="subst">{sid}</span> 已在房间 <span class="subst">{room_id}</span> 中。"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## --- 修改：完善 'disconnect' 事件处理 ---</span></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'disconnect'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_disconnect</span>():</span><br><span class="line">    <span class="string">"""处理客户端断开连接"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    logger.info(<span class="string">f"客户端准备断开连接: sid=<span class="subst">{sid}</span>"</span>)</span><br><span class="line">    <span class="comment"># 查找该客户端所在的房间</span></span><br><span class="line">    <span class="keyword">if</span> sid <span class="keyword">in</span> sid_room:</span><br><span class="line">        room_id = sid_room.pop(sid) <span class="comment"># 从映射中移除并获取房间 ID</span></span><br><span class="line">        logger.info(<span class="string">f"客户端 sid=<span class="subst">{sid}</span> 正在从房间 <span class="subst">{room_id}</span> 断开..."</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># leave_room(room_id, sid=sid) # Flask-SocketIO 会自动处理离开房间</span></span><br><span class="line">            <span class="comment"># 从我们的数据结构中清理</span></span><br><span class="line">            <span class="keyword">if</span> room_id <span class="keyword">in</span> rooms_data:</span><br><span class="line">                rooms_data[room_id].discard(sid) <span class="comment"># 从房间成员列表中移除</span></span><br><span class="line">                logger.info(<span class="string">f"sid=<span class="subst">{sid}</span> 已从 rooms_data[<span class="subst">{room_id}</span>] 移除"</span>)</span><br><span class="line">                <span class="comment"># 如果房间变空，清理房间记录</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> rooms_data[room_id]:</span><br><span class="line">                    <span class="keyword">del</span> rooms_data[room_id]</span><br><span class="line">                    logger.info(<span class="string">f"房间已移除 (空): <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                     <span class="comment"># 通知房间内其他人该用户已离开</span></span><br><span class="line">                     logger.info(<span class="string">f"向房间 <span class="subst">{room_id}</span> 广播 peerLeft 事件 (来自 <span class="subst">{sid}</span>)"</span>)</span><br><span class="line">                     socketio.emit(<span class="string">'peerLeft'</span>, {<span class="string">'peerId'</span>: sid}, room=room_id) <span class="comment"># 通知其他人离开</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f"处理 sid=<span class="subst">{sid}</span> 离开房间 <span class="subst">{room_id}</span> (disconnect时) 出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="comment"># finally 块不再需要，因为 pop 已经处理了映射移除</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">         logger.info(<span class="string">f"客户端 sid=<span class="subst">{sid}</span> 断开连接时不在任何已记录的房间中。"</span>)</span><br><span class="line">    logger.info(<span class="string">f"客户端 sid=<span class="subst">{sid}</span> 清理完成。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## if __name__ == '__main__': ... (保持不变)</span></span><br></pre></td></tr></tbody></table></figure><p><strong>2. 前端修改 (<code>src/App.vue</code>)</strong></p><ul><li><strong>修改:</strong> 更新 <code>onMounted</code> 钩子，在连接成功后发送 <code>joinRoom</code> 事件，并添加必要的错误和断开连接处理。添加可选的 <code>peerJoined</code> 和 <code>peerLeft</code> 监听器。</li><li><strong>修改:</strong> 更新 <code>onUnmounted</code> 钩子，确保断开 Socket.IO 连接。</li><li><strong>新增:</strong> 添加 <code>cleanupWebSocket</code> 和 <code>resetStates</code> 辅助函数（或确保它们已定义）。</li></ul><p><strong>请在 <code>src/App.vue</code> 的 <code>&lt;script setup&gt;</code> 部分替换或添加以下代码：</strong></p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --- 添加清理 WebSocket 的辅助函数 ---</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">cleanupWebSocket</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">   <span class="keyword">if</span> (socket.<span class="property">value</span>) {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"清理 Socket.IO 连接..."</span>);</span><br><span class="line">      socket.<span class="property">value</span>.<span class="title function_">off</span>(); <span class="comment">// 移除所有监听器</span></span><br><span class="line">      <span class="keyword">if</span> (socket.<span class="property">value</span>.<span class="property">connected</span>) {</span><br><span class="line">          socket.<span class="property">value</span>.<span class="title function_">disconnect</span>();</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Socket.IO 已断开。"</span>);</span><br><span class="line">      }</span><br><span class="line">      socket.<span class="property">value</span> = <span class="literal">null</span>;</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 添加或更新重置状态的辅助函数 ---</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">resetStates</span> = (<span class="params"><span class="attr">keepError</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>) =&gt; {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"重置状态..."</span>);</span><br><span class="line">  caller.<span class="property">value</span> = <span class="literal">false</span>; called.<span class="property">value</span> = <span class="literal">false</span>; calling.<span class="property">value</span> = <span class="literal">false</span>; communicating.<span class="property">value</span> = <span class="literal">false</span>; isConnecting.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (!keepError) { errorMessage.<span class="property">value</span> = <span class="string">''</span>; }</span><br><span class="line">  <span class="keyword">if</span> (status.<span class="property">value</span> !== <span class="string">'错误'</span>) { <span class="title function_">setStatus</span>(socket.<span class="property">value</span>?.<span class="property">connected</span> ? <span class="string">'已连接信令服务器'</span> : <span class="string">'空闲'</span>); }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 添加或更新设置状态的辅助函数 ---</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">setStatus</span> = (<span class="params"><span class="attr">newStatus</span>: <span class="built_in">string</span>, <span class="attr">errorMsg</span>: <span class="built_in">string</span> = <span class="string">''</span></span>) =&gt; {</span><br><span class="line">  status.<span class="property">value</span> = newStatus;</span><br><span class="line">  errorMessage.<span class="property">value</span> = errorMsg;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`状态更新: <span class="subst">${newStatus}</span><span class="subst">${errorMsg ? <span class="string">' - '</span> + errorMsg : <span class="string">''</span>}</span>`</span>);</span><br><span class="line">  <span class="keyword">if</span> (newStatus === <span class="string">'错误'</span>) { isConnecting.<span class="property">value</span> = <span class="literal">false</span>; }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 添加或更新挂断清理逻辑 ---</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">hangUpCleanup</span> = (<span class="params"><span class="attr">isUserAction</span>: <span class="built_in">boolean</span> = <span class="literal">true</span></span>) =&gt; {</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`执行本地挂断清理 (用户操作: <span class="subst">${isUserAction}</span>)...`</span>);</span><br><span class="line">     <span class="title function_">cleanupRTC</span>(); <span class="comment">// 清理 WebRTC 资源 (当前为空，后续实现)</span></span><br><span class="line">     <span class="title function_">resetStates</span>(!isUserAction); <span class="comment">// 重置界面状态变量，错误触发时保留错误信息</span></span><br><span class="line">     <span class="keyword">if</span> (isUserAction &amp;&amp; status.<span class="property">value</span> !== <span class="string">'错误'</span>) { <span class="title function_">setStatus</span>(<span class="string">'已挂断'</span>); }</span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (!isUserAction &amp;&amp; status.<span class="property">value</span> !== <span class="string">'错误'</span>) { <span class="title function_">setStatus</span>(<span class="string">'对方已挂断'</span>); } <span class="comment">// 区分状态</span></span><br><span class="line">      <span class="comment">// 短暂显示后恢复</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">           <span class="keyword">if</span> (status.<span class="property">value</span> === <span class="string">'已挂断'</span> || status.<span class="property">value</span> === <span class="string">'对方已挂断'</span>) {</span><br><span class="line">              <span class="title function_">setStatus</span>(socket.<span class="property">value</span>?.<span class="property">connected</span> ? <span class="string">'已连接信令服务器'</span> : <span class="string">'空闲'</span>);</span><br><span class="line">           }</span><br><span class="line">        }, <span class="number">1500</span>);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 修改 onMounted ---</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"App 组件已挂载，开始连接信令服务器..."</span>);</span><br><span class="line">  <span class="comment">// --- 替换之前的 onMounted 连接逻辑 ---</span></span><br><span class="line">  <span class="keyword">const</span> socketInstance = <span class="title function_">io</span>(<span class="string">'http://localhost:3000'</span>, { <span class="comment">// 连接到 Flask 后端</span></span><br><span class="line">      <span class="attr">transports</span>: [<span class="string">'websocket'</span>] <span class="comment">// 推荐指定 transport</span></span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"connect"</span>, <span class="function">() =&gt;</span> { <span class="comment">// 使用标准的 'connect' 事件</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Socket.IO 连接成功, sid:"</span>, socketInstance.<span class="property">id</span>);</span><br><span class="line">    <span class="title function_">setStatus</span>(<span class="string">'已连接信令服务器'</span>); <span class="comment">// 使用辅助函数更新状态</span></span><br><span class="line">    <span class="comment">// 连接成功后立即发送加入房间事件</span></span><br><span class="line">    <span class="keyword">if</span> (socket.<span class="property">value</span>) { <span class="comment">// 使用保存后的 ref</span></span><br><span class="line">        socket.<span class="property">value</span>.<span class="title function_">emit</span>(<span class="string">'joinRoom'</span>, { <span class="attr">roomId</span>: roomId.<span class="property">value</span> });</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`已发送加入房间请求: <span class="subst">${roomId.value}</span>`</span>);</span><br><span class="line">    } <span class="keyword">else</span> { <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"Socket 实例未就绪无法加入房间"</span>); }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"connectionSuccess"</span>, <span class="function">() =&gt;</span> { <span class="comment">// 仍然可以监听自定义确认事件</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"收到来自服务器的 connectionSuccess 确认"</span>);</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"connect_error"</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"连接错误:"</span>, err);</span><br><span class="line">      <span class="title function_">setStatus</span>(<span class="string">'错误'</span>, <span class="string">`无法连接信令服务器: <span class="subst">${err.message}</span>`</span>);</span><br><span class="line">      <span class="title function_">cleanupWebSocket</span>(); <span class="comment">// 清理实例</span></span><br><span class="line">      <span class="title function_">cleanupRTC</span>();</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">   socketInstance.<span class="title function_">on</span>(<span class="string">"disconnect"</span>, <span class="function">(<span class="params">reason</span>) =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"与服务器断开连接:"</span>, reason);</span><br><span class="line">      <span class="keyword">if</span> (status.<span class="property">value</span> !== <span class="string">'错误'</span> &amp;&amp; status.<span class="property">value</span> !== <span class="string">'已挂断'</span>) {</span><br><span class="line">           <span class="title function_">setStatus</span>(<span class="string">'已断开'</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="title function_">resetStates</span>(status.<span class="property">value</span> === <span class="string">'错误'</span>); <span class="comment">// 如果是因错误断开，保留错误信息</span></span><br><span class="line">      <span class="title function_">cleanupRTC</span>();</span><br><span class="line">      socket.<span class="property">value</span> = <span class="literal">null</span>; <span class="comment">// 清理 ref</span></span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// --- 新增：监听房间成员变化事件 (可选) ---</span></span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"peerJoined"</span>, <span class="function">(<span class="params"><span class="attr">data</span>: { peerId: <span class="built_in">string</span> }</span>) =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`通知: 对等端 <span class="subst">${data.peerId}</span> 加入了房间`</span>);</span><br><span class="line">      <span class="comment">// 可在此处更新 UI</span></span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"peerLeft"</span>, <span class="function">(<span class="params"><span class="attr">data</span>: { peerId: <span class="built_in">string</span> }</span>) =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`通知: 对等端 <span class="subst">${data.peerId}</span> 离开了房间`</span>);</span><br><span class="line">      <span class="comment">// 可在此处更新 UI 或处理通话中断</span></span><br><span class="line">       <span class="keyword">if</span> (communicating.<span class="property">value</span>) { <span class="comment">// 如果正在通话中，对方离开了</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"通话中的对方已离开房间！"</span>);</span><br><span class="line">            <span class="title function_">hangUpCleanup</span>(<span class="literal">false</span>); <span class="comment">// 触发本地挂断清理</span></span><br><span class="line">            <span class="title function_">setStatus</span>(<span class="string">"对方已离开"</span>);</span><br><span class="line">       }</span><br><span class="line">  });</span><br><span class="line">  <span class="comment">// -------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// --- 保留后续步骤将使用的事件监听器占位符 ---</span></span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"callRemote"</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> { <span class="comment">/* 第 3 步实现 */</span> });</span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"acceptCall"</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> { <span class="comment">/* 第 3 步实现 */</span> });</span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"hangUp"</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> { <span class="comment">/* 第 3 步实现 */</span> });</span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"offer"</span>, <span class="title function_">async</span> (data) =&gt; { <span class="comment">/* 第 4 步实现 */</span> });</span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"answer"</span>, <span class="title function_">async</span> (data) =&gt; { <span class="comment">/* 第 4 步实现 */</span> });</span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"candidate"</span>, <span class="title function_">async</span> (data) =&gt; { <span class="comment">/* 第 5 步实现 */</span> });</span><br><span class="line">  <span class="comment">// ------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  socket.<span class="property">value</span> = socketInstance; <span class="comment">// !!! 关键：保存 Socket.IO 实例到 ref !!!</span></span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 修改 onUnmounted ---</span></span><br><span class="line"><span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"组件即将卸载，断开连接并清理..."</span>);</span><br><span class="line">    <span class="title function_">hangUpCleanup</span>(<span class="literal">false</span>); <span class="comment">// 尝试清理通话状态和资源</span></span><br><span class="line">    <span class="title function_">cleanupWebSocket</span>(); <span class="comment">// 确保 WebSocket 关闭</span></span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- WebRTC 相关占位函数 ---</span></span><br><span class="line"><span class="comment">// cleanupRTC 占位符（如果上面没实现完整版）</span></span><br><span class="line"><span class="comment">// const cleanupRTC = () =&gt; { console.log("清理 WebRTC (待实现)..."); };</span></span><br><span class="line"><span class="comment">// 其他 WebRTC 函数占位符...</span></span><br><span class="line"><span class="keyword">const</span> getLocalStream = <span class="title function_">async</span> (): <span class="title class_">Promise</span>&lt;<span class="title class_">MediaStream</span> | <span class="literal">undefined</span>&gt; =&gt; { </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"getLocalStream 待实现！"</span>); </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">undefined</span>; </span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createPeerConnectionAndAddTracks = (): <span class="title class_">RTCPeerConnection</span> | <span class="function"><span class="params">null</span> =&gt;</span> { </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"createPeerConnectionAndAddTracks 待实现！"</span>); </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>; </span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// callRemote, acceptCall, hangUp 的占位符保持不变 (它们会在下一步被完整实现)</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">callRemote</span> = (<span class="params"></span>) =&gt; { </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'发起视频 (待实现)'</span>); </span><br><span class="line">  caller.<span class="property">value</span> = <span class="literal">true</span>; </span><br><span class="line">  calling.<span class="property">value</span> = <span class="literal">true</span>; </span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">acceptCall</span> = (<span class="params"></span>) =&gt; { </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'同意视频邀请 (待实现)'</span>); </span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">hangUp</span> = (<span class="params"></span>) =&gt; { </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'挂断视频 (待实现)'</span>); </span><br><span class="line">  caller.<span class="property">value</span> = <span class="literal">false</span>; </span><br><span class="line">  calling.<span class="property">value</span> = <span class="literal">false</span>; </span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure><p><strong>测试:</strong></p><ol><li>重启后端 (<code>python server_flask.py</code>)。</li><li>用 <strong>两个</strong> 浏览器窗口打开前端页面。</li><li><strong>检查后端日志:</strong> 确认两个客户端都连接成功，并且都加入了 <code>room001</code>。</li><li><strong>检查第一个窗口的控制台:</strong> 应该能看到第二个窗口加入房间的 <code>peerJoined</code> 通知。</li><li>关闭第二个窗口:<ul><li>检查后端日志：确认第二个客户端断开连接并已从房间移除。</li><li>检查第一个窗口的控制台：应该能看到第二个窗口离开房间的 <code>peerLeft</code> 通知。</li></ul></li></ol><p>现在，基本的连接和房间管理功能已经完成并且前后端能够正确交互了。</p><hr><h6 id="3-实现呼叫信令-请求-接受-挂断"><a href="#3-实现呼叫信令-请求-接受-挂断" class="headerlink" title="3.实现呼叫信令 (请求/接受/挂断)"></a>3.实现呼叫信令 (请求/接受/挂断)</h6><p><strong>目标:</strong></p><ul><li>用户点击“发起视频”按钮时，前端发送 <code>callRemote</code> 事件。</li><li>房间内其他用户收到 <code>callRemote</code> 事件，更新 UI 显示“收到呼叫邀请”。</li><li>收到邀请的用户点击“接受”按钮，前端发送 <code>acceptCall</code> 事件。</li><li>发起方收到 <code>acceptCall</code> 事件，更新 UI 显示“对方已接受”。</li><li>任何一方点击“挂断”或收到 <code>hangUp</code> 事件，都能结束当前呼叫/通话状态并清理。</li></ul><p><strong>1. 后端修改 (<code>server_flask.py</code>)</strong></p><p>在 <code>server_flask.py</code> 的 “Socket.IO 事件处理” 部分，<strong>添加</strong> 以下三个新的事件处理器，用于转发呼叫相关的信令：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## server_flask.py (在 handle_join_room 和 handle_disconnect 之间或之后添加)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## --- 新增：处理呼叫相关信令事件 ---</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'callRemote'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_call_remote</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理发起呼叫请求，并转发给同房间其他人"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">'roomId'</span>) <span class="comment"># 前端发送时应包含 roomId</span></span><br><span class="line">    logger.info(<span class="string">f"收到来自 sid=<span class="subst">{sid}</span> 的 callRemote 请求，房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">    <span class="keyword">if</span> room_id <span class="keyword">and</span> room_id <span class="keyword">in</span> rooms_data:</span><br><span class="line">        <span class="comment"># 将呼叫请求事件转发给房间内的其他人，并附带发起者 ID</span></span><br><span class="line">        <span class="comment"># 前端应监听 'callRemote' 事件</span></span><br><span class="line">        emit(<span class="string">'callRemote'</span>, {<span class="string">'callerId'</span>: sid}, room=room_id, skip_sid=sid)</span><br><span class="line">        logger.info(<span class="string">f"已将 callRemote 事件转发给房间 <span class="subst">{room_id}</span> (除 <span class="subst">{sid}</span> 外)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f"无法转发 callRemote：房间 <span class="subst">{room_id}</span> 无效或用户不在房间内。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'acceptCall'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_accept_call</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理接受呼叫请求，并转发给发起方（或其他同房间的人）"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">'roomId'</span>)</span><br><span class="line">    logger.info(<span class="string">f"收到来自 sid=<span class="subst">{sid}</span> 的 acceptCall 请求，房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">    <span class="keyword">if</span> room_id <span class="keyword">and</span> room_id <span class="keyword">in</span> rooms_data:</span><br><span class="line">        <span class="comment"># 将接受事件转发给房间内的其他人，并附带接受者 ID</span></span><br><span class="line">        <span class="comment"># 前端应监听 'acceptCall' 事件</span></span><br><span class="line">        emit(<span class="string">'acceptCall'</span>, {<span class="string">'accepterId'</span>: sid}, room=room_id, skip_sid=sid)</span><br><span class="line">        logger.info(<span class="string">f"已将 acceptCall 事件转发给房间 <span class="subst">{room_id}</span> (除 <span class="subst">{sid}</span> 外)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f"无法转发 acceptCall：房间 <span class="subst">{room_id}</span> 无效或用户不在房间内。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'hangUp'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_hang_up</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理挂断请求，并转发给同房间其他人"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">'roomId'</span>)</span><br><span class="line">    logger.info(<span class="string">f"收到来自 sid=<span class="subst">{sid}</span> 的 hangUp 请求，房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">    <span class="keyword">if</span> room_id <span class="keyword">and</span> room_id <span class="keyword">in</span> rooms_data:</span><br><span class="line">        <span class="comment"># 将挂断事件转发给房间内的其他人，并附带挂断者 ID</span></span><br><span class="line">        <span class="comment"># 前端应监听 'hangUp' 事件</span></span><br><span class="line">        emit(<span class="string">'hangUp'</span>, {<span class="string">'peerId'</span>: sid}, room=room_id, skip_sid=sid)</span><br><span class="line">        logger.info(<span class="string">f"已将 hangUp 事件转发给房间 <span class="subst">{room_id}</span> (除 <span class="subst">{sid}</span> 外)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f"无法转发 hangUp：房间 <span class="subst">{room_id}</span> 无效或用户不在房间内。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## ------------------------------------</span></span><br></pre></td></tr></tbody></table></figure><p><strong>2. 前端修改 (<code>src/App.vue</code>)</strong></p><p>在 <code>&lt;script setup lang="ts"&gt;</code> 内部：</p><ul><li><strong>新增</strong> <code>sendSignalingMessage</code> 辅助函数。</li><li><strong>替换</strong> <code>callRemote</code>, <code>acceptCall</code>, <code>hangUp</code> 的占位实现，加入状态更新和 <code>sendSignalingMessage</code> 调用。</li><li><strong>替换</strong> <code>resetStates</code> 和 <code>hangUpCleanup</code> 的占位实现。</li><li>在 <code>onMounted</code> 的 <code>socketInstance</code> 事件监听器中，<strong>替换</strong> <code>callRemote</code>, <code>acceptCall</code>, <code>hangUp</code> 的占位监听器，添加处理逻辑。</li></ul><p><strong>请在 <code>src/App.vue</code> 的 <code>&lt;script setup&gt;</code> 部分添加或替换以下代码：</strong></p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --- 新增：辅助函数 ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 统一设置状态和错误信息 (如果上一步没加，请加上)</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">setStatus</span> = (<span class="params"><span class="attr">newStatus</span>: <span class="built_in">string</span>, <span class="attr">errorMsg</span>: <span class="built_in">string</span> = <span class="string">''</span></span>) =&gt; {</span><br><span class="line">  status.<span class="property">value</span> = newStatus;</span><br><span class="line">  errorMessage.<span class="property">value</span> = errorMsg;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`状态更新: <span class="subst">${newStatus}</span><span class="subst">${errorMsg ? <span class="string">' - '</span> + errorMsg : <span class="string">''</span>}</span>`</span>);</span><br><span class="line">  <span class="keyword">if</span> (newStatus === <span class="string">'错误'</span>) { isConnecting.<span class="property">value</span> = <span class="literal">false</span>; }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 统一处理异步操作中的错误 (如果上一步没加，请加上)</span></span><br><span class="line"><span class="keyword">const</span> handleError = (<span class="attr">context</span>: <span class="built_in">string</span>, <span class="attr">error</span>: <span class="built_in">any</span>): <span class="function"><span class="params">null</span> =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`<span class="subst">${context}</span> 出错:`</span>, error);</span><br><span class="line">  <span class="title function_">setStatus</span>(<span class="string">'错误'</span>, <span class="string">`<span class="subst">${context}</span>失败: <span class="subst">${error <span class="keyword">instanceof</span> <span class="built_in">Error</span> ? error.message : <span class="built_in">String</span>(error)}</span>`</span>);</span><br><span class="line">  <span class="title function_">hangUpCleanup</span>(<span class="literal">false</span>); <span class="comment">// 出错时挂断</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 统一发送信令消息 (新增)</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">sendSignalingMessage</span> = (<span class="params"><span class="attr">type</span>: <span class="built_in">string</span>, <span class="attr">payload</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; = {}</span>) =&gt; {</span><br><span class="line">  <span class="keyword">if</span> (socket.<span class="property">value</span> &amp;&amp; socket.<span class="property">value</span>.<span class="property">connected</span>) {</span><br><span class="line">    <span class="keyword">const</span> message = { <span class="keyword">type</span>, <span class="attr">roomId</span>: roomId.<span class="property">value</span>, ...payload }; <span class="comment">// 自动添加 roomId</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`发送信令: <span class="subst">${<span class="keyword">type</span>}</span>`</span>, message);</span><br><span class="line">    <span class="comment">// Socket.IO emit 第一个参数是事件名，第二个是数据对象</span></span><br><span class="line">    socket.<span class="property">value</span>.<span class="title function_">emit</span>(<span class="keyword">type</span>, message);</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`无法发送信令 '<span class="subst">${<span class="keyword">type</span>}</span>'：Socket.IO 未连接。`</span>);</span><br><span class="line">    <span class="title function_">setStatus</span>(<span class="string">'错误'</span>, <span class="string">'信令服务器连接已断开'</span>);</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现/更新清理函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">cleanupRTC</span> = (<span class="params"></span>) =&gt; { <span class="comment">/* ... (保持之前的空实现或基础实现) ... */</span> };</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">cleanupWebSocket</span> = (<span class="params"></span>) =&gt; { <span class="comment">/* ... (保持之前的实现) ... */</span> };</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现/更新状态重置函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">resetStates</span> = (<span class="params"><span class="attr">keepError</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>) =&gt; {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"重置状态..."</span>);</span><br><span class="line">  caller.<span class="property">value</span> = <span class="literal">false</span>; called.<span class="property">value</span> = <span class="literal">false</span>; calling.<span class="property">value</span> = <span class="literal">false</span>; communicating.<span class="property">value</span> = <span class="literal">false</span>; isConnecting.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (!keepError) { errorMessage.<span class="property">value</span> = <span class="string">''</span>; }</span><br><span class="line">  <span class="keyword">if</span> (status.<span class="property">value</span> !== <span class="string">'错误'</span>) { <span class="title function_">setStatus</span>(socket.<span class="property">value</span>?.<span class="property">connected</span> ? <span class="string">'已连接信令服务器'</span> : <span class="string">'空闲'</span>); }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现/更新挂断清理函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">hangUpCleanup</span> = (<span class="params"><span class="attr">isUserAction</span>: <span class="built_in">boolean</span> = <span class="literal">true</span></span>) =&gt; {</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`执行本地挂断清理 (用户操作: <span class="subst">${isUserAction}</span>)...`</span>);</span><br><span class="line">     <span class="title function_">cleanupRTC</span>(); <span class="comment">// 清理 WebRTC (下一步会完善)</span></span><br><span class="line">     <span class="title function_">resetStates</span>(!isUserAction); <span class="comment">// 重置状态</span></span><br><span class="line">     <span class="keyword">const</span> finalStatus = isUserAction ? <span class="string">'已挂断'</span> : <span class="string">'对方已挂断'</span>;</span><br><span class="line">     <span class="keyword">if</span> (status.<span class="property">value</span> !== <span class="string">'错误'</span>) {</span><br><span class="line">        <span class="title function_">setStatus</span>(finalStatus);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">           <span class="keyword">if</span> (status.<span class="property">value</span> === finalStatus) { <span class="comment">// 检查状态是否仍是挂断状态</span></span><br><span class="line">              <span class="title function_">setStatus</span>(socket.<span class="property">value</span>?.<span class="property">connected</span> ? <span class="string">'已连接信令服务器'</span> : <span class="string">'空闲'</span>);</span><br><span class="line">           }</span><br><span class="line">        }, <span class="number">1500</span>);</span><br><span class="line">     }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 替换用户交互方法的占位实现 ---</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">callRemote</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; { <span class="comment">// 标记为 async 供后续使用</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'发起视频请求...'</span>);</span><br><span class="line">  <span class="keyword">if</span> (!socket.<span class="property">value</span>?.<span class="property">connected</span>) { <span class="keyword">return</span> <span class="title function_">setStatus</span>(<span class="string">'错误'</span>, <span class="string">"未连接到信令服务器"</span>); }</span><br><span class="line">  <span class="keyword">if</span> (communicating.<span class="property">value</span> || calling.<span class="property">value</span> || caller.<span class="property">value</span> || called.<span class="property">value</span>) { <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"已在通话或呼叫中"</span>); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// --- 下一步：获取本地流 ---</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"（模拟）获取本地流..."</span>);</span><br><span class="line">  <span class="comment">// const stream = await getLocalStream();</span></span><br><span class="line">  <span class="comment">// if (!stream) return;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新本地状态</span></span><br><span class="line">  caller.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">  calling.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">  <span class="title function_">setStatus</span>(<span class="string">'呼叫中...'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发送呼叫信令</span></span><br><span class="line">  <span class="title function_">sendSignalingMessage</span>(<span class="string">'callRemote'</span>); <span class="comment">// 使用辅助函数</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">acceptCall</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; { <span class="comment">// 标记为 async 供后续使用</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'接受视频邀请...'</span>);</span><br><span class="line">   <span class="keyword">if</span> (!socket.<span class="property">value</span>?.<span class="property">connected</span>) { <span class="keyword">return</span> <span class="title function_">setStatus</span>(<span class="string">'错误'</span>, <span class="string">"未连接到信令服务器"</span>); }</span><br><span class="line">   <span class="keyword">if</span> (!called.<span class="property">value</span> || !calling.<span class="property">value</span>) { <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"状态不符，无法接受"</span>); }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// --- 下一步：获取本地流 ---</span></span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"（模拟）获取本地流..."</span>);</span><br><span class="line">   <span class="comment">// const stream = await getLocalStream();</span></span><br><span class="line">   <span class="comment">// if (!stream) return;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// --- 下一步：创建 PeerConnection ---</span></span><br><span class="line">   <span class="comment">// const pc = createPeerConnectionAndAddTracks();</span></span><br><span class="line">   <span class="comment">// if (!pc) { sendSignalingMessage('hangUp'); hangUpCleanup(false); return; }</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 更新本地状态</span></span><br><span class="line">   calling.<span class="property">value</span> = <span class="literal">false</span>; <span class="comment">// 结束响铃</span></span><br><span class="line">   <span class="title function_">setStatus</span>(<span class="string">'正在连接...'</span>); <span class="comment">// 进入连接协商状态</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 发送接受信令</span></span><br><span class="line">   <span class="title function_">sendSignalingMessage</span>(<span class="string">'acceptCall'</span>);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">hangUp</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'请求挂断视频...'</span>);</span><br><span class="line">  <span class="title function_">sendSignalingMessage</span>(<span class="string">'hangUp'</span>); <span class="comment">// 发送挂断信令</span></span><br><span class="line">  <span class="title function_">hangUpCleanup</span>(<span class="literal">true</span>); <span class="comment">// 执行本地清理，标记为用户主动</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 在 onMounted 的 socketInstance 事件监听中填充逻辑 ---</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="comment">// ... (connectWebSocket 辅助函数或直接的 io() 连接逻辑) ...</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">connectWebSocket</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">      <span class="comment">// ... (这里包含 io() 连接和基础事件监听) ...</span></span><br><span class="line">      <span class="keyword">const</span> socketInstance = <span class="title function_">io</span>(<span class="string">'http://localhost:3000'</span>, { <span class="attr">transports</span>: [<span class="string">'websocket'</span>] });</span><br><span class="line"></span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"connect"</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Socket.IO 连接成功, sid:"</span>, socketInstance.<span class="property">id</span>);</span><br><span class="line">          <span class="title function_">setStatus</span>(<span class="string">'已连接信令服务器'</span>);</span><br><span class="line">          <span class="title function_">sendSignalingMessage</span>(<span class="string">'joinRoom'</span>); <span class="comment">// 使用辅助函数发送</span></span><br><span class="line">      });</span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"connectionSuccess"</span>, <span class="function">() =&gt;</span> { <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"收到 connectionSuccess 确认"</span>); });</span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"connect_error"</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> { <span class="title function_">handleError</span>(<span class="string">"Socket.IO 连接"</span>, err); }); <span class="comment">// 使用 handleError</span></span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"disconnect"</span>, <span class="function">(<span class="params">reason</span>) =&gt;</span> { <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"与服务器断开:"</span>, reason); <span class="keyword">if</span>(status.<span class="property">value</span> !== <span class="string">'错误'</span> &amp;&amp; status.<span class="property">value</span> !== <span class="string">'已挂断'</span>) <span class="title function_">setStatus</span>(<span class="string">'已断开'</span>); <span class="title function_">hangUpCleanup</span>(<span class="literal">false</span>); }); <span class="comment">// 断开时尝试清理</span></span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"peerJoined"</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> { <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`通知: <span class="subst">${data.peerId}</span> 加入`</span>); });</span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"peerLeft"</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> { <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`通知: <span class="subst">${data.peerId}</span> 离开`</span>); <span class="keyword">if</span>(communicating.<span class="property">value</span>){ <span class="title function_">hangUpCleanup</span>(<span class="literal">false</span>); <span class="title function_">setStatus</span>(<span class="string">'对方已离开'</span>);}});</span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"errorMsg"</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> { <span class="title function_">handleError</span>(<span class="string">"服务器信令"</span>, data.<span class="property">message</span> || <span class="string">"未知错误"</span>); }); <span class="comment">// 监听服务器错误</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// --- 替换/填充呼叫相关事件监听器 ---</span></span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"callRemote"</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> {</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"收到呼叫请求, 来自:"</span>, data?.<span class="property">callerId</span>);</span><br><span class="line">          <span class="keyword">if</span> (communicating.<span class="property">value</span> || calling.<span class="property">value</span> || caller.<span class="property">value</span> || called.<span class="property">value</span>) { <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"忙线中，忽略呼叫"</span>); <span class="keyword">return</span>; }</span><br><span class="line">          called.<span class="property">value</span> = <span class="literal">true</span>; calling.<span class="property">value</span> = <span class="literal">true</span>; <span class="title function_">setStatus</span>(<span class="string">'收到呼叫邀请'</span>);</span><br><span class="line">      });</span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"acceptCall"</span>, <span class="title function_">async</span> (data) =&gt; {</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"对方已接受呼叫, 来自:"</span>, data?.<span class="property">accepterId</span>);</span><br><span class="line">          <span class="keyword">if</span> (caller.<span class="property">value</span> &amp;&amp; calling.<span class="property">value</span>) { <span class="comment">// 确保是发起方且在呼叫中</span></span><br><span class="line">              calling.<span class="property">value</span> = <span class="literal">false</span>; <span class="title function_">setStatus</span>(<span class="string">'对方已接受，正准备连接...'</span>);</span><br><span class="line">              <span class="comment">// --- 下一步：触发 Offer 流程 ---</span></span><br><span class="line">               <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"下一步：创建并发送 Offer (待实现)"</span>);</span><br><span class="line">               <span class="comment">// await createOfferAndSend();</span></span><br><span class="line">          } <span class="keyword">else</span> { <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`收到 acceptCall 但状态不符, caller=<span class="subst">${caller.value}</span>, calling=<span class="subst">${calling.value}</span>`</span>); }</span><br><span class="line">      });</span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"hangUp"</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> {</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"收到对方挂断通知, 来自:"</span>, data?.<span class="property">peerId</span>);</span><br><span class="line">          <span class="title function_">hangUpCleanup</span>(<span class="literal">false</span>); <span class="comment">// 执行本地清理，标记为非用户主动</span></span><br><span class="line">      });</span><br><span class="line">      <span class="comment">// ----------------------------------</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// --- 保留 offer, answer, candidate 监听器占位 ---</span></span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"offer"</span>, <span class="title function_">async</span> (data) =&gt; { <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"收到 Offer (待处理)..."</span>); });</span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"answer"</span>, <span class="title function_">async</span> (data) =&gt; { <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"收到 Answer (待处理)..."</span>); });</span><br><span class="line">      socketInstance.<span class="title function_">on</span>(<span class="string">"candidate"</span>, <span class="title function_">async</span> (data) =&gt; { <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"收到 Candidate (待处理)..."</span>); });</span><br><span class="line">      <span class="comment">// ---------------------------------------------</span></span><br><span class="line"></span><br><span class="line">      socket.<span class="property">value</span> = socketInstance;</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="title function_">connectWebSocket</span>(); <span class="comment">// 调用连接函数</span></span><br><span class="line"></span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// onUnmounted 保持不变 (调用 hangUp 和 cleanupWebSocket)</span></span><br><span class="line"><span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"组件即将卸载，断开连接并清理..."</span>);</span><br><span class="line">    <span class="title function_">hangUp</span>(); <span class="comment">// 调用挂断逻辑（会尝试发信令并清理本地）</span></span><br><span class="line">    <span class="comment">// cleanupWebSocket(); // cleanupWebSocket 会在 socket disconnect 时自动触发或在 hangUp-&gt;resetStates 后被调用</span></span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure><p><strong>测试:</strong></p><p>重复上一步的测试流程：</p><ol><li>重启后端 (<code>python server_flask.py</code>)。</li><li>用两个浏览器窗口打开前端。</li><li>窗口 A 点击“发起视频”。检查状态和日志。</li><li>窗口 B 收到邀请，点击“接受”。检查双方状态和日志。</li><li>任一窗口点击“挂断”。检查双方状态是否正确重置，以及日志。</li></ol><p>现在，应用应该能够正确地处理发起、接受和挂断通话的信令流程了，并且 UI 状态会随之更新。</p><hr><h6 id="4-获取媒体流、创建-PeerConnection-并交换-SDP"><a href="#4-获取媒体流、创建-PeerConnection-并交换-SDP" class="headerlink" title="4.获取媒体流、创建 PeerConnection 并交换 SDP"></a>4.获取媒体流、创建 PeerConnection 并交换 SDP</h6><p><strong>目标:</strong></p><ol><li><strong>获取媒体:</strong> 在发起或接受呼叫时，通过 <code>getUserMedia</code> 请求摄像头和麦克风权限，获取本地 <code>MediaStream</code>。</li><li><strong>创建连接对象:</strong> 初始化 <code>RTCPeerConnection</code>。</li><li><strong>添加轨道:</strong> 将本地 <code>MediaStream</code> 中的音视频轨道添加到 <code>RTCPeerConnection</code>。</li><li>SDP 交换:<ul><li><strong>发起方:</strong> 收到对方接受 (<code>acceptCall</code>) 后，创建 Offer，设为本地描述，发送给对方。</li><li><strong>接收方:</strong> 收到 Offer 后，设为远端描述，创建 Answer，设为本地描述，发送给对方。</li><li><strong>发起方:</strong> 收到 Answer 后，设为远端描述。</li></ul></li></ol><p><strong>1. 后端修改 (<code>server_flask.py</code>)</strong></p><p>在 <code>server_flask.py</code> 的 “Socket.IO 事件处理” 部分，<strong>添加</strong> 用于转发 <code>offer</code> 和 <code>answer</code> 消息的事件处理器：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## server_flask.py (在 handle_hang_up 和 handle_candidate 之间或之后添加)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## --- 新增：处理 WebRTC Offer/Answer 转发 ---</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'offer'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_offer</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理收到的 Offer SDP，并转发给同房间其他人"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">'roomId'</span>)</span><br><span class="line">    sdp = data.get(<span class="string">'sdp'</span>)</span><br><span class="line">    offer_type_from_client = data.get(<span class="string">'offerType'</span>, <span class="string">'offer'</span>) <span class="comment"># 获取前端发送的类型</span></span><br><span class="line">    logger.info(<span class="string">f"收到来自 sid=<span class="subst">{sid}</span> 的 Offer，房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">    <span class="keyword">if</span> room_id <span class="keyword">and</span> room_id <span class="keyword">in</span> rooms_data <span class="keyword">and</span> sdp:</span><br><span class="line">        <span class="comment"># 将 Offer 事件和 SDP 转发给房间内的其他人</span></span><br><span class="line">        emit(<span class="string">'offer'</span>, {<span class="string">'senderId'</span>: sid, <span class="string">'sdp'</span>: sdp, <span class="string">'offerType'</span>: offer_type_from_client}, room=room_id, skip_sid=sid)</span><br><span class="line">        logger.info(<span class="string">f"已将 Offer 事件转发给房间 <span class="subst">{room_id}</span> (除 <span class="subst">{sid}</span> 外)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f"无法转发 Offer：房间 <span class="subst">{room_id}</span> 无效、用户不在房间或缺少SDP。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'answer'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_answer</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理收到的 Answer SDP，并转发给同房间其他人"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">'roomId'</span>)</span><br><span class="line">    sdp = data.get(<span class="string">'sdp'</span>)</span><br><span class="line">    answer_type_from_client = data.get(<span class="string">'answerType'</span>, <span class="string">'answer'</span>) <span class="comment"># 获取前端发送的类型</span></span><br><span class="line">    logger.info(<span class="string">f"收到来自 sid=<span class="subst">{sid}</span> 的 Answer，房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">    <span class="keyword">if</span> room_id <span class="keyword">and</span> room_id <span class="keyword">in</span> rooms_data <span class="keyword">and</span> sdp:</span><br><span class="line">        <span class="comment"># 将 Answer 事件和 SDP 转发给房间内的其他人</span></span><br><span class="line">        emit(<span class="string">'answer'</span>, {<span class="string">'senderId'</span>: sid, <span class="string">'sdp'</span>: sdp, <span class="string">'answerType'</span>: answer_type_from_client}, room=room_id, skip_sid=sid)</span><br><span class="line">        logger.info(<span class="string">f"已将 Answer 事件转发给房间 <span class="subst">{room_id}</span> (除 <span class="subst">{sid}</span> 外)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f"无法转发 Answer：房间 <span class="subst">{room_id}</span> 无效、用户不在房间或缺少SDP。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## ------------------------------------</span></span><br><span class="line"><span class="comment">## 其他事件处理器和主程序入口保持不变</span></span><br></pre></td></tr></tbody></table></figure><p><strong>2. 前端修改 (<code>src/App.vue</code>)</strong></p><p>在 <code>&lt;script setup lang="ts"&gt;</code> 内部：</p><ul><li><strong>替换</strong> <code>getLocalStream</code> 的占位实现。</li><li><strong>替换</strong> <code>createPeerConnectionAndAddTracks</code> 的占位实现（包含事件监听器框架）。</li><li><strong>修改</strong> <code>callRemote</code> 和 <code>acceptCall</code> 方法以调用 <code>getLocalStream</code> 和（对于 <code>acceptCall</code>）<code>createPeerConnectionAndAddTracks</code>。</li><li><strong>新增</strong> <code>createOfferAndSend</code>, <code>handleOfferAndCreateAnswer</code>, <code>handleAnswer</code> 三个辅助函数。</li><li><strong>修改</strong> <code>onMounted</code> 中的 <code>acceptCall</code> 监听器，使其调用 <code>createOfferAndSend</code>。</li><li><strong>新增</strong> <code>offer</code> 和 <code>answer</code> 事件的监听器。</li><li><strong>修改</strong> <code>cleanupRTC</code> 函数以确保停止本地流。</li></ul><p><strong>以下是需要替换或添加到 <code>App.vue</code> 中 <code>&lt;script setup&gt;</code> 部分的代码：</strong></p><figure class="highlight typescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --- WebRTC 核心逻辑 ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换占位符：实现获取本地媒体流</span></span><br><span class="line"><span class="keyword">const</span> getLocalStream = <span class="title function_">async</span> (): <span class="title class_">Promise</span>&lt;<span class="title class_">MediaStream</span> | <span class="literal">undefined</span>&gt; =&gt; {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"尝试获取本地媒体流..."</span>)</span><br><span class="line">  <span class="title function_">setStatus</span>(<span class="string">'请求摄像头权限...'</span>, <span class="string">''</span>);</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="comment">// 如果本地媒体流存在，先停止所有轨道</span></span><br><span class="line">    <span class="keyword">if</span> (localStream.<span class="property">value</span>) {</span><br><span class="line">      localStream.<span class="property">value</span>.<span class="title function_">getTracks</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">track</span> =&gt;</span> track.<span class="title function_">stop</span>());</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 请求摄像头权限</span></span><br><span class="line">    <span class="keyword">const</span> stream = <span class="keyword">await</span> navigator.<span class="property">mediaDevices</span>.<span class="title function_">getUserMedia</span>({ <span class="attr">audio</span>: <span class="literal">true</span>, <span class="attr">video</span>: { <span class="attr">width</span>: <span class="number">640</span>, <span class="attr">height</span>: <span class="number">480</span> } });</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'成功获取本地媒体流:'</span>, stream.<span class="property">id</span>);</span><br><span class="line">    localStream.<span class="property">value</span> = stream;</span><br><span class="line">    <span class="comment">// 如果视频元素有值，则设置对应的src属性</span></span><br><span class="line">    <span class="keyword">if</span> (localVideo.<span class="property">value</span>) {</span><br><span class="line">      localVideo.<span class="property">value</span>.<span class="property">srcObject</span> = stream;</span><br><span class="line">      localVideo.<span class="property">value</span>.<span class="title function_">play</span>().<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"本地视频播放失败:"</span>, e));</span><br><span class="line">      <span class="title function_">setStatus</span>(<span class="string">"本地视频已就绪"</span>)</span><br><span class="line">      <span class="keyword">return</span> stream;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> stream; <span class="comment">// 即使视频元素不存在也返回流</span></span><br><span class="line">  } <span class="keyword">catch</span> (<span class="attr">error</span>: <span class="built_in">any</span>) {</span><br><span class="line">    <span class="title function_">handleError</span>(<span class="string">"获取媒体流"</span>, error); <span class="comment">// 使用同一错误处理</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span>; </span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"><span class="comment">// 替换占位符：实现创建 PeerConnection 和添加轨道的辅助函数</span></span><br><span class="line"><span class="keyword">const</span> createPeerConnectionAndAddTracks = (): <span class="title class_">RTCPeerConnection</span> | <span class="function"><span class="params">null</span> =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"创建 PeerConnection 并添加轨道..."</span>);</span><br><span class="line">    <span class="keyword">if</span> (!localStream.<span class="property">value</span>) { <span class="keyword">return</span> <span class="title function_">handleError</span>(<span class="string">'创建 PC'</span>, <span class="string">'本地流无效'</span>); }</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="title function_">cleanupRTC</span>(); <span class="comment">// 清理旧连接</span></span><br><span class="line">        <span class="keyword">const</span> pcInstance = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>(pcConfig);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置事件监听器 (内部逻辑将在下一步完善)</span></span><br><span class="line">        pcInstance.<span class="property">onicecandidate</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> {</span><br><span class="line">             <span class="keyword">if</span> (event.<span class="property">candidate</span>) {</span><br><span class="line">                 <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'步骤5将处理: 发送本地 ICE Candidate...'</span>);</span><br><span class="line">                 <span class="comment">// sendSignalingMessage('candidate', { candidate: event.candidate.toJSON() });</span></span><br><span class="line">             } <span class="keyword">else</span> { <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"本地 ICE Candidate 收集完成。"</span>); }</span><br><span class="line">         };</span><br><span class="line">        pcInstance.<span class="property">ontrack</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> {</span><br><span class="line">             <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'步骤6将处理: 收到远端轨道...'</span>);</span><br><span class="line">             <span class="comment">// if (remoteVideo.value &amp;&amp; event.streams &amp;&amp; event.streams[0]) { ... }</span></span><br><span class="line">         };</span><br><span class="line">        pcInstance.<span class="property">onconnectionstatechange</span> = <span class="function">() =&gt;</span> {</span><br><span class="line">             <span class="keyword">if</span> (!peer.<span class="property">value</span>) <span class="keyword">return</span>;</span><br><span class="line">             <span class="keyword">const</span> state = peer.<span class="property">value</span>.<span class="property">connectionState</span>;</span><br><span class="line">             <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`PeerConnection 连接状态改变: <span class="subst">${state}</span>`</span>);</span><br><span class="line">              <span class="keyword">switch</span> (state) {</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'connecting'</span>: <span class="title function_">setStatus</span>(<span class="string">'连接中'</span>); isConnecting.<span class="property">value</span> = <span class="literal">true</span>; isConnected.<span class="property">value</span> = <span class="literal">false</span>; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'connected'</span>: <span class="title function_">setStatus</span>(<span class="string">'已连接'</span>); isConnecting.<span class="property">value</span> = <span class="literal">false</span>; isConnected.<span class="property">value</span> = <span class="literal">true</span>; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'disconnected'</span>: <span class="title function_">setStatus</span>(<span class="string">'已断开'</span>); isConnected.<span class="property">value</span> = <span class="literal">false</span>; isConnecting.<span class="property">value</span> = <span class="literal">false</span>; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'failed'</span>: <span class="title function_">handleError</span>(<span class="string">'WebRTC 连接'</span>, <span class="string">'连接失败'</span>); <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'closed'</span>: <span class="keyword">if</span>(status.<span class="property">value</span> !== <span class="string">'错误'</span> &amp;&amp; status.<span class="property">value</span> !== <span class="string">'已挂断'</span> &amp;&amp; status.<span class="property">value</span> !== <span class="string">'对方已挂断'</span>) <span class="title function_">setStatus</span>(<span class="string">'已断开'</span>); isConnected.<span class="property">value</span> = <span class="literal">false</span>; isConnecting.<span class="property">value</span> = <span class="literal">false</span>; <span class="keyword">break</span>;</span><br><span class="line">              }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加本地轨道</span></span><br><span class="line">        localStream.<span class="property">value</span>.<span class="title function_">getTracks</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">track</span> =&gt;</span> {</span><br><span class="line">            <span class="keyword">try</span> { pcInstance.<span class="title function_">addTrack</span>(track, localStream.<span class="property">value</span>!); }</span><br><span class="line">            <span class="keyword">catch</span> (e) { <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`添加本地 <span class="subst">${track.kind}</span> 轨道失败:`</span>, e); }</span><br><span class="line">        });</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"本地轨道已添加"</span>);</span><br><span class="line"></span><br><span class="line">        peer.<span class="property">value</span> = pcInstance; <span class="comment">// 保存到 ref</span></span><br><span class="line">        <span class="keyword">return</span> pcInstance;</span><br><span class="line">    } <span class="keyword">catch</span> (e) {</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">handleError</span>(<span class="string">'创建 PeerConnection'</span>, e);</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 新增：发起方创建并发送 Offer 的逻辑 ---</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createOfferAndSend</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; {</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"准备创建并发送 Offer..."</span>);</span><br><span class="line">   <span class="keyword">if</span> (!peer.<span class="property">value</span>) { <span class="keyword">return</span> <span class="title function_">handleError</span>(<span class="string">'创建 Offer'</span>, <span class="string">'PeerConnection 未创建'</span>); }</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'创建 Offer...'</span>);</span><br><span class="line">       <span class="keyword">const</span> offer = <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">createOffer</span>({ <span class="attr">offerToReceiveAudio</span>: <span class="literal">true</span>, <span class="attr">offerToReceiveVideo</span>: <span class="literal">true</span> });</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'设置本地 Offer 描述...'</span>);</span><br><span class="line">       <span class="comment">// 检查状态避免错误设置</span></span><br><span class="line">       <span class="keyword">if</span> (peer.<span class="property">value</span>.<span class="property">signalingState</span> !== <span class="string">'stable'</span> &amp;&amp; peer.<span class="property">value</span>.<span class="property">signalingState</span> !== <span class="string">'have-remote-offer'</span>) { <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`创建 Offer 时信令状态异常: <span class="subst">${peer.value.signalingState}</span>`</span>); }</span><br><span class="line">       <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">setLocalDescription</span>(offer);</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'通过信令服务器发送 Offer...'</span>);</span><br><span class="line">       <span class="title function_">sendSignalingMessage</span>(<span class="string">'offer'</span>, { <span class="attr">sdp</span>: peer.<span class="property">value</span>.<span class="property">localDescription</span>?.<span class="property">sdp</span>, <span class="attr">offerType</span>: peer.<span class="property">value</span>.<span class="property">localDescription</span>?.<span class="property">type</span> });</span><br><span class="line">   } <span class="keyword">catch</span> (error) {</span><br><span class="line">       <span class="title function_">handleError</span>(<span class="string">'创建或发送 Offer'</span>, error);</span><br><span class="line">   }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 新增：接收方处理 Offer 并创建/发送 Answer 的逻辑 ---</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleOfferAndCreateAnswer</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">offerData</span>: { sdp: <span class="built_in">string</span>, offerType: RTCSdpType }</span>) =&gt; {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"准备处理 Offer 并创建 Answer..."</span>);</span><br><span class="line">    <span class="comment">// 确保 PeerConnection 已在 acceptCall 中创建</span></span><br><span class="line">    <span class="keyword">if</span> (!peer.<span class="property">value</span>) { <span class="keyword">return</span> <span class="title function_">handleError</span>(<span class="string">'处理 Offer'</span>, <span class="string">'PeerConnection 未创建'</span>); }</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'设置远端 Offer 描述...'</span>);</span><br><span class="line">        <span class="keyword">if</span> (peer.<span class="property">value</span>.<span class="property">signalingState</span> !== <span class="string">'stable'</span> &amp;&amp; peer.<span class="property">value</span>.<span class="property">signalingState</span> !== <span class="string">'have-local-offer'</span>) { <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`设置远端 Offer 时信令状态异常: <span class="subst">${peer.value.signalingState}</span>`</span>); }</span><br><span class="line">        <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">setRemoteDescription</span>(<span class="keyword">new</span> <span class="title class_">RTCSessionDescription</span>({ <span class="attr">type</span>: <span class="string">'offer'</span>, <span class="attr">sdp</span>: offerData.<span class="property">sdp</span> }));</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'创建 Answer...'</span>);</span><br><span class="line">        <span class="keyword">const</span> answer = <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">createAnswer</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'设置本地 Answer 描述...'</span>);</span><br><span class="line">        <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">setLocalDescription</span>(answer);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'通过信令服务器发送 Answer...'</span>);</span><br><span class="line">        <span class="title function_">sendSignalingMessage</span>(<span class="string">'answer'</span>, { <span class="attr">sdp</span>: peer.<span class="property">value</span>.<span class="property">localDescription</span>?.<span class="property">sdp</span>, <span class="attr">answerType</span>: peer.<span class="property">value</span>.<span class="property">localDescription</span>?.<span class="property">type</span> });</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">        <span class="title function_">handleError</span>(<span class="string">'处理 Offer 或创建/发送 Answer'</span>, error);</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 新增：发起方处理 Answer 的逻辑 ---</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleAnswer</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">answerData</span>: { sdp: <span class="built_in">string</span>, answerType: RTCSdpType }</span>) =&gt; {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"准备处理 Answer..."</span>);</span><br><span class="line">    <span class="keyword">if</span> (!peer.<span class="property">value</span>) { <span class="keyword">return</span> <span class="title function_">handleError</span>(<span class="string">'处理 Answer'</span>, <span class="string">'PeerConnection 不存在'</span>); }</span><br><span class="line">    <span class="keyword">if</span> (peer.<span class="property">value</span>.<span class="property">signalingState</span> !== <span class="string">'have-local-offer'</span>) { <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`收到 Answer 但信令状态为 <span class="subst">${peer.value.signalingState}</span>，忽略。`</span>); }</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'设置远端 Answer 描述...'</span>);</span><br><span class="line">        <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">setRemoteDescription</span>(<span class="keyword">new</span> <span class="title class_">RTCSessionDescription</span>({ <span class="attr">type</span>: <span class="string">'answer'</span>, <span class="attr">sdp</span>: answerData.<span class="property">sdp</span> }));</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"远端 Answer 已设置，P2P 连接即将通过 ICE 建立..."</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">        <span class="title function_">handleError</span>(<span class="string">'设置远端 Answer'</span>, error);</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 修改用户交互方法 ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新 callRemote 方法，添加获取流</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">callRemote</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'发起视频请求...'</span>);</span><br><span class="line">  <span class="keyword">if</span> (!socket.<span class="property">value</span>?.<span class="property">connected</span>) { <span class="keyword">return</span> <span class="title function_">setStatus</span>(<span class="string">'错误'</span>, <span class="string">"未连接到信令服务器"</span>); }</span><br><span class="line">  <span class="keyword">if</span> (communicating.<span class="property">value</span> || calling.<span class="property">value</span> || caller.<span class="property">value</span> || called.<span class="property">value</span>) { <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"已在通话或呼叫中"</span>); }</span><br><span class="line">  <span class="comment">// 1. 获取本地流</span></span><br><span class="line">  <span class="keyword">const</span> stream = <span class="keyword">await</span> <span class="title function_">getLocalStream</span>();</span><br><span class="line">  <span class="keyword">if</span> (!stream) <span class="keyword">return</span>; <span class="comment">// 获取失败则中止</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 更新状态并发起呼叫</span></span><br><span class="line">  caller.<span class="property">value</span> = <span class="literal">true</span>; calling.<span class="property">value</span> = <span class="literal">true</span>; <span class="title function_">setStatus</span>(<span class="string">'呼叫中...'</span>);</span><br><span class="line">  <span class="title function_">sendSignalingMessage</span>(<span class="string">'callRemote'</span>); <span class="comment">// 发送呼叫信号</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"已发送 callRemote 事件，等待对方接受..."</span>);</span><br><span class="line">  <span class="comment">// Offer 创建将在收到 acceptCall 后进行</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新 acceptCall 方法，添加获取流和创建 PC</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">acceptCall</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'接受视频邀请...'</span>);</span><br><span class="line">   <span class="keyword">if</span> (!socket.<span class="property">value</span>?.<span class="property">connected</span>) { <span class="keyword">return</span> <span class="title function_">setStatus</span>(<span class="string">'错误'</span>, <span class="string">"未连接到信令服务器"</span>); }</span><br><span class="line">   <span class="keyword">if</span> (!called.<span class="property">value</span> || !calling.<span class="property">value</span>) { <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"状态不符，无法接受"</span>); }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 1. 获取本地流</span></span><br><span class="line">   <span class="keyword">const</span> stream = <span class="keyword">await</span> <span class="title function_">getLocalStream</span>();</span><br><span class="line">   <span class="keyword">if</span> (!stream) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 2. 创建 PeerConnection 并添加本地轨道</span></span><br><span class="line">   <span class="keyword">const</span> pc = <span class="title function_">createPeerConnectionAndAddTracks</span>();</span><br><span class="line">   <span class="keyword">if</span> (!pc) { <span class="comment">// 创建失败</span></span><br><span class="line">       <span class="title function_">sendSignalingMessage</span>(<span class="string">'hangUp'</span>); <span class="comment">// 通知对方挂断</span></span><br><span class="line">       <span class="title function_">hangUpCleanup</span>(<span class="literal">false</span>);</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 3. 更新状态并发送接受信令</span></span><br><span class="line">   calling.<span class="property">value</span> = <span class="literal">false</span>; <span class="title function_">setStatus</span>(<span class="string">'正在连接...'</span>);</span><br><span class="line">   <span class="title function_">sendSignalingMessage</span>(<span class="string">'acceptCall'</span>);</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"已发送 acceptCall 事件，准备接收 Offer..."</span>);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 修改 cleanupRTC 函数 ---</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">cleanupRTC</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"清理 WebRTC 资源..."</span>);</span><br><span class="line">    <span class="keyword">if</span> (statsIntervalId) { <span class="built_in">clearInterval</span>(statsIntervalId); statsIntervalId = <span class="literal">null</span>; stats.<span class="property">value</span> = <span class="literal">null</span>; }</span><br><span class="line">    <span class="keyword">if</span> (peer.<span class="property">value</span>) {</span><br><span class="line">        peer.<span class="property">value</span>.<span class="property">onicecandidate</span> = <span class="literal">null</span>; peer.<span class="property">value</span>.<span class="property">ontrack</span> = <span class="literal">null</span>; peer.<span class="property">value</span>.<span class="property">onconnectionstatechange</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            peer.<span class="property">value</span>.<span class="title function_">getSenders</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">sender</span> =&gt;</span> sender.<span class="property">track</span>?.<span class="title function_">stop</span>());</span><br><span class="line">            peer.<span class="property">value</span>.<span class="title function_">getReceivers</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">receiver</span> =&gt;</span> receiver.<span class="property">track</span>?.<span class="title function_">stop</span>());</span><br><span class="line">        } <span class="keyword">catch</span> (e) { <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"清理 sender/receiver 时出错:"</span>, e); }</span><br><span class="line">        peer.<span class="property">value</span>.<span class="title function_">close</span>(); peer.<span class="property">value</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"PeerConnection 已关闭并清理。"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// --- 确认停止本地流轨道 ---</span></span><br><span class="line">    <span class="keyword">if</span> (localStream.<span class="property">value</span>) {</span><br><span class="line">        localStream.<span class="property">value</span>.<span class="title function_">getTracks</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">track</span> =&gt;</span> track.<span class="title function_">stop</span>());</span><br><span class="line">        localStream.<span class="property">value</span> = <span class="literal">undefined</span>; <span class="comment">// 清除引用</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"本地媒体流已停止。"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// --------------------------</span></span><br><span class="line">    <span class="keyword">if</span> (localVideo.<span class="property">value</span>) localVideo.<span class="property">value</span>.<span class="property">srcObject</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (remoteVideo.<span class="property">value</span>) remoteVideo.<span class="property">value</span>.<span class="property">srcObject</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"媒体元素已清理。"</span>);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 修改 onMounted 中的 Socket.IO 监听器 ---</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="keyword">const</span> socketInstance = <span class="title function_">io</span>(<span class="string">'http://localhost:3000'</span>, { <span class="attr">transports</span>: [<span class="string">'websocket'</span>] });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... (connect, connectionSuccess, error, disconnect, room events 不变) ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// --- 修改 'acceptCall' 监听器：调用 createOfferAndSend ---</span></span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"acceptCall"</span>, <span class="title function_">async</span> (data) =&gt; {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"对方已接受呼叫, 来自:"</span>, data?.<span class="property">accepterId</span>);</span><br><span class="line">      <span class="keyword">if</span> (caller.<span class="property">value</span> &amp;&amp; !peer.<span class="property">value</span>) { <span class="comment">// 确保是发起方且 PC 尚未创建</span></span><br><span class="line">          calling.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">          <span class="title function_">setStatus</span>(<span class="string">'对方已接受，正准备连接...'</span>);</span><br><span class="line">          <span class="keyword">await</span> <span class="title function_">createOfferAndSend</span>(); <span class="comment">// 调用异步函数创建并发送 Offer</span></span><br><span class="line">      } <span class="keyword">else</span> { <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`收到 acceptCall 但状态不符, caller=<span class="subst">${caller.value}</span>, peer=<span class="subst">${peer.value}</span>`</span>); }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// --- 新增/修改 'offer' 监听器 ---</span></span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"offer"</span>, <span class="title function_">async</span> (<span class="attr">data</span>: { <span class="attr">senderId</span>: <span class="built_in">string</span>, <span class="attr">sdp</span>: <span class="built_in">string</span>, <span class="attr">offerType</span>: <span class="title class_">RTCSdpType</span> }) =&gt; {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"收到 Offer, 来自:"</span>, data?.<span class="property">senderId</span>);</span><br><span class="line">      <span class="comment">// 确保是被叫方，且 PC 已在 acceptCall 中创建好，并且还未开始通信</span></span><br><span class="line">      <span class="keyword">if</span> (called.<span class="property">value</span> &amp;&amp; peer.<span class="property">value</span> &amp;&amp; !communicating.<span class="property">value</span>) {</span><br><span class="line">          <span class="keyword">await</span> <span class="title function_">handleOfferAndCreateAnswer</span>(data); <span class="comment">// 处理 Offer 并创建 Answer</span></span><br><span class="line">      } <span class="keyword">else</span> { <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`收到 Offer 但状态不符`</span>); }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// --- 新增/修改 'answer' 监听器 ---</span></span><br><span class="line">  socketInstance.<span class="title function_">on</span>(<span class="string">"answer"</span>, <span class="title function_">async</span> (<span class="attr">data</span>: { <span class="attr">senderId</span>: <span class="built_in">string</span>, <span class="attr">sdp</span>: <span class="built_in">string</span>, <span class="attr">answerType</span>: <span class="title class_">RTCSdpType</span> }) =&gt; {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"收到 Answer, 来自:"</span>, data?.<span class="property">senderId</span>);</span><br><span class="line">      <span class="comment">// 确保是发起方且 PC 存在</span></span><br><span class="line">      <span class="keyword">if</span> (caller.<span class="property">value</span> &amp;&amp; peer.<span class="property">value</span>) {</span><br><span class="line">          <span class="keyword">await</span> <span class="title function_">handleAnswer</span>(data); <span class="comment">// 处理 Answer</span></span><br><span class="line">      } <span class="keyword">else</span> { <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`收到 Answer 但状态不符`</span>); }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// --- 'candidate' 监听器保持占位 ---</span></span><br><span class="line">   socketInstance.<span class="title function_">on</span>(<span class="string">"candidate"</span>, <span class="title function_">async</span> (data) =&gt; {</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"步骤5将处理: 收到 ICE Candidate..."</span>);</span><br><span class="line">       <span class="comment">// await handleRemoteCandidate(data.candidate);</span></span><br><span class="line">   });</span><br><span class="line">   <span class="comment">// ------------------------------------</span></span><br><span class="line"></span><br><span class="line">  socket.<span class="property">value</span> = socketInstance; <span class="comment">// 保存实例</span></span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// 其他函数 (hangUp, hangUpCleanup, resetStates, startGettingStats 等) 和 onUnmounted 保持不变</span></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure><p><strong>测试:</strong></p><ol><li>重启后端 (<code>python server_flask.py</code>)。</li><li>用两个浏览器窗口打开前端。</li><li><strong>窗口 A</strong> 点击“发起视频”，同意权限。本地预览出现，状态“呼叫中…”。</li><li><strong>窗口 B</strong> 收到邀请，点击“接受”，同意权限。本地预览出现，状态“正在连接…”。</li><li>观察控制台日志:<ul><li>双方成功获取媒体流、创建 PeerConnection、添加轨道的日志。</li><li><strong>窗口 A:</strong> 在收到 <code>acceptCall</code> 后，应看到创建 Offer、设置本地 Offer、<strong>发送 Offer</strong> 的日志。</li><li><strong>窗口 B:</strong> 应看到收到 Offer、设置远端 Offer、创建 Answer、设置本地 Answer、<strong>发送 Answer</strong> 的日志。</li><li><strong>窗口 A:</strong> 应看到收到 Answer、设置远端 Answer 的日志。</li></ul></li><li>此时，SDP 协商完成！但视频仍不会通，因为网络路径 (ICE Candidate) 还未交换。状态可能停留在 “已连接”。</li></ol><hr><h6 id="5-实现-ICE-Candidate-交换与显示远端流"><a href="#5-实现-ICE-Candidate-交换与显示远端流" class="headerlink" title="5.实现 ICE Candidate 交换与显示远端流"></a>5.实现 ICE Candidate 交换与显示远端流</h6><p><strong>目标:</strong></p><ol><li>在 <code>RTCPeerConnection</code> 生成 ICE Candidate 时，通过信令服务器发送给对方。</li><li>接收并添加对方发送的 ICE Candidate 到本地 <code>RTCPeerConnection</code>。</li><li>在 <code>ontrack</code> 事件触发时，获取远端媒体流并显示在 <code>remoteVideo</code> 元素中，同时更新通话状态。</li><li>(可选) 实现并启动 WebRTC 统计信息获取。</li></ol><p><strong>1. 后端修改 (<code>server_flask.py</code>)</strong></p><p>在 <code>server_flask.py</code> 的 “Socket.IO 事件处理” 部分，<strong>添加</strong> 用于转发 <code>candidate</code> 消息的事件处理器：</p><p>Python</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">## server_flask.py (在 handle_answer 和 handle_disconnect 之间或之后添加)</span><br><span class="line"></span><br><span class="line">## --- 新增：处理 WebRTC ICE Candidate 转发 ---</span><br><span class="line">@socketio.on('candidate')</span><br><span class="line">def handle_candidate(data):</span><br><span class="line">    """处理收到的 ICE Candidate，并转发给同房间其他人"""</span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get('roomId')</span><br><span class="line">    candidate_info = data.get('candidate') # 前端发送时键名为 'candidate'</span><br><span class="line">    # logger.debug(f"收到来自 sid={sid} 的 Candidate，房间: {room_id}") # Debug 时可取消注释</span><br><span class="line">    if room_id and room_id in rooms_data and candidate_info:</span><br><span class="line">        # 将 Candidate 事件和信息转发给房间内的其他人 (不包括发送者)</span><br><span class="line">        # 前端应监听 'candidate' 事件</span><br><span class="line">        emit('candidate', {'senderId': sid, 'candidate': candidate_info}, room=room_id, skip_sid=sid)</span><br><span class="line">        # logger.debug(f"已将 Candidate 事件转发给房间 {room_id} (除 {sid} 外)")</span><br><span class="line">    else:</span><br><span class="line">        logger.warning(f"无法转发 Candidate：房间 {room_id} 无效、用户不在房间或缺少 Candidate 信息。")</span><br><span class="line">## ------------------------------------</span><br><span class="line"></span><br><span class="line">## 其他事件处理器和主程序入口保持不变</span><br></pre></td></tr></tbody></table></figure><p><strong>2. 前端修改 (<code>src/App.vue</code>)</strong></p><p>在 <code>&lt;script setup lang="ts"&gt;</code> 内部：</p><ul><li><strong>完成</strong> <code>setupPeerConnectionEvents</code> 函数中 <code>onicecandidate</code> 和 <code>ontrack</code> 的内部逻辑。</li><li><strong>新增</strong> <code>handleRemoteCandidate</code> 辅助函数。</li><li><strong>完成</strong> <code>onMounted</code> 中对 <code>candidate</code> 事件的处理逻辑。</li><li><strong>实现</strong> <code>startGettingStats</code> 函数。</li><li><strong>更新</strong> <code>cleanupRTC</code> 函数以清除统计定时器。</li></ul><p><strong>请在 <code>src/App.vue</code> 的 <code>&lt;script setup&gt;</code> 部分替换或添加/完成以下代码：</strong></p><p>TypeScript</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">// --- 更新/完成 setupPeerConnectionEvents 函数 ---</span><br><span class="line">const setupPeerConnectionEvents = (pcInstance: RTCPeerConnection) =&gt; {</span><br><span class="line">    // 监听本地 ICE Candidate 生成</span><br><span class="line">    pcInstance.onicecandidate = (event) =&gt; {</span><br><span class="line">        // --- 完成 ICE Candidate 发送逻辑 ---</span><br><span class="line">        if (event.candidate) { // 检查 candidate 是否存在</span><br><span class="line">            console.log('发送本地 ICE Candidate...');</span><br><span class="line">            // 使用辅助函数发送 'candidate' 事件</span><br><span class="line">            sendSignalingMessage('candidate', { candidate: event.candidate.toJSON() });</span><br><span class="line">        } else {</span><br><span class="line">            console.log("本地 ICE Candidate 收集完成。"); // event.candidate 为 null 表示收集完毕</span><br><span class="line">        }</span><br><span class="line">        // ----------------------------------</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    // 监听远端媒体轨道添加</span><br><span class="line">    pcInstance.ontrack = (event) =&gt; {</span><br><span class="line">        // --- 完成 Track 处理逻辑 ---</span><br><span class="line">        console.log('收到远端轨道:', event.track.kind, '所属流:', event.streams[0]);</span><br><span class="line">        // 将收到的第一个流附加到 remoteVideo 元素上播放</span><br><span class="line">        if (remoteVideo.value &amp;&amp; event.streams &amp;&amp; event.streams[0]) {</span><br><span class="line">            // 避免重复设置同一个流</span><br><span class="line">            if (remoteVideo.value.srcObject !== event.streams[0]) {</span><br><span class="line">                remoteVideo.value.srcObject = event.streams[0];</span><br><span class="line">                remoteVideo.value.play().catch(e =&gt; console.error("远端视频播放失败:", e));</span><br><span class="line">                console.log('已将远端流附加到 video 元素');</span><br><span class="line">                // 确认进入通话状态</span><br><span class="line">                calling.value = false; // 不再是呼叫中/响铃中</span><br><span class="line">                communicating.value = true; // 正式进入通话中</span><br><span class="line">                setStatus('通话中'); // 更新状态</span><br><span class="line">                startGettingStats(); // 连接成功，开始获取统计信息</span><br><span class="line">            }</span><br><span class="line">        } else {</span><br><span class="line">             console.warn("无法附加远端流到 video 元素");</span><br><span class="line">        }</span><br><span class="line">        // --------------------------</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    // 监听连接状态变化 (保持不变)</span><br><span class="line">    pcInstance.onconnectionstatechange = () =&gt; { /* ... */ };</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// --- 新增：处理远端 Candidate 的辅助函数 ---</span><br><span class="line">const handleRemoteCandidate = async (candidateData: any) =&gt; {</span><br><span class="line">     // console.log("尝试添加远端 Candidate...");</span><br><span class="line">     // 确保 PeerConnection 实例存在，并且收到的 candidate 有效，且连接未关闭</span><br><span class="line">     if (peer.value &amp;&amp; candidateData &amp;&amp; peer.value.signalingState !== 'closed') {</span><br><span class="line">         try {</span><br><span class="line">             // 使用收到的信息创建 RTCIceCandidate 对象并添加到 PeerConnection</span><br><span class="line">             await peer.value.addIceCandidate(new RTCIceCandidate(candidateData));</span><br><span class="line">             // console.log("已添加远端 ICE Candidate");</span><br><span class="line">         } catch (e) {</span><br><span class="line">             // 忽略添加候选者时可能出现的常见错误（例如重复添加、状态不对等）</span><br><span class="line">             if (e instanceof DOMException &amp;&amp; e.name === 'OperationError') {</span><br><span class="line">                 console.warn(`添加 ICE Candidate 时忽略错误: ${e.message}`);</span><br><span class="line">             } else {</span><br><span class="line">                 console.error("添加远端 ICE Candidate 失败:", e);</span><br><span class="line">             }</span><br><span class="line">         }</span><br><span class="line">     } else if (!candidateData) {</span><br><span class="line">          console.log("收到 null ICE Candidate (对方收集完成)");</span><br><span class="line">     } else {</span><br><span class="line">          console.warn(`收到 Candidate 但 PC 状态异常: peer=${peer.value}, state=${peer.value?.signalingState}`);</span><br><span class="line">     }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// --- 在 onMounted 的 socketInstance 事件监听中完成 ---</span><br><span class="line">onMounted(() =&gt; {</span><br><span class="line">  const socketInstance = io('http://localhost:3000', { transports: ['websocket'] });</span><br><span class="line"></span><br><span class="line">  // ... (connect, connectionSuccess, error, disconnect, room, call, accept, hangup, offer, answer 监听器保持不变) ...</span><br><span class="line"></span><br><span class="line">  // --- 完成 'candidate' 监听器逻辑 ---</span><br><span class="line">   socketInstance.on("candidate", async (data) =&gt; { // 标记为 async</span><br><span class="line">       // console.log("收到 ICE Candidate, 来自:", data?.senderId);</span><br><span class="line">       await handleRemoteCandidate(data.candidate); // 调用处理函数</span><br><span class="line">   });</span><br><span class="line">   // ------------------------------------</span><br><span class="line"></span><br><span class="line">  socket.value = socketInstance; // 保存实例</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// --- 实现 WebRTC 统计获取函数 ---</span><br><span class="line">const startGettingStats = () =&gt; {</span><br><span class="line">    if (statsIntervalId) clearInterval(statsIntervalId); // 清除旧的定时器</span><br><span class="line">    console.log("开始获取 WebRTC 统计信息...");</span><br><span class="line">    statsIntervalId = setInterval(async () =&gt; {</span><br><span class="line">        // 确保 PeerConnection 存在且处于连接状态</span><br><span class="line">        if (peer.value &amp;&amp; peer.value.connectionState === 'connected') {</span><br><span class="line">            try {</span><br><span class="line">                const report = await peer.value.getStats(null); // 获取所有统计信息</span><br><span class="line">                let interestingStats: any = {}; // 存储我们关心的统计数据</span><br><span class="line">                let remoteCandidateInfo: any = {}; // 临时存储远端候选信息</span><br><span class="line"></span><br><span class="line">                report.forEach(item =&gt; {</span><br><span class="line">                    // 筛选常用的统计信息</span><br><span class="line">                    if (item.type === 'inbound-rtp' &amp;&amp; item.kind === 'video') {</span><br><span class="line">                        interestingStats.inboundVideo = {</span><br><span class="line">                            收到的包数: item.packetsReceived, 抖动: item.jitter?.toFixed(4), 丢失的包数: item.packetsLost, NACK数: item.nackCount, PLI数: item.pliCount</span><br><span class="line">                        };</span><br><span class="line">                    } else if (item.type === 'candidate-pair' &amp;&amp; item.state === 'succeeded') {</span><br><span class="line">                         interestingStats.candidatePair = {</span><br><span class="line">                            本地候选ID: item.localCandidateId, 远端候选ID: item.remoteCandidateId, RTT_秒: item.currentRoundTripTime?.toFixed(4)</span><br><span class="line">                         };</span><br><span class="line">                    } else if (item.type === 'remote-candidate') {</span><br><span class="line">                         remoteCandidateInfo[item.id] = { 地址端口: `${item.address}:${item.port}`, 类型: item.candidateType };</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">                if (interestingStats.candidatePair &amp;&amp; remoteCandidateInfo[interestingStats.candidatePair.远端候选ID]) {</span><br><span class="line">                     interestingStats.成功远端候选 = remoteCandidateInfo[interestingStats.candidatePair.远端候选ID];</span><br><span class="line">                }</span><br><span class="line">                stats.value = interestingStats; // 更新响应式 ref</span><br><span class="line">            } catch (err) { console.error("获取统计信息失败:", err); if (statsIntervalId) clearInterval(statsIntervalId); statsIntervalId = null; }</span><br><span class="line">        } else {</span><br><span class="line">            // 如果连接断开或 PC 不存在，停止获取</span><br><span class="line">             if (statsIntervalId) { console.log("连接非 'connected' 状态，停止获取统计信息。"); clearInterval(statsIntervalId); statsIntervalId = null; stats.value = null; }</span><br><span class="line">        }</span><br><span class="line">    }, 2000); // 每 2 秒获取一次</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">// --- 更新 cleanupRTC 函数以清除定时器 ---</span><br><span class="line">const cleanupRTC = () =&gt; {</span><br><span class="line">    console.log("清理 WebRTC 资源...");</span><br><span class="line">    // --- 确保清除定时器 ---</span><br><span class="line">    if (statsIntervalId) {</span><br><span class="line">        clearInterval(statsIntervalId);</span><br><span class="line">        statsIntervalId = null;</span><br><span class="line">        stats.value = null; // 清空统计显示</span><br><span class="line">        console.log("WebRTC 统计定时器已清除。");</span><br><span class="line">    }</span><br><span class="line">    // ---------------------</span><br><span class="line">    if (peer.value) { /* ... 关闭 PC 和轨道 ... */ }</span><br><span class="line">    if (localStream.value) { /* ... 停止本地流 ... */ }</span><br><span class="line">    if (localVideo.value) localVideo.value.srcObject = null;</span><br><span class="line">    if (remoteVideo.value) remoteVideo.value.srcObject = null;</span><br><span class="line">    console.log("媒体元素已清理。");</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">// --- 其他函数和生命周期钩子保持不变 ---</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure><p><strong>测试 (最终完整流程):</strong></p><ol><li>重启后端 (<code>python server_flask.py</code>)。</li><li>用两个浏览器窗口打开前端页面。</li><li>窗口 A 点击“发起视频”，同意权限。</li><li>窗口 B 收到邀请，点击“接受”，同意权限。</li><li>观察:<ul><li>双方的本地视频预览出现。</li><li>状态经历“呼叫中…”、“收到呼叫邀请”、“对方已接受…”、“正在连接…”等变化。</li><li>控制台会打印 Offer, Answer, 以及大量的 Candidate 交换日志。</li><li><strong>关键:</strong> 等待几秒钟，双方的 <strong><code>remoteVideo</code> (右下角小窗口)</strong> 应该会成功显示 <strong>对方</strong> 的摄像头画面！</li><li>状态最终变为“通话中”。</li><li>下方的统计信息区域开始显示数据（如果启用了）。</li></ul></li><li>任一窗口点击“挂断”，双方视频通话结束，状态恢复。</li><li><strong>(可选) 调试:</strong> 如果视频没有出现，检查浏览器控制台是否有 WebRTC 错误。在 Chrome/Edge 中打开 <code>chrome://webrtc-internals</code>，查找当前连接，检查 ICE 候选对 (Candidate Pair) 是否有成功的 (state = succeeded)，以及音视频流的收发包情况。</li></ol><hr><h6 id="最终完整后端代码-server-flask-py"><a href="#最终完整后端代码-server-flask-py" class="headerlink" title="最终完整后端代码 (server_flask.py)"></a>最终完整后端代码 (<code>server_flask.py</code>)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## server_flask.py (使用 Flask 和 Flask-SocketIO)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request  <span class="comment"># 引入 Flask 和 request 对象 (用于获取 sid)</span></span><br><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> SocketIO, emit, join_room, leave_room  <span class="comment"># 引入 Flask-SocketIO 相关组件</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os  <span class="comment"># 用于设置密钥</span></span><br><span class="line"><span class="keyword">import</span> weakref  <span class="comment"># 引入 weakref</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## --- 日志设置 ---</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">'%(asctime)s %(levelname)s:%(name)s: %(message)s'</span>)</span><br><span class="line">logger = logging.getLogger(<span class="string">"flask_socketio_server"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## --- 创建 Flask 应用实例 ---</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = os.urandom(<span class="number">24</span>)  <span class="comment"># 生成一个随机密钥</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## --- 创建 Flask-SocketIO 实例 ---</span></span><br><span class="line">socketio = SocketIO(app, cors_allowed_origins=<span class="string">"*"</span>, async_mode=<span class="string">'eventlet'</span>)</span><br><span class="line"></span><br><span class="line">logger.info(<span class="string">"Flask-SocketIO 服务器准备就绪..."</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## --- 用于管理房间和客户端的数据结构 ---</span></span><br><span class="line"><span class="comment">## 存储每个房间有哪些客户端 sid</span></span><br><span class="line">rooms_data: <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">set</span>[<span class="built_in">str</span>]] = {}</span><br><span class="line"><span class="comment">## 存储每个 sid 当前在哪个房间，方便断开时查找</span></span><br><span class="line">sid_room: <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>] = {}</span><br><span class="line"></span><br><span class="line"><span class="comment">## --- Socket.IO 事件处理 ---</span></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'connect'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_connect</span>():</span><br><span class="line">    sid = request.sid  <span class="comment"># 获取 sid</span></span><br><span class="line">    logger.info(<span class="string">f"客户端 sid = <span class="subst">{sid}</span> 已连接"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># --- 响应前端的 connectionSuccess 事件 ---</span></span><br><span class="line">        emit(<span class="string">"connectionSuccess"</span>, room=sid)  <span class="comment"># 使用 room=sid 或 to=sid 发送给特定客户端</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f"向 sid=<span class="subst">{sid}</span> 发送 connectionSuccess 时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## --- 修改：完善 'disconnect' 事件处理 ---</span></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'disconnect'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_disconnect</span>():</span><br><span class="line">    sid = request.sid</span><br><span class="line">    logger.info(<span class="string">f"客户端已断开连接: sid=<span class="subst">{sid}</span>"</span>)</span><br><span class="line">    <span class="comment"># --- 后续步骤：在这里处理离开房间的逻辑 ---</span></span><br><span class="line">    <span class="comment"># 查找该客户端所在的房间</span></span><br><span class="line">    <span class="keyword">if</span> sid <span class="keyword">in</span> sid_room:</span><br><span class="line">        room_id = sid_room[sid]</span><br><span class="line">        logger.info(<span class="string">f"客户端 sid=<span class="subst">{sid}</span> 正在从房间 <span class="subst">{room_id}</span> 断开..."</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            leave_room(room_id, sid=sid) <span class="comment"># Flask-SocketIO 通常会自动处理，但显式调用更清晰</span></span><br><span class="line">            <span class="keyword">if</span> room_id <span class="keyword">in</span> rooms_data:</span><br><span class="line">                rooms_data[room_id].discard(sid)  <span class="comment"># 从我们的数据结构中移除</span></span><br><span class="line">                logger.info(<span class="string">f"sid=<span class="subst">{sid}</span> 已从 rooms_data[<span class="subst">{room_id}</span>] 移除"</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> rooms_data[room_id]: <span class="comment"># 如果房间空了，清理字典</span></span><br><span class="line">                    <span class="keyword">del</span> rooms_data[room_id]</span><br><span class="line">                    logger.info(<span class="string">f"房间已移除 (空): <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># 通知房间内其他人该用户已离开</span></span><br><span class="line">                    logger.info(<span class="string">f"向房间 <span class="subst">{room_id}</span> 广播 peerLeft 事件 (来自 <span class="subst">{sid}</span>)"</span>)</span><br><span class="line">                    socketio.emit(<span class="string">'peerLeft'</span>, {<span class="string">'peerId'</span>: sid}, room=room_id)  <span class="comment"># 这里不需要 skip_sid，因为自己已断开链接</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f"处理 sid=<span class="subst">{sid}</span> 离开房间 <span class="subst">{room_id}</span> 时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="keyword">del</span> sid_room[sid]  <span class="comment"># 从 sid-&gt;room 映射中移除</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f"客户端 sid=<span class="subst">{sid}</span> 未在任何房间中"</span>)</span><br><span class="line">    logger.info(<span class="string">f"客户端 sid=<span class="subst">{sid}</span> 断开连接处理完成"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## --- 新增：处理 'joinRoom' 事件 ---</span></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'joinRoom'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_join_room</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理客户端加入房间的请求"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">"roomId"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> room_id:</span><br><span class="line">        logger.warning(<span class="string">f"sid=<span class="subst">{sid}</span> 请求加入房间，但未提供 roomId"</span>)</span><br><span class="line">        <span class="comment"># 可以选择发送一个错误事件回客户端</span></span><br><span class="line">        <span class="comment"># emit('error', {'message': '未提供房间号'}, room=sid)</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 如果客户端已在某个房间，先让其离开旧房间</span></span><br><span class="line">    <span class="keyword">if</span> sid <span class="keyword">in</span> sid_room:</span><br><span class="line">        old_room_id = sid_room[sid]</span><br><span class="line">        <span class="keyword">if</span> old_room_id <span class="keyword">in</span> rooms_data <span class="keyword">and</span> sid <span class="keyword">in</span> rooms_data[old_room_id]:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                leave_room(old_room_id, sid=sid)  <span class="comment"># 调用flask提供的离开房间函数 让sid 离开房间</span></span><br><span class="line">                rooms_data[old_room_id].discard(sid)  <span class="comment"># 从数据结构中移除</span></span><br><span class="line">                logger.info(<span class="string">f"sid=<span class="subst">{sid}</span> 已离开旧房间: <span class="subst">{old_room_id}</span>"</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> rooms_data[old_room_id]:  <span class="comment"># 如果房间空了，清理字典</span></span><br><span class="line">                    <span class="keyword">del</span> rooms_data[old_room_id]</span><br><span class="line">                    logger.info(<span class="string">f"房间已移除 (空): <span class="subst">{old_room_id}</span>"</span>)</span><br><span class="line">                <span class="comment"># 可选: 通知旧房间其他人该用户已离开</span></span><br><span class="line">                socketio.emit(<span class="string">"peerLeft"</span>, {<span class="string">"peerId"</span>: sid}, room=old_room_id)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f"处理 sid=<span class="subst">{sid}</span> 离开旧房间 <span class="subst">{old_room_id}</span> 时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="comment"># 如果他在新房间，则我们需要去掉对于旧房间的引用</span></span><br><span class="line">        <span class="keyword">del</span> sid_room[sid]  <span class="comment"># 从 sid-&gt;room 映射中移除</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.加入信访件</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        join_room(room_id,sid=sid) <span class="comment"># 让 sid 加入房间</span></span><br><span class="line">        <span class="keyword">if</span> room_id <span class="keyword">not</span> <span class="keyword">in</span> rooms_data:</span><br><span class="line">            <span class="comment"># 如果房间时新的，则创建set</span></span><br><span class="line">            rooms_data[room_id] = <span class="built_in">set</span>() <span class="comment"># 创建set</span></span><br><span class="line">            rooms_data[room_id].add(sid) <span class="comment"># 将sid添加到set中</span></span><br><span class="line">            sid_room[sid] = room_id <span class="comment"># 将sid和房间号建立映射</span></span><br><span class="line">            logger.info(<span class="string">f"sid=<span class="subst">{sid}</span> 已加入房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">            <span class="comment"># 可选: 通知新房间其他人该用户已加入</span></span><br><span class="line">            <span class="comment"># 使用 skip_sid=sid 避免给自己发送通知</span></span><br><span class="line">            socketio.emit(<span class="string">'peerJoined'</span>, {<span class="string">'peerId'</span>: sid}, room=room_id, skip_sid=sid)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f"处理 sid=<span class="subst">{sid}</span> 加入房间 <span class="subst">{room_id}</span> 时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## --- 新增：处理呼叫相关信令事件 ---</span></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'callRemote'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_call_remote</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理发起呼叫请求，并转发给同房间其他人"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">"roomId"</span>)</span><br><span class="line">    logger.info(<span class="string">f"收到来自 sid=<span class="subst">{sid}</span> 的 callRemote 请求，房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">    <span class="keyword">if</span> room_id <span class="keyword">in</span> rooms_data:</span><br><span class="line">        <span class="comment"># 将呼叫请求事件转发给房间内的其他人</span></span><br><span class="line">        emit(<span class="string">'callRemote'</span>, {<span class="string">'callerId'</span>: sid}, room=room_id, skip_sid=sid)</span><br><span class="line">        logger.info(<span class="string">f"已将 callRemote 事件转发给房间 <span class="subst">{room_id}</span> (除 <span class="subst">{sid}</span> 外)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f"无法转发  callRemote：房间 <span class="subst">{room_id}</span> 无效或不存在。"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'acceptCall'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_accept_call</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理接受呼叫请求，并转发给发起方"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">'roomId'</span>)</span><br><span class="line">    logger.info(<span class="string">f"收到来自 sid=<span class="subst">{sid}</span> 的 acceptCall 请求，房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">    <span class="keyword">if</span> room_id <span class="keyword">and</span> room_id <span class="keyword">in</span> rooms_data:</span><br><span class="line">        <span class="comment"># 将接受事件转发给房间内的其他人（理论上主要是发起方会处理）</span></span><br><span class="line">        emit(<span class="string">'acceptCall'</span>, {<span class="string">'accepterId'</span>: sid}, room=room_id, skip_sid=sid)</span><br><span class="line">        logger.info(<span class="string">f"已将 acceptCall 事件转发给房间 <span class="subst">{room_id}</span> (除 <span class="subst">{sid}</span> 外)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f"无法转发 acceptCall：房间 <span class="subst">{room_id}</span> 无效或不存在。"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'hangUp'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_hang_up</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理挂断请求，并转发给同房间其他人"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">'roomId'</span>)</span><br><span class="line">    logger.info(<span class="string">f"收到来自 sid=<span class="subst">{sid}</span> 的 hangUp 请求，房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">    <span class="keyword">if</span> room_id <span class="keyword">and</span> room_id <span class="keyword">in</span> rooms_data:</span><br><span class="line">        <span class="comment"># 将挂断事件转发给房间内的其他人</span></span><br><span class="line">        emit(<span class="string">'hangUp'</span>, {<span class="string">'peerId'</span>: sid}, room=room_id, skip_sid=sid)</span><br><span class="line">        logger.info(<span class="string">f"已将 hangUp 事件转发给房间 <span class="subst">{room_id}</span> (除 <span class="subst">{sid}</span> 外)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f"无法转发 hangUp：房间 <span class="subst">{room_id}</span> 无效或不存在。"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## --- 新增：处理 WebRTC 信令消息转发 ---</span></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">"offer"</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_offer</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理收到的Offer SDP 并转发给房间内其他人"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">"roomId"</span>)</span><br><span class="line">    sdp = data.get(<span class="string">"sdp"</span>)</span><br><span class="line">    offer_type = data.get(<span class="string">"offerType"</span>) <span class="comment"># 前端发送时调用了offerType</span></span><br><span class="line">    logger.info(<span class="string">f"收到来自 sid=<span class="subst">{sid}</span> 的 Offer，房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">    <span class="keyword">if</span> room_id <span class="keyword">and</span> room_id <span class="keyword">in</span> rooms_data <span class="keyword">and</span> sdp:</span><br><span class="line">        <span class="comment"># 将 Offer SDP 转发给房间内的其他人</span></span><br><span class="line">        emit(<span class="string">"offer"</span>,{<span class="string">"senderId"</span>:sid,<span class="string">"sdp"</span>:sdp,<span class="string">"offerType"</span>:offer_type},room=room_id,skip_sid=sid)</span><br><span class="line">        logger.info(<span class="string">f"已将 Offer 事件转发给房间 <span class="subst">{room_id}</span> (除 <span class="subst">{sid}</span> 外)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f"无法转发 Offer：房间 <span class="subst">{room_id}</span> 无效、用户不在房间或缺少SDP。"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'answer'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_answer</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理收到的 Answer SDP，并转发给同房间其他人"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">'roomId'</span>)</span><br><span class="line">    sdp = data.get(<span class="string">'sdp'</span>)</span><br><span class="line">    answer_type = data.get(<span class="string">'answerType'</span>) <span class="comment"># 前端发送时用了 answerType</span></span><br><span class="line">    logger.info(<span class="string">f"收到来自 sid=<span class="subst">{sid}</span> 的 Answer，房间: <span class="subst">{room_id}</span>"</span>)</span><br><span class="line">    <span class="keyword">if</span> room_id <span class="keyword">and</span> room_id <span class="keyword">in</span> rooms_data <span class="keyword">and</span> sdp:</span><br><span class="line">        <span class="comment"># 将 Answer 事件和 SDP 转发给房间内的其他人</span></span><br><span class="line">        emit(<span class="string">'answer'</span>, {<span class="string">'senderId'</span>: sid, <span class="string">'sdp'</span>: sdp, <span class="string">'answerType'</span>: answer_type}, room=room_id, skip_sid=sid)</span><br><span class="line">        logger.info(<span class="string">f"已将 Answer 事件转发给房间 <span class="subst">{room_id}</span> (除 <span class="subst">{sid}</span> 外)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f"无法转发 Answer：房间 <span class="subst">{room_id}</span> 无效、用户不在房间或缺少SDP。"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">'candidate'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_candidate</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">"""处理收到的 ICE Candidate，并转发给同房间其他人"""</span></span><br><span class="line">    sid = request.sid</span><br><span class="line">    room_id = data.get(<span class="string">'roomId'</span>)</span><br><span class="line">    candidate_info = data.get(<span class="string">'candidate'</span>)  <span class="comment"># 前端发送时用了 candidate</span></span><br><span class="line">    logger.debug(<span class="string">f"收到来自 sid=<span class="subst">{sid}</span> 的 Candidate，房间: <span class="subst">{room_id}</span>"</span>) <span class="comment"># Debug日志</span></span><br><span class="line">    <span class="keyword">if</span> room_id <span class="keyword">and</span> room_id <span class="keyword">in</span> rooms_data <span class="keyword">and</span> candidate_info:</span><br><span class="line">        <span class="comment"># 将 Candidate 事件和信息转发给房间内的其他人</span></span><br><span class="line">        emit(<span class="string">'candidate'</span>, {<span class="string">'senderId'</span>: sid, <span class="string">'candidate'</span>: candidate_info}, room=room_id, skip_sid=sid)</span><br><span class="line">        logger.debug(<span class="string">f"已将 Candidate 事件转发给房间 <span class="subst">{room_id}</span> (除 <span class="subst">{sid}</span> 外)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f"无法转发 Candidate：房间 <span class="subst">{room_id}</span> 无效、用户不在房间或缺少 Candidate 信息。"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    logger.info(<span class="string">"准备启动 Flask-SocketIO 服务器 on port 3000..."</span>)</span><br><span class="line">    <span class="comment"># 使用 socketio.run() 启动服务器, 使用 eventlet</span></span><br><span class="line">    socketio.run(app, host=<span class="string">'127.0.0.1'</span>, port=<span class="number">3000</span>, debug=<span class="literal">True</span>, allow_unsafe_werkzeug=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><hr><h6 id="最终完整前端代码-src-App-vue"><a href="#最终完整前端代码-src-App-vue" class="headerlink" title="最终完整前端代码 (src/App.vue)"></a>最终完整前端代码 (<code>src/App.vue</code>)</h6><p>Code snippet</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br></pre></td><td class="code"><pre><span class="line">&lt;script lang="ts" setup&gt;</span><br><span class="line">import { ref, onMounted, onUnmounted, computed } from 'vue'</span><br><span class="line">import { io, Socket } from 'socket.io-client'</span><br><span class="line"></span><br><span class="line">// --- 响应式状态 ---</span><br><span class="line">const socket = ref&lt;Socket | undefined&gt;()        // Socket.IO 实例</span><br><span class="line">const called = ref(false)                       // 当前用户是否是接收方 (收到呼叫)</span><br><span class="line">const caller = ref(false)                       // 当前用户是否是发起方</span><br><span class="line">const calling = ref(false)                      // 是否正处于"呼叫中/等待接听"的状态</span><br><span class="line">const communicating = ref(false)                // 是否正在视频通话中</span><br><span class="line">const localVideo = ref&lt;HTMLVideoElement | null&gt;(null)  // 本地视频 &lt;video&gt; 元素引用</span><br><span class="line">const remoteVideo = ref&lt;HTMLVideoElement | null&gt;(null) // 远端视频 &lt;video&gt; 元素引用</span><br><span class="line">const currentTheme = ref('tropicalLight')       // 主题名称</span><br><span class="line">const peer = ref&lt;RTCPeerConnection | null&gt;(null)       // RTCPeerConnection 实例</span><br><span class="line">const localStream = ref&lt;MediaStream | undefined&gt;()     // 本地媒体流</span><br><span class="line">const errorMessage = ref('')                    // 用于在界面上显示错误信息</span><br><span class="line">const roomId = ref('room001')                   // 示例房间ID</span><br><span class="line">const status = ref('空闲')                      // 连接状态显示</span><br><span class="line">const stats = ref&lt;any&gt;(null)                    // 存储 WebRTC 统计信息</span><br><span class="line">let statsIntervalId: number | null = null       // 存储统计定时器的ID</span><br><span class="line">const isConnecting = ref(false)                // 连接状态</span><br><span class="line">const isConnected = ref(false)                  // 连接状态</span><br><span class="line"></span><br><span class="line">const pcConfig = {</span><br><span class="line">  iceServers: [</span><br><span class="line">    {</span><br><span class="line">      urls: ['stun:stun.l.google.com:19302', 'stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302', 'stun:stun3.l.google.com:19302', 'stun:stun4.l.google.com:19302']</span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// --- 计算属性 (用于样式) ---</span><br><span class="line">const statusClass = computed(() =&gt; {</span><br><span class="line">  switch (status.value) {</span><br><span class="line">    case '已连接':</span><br><span class="line">    case '通话中':</span><br><span class="line">      return 'badge-success';</span><br><span class="line">    case '连接中':</span><br><span class="line">    case '连接信令服务器...':</span><br><span class="line">    case '正在连接...':</span><br><span class="line">    case '呼叫中...':</span><br><span class="line">    case '收到呼叫邀请':</span><br><span class="line">    case '对方已接受，正在建立连接...':</span><br><span class="line">      return 'badge-info';</span><br><span class="line">    case '错误':</span><br><span class="line">      return 'badge-error';</span><br><span class="line">    case '已断开':</span><br><span class="line">    case '已挂断':</span><br><span class="line">    case '空闲':</span><br><span class="line">    default:</span><br><span class="line">      return 'badge-neutral';</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">// 更新后的 cleanupRTC 函数</span><br><span class="line">const cleanupRTC = () =&gt; {</span><br><span class="line">  console.log("清理 WebRTC 资源...");</span><br><span class="line">  if (statsIntervalId) { clearInterval(statsIntervalId); statsIntervalId = null; stats.value = null; }</span><br><span class="line">  if (peer.value) {</span><br><span class="line">    peer.value.onicecandidate = null; peer.value.ontrack = null; peer.value.onconnectionstatechange = null;</span><br><span class="line">    try {</span><br><span class="line">      peer.value.getSenders().forEach(sender =&gt; sender.track?.stop());</span><br><span class="line">      peer.value.getReceivers().forEach(receiver =&gt; receiver.track?.stop());</span><br><span class="line">    } catch (e) { console.warn("清理 sender/receiver 时出错:", e); }</span><br><span class="line">    peer.value.close(); peer.value = null;</span><br><span class="line">    console.log("PeerConnection 已关闭并清理。");</span><br><span class="line">  }</span><br><span class="line">  // 清理本地媒体流</span><br><span class="line">  if (localStream.value) {</span><br><span class="line">    localStream.value.getTracks().forEach(track =&gt; track.stop());</span><br><span class="line">    localStream.value = undefined;</span><br><span class="line">    console.log("本地媒体流已停止。");</span><br><span class="line">  }</span><br><span class="line">  if (localVideo.value) localVideo.value.srcObject = null;</span><br><span class="line">  if (remoteVideo.value) remoteVideo.value.srcObject = null;</span><br><span class="line">  console.log("媒体元素已清理。");</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">// 重置所有与通话相关的状态变量</span><br><span class="line">const resetStates = () =&gt; {</span><br><span class="line">  console.log("重置状态...");</span><br><span class="line">  called.value = false;</span><br><span class="line">  caller.value = false;</span><br><span class="line">  calling.value = false;</span><br><span class="line">  communicating.value = false;</span><br><span class="line">  // 保留 status 和 errorMessage 的当前值，由调用者决定后续状态</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">// 开始获取WebRTC统计信息</span><br><span class="line">const startGettingStats = () =&gt; {</span><br><span class="line">  if (statsIntervalId) clearInterval(statsIntervalId);</span><br><span class="line">  statsIntervalId = window.setInterval(() =&gt; {</span><br><span class="line">    if (peer.value) {</span><br><span class="line">      peer.value.getStats().then(statsReport =&gt; {</span><br><span class="line">        const statsObj: Record&lt;string, any&gt; = {};</span><br><span class="line">        statsReport.forEach(report =&gt; {</span><br><span class="line">          if (report.type === 'inbound-rtp' || report.type === 'outbound-rtp') {</span><br><span class="line">            statsObj[report.id] = report;</span><br><span class="line">          }</span><br><span class="line">        });</span><br><span class="line">        stats.value = statsObj;</span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line">  }, 2000); // 每2秒更新一次</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">// 停止视频通话流(用于错误处理和主动挂断)</span><br><span class="line">const stopStreaming = () =&gt; {</span><br><span class="line">  hangUpCleanup();</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">// --- 更新 setupPeerConnectionEvents 函数 ---</span><br><span class="line">const setupPeerConnectionEvents = (pcInstance: RTCPeerConnection) =&gt; {</span><br><span class="line">  // 监听本地 ICE Candidate 生成</span><br><span class="line">  pcInstance.onicecandidate = (event) =&gt; {</span><br><span class="line">    // --- 步骤 5 实现 ---</span><br><span class="line">    if (event.candidate &amp;&amp; socket.value &amp;&amp; socket.value.connected) {</span><br><span class="line">      console.log('发送本地 ICE Candidate...');</span><br><span class="line">      // 将 candidate 通过 WebSocket 发送给信令服务器</span><br><span class="line">      socket.value.emit('candidate', { // 发送 'candidate' 事件</span><br><span class="line">        roomId: roomId.value,</span><br><span class="line">        candidate: event.candidate.toJSON() // 发送 JSON 格式</span><br><span class="line">      });</span><br><span class="line">    } else if (!event.candidate) {</span><br><span class="line">      console.log("本地 ICE Candidate 收集完成。");</span><br><span class="line">    }</span><br><span class="line">    // --- 结束步骤 5 实现 ---</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  // 监听远端媒体轨道添加 (替代旧的 onaddstream)</span><br><span class="line">  pcInstance.ontrack = (event) =&gt; {</span><br><span class="line">    // --- 步骤 6 实现 ---</span><br><span class="line">    console.log('收到远端轨道:', event.track, '所属流:', event.streams[0]);</span><br><span class="line">    // 将收到的第一个流附加到 remoteVideo 元素上播放</span><br><span class="line">    if (remoteVideo.value &amp;&amp; event.streams &amp;&amp; event.streams[0]) {</span><br><span class="line">      // 避免重复设置同一个流</span><br><span class="line">      if (remoteVideo.value.srcObject !== event.streams[0]) {</span><br><span class="line">        remoteVideo.value.srcObject = event.streams[0];</span><br><span class="line">        remoteVideo.value.play().catch(e =&gt; console.error("远端视频播放失败:", e));</span><br><span class="line">        console.log('已将远端流附加到 video 元素');</span><br><span class="line">        // 确认进入通话状态</span><br><span class="line">        calling.value = false; // 不再是呼叫中/响铃中</span><br><span class="line">        communicating.value = true; // 正式进入通话中</span><br><span class="line">        status.value = '通话中'; // 更新状态</span><br><span class="line">        startGettingStats(); // 开始获取统计信息</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    // --- 结束步骤 6 实现 ---</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  // 监听连接状态变化 (保持不变)</span><br><span class="line">  pcInstance.onconnectionstatechange = () =&gt; {</span><br><span class="line">    if (!peer.value) return;</span><br><span class="line">    const state = peer.value.connectionState;</span><br><span class="line">    console.log(`PeerConnection 连接状态改变: ${state}`);</span><br><span class="line">    switch (state) {</span><br><span class="line">      case 'connecting': status.value = '连接中'; isConnecting.value = true; isConnected.value = false; break;</span><br><span class="line">      case 'connected':</span><br><span class="line">        // 连接成功，但等 ontrack 后再确认 communicating 状态</span><br><span class="line">        status.value = '已连接'; isConnecting.value = false; isConnected.value = true; errorMessage.value = '';</span><br><span class="line">        break;</span><br><span class="line">      case 'disconnected': status.value = '已断开'; isConnected.value = false; isConnecting.value = false; console.warn("WebRTC 连接已断开..."); break;</span><br><span class="line">      case 'failed': status.value = '错误'; errorMessage.value = 'WebRTC 连接失败。'; isConnected.value = false; isConnecting.value = false; stopStreaming(); break;</span><br><span class="line">      case 'closed': status.value = '已断开'; isConnected.value = false; isConnecting.value = false; console.log("WebRTC 连接已关闭。"); break;</span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">// 更新后的 callRemote 方法</span><br><span class="line">const callRemote = async () =&gt; {</span><br><span class="line">  console.log('发起视频请求...');</span><br><span class="line">  if (!socket.value || !socket.value.connected) {</span><br><span class="line">    errorMessage.value = "未连接到信令服务器"; status.value = '错误'; return;</span><br><span class="line">  }</span><br><span class="line">  if (communicating.value || calling.value || caller.value || called.value) {</span><br><span class="line">    console.warn("已在通话或呼叫中"); return;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  // 1. 获取本地媒体流 (这是新增的关键部分)</span><br><span class="line">  const stream = await getLocalStream();</span><br><span class="line">  if (!stream) {</span><br><span class="line">    errorMessage.value = "无法获取本地媒体流，无法发起呼叫";</span><br><span class="line">    status.value = '错误';</span><br><span class="line">    return; // 获取失败则不继续</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  // 2. 更新状态并发送呼叫信令</span><br><span class="line">  caller.value = true;</span><br><span class="line">  calling.value = true;</span><br><span class="line">  status.value = '呼叫中...';</span><br><span class="line">  socket.value.emit('callRemote', { roomId: roomId.value });</span><br><span class="line">  console.log("已发送 callRemote 事件，等待对方接受...");</span><br><span class="line">  // Offer 的创建和发送现在移动到收到 'acceptCall' 事件后</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 更新后的 acceptCall 方法</span><br><span class="line">const acceptCall = async () =&gt; {</span><br><span class="line">  console.log('接受视频邀请...');</span><br><span class="line">  if (!socket.value || !socket.value.connected) {</span><br><span class="line">    errorMessage.value = "未连接到信令服务器"; status.value = '错误'; return;</span><br><span class="line">  }</span><br><span class="line">  if (!called.value || !calling.value) {</span><br><span class="line">    console.warn("没有收到呼叫或不在呼叫状态，无法接受"); return;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  // 1. 获取本地媒体流 (这是新增的关键部分)</span><br><span class="line">  const stream = await getLocalStream();</span><br><span class="line">  if (!stream) {</span><br><span class="line">    errorMessage.value = "无法获取本地媒体流，无法接听";</span><br><span class="line">    status.value = '错误';</span><br><span class="line">    return; // 获取失败则不继续</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  // 2. 更新状态</span><br><span class="line">  calling.value = false; // 结束响铃状态</span><br><span class="line">  status.value = '正在连接...'; // 进入连接协商状态</span><br><span class="line"></span><br><span class="line">  // 3. 创建 PeerConnection 并添加本地轨道 (这是新增的关键部分)</span><br><span class="line">  const pc = createPeerConnectionAndAddTracks();</span><br><span class="line">  if (!pc) {</span><br><span class="line">    // 创建失败，错误信息已在辅助函数中设置</span><br><span class="line">    return;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  // 4. 发送接受信令给服务器</span><br><span class="line">  socket.value.emit('acceptCall', { roomId: roomId.value });</span><br><span class="line">  console.log("已发送 acceptCall 事件，并准备好接收 Offer...");</span><br><span class="line">  // 此时接收方准备好接收 Offer 了</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 点击"挂断"按钮或需要主动结束通话时调用</span><br><span class="line">const hangUp = () =&gt; {</span><br><span class="line">  console.log('请求挂断视频...');</span><br><span class="line">  // 发送挂断信令给服务器转发 (如果还在线)</span><br><span class="line">  if (socket.value &amp;&amp; socket.value.connected) {</span><br><span class="line">    socket.value.emit('hangUp', { roomId: roomId.value });</span><br><span class="line">    console.log("已发送 hangUp 事件");</span><br><span class="line">  }</span><br><span class="line">  // 执行本地的清理操作</span><br><span class="line">  hangUpCleanup();</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">// 本地清理逻辑 (挂断或收到对方挂断时调用)</span><br><span class="line">const hangUpCleanup = () =&gt; {</span><br><span class="line">  console.log("执行本地挂断清理...");</span><br><span class="line">  cleanupRTC(); // 清理 WebRTC 相关资源 (后续实现)</span><br><span class="line">  resetStates(); // 重置界面状态变量</span><br><span class="line">  // 可以根据情况设置最终状态，比如 '已挂断' 或 '空闲'</span><br><span class="line">  if (status.value !== '错误') { // 避免覆盖错误状态</span><br><span class="line">    status.value = '已挂断';</span><br><span class="line">    // 短暂显示"已挂断"后可以变回"空闲"或"已连接信令服务器"</span><br><span class="line">    setTimeout(() =&gt; {</span><br><span class="line">      if (status.value === '已挂断') {</span><br><span class="line">        status.value = socket.value?.connected ? '已连接信令服务器' : '空闲';</span><br><span class="line">      }</span><br><span class="line">    }, 2000);</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// --- WebRTC 核心逻辑 ---</span><br><span class="line"></span><br><span class="line">// 实现获取本地媒体流</span><br><span class="line">const getLocalStream = async (): Promise&lt;MediaStream | undefined&gt; =&gt; {</span><br><span class="line">  console.log("尝试获取本地媒体流...");</span><br><span class="line">  errorMessage.value = ''; // 清除旧错误</span><br><span class="line">  try {</span><br><span class="line">    if (localStream.value) { // 如果已有流，先停止</span><br><span class="line">      localStream.value.getTracks().forEach(track =&gt; track.stop());</span><br><span class="line">      console.log("已停止之前的本地媒体轨道。");</span><br><span class="line">    }</span><br><span class="line">    const stream = await navigator.mediaDevices.getUserMedia({</span><br><span class="line">      audio: true, // 开启音频</span><br><span class="line">      video: { width: 640, height: 480 } // 请求视频</span><br><span class="line">    });</span><br><span class="line">    console.log('成功获取本地媒体流:', stream.id);</span><br><span class="line">    localStream.value = stream; // 保存流引用</span><br><span class="line">    if (localVideo.value) {</span><br><span class="line">      localVideo.value.srcObject = stream;</span><br><span class="line">      // play() 返回 Promise，最好 catch 一下可能的错误 (例如用户未互动)</span><br><span class="line">      localVideo.value.play().catch(e =&gt; console.error("本地视频自动播放失败:", e));</span><br><span class="line">    }</span><br><span class="line">    return stream; // 返回获取到的流</span><br><span class="line">  } catch (error: any) {</span><br><span class="line">    // 处理获取媒体流失败的情况</span><br><span class="line">    console.error('getUserMedia 错误:', error);</span><br><span class="line">    errorMessage.value = `无法访问媒体设备: ${error.name}`; // 向用户显示错误</span><br><span class="line">    status.value = '错误';</span><br><span class="line">    return undefined; // 返回 undefined 表示失败</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">// 实现创建 PeerConnection 和添加轨道的辅助函数</span><br><span class="line">const createPeerConnectionAndAddTracks = (): RTCPeerConnection | null =&gt; {</span><br><span class="line">  console.log("创建 PeerConnection 并添加轨道...");</span><br><span class="line">  try {</span><br><span class="line">    const pcInstance = new RTCPeerConnection(pcConfig); // 创建实例</span><br><span class="line"></span><br><span class="line">    // 设置事件监听器</span><br><span class="line">    setupPeerConnectionEvents(pcInstance);</span><br><span class="line"></span><br><span class="line">    // 将本地流的轨道添加到 PeerConnection</span><br><span class="line">    if (localStream.value) {</span><br><span class="line">      localStream.value.getTracks().forEach(track =&gt; {</span><br><span class="line">        try {</span><br><span class="line">          pcInstance.addTrack(track, localStream.value!);</span><br><span class="line">          console.log(`已添加本地 ${track.kind} 轨道`);</span><br><span class="line">        } catch (e) { console.error(`添加本地 ${track.kind} 轨道失败:`, e); }</span><br><span class="line">      });</span><br><span class="line">    } else {</span><br><span class="line">      console.error("无法添加轨道：本地流无效！");</span><br><span class="line">      errorMessage.value = "本地摄像头/麦克风流无效";</span><br><span class="line">      status.value = '错误';</span><br><span class="line">      return null; // 创建失败</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    peer.value = pcInstance; // 保存到 ref</span><br><span class="line">    return pcInstance;</span><br><span class="line">  } catch (e) {</span><br><span class="line">    console.error("创建 PeerConnection 失败:", e);</span><br><span class="line">    errorMessage.value = "创建 WebRTC 连接失败";</span><br><span class="line">    status.value = '错误';</span><br><span class="line">    return null;</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// --- Socket.IO 连接 ---</span><br><span class="line">// --- Socket.IO 连接与事件监听 ---</span><br><span class="line">onMounted(() =&gt; {</span><br><span class="line">  const socketInstance = io('http://localhost:3000', { transports: ['websocket'] });</span><br><span class="line"></span><br><span class="line">  socketInstance.on("connectionSuccess", () =&gt; {</span><br><span class="line">    console.log("连接成功");</span><br><span class="line">    status.value = '已连接信令服务器';</span><br><span class="line">    if (socket.value) {</span><br><span class="line">      socket.value.emit('joinRoom', { roomId: roomId.value });</span><br><span class="line">      console.log(`已发送加入房间请求: ${roomId.value}`);</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  socketInstance.on("connect_error", (err) =&gt; {</span><br><span class="line">    console.log("连接失败", err);</span><br><span class="line">    status.value = '连接失败';</span><br><span class="line">  });</span><br><span class="line">  socketInstance.on("disconnect", (reason) =&gt; {</span><br><span class="line">    console.log("断开连接", reason);</span><br><span class="line">    status.value = '已断开';</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  // --- 新增：监听呼叫相关事件 ---</span><br><span class="line">  socketInstance.on("callRemote", (data) =&gt; { // 收到呼叫请求</span><br><span class="line">    console.log("收到呼叫请求, 来自:", data?.callerId);</span><br><span class="line">    // 检查是否已在通话或呼叫中，避免冲突</span><br><span class="line">    if (communicating.value || calling.value || caller.value) {</span><br><span class="line">      console.warn("正在通话或呼叫中，忽略新的呼叫请求");</span><br><span class="line">      // 可以选择给对方发送一个 "busy" 信号</span><br><span class="line">      // socket.value?.emit('busy', { roomId: roomId.value, targetSid: data?.callerId });</span><br><span class="line">      return;</span><br><span class="line">    }</span><br><span class="line">    called.value = true; // 标记为被呼叫方</span><br><span class="line">    calling.value = true; // 进入响铃状态</span><br><span class="line">    status.value = '收到呼叫邀请';</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  socketInstance.on("acceptCall", async (data) =&gt; { // 标记为 async</span><br><span class="line">    console.log("对方已接受呼叫, 来自:", data?.accepterId);</span><br><span class="line">    if (caller.value) { // 只有发起方处理</span><br><span class="line">      calling.value = false;</span><br><span class="line">      status.value = '对方已接受，正在建立连接...';</span><br><span class="line"></span><br><span class="line">      // --- 触发 Offer 流程 ---</span><br><span class="line">      // 确保 PeerConnection 已创建并添加了轨道</span><br><span class="line">      // 注意：在 callRemote 时我们已经获取了流，但 PC 在这里创建</span><br><span class="line">      const pc = createPeerConnectionAndAddTracks();</span><br><span class="line">      if (pc) {</span><br><span class="line">        try {</span><br><span class="line">          console.log('创建 Offer...');</span><br><span class="line">          const offer = await pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true });</span><br><span class="line">          console.log('设置本地 Offer 描述...');</span><br><span class="line">          await pc.setLocalDescription(offer);</span><br><span class="line"></span><br><span class="line">          console.log('通过信令服务器发送 Offer...');</span><br><span class="line">          socket.value?.emit('offer', { // 发送 'offer' 事件</span><br><span class="line">            roomId: roomId.value,</span><br><span class="line">            sdp: pc.localDescription?.sdp,</span><br><span class="line">            offerType: pc.localDescription?.type // 使用 offerType 区分</span><br><span class="line">          });</span><br><span class="line">        } catch (error) {</span><br><span class="line">          console.error('创建或发送 Offer 失败:', error);</span><br><span class="line">          errorMessage.value = '创建 Offer 失败'; status.value = '错误';</span><br><span class="line">          hangUpCleanup(); // 出错时挂断</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  socketInstance.on("hangUp", (data) =&gt; { // 收到对方挂断信号</span><br><span class="line">    console.log("收到对方挂断通知, 来自:", data?.peerId);</span><br><span class="line">    hangUpCleanup(); // 执行本地清理</span><br><span class="line">    status.value = '对方已挂断';</span><br><span class="line">    alert("对方已挂断"); // 可选的用户提示</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  // --- 新增 'offer' 监听器 ---</span><br><span class="line">  socketInstance.on("offer", async (data) =&gt; { // 标记为 async</span><br><span class="line">    console.log("收到 Offer, 来自:", data?.senderId);</span><br><span class="line">    // 确保是被叫方，且 PC 实例已在 acceptCall 中创建</span><br><span class="line">    if (called.value &amp;&amp; peer.value &amp;&amp; !communicating.value) {</span><br><span class="line">      try {</span><br><span class="line">        console.log('设置远端 Offer 描述...');</span><br><span class="line">        await peer.value.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: data.sdp }));</span><br><span class="line"></span><br><span class="line">        console.log('创建 Answer...');</span><br><span class="line">        const answer = await peer.value.createAnswer();</span><br><span class="line">        console.log('设置本地 Answer 描述...');</span><br><span class="line">        await peer.value.setLocalDescription(answer);</span><br><span class="line"></span><br><span class="line">        console.log('通过信令服务器发送 Answer...');</span><br><span class="line">        socket.value?.emit('answer', { // 发送 'answer' 事件</span><br><span class="line">          roomId: roomId.value,</span><br><span class="line">          sdp: peer.value.localDescription?.sdp,</span><br><span class="line">          answerType: peer.value.localDescription?.type // 使用 answerType 区分</span><br><span class="line">        });</span><br><span class="line">      } catch (error) {</span><br><span class="line">        console.error('处理 Offer 或创建/发送 Answer 失败:', error);</span><br><span class="line">        errorMessage.value = '创建 Answer 失败'; status.value = '错误';</span><br><span class="line">        hangUpCleanup();</span><br><span class="line">      }</span><br><span class="line">    } else {</span><br><span class="line">      console.warn("收到 Offer 但状态不符 (非接收方、无 PC 或已通话)");</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  // --- 新增 'answer' 监听器 ---</span><br><span class="line">  socketInstance.on("answer", async (data) =&gt; { // 标记为 async</span><br><span class="line">    console.log("收到 Answer, 来自:", data?.senderId);</span><br><span class="line">    // 确保是发起方且 PC 实例存在</span><br><span class="line">    if (caller.value &amp;&amp; peer.value) {</span><br><span class="line">      if (peer.value.signalingState === 'have-local-offer') { // 检查状态是否适合设置 Answer</span><br><span class="line">        try {</span><br><span class="line">          console.log('设置远端 Answer 描述...');</span><br><span class="line">          await peer.value.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: data.sdp }));</span><br><span class="line">          console.log("远端 Answer 已设置，P2P 连接即将建立...");</span><br><span class="line">        } catch (error) {</span><br><span class="line">          console.error('设置远端 Answer 失败:', error);</span><br><span class="line">          errorMessage.value = '设置 Answer 失败'; status.value = '错误';</span><br><span class="line">          hangUpCleanup();</span><br><span class="line">        }</span><br><span class="line">      } else {</span><br><span class="line">        console.warn(`收到 Answer 但当前信令状态为 ${peer.value.signalingState}，忽略。`);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  // --- 更新 'candidate' 事件处理 ---</span><br><span class="line">  socketInstance.on("candidate", async (data) =&gt; { // 标记为 async</span><br><span class="line">    // 确保 PeerConnection 实例存在，并且收到的 candidate 有效</span><br><span class="line">    if (peer.value &amp;&amp; data.candidate &amp;&amp; peer.value.signalingState !== 'closed') {</span><br><span class="line">      try {</span><br><span class="line">        // 使用收到的信息创建 RTCIceCandidate 对象并添加到 PeerConnection</span><br><span class="line">        await peer.value.addIceCandidate(new RTCIceCandidate(data.candidate));</span><br><span class="line">        console.log("已添加远端 ICE Candidate");</span><br><span class="line">      } catch (e) {</span><br><span class="line">        // 忽略添加候选者时可能出现的常见错误（例如重复添加、状态不对等）</span><br><span class="line">        if (e instanceof DOMException &amp;&amp; e.name === 'OperationError') {</span><br><span class="line">          console.warn(`添加 ICE Candidate 时忽略错误: ${e.message}`);</span><br><span class="line">        } else {</span><br><span class="line">          console.error("添加远端 ICE Candidate 失败:", e);</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    } else if (!data.candidate) {</span><br><span class="line">      console.log("收到 null ICE Candidate (对方收集完成)");</span><br><span class="line">    } else {</span><br><span class="line">      console.warn("收到 Candidate 但 PC 不存在或已关闭");</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  socketInstance.on("peerJoined", (data) =&gt; { console.log(`通知: ${data.peerId} 加入房间`); });</span><br><span class="line">  socketInstance.on("peerLeft", (data) =&gt; { console.log(`通知: ${data.peerId} 离开房间`); });</span><br><span class="line">  // -----------------------------</span><br><span class="line"></span><br><span class="line">  socket.value = socketInstance;</span><br><span class="line">});</span><br><span class="line">// 组件卸载时清理资源</span><br><span class="line">onUnmounted(() =&gt; {</span><br><span class="line">  if (socket.value) {</span><br><span class="line">    socket.value.disconnect();</span><br><span class="line">  }</span><br><span class="line">  cleanupRTC(); // 确保 WebRTC 也被清理</span><br><span class="line">});</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="min-h-screen bg-base-100 transition-colors duration-300 font-sans" :data-theme="currentTheme"&gt;</span><br><span class="line">    &lt;div class="flex flex-col items-center justify-between p-4 md:p-8 min-h-screen"&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="card w-full max-w-3xl bg-base-200 shadow-xl mb-4"&gt;</span><br><span class="line">        &lt;div class="card-body items-center text-center"&gt;</span><br><span class="line">          &lt;p class="text-sm md:text-base"&gt;使用WebRTC技术，实现高质量的视频通话&lt;/p&gt;</span><br><span class="line">          &lt;p class="mt-2"&gt;状态: &lt;span :class="statusClass" class="font-semibold badge badge-md md:badge-lg text-white"&gt;{{</span><br><span class="line">            status</span><br><span class="line">              }}&lt;/span&gt;&lt;/p&gt;</span><br><span class="line">          &lt;p v-if="errorMessage" class="text-error text-sm mt-1"&gt;{{ errorMessage }}&lt;/p&gt;</span><br><span class="line">          &lt;p class="text-sm mt-1 text-gray-500"&gt;房间号: {{ roomId }}&lt;/p&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="relative w-full max-w-3xl aspect-video bg-black rounded-lg overflow-hidden shadow-lg"&gt;</span><br><span class="line">        &lt;video ref="localVideo" autoplay playsinline muted</span><br><span class="line">          class="absolute inset-0 w-full h-full object-cover z-0 aspect-ratio"&gt;&lt;/video&gt;</span><br><span class="line">        &lt;video ref="remoteVideo" autoplay playsinline</span><br><span class="line">          class="w-1/4 max-w-[160px] h-auto absolute bottom-4 right-4 object-cover border-2 border-base-300 rounded shadow-md z-10 transition-opacity duration-300 remote-video"</span><br><span class="line">          :class="{ 'opacity-0 pointer-events-none': !communicating }"&gt;&lt;/video&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dialog id="waiting_modal" class="modal" :open="caller &amp;&amp; calling"&gt;</span><br><span class="line">          &lt;div class="modal-box"&gt;</span><br><span class="line">            &lt;h3 class="text-lg font-bold"&gt;等待对方接听...&lt;/h3&gt;</span><br><span class="line">            &lt;p class="py-4"&gt;请耐心等待对方接受您的视频邀请&lt;/p&gt;</span><br><span class="line">            &lt;div class="modal-action"&gt;</span><br><span class="line">              &lt;button class="btn btn-primary" @click="hangUp"&gt;取消&lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;form method="dialog" class="modal-backdrop"&gt;</span><br><span class="line">            &lt;button @click="hangUp"&gt;关闭&lt;/button&gt;</span><br><span class="line">          &lt;/form&gt;</span><br><span class="line">        &lt;/dialog&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div v-if="called &amp;&amp; calling"</span><br><span class="line">          class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-70 text-white z-20"&gt;</span><br><span class="line">          &lt;p class="mb-4 text-lg"&gt;收到视频邀请...&lt;/p&gt;</span><br><span class="line">          &lt;div class="flex gap-4"&gt;</span><br><span class="line">            &lt;button @click="hangUp" class="btn btn-circle btn-error btn-lg" aria-label="拒绝"&gt;</span><br><span class="line">              ✗</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">            &lt;button @click="acceptCall" class="btn btn-circle btn-success btn-lg" aria-label="接受"&gt;</span><br><span class="line">              ✓</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="flex gap-4 mt-4"&gt;</span><br><span class="line">        &lt;button class="btn btn-primary text-white" @click="callRemote"</span><br><span class="line">          :disabled="communicating || calling || caller || called"&gt;</span><br><span class="line">          发起视频</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">        &lt;button class="btn btn-error btn-outline" @click="hangUp"&gt;</span><br><span class="line">          挂断</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div v-if="stats" class="mt-4 p-2 bg-base-300 rounded shadow w-full max-w-3xl"&gt;</span><br><span class="line">        &lt;h3 class="text-sm font-semibold mb-1"&gt;WebRTC 统计 (示例)&lt;/h3&gt;</span><br><span class="line">        &lt;pre class="text-xs overflow-auto max-h-24 bg-base-100 p-1 rounded"&gt;{{ JSON.stringify(stats, null, 2) }}&lt;/pre&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">.content-container {</span><br><span class="line">  display: flex;</span><br><span class="line">  flex-direction: column;</span><br><span class="line">  align-items: center;</span><br><span class="line">  justify-content: space-between;</span><br><span class="line">  /* 让按钮区域和状态信息在底部 */</span><br><span class="line">  padding: 1rem;</span><br><span class="line">  /* 调整内边距 */</span><br><span class="line">  min-height: 100vh;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.video-container {</span><br><span class="line">  position: relative;</span><br><span class="line">  /* 确保子元素绝对定位是相对于此容器 */</span><br><span class="line">  width: 100%;</span><br><span class="line">  /* 占据可用宽度 */</span><br><span class="line">  /* max-width: 800px; */</span><br><span class="line">  /* 可以限制最大宽度 */</span><br><span class="line">  /* aspect-ratio: 16 / 9; */</span><br><span class="line">  /* 保持16:9比例 */</span><br><span class="line">  background-color: #000;</span><br><span class="line">  /* 背景设为黑色 */</span><br><span class="line">  /* 移除固定的 height: 100% */</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.main-video {</span><br><span class="line">  /* 用于本地视频，充满容器 */</span><br><span class="line">  display: block;</span><br><span class="line">  /* 避免 video 底部空隙 */</span><br><span class="line">  width: 100%;</span><br><span class="line">  height: 100%;</span><br><span class="line">  object-fit: cover;</span><br><span class="line">  /* 覆盖整个区域，可能裁剪 */</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.remote-video {</span><br><span class="line">  /* 用于远端视频，小窗效果 */</span><br><span class="line">  /* 样式已在 class 属性中定义 */</span><br><span class="line">  background-color: #222;</span><br><span class="line">  /* 给小窗加个背景色 */</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><hr><p><strong>运行与测试:</strong></p><ol><li><strong>启动后端:</strong> <code>python server_flask.py</code></li><li><strong>启动前端:</strong> <code>npm run dev</code></li><li><strong>测试:</strong> 使用两个浏览器窗口或设备进行完整的呼叫、接听、显示视频、查看统计、挂断流程。使用浏览器开发者工具和后端的日志进行调试。</li></ol><p>这份代码整合了所有步骤，并进行了一些优化和错误处理的改进，形成了一个功能更完整、代码结构更清晰的版本。</p><h5 id="5-进阶实现-调优"><a href="#5-进阶实现-调优" class="headerlink" title="5.进阶实现+调优"></a>5.进阶实现+调优</h5><h6 id="实战-通过-aiortc-做一个超低延迟摄像头转播"><a href="#实战-通过-aiortc-做一个超低延迟摄像头转播" class="headerlink" title="实战 : 通过 aiortc 做一个超低延迟摄像头转播"></a>实战 : 通过 aiortc 做一个超低延迟摄像头转播</h6><h6 id="前端代码（采用-VUE3-daisyui-tailwindcss-实现）"><a href="#前端代码（采用-VUE3-daisyui-tailwindcss-实现）" class="headerlink" title="前端代码（采用 VUE3+daisyui+tailwindcss 实现）"></a>前端代码（采用 VUE3+daisyui+tailwindcss 实现）</h6><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh-CN"</span> <span class="attr">data-theme</span>=<span class="string">"dark"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Python WebRTC 摄像头实时流 (优化)<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 可选: 添加一些基本的 body 样式 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> {</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: sans-serif;</span></span><br><span class="line"><span class="language-css">        }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-id">#app</span> {</span></span><br><span class="line"><span class="language-css">            <span class="attribute">max-width</span>: <span class="number">800px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">2rem</span> auto;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">1rem</span>;</span></span><br><span class="line"><span class="language-css">        }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 让 video 元素默认背景为黑色，减少白屏闪烁 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">video</span> {</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#000</span>;</span></span><br><span class="line"><span class="language-css">        }</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">"bg-base-200"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span> <span class="attr">class</span>=<span class="string">"p-4"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"text-3xl font-bold mb-4 text-center text-primary"</span>&gt;</span>Python WebRTC 摄像头<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card bg-base-100 shadow-xl mb-6"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">figure</span> <span class="attr">class</span>=<span class="string">"bg-black"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">video</span> <span class="attr">ref</span>=<span class="string">"videoElement"</span> <span class="attr">autoplay</span> <span class="attr">playsinline</span> <span class="attr">muted</span> <span class="attr">class</span>=<span class="string">"w-full h-auto aspect-video"</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">figure</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card-body items-center text-center"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"mb-2"</span>&gt;</span>状态: <span class="tag">&lt;<span class="name">span</span> <span class="attr">:class</span>=<span class="string">"statusClass"</span> <span class="attr">class</span>=<span class="string">"font-semibold badge badge-lg"</span>&gt;</span>{{ status }}<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card-actions"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"startStreaming"</span> <span class="attr">:disabled</span>=<span class="string">"isConnected || isConnecting"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span></span><br><span class="line">                        开始推流</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"stopStreaming"</span> <span class="attr">:disabled</span>=<span class="string">"!isConnected &amp;&amp; !isConnecting"</span> <span class="attr">class</span>=<span class="string">"btn btn-secondary"</span>&gt;</span></span><br><span class="line">                        停止推流</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-if</span>=<span class="string">"errorMessage"</span> <span class="attr">class</span>=<span class="string">"text-error mt-2"</span>&gt;</span>{{ errorMessage }}<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"text-center text-xs text-base-content/70"</span>&gt;</span></span><br><span class="line">            建议使用 Chrome/Edge 访问 <span class="tag">&lt;<span class="name">code</span> <span class="attr">class</span>=<span class="string">"bg-base-300 px-1 rounded"</span>&gt;</span>chrome://webrtc-internals<span class="tag">&lt;/<span class="name">code</span>&gt;</span> 或 Firefox 访问</span><br><span class="line">            <span class="tag">&lt;<span class="name">code</span> <span class="attr">class</span>=<span class="string">"bg-base-300 px-1 rounded"</span>&gt;</span>about:webrtc<span class="tag">&lt;/<span class="name">code</span>&gt;</span> 查看连接详情。</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"stats"</span> <span class="attr">class</span>=<span class="string">"mt-4 p-4 bg-base-100 rounded shadow"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"text-lg font-semibold mb-2"</span>&gt;</span>WebRTC 统计 (示例)<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pre</span></span></span><br><span class="line"><span class="tag">                <span class="attr">class</span>=<span class="string">"text-xs overflow-auto max-h-48 bg-base-200 p-2 rounded"</span>&gt;</span>{{ JSON.stringify(stats, null, 2) }}<span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/vue@3/dist/vue.global.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> { createApp, ref, computed, onMounted, onUnmounted } = <span class="title class_">Vue</span>; <span class="comment">// 从 Vue 全局对象解构所需函数</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> app = <span class="title function_">createApp</span>({ <span class="comment">// 创建 Vue 应用</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">setup</span>(<span class="params"></span>) { <span class="comment">// 使用 Composition API</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// --- 响应式状态 ---</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> status = <span class="title function_">ref</span>(<span class="string">'空闲'</span>); <span class="comment">// 状态: 空闲, 连接中, 已连接, 已断开, 错误</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> isConnecting = <span class="title function_">ref</span>(<span class="literal">false</span>); <span class="comment">// 是否正在连接</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> isConnected = <span class="title function_">ref</span>(<span class="literal">false</span>); <span class="comment">// 是否已连接</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> errorMessage = <span class="title function_">ref</span>(<span class="string">''</span>); <span class="comment">// 错误消息</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> videoElement = <span class="title function_">ref</span>(<span class="literal">null</span>); <span class="comment">// 用于持有 &lt;video&gt; DOM 元素的引用</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> ws = <span class="title function_">ref</span>(<span class="literal">null</span>);           <span class="comment">// WebSocket 实例</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> pc = <span class="title function_">ref</span>(<span class="literal">null</span>);           <span class="comment">// RTCPeerConnection 实例</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> stats = <span class="title function_">ref</span>(<span class="literal">null</span>); <span class="comment">// 用于显示统计信息 (可选)</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> statsIntervalId = <span class="literal">null</span>; <span class="comment">// 存储统计定时器的ID</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// --- 计算属性 ---</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 根据状态动态计算 CSS 类名</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> statusClass = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">switch</span> (status.<span class="property">value</span>) {</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">case</span> <span class="string">'已连接'</span>: <span class="keyword">return</span> <span class="string">'badge-success'</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">case</span> <span class="string">'连接中'</span>: <span class="keyword">return</span> <span class="string">'badge-info'</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">case</span> <span class="string">'错误'</span>: <span class="keyword">return</span> <span class="string">'badge-error'</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">case</span> <span class="string">'已断开'</span>:</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">case</span> <span class="string">'空闲'</span>:</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">default</span>: <span class="keyword">return</span> <span class="string">'badge-neutral'</span>;</span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript">                });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// --- WebRTC 配置 (加入 STUN 服务器) ---</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> pcConfig = {</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">iceServers</span>: [</span></span><br><span class="line"><span class="language-javascript">                        { <span class="attr">urls</span>: <span class="string">'stun:stun.l.google.com:19302'</span> },</span></span><br><span class="line"><span class="language-javascript">                        { <span class="attr">urls</span>: <span class="string">'stun:stun1.l.google.com:19302'</span> }</span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 你可以添加更多的 STUN 服务器或你自己的 TURN 服务器</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// { urls: 'turn:your.turn.server:3478', username: 'user', credential: 'password' }</span></span></span><br><span class="line"><span class="language-javascript">                    ]</span></span><br><span class="line"><span class="language-javascript">                };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// --- 方法 ---</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 清理 WebRTC 资源</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> <span class="title function_">cleanupRTC</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"清理 WebRTC 资源..."</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (statsIntervalId) {</span></span><br><span class="line"><span class="language-javascript">                        <span class="built_in">clearInterval</span>(statsIntervalId); <span class="comment">// 清除统计定时器</span></span></span><br><span class="line"><span class="language-javascript">                        statsIntervalId = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                        stats.<span class="property">value</span> = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"WebRTC 统计定时器已清除。"</span>);</span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (pc.<span class="property">value</span>) {</span></span><br><span class="line"><span class="language-javascript">                        pc.<span class="property">value</span>.<span class="property">onicecandidate</span> = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                        pc.<span class="property">value</span>.<span class="property">ontrack</span> = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                        pc.<span class="property">value</span>.<span class="property">onconnectionstatechange</span> = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 关闭所有发送器和接收器 (更彻底的清理)</span></span></span><br><span class="line"><span class="language-javascript">                        pc.<span class="property">value</span>.<span class="title function_">getSenders</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">sender</span> =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">if</span> (sender.<span class="property">track</span>) {</span></span><br><span class="line"><span class="language-javascript">                                sender.<span class="property">track</span>.<span class="title function_">stop</span>(); <span class="comment">// 停止轨道（如果是本地轨道）</span></span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                        });</span></span><br><span class="line"><span class="language-javascript">                        pc.<span class="property">value</span>.<span class="title function_">getReceivers</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">receiver</span> =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">if</span> (receiver.<span class="property">track</span>) {</span></span><br><span class="line"><span class="language-javascript">                                receiver.<span class="property">track</span>.<span class="title function_">stop</span>(); <span class="comment">// 停止接收到的轨道</span></span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                        });</span></span><br><span class="line"><span class="language-javascript">                        pc.<span class="property">value</span>.<span class="title function_">close</span>(); <span class="comment">// 关闭 PeerConnection</span></span></span><br><span class="line"><span class="language-javascript">                        pc.<span class="property">value</span> = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"PeerConnection 已关闭并清理。"</span>);</span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (videoElement.<span class="property">value</span> &amp;&amp; videoElement.<span class="property">value</span>.<span class="property">srcObject</span>) {</span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 停止视频流的所有轨道</span></span></span><br><span class="line"><span class="language-javascript">                        videoElement.<span class="property">value</span>.<span class="property">srcObject</span>.<span class="title function_">getTracks</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">track</span> =&gt;</span> track.<span class="title function_">stop</span>());</span></span><br><span class="line"><span class="language-javascript">                        videoElement.<span class="property">value</span>.<span class="property">srcObject</span> = <span class="literal">null</span>; <span class="comment">// 清空 video 元素的源</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Video 元素 srcObject 已清理。"</span>);</span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript">                };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 清理 WebSocket 资源</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> <span class="title function_">cleanupWebSocket</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (ws.<span class="property">value</span>) {</span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"清理 WebSocket 资源..."</span>);</span></span><br><span class="line"><span class="language-javascript">                        ws.<span class="property">value</span>.<span class="property">onopen</span> = ws.<span class="property">value</span>.<span class="property">onmessage</span> = ws.<span class="property">value</span>.<span class="property">onclose</span> = ws.<span class="property">value</span>.<span class="property">onerror</span> = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">if</span> (ws.<span class="property">value</span>.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span> || ws.<span class="property">value</span>.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">CONNECTING</span>) {</span></span><br><span class="line"><span class="language-javascript">                            ws.<span class="property">value</span>.<span class="title function_">close</span>(); <span class="comment">// 关闭 WebSocket</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"WebSocket 已关闭。"</span>);</span></span><br><span class="line"><span class="language-javascript">                        } <span class="keyword">else</span> {</span></span><br><span class="line"><span class="language-javascript">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`WebSocket 状态为 <span class="subst">${ws.value.readyState}</span>，无需关闭。`</span>);</span></span><br><span class="line"><span class="language-javascript">                        }</span></span><br><span class="line"><span class="language-javascript">                        ws.<span class="property">value</span> = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript">                };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 连接 WebSocket</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> <span class="title function_">connectWebSocket</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 判断 WebSocket 协议 (ws:// 或 wss://)</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">const</span> wsProtocol = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">protocol</span> === <span class="string">'https:'</span> ? <span class="string">'wss://'</span> : <span class="string">'ws://'</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 假设服务器在同一主机，不同端口（如果需要请调整）</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 使用 127.0.0.1 可能比 localhost 更可靠，尤其是在某些系统配置下</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">const</span> wsHost = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">hostname</span> === <span class="string">'localhost'</span> ? <span class="string">'127.0.0.1'</span> : <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">hostname</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">const</span> wsUrl = <span class="string">`<span class="subst">${wsProtocol}</span><span class="subst">${wsHost}</span>:8080/ws`</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`尝试连接 WebSocket 到: <span class="subst">${wsUrl}</span>`</span>);</span></span><br><span class="line"><span class="language-javascript">                        status.<span class="property">value</span> = <span class="string">'连接中'</span>;</span></span><br><span class="line"><span class="language-javascript">                        isConnecting.<span class="property">value</span> = <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">                        errorMessage.<span class="property">value</span> = <span class="string">''</span>; <span class="comment">// 清空之前的错误</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 清理可能存在的旧连接</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">cleanupWebSocket</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                        ws.<span class="property">value</span> = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(wsUrl); <span class="comment">// 创建 WebSocket 实例</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                        ws.<span class="property">value</span>.<span class="property">onopen</span> = <span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"WebSocket 连接已建立"</span>);</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 连接成功后，继续 WebRTC 流程</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="title function_">resolve</span>(); <span class="comment">// WebSocket 连接成功，解析 Promise</span></span></span><br><span class="line"><span class="language-javascript">                        };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                        ws.<span class="property">value</span>.<span class="property">onmessage</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 处理从服务器收到的信令消息</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">                                <span class="title function_">handleSignalingMessage</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(event.<span class="property">data</span>));</span></span><br><span class="line"><span class="language-javascript">                            } <span class="keyword">catch</span> (e) {</span></span><br><span class="line"><span class="language-javascript">                                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"解析收到的消息失败:"</span>, event.<span class="property">data</span>, e);</span></span><br><span class="line"><span class="language-javascript">                                errorMessage.<span class="property">value</span> = <span class="string">"收到无效的服务器消息。"</span>;</span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                        };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                        ws.<span class="property">value</span>.<span class="property">onclose</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 处理 WebSocket 关闭事件</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`WebSocket 已关闭: 代码=<span class="subst">${event.code}</span>, 原因=<span class="subst">${event.reason || <span class="string">'(无原因)'</span>}</span>, 是否正常关闭=<span class="subst">${event.wasClean}</span>`</span>);</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">if</span> (status.<span class="property">value</span> !== <span class="string">'错误'</span> &amp;&amp; status.<span class="property">value</span> !== <span class="string">'空闲'</span>) { <span class="comment">// 不要覆盖 错误/空闲 状态</span></span></span><br><span class="line"><span class="language-javascript">                                status.<span class="property">value</span> = <span class="string">'已断开'</span>;</span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                            isConnected.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                            isConnecting.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                            <span class="title function_">cleanupRTC</span>(); <span class="comment">// 如果 WebSocket 关闭，也清理 WebRTC</span></span></span><br><span class="line"><span class="language-javascript">                            ws.<span class="property">value</span> = <span class="literal">null</span>; <span class="comment">// 清理实例</span></span></span><br><span class="line"><span class="language-javascript">                        };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                        ws.<span class="property">value</span>.<span class="property">onerror</span> = <span class="function">(<span class="params">error</span>) =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 处理 WebSocket 错误</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"WebSocket 错误:"</span>, error);</span></span><br><span class="line"><span class="language-javascript">                            errorMessage.<span class="property">value</span> = <span class="string">'WebSocket 连接错误。请检查服务器是否运行，以及网络连接。'</span>;</span></span><br><span class="line"><span class="language-javascript">                            status.<span class="property">value</span> = <span class="string">'错误'</span>;</span></span><br><span class="line"><span class="language-javascript">                            isConnected.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                            isConnecting.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                            <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">'WebSocket connection failed'</span>)); <span class="comment">// 出错时拒绝 Promise</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="title function_">cleanupRTC</span>(); <span class="comment">// 出错时清理 WebRTC</span></span></span><br><span class="line"><span class="language-javascript">                            ws.<span class="property">value</span> = <span class="literal">null</span>; <span class="comment">// 清理实例</span></span></span><br><span class="line"><span class="language-javascript">                        };</span></span><br><span class="line"><span class="language-javascript">                    });</span></span><br><span class="line"><span class="language-javascript">                };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 开始推流过程</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> <span class="title function_">startStreaming</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 防止重复点击</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (isConnected.<span class="property">value</span> || isConnecting.<span class="property">value</span>) {</span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"已在连接中或已连接。"</span>);</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"开始推流处理 (优化版)..."</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 1. 首先连接 WebSocket</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">await</span> <span class="title function_">connectWebSocket</span>(); <span class="comment">// 等待 WebSocket 成功连接</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 2. 设置 PeerConnection</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"设置 PeerConnection (优化版)..."</span>);</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">cleanupRTC</span>(); <span class="comment">// 清理可能存在的旧 PeerConnection</span></span></span><br><span class="line"><span class="language-javascript">                        pc.<span class="property">value</span> = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>(pcConfig); <span class="comment">// 创建 PeerConnection</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 处理 ICE 候选者：当本地生成 ICE 候选者时，通过 WebSocket 发送给服务器</span></span></span><br><span class="line"><span class="language-javascript">                        pc.<span class="property">value</span>.<span class="property">onicecandidate</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">if</span> (event.<span class="property">candidate</span> &amp;&amp; ws.<span class="property">value</span> &amp;&amp; ws.<span class="property">value</span>.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) {</span></span><br><span class="line"><span class="language-javascript">                                <span class="comment">// console.log("发送 ICE 候选者:", event.candidate.candidate.substring(0, 30) + "..."); // 缩短日志输出</span></span></span><br><span class="line"><span class="language-javascript">                                ws.<span class="property">value</span>.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>({</span></span><br><span class="line"><span class="language-javascript">                                    <span class="attr">type</span>: <span class="string">"ice"</span>,</span></span><br><span class="line"><span class="language-javascript">                                    <span class="attr">candidate</span>: event.<span class="property">candidate</span>.<span class="title function_">toJSON</span>() <span class="comment">// 发送 JSON 格式</span></span></span><br><span class="line"><span class="language-javascript">                                }));</span></span><br><span class="line"><span class="language-javascript">                            } <span class="keyword">else</span> <span class="keyword">if</span> (!event.<span class="property">candidate</span>) {</span></span><br><span class="line"><span class="language-javascript">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"ICE 收集完成。"</span>);</span></span><br><span class="line"><span class="language-javascript">                            } <span class="keyword">else</span> {</span></span><br><span class="line"><span class="language-javascript">                                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"WebSocket 未打开或不存在，无法发送 ICE 候选者。"</span>);</span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                        };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 处理传入的轨道：当收到远端（服务器）的视频轨道时</span></span></span><br><span class="line"><span class="language-javascript">                        pc.<span class="property">value</span>.<span class="property">ontrack</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"收到远端轨道:"</span>, event.<span class="property">track</span>);</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 将收到的流附加到 video 元素上进行播放</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">if</span> (event.<span class="property">streams</span> &amp;&amp; event.<span class="property">streams</span>[<span class="number">0</span>] &amp;&amp; videoElement.<span class="property">value</span>) {</span></span><br><span class="line"><span class="language-javascript">                                <span class="comment">// 检查 srcObject 是否已经设置，避免重复设置或冲突</span></span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">if</span> (videoElement.<span class="property">value</span>.<span class="property">srcObject</span> !== event.<span class="property">streams</span>[<span class="number">0</span>]) {</span></span><br><span class="line"><span class="language-javascript">                                    videoElement.<span class="property">value</span>.<span class="property">srcObject</span> = event.<span class="property">streams</span>[<span class="number">0</span>];</span></span><br><span class="line"><span class="language-javascript">                                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"已将流分配给 video 元素"</span>);</span></span><br><span class="line"><span class="language-javascript">                                    <span class="comment">// 连接成功且轨道已附加后开始获取统计信息</span></span></span><br><span class="line"><span class="language-javascript">                                    <span class="title function_">startGettingStats</span>();</span></span><br><span class="line"><span class="language-javascript">                                }</span></span><br><span class="line"><span class="language-javascript">                            } <span class="keyword">else</span> {</span></span><br><span class="line"><span class="language-javascript">                                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"无法将流分配给 video 元素 (元素不存在或流无效)。"</span>);</span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                        };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 处理连接状态变化：监控 PeerConnection 的连接状态</span></span></span><br><span class="line"><span class="language-javascript">                        pc.<span class="property">value</span>.<span class="property">onconnectionstatechange</span> = <span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">if</span> (!pc.<span class="property">value</span>) {</span></span><br><span class="line"><span class="language-javascript">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"onconnectionstatechange 触发时 pc 已清理，忽略。"</span>);</span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">return</span>; <span class="comment">// 防止在清理后触发</span></span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">const</span> state = pc.<span class="property">value</span>.<span class="property">connectionState</span>;</span></span><br><span class="line"><span class="language-javascript">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`PeerConnection 状态改变: <span class="subst">${state}</span>`</span>);</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">switch</span> (state) {</span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">case</span> <span class="string">"connecting"</span>:</span></span><br><span class="line"><span class="language-javascript">                                    status.<span class="property">value</span> = <span class="string">"连接中"</span>; <span class="comment">// 更新状态</span></span></span><br><span class="line"><span class="language-javascript">                                    isConnecting.<span class="property">value</span> = <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">                                    isConnected.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">case</span> <span class="string">"connected"</span>:</span></span><br><span class="line"><span class="language-javascript">                                    status.<span class="property">value</span> = <span class="string">"已连接"</span>; <span class="comment">// 更新状态</span></span></span><br><span class="line"><span class="language-javascript">                                    isConnecting.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                                    isConnected.<span class="property">value</span> = <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">                                    errorMessage.<span class="property">value</span> = <span class="string">''</span>; <span class="comment">// 清除错误信息</span></span></span><br><span class="line"><span class="language-javascript">                                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">case</span> <span class="string">"disconnected"</span>: <span class="comment">// 连接断开，可能可以恢复，保持 isConnected=false</span></span></span><br><span class="line"><span class="language-javascript">                                    status.<span class="property">value</span> = <span class="string">'已断开'</span>;</span></span><br><span class="line"><span class="language-javascript">                                    isConnected.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                                    isConnecting.<span class="property">value</span> = <span class="literal">false</span>; <span class="comment">// 不再是正在连接状态</span></span></span><br><span class="line"><span class="language-javascript">                                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"WebRTC 连接已断开，可能尝试自动重连..."</span>);</span></span><br><span class="line"><span class="language-javascript">                                    <span class="comment">// 这里可以选择不调用 stopStreaming，WebRTC 可能会自动尝试恢复</span></span></span><br><span class="line"><span class="language-javascript">                                    <span class="comment">// 如果需要手动停止，可以在这里调用 stopStreaming()</span></span></span><br><span class="line"><span class="language-javascript">                                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">case</span> <span class="string">"failed"</span>: <span class="comment">// 连接失败，无法恢复</span></span></span><br><span class="line"><span class="language-javascript">                                    status.<span class="property">value</span> = <span class="string">'错误'</span>;</span></span><br><span class="line"><span class="language-javascript">                                    errorMessage.<span class="property">value</span> = <span class="string">'WebRTC 连接失败。请检查网络或 STUN/TURN 服务器配置。'</span>;</span></span><br><span class="line"><span class="language-javascript">                                    isConnected.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                                    isConnecting.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                                    <span class="title function_">stopStreaming</span>(); <span class="comment">// 失败时彻底停止并清理</span></span></span><br><span class="line"><span class="language-javascript">                                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">case</span> <span class="string">"closed"</span>: <span class="comment">// 连接已关闭</span></span></span><br><span class="line"><span class="language-javascript">                                    status.<span class="property">value</span> = <span class="string">'已断开'</span>; <span class="comment">// 或者 '空闲'，取决于预期</span></span></span><br><span class="line"><span class="language-javascript">                                    isConnected.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                                    isConnecting.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                                    <span class="comment">// 通常是调用 stopStreaming() 导致的，这里无需再调用</span></span></span><br><span class="line"><span class="language-javascript">                                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"WebRTC 连接已关闭。"</span>);</span></span><br><span class="line"><span class="language-javascript">                                    <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                        };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 3. 创建并发送 Offer</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"创建 Offer (优化版)..."</span>);</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">const</span> offer = <span class="keyword">await</span> pc.<span class="property">value</span>.<span class="title function_">createOffer</span>({</span></span><br><span class="line"><span class="language-javascript">                            <span class="attr">offerToReceiveAudio</span>: <span class="literal">false</span>, <span class="comment">// 我们只发送视频，不接收音频</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="attr">offerToReceiveVideo</span>: <span class="literal">true</span>   <span class="comment">// 我们要接收视频</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// iceRestart: true // 如果需要强制重新进行 ICE 协商，可以设置此项</span></span></span><br><span class="line"><span class="language-javascript">                        });</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">await</span> pc.<span class="property">value</span>.<span class="title function_">setLocalDescription</span>(offer); <span class="comment">// 设置本地描述 (Offer)</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"本地描述 (Offer) 已设置，发送给服务器..."</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 通过 WebSocket 发送 Offer 给服务器</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">if</span> (ws.<span class="property">value</span> &amp;&amp; ws.<span class="property">value</span>.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) {</span></span><br><span class="line"><span class="language-javascript">                            ws.<span class="property">value</span>.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>({</span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">type</span>: <span class="string">"offer"</span>,</span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">sdp</span>: pc.<span class="property">value</span>.<span class="property">localDescription</span>.<span class="property">sdp</span>, <span class="comment">// 获取 SDP</span></span></span><br><span class="line"><span class="language-javascript">                                <span class="attr">type</span>: pc.<span class="property">value</span>.<span class="property">localDescription</span>.<span class="property">type</span> <span class="comment">// 获取类型 (offer)</span></span></span><br><span class="line"><span class="language-javascript">                            }));</span></span><br><span class="line"><span class="language-javascript">                        } <span class="keyword">else</span> {</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">"WebSocket 未连接，无法发送 Offer。"</span>);</span></span><br><span class="line"><span class="language-javascript">                        }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"启动推流失败:"</span>, error);</span></span><br><span class="line"><span class="language-javascript">                        errorMessage.<span class="property">value</span> = <span class="string">`启动失败: <span class="subst">${error.message || error}</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">                        status.<span class="property">value</span> = <span class="string">'错误'</span>;</span></span><br><span class="line"><span class="language-javascript">                        isConnected.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                        isConnecting.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">stopStreaming</span>(); <span class="comment">// 出错时尝试清理</span></span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript">                };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 停止推流过程</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> <span class="title function_">stopStreaming</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"停止推流..."</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">cleanupWebSocket</span>(); <span class="comment">// 清理 WebSocket</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">cleanupRTC</span>();       <span class="comment">// 清理 WebRTC</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 只有当状态不是错误时才重置为空闲，否则保持错误状态</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (status.<span class="property">value</span> !== <span class="string">'错误'</span>) {</span></span><br><span class="line"><span class="language-javascript">                        status.<span class="property">value</span> = <span class="string">'空闲'</span>;</span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript">                    isConnected.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                    isConnecting.<span class="property">value</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 保留错误信息，除非是用户手动停止</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// errorMessage.value = ''; // 可以取消注释这一行，如果希望停止时总是清除错误信息</span></span></span><br><span class="line"><span class="language-javascript">                };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 处理从 WebSocket 收到的信令消息</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> <span class="title function_">handleSignalingMessage</span> = <span class="keyword">async</span> (<span class="params">data</span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 在处理 answer 或 ice 前检查 pc 是否存在</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (!pc.<span class="property">value</span> &amp;&amp; (data.<span class="property">type</span> === <span class="string">'answer'</span> || data.<span class="property">type</span> === <span class="string">'ice'</span>)) {</span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"收到信令消息，但 PeerConnection 不存在或已清理:"</span>, data.<span class="property">type</span>);</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"处理信令消息:"</span>, data.<span class="property">type</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">if</span> (data.<span class="property">type</span> === <span class="string">"answer"</span>) {</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 收到服务器的 Answer</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">if</span> (pc.<span class="property">value</span>.<span class="property">signalingState</span> !== <span class="string">'have-local-offer'</span>) {</span></span><br><span class="line"><span class="language-javascript">                                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`收到 Answer 但当前信令状态为 <span class="subst">${pc.value.signalingState}</span>，忽略。`</span>);</span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">const</span> answer = <span class="keyword">new</span> <span class="title class_">RTCSessionDescription</span>({ <span class="attr">sdp</span>: data.<span class="property">sdp</span>, <span class="attr">type</span>: data.<span class="property">type</span> });</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">await</span> pc.<span class="property">value</span>.<span class="title function_">setRemoteDescription</span>(answer); <span class="comment">// 设置远端描述 (Answer)</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"远端描述 (Answer) 已设置。"</span>);</span></span><br><span class="line"><span class="language-javascript">                        } <span class="keyword">else</span> <span class="keyword">if</span> (data.<span class="property">type</span> === <span class="string">"ice"</span>) {</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 收到服务器的 ICE 候选者</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">if</span> (data.<span class="property">candidate</span>) {</span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">const</span> candidate = <span class="keyword">new</span> <span class="title class_">RTCIceCandidate</span>(data.<span class="property">candidate</span>);</span></span><br><span class="line"><span class="language-javascript">                                <span class="comment">// 在添加前检查状态，避免在 closed 状态下添加</span></span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">if</span> (pc.<span class="property">value</span>.<span class="property">signalingState</span> !== <span class="string">'closed'</span>) {</span></span><br><span class="line"><span class="language-javascript">                                    <span class="keyword">await</span> pc.<span class="property">value</span>.<span class="title function_">addIceCandidate</span>(candidate); <span class="comment">// 添加 ICE 候选者</span></span></span><br><span class="line"><span class="language-javascript">                                    <span class="comment">// console.log("添加来自服务器的 ICE 候选者。");</span></span></span><br><span class="line"><span class="language-javascript">                                } <span class="keyword">else</span> {</span></span><br><span class="line"><span class="language-javascript">                                    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"PeerConnection 已关闭，忽略收到的 ICE 候选者。"</span>);</span></span><br><span class="line"><span class="language-javascript">                                }</span></span><br><span class="line"><span class="language-javascript">                            } <span class="keyword">else</span> {</span></span><br><span class="line"><span class="language-javascript">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"收到来自服务器的 null ICE 候选者（收集结束）。"</span>);</span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                        } <span class="keyword">else</span> <span class="keyword">if</span> (data.<span class="property">type</span> === <span class="string">"error"</span>) {</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 处理服务器发送的错误消息</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"收到来自服务器的错误消息:"</span>, data.<span class="property">message</span>);</span></span><br><span class="line"><span class="language-javascript">                            errorMessage.<span class="property">value</span> = <span class="string">`服务器错误: <span class="subst">${data.message || <span class="string">'未知错误'</span>}</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">                            status.<span class="property">value</span> = <span class="string">'错误'</span>;</span></span><br><span class="line"><span class="language-javascript">                            <span class="title function_">stopStreaming</span>(); <span class="comment">// 收到服务器错误时停止</span></span></span><br><span class="line"><span class="language-javascript">                        }</span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 可以添加其他信令消息类型处理</span></span></span><br><span class="line"><span class="language-javascript">                    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"处理信令消息时出错:"</span>, error, <span class="string">"消息类型:"</span>, data.<span class="property">type</span>);</span></span><br><span class="line"><span class="language-javascript">                        errorMessage.<span class="property">value</span> = <span class="string">`处理信令失败 (<span class="subst">${data.type}</span>): <span class="subst">${error.message || error}</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">                        status.<span class="property">value</span> = <span class="string">'错误'</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">stopStreaming</span>(); <span class="comment">// 处理信令出错时停止</span></span></span><br><span class="line"><span class="language-javascript">                    }</span></span><br><span class="line"><span class="language-javascript">                };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// --- WebRTC 统计 ---</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 开始定时获取统计信息</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> <span class="title function_">startGettingStats</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (statsIntervalId) <span class="built_in">clearInterval</span>(statsIntervalId); <span class="comment">// 清除旧的定时器</span></span></span><br><span class="line"><span class="language-javascript">                    statsIntervalId = <span class="built_in">setInterval</span>(<span class="title function_">async</span> () =&gt; {</span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 确保 PeerConnection 存在且处于连接状态</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">if</span> (pc.<span class="property">value</span> &amp;&amp; pc.<span class="property">value</span>.<span class="property">connectionState</span> === <span class="string">'connected'</span>) {</span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">const</span> report = <span class="keyword">await</span> pc.<span class="property">value</span>.<span class="title function_">getStats</span>(<span class="literal">null</span>); <span class="comment">// 获取所有统计信息</span></span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">let</span> interestingStats = {}; <span class="comment">// 存储我们关心的统计数据</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                                report.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                                    <span class="comment">// 筛选一些常用的统计信息</span></span></span><br><span class="line"><span class="language-javascript">                                    <span class="comment">// 入站 RTP 视频流统计</span></span></span><br><span class="line"><span class="language-javascript">                                    <span class="keyword">if</span> (item.<span class="property">type</span> === <span class="string">'inbound-rtp'</span> &amp;&amp; item.<span class="property">kind</span> === <span class="string">'video'</span>) {</span></span><br><span class="line"><span class="language-javascript">                                        interestingStats.<span class="property">inboundVideo</span> = {</span></span><br><span class="line"><span class="language-javascript">                                            收到的包数: item.<span class="property">packetsReceived</span>,</span></span><br><span class="line"><span class="language-javascript">                                            收到的字节数: item.<span class="property">bytesReceived</span>,</span></span><br><span class="line"><span class="language-javascript">                                            解码的帧数: item.<span class="property">framesDecoded</span>,</span></span><br><span class="line"><span class="language-javascript">                                            抖动: item.<span class="property">jitter</span>?.<span class="title function_">toFixed</span>(<span class="number">4</span>), <span class="comment">// 抖动，网络延迟变化</span></span></span><br><span class="line"><span class="language-javascript">                                            丢失的包数: item.<span class="property">packetsLost</span>, <span class="comment">// 丢包数</span></span></span><br><span class="line"><span class="language-javascript">                                            时间戳: <span class="keyword">new</span> <span class="title class_">Date</span>(item.<span class="property">timestamp</span>).<span class="title function_">toLocaleTimeString</span>(),</span></span><br><span class="line"><span class="language-javascript">                                            <span class="variable constant_">NACK</span>请求数: item.<span class="property">nackCount</span>, <span class="comment">// 发送 NACK (否定确认) 的次数，表示丢包</span></span></span><br><span class="line"><span class="language-javascript">                                            <span class="variable constant_">PLI</span>请求数: item.<span class="property">pliCount</span>   <span class="comment">// 发送 PLI (图像丢失指示) 的次数，表示需要关键帧</span></span></span><br><span class="line"><span class="language-javascript">                                        };</span></span><br><span class="line"><span class="language-javascript">                                    }</span></span><br><span class="line"><span class="language-javascript">                                    <span class="comment">// 成功建立连接的 ICE 候选对统计</span></span></span><br><span class="line"><span class="language-javascript">                                    <span class="keyword">else</span> <span class="keyword">if</span> (item.<span class="property">type</span> === <span class="string">'candidate-pair'</span> &amp;&amp; item.<span class="property">state</span> === <span class="string">'succeeded'</span>) {</span></span><br><span class="line"><span class="language-javascript">                                        interestingStats.<span class="property">candidatePair</span> = {</span></span><br><span class="line"><span class="language-javascript">                                            本地候选<span class="attr">ID</span>: item.<span class="property">localCandidateId</span>.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">10</span>) + <span class="string">'...'</span>,</span></span><br><span class="line"><span class="language-javascript">                                            远端候选<span class="attr">ID</span>: item.<span class="property">remoteCandidateId</span>.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">10</span>) + <span class="string">'...'</span>,</span></span><br><span class="line"><span class="language-javascript">                                            当前往返时延<span class="attr">RTT</span>: item.<span class="property">currentRoundTripTime</span>?.<span class="title function_">toFixed</span>(<span class="number">4</span>), <span class="comment">// RTT (关键延迟指标) 秒</span></span></span><br><span class="line"><span class="language-javascript">                                            可用出向比特率: item.<span class="property">availableOutgoingBitrate</span> ? (item.<span class="property">availableOutgoingBitrate</span> / <span class="number">1000</span>).<span class="title function_">toFixed</span>(<span class="number">1</span>) + <span class="string">' kbps'</span> : <span class="string">'N/A'</span> <span class="comment">// 估计的可用带宽</span></span></span><br><span class="line"><span class="language-javascript">                                        };</span></span><br><span class="line"><span class="language-javascript">                                    }</span></span><br><span class="line"><span class="language-javascript">                                    <span class="comment">// 成功配对的远端候选者信息</span></span></span><br><span class="line"><span class="language-javascript">                                    <span class="keyword">else</span> <span class="keyword">if</span> (item.<span class="property">type</span> === <span class="string">'remote-candidate'</span> &amp;&amp; interestingStats.<span class="property">candidatePair</span> &amp;&amp; item.<span class="property">id</span> === interestingStats.<span class="property">candidatePair</span>.远端候选<span class="variable constant_">ID</span>) {</span></span><br><span class="line"><span class="language-javascript">                                        interestingStats.<span class="property">remoteCandidate</span> = {</span></span><br><span class="line"><span class="language-javascript">                                            地址和端口: <span class="string">`<span class="subst">${item.address}</span>:<span class="subst">${item.port}</span>`</span>,</span></span><br><span class="line"><span class="language-javascript">                                            协议: item.<span class="property">protocol</span>,</span></span><br><span class="line"><span class="language-javascript">                                            类型: item.<span class="property">candidateType</span> <span class="comment">// host, srflx (服务器反射), relay (中继), prflx (对等反射)</span></span></span><br><span class="line"><span class="language-javascript">                                        };</span></span><br><span class="line"><span class="language-javascript">                                    }</span></span><br><span class="line"><span class="language-javascript">                                });</span></span><br><span class="line"><span class="language-javascript">                                stats.<span class="property">value</span> = interestingStats; <span class="comment">// 更新响应式 ref 以显示在界面上</span></span></span><br><span class="line"><span class="language-javascript">                            } <span class="keyword">catch</span> (err) {</span></span><br><span class="line"><span class="language-javascript">                                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"获取 WebRTC 统计信息失败:"</span>, err);</span></span><br><span class="line"><span class="language-javascript">                                <span class="keyword">if</span> (statsIntervalId) <span class="built_in">clearInterval</span>(statsIntervalId); <span class="comment">// 获取失败时停止</span></span></span><br><span class="line"><span class="language-javascript">                                statsIntervalId = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                        } <span class="keyword">else</span> {</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 如果连接断开或 PeerConnection 不存在，停止获取统计</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="keyword">if</span> (statsIntervalId) {</span></span><br><span class="line"><span class="language-javascript">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"连接非 'connected' 状态，停止获取统计信息。"</span>);</span></span><br><span class="line"><span class="language-javascript">                                <span class="built_in">clearInterval</span>(statsIntervalId);</span></span><br><span class="line"><span class="language-javascript">                                statsIntervalId = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                                stats.<span class="property">value</span> = <span class="literal">null</span>; <span class="comment">// 清空显示</span></span></span><br><span class="line"><span class="language-javascript">                            }</span></span><br><span class="line"><span class="language-javascript">                        }</span></span><br><span class="line"><span class="language-javascript">                    }, <span class="number">2000</span>); <span class="comment">// 每 2 秒获取一次统计信息</span></span></span><br><span class="line"><span class="language-javascript">                };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// --- 生命周期钩子 ---</span></span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 组件挂载后调用</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"组件已挂载。"</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 可以在这里自动连接，或者等待用户点击按钮</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// startStreaming(); // 如果想自动开始，取消此行注释</span></span></span><br><span class="line"><span class="language-javascript">                });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 组件卸载前调用</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"组件即将卸载，清理资源..."</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">stopStreaming</span>(); <span class="comment">// 确保清理所有资源</span></span></span><br><span class="line"><span class="language-javascript">                });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// --- 返回需要在模板中使用的数据和方法 ---</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> {</span></span><br><span class="line"><span class="language-javascript">                    status,</span></span><br><span class="line"><span class="language-javascript">                    isConnecting,</span></span><br><span class="line"><span class="language-javascript">                    isConnected,</span></span><br><span class="line"><span class="language-javascript">                    errorMessage,</span></span><br><span class="line"><span class="language-javascript">                    videoElement, <span class="comment">// 将 ref 暴露给模板，以便 &lt;video ref="videoElement"&gt; 可以关联</span></span></span><br><span class="line"><span class="language-javascript">                    statusClass,</span></span><br><span class="line"><span class="language-javascript">                    stats, <span class="comment">// 暴露统计信息 ref</span></span></span><br><span class="line"><span class="language-javascript">                    startStreaming,</span></span><br><span class="line"><span class="language-javascript">                    stopStreaming</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 注意：connectWebSocket 和 handleSignalingMessage 是内部逻辑，通常不需要暴露给模板</span></span></span><br><span class="line"><span class="language-javascript">                };</span></span><br><span class="line"><span class="language-javascript">            }</span></span><br><span class="line"><span class="language-javascript">        });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        app.<span class="title function_">mount</span>(<span class="string">'#app'</span>); <span class="comment">// 将 Vue 应用挂载到 DOM 元素 #app 上</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h6 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server.py (优化后的完整后端代码)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> weakref <span class="comment"># 用于干净地管理 WebSocket</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</span><br><span class="line"><span class="comment"># 引入 RTCConfiguration 和 RTCIceServer</span></span><br><span class="line"><span class="keyword">from</span> aiortc <span class="keyword">import</span> RTCIceCandidate, RTCPeerConnection, RTCSessionDescription, VideoStreamTrack, RTCConfiguration, RTCIceServer</span><br><span class="line"><span class="keyword">from</span> aiortc.contrib.media <span class="keyword">import</span> MediaRelay</span><br><span class="line"><span class="keyword">from</span> av <span class="keyword">import</span> VideoFrame</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 日志设置 ---</span></span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line">logger = logging.getLogger(<span class="string">"server"</span>)</span><br><span class="line">logger.setLevel(logging.INFO)</span><br><span class="line">pc_logger = logging.getLogger(<span class="string">"pc"</span>)</span><br><span class="line">pc_logger.setLevel(logging.INFO)</span><br><span class="line">cam_logger = logging.getLogger(<span class="string">"camera"</span>)</span><br><span class="line">cam_logger.setLevel(logging.INFO) <span class="comment"># 单独的摄像头日志记录器</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ROOT = os.path.dirname(__file__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 全局变量 ---</span></span><br><span class="line">pcs = <span class="built_in">set</span>() <span class="comment"># 用于存储活动 PeerConnection 的集合</span></span><br><span class="line"><span class="comment"># 存储 WebSocket，以便在需要时将其与 PeerConnection 关联，或仅用于管理</span></span><br><span class="line"><span class="comment"># 使用 weakref 避免套接字意外关闭时产生悬空引用</span></span><br><span class="line">web_sockets = weakref.WeakSet()</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 摄像头处理 (优化) ---</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CameraDevice</span>:</span><br><span class="line">    _instance = <span class="literal">None</span></span><br><span class="line">    _lock = threading.Lock() <span class="comment"># 类锁，用于控制单例实例化</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="comment"># 单例模式：确保只有一个 CameraDevice 实例</span></span><br><span class="line">        <span class="keyword">with</span> cls._lock:</span><br><span class="line">            <span class="keyword">if</span> cls._instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                cls._instance = <span class="built_in">super</span>(CameraDevice, cls).__new__(cls)</span><br><span class="line">                cls._instance._initialized = <span class="literal">False</span> <span class="comment"># 标记为未初始化</span></span><br><span class="line">            <span class="keyword">return</span> cls._instance</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, camera_index=<span class="number">0</span></span>):</span><br><span class="line">         <span class="comment"># 确保初始化只执行一次</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">'_initialized'</span>) <span class="keyword">and</span> <span class="variable language_">self</span>._initialized:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>._lock:</span><br><span class="line">             <span class="comment"># 获取锁后再次检查，防止并发初始化</span></span><br><span class="line">             <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">'_initialized'</span>) <span class="keyword">and</span> <span class="variable language_">self</span>._initialized:</span><br><span class="line">                  <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">             <span class="comment"># --- !!! Windows 优化点：尝试指定后端 !!! ---</span></span><br><span class="line">             <span class="comment"># 选择其中一个或者都不用来使用默认值进行测试</span></span><br><span class="line">             backend_preference = cv2.CAP_MSMF      <span class="comment"># 尝试 Media Foundation (较新)</span></span><br><span class="line">             <span class="comment"># backend_preference = cv2.CAP_DSHOW     # 尝试 DirectShow (较旧，有时兼容性/性能更好)</span></span><br><span class="line">             <span class="comment"># backend_preference = None             # 使用 OpenCV 默认后端</span></span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> backend_preference <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                  <span class="variable language_">self</span>.cap = cv2.VideoCapture(camera_index, backend_preference)</span><br><span class="line">                  cam_logger.info(<span class="string">f"尝试使用 OpenCV 后端: <span class="subst">{backend_preference}</span>"</span>)</span><br><span class="line">             <span class="keyword">else</span>:</span><br><span class="line">                  <span class="variable language_">self</span>.cap = cv2.VideoCapture(camera_index)</span><br><span class="line">                  cam_logger.info(<span class="string">"使用 OpenCV 默认后端"</span>)</span><br><span class="line">             <span class="comment"># --- !!! 结束优化点 !!! ---</span></span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.cap.isOpened():</span><br><span class="line">                 <span class="keyword">raise</span> RuntimeError(<span class="string">f"无法打开视频源 <span class="subst">{camera_index}</span>"</span>)</span><br><span class="line"></span><br><span class="line">             <span class="comment"># 尝试设置较低的分辨率和目标 FPS (可以根据需要调整)</span></span><br><span class="line">             target_width = <span class="number">640</span></span><br><span class="line">             target_height = <span class="number">480</span></span><br><span class="line">             target_fps = <span class="number">30</span></span><br><span class="line"></span><br><span class="line">             <span class="variable language_">self</span>.cap.<span class="built_in">set</span>(cv2.CAP_PROP_FRAME_WIDTH, target_width)</span><br><span class="line">             <span class="variable language_">self</span>.cap.<span class="built_in">set</span>(cv2.CAP_PROP_FRAME_HEIGHT, target_height)</span><br><span class="line">             <span class="variable language_">self</span>.cap.<span class="built_in">set</span>(cv2.CAP_PROP_FPS, target_fps)</span><br><span class="line">             <span class="comment"># 尝试禁用缓存 (效果取决于摄像头和驱动)</span></span><br><span class="line">             <span class="variable language_">self</span>.cap.<span class="built_in">set</span>(cv2.CAP_PROP_BUFFERSIZE, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">             w = <span class="built_in">int</span>(<span class="variable language_">self</span>.cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">             h = <span class="built_in">int</span>(<span class="variable language_">self</span>.cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line">             <span class="comment"># 读取实际应用的 FPS</span></span><br><span class="line">             actual_fps = <span class="variable language_">self</span>.cap.get(cv2.CAP_PROP_FPS)</span><br><span class="line">             buffer_size = <span class="built_in">int</span>(<span class="variable language_">self</span>.cap.get(cv2.CAP_PROP_BUFFERSIZE))</span><br><span class="line">             cam_logger.info(<span class="string">f"摄像头 <span class="subst">{camera_index}</span> 配置请求: <span class="subst">{target_width}</span>x<span class="subst">{target_height}</span>@<span class="subst">{target_fps}</span>fps, Buffer: 1"</span>)</span><br><span class="line">             cam_logger.info(<span class="string">f"摄像头 <span class="subst">{camera_index}</span> 实际配置: (<span class="subst">{w}</span>x<span class="subst">{h}</span>@<span class="subst">{actual_fps}</span>fps, Buffer: <span class="subst">{buffer_size}</span>)"</span>)</span><br><span class="line">             <span class="variable language_">self</span>.target_fps = actual_fps <span class="keyword">if</span> actual_fps &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">30</span> <span class="comment"># 使用实际读取的FPS或默认值</span></span><br><span class="line"></span><br><span class="line">             <span class="variable language_">self</span>._frame_lock = threading.Lock() <span class="comment"># 帧锁，用于保护 _frame 的访问</span></span><br><span class="line">             <span class="variable language_">self</span>._frame = <span class="literal">None</span> <span class="comment"># 存储最新帧</span></span><br><span class="line">             <span class="comment"># 使用 daemon=True 确保主程序退出时线程也退出</span></span><br><span class="line">             <span class="variable language_">self</span>._thread = threading.Thread(target=<span class="variable language_">self</span>._capture_loop, daemon=<span class="literal">True</span>)</span><br><span class="line">             <span class="variable language_">self</span>._running = <span class="literal">True</span> <span class="comment"># 控制捕获循环的标志</span></span><br><span class="line">             <span class="variable language_">self</span>._thread.start() <span class="comment"># 启动捕获线程</span></span><br><span class="line">             <span class="variable language_">self</span>._initialized = <span class="literal">True</span> <span class="comment"># 标记为已初始化</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_capture_loop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 摄像头帧捕获循环（在单独线程中运行）</span></span><br><span class="line">        cam_logger.info(<span class="string">"摄像头捕获线程已启动"</span>)</span><br><span class="line">        last_log_time = time.monotonic() <span class="comment"># 使用 monotonic 时钟更适合测量间隔</span></span><br><span class="line">        frames_captured_interval = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="variable language_">self</span>._running:</span><br><span class="line">            ret, frame = <span class="variable language_">self</span>.cap.read() <span class="comment"># 读取一帧</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">                <span class="comment"># cam_logger.warning("无法从摄像头抓取帧") # 频繁打印可能影响性能</span></span><br><span class="line">                time.sleep(<span class="number">0.005</span>) <span class="comment"># 短暂等待再重试</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> <span class="variable language_">self</span>._frame_lock: <span class="comment"># 获取帧锁</span></span><br><span class="line">                <span class="variable language_">self</span>._frame = frame <span class="comment"># 更新最新帧</span></span><br><span class="line"></span><br><span class="line">            frames_captured_interval += <span class="number">1</span></span><br><span class="line">            <span class="comment"># 每 5 秒记录一次实际捕获帧率</span></span><br><span class="line">            current_time = time.monotonic()</span><br><span class="line">            duration = current_time - last_log_time</span><br><span class="line">            <span class="keyword">if</span> duration &gt;= <span class="number">5.0</span>:</span><br><span class="line">                actual_capture_fps = frames_captured_interval / duration</span><br><span class="line">                cam_logger.info(<span class="string">f"摄像头实际捕获帧率: <span class="subst">{actual_capture_fps:<span class="number">.2</span>f}</span> FPS"</span>)</span><br><span class="line">                frames_captured_interval = <span class="number">0</span></span><br><span class="line">                last_log_time = current_time</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 减少休眠时间，让线程尽可能快地再次读取</span></span><br><span class="line">            <span class="comment"># 如果 cap.read() 是阻塞的，这个 sleep 可能不是主要瓶颈</span></span><br><span class="line">            time.sleep(<span class="number">0.001</span>) <span class="comment"># 1ms 休眠，给其他线程机会</span></span><br><span class="line"></span><br><span class="line">        cam_logger.info(<span class="string">"摄像头捕获线程已停止"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.cap.isOpened():</span><br><span class="line">             <span class="variable language_">self</span>.cap.release() <span class="comment"># 释放摄像头资源</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_latest_frame</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 获取最新的摄像头帧</span></span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>._frame_lock: <span class="comment"># 获取帧锁</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>._frame <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                 <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._frame.copy() <span class="comment"># 返回帧的副本，避免多线程问题</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 停止摄像头设备（单例模式下）</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(CameraDevice, <span class="string">'_instance'</span>) <span class="keyword">and</span> CameraDevice._instance <span class="keyword">and</span> CameraDevice._instance._initialized:</span><br><span class="line">            cam_logger.info(<span class="string">"正在停止摄像头设备..."</span>)</span><br><span class="line">            CameraDevice._instance._running = <span class="literal">False</span> <span class="comment"># 设置停止标志</span></span><br><span class="line">            <span class="keyword">if</span> CameraDevice._instance._thread:</span><br><span class="line">                CameraDevice._instance._thread.join(timeout=<span class="number">1</span>) <span class="comment"># 缩短等待时间</span></span><br><span class="line">            <span class="keyword">if</span> CameraDevice._instance.cap <span class="keyword">and</span> CameraDevice._instance.cap.isOpened():</span><br><span class="line">                CameraDevice._instance.cap.release() <span class="comment"># 确保摄像头被释放</span></span><br><span class="line">            cam_logger.info(<span class="string">"摄像头设备已停止。"</span>)</span><br><span class="line">            CameraDevice._instance = <span class="literal">None</span> <span class="comment"># 重置单例，允许下次重新创建</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局初始化摄像头（单例模式）</span></span><br><span class="line">camera_device = <span class="literal">None</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    camera_device = CameraDevice() <span class="comment"># 尝试创建/获取摄像头实例</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">     logger.error(<span class="string">f"严重: 启动时初始化摄像头失败: <span class="subst">{e}</span>。服务器可能无法传输视频。"</span>)</span><br><span class="line">     camera_device = <span class="literal">None</span> <span class="comment"># 如果失败，确保其值为 None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- WebRTC 视频轨道 (优化) ---</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CameraVideoStreamTrack</span>(<span class="title class_ inherited__">VideoStreamTrack</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    一个从全局 CameraDevice 读取帧的视频流轨道。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, camera: CameraDevice</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.camera = camera</span><br><span class="line">        <span class="variable language_">self</span>._last_valid_frame = <span class="literal">None</span> <span class="comment"># 缓存最后一帧有效帧</span></span><br><span class="line">        <span class="comment"># 帧率监控</span></span><br><span class="line">        <span class="variable language_">self</span>._frame_count_sent = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>._log_interval = <span class="number">5.0</span> <span class="comment"># 每 5 秒记录一次发送帧率</span></span><br><span class="line">        <span class="variable language_">self</span>._last_log_time_sent = time.monotonic()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">recv</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># aiortc 调用此方法获取下一帧</span></span><br><span class="line">        start_wait = time.monotonic()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.camera <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 处理摄像头初始化失败的情况</span></span><br><span class="line">            <span class="comment"># logger.warning("recv: 摄像头未初始化，发送黑屏。")</span></span><br><span class="line">            frame = VideoFrame(width=<span class="number">640</span>, height=<span class="number">480</span>, <span class="built_in">format</span>=<span class="string">"bgr24"</span>) <span class="comment"># 创建黑屏帧</span></span><br><span class="line">            pts = <span class="built_in">int</span>(time.time() * <span class="number">90000</span>) <span class="comment"># 使用当前时间估算 pts (90kHz 时基)</span></span><br><span class="line">            frame.pts = pts</span><br><span class="line">            frame.time_base = <span class="number">90000</span></span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>/<span class="number">30</span>) <span class="comment"># 保持一个默认间隔</span></span><br><span class="line">            <span class="keyword">return</span> frame</span><br><span class="line"></span><br><span class="line">        frame_data = <span class="variable language_">self</span>.camera.get_latest_frame() <span class="comment"># 获取最新帧</span></span><br><span class="line">        now = time.monotonic()</span><br><span class="line">        wait_time = now - start_wait <span class="comment"># 计算获取帧实际花费的时间</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> frame_data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 如果当前无法获取帧 (例如，摄像头刚启动或暂时出问题)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>._last_valid_frame <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                frame = <span class="variable language_">self</span>._last_valid_frame</span><br><span class="line">                <span class="comment"># 需要更新重用帧的 pts 和 time_base</span></span><br><span class="line">                pts, time_base = <span class="keyword">await</span> <span class="variable language_">self</span>.next_timestamp()</span><br><span class="line">                frame.pts = pts</span><br><span class="line">                frame.time_base = time_base</span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="built_in">max</span>(<span class="number">0</span>, (<span class="number">1</span>/<span class="number">30</span>) - wait_time)) <span class="comment"># 即使重用也大致按目标帧率等待</span></span><br><span class="line">                <span class="keyword">return</span> frame</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 如果从未收到任何帧，则发送黑屏帧</span></span><br><span class="line">                <span class="comment"># pc_logger.warning("recv: 无可用帧且无历史帧，发送黑屏。")</span></span><br><span class="line">                frame = VideoFrame(width=<span class="number">640</span>, height=<span class="number">480</span>, <span class="built_in">format</span>=<span class="string">"bgr24"</span>) <span class="comment"># 黑屏帧</span></span><br><span class="line">                pts, time_base = <span class="keyword">await</span> <span class="variable language_">self</span>.next_timestamp()</span><br><span class="line">                frame.pts = pts</span><br><span class="line">                frame.time_base = time_base</span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>/<span class="number">30</span>)</span><br><span class="line">                <span class="keyword">return</span> frame</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">             <span class="comment"># --- !!! 优化点：减少或移除发送端的等待 !!! ---</span></span><br><span class="line">             <span class="comment"># 尽快处理新帧并发送，将平滑交给接收端缓冲区</span></span><br><span class="line">             frame = VideoFrame.from_ndarray(frame_data, <span class="built_in">format</span>=<span class="string">"bgr24"</span>)</span><br><span class="line">             pts, time_base = <span class="keyword">await</span> <span class="variable language_">self</span>.next_timestamp()</span><br><span class="line">             frame.pts = pts</span><br><span class="line">             frame.time_base = time_base</span><br><span class="line">             <span class="variable language_">self</span>._last_valid_frame = frame <span class="comment"># 缓存有效帧</span></span><br><span class="line"></span><br><span class="line">             <span class="comment"># (帧率监控逻辑不变)</span></span><br><span class="line">             <span class="variable language_">self</span>._frame_count_sent += <span class="number">1</span></span><br><span class="line">             current_time = time.monotonic()</span><br><span class="line">             duration = current_time - <span class="variable language_">self</span>._last_log_time_sent</span><br><span class="line">             <span class="keyword">if</span> duration &gt;= <span class="variable language_">self</span>._log_interval:</span><br><span class="line">                 actual_send_fps = <span class="variable language_">self</span>._frame_count_sent / duration</span><br><span class="line">                 pc_logger.info(<span class="string">f"WebRTC 发送帧率: <span class="subst">{actual_send_fps:<span class="number">.2</span>f}</span> FPS"</span>)</span><br><span class="line">                 <span class="variable language_">self</span>._frame_count_sent = <span class="number">0</span></span><br><span class="line">                 <span class="variable language_">self</span>._last_log_time_sent = current_time</span><br><span class="line"></span><br><span class="line">             <span class="comment"># 注释掉或使用极小的 sleep 以降低延迟</span></span><br><span class="line">             <span class="comment"># await asyncio.sleep(max(0, self._target_timestamp_delta - wait_time))</span></span><br><span class="line">             <span class="comment"># await asyncio.sleep(0.001) # 可选：给予事件循环一点喘息时间</span></span><br><span class="line">             <span class="keyword">pass</span> <span class="comment"># 直接返回，追求最低延迟</span></span><br><span class="line">             <span class="comment"># --- !!! 结束优化点 !!! ---</span></span><br><span class="line"></span><br><span class="line">             <span class="keyword">return</span> frame</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Web 服务器与信令处理 (优化) ---</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">serve_html</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="comment"># 处理根路径请求，返回 index.html</span></span><br><span class="line">    content = <span class="built_in">open</span>(os.path.join(ROOT, <span class="string">"index.html"</span>), <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>).read()</span><br><span class="line">    <span class="keyword">return</span> web.Response(content_type=<span class="string">"text/html"</span>, text=content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_websocket</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="comment"># 处理 WebSocket 连接请求</span></span><br><span class="line">    ws = web.WebSocketResponse()</span><br><span class="line">    <span class="keyword">await</span> ws.prepare(request) <span class="comment"># 准备 WebSocket 响应</span></span><br><span class="line">    logger.info(<span class="string">"WebSocket 连接已建立"</span>)</span><br><span class="line">    web_sockets.add(ws) <span class="comment"># 添加到活动 WebSocket 集合中</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- WebRTC 配置，加入 STUN 服务器 ---</span></span><br><span class="line">    rtc_configuration = RTCConfiguration(</span><br><span class="line">        iceServers=[</span><br><span class="line">            <span class="comment"># 使用 Google 的公共 STUN 服务器</span></span><br><span class="line">            RTCIceServer(urls=<span class="string">"stun:stun.l.google.com:19302"</span>),</span><br><span class="line">            RTCIceServer(urls=<span class="string">"stun:stun1.l.google.com:19302"</span>),</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建 PeerConnection 时传入配置</span></span><br><span class="line">    pc = RTCPeerConnection(configuration=rtc_configuration)</span><br><span class="line">    pc_id = <span class="string">f"PeerConnection(<span class="subst">{<span class="built_in">hex</span>(<span class="built_in">id</span>(pc))[-<span class="number">6</span>:]}</span>)"</span> <span class="comment"># 创建一个易于识别的 ID</span></span><br><span class="line">    pcs.add(pc) <span class="comment"># 添加到活动 PeerConnection 集合中</span></span><br><span class="line">    logger.info(<span class="string">f"<span class="subst">{pc_id}</span>: 已为 WebSocket <span class="subst">{<span class="built_in">hex</span>(<span class="built_in">id</span>(ws))[-<span class="number">6</span>:]}</span> 创建 (带 STUN 配置)"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将 WebSocket 和 PeerConnection 关联起来（简单方式）</span></span><br><span class="line">    ws.pc = pc</span><br><span class="line"></span><br><span class="line"><span class="meta">    @pc.on(<span class="params"><span class="string">"icecandidate"</span></span>)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">on_icecandidate</span>(<span class="params">candidate</span>):</span><br><span class="line">        <span class="comment"># 当 RTCPeerConnection 生成 ICE 候选者时调用</span></span><br><span class="line">        <span class="keyword">if</span> candidate:</span><br><span class="line">            <span class="comment"># 如果有候选者，将其发送给对端（浏览器）</span></span><br><span class="line">            <span class="comment"># pc_logger.debug(f"{pc_id}: 发送 ICE 候选者: {candidate.sdpMid}|{candidate.sdpMLineIndex}")</span></span><br><span class="line">            <span class="keyword">await</span> ws.send_json({<span class="string">"type"</span>: <span class="string">"ice"</span>, <span class="string">"candidate"</span>: candidate.to_dict()})</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">             <span class="comment"># candidate 为 None 表示 ICE 收集完成</span></span><br><span class="line">             logger.info(<span class="string">f"<span class="subst">{pc_id}</span>: ICE 收集完成。"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">    @pc.on(<span class="params"><span class="string">"connectionstatechange"</span></span>)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">on_connectionstatechange</span>():</span><br><span class="line">        <span class="comment"># 当 PeerConnection 连接状态改变时调用</span></span><br><span class="line">        logger.info(<span class="string">f"<span class="subst">{pc_id}</span>: 连接状态为 <span class="subst">{pc.connectionState}</span>"</span>)</span><br><span class="line">        <span class="keyword">if</span> pc.connectionState <span class="keyword">in</span> [<span class="string">"failed"</span>, <span class="string">"closed"</span>, <span class="string">"disconnected"</span>]:</span><br><span class="line">            <span class="comment"># 如果连接失败、关闭或断开</span></span><br><span class="line">            <span class="keyword">if</span> pc <span class="keyword">in</span> pcs: <span class="comment"># 检查是否还在集合中，避免重复关闭</span></span><br><span class="line">                 logger.info(<span class="string">f"<span class="subst">{pc_id}</span>: 正在关闭..."</span>)</span><br><span class="line">                 <span class="keyword">await</span> pc.close() <span class="comment"># 关闭 PeerConnection</span></span><br><span class="line">                 pcs.discard(pc) <span class="comment"># 从集合中移除</span></span><br><span class="line">                 logger.info(<span class="string">f"<span class="subst">{pc_id}</span>: 已关闭并移除。"</span>)</span><br><span class="line">            <span class="comment"># 同时关闭关联的 WebSocket（如果它还开着）</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ws.closed:</span><br><span class="line">                 logger.info(<span class="string">f"关闭关联的 WebSocket <span class="subst">{<span class="built_in">hex</span>(<span class="built_in">id</span>(ws))[-<span class="number">6</span>:]}</span>"</span>)</span><br><span class="line">                 <span class="keyword">await</span> ws.close(code=<span class="number">1000</span>, message=<span class="string">"PeerConnection closed"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果摄像头设备可用，则添加视频轨道</span></span><br><span class="line">    <span class="keyword">if</span> camera_device:</span><br><span class="line">        video_track = CameraVideoStreamTrack(camera_device)</span><br><span class="line">        pc.addTrack(video_track) <span class="comment"># 添加视频轨道到 PeerConnection</span></span><br><span class="line">        logger.info(<span class="string">f"<span class="subst">{pc_id}</span>: 已添加摄像头视频轨道。"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">         logger.warning(<span class="string">f"<span class="subst">{pc_id}</span>: 无可用摄像头设备，无法添加视频轨道。"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 循环监听来自 WebSocket 的消息</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">for</span> msg <span class="keyword">in</span> ws:</span><br><span class="line">            <span class="keyword">if</span> msg.<span class="built_in">type</span> == web.WSMsgType.TEXT:</span><br><span class="line">                <span class="comment"># 处理文本消息</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    data = json.loads(msg.data) <span class="comment"># 解析 JSON</span></span><br><span class="line">                    pc_logger.debug(<span class="string">f"<span class="subst">{pc_id}</span>: 收到消息类型: <span class="subst">{data.get(<span class="string">'type'</span>)}</span>"</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> data[<span class="string">"type"</span>] == <span class="string">"offer"</span>:</span><br><span class="line">                        <span class="comment"># 收到来自浏览器的 Offer</span></span><br><span class="line">                        offer = RTCSessionDescription(sdp=data[<span class="string">"sdp"</span>], <span class="built_in">type</span>=data[<span class="string">"type"</span>])</span><br><span class="line">                        <span class="keyword">await</span> pc.setRemoteDescription(offer) <span class="comment"># 设置远端描述 (Offer)</span></span><br><span class="line">                        pc_logger.info(<span class="string">f"<span class="subst">{pc_id}</span>: 远端描述 (offer) 已设置。"</span>)</span><br><span class="line"></span><br><span class="line">                        <span class="comment"># 创建 Answer</span></span><br><span class="line">                        answer = <span class="keyword">await</span> pc.createAnswer()</span><br><span class="line">                        <span class="keyword">await</span> pc.setLocalDescription(answer) <span class="comment"># 设置本地描述 (Answer)</span></span><br><span class="line">                        pc_logger.info(<span class="string">f"<span class="subst">{pc_id}</span>: 本地描述 (answer) 已设置。"</span>)</span><br><span class="line"></span><br><span class="line">                        <span class="comment"># 将 Answer 发送回浏览器</span></span><br><span class="line">                        <span class="keyword">await</span> ws.send_json({</span><br><span class="line">                            <span class="string">"type"</span>: <span class="string">"answer"</span>,</span><br><span class="line">                            <span class="string">"sdp"</span>: pc.localDescription.sdp,</span><br><span class="line">                            <span class="string">"type"</span>: pc.localDescription.<span class="built_in">type</span>,</span><br><span class="line">                        })</span><br><span class="line">                        pc_logger.info(<span class="string">f"<span class="subst">{pc_id}</span>: 已发送 answer 到 WebSocket <span class="subst">{<span class="built_in">hex</span>(<span class="built_in">id</span>(ws))[-<span class="number">6</span>:]}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">elif</span> data[<span class="string">"type"</span>] == <span class="string">"ice"</span>:</span><br><span class="line">                        <span class="comment"># 收到来自浏览器的 ICE 候选者</span></span><br><span class="line">                        candidate_info = data.get(<span class="string">"candidate"</span>) <span class="comment"># 使用 .get() 更安全</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment"># 有时浏览器会发送 null candidates (表示结束) - 优雅地处理</span></span><br><span class="line">                        <span class="keyword">if</span> candidate_info:</span><br><span class="line">                            <span class="keyword">try</span>:</span><br><span class="line">                                <span class="comment"># 显式提取所需参数，忽略其他参数 (如 usernameFragment)</span></span><br><span class="line">                                candidate = RTCIceCandidate(</span><br><span class="line">                                    sdpMid=candidate_info.get(<span class="string">"sdpMid"</span>),</span><br><span class="line">                                    sdpMLineIndex=candidate_info.get(<span class="string">"sdpMLineIndex"</span>),</span><br><span class="line">                                    candidate=candidate_info.get(<span class="string">"candidate"</span>) <span class="comment"># 确保传递的是 candidate 字符串</span></span><br><span class="line">                                )</span><br><span class="line">                                <span class="comment"># 添加一些检查确保提取的值有效</span></span><br><span class="line">                                <span class="keyword">if</span> candidate.candidate <span class="keyword">and</span> candidate.sdpMid <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> candidate.sdpMLineIndex <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                                    <span class="keyword">await</span> pc.addIceCandidate(candidate) <span class="comment"># 添加 ICE 候选者</span></span><br><span class="line">                                    <span class="comment"># pc_logger.debug(f"{pc_id}: 已添加来自客户端的 ICE 候选者 (mid={candidate.sdpMid}, line={candidate.sdpMLineIndex})。")</span></span><br><span class="line">                                <span class="keyword">else</span>:</span><br><span class="line">                                     pc_logger.warning(<span class="string">f"<span class="subst">{pc_id}</span>: 收到无效或不完整的 ICE candidate 字典: <span class="subst">{candidate_info}</span>"</span>)</span><br><span class="line">                            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                                <span class="comment"># 捕获创建或添加候选者时可能出现的任何错误</span></span><br><span class="line">                                pc_logger.error(<span class="string">f"<span class="subst">{pc_id}</span>: 处理 ICE candidate 时出错: <span class="subst">{e}</span> - Candidate Info: <span class="subst">{candidate_info}</span>"</span>)</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            <span class="comment"># 收到 null candidate 表示客户端 ICE 收集完成</span></span><br><span class="line">                            pc_logger.info(<span class="string">f"<span class="subst">{pc_id}</span>: 收到来自客户端的 null ICE 候选者（表示收集结束）。"</span>)</span><br><span class="line">                            <span class="comment"># aiortc 不需要显式调用 addIceCandidate(None)</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        logger.warning(<span class="string">f"收到未知消息类型: <span class="subst">{data[<span class="string">'type'</span>]}</span>"</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">                    logger.error(<span class="string">f"WebSocket <span class="subst">{<span class="built_in">hex</span>(<span class="built_in">id</span>(ws))[-<span class="number">6</span>:]}</span>: 收到无效 JSON: <span class="subst">{msg.data}</span>"</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logger.error(<span class="string">f"处理 <span class="subst">{pc_id}</span> 的消息时出错: <span class="subst">{e}</span>"</span>, exc_info=<span class="literal">True</span>) <span class="comment"># 添加 exc_info=True 获取更详细的回溯信息</span></span><br><span class="line">                    <span class="comment"># 为安全起见，在出错时关闭连接</span></span><br><span class="line">                    <span class="keyword">if</span> pc <span class="keyword">in</span> pcs:</span><br><span class="line">                        <span class="keyword">await</span> pc.close()</span><br><span class="line">                        pcs.discard(pc)</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> ws.closed:</span><br><span class="line">                         <span class="keyword">await</span> ws.close(code=<span class="number">1011</span>, message=<span class="string">f"处理消息出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> msg.<span class="built_in">type</span> == web.WSMsgType.ERROR:</span><br><span class="line">                <span class="comment"># 处理 WebSocket 错误</span></span><br><span class="line">                logger.error(<span class="string">f'WebSocket 连接因异常关闭 <span class="subst">{ws.exception()}</span>'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">         <span class="comment"># 处理任务被取消的情况（例如服务器关闭时）</span></span><br><span class="line">         logger.info(<span class="string">f"WebSocket <span class="subst">{<span class="built_in">hex</span>(<span class="built_in">id</span>(ws))[-<span class="number">6</span>:]}</span> 任务被取消。"</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># WebSocket 连接关闭后的清理工作</span></span><br><span class="line">        logger.info(<span class="string">f"WebSocket 连接 <span class="subst">{<span class="built_in">hex</span>(<span class="built_in">id</span>(ws))[-<span class="number">6</span>:]}</span> 已关闭"</span>)</span><br><span class="line">        web_sockets.discard(ws) <span class="comment"># 从活动集合中移除</span></span><br><span class="line">        <span class="comment"># 确保关联的 PeerConnection 被清理</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(ws, <span class="string">'pc'</span>) <span class="keyword">and</span> ws.pc <span class="keyword">in</span> pcs:</span><br><span class="line">            logger.info(<span class="string">f"正在关闭与已关闭 WebSocket 关联的 PeerConnection <span class="subst">{pc_id}</span>。"</span>)</span><br><span class="line">            <span class="keyword">await</span> ws.pc.close()</span><br><span class="line">            pcs.discard(ws.pc)</span><br><span class="line">    <span class="keyword">return</span> ws</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 清理与主程序 ---</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">on_shutdown</span>(<span class="params">app</span>):</span><br><span class="line">    <span class="comment"># 服务器关闭时的清理函数</span></span><br><span class="line">    logger.info(<span class="string">"服务器正在关闭..."</span>)</span><br><span class="line">    <span class="comment"># 关闭所有活动的 PeerConnection</span></span><br><span class="line">    coros_pc = [pc.close() <span class="keyword">for</span> pc <span class="keyword">in</span> pcs]</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*coros_pc, return_exceptions=<span class="literal">True</span>) <span class="comment"># 并发关闭，忽略单个错误</span></span><br><span class="line">    pcs.clear()</span><br><span class="line">    logger.info(<span class="string">"所有 PeerConnection 已关闭。"</span>)</span><br><span class="line">    <span class="comment"># 关闭所有活动的 WebSocket 连接</span></span><br><span class="line">    coros_ws = [ws.close(code=<span class="number">1001</span>, message=<span class="string">'服务器关闭'</span>) <span class="keyword">for</span> ws <span class="keyword">in</span> web_sockets]</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*coros_ws, return_exceptions=<span class="literal">True</span>)</span><br><span class="line">    logger.info(<span class="string">"所有 WebSocket 已关闭。"</span>)</span><br><span class="line">    <span class="comment"># 停止摄像头设备</span></span><br><span class="line">    <span class="keyword">if</span> camera_device: camera_device.stop()</span><br><span class="line">    logger.info(<span class="string">"关闭完成。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    app = web.Application()</span><br><span class="line">    app.on_shutdown.append(on_shutdown) <span class="comment"># 注册关闭处理函数</span></span><br><span class="line">    app.router.add_get(<span class="string">"/"</span>, serve_html) <span class="comment"># 添加根路径路由，服务 HTML</span></span><br><span class="line">    app.router.add_get(<span class="string">"/ws"</span>, handle_websocket) <span class="comment"># 添加 WebSocket 路由</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 在没有 SSL 的情况下运行（用于本地测试）---</span></span><br><span class="line">    runner = web.AppRunner(app)</span><br><span class="line">    <span class="keyword">await</span> runner.setup()</span><br><span class="line">    site = web.TCPSite(runner, <span class="string">"0.0.0.0"</span>, <span class="number">8080</span>) <span class="comment"># 监听所有接口的 8080 端口</span></span><br><span class="line">    <span class="comment"># -------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">"服务器已启动于 http://0.0.0.0:8080"</span>)</span><br><span class="line">    <span class="keyword">await</span> site.start() <span class="comment"># 启动服务器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 让服务器无限期运行，直到被中断</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.Event().wait()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        asyncio.run(main()) <span class="comment"># 运行主异步函数</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="comment"># 处理 Ctrl+C</span></span><br><span class="line">        logger.info(<span class="string">"收到 KeyboardInterrupt，正在关闭..."</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">         <span class="comment"># 确保即使主循环意外退出，摄像头也能被清理</span></span><br><span class="line">         <span class="keyword">if</span> camera_device:</span><br><span class="line">              camera_device.stop()</span><br></pre></td></tr></tbody></table></figure><h4 id="15-3-6-视频流协议-RTMP-RTSP-HLS"><a href="#15-3-6-视频流协议-RTMP-RTSP-HLS" class="headerlink" title="15.3.6 视频流协议(RTMP/RTSP/HLS)"></a>15.3.6 视频流协议(RTMP/RTSP/HLS)</h4><p>三个协议在直播推流中都占据重要的角色:</p><p><code>推流 (Ingest)</code>: 将直播源（摄像头、屏幕录制、本地文件）发送到流媒体服务器的过程。由于对低延迟的要求较高（主播需要尽快看到观众反馈或了解传输状态），RTMP 是这个阶段最常用的协议。RTSP 有时也用于 IP 摄像头的推流。WebRTC 推流也在兴起。<br><code>拉流/分发 (Delivery)</code>: 流媒体服务器将直播内容分发给大量观众的过程。考虑到兼容性、可伸缩性和网络适应性，HLS 和 DASH (另一种基于 HTTP 的自适应流协议) 是这个阶段的主流选择。虽然延迟较高，但可以通过 CDN 轻松分发给全球观众，并能在不同网络条件下自动调整清晰度，当然我们也会同样的学习其余两种协议</p><h5 id="主要视频流协议对比"><a href="#主要视频流协议对比" class="headerlink" title="主要视频流协议对比"></a>主要视频流协议对比</h5><table><thead><tr><th>特性</th><th>RTMP</th><th>RTSP</th><th>HLS</th><th>适用场景</th></tr></thead><tbody><tr><td>全称</td><td>实时消息传输协议</td><td>实时流协议</td><td>HTTP 直播流</td><td>-</td></tr><tr><td>开发者</td><td>Adobe</td><td>IETF</td><td>Apple</td><td>-</td></tr><tr><td>传输层协议</td><td>TCP</td><td>TCP/UDP</td><td>HTTP</td><td>-</td></tr><tr><td>延迟</td><td>低(1-3 秒)</td><td>最低(&lt; 1 秒)</td><td>高(5-30 秒)</td><td>RTMP 适合直播互动，HLS 适合点播</td></tr><tr><td>自适应比特率</td><td>有限</td><td>不支持</td><td>支持</td><td>HLS 适合不稳定网络</td></tr><tr><td>客户端兼容性</td><td>需要 Flash 或专用播放器</td><td>需要专用播放器</td><td>几乎所有浏览器</td><td>HLS 兼容性最好</td></tr><tr><td>穿透防火墙能力</td><td>一般</td><td>较差</td><td>最佳</td><td>HLS 适合严格网络环境</td></tr><tr><td>内容加密</td><td>可选</td><td>可选</td><td>内置支持</td><td>HLS 适合对安全性要求高的场景</td></tr></tbody></table><ul><li><p><strong><code>RTMP</code>:</strong> 由于其 <strong>较低的延迟</strong>，历史上广泛用于 <strong>直播推流</strong>，即把直播源（摄像头、桌面画面）发送到流媒体服务器。虽然 Flash 已被淘汰，但 RTMP 仍然是许多直播平台接收推流的主要协议之一。它不太适合大规模分发给观众。</p></li><li><p><strong><code>RTSP</code>:</strong> 主要设计用于 <strong>控制</strong> 媒体流的播放（类似 VCR 控制），并配合 RTP 传输数据。它的 <strong>延迟可以非常低</strong>，因此广泛应用于 <strong>IP 摄像头监控</strong>、视频会议系统、以及作为流媒体服务器的内容源。直接在 Web 浏览器中播放 RTSP 比较困难。</p></li><li><p><strong><code>HLS</code>:</strong> 由 Apple 开发，基于 <strong>HTTP</strong>。它将视频流切分成一系列小的 <code>.ts</code> (Transport Stream) 文件片段，并提供一个 <code>.m3u8</code> 索引文件。</p><ul><li><p><strong>优点:</strong> <strong>兼容性极好</strong>（几乎所有设备和浏览器都能通过 HTTP 播放），可以轻松利用 <strong>CDN</strong> 进行大规模分发，支持 <strong>自适应比特率</strong>（根据网速自动切换清晰度），容易 <strong>穿透防火墙</strong>。</p></li><li><p><strong>缺点:</strong> <strong>延迟较高</strong>（通常是多个切片时长之和），不适合需要实时互动的场景。近些年有低延迟 HLS (LL-HLS) 标准出现，可以将延迟降低到 2-5 秒。HLS 是目前 <strong>互联网视频点播和大规模直播分发</strong> 最主流的技术。</p></li></ul></li></ul><h5 id="认识必要的两个库"><a href="#认识必要的两个库" class="headerlink" title="认识必要的两个库"></a>认识必要的两个库</h5><p><code>python-ffmpeg-video-streaming.</code> 主要 <strong>简化 HLS 和 DASH 流的打包创建过程</strong>，提供了高级 API。也包含一些 RTMP 相关的功能封装。</p><p><strong><code>opencv-python</code>:</strong> 虽然是计算机视觉库，但它的 <code>cv2.VideoCapture()</code> 函数能够 <strong>非常方便地读取 RTSP 流</strong>（以及其他 FFmpeg 支持的视频源），逐帧进行处理。<strong>读取 RTSP 时非常常用！</strong></p><p>[环境准备]：</p><p>1.安装 FFmpeg 命令行工具 (如果尚未安装，参考第 17 章)</p><p>2.安装核心 Python 库</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install ffmpeg-python opencv-python python-ffmpeg-video-streaming</span><br></pre></td></tr></tbody></table></figure><h5 id="读取-RTSP-视频流-使用-opencv-python"><a href="#读取-RTSP-视频流-使用-opencv-python" class="headerlink" title="读取 RTSP 视频流 (使用 opencv-python)"></a>读取 RTSP 视频流 (使用 <code>opencv-python</code>)</h5><p><strong>场景与用途:</strong><br>RTSP 协议广泛应用于 IP 摄像头和安防监控系统。<code>opencv-python</code> (cv2) 库提供了一个非常简洁的接口 (<code>cv2.VideoCapture</code>) 来读取 RTSP 流（以及其他 FFmpeg 支持的视频源），它会自动处理底层的连接和解码，让你能够方便地逐帧获取视频画面（作为 NumPy 数组）进行分析、处理或显示。这对于需要对摄像头画面进行实时计算机视觉任务（如目标检测、人脸识别）的应用来说非常方便。</p><p><strong>面临的问题:</strong></p><p>在开发和测试需要处理实时视频流（尤其是 RTSP 协议）的应用时，我们经常面临一个挑战：手边没有现成的、稳定的 RTSP 源。IP 摄像头可能尚未部署或配置复杂，而去网上搜索公开的 RTSP 测试地址，会发现它们大多已经失效或极其不稳定，这给开发调试带来了很大不便。</p><p><strong>解决方案：使用 RTSP 模拟器</strong></p><p>为了解决这个问题，我们可以使用 <strong>RTSP 模拟器</strong>。这是一种软件工具，它可以在你的本地计算机上运行，将 <strong>本地视频文件</strong>、<strong>图片序列</strong>、甚至 <strong>其他网络流</strong>（如 HTTP、RTMP 或另一个 RTSP 流）作为输入源，然后通过标准的 RTSP 协议将这些内容 <strong>模拟成一个摄像头实时流</strong> 向外提供服务。</p><p>这样，就有了一个 <strong>稳定、可靠、随时可用</strong> 的 RTSP 源用于开发和测试，完全摆脱了对物理设备或不稳定公网地址的依赖。</p><h6 id="EasyRTSPServer-Simulator-工具使用"><a href="#EasyRTSPServer-Simulator-工具使用" class="headerlink" title="EasyRTSPServer Simulator 工具使用"></a>EasyRTSPServer Simulator 工具使用</h6><p><a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMUNvVndfUzk2X0s1UDFVNE1NcHZBamc_cHdkPWdoZWg">下载链接</a></p><ul><li>第一步：下载 RTSP_Simulator 解压，运行 EasyRTSPServer_Demo.exe【注意保证 554 端口没有被占用！】</li><li>第二步：放一个视频文件到 exe 同目录，例如：easy.mp4</li><li>第三步：用 VLC 等播放器请求 rtsp://127.0.0.1:554/easy.mp4</li></ul><p><strong>核心 API (<code>cv2.VideoCapture</code>):</strong></p><table><thead><tr><th align="left">方法/属性</th><th align="left">描述</th><th align="left">参数</th><th align="left">返回值/效果</th></tr></thead><tbody><tr><td align="left"><code>cv2.VideoCapture(source)</code></td><td align="left">创建一个视频捕获对象。</td><td align="left"><code>source</code>: 视频源 (RTSP URL, 文件路径, 摄像头索引)</td><td align="left">VideoCapture 对象</td></tr><tr><td align="left"><code>cap.isOpened()</code></td><td align="left">检查视频源是否成功打开。</td><td align="left">无</td><td align="left"><code>True</code> (成功) 或 <code>False</code> (失败)</td></tr><tr><td align="left"><code>cap.read()</code></td><td align="left">从视频源读取下一帧。</td><td align="left">无</td><td align="left"><code>(retval, frame)</code> 元组。&lt; br &gt; <code>retval</code>: bool, 是否成功读取。&lt; br &gt; <code>frame</code>: NumPy 数组 (BGR 格式), 或失败时 <code>None</code>。</td></tr><tr><td align="left"><code>cap.release()</code></td><td align="left">释放视频捕获对象，关闭视频源连接。</td><td align="left">无</td><td align="left">无</td></tr><tr><td align="left"><code>cap.get(propId)</code></td><td align="left">获取视频属性（如 <code>cv2.CAP_PROP_FRAME_WIDTH</code>, <code>cv2.CAP_PROP_FPS</code> 等）。</td><td align="left"><code>propId</code>: 属性 ID (整数常量)</td><td align="left">属性值 (浮点数)</td></tr><tr><td align="left"><code>cap.set(propId, value)</code></td><td align="left">设置视频属性（并非所有属性都可设置或所有摄像头都支持）。</td><td align="left"><code>propId</code>: 属性 ID &lt; br &gt; <code>value</code>: 要设置的值</td><td align="left"><code>True</code> (成功) 或 <code>False</code> (失败/不支持)</td></tr></tbody></table><p><strong>代码示例: 读取并显示 RTSP 流</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># read_rtsp_opencv.py</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 配置 ---</span></span><br><span class="line"><span class="comment"># !!! 将这里的 URL 替换为你的有效 RTSP 流地址 !!!</span></span><br><span class="line"><span class="comment"># 或者你的 IP 摄像头地址，格式类似: "rtsp://username:password@ip_address:port/stream_path"</span></span><br><span class="line">rtsp_url = <span class="string">"rtsp://127.0.0.1:554/easy.mp4"</span></span><br><span class="line"></span><br><span class="line">reconnect_delay = <span class="number">5</span> <span class="comment"># 连接失败或中断后的重连延迟（秒）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_rtsp_stream</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="string">"""循环读取并显示 RTSP 流"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"尝试连接到 RTSP 流: <span class="subst">{url}</span>"</span>)</span><br><span class="line">        <span class="comment"># 1. 创建 VideoCapture 对象</span></span><br><span class="line">        cap = cv2.VideoCapture(url)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. 检查连接是否成功打开</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cap.isOpened():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"错误：无法打开 RTSP 流。将在 <span class="subst">{reconnect_delay}</span> 秒后重试..."</span>)</span><br><span class="line">            cap.release() <span class="comment"># 确保释放资源</span></span><br><span class="line">            time.sleep(reconnect_delay)</span><br><span class="line">            <span class="keyword">continue</span> <span class="comment"># 继续下一次循环尝试连接</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"RTSP 流连接成功，开始读取帧..."</span>)</span><br><span class="line">        frame_count = <span class="number">0</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># 3. 循环读取帧</span></span><br><span class="line">            ret, frame = cap.read()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 检查是否成功读取到帧</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"错误：无法读取帧或视频流结束。准备重新连接..."</span>)</span><br><span class="line">                <span class="keyword">break</span> <span class="comment"># 跳出内层循环，触发重连</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- 在这里可以对 frame (NumPy 数组) 进行处理 ---</span></span><br><span class="line">            <span class="comment"># 例如：获取帧尺寸</span></span><br><span class="line">            <span class="comment"># height, width = frame.shape[:2]</span></span><br><span class="line">            <span class="comment"># 在帧上绘制时间戳</span></span><br><span class="line">            timestamp = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>)</span><br><span class="line">            cv2.putText(frame, timestamp, (<span class="number">10</span>, <span class="number">30</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">0.8</span>, (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">            <span class="comment"># ---------------------------------------------</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 4. 显示帧</span></span><br><span class="line">            cv2.imshow(<span class="string">"RTSP Stream Viewer (Press 'q' to quit)"</span>, frame)</span><br><span class="line"></span><br><span class="line">            frame_count += <span class="number">1</span></span><br><span class="line">            <span class="comment"># 计算并打印 FPS (可选)</span></span><br><span class="line">            <span class="comment"># if frame_count % 30 == 0:</span></span><br><span class="line">            <span class="comment">#     elapsed = time.time() - start_time</span></span><br><span class="line">            <span class="comment">#     fps = frame_count / elapsed</span></span><br><span class="line">            <span class="comment">#     print(f"FPS: {fps:.2f}")</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 5. 检测按键，如果按下 'q' 则退出</span></span><br><span class="line">            <span class="keyword">if</span> cv2.waitKey(<span class="number">1</span>) &amp; <span class="number">0xFF</span> == <span class="built_in">ord</span>(<span class="string">'q'</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"用户请求退出。"</span>)</span><br><span class="line">                cap.release() <span class="comment"># 释放资源</span></span><br><span class="line">                cv2.destroyAllWindows() <span class="comment"># 关闭窗口</span></span><br><span class="line">                <span class="keyword">return</span> <span class="comment"># 结束函数</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果内层循环 break (读取失败或流结束)，释放当前 capture 对象</span></span><br><span class="line">        cap.release()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"当前连接已断开。将在 <span class="subst">{reconnect_delay}</span> 秒后尝试重新连接..."</span>)</span><br><span class="line">        time.sleep(reconnect_delay)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        read_rtsp_stream(rtsp_url)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n捕获到 Ctrl+C，正在退出..."</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        cv2.destroyAllWindows() <span class="comment"># 确保所有 OpenCV 窗口都关闭</span></span><br></pre></td></tr></tbody></table></figure><p><strong>优点:</strong></p><ul><li>代码简洁，使用非常方便，几行代码就能开始读取帧。</li><li>直接获取 NumPy 数组，无缝对接 Python 中其他的图像处理、机器学习库。<br><strong>缺点:</strong></li><li>对底层的 FFmpeg 连接参数（如 TCP/UDP 选择、缓冲大小、超时设置）控制能力较弱。</li><li>错误处理相对基础，对于网络不稳定或摄像头异常的情况，可能需要更复杂的重连和错误恢复逻辑。</li></ul><hr><h5 id="15-3-7-2-推送-RTMP-直播流-使用-ffmpeg-python"><a href="#15-3-7-2-推送-RTMP-直播流-使用-ffmpeg-python" class="headerlink" title="15.3.7.2 推送 RTMP 直播流 (使用 ffmpeg-python)"></a>15.3.7.2 推送 RTMP 直播流 (使用 <code>ffmpeg-python</code>)</h5><p><strong>场景与用途:</strong><br>将本地视频文件、摄像头画面、屏幕录制或其他视频源，实时地以 RTMP 协议推送到流媒体服务器（如 SRS, Nginx-RTMP, Ant Media Server）或直播平台（如 Bilibili 直播、YouTube Live、Twitch 的 RTMP 接收地址）。这是 <strong>直播推流</strong> 最常用的方式之一。</p><p><strong>核心概念 (FFmpeg 命令):</strong><br>基本的 RTMP 推流命令结构如下：<br><code>ffmpeg -re -i &lt;输入源&gt; [编码选项] -f flv &lt;RTMP 推流地址&gt;</code></p><ul><li><strong><code>-re</code></strong>: (输入选项) 要求 FFmpeg 以输入源的 <strong>自然帧率</strong> 读取数据。这对于直播推流 <strong>非常重要</strong>，可以防止 FFmpeg 因为处理速度过快而瞬间将整个文件推完。</li><li><strong><code>-i &lt;输入源&gt;</code></strong>: 指定你的视频来源（本地文件路径、摄像头设备标识符等）。</li><li><strong><code>[编码选项]</code></strong>: 控制推流的音视频编码。<ul><li><code>-c copy</code> 或 <code>-c:v copy -c:a copy</code>: 如果输入源的编码格式 (通常是 H.264 视频 + AAC 音频) RTMP 协议和目标服务器 <strong>直接支持</strong>，使用 <code>copy</code> 可以 <strong>避免重新编码</strong>，大大降低 CPU 消耗，延迟也可能更低。</li><li><code>-c:v libx264 -preset veryfast -crf 25 ... -c:a aac -b:a 128k ...</code>: 如果需要转码（例如，来源不是 H.264/AAC，或者需要调整码率/分辨率/帧率），则需要指定编码器和参数。直播推流通常选用较快的 <code>preset</code>。</li></ul></li><li><strong><code>-f flv</code></strong>: (输出选项) <strong>强制</strong> 指定输出格式为 <code>flv</code> (Flash Video)。这是 RTMP 推流 <strong>必需</strong> 的容器格式。</li><li><strong><code>&lt;RTMP 推流地址&gt;</code></strong>: 你的流媒体服务器或直播平台提供的 RTMP 地址，通常格式为 <code>rtmp://&lt;服务器地址&gt;[:端口]/&lt;应用名&gt;/&lt;流密钥&gt;</code>。</li></ul><p><strong><code>ffmpeg-python</code> 实现:</strong></p><p>我们可以使用 <code>ffmpeg-python</code> 来构建并执行上述命令。</p><p><strong>代码示例: 将本地 MP4 文件推送到 RTMP 服务器</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># push_rtmp_ffmpeg_python.py</span></span><br><span class="line"><span class="keyword">import</span> ffmpeg</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 配置 ---</span></span><br><span class="line">input_file = <span class="string">"input.mp4"</span> <span class="comment"># 替换为你的本地视频文件路径</span></span><br><span class="line"><span class="comment"># !!! 将这里的 URL 替换为你的有效 RTMP 推流地址 !!!</span></span><br><span class="line"><span class="comment"># 本地测试服务器示例:</span></span><br><span class="line">rtmp_url = <span class="string">"rtmp://localhost/live/mystream"</span></span><br><span class="line"><span class="comment"># 其他平台示例 (需要替换 stream key):</span></span><br><span class="line"><span class="comment"># rtmp_url = "rtmp://a.rtmp.youtube.com/live2/YOUR_YOUTUBE_STREAM_KEY"</span></span><br><span class="line"><span class="comment"># rtmp_url = "rtmp://live-push.bilivideo.com/live-bvc/?streamname=...&amp;key=..."</span></span><br><span class="line"></span><br><span class="line">FFMPEG_PATH = <span class="string">"ffmpeg"</span> <span class="comment"># 假设在 PATH 中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">push_stream_to_rtmp</span>(<span class="params">source_path: <span class="built_in">str</span>, rtmp_destination: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">"""使用 ffmpeg-python 将视频文件推送到 RTMP 服务器"""</span></span><br><span class="line">    source_obj = Path(source_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> source_obj.is_file():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误: 输入文件不存在 '<span class="subst">{source_path}</span>'"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n--- 开始推送 '<span class="subst">{source_path}</span>' 到 '<span class="subst">{rtmp_destination}</span>' ---"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. 定义输入节点</span></span><br><span class="line">        <span class="comment">#    使用 re=None 来添加 -re 标志 (读取文件应按原始速率)</span></span><br><span class="line">        <span class="comment">#    对于直播设备输入可能不需要 -re，FFmpeg 会自动按设备速率读</span></span><br><span class="line">        input_node = ffmpeg.<span class="built_in">input</span>(<span class="built_in">str</span>(source_obj), re=<span class="literal">None</span>) <span class="comment"># re=None 对应 -re</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"输入节点已定义 (带 -re)"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. 定义输出节点</span></span><br><span class="line">        <span class="comment">#    将 RTMP URL 作为输出 "文件名"</span></span><br><span class="line">        <span class="comment">#    设置必要的输出选项</span></span><br><span class="line">        output_node = ffmpeg.output(</span><br><span class="line">            input_node,          <span class="comment"># 将所有自动选择的流 (通常是视频和音频) 传递给输出</span></span><br><span class="line">            rtmp_destination,    <span class="comment"># 输出目标是 RTMP URL</span></span><br><span class="line">            f=<span class="string">'flv'</span>,             <span class="comment"># **必需** 指定输出格式为 flv</span></span><br><span class="line">            <span class="comment"># --- 编码选项 (根据需要选择) ---</span></span><br><span class="line">            <span class="comment"># 选项 A: 直接复制流 (如果源是 H.264/AAC 且服务器支持，效率最高)</span></span><br><span class="line">            codec=<span class="string">'copy'</span>,        <span class="comment"># 等同于 -c copy 或 -c:v copy -c:a copy</span></span><br><span class="line">            <span class="comment"># 选项 B: 重新编码 (如果需要转码或调整参数)</span></span><br><span class="line">            <span class="comment"># vcodec='libx264',</span></span><br><span class="line">            <span class="comment"># preset='veryfast', # 直播常用较快预设</span></span><br><span class="line">            <span class="comment"># tune='zerolatency',# 针对低延迟优化 (可选)</span></span><br><span class="line">            <span class="comment"># video_bitrate='2M', # 控制视频码率</span></span><br><span class="line">            <span class="comment"># g=60,              # 设置关键帧间隔 (GOP)，通常为推流帧率的 2 倍左右</span></span><br><span class="line">            <span class="comment"># acodec='aac',</span></span><br><span class="line">            <span class="comment"># audio_bitrate='128k',</span></span><br><span class="line">            <span class="comment"># ar=44100,          # 音频采样率 (有时需要指定)</span></span><br><span class="line">            <span class="comment"># -----------------------------</span></span><br><span class="line">            **{<span class="string">'bsf:v'</span>: <span class="string">'h264_mp4toannexb'</span>} <span class="keyword">if</span> <span class="string">'-c:v copy'</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(input_node) <span class="keyword">else</span> {} <span class="comment"># 可能需要比特流过滤器，如果源是 MP4 封装的 H.264 并使用 copy</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 如果使用 -c copy 从 MP4 复制 H.264 流到 FLV/RTMP，有时需要添加比特流过滤器: -bsf:v h264_mp4toannexb</span></span><br><span class="line">        <span class="comment"># ffmpeg-python 中可以用 **{'bsf:v': 'h264_mp4toannexb'}</span></span><br><span class="line">        <span class="comment"># 但如果重新编码 (如用 libx264)，则不需要这个</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 查看命令 (调试)</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"生成的命令:"</span>, output_node.<span class="built_in">compile</span>(cmd=FFMPEG_PATH))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. 执行推流 (这是一个持续的过程，直到文件读完或被中断)</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"开始执行推流..."</span>)</span><br><span class="line">        <span class="comment"># 对于推流，stderr 通常包含连接和发送状态，捕获它很有用</span></span><br><span class="line">        process = output_node.run_async(cmd=FFMPEG_PATH, pipe_stderr=<span class="literal">True</span>) <span class="comment"># 使用 run_async 获取进程对象</span></span><br><span class="line">        <span class="comment"># 可以读取并打印 stderr 来监控状态</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                 line = process.stderr.readline().decode(errors=<span class="string">'ignore'</span>)</span><br><span class="line">                 <span class="keyword">if</span> <span class="keyword">not</span> line: <span class="keyword">break</span> <span class="comment"># 进程结束</span></span><br><span class="line">                 <span class="built_in">print</span>(<span class="string">f"[ffmpeg stderr] <span class="subst">{line.strip()}</span>"</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">             <span class="built_in">print</span>(<span class="string">f"读取 stderr 时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        process.wait() <span class="comment"># 等待进程结束</span></span><br><span class="line">        <span class="keyword">if</span> process.returncode == <span class="number">0</span>:</span><br><span class="line">             <span class="built_in">print</span>(<span class="string">"推流正常结束。"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">             <span class="built_in">print</span>(<span class="string">f"推流异常结束，返回码: <span class="subst">{process.returncode}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> ffmpeg.Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"FFmpeg 推流失败:"</span>)</span><br><span class="line">        <span class="built_in">print</span>(e.stderr.decode(errors=<span class="string">'ignore'</span>))</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">         <span class="built_in">print</span>(<span class="string">f"错误: 输入文件 '<span class="subst">{source_path}</span>' 或 ffmpeg 命令 '<span class="subst">{FFMPEG_PATH}</span>' 未找到。"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"执行推流时发生未知错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 运行 ---</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    push_stream_to_rtmp(input_file, rtmp_url)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>关键参数/知识点 (<code>ffmpeg.output</code> for RTMP):</strong></p><table><thead><tr><th align="left">kwarg</th><th align="left">FFmpeg CLI</th><th align="left">作用</th><th align="left">备注</th></tr></thead><tbody><tr><td align="left"><code>filename</code></td><td align="left">(输出文件名)</td><td align="left"><strong>必需:</strong> 设置为你的 RTMP 推流地址。</td><td align="left">如 <code>'rtmp://server/app/key'</code></td></tr><tr><td align="left"><code>f</code></td><td align="left"><code>-f flv</code></td><td align="left"><strong>必需:</strong> 强制指定输出格式为 <code>flv</code>。</td><td align="left">RTMP 协议基于 FLV 容器。</td></tr><tr><td align="left"><code>codec</code></td><td align="left"><code>-c copy</code></td><td align="left">(可选) 直接复制所有流。<strong>推荐优先尝试</strong>，如果源编码兼容 RTMP。</td><td align="left">效率最高，CPU 占用最低。</td></tr><tr><td align="left"><code>vcodec</code></td><td align="left"><code>-c:v &lt;codec&gt;</code></td><td align="left">(可选, 如果不 copy) 指定视频编码器，直播通常用 <code>libx264</code>。</td><td align="left"></td></tr><tr><td align="left"><code>acodec</code></td><td align="left"><code>-c:a &lt;codec&gt;</code></td><td align="left">(可选, 如果不 copy) 指定音频编码器，直播常用 <code>aac</code>。</td><td align="left"></td></tr><tr><td align="left"><code>preset</code></td><td align="left"><code>-preset &lt;value&gt;</code></td><td align="left">(可选, 编码时) 编码预设，直播常用 <code>'veryfast'</code> 或 <code>'fast'</code>。</td><td align="left"></td></tr><tr><td align="left"><code>tune</code></td><td align="left"><code>-tune &lt;value&gt;</code></td><td align="left">(可选, 编码时) 编码器调优，<code>'zerolatency'</code> 可能有助于降低编码延迟。</td><td align="left"></td></tr><tr><td align="left"><code>video_bitrate</code></td><td align="left"><code>-b:v &lt;rate&gt;</code></td><td align="left">(可选, 编码时) 控制视频码率。</td><td align="left"></td></tr><tr><td align="left"><code>audio_bitrate</code></td><td align="left"><code>-b:a &lt;rate&gt;</code></td><td align="left">(可选, 编码时) 控制音频码率。</td><td align="left"></td></tr><tr><td align="left"><code>g</code></td><td align="left"><code>-g &lt;value&gt;</code></td><td align="left">(可选, 编码时) 设置关键帧间隔 (GOP size)。对直播流很重要，建议设为帧率的 2-4 倍。</td><td align="left">如 <code>-g 60</code> (假设帧率 30)。</td></tr><tr><td align="left"><code>**{'bsf:v': '...'}</code></td><td align="left"><code>-bsf:v ...</code></td><td align="left">(可选, 仅 copy 时) 比特流过滤器，如 <code>'h264_mp4toannexb'</code> (从 MP4 复制 H.264 时需要)。</td><td align="left"></td></tr><tr><td align="left"><code>re=None</code></td><td align="left"><code>-re</code></td><td align="left">(<strong>输入选项</strong>) 在 <code>ffmpeg.input()</code> 中使用，按源帧率读取，<strong>直播推流必需</strong>。</td><td align="left"></td></tr></tbody></table><p><strong>注意:</strong></p><ul><li>你需要一个正在运行的 RTMP 服务器来接收推流。可以使用 Nginx + RTMP 模块、SRS、Ant Media Server 等自行搭建，或者使用直播平台提供的推流地址。</li><li>如果推流来源是摄像头等实时设备，需要在 <code>ffmpeg.input()</code> 中使用正确的设备名和格式参数（如 <code>-f dshow -i video="My Camera"</code> on Windows, <code>-f v4l2 -i /dev/video0</code> on Linux, <code>-f avfoundation -i "0"</code> on macOS），并且通常 <strong>不需要</strong> 输入选项 <code>-re</code>。</li></ul><hr><h3 id="15-4-网络安全与加密"><a href="#15-4-网络安全与加密" class="headerlink" title="15.4 网络安全与加密"></a>15.4 网络安全与加密</h3><p>在现代软件开发中，网络通信无处不在。无论是构建 Web 应用、API 服务、移动后端还是分布式系统，数据在网络中的传输都面临着被窃听、篡改或伪造的风险。因此，<strong>网络安全</strong> 和 <strong>数据加密</strong> 成为了保护用户信息、维护系统完整性和确保业务连续性的基石。Python 凭借其丰富的标准库和第三方库生态系统，为开发者提供了强大的工具来实现安全的网络通信和数据保护。</p><p>本章将深入探讨网络安全的核心概念，特别是 TLS/SSL 协议，以及常用的数据摘要（哈希）、编码和加密技术，并结合 Python 代码示例进行实战讲解，帮助你理解其原理、应用场景和最佳实践，规避常见陷阱。</p><h4 id="15-4-1-TLS-SSL-加密通信：保障传输通道安全"><a href="#15-4-1-TLS-SSL-加密通信：保障传输通道安全" class="headerlink" title="15.4.1 TLS/SSL 加密通信：保障传输通道安全"></a>15.4.1 TLS/SSL 加密通信：保障传输通道安全</h4><p>当你通过浏览器访问 <code>https://</code> 网站，或者当你的应用程序通过网络与服务器安全地交换数据时，<strong>TLS (Transport Layer Security)</strong> 及其前身 <strong>SSL (Secure Sockets Layer)</strong> 协议就在幕后默默工作。它们是保障网络通信通道安全的事实标准。</p><p>想象一下没有 TLS/SSL 的互联网通信，就像是在大街上用明信片传递非常私密的信息：</p><p><strong>1.谁都能看（无保密性）：</strong> 任何在网络路径上的中间节点（你的网络提供商、同一 Wi-Fi 下的其他人、黑客控制的路由器等）都能轻易读取你的数据，比如用户名、密码、银行卡号、聊天内容。</p><p><strong>2.谁都能改（无完整性）：</strong> 中间人可以截获你的数据，修改后再发给对方，而接收方可能毫无察觉。比如，把转账金额改掉，或者在网页里注入恶意脚本。</p><p><strong>3.你不知道对方是谁（无身份认证）：</strong> 你连接一个网站或服务时，无法确定对方真的是你想连接的目标。攻击者可以伪造一个看起来一模一样的网站（钓鱼网站）来骗取你的信息。这就是所谓的 <strong>中间人攻击 (Man-in-the-Middle, MitM)</strong>。</p><p>本小结的代码核心不是教你 <code>ssl</code> 模块的 API 语法，而是强调：</p><p>网络通信默认不安全，必须主动采取措施（使用 TLS/SSL）来保障数据传输的机密性、完整性和通信双方的身份真实性。Python 的 <code>ssl</code> 模块提供了实现这些安全保障的标准工具。理解并正确使用这些工具对于开发任何需要网络交互的安全应用都至关重要。</p><h5 id="TLS-SSL-的关键特性与安全意义"><a href="#TLS-SSL-的关键特性与安全意义" class="headerlink" title="TLS/SSL 的关键特性与安全意义"></a>TLS/SSL 的关键特性与安全意义</h5><p>理解 TLS/SSL 提供的安全保障对于正确使用它至关重要。</p><table><thead><tr><th align="left">特性</th><th align="left">描述</th><th align="left">安全意义</th><th align="left">日常场景举例</th></tr></thead><tbody><tr><td align="left"><strong>加密通信</strong></td><td align="left">数据在客户端和服务器之间传输时，使用协商好的对称密钥进行加密。</td><td align="left">防止网络中间的 <em><strong>窃听者</strong></em>（如 Wi-Fi 热点上的攻击者）读取敏感信息。</td><td align="left">在线银行交易、登录凭据提交、API 数据传输。</td></tr><tr><td align="left"><strong>身份验证</strong></td><td align="left">通常，客户端会验证服务器提供的 <strong>数字证书</strong>，以确认服务器的真实身份。</td><td align="left">防止 <em><strong>中间人攻击 (Man-in-the-Middle, MitM)</strong></em>，确保你连接的是目标服务器，而非冒名顶替者。</td><td align="left">浏览器验证网站证书，显示安全锁标志。</td></tr><tr><td align="left"><strong>数据完整性</strong></td><td align="left">使用消息认证码 (MAC) 或类似机制，确保数据在传输过程中没有被修改。</td><td align="left">防止数据在传输途中被 <em><strong>篡改</strong></em>，例如修改交易金额或注入恶意内容。</td><td align="left">确保下载的文件未被损坏或植入病毒。</td></tr><tr><td align="left"><strong>前向保密 (PFS)</strong></td><td align="left">（可选，但推荐）即使服务器的长期私钥泄露，过去的会话密钥也无法被解密。</td><td align="left">即使发生最坏情况（私钥泄露），也能保护 <em><strong>历史通信</strong></em> 的机密性，增强长期安全。</td><td align="left">现代 Web 服务器（如 Nginx, Apache）通常默认启用。</td></tr></tbody></table><blockquote><p><strong>注释</strong>：虽然 SSL 是早期版本，且存在已知漏洞，现在应始终优先使用 TLS（当前推荐版本为 TLS 1.2 和 TLS 1.3）。Python 的 <code>ssl</code> 模块默认会尝试使用安全的协议版本。</p></blockquote><h5 id="Python-中的-TLS-SSL-支持：ssl-模块"><a href="#Python-中的-TLS-SSL-支持：ssl-模块" class="headerlink" title="Python 中的 TLS/SSL 支持：ssl 模块"></a>Python 中的 TLS/SSL 支持：<code>ssl</code> 模块</h5><p>Python 的内置 <code>ssl</code> 模块提供了创建 TLS/SSL 安全连接的接口，可以包装标准的 <code>socket</code> 对象。</p><h6 id="示例-1：创建一个安全的-TLS-SSL-客户端"><a href="#示例-1：创建一个安全的-TLS-SSL-客户端" class="headerlink" title="示例 1：创建一个安全的 TLS/SSL 客户端"></a>示例 1：创建一个安全的 TLS/SSL 客户端</h6><p>这个例子演示了如何连接到一个公共 HTTPS 网站 (<code>www.python.org</code>)，验证其证书，并进行简单的 HTTP 请求。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> pprint  <span class="comment"># 用于更美观地打印证书信息</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">secure_tls_client_example</span>(<span class="params">host=<span class="string">"www.python.org"</span>, port=<span class="number">443</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    演示创建一个安全的 TLS/SSL 客户端连接。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        host (str): 目标服务器主机名。</span></span><br><span class="line"><span class="string">        port (int): 目标服务器端口号 (HTTPS 默认为 443)。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"--- 开始连接到 <span class="subst">{host}</span>:<span class="subst">{port}</span> ---"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 创建 SSL 上下文 (Context)</span></span><br><span class="line">    <span class="comment">#    - Purpose.SERVER_AUTH: 指定此上下文用于验证服务器证书。</span></span><br><span class="line">    <span class="comment">#    - create_default_context: 使用系统推荐的安全设置 (推荐做法)。</span></span><br><span class="line">    context = ssl.create_default_context(ssl.Purpose.SERVER_AUTH)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 可选: 配置更严格的设置</span></span><br><span class="line">    <span class="comment"># context.minimum_version = ssl.TLSVersion.TLSv1_2 # 强制最低 TLS 版本</span></span><br><span class="line">    <span class="comment"># context.set_ciphers('DEFAULT@SECLEVEL=2') # 设置密码套件安全级别 (具体依赖 OpenSSL 版本)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 可选: 加载客户端证书 (如果服务器要求客户端认证，较少见于公共网站)</span></span><br><span class="line">    <span class="comment"># try:</span></span><br><span class="line">    <span class="comment">#     context.load_cert_chain(certfile="path/to/client.crt", keyfile="path/to/client.key")</span></span><br><span class="line">    <span class="comment"># except ssl.SSLError as e:</span></span><br><span class="line">    <span class="comment">#     print(f"加载客户端证书失败: {e}")</span></span><br><span class="line">    <span class="comment">#     # 根据需要处理错误，可能是证书文件问题或密码错误</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 创建标准 TCP 套接字</span></span><br><span class="line">    <span class="comment">#    - AF_INET: 使用 IPv4 地址族。</span></span><br><span class="line">    <span class="comment">#    - SOCK_STREAM: 使用 TCP 协议。</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sock = socket.create_connection((host, port), timeout=<span class="number">10</span>)  <span class="comment"># 包含 DNS 解析和连接，设置超时</span></span><br><span class="line">    <span class="keyword">except</span> socket.gaierror <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：无法解析主机名 <span class="subst">{host}</span>: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> socket.timeout:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：连接 <span class="subst">{host}</span>:<span class="subst">{port}</span> 超时"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：无法建立 TCP 连接到 <span class="subst">{host}</span>:<span class="subst">{port}</span>: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 使用 SSL 上下文包装套接字</span></span><br><span class="line">    <span class="comment">#    - wrap_socket: 将普通 socket 包装成 SSLSocket。</span></span><br><span class="line">    <span class="comment">#    - server_hostname: 必须提供！用于服务器名称指示 (SNI) 和证书主机名验证。</span></span><br><span class="line">    <span class="comment">#      SNI 允许多个 HTTPS 站点共享同一 IP 地址。主机名验证确保证书匹配我们连接的主机。</span></span><br><span class="line">    <span class="comment">#    * 踩坑点：**忘记或错误设置 `server_hostname` 是导致连接失败或安全风险的常见原因！**</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ssl_sock = context.wrap_socket(sock, server_hostname=host)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"成功建立 TLS 连接到 <span class="subst">{ssl_sock.server_hostname}</span> (IP: <span class="subst">{ssl_sock.getpeername()}</span>)"</span>)</span><br><span class="line">    <span class="keyword">except</span> ssl.SSLCertVerificationError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：服务器证书验证失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        sock.close()  <span class="comment"># 验证失败，必须关闭原始 socket</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> ssl.SSLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：TLS 握手失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        sock.close()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:  <span class="comment"># 捕获其他可能的 wrap_socket 错误</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：包装套接字时发生未知错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        sock.close()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. (成功连接后) 获取和检查连接信息</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n--- TLS 连接详情 ---"</span>)</span><br><span class="line">        <span class="comment"># 获取并打印使用的 TLS/SSL 版本和密码套件</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"TLS 版本: <span class="subst">{ssl_sock.version()}</span>"</span>)</span><br><span class="line">        cipher_details = ssl_sock.cipher()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"密码套件: <span class="subst">{cipher_details[<span class="number">0</span>]}</span>"</span>)  <span class="comment"># 密码套件名称 (e.g., TLS_AES_256_GCM_SHA384)</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"协议版本: <span class="subst">{cipher_details[<span class="number">1</span>]}</span>"</span>)  <span class="comment"># 使用的协议 (e.g., TLSv1.3)</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"密钥位数: <span class="subst">{cipher_details[<span class="number">2</span>]}</span>"</span>)  <span class="comment"># 对称加密密钥位数 (e.g., 256)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取服务器证书信息</span></span><br><span class="line">        server_cert = ssl_sock.getpeercert()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n--- 服务器证书信息 ---"</span>)</span><br><span class="line">        <span class="comment"># 使用 pprint 格式化输出复杂的证书结构</span></span><br><span class="line">        pprint.pprint(server_cert)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 提取并格式化关键信息</span></span><br><span class="line">        <span class="keyword">if</span> server_cert:</span><br><span class="line">            subject_dict = <span class="built_in">dict</span>(x[<span class="number">0</span>] <span class="keyword">for</span> x <span class="keyword">in</span> server_cert.get(<span class="string">'subject'</span>, []))</span><br><span class="line">            issuer_dict = <span class="built_in">dict</span>(x[<span class="number">0</span>] <span class="keyword">for</span> x <span class="keyword">in</span> server_cert.get(<span class="string">'issuer'</span>, []))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"\n  主要信息提取:"</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  主题 (Subject CN): <span class="subst">{subject_dict.get(<span class="string">'commonName'</span>, <span class="string">'N/A'</span>)}</span>"</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  颁发者 (Issuer CN): <span class="subst">{issuer_dict.get(<span class="string">'commonName'</span>, <span class="string">'N/A'</span>)}</span>"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 解析证书有效期 (注意日期格式可能变化，添加健壮性)</span></span><br><span class="line">                formats_to_try = [<span class="string">"%b %d %H:%M:%S %Y %Z"</span>, <span class="string">"%Y%m%d%H%M%SZ"</span>]  <span class="comment"># 常见格式</span></span><br><span class="line">                not_before, not_after = <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">                <span class="keyword">for</span> fmt <span class="keyword">in</span> formats_to_try:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        not_before = datetime.datetime.strptime(server_cert[<span class="string">'notBefore'</span>], fmt)</span><br><span class="line">                        not_after = datetime.datetime.strptime(server_cert[<span class="string">'notAfter'</span>], fmt)</span><br><span class="line">                        <span class="keyword">break</span>  <span class="comment"># 成功解析则跳出</span></span><br><span class="line">                    <span class="keyword">except</span> ValueError:</span><br><span class="line">                        <span class="keyword">continue</span>  <span class="comment"># 格式不匹配，尝试下一个</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> not_before <span class="keyword">and</span> not_after:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f"  有效期: <span class="subst">{not_before.strftime(<span class="string">'%Y-%m-%d'</span>)}</span> 至 <span class="subst">{not_after.strftime(<span class="string">'%Y-%m-%d'</span>)}</span>"</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">"  有效期: 无法解析日期格式"</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 检查证书是否即将过期或已过期</span></span><br><span class="line">                now = datetime.datetime.now()</span><br><span class="line">                <span class="keyword">if</span> not_after &lt; now:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">"  警告: 证书已过期！"</span>)</span><br><span class="line">                <span class="keyword">elif</span> (not_after - now).days &lt; <span class="number">30</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f"  警告: 证书将在 <span class="subst">{(not_after - now).days}</span> 天内过期！"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> KeyError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"  有效期: 证书信息中缺少日期字段"</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"  有效期: 解析日期时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5. 通过安全通道发送和接收数据 (示例: HTTP GET 请求)</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n--- 发送 HTTP GET 请求 ---"</span>)</span><br><span class="line">        request = <span class="string">f"GET / HTTP/1.1\r\nHost: <span class="subst">{host}</span>\r\nConnection: close\r\nUser-Agent: Python-SecureClient/1.0\r\nAccept: */*\r\n\r\n"</span></span><br><span class="line">        ssl_sock.sendall(request.encode(<span class="string">'utf-8'</span>))  <span class="comment"># 使用 sendall 确保所有数据发送</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"请求已发送。"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n--- 接收响应 ---"</span>)</span><br><span class="line">        response_parts = []</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                chunk = ssl_sock.recv(<span class="number">4096</span>)  <span class="comment"># 接收数据块</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">                    <span class="keyword">break</span>  <span class="comment"># 服务器关闭连接，接收完毕</span></span><br><span class="line">                response_parts.append(chunk)</span><br><span class="line">            <span class="keyword">except</span> ssl.SSLWantReadError:</span><br><span class="line">                <span class="comment"># 非阻塞模式下可能出现，这里是阻塞模式，理论上不应频繁触发</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"等待更多数据..."</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">except</span> socket.timeout:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"错误：接收响应超时"</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> ssl.SSLError <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"错误：接收数据时发生 SSL 错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"错误：接收数据时发生套接字错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        response = <span class="string">b""</span>.join(response_parts)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"收到 <span class="subst">{<span class="built_in">len</span>(response)}</span> 字节的响应。"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 尝试解码并打印部分响应头和内容</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            decoded_response = response.decode(<span class="string">'utf-8'</span>, errors=<span class="string">'ignore'</span>)  <span class="comment"># 使用 ignore 处理可能的解码错误</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\n--- 响应预览 (前 500 字符) ---"</span>)</span><br><span class="line">            <span class="built_in">print</span>(decoded_response[:<span class="number">500</span>] + (<span class="string">"..."</span> <span class="keyword">if</span> <span class="built_in">len</span>(decoded_response) &gt; <span class="number">500</span> <span class="keyword">else</span> <span class="string">""</span>))</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"解码响应时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"原始响应 (前 500 字节):"</span>)</span><br><span class="line">            <span class="built_in">print</span>(response[:<span class="number">500</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> ssl.SSLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 捕获通信过程中的 SSL 错误</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：在 TLS 通信期间发生错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：在通信期间发生套接字错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 捕获任何其他意外错误</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：发生意外错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 6. 关闭连接</span></span><br><span class="line">        <span class="comment">#    - **重要**：务必在 finally 块中关闭套接字，确保资源被释放。</span></span><br><span class="line">        <span class="comment">#    - 关闭 SSLSocket 会自动处理 TLS 关闭握手 (发送 close_notify)。</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n--- 关闭连接 ---"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'ssl_sock'</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> ssl_sock:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                ssl_sock.close()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"SSL/TLS 套接字已关闭。"</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"关闭 SSL 套接字时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行客户端示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    secure_tls_client_example(host=<span class="string">"blog.csdn.net"</span>)</span><br><span class="line">    <span class="comment"># 尝试连接其他网站</span></span><br><span class="line">    <span class="comment"># secure_tls_client_example(host="www.google.com")</span></span><br><span class="line">    <span class="comment"># 尝试连接一个使用自签名证书或无效证书的地址（预期会失败）</span></span><br><span class="line">    <span class="comment"># secure_tls_client_example(host="expired.badssl.com")</span></span><br><span class="line">    <span class="comment"># secure_tls_client_example(host="self-signed.badssl.com")</span></span><br></pre></td></tr></tbody></table></figure><h5 id="示例-2：创建一个基础的-TLS-SSL-服务器"><a href="#示例-2：创建一个基础的-TLS-SSL-服务器" class="headerlink" title="示例 2：创建一个基础的 TLS/SSL 服务器"></a>示例 2：创建一个基础的 TLS/SSL 服务器</h5><p>这个例子需要你自己生成一个服务器证书和私钥文件。</p><p><strong>前提：生成自签名证书和私钥</strong></p><p>在你的项目目录下，使用 OpenSSL 命令行工具执行：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成一个新的私钥 (key.pem) 和一个自签名的证书 (cert.pem)，有效期 365 天</span></span><br><span class="line"><span class="comment"># -nodes: 不加密私钥 (方便测试，生产环境通常会加密并使用密码)</span></span><br><span class="line"><span class="comment"># -new: 生成新的证书请求和私钥</span></span><br><span class="line"><span class="comment"># -x509: 输出自签名证书而不是证书请求</span></span><br><span class="line"><span class="comment"># -days 365: 证书有效期</span></span><br><span class="line"><span class="comment"># -out cert.pem: 输出证书文件</span></span><br><span class="line"><span class="comment"># -keyout key.pem: 输出私钥文件</span></span><br><span class="line">openssl req -new -x509 -days 365 -nodes -out cert.pem -keyout key.pem -subj <span class="string">"/C=CN/ST=Beijing/L=Beijing/O=MyOrg/OU=MyDept/CN=localhost"</span> </span><br><span class="line">    <span class="comment"># 提供一些主题信息，CN (Common Name) 对某些客户端验证很重要，这里设为 localhost</span></span><br></pre></td></tr></tbody></table></figure><p><strong>Python 服务器代码：</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> os  <span class="comment"># 用于检查证书文件是否存在</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_secure_client</span>(<span class="params">ssl_client_sock, client_addr</span>):</span><br><span class="line">    <span class="string">"""处理单个安全客户端连接的线程函数"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程 <span class="subst">{threading.get_ident()}</span>: 处理来自 <span class="subst">{client_addr}</span> 的连接"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 显示连接的加密信息</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  客户端 TLS 版本: <span class="subst">{ssl_client_sock.version()}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  客户端使用密码套件: <span class="subst">{ssl_client_sock.cipher()[<span class="number">0</span>]}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 接收数据</span></span><br><span class="line">        request_data = ssl_client_sock.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request_data:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  客户端 <span class="subst">{client_addr}</span> 未发送数据，提前关闭连接。"</span>)</span><br><span class="line">            <span class="keyword">return</span>  <span class="comment"># 如果客户端连接后立即关闭，则不发送响应</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            <span class="string">f"  收到 <span class="subst">{<span class="built_in">len</span>(request_data)}</span> 字节数据: <span class="subst">{request_data.decode(<span class="string">'utf-8'</span>, errors=<span class="string">'ignore'</span>)[:<span class="number">80</span>]}</span>..."</span>)  <span class="comment"># 打印部分接收内容</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构造并发送一个简单的 HTTPS 响应</span></span><br><span class="line">        response_body = <span class="string">f"""</span></span><br><span class="line"><span class="string">        &lt;html&gt;</span></span><br><span class="line"><span class="string">            &lt;head&gt;&lt;title&gt;Secure Server Response&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">            &lt;body&gt;</span></span><br><span class="line"><span class="string">                &lt;h1&gt;Hello from Secure Python Server!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;Your connection from <span class="subst">{client_addr}</span> is encrypted using <span class="subst">{ssl_client_sock.cipher()[<span class="number">0</span>]}</span>.&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        response_headers = <span class="string">f"""HTTP/1.1 200 OK</span></span><br><span class="line"><span class="string">Content-Type: text/html; charset=utf-8</span></span><br><span class="line"><span class="string">Content-Length: <span class="subst">{<span class="built_in">len</span>(response_body.encode(<span class="string">'utf-8'</span>))}</span></span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Server: Python-SecureServer/1.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span>  <span class="comment"># 注意headers 和 body 之间必须有空行 (\r\n\r\n 或 \n\n)</span></span><br><span class="line"></span><br><span class="line">        full_response = response_headers.encode(<span class="string">'utf-8'</span>) + response_body.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">        ssl_client_sock.sendall(full_response)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  已向 <span class="subst">{client_addr}</span> 发送响应。"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> ssl.SSLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：与客户端 <span class="subst">{client_addr}</span> 通信时发生 SSL 错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：与客户端 <span class="subst">{client_addr}</span> 通信时发生套接字错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：处理客户端 <span class="subst">{client_addr}</span> 时发生意外错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 关闭与该客户端的连接</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ssl_client_sock.shutdown(socket.SHUT_RDWR)  <span class="comment"># 尝试优雅关闭</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span>  <span class="comment"># 忽略关闭中的错误</span></span><br><span class="line">        ssl_client_sock.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"线程 <span class="subst">{threading.get_ident()}</span>: 与 <span class="subst">{client_addr}</span> 的连接已关闭。"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_secure_tls_server</span>(<span class="params">host=<span class="string">'localhost'</span>, port=<span class="number">8443</span>, certfile=<span class="string">'cert.pem'</span>, keyfile=<span class="string">'key.pem'</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    创建并运行一个基础的多线程 TLS/SSL 服务器。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        host (str): 服务器绑定的主机地址。 '0.0.0.0' 表示监听所有网络接口。</span></span><br><span class="line"><span class="string">        port (int): 服务器监听的端口号。</span></span><br><span class="line"><span class="string">        certfile (str): 服务器证书文件路径。</span></span><br><span class="line"><span class="string">        keyfile (str): 服务器私钥文件路径。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 检查证书和密钥文件是否存在</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(certfile) <span class="keyword">or</span> <span class="keyword">not</span> os.path.exists(keyfile):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：证书文件 '<span class="subst">{certfile}</span>' 或密钥文件 '<span class="subst">{keyfile}</span>' 不存在。"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"请先使用 openssl 生成："</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"openssl req -new -x509 -days 365 -nodes -out cert.pem -keyout key.pem -subj \"/CN=localhost\""</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 创建 SSL 上下文</span></span><br><span class="line">    <span class="comment">#    - PROTOCOL_TLS_SERVER: 表明这是服务器端上下文，会自动选择合适的最高 TLS 协议版本。</span></span><br><span class="line">    context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 加载服务器证书和私钥</span></span><br><span class="line">    <span class="comment">#    * 踩坑点：证书和私钥文件路径必须正确，并且程序需要有读取权限。</span></span><br><span class="line">    <span class="comment">#    * 踩坑点：如果私钥被密码保护，需要提供 password 参数。</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        context.load_cert_chain(certfile=certfile, keyfile=keyfile)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"服务器证书和私钥加载成功。"</span>)</span><br><span class="line">    <span class="keyword">except</span> ssl.SSLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：加载证书/密钥失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"请确保证书 '<span class="subst">{certfile}</span>' 和密钥 '<span class="subst">{keyfile}</span>' 文件有效且格式正确。"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：找不到证书文件 '<span class="subst">{certfile}</span>' 或密钥文件 '<span class="subst">{keyfile}</span>'。"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 可选: 配置服务器端的 TLS 设置</span></span><br><span class="line">    <span class="comment"># context.minimum_version = ssl.TLSVersion.TLSv1_2</span></span><br><span class="line">    <span class="comment"># context.set_ciphers(...) # 定义允许的密码套件</span></span><br><span class="line">    <span class="comment"># context.options |= ssl.OP_NO_SSLv3 | ssl.OP_NO_TLSv1 | ssl.OP_NO_TLSv1_1 # 禁用不安全的旧协议</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 创建、绑定和监听普通 TCP 套接字</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        bindsocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        <span class="comment"># 设置 SO_REUSEADDR 选项，允许服务器快速重启并重新绑定到之前的地址</span></span><br><span class="line">        bindsocket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        server_address = (host, port)</span><br><span class="line">        bindsocket.bind(server_address)</span><br><span class="line">        bindsocket.listen(<span class="number">5</span>)  <span class="comment"># 设置连接队列大小</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"安全服务器启动，正在监听 <span class="subst">{server_address}</span>..."</span>)</span><br><span class="line">    <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：无法绑定或监听端口 <span class="subst">{port}</span>: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"端口可能已被占用，或者没有权限绑定到该地址。"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：服务器套接字设置失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. 循环接受客户端连接</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\n等待新的客户端连接..."</span>)</span><br><span class="line">            <span class="comment"># 接受普通 TCP 连接</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                client_sock, client_addr = bindsocket.accept()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"接受来自 <span class="subst">{client_addr}</span> 的 TCP 连接。"</span>)</span><br><span class="line">            <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"警告：接受连接时出错: <span class="subst">{e}</span>。继续等待..."</span>)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># 发生错误，继续等待下一个连接</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 5. 包装客户端套接字为 SSLSocket</span></span><br><span class="line">            <span class="comment">#    - server_side=True: 表明这是服务器端包装。</span></span><br><span class="line">            <span class="comment">#    - do_handshake_on_connect=True (默认): 包装时自动执行 TLS 握手。</span></span><br><span class="line">            <span class="comment">#    * 踩坑点：TLS 握手可能失败（例如客户端不支持服务器的协议/密码套件，或证书问题）。</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                ssl_client_sock = context.wrap_socket(client_sock, server_side=<span class="literal">True</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"与 <span class="subst">{client_addr}</span> 的 TLS 握手成功。"</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 6. 为每个客户端连接创建一个新线程进行处理</span></span><br><span class="line">                <span class="comment">#    - 避免阻塞主循环，可以同时处理多个客户端。</span></span><br><span class="line">                <span class="comment">#    * 注意：对于高并发场景，线程模型可能不是最高效的，可考虑异步IO (asyncio)。</span></span><br><span class="line">                client_handler = threading.Thread(</span><br><span class="line">                    target=handle_secure_client,</span><br><span class="line">                    args=(ssl_client_sock, client_addr),</span><br><span class="line">                    daemon=<span class="literal">True</span>  <span class="comment"># 设置为守护线程，主线程退出时它们也会退出</span></span><br><span class="line">                )</span><br><span class="line">                client_handler.start()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> ssl.SSLError <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"错误：与 <span class="subst">{client_addr}</span> 的 TLS 握手失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                client_sock.close()  <span class="comment"># 握手失败，关闭原始 socket</span></span><br><span class="line">            <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:  <span class="comment"># 处理包装或握手期间可能的套接字错误</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"错误：在包装套接字或与 <span class="subst">{client_addr}</span> 握手期间发生错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                client_sock.close()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"错误：处理新连接 <span class="subst">{client_addr}</span> 时发生未知错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                client_sock.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n检测到 Ctrl+C，服务器正在关闭..."</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"\n服务器主循环发生意外错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 关闭监听套接字</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"关闭服务器监听套接字。"</span>)</span><br><span class="line">        bindsocket.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行服务器示例 (需要先生成 cert.pem 和 key.pem)</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    create_secure_tls_server() <span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> os  <span class="comment"># 用于检查证书文件是否存在</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_secure_client</span>(<span class="params">ssl_client_sock, client_addr</span>):</span><br><span class="line">    <span class="string">"""处理单个安全客户端连接的线程函数"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"线程 <span class="subst">{threading.get_ident()}</span>: 处理来自 <span class="subst">{client_addr}</span> 的连接"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 显示连接的加密信息</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  客户端 TLS 版本: <span class="subst">{ssl_client_sock.version()}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  客户端使用密码套件: <span class="subst">{ssl_client_sock.cipher()[<span class="number">0</span>]}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 接收数据</span></span><br><span class="line">        request_data = ssl_client_sock.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request_data:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  客户端 <span class="subst">{client_addr}</span> 未发送数据，提前关闭连接。"</span>)</span><br><span class="line">            <span class="keyword">return</span>  <span class="comment"># 如果客户端连接后立即关闭，则不发送响应</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            <span class="string">f"  收到 <span class="subst">{<span class="built_in">len</span>(request_data)}</span> 字节数据: <span class="subst">{request_data.decode(<span class="string">'utf-8'</span>, errors=<span class="string">'ignore'</span>)[:<span class="number">80</span>]}</span>..."</span>)  <span class="comment"># 打印部分接收内容</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构造并发送一个简单的 HTTPS 响应</span></span><br><span class="line">        response_body = <span class="string">f"""</span></span><br><span class="line"><span class="string">        &lt;html&gt;</span></span><br><span class="line"><span class="string">            &lt;head&gt;&lt;title&gt;Secure Server Response&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">            &lt;body&gt;</span></span><br><span class="line"><span class="string">                &lt;h1&gt;Hello from Secure Python Server!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;Your connection from <span class="subst">{client_addr}</span> is encrypted using <span class="subst">{ssl_client_sock.cipher()[<span class="number">0</span>]}</span>.&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        response_headers = <span class="string">f"""HTTP/1.1 200 OK</span></span><br><span class="line"><span class="string">Content-Type: text/html; charset=utf-8</span></span><br><span class="line"><span class="string">Content-Length: <span class="subst">{<span class="built_in">len</span>(response_body.encode(<span class="string">'utf-8'</span>))}</span></span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Server: Python-SecureServer/1.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span>  <span class="comment"># 注意headers 和 body 之间必须有空行 (\r\n\r\n 或 \n\n)</span></span><br><span class="line"></span><br><span class="line">        full_response = response_headers.encode(<span class="string">'utf-8'</span>) + response_body.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">        ssl_client_sock.sendall(full_response)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  已向 <span class="subst">{client_addr}</span> 发送响应。"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> ssl.SSLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：与客户端 <span class="subst">{client_addr}</span> 通信时发生 SSL 错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：与客户端 <span class="subst">{client_addr}</span> 通信时发生套接字错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：处理客户端 <span class="subst">{client_addr}</span> 时发生意外错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 关闭与该客户端的连接</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ssl_client_sock.shutdown(socket.SHUT_RDWR)  <span class="comment"># 尝试优雅关闭</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span>  <span class="comment"># 忽略关闭中的错误</span></span><br><span class="line">        ssl_client_sock.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"线程 <span class="subst">{threading.get_ident()}</span>: 与 <span class="subst">{client_addr}</span> 的连接已关闭。"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_secure_tls_server</span>(<span class="params">host=<span class="string">'localhost'</span>, port=<span class="number">8443</span>, certfile=<span class="string">'cert.pem'</span>, keyfile=<span class="string">'key.pem'</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    创建并运行一个基础的多线程 TLS/SSL 服务器。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        host (str): 服务器绑定的主机地址。 '0.0.0.0' 表示监听所有网络接口。</span></span><br><span class="line"><span class="string">        port (int): 服务器监听的端口号。</span></span><br><span class="line"><span class="string">        certfile (str): 服务器证书文件路径。</span></span><br><span class="line"><span class="string">        keyfile (str): 服务器私钥文件路径。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 检查证书和密钥文件是否存在</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(certfile) <span class="keyword">or</span> <span class="keyword">not</span> os.path.exists(keyfile):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：证书文件 '<span class="subst">{certfile}</span>' 或密钥文件 '<span class="subst">{keyfile}</span>' 不存在。"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"请先使用 openssl 生成："</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"openssl req -new -x509 -days 365 -nodes -out cert.pem -keyout key.pem -subj \"/CN=localhost\""</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 创建 SSL 上下文</span></span><br><span class="line">    <span class="comment">#    - PROTOCOL_TLS_SERVER: 表明这是服务器端上下文，会自动选择合适的最高 TLS 协议版本。</span></span><br><span class="line">    context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 加载服务器证书和私钥</span></span><br><span class="line">    <span class="comment">#    * 踩坑点：证书和私钥文件路径必须正确，并且程序需要有读取权限。</span></span><br><span class="line">    <span class="comment">#    * 踩坑点：如果私钥被密码保护，需要提供 password 参数。</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        context.load_cert_chain(certfile=certfile, keyfile=keyfile)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"服务器证书和私钥加载成功。"</span>)</span><br><span class="line">    <span class="keyword">except</span> ssl.SSLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：加载证书/密钥失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"请确保证书 '<span class="subst">{certfile}</span>' 和密钥 '<span class="subst">{keyfile}</span>' 文件有效且格式正确。"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：找不到证书文件 '<span class="subst">{certfile}</span>' 或密钥文件 '<span class="subst">{keyfile}</span>'。"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 可选: 配置服务器端的 TLS 设置</span></span><br><span class="line">    <span class="comment"># context.minimum_version = ssl.TLSVersion.TLSv1_2</span></span><br><span class="line">    <span class="comment"># context.set_ciphers(...) # 定义允许的密码套件</span></span><br><span class="line">    <span class="comment"># context.options |= ssl.OP_NO_SSLv3 | ssl.OP_NO_TLSv1 | ssl.OP_NO_TLSv1_1 # 禁用不安全的旧协议</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 创建、绑定和监听普通 TCP 套接字</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        bindsocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        <span class="comment"># 设置 SO_REUSEADDR 选项，允许服务器快速重启并重新绑定到之前的地址</span></span><br><span class="line">        bindsocket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        server_address = (host, port)</span><br><span class="line">        bindsocket.bind(server_address)</span><br><span class="line">        bindsocket.listen(<span class="number">5</span>)  <span class="comment"># 设置连接队列大小</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"安全服务器启动，正在监听 <span class="subst">{server_address}</span>..."</span>)</span><br><span class="line">    <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：无法绑定或监听端口 <span class="subst">{port}</span>: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"端口可能已被占用，或者没有权限绑定到该地址。"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误：服务器套接字设置失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. 循环接受客户端连接</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\n等待新的客户端连接..."</span>)</span><br><span class="line">            <span class="comment"># 接受普通 TCP 连接</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                client_sock, client_addr = bindsocket.accept()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"接受来自 <span class="subst">{client_addr}</span> 的 TCP 连接。"</span>)</span><br><span class="line">            <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"警告：接受连接时出错: <span class="subst">{e}</span>。继续等待..."</span>)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># 发生错误，继续等待下一个连接</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 5. 包装客户端套接字为 SSLSocket</span></span><br><span class="line">            <span class="comment">#    - server_side=True: 表明这是服务器端包装。</span></span><br><span class="line">            <span class="comment">#    - do_handshake_on_connect=True (默认): 包装时自动执行 TLS 握手。</span></span><br><span class="line">            <span class="comment">#    * 踩坑点：TLS 握手可能失败（例如客户端不支持服务器的协议/密码套件，或证书问题）。</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                ssl_client_sock = context.wrap_socket(client_sock, server_side=<span class="literal">True</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"与 <span class="subst">{client_addr}</span> 的 TLS 握手成功。"</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 6. 为每个客户端连接创建一个新线程进行处理</span></span><br><span class="line">                <span class="comment">#    - 避免阻塞主循环，可以同时处理多个客户端。</span></span><br><span class="line">                <span class="comment">#    * 注意：对于高并发场景，线程模型可能不是最高效的，可考虑异步IO (asyncio)。</span></span><br><span class="line">                client_handler = threading.Thread(</span><br><span class="line">                    target=handle_secure_client,</span><br><span class="line">                    args=(ssl_client_sock, client_addr),</span><br><span class="line">                    daemon=<span class="literal">True</span>  <span class="comment"># 设置为守护线程，主线程退出时它们也会退出</span></span><br><span class="line">                )</span><br><span class="line">                client_handler.start()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> ssl.SSLError <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"错误：与 <span class="subst">{client_addr}</span> 的 TLS 握手失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                client_sock.close()  <span class="comment"># 握手失败，关闭原始 socket</span></span><br><span class="line">            <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:  <span class="comment"># 处理包装或握手期间可能的套接字错误</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"错误：在包装套接字或与 <span class="subst">{client_addr}</span> 握手期间发生错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                client_sock.close()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"错误：处理新连接 <span class="subst">{client_addr}</span> 时发生未知错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                client_sock.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n检测到 Ctrl+C，服务器正在关闭..."</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"\n服务器主循环发生意外错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 关闭监听套接字</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"关闭服务器监听套接字。"</span>)</span><br><span class="line">        bindsocket.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行服务器示例 (需要先生成 cert.pem 和 key.pem)</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    create_secure_tls_server() </span><br></pre></td></tr></tbody></table></figure><p><strong>如何测试服务器：</strong></p><ol><li>确保 <code>cert.pem</code> 和 <code>key.pem</code> 在同一目录。</li><li>运行包含 <code>create_secure_tls_server()</code> 的 Python 脚本。</li><li>打开浏览器，访问 <code>https://localhost:8443</code>。<ul><li><strong>你会看到一个安全警告！</strong> 这是因为浏览器不信任你的自签名证书（它不是由受信任的证书颁发机构 CA 签发的）。你需要手动选择“高级”或“继续前往”（具体措辞因浏览器而异）才能访问。</li><li>成功访问后，你应该能看到服务器返回的 HTML 页面。</li></ul></li><li>你也可以使用 <code>curl</code> 或修改上面的 <code>secure_tls_client_example</code> 连接到 <code>localhost:8443</code> 来测试。<ul><li>使用 <code>curl</code> 时，需要加上 <code>-k</code> 或 <code>--insecure</code> 选项来忽略证书验证：<code>curl -k https://localhost:8443</code></li><li>修改客户端连接 <code>localhost</code> 时，如果客户端默认验证证书，也会失败。你需要配置客户端信任你的自签名证书（高级）或暂时禁用验证（<strong>仅用于测试！</strong>）。</li></ul></li></ol><hr><h4 id="15-4-2-数据摘要与哈希函数-Hashing-：验证数据完整性"><a href="#15-4-2-数据摘要与哈希函数-Hashing-：验证数据完整性" class="headerlink" title="15.4.2 数据摘要与哈希函数 (Hashing)：验证数据完整性"></a>15.4.2 数据摘要与哈希函数 (Hashing)：验证数据完整性</h4><p>哈希函数（也称散列函数或摘要函数）是一种将任意长度的输入数据通过一个数学算法，转换成一个固定长度的输出（哈希值或摘要）的过程。</p><p><strong>核心特性：</strong></p><ul><li><strong>单向性 (One-way):</strong> 从哈希值几乎不可能反向推导出原始输入数据。</li><li><strong>确定性 (Deterministic):</strong> 相同的输入总是产生相同的输出哈希值。</li><li><strong>固定长度输出:</strong> 无论输入多大，输出的哈希值长度总是固定的（例如 SHA-256 输出总是 256 位）。</li><li><strong>抗碰撞性 (Collision Resistance):</strong><ul><li><strong>弱抗碰撞性:</strong> 给定一个输入 $ M_1 $ ，难以找到另一个输入 $ M_2 $ 使得 $ Hash(M_1) = Hash(M_2) $ 。</li><li><strong>强抗碰撞性:</strong> 难以找到任意两个不同的输入 $ M_1 $ 和 $ M_2 $ 使得 $ Hash(M_1) = Hash(M_2) $ 。</li></ul></li></ul><p><strong>主要应用场景：</strong></p><ol><li><strong>数据完整性校验:</strong> 计算文件的哈希值，传输或存储后再次计算哈希值进行比较，判断文件是否被篡改。例如，软件下载网站提供的 MD5/SHA 校验码。</li><li><strong>密码存储:</strong> 不直接存储用户密码明文，而是存储密码的哈希值（通常加盐处理）。用户登录时，计算输入密码的哈希值与存储的哈希值比较。</li><li><strong>数据索引/查找:</strong> 哈希表（如 Python 的字典 <code>dict</code>）使用哈希函数快速定位数据。</li><li><strong>数字签名:</strong> 对消息的哈希值进行签名，而非整个消息，提高效率。</li></ol><h5 id="Python-中的哈希支持：hashlib-模块"><a href="#Python-中的哈希支持：hashlib-模块" class="headerlink" title="Python 中的哈希支持：hashlib 模块"></a>Python 中的哈希支持：<code>hashlib</code> 模块</h5><p>Python 的内置 <code>hashlib</code> 模块提供了对多种安全哈希和消息摘要算法的接口，包括 MD5, SHA-1, SHA-2 系列 (SHA-224, SHA-256, SHA-384, SHA-512), 以及 SHA-3 系列和 BLAKE2 等。</p><h6 id="常用哈希算法对比与选择"><a href="#常用哈希算法对比与选择" class="headerlink" title="常用哈希算法对比与选择"></a>常用哈希算法对比与选择</h6><table><thead><tr><th align="left">算法</th><th align="left">输出长度 (位)</th><th align="left">安全性评估</th><th align="left">推荐场景</th><th align="left"><code>hashlib</code> 构造器</th></tr></thead><tbody><tr><td align="left"><strong>MD5</strong></td><td align="left">128</td><td align="left"><strong>不安全！</strong> 已发现严重碰撞漏洞，<strong>绝对禁止</strong> 用于安全目的。</td><td align="left"><strong>仅限</strong> 于非安全相关的文件校验和（例如检查下载是否完整）。</td><td align="left"><code>hashlib.md5()</code></td></tr><tr><td align="left"><strong>SHA-1</strong></td><td align="left">160</td><td align="left"><strong>不安全！</strong> 已被攻破，<strong>禁止</strong> 用于安全目的。</td><td align="left">遗留系统兼容（非常不推荐）。</td><td align="left"><code>hashlib.sha1()</code></td></tr><tr><td align="left"><strong>SHA-256</strong></td><td align="left">256</td><td align="left"><strong>当前安全标准。</strong> 广泛应用。</td><td align="left">数据完整性、密码存储（需加盐）、数字签名。</td><td align="left"><code>hashlib.sha256()</code></td></tr><tr><td align="left"><strong>SHA-512</strong></td><td align="left">512</td><td align="left"><strong>更安全。</strong> 在 64 位系统上可能更快。</td><td align="left">需要更高安全性的场景，性能要求不高时。</td><td align="left"><code>hashlib.sha512()</code></td></tr><tr><td align="left"><strong>SHA-3</strong></td><td align="left">可变</td><td align="left">NIST 标准，不同于 SHA-2 的内部结构，提供替代方案。</td><td align="left">新项目可选，尚未如 SHA-2 般普及。</td><td align="left"><code>hashlib.sha3_256()</code>, etc.</td></tr><tr><td align="left"><strong>BLAKE2</strong></td><td align="left">可变</td><td align="left">通常比 MD5, SHA-1, SHA-2, SHA-3 更快且同样安全。</td><td align="left">高性能哈希计算。</td><td align="left"><code>hashlib.blake2b()</code>, <code>blake2s()</code></td></tr></tbody></table><blockquote><p><strong>强烈建议</strong>：对于新的安全应用，<strong>至少使用 SHA-256</strong>。<strong>绝对避免使用 MD5 和 SHA-1</strong>。</p></blockquote><h6 id="示例-1：计算数据的哈希值"><a href="#示例-1：计算数据的哈希值" class="headerlink" title="示例 1：计算数据的哈希值"></a>示例 1：计算数据的哈希值</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_hashes</span>(<span class="params">data_bytes</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    计算给定字节数据的多种哈希值。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        data_bytes (bytes): 需要计算哈希的原始数据 (必须是 bytes 类型)。</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        dict: 包含不同算法哈希值 (十六进制字符串) 的字典。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(data_bytes, <span class="built_in">bytes</span>):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"输入数据必须是 bytes 类型"</span>)</span><br><span class="line">        </span><br><span class="line">    results = {}</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># --- MD5 (仅作演示，不推荐安全场景使用) ---</span></span><br><span class="line">    md5_hash = hashlib.md5()</span><br><span class="line">    md5_hash.update(data_bytes) <span class="comment"># 可以多次调用 update() 处理大文件分块</span></span><br><span class="line">    results[<span class="string">'MD5'</span>] = md5_hash.hexdigest() <span class="comment"># 获取十六进制表示的哈希值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- SHA-1 (仅作演示，不推荐安全场景使用) ---</span></span><br><span class="line">    sha1_hash = hashlib.sha1()</span><br><span class="line">    sha1_hash.update(data_bytes)</span><br><span class="line">    results[<span class="string">'SHA-1'</span>] = sha1_hash.hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- SHA-256 (推荐) ---</span></span><br><span class="line">    sha256_hash = hashlib.sha256()</span><br><span class="line">    sha256_hash.update(data_bytes)</span><br><span class="line">    results[<span class="string">'SHA-256'</span>] = sha256_hash.hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- SHA-512 (更强) ---</span></span><br><span class="line">    sha512_hash = hashlib.sha512()</span><br><span class="line">    sha512_hash.update(data_bytes)</span><br><span class="line">    results[<span class="string">'SHA-512'</span>] = sha512_hash.hexdigest()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 使用示例 ---</span></span><br><span class="line">message = <span class="string">"这是一个需要计算哈希值的示例文本。"</span></span><br><span class="line"><span class="comment"># 必须将字符串编码为字节串 (如 UTF-8)</span></span><br><span class="line">message_bytes = message.encode(<span class="string">'utf-8'</span>) </span><br><span class="line"></span><br><span class="line">hashes = calculate_hashes(message_bytes)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"原始消息: '<span class="subst">{message}</span>'"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"计算得到的哈希值:"</span>)</span><br><span class="line"><span class="keyword">for</span> algo, hash_value <span class="keyword">in</span> hashes.items():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  <span class="subst">{algo:&lt;<span class="number">8</span>}</span>: <span class="subst">{hash_value}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 演示对文件的哈希计算</span></span><br><span class="line"><span class="comment"># 假设当前目录有一个名为 'my_document.txt' 的文件</span></span><br><span class="line">file_path = <span class="string">'my_document.txt'</span> </span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">'wb'</span>) <span class="keyword">as</span> f: <span class="comment"># 创建一个示例文件</span></span><br><span class="line">         f.write(<span class="string">b"This is the content of the file.\n"</span>)</span><br><span class="line">         f.write(<span class="string">b"Hashing ensures data integrity.\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n计算文件 '<span class="subst">{file_path}</span>' 的 SHA-256 哈希值..."</span>)</span><br><span class="line">    file_sha256 = hashlib.sha256()</span><br><span class="line">    buffer_size = <span class="number">65536</span> <span class="comment"># 64KB 缓冲区，避免一次性加载大文件到内存</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f: <span class="comment"># 以二进制读取模式打开</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data_chunk = f.read(buffer_size)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data_chunk:</span><br><span class="line">                <span class="keyword">break</span> <span class="comment"># 文件读取完毕</span></span><br><span class="line">            file_sha256.update(data_chunk) <span class="comment"># 逐块更新哈希对象</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"文件 '<span class="subst">{file_path}</span>' 的 SHA-256: <span class="subst">{file_sha256.hexdigest()}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 清理示例文件</span></span><br><span class="line">    <span class="comment"># import os</span></span><br><span class="line">    <span class="comment"># os.remove(file_path) </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n错误：文件 '<span class="subst">{file_path}</span>' 未找到，跳过文件哈希示例。"</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">     <span class="built_in">print</span>(<span class="string">f"\n处理文件时出错: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="示例-2：安全的密码存储（加盐哈希）"><a href="#示例-2：安全的密码存储（加盐哈希）" class="headerlink" title="示例 2：安全的密码存储（加盐哈希）"></a>示例 2：安全的密码存储（加盐哈希）</h6><p>直接存储密码的哈希值是不够的，因为攻击者可以使用 <strong>彩虹表 (Rainbow Tables)</strong> —— 预先计算好的常见密码哈希值列表 —— 来快速破解。为了防御彩虹表攻击，我们需要为每个密码添加一个 <strong>随机盐 (Salt)</strong>，然后将密码和盐一起哈希。</p><p><strong>基本流程：</strong></p><ol><li><strong>注册时:</strong><ul><li>为新用户生成一个唯一的、随机的盐值 (Salt)。</li><li>将用户输入的密码和盐值拼接（或其他组合方式）。</li><li>使用安全的哈希算法（如 SHA-256）计算拼接后结果的哈希值。</li><li>将 <strong>盐值</strong> 和 <strong>哈希值</strong> 一起存储在数据库中（<strong>绝不能存储明文密码！</strong>）。</li></ul></li><li><strong>登录时:</strong><ul><li>根据用户名从数据库中取出对应的 <strong>盐值</strong> 和 <strong>存储的哈希值</strong>。</li><li>将用户输入的密码和取出的盐值以 <strong>相同的方式</strong> 拼接。</li><li>计算拼接后结果的哈希值。</li><li>将计算出的哈希值与数据库中存储的哈希值进行比较。如果相同，则密码正确。</li></ul></li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> os  <span class="comment"># 用于生成安全的随机盐</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_salt</span>(<span class="params">length: <span class="built_in">int</span> = <span class="number">16</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">"""生成一个指定长度的安全随机盐值 (bytes)。"""</span></span><br><span class="line">    <span class="keyword">return</span> os.urandom(length)  <span class="comment"># 使用操作系统提供的加密级随机源 # 一般来说盐可以选择写死，也可以选择动态生成</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hash_password</span>(<span class="params">password: <span class="built_in">str</span>, salt: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">"""使用 SHA-256 和给定的盐来哈希密码。"""</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(password, <span class="built_in">str</span>):</span><br><span class="line">        password = password.encode(<span class="string">'utf-8'</span>)  <span class="comment"># 确保密码是字节串</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(salt, <span class="built_in">bytes</span>):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"盐值必须是 bytes 类型"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将密码和盐组合 (简单拼接)</span></span><br><span class="line">    password_salt_combo = salt + password</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算哈希值</span></span><br><span class="line">    hashed_password = hashlib.sha256(password_salt_combo).digest()  <span class="comment"># 获取原始字节哈希值</span></span><br><span class="line">    <span class="keyword">return</span> hashed_password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_password</span>(<span class="params">stored_hash: <span class="built_in">bytes</span>, provided_password: <span class="built_in">str</span>, salt: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">"""验证提供的密码是否与存储的哈希值匹配 (使用相同的盐)。"""</span></span><br><span class="line">    <span class="comment"># 使用相同的盐和提供的密码计算哈希值</span></span><br><span class="line">    new_hash = hash_password(provided_password, salt)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用安全的方式比较哈希值 (避免时序攻击)</span></span><br><span class="line">    <span class="comment"># 某些Python版本中hashlib可能没有compare_digest，改用hmac模块中的方法</span></span><br><span class="line">    <span class="keyword">import</span> hmac</span><br><span class="line">    <span class="keyword">return</span> hmac.compare_digest(stored_hash, new_hash)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_user_login</span>(<span class="params">is_valid: <span class="built_in">bool</span></span>):</span><br><span class="line">    <span class="string">"""检查用户名和密码是否匹配。"""</span></span><br><span class="line">    <span class="keyword">if</span> is_valid:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"登录成功！密码匹配。"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"登录失败！密码错误。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># --- 模拟用户注册 ---</span></span><br><span class="line">    password_attempt = <span class="string">"Prorise@qq.com"</span></span><br><span class="line">    user_salt = generate_salt()  <span class="comment"># 为该用户生成唯一的盐</span></span><br><span class="line">    stored_password_hash = hash_password(password_attempt, user_salt)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"--- 模拟用户注册 ---"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"用户密码: <span class="subst">{password_attempt}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"生成的盐值 (hex): <span class="subst">{user_salt.<span class="built_in">hex</span>()}</span>"</span>)  <span class="comment"># 十六进制显示方便查看</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"存储的哈希值 (hex): <span class="subst">{stored_password_hash.<span class="built_in">hex</span>()}</span>"</span>)</span><br><span class="line">    <span class="comment"># 在实际应用中，你会将 user_salt 和 stored_password_hash 存储在数据库中</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 模拟用户登录 ---</span></span><br><span class="line">    login_password_attempt = <span class="string">"Prorise@qq.com"</span></span><br><span class="line">    <span class="comment"># 假设从数据库中获取了该用户的 salt 和 hash</span></span><br><span class="line">    retrieved_salt = user_salt</span><br><span class="line">    retrieved_hash = stored_password_hash</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n--- 模拟用户登录 ---"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"尝试登录密码: <span class="subst">{login_password_attempt}</span>"</span>)</span><br><span class="line">    is_valid = verify_password(retrieved_hash, login_password_attempt, retrieved_salt)</span><br><span class="line"></span><br><span class="line">    check_user_login(is_valid) <span class="comment"># 调用函数检查登录结果</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>进阶与替代方案</strong>：虽然上述加盐哈希比简单哈希好得多，但现代密码存储更推荐使用 <strong>专为密码哈希设计的算法</strong>，如 <strong>bcrypt</strong>, <strong>scrypt</strong>, <strong>Argon2</strong> (Argon2id 最佳)。这些算法是 <strong>计算密集型</strong> 的（可以调整工作因子），使得即使有盐，暴力破解的成本也极高。Python 中可以通过 <code>bcrypt</code> 库或 <code>argon2-cffi</code> 库使用它们。<code>hashlib</code> 也提供了 <code>pbkdf2_hmac</code>，它是一种密钥派生函数，也可用于密码哈希，允许配置迭代次数。</p></blockquote><h5 id="HMAC：带密钥的哈希，用于消息认证"><a href="#HMAC：带密钥的哈希，用于消息认证" class="headerlink" title="HMAC：带密钥的哈希，用于消息认证"></a>HMAC：带密钥的哈希，用于消息认证</h5><p>HMAC (Hash-based Message Authentication Code) 结合了哈希函数和一个 <strong>秘密密钥</strong>，用于同时验证 <strong>数据完整性</strong> 和 <strong>消息来源的真实性</strong>。</p><p><strong>工作原理</strong> (简化):</p><ol><li>发送方和接收方共享一个秘密密钥。</li><li>发送方使用该密钥和哈希函数（如 SHA-256）计算消息的 HMAC 值。</li><li>发送方将原始消息和计算出的 HMAC 值一起发送给接收方。</li><li>接收方使用 <strong>相同的密钥</strong> 和哈希函数，对收到的原始消息独立计算 HMAC 值。</li><li>接收方比较自己计算的 HMAC 值与收到的 HMAC 值。如果相同，则消息未被篡改，并且确实来自持有共享密钥的发送方。</li></ol><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">    K["共享密钥 K"] --&gt; S1["发送方\n计算 HMAC"]</span><br><span class="line">    S1 --&gt; S2["发送\n消息 + HMAC"]</span><br><span class="line">    S2 --&gt; R1["接收方\n收到 消息 + HMAC"]</span><br><span class="line">    R1 --&gt; R2["计算 HMAC'"]</span><br><span class="line">    R2 --&gt; C{"HMAC' == HMAC?"}</span><br><span class="line">    C -- 是 --&gt; OK["验证通过"]</span><br><span class="line">    C -- 否 --&gt; NG["验证失败"]</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>与普通哈希的区别：</strong></p><ul><li>普通哈希只能验证完整性（任何人都可以计算哈希），不能验证来源。</li><li>HMAC 因为需要秘密密钥，所以可以验证来源（只有持有密钥的人才能计算出正确的 HMAC）。</li></ul><p><strong>应用场景：</strong></p><ul><li>确保 API 请求未被篡改且来自合法客户端。</li><li>验证 Webhook 请求的来源。</li><li>安全协议中的消息认证。</li></ul><h5 id="Python-中的-HMAC-支持：hmac-模块"><a href="#Python-中的-HMAC-支持：hmac-模块" class="headerlink" title="Python 中的 HMAC 支持：hmac 模块"></a>Python 中的 HMAC 支持：<code>hmac</code> 模块</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_hmac</span>(<span class="params">key, message</span>):</span><br><span class="line">    <span class="string">"""使用 SHA-256 和给定密钥计算消息的 HMAC。"""</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(key, <span class="built_in">str</span>):</span><br><span class="line">        key = key.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(message, <span class="built_in">str</span>):</span><br><span class="line">        message = message.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 创建 hmac 对象，需要密钥、消息和摘要算法 (例如 hashlib.sha256)</span></span><br><span class="line">    h = hmac.new(key, message, hashlib.sha256)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 返回十六进制表示的 HMAC 值</span></span><br><span class="line">    <span class="keyword">return</span> h.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_hmac</span>(<span class="params">key, message, received_hmac_hex</span>):</span><br><span class="line">    <span class="string">"""验证接收到的 HMAC 是否与基于密钥和消息计算出的 HMAC 匹配。"""</span></span><br><span class="line">    <span class="comment"># 重新计算 HMAC</span></span><br><span class="line">    calculated_hmac_hex = generate_hmac(key, message)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用 hmac.compare_digest 进行安全比较 (防止时序攻击)</span></span><br><span class="line">    <span class="keyword">return</span> hmac.compare_digest(calculated_hmac_hex, received_hmac_hex)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 共享的秘密密钥 (必须保密！) ---</span></span><br><span class="line">shared_secret_key = <span class="string">"my-super-secret-and-long-key"</span> <span class="comment"># 实际应用中应使用更随机、更长的密钥</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 发送方 ---</span></span><br><span class="line">message_to_send = <span class="string">"This is an important message that needs authentication."</span></span><br><span class="line">hmac_generated = generate_hmac(shared_secret_key, message_to_send)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"--- 发送方 ---"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"消息: <span class="subst">{message_to_send}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"密钥: <span class="subst">{shared_secret_key}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"生成的 HMAC (SHA-256): <span class="subst">{hmac_generated}</span>"</span>)</span><br><span class="line"><span class="comment"># 发送方将 message_to_send 和 hmac_generated 发送给接收方</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 接收方 ---</span></span><br><span class="line">received_message = <span class="string">"This is an important message that needs authentication."</span></span><br><span class="line">received_hmac = hmac_generated </span><br><span class="line"><span class="comment"># 假设接收方也知道 shared_secret_key</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n--- 接收方 ---"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"收到的消息: <span class="subst">{received_message}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"收到的 HMAC: <span class="subst">{received_hmac}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"使用的密钥: <span class="subst">{shared_secret_key}</span>"</span>)</span><br><span class="line"></span><br><span class="line">is_authentic = verify_hmac(shared_secret_key, received_message, received_hmac)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> is_authentic:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"消息验证成功！数据完整且来源可信。"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"消息验证失败！数据可能被篡改或来源不可信。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 模拟篡改 ---</span></span><br><span class="line">tampered_message = <span class="string">"This is an important message that has been TAMPERED!!!"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"\n--- 模拟篡改 ---"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"篡改后的消息: <span class="subst">{tampered_message}</span>"</span>)</span><br><span class="line">is_tampered_authentic = verify_hmac(shared_secret_key, tampered_message, received_hmac) <span class="comment"># 使用原始 HMAC</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> is_tampered_authentic:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"篡改后的消息验证失败 (预期结果)。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 模拟使用错误密钥 ---</span></span><br><span class="line">wrong_key = <span class="string">"another-key"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"\n--- 模拟错误密钥 ---"</span>)</span><br><span class="line">is_wrong_key_authentic = verify_hmac(wrong_key, received_message, received_hmac) <span class="comment"># 使用原始消息和 HMAC，但密钥错误</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> is_wrong_key_authentic:</span><br><span class="line">     <span class="built_in">print</span>(<span class="string">"使用错误密钥验证失败 (预期结果)。"</span>)</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>踩坑点：</strong> HMAC 的安全性 <strong>严重依赖于密钥的保密性</strong>。如果密钥泄露，HMAC 就失去了验证来源的作用。密钥管理是使用 HMAC 的关键挑战。</p></blockquote><hr><h4 id="15-4-3-数据编码-Data-Encoding-：安全传输的变形术"><a href="#15-4-3-数据编码-Data-Encoding-：安全传输的变形术" class="headerlink" title="15.4.3 数据编码 (Data Encoding)：安全传输的变形术"></a>15.4.3 数据编码 (Data Encoding)：安全传输的变形术</h4><p>在深入探讨“加密”以保护数据机密性之前，我们先来理解一个相关但不同的概念——<strong>编码 (Encoding)</strong>。</p><p><strong>编码 vs. 加密：核心区别</strong></p><ul><li><strong>目的不同:</strong><ul><li><strong>编码</strong>：主要目的是 <strong>转换数据格式</strong>，使其适应特定的传输协议、存储系统或媒介，确保数据能够被正确、无损地处理。它 <strong>不提供保密性</strong>。</li><li><strong>加密</strong>：主要目的是 <strong>保护数据内容</strong>，防止未经授权的访问（保密性）。它通常还需要保证数据的完整性和来源真实性。</li></ul></li><li><strong>可逆性与密钥:</strong><ul><li><strong>编码</strong>：算法是 <strong>公开</strong> 的，过程通常是 <strong>完全可逆</strong> 的，<strong>不需要密钥</strong>。知道编码算法就能解码。</li><li><strong>加密</strong>：算法可以是公开的，但必须使用 <strong>密钥</strong>。只有持有正确密钥的人才能解密。</li></ul></li></ul><p>简单来说，编码是为了让数据“说”目标系统能听懂的“语言”，而加密是为了让数据“说”只有授权者能听懂的“密语”。</p><p>本节我们重点介绍两种在网络开发中极其常见的编码方式：Base64 和 URL 编码。</p><h5 id="Base64-编码："><a href="#Base64-编码：" class="headerlink" title="Base64 编码："></a>Base64 编码：</h5><p><strong>为什么需要 Base64？</strong></p><p>想象一下，你想在一段 JSON 数据（纯文本格式）中包含一张小图片（二进制数据），或者通过电子邮件发送一个程序文件。很多基于文本的协议或格式无法直接处理原始的二进制字节流，因为：</p><ol><li>二进制数据可能包含 <strong>控制字符</strong>（如 NULL 字节 <code>\x00</code>），这些字符在某些文本处理系统中可能有特殊含义或导致截断。</li><li>文本协议通常基于特定的 <strong>字符集</strong>（如 ASCII, UTF-8），直接嵌入任意二进制数据可能导致解析错误。</li></ol><p>Base64 就是为了解决这个问题而设计的。它定义了一种方法，可以将 <strong>任何二进制数据</strong> 映射为仅包含 <strong><code>64</code></strong> 个安全、可打印的 ASCII 字符的序列。</p><p><strong>字符集：</strong></p><ul><li><code>A-Z</code> (26 个)</li><li><code>a-z</code> (26 个)</li><li><code>0-9</code> (10 个)</li><li><code>+</code> (加号)</li><li><code>/</code> (斜杠)</li></ul><p>总计 62 个。另外还有用于填充的 <code>=</code> 字符。第 63 和 64 个字符 (<code>+</code>, <code>/</code>) 在某些场景（如 URL 或文件名）中不安全，因此存在一个 <strong>URL 安全的 Base64 变种</strong>，它使用 <code>-</code> (减号) 替换 <code>+</code>，使用 <code>_</code> (下划线) 替换 <code>/</code>。</p><p><strong>工作原理简述：</strong></p><p>Base64 将输入的二进制数据按 <strong>每 3 个字节</strong> (24 位) 分组，然后将这 24 位再拆分成 <strong>4 个 6 位</strong> 的单元。每个 6 位的单元可以表示 $ 2^6 = 64 $ 个不同的值，正好对应 Base64 字符集中的一个字符。如果原始数据字节数不是 3 的倍数，会在末尾进行 <strong>填充 (Padding)</strong>，通常用 <code>=</code> 字符表示填充了多少字节。</p><p><strong>应用场景：</strong></p><ul><li><strong>嵌入数据：</strong> 在 JSON, XML, YAML 等文本格式中嵌入二进制内容。</li><li><strong>Data URLs：</strong> 在 HTML 或 CSS 中直接嵌入小型资源（如图片、字体），格式为 <code>data:[&lt;mediatype&gt;][;base64],&lt;data&gt;</code>。例如 <code>data:image/png;base64,iVBORw0KGgo...</code>。</li><li><strong>邮件传输 (MIME)：</strong> 编码邮件附件。</li><li><strong>HTTP Basic Authentication：</strong> 将 <code>username:password</code> 字符串进行 Base64 编码后放入 <code>Authorization</code> 请求头。</li><li><strong>证书文件：</strong> PEM 格式的证书文件（如 <code>.crt</code>, <code>.pem</code>）中间的内容就是 Base64 编码的二进制证书数据 (DER 格式)。</li></ul><p><strong>安全警示：Base64 ≠ 加密！</strong></p><blockquote><p><strong>这是最重要的提醒！</strong> Base64 编码是完全公开、可逆的转换。任何知道数据是 Base64 编码的人都可以轻松地将其解码回原始二进制内容。<strong>绝对不能用 Base64 来“隐藏”或“保护”任何敏感信息，如密码、私钥、API Key 等。</strong> 它仅仅是一种格式转换工具，不提供任何机密性保障。</p></blockquote><p><strong>Python 中的 Base64 支持：<code>base64</code> 模块</strong></p><p>Python 内置的 <code>base64</code> 模块提供了方便的函数来进行标准 Base64 和 URL 安全 Base64 的编解码。</p><p><strong>核心函数：</strong></p><table><thead><tr><th align="left">函数</th><th align="left">描述</th><th align="left">输入类型</th><th align="left">输出类型</th><th align="left">注意事项</th></tr></thead><tbody><tr><td align="left"><code>base64.b64encode(s)</code></td><td align="left">对字节串 <code>s</code> 进行标准 Base64 编码。</td><td align="left"><code>bytes</code></td><td align="left"><code>bytes</code></td><td align="left"></td></tr><tr><td align="left"><code>base64.b64decode(s)</code></td><td align="left">对标准 Base64 编码的字节串 <code>s</code> 进行解码。</td><td align="left"><code>bytes</code></td><td align="left"><code>bytes</code></td><td align="left">输入 <code>s</code> 必须是有效的 Base64 格式，否则抛异常</td></tr><tr><td align="left"><code>base64.urlsafe_b64encode(s)</code></td><td align="left">对字节串 <code>s</code> 进行 URL 安全的 Base64 编码。</td><td align="left"><code>bytes</code></td><td align="left"><code>bytes</code></td><td align="left">使用 <code>-</code> 和 <code>_</code> 替代 <code>+</code> 和 <code>/</code></td></tr><tr><td align="left"><code>base64.urlsafe_b64decode(s)</code></td><td align="left">对 URL 安全的 Base64 编码的字节串 <code>s</code> 进行解码。</td><td align="left"><code>bytes</code></td><td align="left"><code>bytes</code></td><td align="left"></td></tr></tbody></table><p><strong>代码示例：</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原始数据</span></span><br><span class="line">data = <span class="string">"Hello, World!"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编码</span></span><br><span class="line">encoded_data = base64.b64encode(data.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Encoded data:"</span>, encoded_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解码</span></span><br><span class="line">decoded_data = base64.b64decode(encoded_data).decode(<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Decoded data:"</span>, decoded_data)</span><br></pre></td></tr></tbody></table></figure><h5 id="URL-编码-Percent-Encoding-："><a href="#URL-编码-Percent-Encoding-：" class="headerlink" title="URL 编码 (Percent-Encoding)："></a>URL 编码 (Percent-Encoding)：</h5><p><strong>为什么需要 URL 编码？</strong></p><p>URL 的设计有着严格的字符限制。根据 RFC 3986 标准：</p><ul><li><strong>允许的字符:</strong> 字母 (<code>A-Z</code>, <code>a-z</code>)、数字 (<code>0-9</code>) 以及 <code>-</code>, <code>.</code>, <code>_</code>, <code>~</code> 这些字符可以直接出现在 URL 中，不需要编码。</li><li><strong>保留字符 (Reserved Characters):</strong> <code>: / ? # [ ] @ ! $ &amp; ' ( ) * + , ; =</code> 这些字符在 URL 中有特殊的语法含义（例如 <code>:</code> 分隔协议和主机，<code>/</code> 分隔路径段，<code>?</code> 分隔路径和查询，<code>&amp;</code> 分隔查询参数等）。如果想在路径或查询参数值中 <strong>表示这些字符本身</strong>，而不是它们的特殊含义，就必须进行编码。</li><li><strong>不安全字符:</strong> 空格、引号、<code>&lt;</code>, <code>&gt;</code>, <code>{</code>, <code>}</code>, <code>|</code>, <code>\</code>, <code>^</code>, <code>`</code> 等字符，以及所有 ASCII 控制字符和非 ASCII 字符，都 <strong>不允许</strong> 直接出现在 URL 中，必须进行编码。</li></ul><p>URL 编码（或称百分号编码）就是将这些需要编码的字符表示为其 UTF-8 (或其他指定编码) 字节序列的 <code>%XX</code> 形式，其中 <code>XX</code> 是该字节的两位十六进制表示。</p><p><strong>应用场景：</strong></p><ul><li><strong>构建 URL 查询字符串:</strong> 当你需要将用户输入或其他动态数据放入 URL 的查询参数时，必须对这些数据进行编码，以防特殊字符破坏 URL 结构或引起歧义。</li><li><strong>HTML 表单提交:</strong> 当浏览器以 <code>application/x-www-form-urlencoded</code> 方式提交表单时，会对表单字段名和值进行 URL 编码。</li><li><strong>路径中包含特殊字符:</strong> 虽然不太常见，但如果 URL 路径段本身需要包含保留字符（如 <code>/</code>），也需要编码。</li></ul><p><strong>Python 中的 URL 编码支持：<code>urllib.parse</code> 模块</strong></p><p><code>urllib.parse</code> 模块提供了处理 URL 各部分的函数，包括编码和解码。</p><p><strong>核心函数：</strong></p><table><thead><tr><th align="left">函数</th><th align="left">描述</th><th align="left">对空格的处理</th><th align="left">适用场景 (一般)</th></tr></thead><tbody><tr><td align="left"><code>urllib.parse.quote(string, safe='/')</code></td><td align="left">对字符串进行 URL 编码。默认情况下，<code>/</code> 字符 <strong>不会</strong> 被编码 (因为常用于路径)。可以传入 <code>safe</code> 参数指定哪些字符不编码。</td><td align="left">编码为 <code>%20</code></td><td align="left">URL 路径 (Path) 部分</td></tr><tr><td align="left"><code>urllib.parse.unquote(string)</code></td><td align="left">对 URL 编码的字符串进行解码。</td><td align="left"><code>%20</code> 解码为空格</td><td align="left">解码路径或查询部分</td></tr><tr><td align="left"><code>urllib.parse.quote_plus(string)</code></td><td align="left">类似于 <code>quote</code>，但 <strong>默认会将空格编码为 <code>+</code> 号</strong>。它不接受 <code>safe</code> 参数，所有保留字符都会编码（除了 <code>-._~</code>）。</td><td align="left">编码为 <code>+</code></td><td align="left">URL 查询 (Query) 部分</td></tr><tr><td align="left"><code>urllib.parse.unquote_plus(string)</code></td><td align="left">类似于 <code>unquote</code>，但会将 <code>+</code> 号解码为空格。</td><td align="left"><code>+</code> 解码为空格</td><td align="left">解码查询部分</td></tr><tr><td align="left"><code>urllib.parse.urlencode(query)</code></td><td align="left">接收一个字典或 (key, value) 对列表，将其编码成 URL 查询字符串 (如 <code>key1=value1&amp;key2=value2</code>)。默认使用 <code>quote_plus</code> 对键和值进行编码。</td><td align="left">内部使用 <code>quote_plus</code></td><td align="left">方便地构建整个查询字符串</td></tr></tbody></table><p><strong>代码示例：</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote, unquote, quote_plus, unquote_plus, urlencode, parse_qs</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 场景 1: 对路径部分进行编码 ---</span></span><br><span class="line"><span class="comment"># 假设文件名包含特殊字符</span></span><br><span class="line">file_name = <span class="string">"report for Q1/2025&amp;draft.pdf"</span></span><br><span class="line"><span class="comment"># 我们希望在 URL 路径中使用它，但要保留 '/' 作为路径分隔符</span></span><br><span class="line">encoded_path_segment = quote(file_name, safe=<span class="string">''</span>) <span class="comment"># safe='' 表示对所有保留字符都编码</span></span><br><span class="line"><span class="comment"># 注意：上面的做法会把 / 也编码为 %2F，如果想保留 /，应该用默认的 safe='/'</span></span><br><span class="line">encoded_path_segment_keep_slash = quote(file_name) <span class="comment"># 默认 safe='/'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"--- 对路径编码 ---"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"原始文件名: '<span class="subst">{file_name}</span>'"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"编码 (safe=''): <span class="subst">{encoded_path_segment}</span>"</span>) <span class="comment"># report%20for%20Q1%2F2025%26draft.pdf</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"编码 (默认 safe='/'): <span class="subst">{encoded_path_segment_keep_slash}</span>"</span>) <span class="comment"># report%20for%20Q1/2025%26draft.pdf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解码</span></span><br><span class="line">decoded_path = unquote(encoded_path_segment_keep_slash)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"解码后: '<span class="subst">{decoded_path}</span>'"</span>)</span><br><span class="line"><span class="keyword">assert</span> decoded_path == file_name</span><br><span class="line"><span class="comment">#============================================================================================================================</span></span><br><span class="line"><span class="comment"># --- 场景 2: 对查询参数值进行编码 ---</span></span><br><span class="line">param_value = <span class="string">"搜索: Python &amp; C++ ?"</span></span><br><span class="line"><span class="comment"># 使用 quote_plus 编码查询参数值</span></span><br><span class="line">encoded_query_value = quote_plus(param_value)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n--- 对查询参数编码 ---"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"原始参数值: '<span class="subst">{param_value}</span>'"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"quote_plus 编码后: <span class="subst">{encoded_query_value}</span>"</span>) <span class="comment"># %E6%90%9C%E7%B4%A2%3A+Python+%26+C%2B%2B+%3F</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解码</span></span><br><span class="line">decoded_query_value = unquote_plus(encoded_query_value)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"unquote_plus 解码后: '<span class="subst">{decoded_query_value}</span>'"</span>)</span><br><span class="line"><span class="keyword">assert</span> decoded_query_value == param_value</span><br><span class="line"><span class="comment">#============================================================================================================================</span></span><br><span class="line"><span class="comment"># --- 场景 3: 使用 urlencode 构建完整查询字符串 ---</span></span><br><span class="line">params = {</span><br><span class="line">    <span class="string">'query'</span>: <span class="string">'网络安全 &amp; 加密'</span>, <span class="comment"># 包含特殊字符</span></span><br><span class="line">    <span class="string">'lang'</span>: <span class="string">'zh-cn'</span>,</span><br><span class="line">    <span class="string">'results per page'</span>: <span class="number">10</span> <span class="comment"># key 也包含空格</span></span><br><span class="line">}</span><br><span class="line"><span class="comment"># urlencode 会自动处理字典，并使用 quote_plus</span></span><br><span class="line">query_string = urlencode(params)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"\n--- 使用 urlencode 构建查询字符串 ---"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"参数字典: <span class="subst">{params}</span>"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"生成的查询字符串: <span class="subst">{query_string}</span>"</span>) </span><br><span class="line"><span class="comment"># 输出: query=%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8+%26+%E5%8A%A0%E5%AF%86&amp;lang=zh-cn&amp;results+per+page=10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟服务器端解析 (常用 Web 框架会自动完成)</span></span><br><span class="line">parsed_params = parse_qs(query_string) <span class="comment"># parse_qs 会自动 unquote_plus</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"服务器端解析结果: <span class="subst">{parsed_params}</span>"</span>)</span><br><span class="line"><span class="comment"># 输出: {'query': ['网络安全 &amp; 加密'], 'lang': ['zh-cn'], 'results per page': ['10']}</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建完整 URL</span></span><br><span class="line">base_url = <span class="string">"https://example.com/search"</span></span><br><span class="line">full_url = <span class="string">f"<span class="subst">{base_url}</span>?<span class="subst">{query_string}</span>"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"最终 URL: <span class="subst">{full_url}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><hr><h3 id="15-4-4-对称加密-Symmetric-Encryption-：共享同一把钥匙的保险箱"><a href="#15-4-4-对称加密-Symmetric-Encryption-：共享同一把钥匙的保险箱" class="headerlink" title="15.4.4 对称加密 (Symmetric Encryption)：共享同一把钥匙的保险箱"></a>15.4.4 对称加密 (Symmetric Encryption)：共享同一把钥匙的保险箱</h3><p>对称加密，顾名思义，就是指在<strong>加密</strong>（将明文数据转换为不可读的密文）和<strong>解密</strong>（将密文还原为明文）这两个过程中，使用<strong>完全相同的密钥 (Secret Key)</strong>。</p><p><strong>核心思想与流程：</strong></p><p>可以把它想象成一个保险箱和一把物理钥匙：</p><ol><li><strong>共享钥匙：</strong> 发送方 Alice 和接收方 Bob 必须在通信开始前，通过某种<strong>安全</strong>的方式获得并保管好<strong>同一把</strong>钥匙 $ K $ 。</li><li><strong>锁上（加密）：</strong> Alice 使用钥匙 $ K $ 锁上保险箱（使用对称加密算法和密钥 $ K $ 对明文 $ P $ 进行加密，得到密文 $ C $ ）。</li><li><strong>运输：</strong> Alice 将锁上的保险箱（密文 $ C $ ）通过普通快递（不安全的网络）发送给 Bob。</li><li><strong>打开（解密）：</strong> Bob 收到保险箱后，使用他手中那把<strong>相同的钥匙 $ K $</strong> 打开保险箱（使用相同的对称解密算法和密钥 $ K $ 对密文 $ C $ 进行解密，恢复出明文 $ P $ ）。</li></ol><p><strong>优点：</strong></p><ul><li><strong>速度快：</strong> 计算效率高，适合加密大量数据。</li></ul><p><strong>缺点：</strong></p><ul><li><strong>密钥分发困难：</strong> 如何安全地共享密钥是核心难题。</li><li><strong>密钥管理复杂：</strong> 密钥的生成、存储、分发、轮换、销毁等环节都需要极其小心。</li></ul><h4 id="DES-和-3DES-Data-Encryption-Standard-：昔日标准，【绝对避免】"><a href="#DES-和-3DES-Data-Encryption-Standard-：昔日标准，【绝对避免】" class="headerlink" title="DES 和 3DES (Data Encryption Standard)：昔日标准，【绝对避免】"></a>DES 和 3DES (Data Encryption Standard)：昔日标准，【绝对避免】</h4><ul><li><strong>DES:</strong> 56 位密钥，<strong>极其不安全</strong>，已被完全破解。<strong>禁止使用！</strong></li><li><strong>3DES:</strong> DES 的改良版，速度慢，分组大小有缺陷，也被认为<strong>过时且不安全</strong>。<strong>禁止在新系统中使用！</strong></li></ul><blockquote><p><strong>核心建议：</strong> 彻底忘记 DES 和 3DES，它们在现代密码学中没有位置。</p></blockquote><h4 id="AES-Advanced-Encryption-Standard-：现代对称加密的基石"><a href="#AES-Advanced-Encryption-Standard-：现代对称加密的基石" class="headerlink" title="AES (Advanced Encryption Standard)：现代对称加密的基石"></a>AES (Advanced Encryption Standard)：现代对称加密的基石</h4><p>AES (高级加密标准)，算法原名 Rijndael，是当前<strong>最广泛使用、最受信任</strong>的对称加密<strong>行业标准</strong>。</p><ul><li><strong>分组大小 (Block Size):</strong> 固定为 <strong>128 位 (16 字节)</strong>。</li><li><strong>密钥长度 (Key Length):</strong> 支持 <strong>128 位、192 位、256 位</strong>。<ul><li><code>AES-128</code>: 速度最快，安全性足够应对当前绝大多数场景。</li><li><code>AES-192</code>: 安全性更高。</li><li><code>AES-256</code>: 目前最高安全级别，用于长期或极高安全要求。</li></ul></li><li><strong>安全性：</strong> 算法本身极为健壮，安全性依赖于<strong>密钥保密</strong>和<strong>正确的使用方式（操作模式与 IV/Nonce 管理）</strong>。</li></ul><h4 id="15-4-4-1-AES-块加密操作模式-【使用-AES-的关键！】"><a href="#15-4-4-1-AES-块加密操作模式-【使用-AES-的关键！】" class="headerlink" title="15.4.4.1 AES 块加密操作模式 - 【使用 AES 的关键！】"></a>15.4.4.1 AES 块加密操作模式 - 【使用 AES 的关键！】</h4><p>AES 本身一次只能处理 128 位的数据块。要加密更长的数据，必须采用一种<strong>操作模式</strong>来定义如何链接这些块的加密过程。<strong>错误的选择或使用模式将彻底摧毁 AES 的安全性！</strong></p><h5 id="ECB-Electronic-Codebook-模式：【极其危险，禁止使用！】"><a href="#ECB-Electronic-Codebook-模式：【极其危险，禁止使用！】" class="headerlink" title="ECB (Electronic Codebook) 模式：【极其危险，禁止使用！】"></a><code>ECB (Electronic Codebook)</code>模式：【极其危险，禁止使用！】</h5><ul><li><strong>原理：</strong> 每个 128 位明文块都使用相同的密钥独立加密。</li><li><strong>致命缺陷：</strong> <strong>相同的明文块产生相同的密文块！</strong> 这会暴露数据的内在模式。想象一下加密一张图片，相同颜色的区域加密后依然会呈现出相同的“加密”色块，导致图片轮廓可见。</li><li><strong>结论：绝对不要使用 ECB 模式进行任何需要保密的加密！</strong></li></ul><h5 id="CBC-Cipher-Block-Chaining-模式：【常用，需正确管理-IV】"><a href="#CBC-Cipher-Block-Chaining-模式：【常用，需正确管理-IV】" class="headerlink" title="CBC (Cipher Block Chaining) 模式：【常用，需正确管理 IV】"></a><code>CBC (Cipher Block Chaining)</code>模式：【常用，需正确管理 IV】</h5><ul><li><strong>原理：</strong> 在加密当前明文块前，先将其与<strong>前一个密文块</strong>进行异或 (XOR)。第一个明文块与一个<strong>初始化向量 (IV)</strong> 进行异或。</li><li><strong>IV (Initialization Vector):</strong><ul><li><strong>必须随机且唯一：</strong> 对于使用<strong>相同密钥</strong>的每一次加密操作，<strong>必须生成一个新的、随机的、不可预测的 IV</strong>。重复使用 IV 会严重破坏安全性。</li><li><strong>无需保密：</strong> IV 可以公开传输，通常放在密文的前面。解密时需要使用这个 IV。</li></ul></li><li><strong>填充 (Padding):</strong> 由于 CBC 要求明文是块大小（16 字节）的整数倍，如果原始数据长度不足，需要在最后一个块尾部填充字节。解密后需要移除填充。</li><li><strong>优点：</strong> 隐藏了明文模式（相同明文块在不同位置密文不同）。</li><li><strong>缺点：</strong><ul><li>加密过程是<strong>串行</strong>的，不能并行化。</li><li><strong>不提供内置的完整性/认证保护</strong>：仅仅是加密。攻击者可能在不知道密钥的情况下篡改密文（例如比特翻转攻击），导致解密出损坏或被恶意修改的数据，而接收方可能无法察觉（除非结合 MAC）。</li></ul></li><li><strong>适用场景：</strong> 过去广泛用于文件和数据库加密，但现在更推荐使用 GCM 等认证加密模式。</li></ul><h5 id="GCM-Galois-Counter-Mode-模式：【强烈推荐，认证加密】"><a href="#GCM-Galois-Counter-Mode-模式：【强烈推荐，认证加密】" class="headerlink" title="GCM (Galois/Counter Mode) 模式：【强烈推荐，认证加密】"></a><code>GCM (Galois/Counter Mode)</code> 模式：【强烈推荐，认证加密】</h5><ul><li><strong>原理：</strong> GCM 是一种<strong>认证加密</strong>模式 (AEAD - Authenticated Encryption with Associated Data)。它不仅提供<strong>数据机密性</strong>（加密），还同时提供<strong>数据完整性</strong>和<strong>来源真实性</strong>（认证），类似于将加密（如 CTR 模式）和消息认证码（如 GMAC）高效地结合在一起。</li><li><strong>Nonce (Number used once):</strong><ul><li><strong>必须唯一：</strong> 对于使用<strong>相同密钥</strong>的每一次加密操作，<strong>必须使用唯一的 Nonce</strong>。Nonce 的长度通常推荐为 96 位 (12 字节)。<strong>重复使用 Nonce 会导致灾难性的安全问题，可能暴露密钥！</strong></li><li><strong>无需保密：</strong> Nonce 通常与密文一起传输。</li></ul></li><li><strong>AAD (Associated Authenticated Data):</strong><ul><li>可以包含<strong>附加的、不需要加密但需要保护其完整性</strong>的数据（例如，消息头、元数据、协议版本号等）。AAD 会参与认证标签的计算。</li></ul></li><li><strong>认证标签 (Authentication Tag):</strong><ul><li>GCM 在加密结束后会生成一个固定长度（通常 128 位/16 字节）的认证标签。</li><li>这个标签<strong>必须</strong>与密文、Nonce（以及 AAD，如果使用的话）一起传输。</li><li>解密时，接收方不仅需要密钥、Nonce、密文，还需要这个标签。解密过程会重新计算标签并与收到的标签比较。<strong>只有标签匹配，解密才会成功</strong>，这证明了数据在传输中未被篡改，并且确实是由持有相同密钥和 Nonce 的发送方生成的。</li></ul></li><li><strong>优点：</strong><ul><li><strong>一体化安全：</strong> 同时解决机密性、完整性、真实性。</li><li><strong>高性能：</strong> 加密和解密的核心操作（基于 CTR 模式）可以并行化。</li><li><strong>通常无需填充。</strong></li></ul></li><li><strong>缺点：</strong><ul><li>实现相对复杂一些（但好的库如 <code>cryptography</code> 会封装好）。</li><li><strong>对 Nonce 的唯一性要求极高，是使用的关键安全点。</strong></li></ul></li><li><strong>适用场景：</strong> <strong>现代安全通信（如 TLS 1.2/1.3）、网络协议、需要高保障的数据加密等的首选模式。</strong></li></ul><h5 id="其他模式"><a href="#其他模式" class="headerlink" title="其他模式"></a>其他模式</h5><ul><li><strong>CTR (Counter Mode):</strong> 将计数器加密后与明文异或。可并行、无需填充。常作为 GCM 的基础。本身不提供认证。</li><li>CFB (Cipher Feedback), OFB (Output Feedback): 也是流式处理模式，各有特点，相对 GCM/CTR 使用较少。</li></ul><h4 id="15-4-4-2-Python-实现-AES-加密-使用-cryptography-库"><a href="#15-4-4-2-Python-实现-AES-加密-使用-cryptography-库" class="headerlink" title="15.4.4.2 Python 实现 AES 加密 (使用 cryptography 库)"></a>15.4.4.2 Python 实现 AES 加密 (使用 <code>cryptography</code> 库)</h4><p>Python 标准库不直接提供易用的 AES 功能。强烈推荐使用现代、维护良好且功能强大的 <code>cryptography</code> 库。</p><p><strong>安装:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install cryptography</span><br></pre></td></tr></tbody></table></figure><h5 id="示例-1：使用-AES-GCM-推荐模式"><a href="#示例-1：使用-AES-GCM-推荐模式" class="headerlink" title="示例 1：使用 AES-GCM (推荐模式)"></a>示例 1：使用 AES-GCM (推荐模式)</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> Cipher, algorithms, modes</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">from</span> cryptography.exceptions <span class="keyword">import</span> InvalidTag  <span class="comment"># 用于捕获 GCM 验证失败</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 辅助函数 ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_aes_key</span>(<span class="params">key_size: <span class="built_in">int</span> = <span class="number">256</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">"""生成指定位数的随机 AES 密钥 (bytes)"""</span></span><br><span class="line">    <span class="keyword">if</span> key_size <span class="keyword">not</span> <span class="keyword">in</span> [<span class="number">128</span>, <span class="number">192</span>, <span class="number">256</span>]:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"密钥大小必须是128, 192 or 256位"</span>)</span><br><span class="line">    <span class="comment"># 返回随机字节串</span></span><br><span class="line">    <span class="comment"># 这里 // 8 是为了将比特(bit)转换为字节(byte)</span></span><br><span class="line">    <span class="comment"># 因为密钥大小(key_size)是以比特为单位的(如128位、256位)</span></span><br><span class="line">    <span class="comment"># 而os.urandom()函数需要的参数是字节数</span></span><br><span class="line">    <span class="comment"># 1字节 = 8比特，所以需要用key_size除以8来得到对应的字节数</span></span><br><span class="line">    <span class="comment"># 例如：128位密钥需要128/8=16字节的随机数据</span></span><br><span class="line">    <span class="keyword">return</span> os.urandom(key_size // <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_nonce</span>(<span class="params">nonce_size: <span class="built_in">int</span> = <span class="number">12</span></span>):</span><br><span class="line">    <span class="string">"""生成指定字节数的随机 Nonce (bytes)，GCM 推荐 12 字节 (96 位)。"""</span></span><br><span class="line">    <span class="keyword">return</span> os.urandom(nonce_size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ensure_bytes</span>(<span class="params">data, encoding=<span class="string">'utf-8'</span></span>):</span><br><span class="line">    <span class="string">"""确保数据是字节类型，如果不是则转换为字节类型"""</span></span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(data, <span class="built_in">bytes</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(data).encode(encoding)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 加密解密函数 (AES-GCM)---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_aes_gcm</span>(<span class="params">key: <span class="built_in">bytes</span>, plaintext: <span class="built_in">bytes</span>, associated_data: <span class="built_in">bytes</span> = <span class="literal">None</span></span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">bytes</span>, <span class="built_in">bytes</span>, <span class="built_in">bytes</span>] | <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""使用 AES-GCM 模式加密数据</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        key: AES 加密密钥，应为 128、192 或 256 位（16、24 或 32 字节）</span></span><br><span class="line"><span class="string">        plaintext: 需要加密的明文数据</span></span><br><span class="line"><span class="string">        associated_data: 关联数据（可选），不会被加密但会被包含在认证中</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        成功时返回一个包含三个元素的元组 (随机数, 密文, 认证标签)，均为字节类型；</span></span><br><span class="line"><span class="string">        失败时返回 None</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    plaintext = ensure_bytes(plaintext)</span><br><span class="line">    associated_data = ensure_bytes(associated_data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.为本次加密生成唯一的Nonce (关键！！！)</span></span><br><span class="line">    nonce = generate_nonce()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 2.准备加密器</span></span><br><span class="line">        encryptor = Cipher(</span><br><span class="line">            algorithms.AES(key),  <span class="comment"># 指定加密算法为 AES 并提供 密钥</span></span><br><span class="line">            modes.GCM(nonce),  <span class="comment"># 提供 Nonce</span></span><br><span class="line">            backend=default_backend()</span><br><span class="line">        ).encryptor()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. (可选) 添加附加认证数据 (AAD)</span></span><br><span class="line">        <span class="keyword">if</span> associated_data:</span><br><span class="line">            encryptor.authenticate_additional_data(associated_data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4.执行加密 encryptor.finalize(): 返回加密后的密文和认证标签</span></span><br><span class="line">        ciphertext = encryptor.update(plaintext) + encryptor.finalize()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5.获取认证标签 (加密后自动生成)</span></span><br><span class="line">        tag = encryptor.tag</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 6. 返回所有需要传输/存储的部分</span></span><br><span class="line">        <span class="keyword">return</span> nonce, ciphertext, tag</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"加密过程出错：<span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 解密函数 (AES-GCM)---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_aes_gcm</span>(<span class="params">key: <span class="built_in">bytes</span>, nonce: <span class="built_in">bytes</span>, ciphertext: <span class="built_in">bytes</span>, tag: <span class="built_in">bytes</span>, associated_data: <span class="built_in">bytes</span> = <span class="literal">None</span></span>) -&gt; <span class="built_in">bytes</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""使用 AES-GCM 模式解密数据</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        key: AES 加密密钥，应为 128、192 或 256 位（16、24 或 32 字节）</span></span><br><span class="line"><span class="string">        nonce: 加密时使用的随机数，应为 12 字节 (96 位)</span></span><br><span class="line"><span class="string">        ciphertext: 加密后的密文数据</span></span><br><span class="line"><span class="string">        tag: 加密后的认证标签</span></span><br><span class="line"><span class="string">        associated_data: 加密时提供的关联数据（可选）</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        成功时返回解密后的明文数据，失败时返回 None</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    ciphertext = ensure_bytes(ciphertext)</span><br><span class="line">    tag = ensure_bytes(tag)</span><br><span class="line">    associated_data = ensure_bytes(associated_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. 准备解密器，同时提供 Nonce 和 Tag 用于认证</span></span><br><span class="line">        decryptor = Cipher(</span><br><span class="line">            algorithms.AES(key),  <span class="comment"># 指定加密算法为 AES 并提供 密钥</span></span><br><span class="line">            modes.GCM(nonce, tag), <span class="comment"># 解密时必须提供 Tag ！</span></span><br><span class="line">            backend=default_backend()</span><br><span class="line">        ).decryptor()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. (可选) 添加附加认证数据 (AAD)</span></span><br><span class="line">        <span class="keyword">if</span> associated_data:</span><br><span class="line">            decryptor.authenticate_additional_data(associated_data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 执行解密 (内部会先验证 Tag)</span></span><br><span class="line">        <span class="comment"># 如果 Tag 不匹配或数据卷被穿该 此处将会引发 InvalidTag 异常</span></span><br><span class="line">        plaintext = decryptor.update(ciphertext) + decryptor.finalize()</span><br><span class="line">        <span class="keyword">return</span> plaintext</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> InvalidTag:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[解密错误] 解密失败：认证标签无效！数据可能被篡改或密钥/Nonce/AAD 不匹配。"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"[解密错误] AES-GCM 解密时发生其他错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># --- 使用 AES-GCM 示例 ---</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"--- AES-GCM 示例 ---"</span>)</span><br><span class="line">    <span class="comment"># 1. 生成密钥 (仅用于演示，实际应用需安全管理)</span></span><br><span class="line">    my_aes_key = generate_aes_key(<span class="number">256</span>)  <span class="comment"># 使用 256 位密钥</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"使用的 AES 密钥 (Hex): <span class="subst">{my_aes_key.<span class="built_in">hex</span>()}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 准备明文 和 AAD</span></span><br><span class="line">    secret_data = <span class="string">"这是需要高度保密和完整性保护的数据！"</span></span><br><span class="line">    metadata = {<span class="string">"sender"</span>: <span class="string">"Alice"</span>, <span class="string">"receiver"</span>: <span class="string">"Bob"</span>, <span class="string">"msg_id"</span>: <span class="number">123</span>}  <span class="comment"># 假设 AAD 是 JSON 字符串</span></span><br><span class="line">    <span class="keyword">import</span> json</span><br><span class="line">    aad_json = json.dumps(metadata, separators=(<span class="string">','</span>, <span class="string">':'</span>)).encode(<span class="string">'utf-8'</span>)  <span class="comment"># 紧凑的 JSON 字符串作为 AAD</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"原始明文: '<span class="subst">{secret_data}</span>'"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"附加数据 (AAD): <span class="subst">{aad_json.decode()}</span>"</span>)</span><br><span class="line">    <span class="comment"># 3. 加密</span></span><br><span class="line">    encryption_result = encrypt_aes_gcm(my_aes_key, secret_data, aad_json)</span><br><span class="line">    <span class="keyword">if</span> encryption_result:</span><br><span class="line">        nonce, ciphertext, tag = encryption_result</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n[加密成功]"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  Nonce (Hex): <span class="subst">{nonce.<span class="built_in">hex</span>()}</span> (<span class="subst">{<span class="built_in">len</span>(nonce)}</span> bytes)"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  认证标签 (Hex): <span class="subst">{tag.<span class="built_in">hex</span>()}</span> (<span class="subst">{<span class="built_in">len</span>(tag)}</span> bytes)"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  密文 (Hex): <span class="subst">{ciphertext.<span class="built_in">hex</span>()}</span> (<span class="subst">{<span class="built_in">len</span>(ciphertext)}</span> bytes)"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 模拟传输/存储 (通常需要将 nonce, tag, ciphertext 组合) ---</span></span><br><span class="line">        <span class="comment"># 例如，简单拼接： transmitted_blob = nonce + tag + ciphertext</span></span><br><span class="line">        <span class="comment"># --- 模拟接收方接收到数据并解密 ---</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n[开始解密]"</span>)</span><br><span class="line">        <span class="comment"># 假设接收到 nonce, tag, ciphertext 和 aad_json</span></span><br><span class="line">        decrypted_data = decrypt_aes_gcm(my_aes_key, nonce, ciphertext, tag, aad_json)</span><br><span class="line">        <span class="keyword">if</span> decrypted_data:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"[解密成功]"</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"  解密后明文: '<span class="subst">{decrypted_data.decode(<span class="string">'utf-8'</span>)}</span>'"</span>)</span><br><span class="line">                <span class="keyword">assert</span> decrypted_data == secret_data.encode(<span class="string">'utf-8'</span>) <span class="comment"># 断言为真，说明解密成功</span></span><br><span class="line">            <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"  解密后字节 (Hex): <span class="subst">{decrypted_data.<span class="built_in">hex</span>()}</span>"</span>)  <span class="comment"># 如果原始不是字符串</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"[解密失败]"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 模拟攻击：篡改密文 ---</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n[模拟攻击：篡改密文]"</span>)</span><br><span class="line">        tampered_ciphertext = <span class="built_in">bytearray</span>(ciphertext)</span><br><span class="line">        <span class="keyword">if</span> tampered_ciphertext: tampered_ciphertext[<span class="number">0</span>] ^= <span class="number">0xFF</span>  <span class="comment"># 修改第一个字节</span></span><br><span class="line">        decrypted_tampered = decrypt_aes_gcm(my_aes_key, nonce, <span class="built_in">bytes</span>(tampered_ciphertext), tag, aad_json) <span class="comment"># 解密肯定会失败</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 模拟攻击：使用错误的 AAD 解密 ---</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n[模拟使用错误 AAD 解密]"</span>)</span><br><span class="line">        wrong_aad = <span class="string">b'{"sender":"Eve"}'</span>  <span class="comment"># AAD 被篡改</span></span><br><span class="line">        decrypted_wrong_aad = decrypt_aes_gcm(my_aes_key, nonce, ciphertext, tag, wrong_aad)</span><br><span class="line">        <span class="comment"># 预期结果：解密失败，因为 Tag 是基于原始 AAD 计算的</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[加密失败]"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="示例-2：使用-AES-CBC-如果必须使用，且理解其局限性"><a href="#示例-2：使用-AES-CBC-如果必须使用，且理解其局限性" class="headerlink" title="示例 2：使用 AES-CBC (如果必须使用，且理解其局限性)"></a>示例 2：使用 AES-CBC (如果必须使用，且理解其局限性)</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --- 辅助函数 ---</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> Cipher, algorithms, modes</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> padding  <span class="comment"># 用于 PKCS7 填充</span></span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_aes_key</span>(<span class="params">key_size: <span class="built_in">int</span> = <span class="number">256</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">"""生成指定位数的随机 AES 密钥 (bytes)"""</span></span><br><span class="line">    <span class="keyword">if</span> key_size <span class="keyword">not</span> <span class="keyword">in</span> [<span class="number">128</span>, <span class="number">192</span>, <span class="number">256</span>]:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"密钥大小必须是128, 192 or 256位"</span>)</span><br><span class="line">    <span class="comment"># 返回随机字节串</span></span><br><span class="line">    <span class="comment"># 这里 // 8 是为了将比特(bit)转换为字节(byte)</span></span><br><span class="line">    <span class="comment"># 因为密钥大小(key_size)是以比特为单位的(如128位、256位)</span></span><br><span class="line">    <span class="comment"># 而os.urandom()函数需要的参数是字节数</span></span><br><span class="line">    <span class="comment"># 1字节 = 8比特，所以需要用key_size除以8来得到对应的字节数</span></span><br><span class="line">    <span class="comment"># 例如：128位密钥需要128/8=16字节的随机数据</span></span><br><span class="line">    <span class="keyword">return</span> os.urandom(key_size // <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_iv</span>(<span class="params">block_size: <span class="built_in">int</span> = <span class="number">16</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">"""为 CBC 生成随机 IV (必须与 AES 块大小相同)。"""</span></span><br><span class="line">    <span class="keyword">return</span> os.urandom(block_size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 加密解密函数(AES-CBC) ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_aes_cbc</span>(<span class="params">key: <span class="built_in">bytes</span>, plaintext: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""使用 AES-CBC 加密 plaintext，密钥为 key。"""</span></span><br><span class="line">    <span class="comment"># 1. 为本次加密生成随机 IV （最关键！！）</span></span><br><span class="line">    iv = generate_iv()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 2. 创建 AES-CBC 加密器</span></span><br><span class="line">        cipher = Cipher(</span><br><span class="line">            algorithms.AES(key),</span><br><span class="line">            modes.CBC(iv),</span><br><span class="line">            backend=default_backend()</span><br><span class="line">        ).encryptor()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 进行 PKCS7 填充</span></span><br><span class="line">        padder = padding.PKCS7(algorithms.AES.block_size).padder()  <span class="comment"># AES 块大小固定为 128 位</span></span><br><span class="line">        padded_data = padder.update(plaintext) + padder.finalize()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. 加密数据</span></span><br><span class="line">        ciphertext = cipher.update(padded_data) + cipher.finalize()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5.将 IV 附加到密文前面(常用做法)</span></span><br><span class="line">        <span class="keyword">return</span> iv + ciphertext</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"[加密错误] AES-CBC 加密失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 解密函数 (AES-CBC) ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_aes_cbc</span>(<span class="params">key: <span class="built_in">bytes</span>, iv_ciphertext: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""解密 AES-CBC 数据 (假设 IV 位于密文前面)"""</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(iv_ciphertext, <span class="built_in">bytes</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[解密错误] 密文必须是字节串"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="comment"># 1. 提取 IV 和密文</span></span><br><span class="line">    iv = iv_ciphertext[:<span class="number">16</span>]  <span class="comment"># 前 16 字节为 IV</span></span><br><span class="line">    ciphertext = iv_ciphertext[<span class="number">16</span>:]  <span class="comment"># 后面的字节为密文</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 2.准备解密器</span></span><br><span class="line">        cipher = Cipher(</span><br><span class="line">            algorithms.AES(key),</span><br><span class="line">            modes.CBC(iv),</span><br><span class="line">            backend=default_backend()</span><br><span class="line">        ).decryptor()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 去除 PKCS7 填充</span></span><br><span class="line">        unpadder = padding.PKCS7(algorithms.AES.block_size).unpadder()</span><br><span class="line">        padded_data = cipher.update(ciphertext) + cipher.finalize()</span><br><span class="line">        plaintext = unpadder.update(padded_data) + unpadder.finalize()</span><br><span class="line">        <span class="comment"># 4. 返回解密结果</span></span><br><span class="line">        <span class="keyword">return</span> plaintext</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"[解密错误] AES-CBC 解密失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># --- 使用 AES-CBC 示例 ---</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n\n--- AES-CBC 示例 ---"</span>)</span><br><span class="line">    <span class="comment"># 1. 生成密钥</span></span><br><span class="line">    key = generate_aes_key(<span class="number">256</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"密钥: <span class="subst">{key.<span class="built_in">hex</span>()}</span>"</span>)</span><br><span class="line">    <span class="comment"># 2. 待加密数据</span></span><br><span class="line">    plaintext = <span class="string">"这是用 CBC 模式加密的数据，需要注意完整性问题！"</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"待加密数据: <span class="subst">{plaintext}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 加密数据</span></span><br><span class="line">    ciphertext = encrypt_aes_cbc(key, plaintext.encode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"加密后数据: <span class="subst">{ciphertext.<span class="built_in">hex</span>()}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. 解密数据</span></span><br><span class="line">    decrypted_data = decrypt_aes_cbc(key, ciphertext)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"解密后数据: <span class="subst">{decrypted_data.decode()}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 重点：CBC 不提供内置完整性保护 ---</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n[模拟 CBC 密文篡改]"</span>)</span><br><span class="line">    tampered_blob_cbc = <span class="built_in">bytearray</span>(ciphertext)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tampered_blob_cbc) &gt; <span class="number">17</span>:  <span class="comment"># 确保能修改密文部分</span></span><br><span class="line">        tampered_blob_cbc[<span class="number">16</span>] ^= <span class="number">0xFF</span>  <span class="comment"># 修改密文的第一个字节 (IV 之后)</span></span><br><span class="line">    decrypted_tampered_cbc = decrypt_aes_cbc(key, <span class="built_in">bytes</span>(tampered_blob_cbc))</span><br><span class="line">    <span class="keyword">if</span> decrypted_tampered_cbc:</span><br><span class="line">         <span class="built_in">print</span>(<span class="string">"  篡改后 CBC 解密'成功'，但数据已损坏:"</span>)</span><br><span class="line">         <span class="built_in">print</span>(<span class="string">f"  损坏的明文 (尝试解码): '<span class="subst">{decrypted_tampered_cbc.decode(<span class="string">'utf-8'</span>, errors=<span class="string">'replace'</span>)}</span>'"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">         <span class="built_in">print</span>(<span class="string">"  篡改后 CBC 解密失败 (可能是填充错误)。"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"  结论：需要额外的 MAC 来保证 CBC 的完整性！"</span>)</span><br></pre></td></tr></tbody></table></figure><hr><h3 id="15-4-5-非对称加密-Asymmetric-Encryption-：公钥与私钥的世界"><a href="#15-4-5-非对称加密-Asymmetric-Encryption-：公钥与私钥的世界" class="headerlink" title="15.4.5 非对称加密 (Asymmetric Encryption)：公钥与私钥的世界"></a>15.4.5 非对称加密 (Asymmetric Encryption)：公钥与私钥的世界</h3><p>非对称加密，也称为<strong>公钥加密 (Public-key Cryptography)</strong>，是密码学领域的一项革命性发明。它与对称加密最根本的区别在于：<strong>加密和解密使用不同的密钥</strong>。</p><p><strong>核心概念：密钥对 (Key Pair)</strong></p><p>非对称加密系统基于一个<strong>密钥对</strong>，包含两个在数学上相关联但又不同的密钥：</p><ol><li><strong>公钥 (Public Key):</strong><ul><li>可以（也应该）<strong>公开发布</strong>，任何人都可以获取。</li><li>用于<strong>加密数据</strong>（发送给私钥持有者）或<strong>验证签名</strong>（验证是否由私钥持有者签名）。</li></ul></li><li><strong>私钥 (Private Key):</strong><ul><li><strong>必须由所有者严格保密</strong>，绝不能泄露。</li><li>用于<strong>解密由对应公钥加密的数据</strong>或<strong>创建数字签名</strong>。</li></ul></li></ol><p>这两个密钥是<strong>配对生成</strong>的。通过公钥几乎不可能推导出私钥（这是非对称加密安全性的数学基础）。</p><p><strong>工作流程类比：</strong></p><ul><li><p><strong>加密通信（像信箱）：</strong></p><ol><li>Bob 生成一对密钥（公钥 $ Pub_B $ ，私钥 $ Pri_B $ ），并将公钥 $ Pub_B $ 公开。</li><li>Alice 想要给 Bob 发送机密消息 $ P $ 。她使用 Bob 的<strong>公钥 $ Pub_B $</strong> 对消息进行加密，得到密文 $ C $ 。</li><li>Alice 将密文 $ C $ 发送给 Bob。网络上的任何人都可以截获 $ C $ ，但没有 Bob 的私钥是无法解密的。</li><li>Bob 收到密文 $ C $ 后，使用他自己<strong>保密的私钥 $ Pri_B $</strong> 进行解密，恢复出明文 $ P $ 。</li></ol></li><li><p><strong>数字签名（像印章）：</strong></p><ol><li>Alice 生成一对密钥（公钥 $ Pub_A $ ，私钥 $ Pri_A $ ），并将公钥 $ Pub_A $ 公开。</li><li>Alice 写了一份文件 $ M $ ，她想证明这份文件确实是她写的且未被篡改。她使用自己的<strong>私钥 $ Pri_A $</strong> 对文件（通常是文件的哈希值）进行<strong>签名</strong>，生成一个数字签名 $ S $ 。</li><li>Alice 将文件 $ M $ 和签名 $ S $ 一起发送出去。</li><li>任何人（比如 Bob）收到 $ M $ 和 $ S $ 后，可以使用 Alice 的<strong>公钥 $ Pub_A $</strong> 对签名 $ S $ 和文件 $ M $ 进行<strong>验证</strong>。如果验证通过，Bob 就能确信这份文件确实来自 Alice 且内容未被修改过。</li></ol></li></ul><p><strong>优点：</strong></p><ol><li><strong>解决了密钥分发问题：</strong> 这是非对称加密最核心的优势。公钥可以安全地通过任何渠道分发（网站、邮件、目录服务等），无需担心被窃听。发送方只需获取接收方的公钥即可加密信息，大大简化了密钥管理。</li><li><strong>实现数字签名：</strong> 私钥的唯一性使得非对称加密能够提供：<ul><li><strong>身份认证 (Authentication):</strong> 验证消息来源。</li><li><strong>数据完整性 (Integrity):</strong> 确保消息未被篡改。</li><li><strong>不可否认性 (Non-repudiation):</strong> 发送方无法否认自己发送过经过签名的消息。</li></ul></li></ol><p><strong>缺点：</strong></p><ol><li><strong>速度极慢：</strong> 非对称加密算法涉及复杂的数学运算（如大数模幂运算、椭圆曲线运算），其<strong>加密和解密速度比对称加密算法（如 AES）慢几个数量级</strong>（通常是 100 到 1000 倍甚至更多）。</li><li><strong>不适合加密大量数据：</strong> 由于速度慢，直接使用非对称加密来加密大文件或长时间的通信流是<strong>不现实</strong>的。</li></ol><p><strong>标准实践：混合加密 (Hybrid Encryption)</strong></p><p>为了兼顾非对称加密的密钥管理便利性和对称加密的高效率，实际应用中（如 TLS/SSL、PGP 等）普遍采用<strong>混合加密</strong>方案：</p><ol><li><strong>生成临时对称密钥：</strong> 发送方为本次通信<strong>随机生成一个一次性的对称密钥</strong> $ K_{sym} $ （例如，一个 AES 密钥）。</li><li><strong>用对称密钥加密数据：</strong> 使用快速的对称算法（如 AES-GCM）和密钥 $ K_{sym} $ 加密<strong>主要数据</strong> $ P $ ，得到密文 $ C_{data} $ 。</li><li><strong>用非对称密钥加密对称密钥：</strong> 使用接收方的<strong>公钥</strong> $ Pub_{Receiver} $ 加密这个<strong>一次性对称密钥</strong> $ K_{sym} $ ，得到加密后的密钥 $ C_{key} $ 。由于 $ K_{sym} $ 通常很短（如 128 或 256 位），非对称加密的性能开销可以接受。</li><li><strong>传输：</strong> 将加密后的对称密钥 $ C_{key} $ 和用对称密钥加密的数据 $ C_{data} $ 一起发送给接收方。</li><li><strong>解密：</strong><ul><li>接收方使用自己的<strong>私钥</strong> $ Pri_{Receiver} $ 解密 $ C_{key} $ ，得到一次性对称密钥 $ K_{sym} $ 。</li><li>接收方再使用恢复出的对称密钥 $ K_{sym} $ 解密 $ C_{data} $ ，得到原始数据 $ P $ 。</li></ul></li></ol><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    subgraph 发送方 Alice</span><br><span class="line">        Ksym["生成临时对称密钥 Ksym"]</span><br><span class="line">        P["大数据 P"] -- "使用 Ksym 加密 (AES)" --&gt; Cdata["密文 Cdata"]</span><br><span class="line">        PubRcv["接收方 Bob 的公钥 Pub_B"]</span><br><span class="line">        Ksym -- "使用 Pub_B 加密 (RSA)" --&gt; Ckey["加密的密钥 Ckey"]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    Ckey -- "传输" --&gt; R_Ckey</span><br><span class="line">    Cdata -- "传输" --&gt; R_Cdata</span><br><span class="line"></span><br><span class="line">    subgraph 接收方 Bob</span><br><span class="line">        PriRcv["Bob 的私钥 Pri_B"]</span><br><span class="line">        R_Ckey -- "使用 Pri_B 解密 (RSA)" --&gt; Dec_Ksym["得到 Ksym"]</span><br><span class="line">        R_Cdata -- "使用 Ksym 解密 (AES)" --&gt; Dec_P["得到数据 P"]</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    style Ksym fill:#lightgreen,stroke:#333</span><br><span class="line">    style PubRcv fill:#lightblue,stroke:#333</span><br><span class="line">    style PriRcv fill:#f9f,stroke:#333</span><br></pre></td></tr></tbody></table></figure><h4 id="RSA-Rivest–Shamir–Adleman-：应用最广泛的非对称算法"><a href="#RSA-Rivest–Shamir–Adleman-：应用最广泛的非对称算法" class="headerlink" title="RSA (Rivest–Shamir–Adleman)：应用最广泛的非对称算法"></a>RSA (Rivest–Shamir–Adleman)：应用最广泛的非对称算法</h4><p>RSA 是第一个实用且至今仍在广泛使用的公钥加密算法。</p><ul><li><strong>数学基础：</strong> 其安全性依赖于<strong>大整数分解的困难性</strong>。即，给定两个大素数 $ p $ 和 $ q $ ，计算它们的乘积 $ N = p \times q $ 很容易；但给定 $ N $ ，想反向分解出 $ p $ 和 $ q $ 则极其困难。</li><li><strong>密钥生成：</strong> 涉及生成两个大素数，并进行一系列模幂运算来得到公钥和私钥对。</li><li><strong>密钥长度：</strong><ul><li>RSA 的安全性直接取决于密钥（模数 N）的长度（位数）。</li><li><strong>【安全警告】</strong>：随着计算能力的提升，较短的 RSA 密钥已不再安全。<ul><li><strong>1024 位：绝对不安全！</strong> 已被证明可以被破解。</li><li><strong>2048 位：当前推荐的最低长度</strong>，用于一般性需求。</li><li><strong>3072 位或 4096 位：推荐用于需要更高、更长期安全的场景</strong>。</li></ul></li><li>使用过短的密钥是常见的安全风险。</li></ul></li><li><strong>填充方案 (Padding) - 【极其重要！】</strong><ul><li><strong>原始的 RSA 算法（教科书式 RSA）本身存在严重的安全缺陷</strong>，容易受到多种攻击（如选择密文攻击）。<strong>绝对不能直接使用原始 RSA！</strong></li><li><strong>必须</strong>结合安全的<strong>填充方案</strong>来使用 RSA。填充是在加密/签名前对原始数据进行处理，加入随机性或特定结构，以抵抗各种攻击。</li><li><strong>用于加密：</strong><ul><li><strong>推荐：OAEP (Optimal Asymmetric Encryption Padding)</strong>，通常结合 SHA-256 或更强的哈希函数。</li><li><strong>【弃用警告】</strong>：<strong>PKCS#1 v1.5 填充</strong>（较旧的标准）用于加密时存在已知的安全漏洞，<strong>不应再用于新的加密应用</strong>。</li></ul></li><li><strong>用于签名：</strong><ul><li><strong>推荐：PSS (Probabilistic Signature Scheme)</strong>，通常结合 SHA-256 或更强的哈希函数。PSS 提供了更强的理论安全证明（抗选择消息攻击）。</li><li><strong>兼容性：PKCS#1 v1.5 填充</strong> 用于签名目前仍被广泛使用且相对安全（不像用于加密时那么脆弱），但 PSS 是更现代、更受推荐的选择。</li></ul></li></ul></li><li><strong>常见用途：</strong><ul><li><strong>密钥交换：</strong> 在混合加密中加密对称会话密钥。</li><li><strong>数字签名：</strong> 验证软件、文档、证书等的来源和完整性。</li></ul></li></ul><h4 id="Python-实现-RSA-使用-cryptography-库"><a href="#Python-实现-RSA-使用-cryptography-库" class="headerlink" title="Python 实现 RSA (使用 cryptography 库)"></a>Python 实现 RSA (使用 <code>cryptography</code> 库)</h4><p><code>cryptography</code> 库提供了对 RSA 密钥生成、管理、加密/解密（带填充）和签名/验证（带填充）的全面支持。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> hashes</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.asymmetric <span class="keyword">import</span> padding <span class="keyword">as</span> asym_padding  <span class="comment"># 重命名避免与对称填充混淆</span></span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.asymmetric <span class="keyword">import</span> rsa</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> serialization  <span class="comment"># 用于密钥的保存和加载</span></span><br><span class="line"><span class="keyword">from</span> cryptography.exceptions <span class="keyword">import</span> InvalidSignature  <span class="comment"># 用于捕获签名验证失败</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 1.RSA 密钥对生成 ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_rsa_key_pair</span>(<span class="params">key_size: <span class="built_in">int</span> = <span class="number">2048</span>, public_exponent: <span class="built_in">int</span> = <span class="number">65537</span></span>) -&gt; <span class="built_in">tuple</span>:</span><br><span class="line">    <span class="string">"""生成 RSA 公私钥对"""</span></span><br><span class="line">    private_key = rsa.generate_private_key(</span><br><span class="line">        public_exponent=public_exponent,  <span class="comment"># 公共指数，通常固定为 65537</span></span><br><span class="line">        key_size=key_size,  <span class="comment"># 密钥长度，通常为 2048 或 4096</span></span><br><span class="line">        backend=default_backend()  <span class="comment"># 后端，提供密码学操作的具体实现，default_backend 使用系统默认的密码学后端实现，负责处理底层的密码学计算</span></span><br><span class="line">    )</span><br><span class="line">    public_key = private_key.public_key()  <span class="comment"># 生成公钥</span></span><br><span class="line">    <span class="keyword">return</span> private_key, public_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 2.密钥序列化 (保存/加载) ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_private_key</span>(<span class="params">private_key: rsa.RSAPrivateKey, filename: <span class="built_in">str</span>, password: <span class="built_in">str</span> = <span class="literal">None</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""将私钥以 PEM 格式保存到文件，可选密码保护。"""</span></span><br><span class="line">    pem = private_key.private_bytes(</span><br><span class="line">        encoding=serialization.Encoding.PEM,  <span class="comment"># 编码格式为 PEM</span></span><br><span class="line">        <span class="built_in">format</span>=serialization.PrivateFormat.PKCS8,  <span class="comment"># 推荐使用 PKCS8 格式</span></span><br><span class="line">        encryption_algorithm=serialization.BestAvailableEncryption(</span><br><span class="line">            password.encode(<span class="string">'utf-8'</span>)) <span class="keyword">if</span> password <span class="keyword">else</span> serialization.NoEncryption()  <span class="comment"># 选择密码加密或不加密</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(pem)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"私钥已保存到 <span class="subst">{filename}</span>"</span> + (<span class="string">" (已加密)"</span> <span class="keyword">if</span> password <span class="keyword">else</span> <span class="string">" (未加密)"</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_private_key</span>(<span class="params">filename: <span class="built_in">str</span>, password: <span class="built_in">str</span> = <span class="literal">None</span></span>) -&gt; rsa.RSAPrivateKey:</span><br><span class="line">    <span class="string">"""从文件加载私钥，可选密码解密。"""</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        pem = f.read()</span><br><span class="line">        private_key = serialization.load_pem_private_key(</span><br><span class="line">            pem,  <span class="comment"># 使用已读取的内容，而不是再次调用f.read()</span></span><br><span class="line">            password=password.encode(<span class="string">'utf-8'</span>) <span class="keyword">if</span> password <span class="keyword">else</span> <span class="literal">None</span>,  <span class="comment"># 选择密码解密或不解密</span></span><br><span class="line">            backend=default_backend()  <span class="comment"># 后端</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> private_key</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_public_key</span>(<span class="params">public_key, filename</span>):</span><br><span class="line">    <span class="string">"""将公钥以 PEM 格式保存到文件。"""</span></span><br><span class="line">    pem = public_key.public_bytes(</span><br><span class="line">        encoding=serialization.Encoding.PEM,</span><br><span class="line">        <span class="built_in">format</span>=serialization.PublicFormat.SubjectPublicKeyInfo <span class="comment"># 标准格式</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(pem)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"公钥已保存到 <span class="subst">{filename}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_public_key</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="string">"""从 PEM 文件加载公钥。"""</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        public_key = serialization.load_pem_public_key(</span><br><span class="line">            f.read(),</span><br><span class="line">            backend=default_backend()</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> public_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 3. RSA 加密/解密 (使用 OAEP 填充) ---</span></span><br><span class="line"><span class="comment"># 注意：RSA 仅适合加密少量数据，如对称密钥或短消息</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rsa_encrypt_oaep</span>(<span class="params">public_key: rsa.RSAPublicKey, plaintext: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""使用 RSA 公钥加密数据，使用 OAEP 填充"""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ciphertext = public_key.encrypt(</span><br><span class="line">            plaintext,</span><br><span class="line">            asym_padding.OAEP(</span><br><span class="line">                mgf=asym_padding.MGF1(algorithm=hashes.SHA256()),  <span class="comment"># 掩码生成函数</span></span><br><span class="line">                algorithm=hashes.SHA256(),  <span class="comment"># 哈希算法</span></span><br><span class="line">                label=<span class="literal">None</span>  <span class="comment"># 标签，通常为空</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> ciphertext</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"RSA 加密失败：<span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rsa_decrypt_oaep</span>(<span class="params">private_key, ciphertext: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""使用私钥和 OAEP 填充解密少量数据。"""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        plaintext = private_key.decrypt(</span><br><span class="line">            ciphertext,</span><br><span class="line">            asym_padding.OAEP(</span><br><span class="line">                mgf=asym_padding.MGF1(algorithm=hashes.SHA256()),  <span class="comment"># 掩码生成函数</span></span><br><span class="line">                algorithm=hashes.SHA256(),  <span class="comment"># 哈希算法</span></span><br><span class="line">                label=<span class="literal">None</span>  <span class="comment"># 标签，通常为空</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> plaintext</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"RSA 解密失败：<span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 4. RSA 签名/验证 (使用 PSS 填充) ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rsa_sign_pss</span>(<span class="params">private_key, message: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""使用私钥和 PSS 填充对消息进行签名 (实际签的是哈希)。"""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        signature = private_key.sign(</span><br><span class="line">            message,  <span class="comment"># cryptography v3.0+ 可以直接签消息，内部会做哈希</span></span><br><span class="line">            <span class="comment"># 如果是旧版本或想明确控制，可以先 hash_obj = hashes.Hash(hashes.SHA256()); hash_obj.update(message); digest = hash_obj.finalize(); 然后签 digest</span></span><br><span class="line">            asym_padding.PSS(</span><br><span class="line">                mgf=asym_padding.MGF1(hashes.SHA256()),</span><br><span class="line">                salt_length=asym_padding.PSS.MAX_LENGTH  <span class="comment"># 推荐最大盐长度以增强安全性</span></span><br><span class="line">            ),</span><br><span class="line">            hashes.SHA256()  <span class="comment"># 指定签名使用的哈希算法</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> signature</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"[签名错误] RSA PSS 签名失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rsa_verify_pss</span>(<span class="params">public_key: rsa.RSAPublicKey, message: <span class="built_in">bytes</span>, signature: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">"""使用公钥和 PSS 填充验证签名。"""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        public_key.verify(</span><br><span class="line">            signature,</span><br><span class="line">            message,</span><br><span class="line">            asym_padding.PSS(</span><br><span class="line">                mgf=asym_padding.MGF1(hashes.SHA256()),</span><br><span class="line">                salt_length=asym_padding.PSS.MAX_LENGTH  <span class="comment"># 推荐最大盐长度以增强安全性</span></span><br><span class="line">            ),</span><br><span class="line">            hashes.SHA256()  <span class="comment"># 指定签名使用的哈希算法</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> InvalidSignature:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[签名错误] RSA PSS 签名验证失败"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 5. 示例 ---</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 1. 生成或加载密钥对 (为避免每次运行都生成，可以保存后加载)</span></span><br><span class="line">    private_key_file = <span class="string">"rsa_private_key.pem"</span></span><br><span class="line">    public_key_file = <span class="string">"rsa_public_key.pem"</span></span><br><span class="line">    key_password = <span class="string">"abc123"</span>  <span class="comment"># 用于加密私钥文件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(private_key_file) <span class="keyword">and</span> os.path.exists(public_key_file):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"检测到已有密钥对，加载已有密钥对..."</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            private_key = load_private_key(private_key_file,key_password)</span><br><span class="line">            public_key = load_public_key(public_key_file)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"已加载密钥对"</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"加载密钥对失败：<span class="subst">{e}</span> . 重新生成密钥对..."</span>)</span><br><span class="line">            private_key, public_key = generate_rsa_key_pair(key_size=<span class="number">2048</span>)</span><br><span class="line">            save_private_key(private_key, private_key_file, key_password)</span><br><span class="line">            save_public_key(public_key, public_key_file)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"未检测到密钥对，生成新密钥对..."</span>)</span><br><span class="line">        private_key, public_key = generate_rsa_key_pair(key_size=<span class="number">2048</span>)</span><br><span class="line">        <span class="comment"># 保存密钥以便下次使用 (私钥使用密码加密)</span></span><br><span class="line">        save_private_key(private_key, private_key_file, key_password)</span><br><span class="line">        save_public_key(public_key, public_key_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 演示加密和解密 (少量数据，比如一个对称密钥)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n--- RSA 加密/解密 (OAEP) 示例 ---"</span>)</span><br><span class="line">    <span class="comment"># 假设这是我们要安全传输的 AES 密钥</span></span><br><span class="line">    symmetric_key_to_transmit = os.urandom(<span class="number">32</span>)  <span class="comment"># 256 位</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"要加密的对称密钥 (Hex): <span class="subst">{symmetric_key_to_transmit.<span class="built_in">hex</span>()}</span>"</span>)</span><br><span class="line">    encrypted_key = rsa_encrypt_oaep(public_key, symmetric_key_to_transmit)</span><br><span class="line">    <span class="keyword">if</span> encrypted_key:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"RSA 加密后的密钥 (Hex, 前 32 字节): <span class="subst">{encrypted_key[:<span class="number">32</span>].<span class="built_in">hex</span>()}</span>..."</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"加密后长度: <span class="subst">{<span class="built_in">len</span>(encrypted_key)}</span> bytes"</span>)  <span class="comment"># 通常等于 RSA 密钥字节数</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"====尝试解密===="</span>)</span><br><span class="line">        decrypted_key = rsa_decrypt_oaep(private_key, encrypted_key)</span><br><span class="line">        <span class="keyword">if</span> decrypted_key:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"RSA 解密后的密钥 (Hex): <span class="subst">{decrypted_key.<span class="built_in">hex</span>()}</span>"</span>)</span><br><span class="line">            <span class="keyword">assert</span> decrypted_key == symmetric_key_to_transmit</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"解密验证成功！"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"解密失败。"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"加密失败。"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="其他重要非对称算法：ECC-椭圆曲线密码学"><a href="#其他重要非对称算法：ECC-椭圆曲线密码学" class="headerlink" title="其他重要非对称算法：ECC (椭圆曲线密码学)"></a>其他重要非对称算法：ECC (椭圆曲线密码学)</h4><p>除了 RSA，<strong>椭圆曲线密码学 (Elliptic Curve Cryptography, ECC)</strong> 是另一大类非常重要的非对称算法。</p><ul><li><strong>优势：</strong> ECC 最大的优点在于它能用<strong>更短的密钥长度</strong>达到与 RSA 相同的安全级别。例如：<ul><li>256 位的 ECC 密钥提供的安全性 ≈ 3072 位的 RSA 密钥。</li><li>384 位的 ECC 密钥提供的安全性 ≈ 7680 位的 RSA 密钥。</li></ul></li><li><strong>结果：</strong><ul><li><strong>性能更高：</strong> 更短的密钥意味着更快的计算速度（加密、解密、签名、验证）。</li><li><strong>带宽和存储更少：</strong> 密钥和签名都更小。</li></ul></li><li><strong>应用：</strong> ECC 在性能和资源受限的环境（如移动设备、物联网设备、智能卡）中特别有优势，并且越来越多地被用于：<ul><li><strong>数字签名：</strong> ECDSA (Elliptic Curve Digital Signature Algorithm) 是常用的标准。</li><li><strong>密钥协商：</strong> ECDH (Elliptic Curve Diffie–Hellman) 用于安全地生成共享密钥（TLS 1.3 中广泛使用）。</li><li>比特币等加密货币也大量使用 ECC。</li></ul></li><li><strong><code>cryptography</code> 库支持：</strong> Python 的 <code>cryptography</code> 库也提供了对 ECC 密钥对生成、ECDH 密钥交换和 ECDSA 签名/验证的支持（例如 <code>ec.generate_private_key</code>, <code>ec.ECDH</code>, <code>ec.ECDSA</code>）。</li></ul><blockquote><p><strong>注释：</strong> 虽然 RSA 仍非常流行，但 ECC 代表了现代非对称加密的一个重要发展方向，尤其是在性能和效率方面。</p></blockquote><hr><h2 id="第十六章-操作数据库"><a href="#第十六章-操作数据库" class="headerlink" title="第十六章 操作数据库"></a>第十六章 操作数据库</h2><p>本章核心：通过<strong>实现一个分层架构的 SQLite 操作框架</strong>，深入学习 Python 数据库交互的最佳实践。我们将涵盖从数据库连接管理、模型定义、数据访问到业务逻辑的完整流程。</p><h3 id="16-1-SQLite-数据库：构建一个分层操作框架"><a href="#16-1-SQLite-数据库：构建一个分层操作框架" class="headerlink" title="16.1 SQLite 数据库：构建一个分层操作框架"></a>16.1 SQLite 数据库：构建一个分层操作框架</h3><p><strong>核心特性:</strong> 内置、无服务器、单文件数据库。遵循 DB-API 2.0 规范。</p><p><strong>常用 API 参考表:</strong></p><table><thead><tr><th align="left">API</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>sqlite3.connect(database, ...)</code></td><td align="left">连接数据库文件，返回 <code>Connection</code> 对象。</td></tr><tr><td align="left"><code>connection.cursor()</code></td><td align="left">创建 <code>Cursor</code> 对象。</td></tr><tr><td align="left"><code>cursor.execute(sql, parameters)</code></td><td align="left">执行单条 SQL (用 <code>?</code> 占位符)。</td></tr><tr><td align="left"><code>cursor.executemany(sql, seq_of_params)</code></td><td align="left">批量执行 SQL。</td></tr><tr><td align="left"><code>connection.commit()</code></td><td align="left">提交事务。</td></tr><tr><td align="left"><code>connection.rollback()</code></td><td align="left">回滚事务。</td></tr><tr><td align="left"><code>cursor.fetchone()</code></td><td align="left">获取下一行结果 (元组或 Row 对象)，无结果时 <code>None</code>。</td></tr><tr><td align="left"><code>cursor.fetchall()</code></td><td align="left">获取所有剩余行结果 (元组或 Row 对象的列表)。</td></tr><tr><td align="left"><code>cursor.lastrowid</code></td><td align="left">(属性) 最后 INSERT 的行的 ROWID。</td></tr><tr><td align="left"><code>cursor.rowcount</code></td><td align="left">(属性) 最后 DML 操作影响的行数 (-1 表示不确定或不适用)。</td></tr><tr><td align="left"><code>connection.close()</code></td><td align="left">关闭连接。</td></tr><tr><td align="left"><code>connection.row_factory = sqlite3.Row</code></td><td align="left">(设置) 让查询结果可以通过列名访问（类似字典）。</td></tr><tr><td align="left"><code>sqlite3.Binary(bytes)</code></td><td align="left">用于封装要存入 BLOB 字段的二进制数据。</td></tr><tr><td align="left"><code>with sqlite3.connect(...) as conn:</code></td><td align="left">(推荐) 使用上下文管理器，自动处理连接关闭和基本事务。</td></tr></tbody></table><hr><p><strong>框架实现步骤</strong></p><h4 id="16-1-1-项目结构设置"><a href="#16-1-1-项目结构设置" class="headerlink" title="16.1.1 项目结构设置"></a>16.1.1 项目结构设置</h4><p>我们创建以下目录结构，并在每个目录中放入 <code>__init__.py</code> 文件使其成为 Python 包：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">sqlite_practice/  </span><br><span class="line">├── core/                     # 核心功能模块  </span><br><span class="line">│   ├── __init__.py  </span><br><span class="line">│   ├── db_manager.py         # 数据库连接管理  </span><br><span class="line">│   └── table_manager.py      # 表结构管理  </span><br><span class="line">├── models/                   # 数据模型  </span><br><span class="line">│   ├── __init__.py  </span><br><span class="line">│   └── task.py               # 任务数据模型  </span><br><span class="line">├── repositories/             # 数据访问层  </span><br><span class="line">│   ├── __init__.py  </span><br><span class="line">│   └── task_repository.py    # 任务数据访问  </span><br><span class="line">├── services/                 # 业务逻辑层  </span><br><span class="line">│   ├── __init__.py  </span><br><span class="line">│   └── task_service.py       # 任务业务逻辑  </span><br><span class="line">├── utils/                    # 工具类  </span><br><span class="line">│   ├── __init__.py  </span><br><span class="line">│   └── date_utils.py         # 日期处理工具(被删减了)</span><br><span class="line">├── examples/                 # 示例代码  </span><br><span class="line">│   ├── __init__.py  </span><br><span class="line">│   ├── basic_operations.py   # 基本操作示例  </span><br><span class="line">│   ├── advanced_queries_oop.py   # 高级查询示例  </span><br><span class="line">│  </span><br><span class="line">└── README.md                 # 项目说明文档  </span><br></pre></td></tr></tbody></table></figure><p><strong>要点:</strong></p><ul><li><p>每个目录下的 <code>__init__.py</code> 文件（可以是空文件）是必需的，它告诉 Python 这个目录应该被视为一个<strong>包 (Package)</strong>，从而允许我们使用点号 <code>.</code> 来导入其中的模块（例如 <code>from core.db_manager import DatabaseManager</code>）。</p></li><li><p>这种结构实现了</p><p>关注点分离</p><ul><li><code>models</code> 只关心数据长什么样。</li><li><code>repositories</code> 只关心如何从数据库存取这些数据。</li><li><code>services</code> 只关心如何使用这些数据来完成业务目标。</li><li><code>core</code> 提供底层的数据库连接等基础服务。</li></ul></li></ul><h4 id="16-1-2-核心层实现-core"><a href="#16-1-2-核心层实现-core" class="headerlink" title="16.1.2 核心层实现 (core/)"></a>16.1.2 核心层实现 (<code>core/</code>)</h4><h5 id="数据库管理器-core-db-manager-py"><a href="#数据库管理器-core-db-manager-py" class="headerlink" title="数据库管理器 (core/db_manager.py)"></a>数据库管理器 (<code>core/db_manager.py</code>)</h5><p>此类负责管理数据库连接，提供连接、关闭及上下文管理 (<code>with</code> 语句) 支持。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">任务数据模型模块，定义Task相关的数据结构。</span></span><br><span class="line"><span class="string"># sqlite_practice/models/task.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field, asdict</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span>:</span><br><span class="line">    <span class="string">"""任务数据模型类，使用dataclass简化代码"""</span></span><br><span class="line">    title: <span class="built_in">str</span>  <span class="comment"># 任务标题（必填）</span></span><br><span class="line">    priority: <span class="built_in">int</span> = <span class="number">3</span>  <span class="comment"># 优先级（默认3）</span></span><br><span class="line">    is_completed: <span class="built_in">bool</span> = <span class="literal">False</span>  <span class="comment"># 是否完成（默认False）</span></span><br><span class="line"></span><br><span class="line">    task_id: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>  <span class="comment"># 任务ID（可选，若不指定，则由数据库自动生成）</span></span><br><span class="line">    due_date: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>  <span class="comment"># 截止日期（可选</span></span><br><span class="line">    attachment: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>  <span class="comment"># 附件（可选）</span></span><br><span class="line">    created_at: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>  <span class="comment"># 创建时间（可选）</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>  <span class="comment"># 任务描述（可选）</span></span><br><span class="line">    last_updated: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>  <span class="comment"># 最后更新时间（可选）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__post_init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""dataclass提供的初始化后自动执行的函数，用于设置默认值"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.created_at <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment">#  如果没有提供当前创建时间，则使用当前时间</span></span><br><span class="line">            <span class="variable language_">self</span>.created_at = datetime.now().strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">        <span class="string">"""将对象转换为字典，用于数据库操作</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            dict: 包含任务数据的字典</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 使用dataclasses.asdict获取基础字典</span></span><br><span class="line">        task_dict = asdict(<span class="variable language_">self</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># SQLite中布尔值以0/1存储，需要转换</span></span><br><span class="line">        task_dict[<span class="string">'is_completed'</span>] = <span class="number">1</span> <span class="keyword">if</span> <span class="variable language_">self</span>.is_completed <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果task_id为None，从字典中移除它</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.task_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            task_dict.pop(<span class="string">'task_id'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> task_dict</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">from_row</span>(<span class="params">cls, row</span>) -&gt; <span class="string">'Task'</span>:</span><br><span class="line">        <span class="string">"""从数据库行创建Task对象</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        这个方法的作用是将数据库查询结果（SQLite行数据）转换为Task对象。</span></span><br><span class="line"><span class="string">        看起来复杂是因为它需要处理多种可能的输入格式：</span></span><br><span class="line"><span class="string">        1. sqlite3.Row对象（有keys方法的字典类对象）</span></span><br><span class="line"><span class="string">        2. 元组或列表形式的结果</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        虽然dataclass简化了类定义，但不能自动处理从外部数据源（如数据库）</span></span><br><span class="line"><span class="string">        创建对象的过程，尤其是当数据需要类型转换时（如整数到布尔值）。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        这种复杂性是为了提高代码的健壮性，确保从不同来源的数据都能正确转换为Task对象。</span></span><br><span class="line"><span class="string">        如果确定数据库始终返回同一格式的结果，可以简化此方法。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            row: sqlite3.Row对象或类似字典/序列的对象</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Task: 创建的Task对象</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 创建一个包含所有可能属性的字典</span></span><br><span class="line">        task_data = {}</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查row中是否有每个属性并添加到task_data</span></span><br><span class="line">        <span class="comment"># 使用get方法避免KeyError</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(row, <span class="string">'keys'</span>):</span><br><span class="line">            <span class="comment"># 如果row有keys方法（如sqlite3.Row），使用它</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> row.keys():</span><br><span class="line">                task_data[key] = row[key]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 否则尝试按照索引获取</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                task_data = {</span><br><span class="line">                    <span class="string">'task_id'</span>: row[<span class="number">0</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">'title'</span>: row[<span class="number">1</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">'description'</span>: row[<span class="number">2</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">2</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">'priority'</span>: row[<span class="number">3</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">3</span> <span class="keyword">else</span> <span class="number">3</span>,</span><br><span class="line">                    <span class="string">'due_date'</span>: row[<span class="number">4</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">4</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">'is_completed'</span>: <span class="built_in">bool</span>(row[<span class="number">5</span>]) <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">5</span> <span class="keyword">else</span> <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">'attachment'</span>: row[<span class="number">6</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">6</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">'created_at'</span>: row[<span class="number">7</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">7</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">'last_updated'</span>: row[<span class="number">8</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">8</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">                }</span><br><span class="line">            <span class="keyword">except</span> (IndexError, TypeError):</span><br><span class="line">                <span class="comment"># 如果索引访问失败，返回具有默认值的Task</span></span><br><span class="line">                <span class="keyword">return</span> cls(title=<span class="string">"Unknown"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理布尔值转换</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'is_completed'</span> <span class="keyword">in</span> task_data:</span><br><span class="line">            task_data[<span class="string">'is_completed'</span>] = <span class="built_in">bool</span>(task_data[<span class="string">'is_completed'</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建并返回Task对象</span></span><br><span class="line">        <span class="keyword">return</span> cls(**task_data) </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="表管理器-core-table-manager-py"><a href="#表管理器-core-table-manager-py" class="headerlink" title="表管理器 (core/table_manager.py)"></a>表管理器 (<code>core/table_manager.py</code>)</h5><p>​	`</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">表管理模块，负责SQLite数据库表的创建和基础操作。</span></span><br><span class="line"><span class="string">提供表结构定义、创建、修改等功能。</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TableManager</span>:</span><br><span class="line">    <span class="string">"""表管理类，负责SQLite数据库表的创建和操作"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, conn: sqlite3.Connection, cursor: sqlite3.Cursor</span>):</span><br><span class="line">        <span class="string">"""初始化表管理器</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            conn: 数据库连接对象</span></span><br><span class="line"><span class="string">            cursor: 数据库游标对象</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="variable language_">self</span>.conn = conn</span><br><span class="line">        <span class="variable language_">self</span>.cursor = cursor</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_table</span>(<span class="params">self, table_name: <span class="built_in">str</span>, columns: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""创建数据库表</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            table_name: 表名</span></span><br><span class="line"><span class="string">            columns: 表列定义字典，格式为 {列名: 列类型}</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 表创建是否成功</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 确保连接和游标有效</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.conn <span class="keyword">or</span> <span class="keyword">not</span> <span class="variable language_">self</span>.cursor:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"[Error] 数据库连接或游标无效"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                </span><br><span class="line">            <span class="comment"># 构建列定义字符串</span></span><br><span class="line">            columns_def = []</span><br><span class="line">            <span class="keyword">for</span> col_name, col_type <span class="keyword">in</span> columns.items():</span><br><span class="line">                columns_def.append(<span class="string">f"<span class="subst">{col_name}</span> <span class="subst">{col_type}</span>"</span>)</span><br><span class="line"></span><br><span class="line">            create_table_sql = <span class="string">f'''CREATE TABLE IF NOT EXISTS <span class="subst">{table_name}</span> (</span></span><br><span class="line"><span class="string">                <span class="subst">{<span class="string">', '</span>.join(columns_def)}</span></span></span><br><span class="line"><span class="string">            )'''</span></span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(create_table_sql)</span><br><span class="line">            <span class="variable language_">self</span>.conn.commit()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Setup] 表 '<span class="subst">{table_name}</span>' 已检查/创建。"</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 创建表 '<span class="subst">{table_name}</span>' 时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_column</span>(<span class="params">self, table_name: <span class="built_in">str</span>, column_name: <span class="built_in">str</span>, column_type: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""向已有表添加新列</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            table_name: 表名</span></span><br><span class="line"><span class="string">            column_name: 列名</span></span><br><span class="line"><span class="string">            column_type: 列类型和约束</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 添加列是否成功</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            alter_sql = <span class="string">f"ALTER TABLE <span class="subst">{table_name}</span> ADD COLUMN <span class="subst">{column_name}</span> <span class="subst">{column_type}</span>"</span></span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(alter_sql)</span><br><span class="line">            <span class="variable language_">self</span>.conn.commit()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Setup] 已向表 '<span class="subst">{table_name}</span>' 添加列 '<span class="subst">{column_name}</span> <span class="subst">{column_type}</span>'"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 向表 '<span class="subst">{table_name}</span>' 添加列时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">table_exists</span>(<span class="params">self, table_name: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""检查表是否存在</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            table_name: 表名</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 表是否存在</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(<span class="string">f"SELECT name FROM sqlite_master WHERE type='table' AND name=?"</span>, (table_name,))</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.cursor.fetchone() <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 检查表 '<span class="subst">{table_name}</span>' 是否存在时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_table_info</span>(<span class="params">self, table_name: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">"""获取表结构信息</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            table_name: 表名</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            list: 包含列信息的字典列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(<span class="string">f"PRAGMA table_info(<span class="subst">{table_name}</span>)"</span>)</span><br><span class="line">            columns = []</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> <span class="variable language_">self</span>.cursor.fetchall():</span><br><span class="line">                column_info = {</span><br><span class="line">                    <span class="string">'cid'</span>: row[<span class="string">'cid'</span>],</span><br><span class="line">                    <span class="string">'name'</span>: row[<span class="string">'name'</span>],</span><br><span class="line">                    <span class="string">'type'</span>: row[<span class="string">'type'</span>],</span><br><span class="line">                    <span class="string">'notnull'</span>: row[<span class="string">'notnull'</span>],</span><br><span class="line">                    <span class="string">'default_value'</span>: row[<span class="string">'dflt_value'</span>],</span><br><span class="line">                    <span class="string">'pk'</span>: row[<span class="string">'pk'</span>]</span><br><span class="line">                }</span><br><span class="line">                columns.append(column_info)</span><br><span class="line">            <span class="keyword">return</span> columns</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 获取表 '<span class="subst">{table_name}</span>' 信息时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> [] </span><br></pre></td></tr></tbody></table></figure><h4 id="16-1-3-数据模型层实现-models"><a href="#16-1-3-数据模型层实现-models" class="headerlink" title="16.1.3 数据模型层实现 (models/)"></a>16.1.3 数据模型层实现 (<code>models/</code>)</h4><h5 id="前置知识：使用-dataclass-简化-Python-类定义"><a href="#前置知识：使用-dataclass-简化-Python-类定义" class="headerlink" title="前置知识：使用 @dataclass 简化 Python 类定义"></a>前置知识：使用 <code>@dataclass</code> 简化 Python 类定义</h5><p>在定义 <code>Task</code> 模型之前，我们先了解一下 Python 3.7+ 引入的一个非常有用的工具：<code>@dataclass</code> 装饰器。它能极大地简化用于存储数据的类的编写。</p><blockquote><p><code>dataclass</code> 是从 Python 3.7 版本开始，作为标准库 <code>dataclasses</code> 中的模块被引入的。 随着 Python 版本的不断更新，<code>dataclass</code> 也逐步发展和完善，为 Python 开发者提供了更加便捷的数据类创建和管理方式。</p><p><code>dataclass</code> 的主要功能在于帮助我们<strong>简化数据类的定义过程</strong>。 本文总结了几个我们在此框架中会用到的 <code>dataclass</code> 技巧。</p></blockquote><p><strong>1. 传统的类定义方式</strong></p><p>回顾一下，如果不用 <code>dataclass</code>，定义一个简单的 <code>CoinTrans</code> 类（包含交易 ID, 交易对, 价格, 是否成功, 地址列表）大致如下：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 传统方式定义类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoinTransTraditional</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        <span class="built_in">id</span>: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        symbol: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        price: <span class="built_in">float</span>,</span></span><br><span class="line"><span class="params">        is_success: <span class="built_in">bool</span>,</span></span><br><span class="line"><span class="params">        addrs: <span class="built_in">list</span>,</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.<span class="built_in">id</span> = <span class="built_in">id</span></span><br><span class="line">        <span class="variable language_">self</span>.symbol = symbol</span><br><span class="line">        <span class="variable language_">self</span>.price = price</span><br><span class="line">        <span class="variable language_">self</span>.is_success = is_success </span><br><span class="line">        <span class="variable language_">self</span>.addrs = addrs</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 为了方便打印，需要自己实现 __str__ 或 __repr__</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="comment"># repr 通常返回更详细、无歧义的表示</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="string">f"CoinTransTraditional(id='<span class="subst">{self.<span class="built_in">id</span>}</span>', symbol='<span class="subst">{self.symbol}</span>', "</span></span><br><span class="line">                <span class="string">f"price=<span class="subst">{self.price}</span>, is_success=<span class="subst">{self.is_success}</span>, addrs=<span class="subst">{self.addrs}</span>)"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用传统类</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    coin_trans_trad = CoinTransTraditional(<span class="string">"id01"</span>, <span class="string">"BTC/USDT"</span>, <span class="number">71000.0</span>, <span class="literal">True</span>, [<span class="string">"0x1111"</span>, <span class="string">"0x2222"</span>])</span><br><span class="line">    <span class="comment"># 需要实现 __repr__ 或 __str__ 才能得到有意义的打印输出</span></span><br><span class="line">    <span class="built_in">print</span>(coin_trans_trad) </span><br></pre></td></tr></tbody></table></figure><p>如你所见，我们需要编写 <code>__init__</code> 方法来初始化所有属性，还需要编写 <code>__repr__</code> (或 <code>__str__</code>) 方法才能方便地打印对象内容。</p><p><strong>2. 使用 <code>@dataclass</code> 装饰器定义类</strong></p><p>现在看看用 <code>@dataclass</code> 有多简单：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field <span class="comment"># 导入 dataclass 和 field</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span> <span class="comment"># 使用 List 进行类型提示</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 @dataclass 装饰器</span></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoinTransDataclass</span>:</span><br><span class="line">    <span class="comment"># 只需声明属性及其类型提示</span></span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">str</span></span><br><span class="line">    symbol: <span class="built_in">str</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    is_success: <span class="built_in">bool</span></span><br><span class="line">    addrs: <span class="type">List</span>[<span class="built_in">str</span>] <span class="comment"># 使用 List[str] 提供更精确的类型提示</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 dataclass</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    coin_trans_dc = CoinTransDataclass(<span class="string">"id01"</span>, <span class="string">"BTC/USDT"</span>, <span class="number">71000.0</span>, <span class="literal">True</span>, [<span class="string">"0x1111"</span>, <span class="string">"0x2222"</span>])</span><br><span class="line">    <span class="comment"># dataclass 自动生成了 __init__ 和 __repr__ 方法！</span></span><br><span class="line">    <span class="built_in">print</span>(coin_trans_dc) </span><br></pre></td></tr></tbody></table></figure><p>运行结果会直接打印出易于阅读的对象表示：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CoinTransDataclass(id='id01', symbol='BTC/USDT', price=71000.0, is_success=True, addrs=['0x1111', '0x2222'])</span><br></pre></td></tr></tbody></table></figure><p><strong>关键优势:</strong></p><ul><li><strong>自动生成方法:</strong> <code>@dataclass</code> 会自动为你生成 <code>__init__</code>、<code>__repr__</code>、<code>__eq__</code> (等值比较) 等常用方法，大大减少样板代码。</li><li><strong>类型提示:</strong> 它强制（或强烈推荐）使用类型提示，有助于代码清晰度和静态分析。</li></ul><p><strong>2.1 默认值与 <code>default_factory</code></strong></p><p>设置默认值很简单，直接在属性后面赋值即可。但对于<strong>可变类型</strong>（如 <code>list</code>, <code>dict</code>）作为默认值，直接赋值会引发 <code>ValueError</code>，因为所有实例会共享同一个可变对象，这通常不是我们想要的。需要使用 <code>field</code> 函数和 <code>default_factory</code> 来指定一个<strong>工厂函数</strong>（一个无参可调用对象，返回默认值）。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 工厂函数，用于生成默认的列表</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">default_addr_list</span>() -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"  (调用了 default_addr_list 工厂函数)"</span>) <span class="comment"># 演示工厂函数何时被调用</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="string">"0xdefault1"</span>, <span class="string">"0xdefault2"</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoinTransWithDefaults</span>:</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">str</span> = <span class="string">"default_id"</span>       <span class="comment"># 字符串默认值</span></span><br><span class="line">    symbol: <span class="built_in">str</span> = <span class="string">"BTC/USDT"</span>     <span class="comment"># 字符串默认值</span></span><br><span class="line">    price: <span class="built_in">float</span> = <span class="number">0.0</span>           <span class="comment"># 数值默认值</span></span><br><span class="line">    is_success: <span class="built_in">bool</span> = <span class="literal">False</span>     <span class="comment"># 布尔默认值</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 对于 list (可变类型)，使用 default_factory 指定生成函数</span></span><br><span class="line">    addrs: <span class="type">List</span>[<span class="built_in">str</span>] = field(default_factory=default_addr_list) </span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 另一个例子: 默认空列表</span></span><br><span class="line">    <span class="comment"># related_ids: List[str] = field(default_factory=list)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用带默认值的 dataclass</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n--- Dataclass 默认值示例 ---"</span>)</span><br><span class="line">    <span class="comment"># 不提供参数，将使用默认值</span></span><br><span class="line">    default_trans = CoinTransWithDefaults() </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"创建第一个实例:"</span>)</span><br><span class="line">    <span class="built_in">print</span>(default_trans)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 再创建一个实例，验证列表是独立的</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"创建第二个实例:"</span>)</span><br><span class="line">    another_default = CoinTransWithDefaults()</span><br><span class="line">    <span class="built_in">print</span>(another_default)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 修改第一个实例的列表，不应影响第二个</span></span><br><span class="line">    default_trans.addrs.append(<span class="string">"0xadded"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"修改第一个实例的 addrs 后:"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  实例1: <span class="subst">{default_trans}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  实例2: <span class="subst">{another_default}</span>"</span>) <span class="comment"># 实例2的列表未受影响</span></span><br></pre></td></tr></tbody></table></figure><p><strong>2.2 隐藏敏感信息 (<code>repr=False</code>)</strong></p><p>如果你不希望某些字段出现在 <code>print()</code> (即 <code>__repr__</code>) 的输出中（例如密码、密钥等），可以在 <code>field</code> 中设置 <code>repr=False</code>。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SensitiveData</span>:</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    session_id: <span class="built_in">str</span></span><br><span class="line">    <span class="comment"># 不希望 token 出现在 repr 输出中</span></span><br><span class="line">    token: <span class="built_in">str</span> = field(<span class="built_in">repr</span>=<span class="literal">False</span>) </span><br><span class="line">    <span class="comment"># 也可以给 token 设置默认值或 default_factory</span></span><br><span class="line">    <span class="comment"># token: str = field(default="dummy_token", repr=False) </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">     <span class="built_in">print</span>(<span class="string">"\n--- Dataclass 隐藏字段示例 ---"</span>)</span><br><span class="line">     data = SensitiveData(<span class="string">"user1"</span>, <span class="string">"sess123"</span>, token=<span class="string">"secret_token_value"</span>)</span><br><span class="line">     <span class="built_in">print</span>(data) <span class="comment"># 输出中不会包含 token</span></span><br><span class="line">     <span class="comment"># 但仍然可以访问该属性</span></span><br><span class="line">     <span class="built_in">print</span>(<span class="string">f"  访问隐藏的 token: <span class="subst">{data.token}</span>"</span>) </span><br></pre></td></tr></tbody></table></figure><p><strong>2.3 只读对象 (<code>frozen=True</code>)</strong></p><p>如果你希望创建的对象是<strong>不可变</strong>的（创建后其属性值不能被修改），可以在 <code>@dataclass</code> 装饰器中设置 <code>frozen=True</code>。这对于表示常量数据或确保数据不被意外篡改很有用。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>) </span><span class="comment"># 设置为只读</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ImmutablePoint</span>:</span><br><span class="line">    x: <span class="built_in">float</span></span><br><span class="line">    y: <span class="built_in">float</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">     <span class="built_in">print</span>(<span class="string">"\n--- Dataclass 只读对象示例 ---"</span>)</span><br><span class="line">     p = ImmutablePoint(<span class="number">1.0</span>, <span class="number">2.0</span>)</span><br><span class="line">     <span class="built_in">print</span>(p)</span><br><span class="line">     <span class="comment"># 尝试修改属性会抛出 FrozenInstanceError</span></span><br><span class="line">     <span class="keyword">try</span>:</span><br><span class="line">         p.x = <span class="number">5.0</span> </span><br><span class="line">     <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">         <span class="built_in">print</span>(<span class="string">f"  尝试修改只读对象失败: <span class="subst">{<span class="built_in">type</span>(e).__name__}</span>: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><p><strong>2.4 转换为元组和字典 (<code>astuple</code>, <code>asdict</code>)</strong></p><p><code>dataclasses</code> 模块提供了 <code>astuple</code> 和 <code>asdict</code> 函数，可以方便地将 dataclass 实例转换为元组或字典，这在与其他库或模块交互时非常方便。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> astuple, asdict, dataclass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleConfig</span>:</span><br><span class="line">    host: <span class="built_in">str</span> = <span class="string">"localhost"</span></span><br><span class="line">    port: <span class="built_in">int</span> = <span class="number">8080</span></span><br><span class="line">    debug_mode: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n--- Dataclass 转换示例 ---"</span>)</span><br><span class="line">    config = SimpleConfig(port=<span class="number">9000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 转换为元组</span></span><br><span class="line">    config_tuple = astuple(config)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  转换为元组: <span class="subst">{config_tuple}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 转换为字典</span></span><br><span class="line">    config_dict = asdict(config)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  转换为字典: <span class="subst">{config_dict}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><p><strong>总结 (<code>@dataclass</code>)</strong></p><blockquote><p>在 Python 中，数据类主要用于存储数据。 定义数据类时，通常需要编写一些重复性的代码，如构造函数 (<code>__init__</code>)、字符串表示 (<code>__repr__</code>, <code>__str__</code>) 等。 <code>@dataclass</code> 装饰器的出现，使得这些通用方法的生成变得自动化，从而极大地简化了数据类的定义过程，提高了开发效率，是我们在数据建模时非常有用的工具。</p></blockquote><p>现在，我们将使用 <code>@dataclass</code> 来定义我们的 <code>Task</code> 模型。</p><h5 id="任务模型-models-task-py-使用-dataclass"><a href="#任务模型-models-task-py-使用-dataclass" class="headerlink" title="任务模型 (models/task.py - 使用 @dataclass)"></a>任务模型 (<code>models/task.py</code> - 使用 @dataclass)</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">任务数据模型模块，定义Task相关的数据结构。</span></span><br><span class="line"><span class="string"># sqlite_practice/models/task.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span>:</span><br><span class="line">    <span class="string">"""任务数据模型类，使用dataclass简化代码"""</span></span><br><span class="line">    </span><br><span class="line">    title: <span class="built_in">str</span>  <span class="comment"># 任务标题，必填</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>  <span class="comment"># 任务描述，可选</span></span><br><span class="line">    priority: <span class="built_in">int</span> = <span class="number">3</span>  <span class="comment"># 优先级，默认为3</span></span><br><span class="line">    due_date: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>  <span class="comment"># 截止日期，可选</span></span><br><span class="line">    is_completed: <span class="built_in">bool</span> = <span class="literal">False</span>  <span class="comment"># 是否完成，默认为False</span></span><br><span class="line">    attachment: <span class="type">Optional</span>[<span class="built_in">bytes</span>] = <span class="literal">None</span>  <span class="comment"># 附件，可选</span></span><br><span class="line">    created_at: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>  <span class="comment"># 创建时间，可选</span></span><br><span class="line">    last_updated: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>  <span class="comment"># 最后更新时间，可选</span></span><br><span class="line">    task_id: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>  <span class="comment"># 任务ID，由数据库生成</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__post_init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""对象初始化后运行的方法，用于设置默认值"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.created_at <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 如果没有提供创建时间，设置为当前时间</span></span><br><span class="line">            <span class="variable language_">self</span>.created_at = datetime.now().strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">        <span class="string">"""将对象转换为字典，用于数据库操作</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            dict: 包含任务数据的字典</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        task_dict = {</span><br><span class="line">            <span class="string">'title'</span>: <span class="variable language_">self</span>.title,</span><br><span class="line">            <span class="string">'description'</span>: <span class="variable language_">self</span>.description,</span><br><span class="line">            <span class="string">'priority'</span>: <span class="variable language_">self</span>.priority,</span><br><span class="line">            <span class="string">'due_date'</span>: <span class="variable language_">self</span>.due_date,</span><br><span class="line">            <span class="string">'is_completed'</span>: <span class="number">1</span> <span class="keyword">if</span> <span class="variable language_">self</span>.is_completed <span class="keyword">else</span> <span class="number">0</span>,  <span class="comment"># SQLite中布尔值以0/1存储</span></span><br><span class="line">            <span class="string">'attachment'</span>: <span class="variable language_">self</span>.attachment,</span><br><span class="line">            <span class="string">'created_at'</span>: <span class="variable language_">self</span>.created_at,</span><br><span class="line">            <span class="string">'last_updated'</span>: <span class="variable language_">self</span>.last_updated</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 只有在task_id存在时才添加到字典中</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.task_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            task_dict[<span class="string">'task_id'</span>] = <span class="variable language_">self</span>.task_id</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> task_dict</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">from_row</span>(<span class="params">cls, row</span>) -&gt; <span class="string">'Task'</span>:</span><br><span class="line">        <span class="string">"""从数据库行创建Task对象</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            row: sqlite3.Row对象或类似字典的对象</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Task: 创建的Task对象</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 创建一个包含所有可能属性的字典</span></span><br><span class="line">        task_data = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查row中是否有每个属性并添加到task_data</span></span><br><span class="line">        <span class="comment"># 使用get方法避免KeyError</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(row, <span class="string">'keys'</span>):</span><br><span class="line">            <span class="comment"># 如果row有keys方法（如sqlite3.Row），使用它</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> row.keys():</span><br><span class="line">                task_data[key] = row[key]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 否则尝试按照索引获取</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                task_data = {</span><br><span class="line">                    <span class="string">'task_id'</span>: row[<span class="number">0</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">'title'</span>: row[<span class="number">1</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">'description'</span>: row[<span class="number">2</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">2</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">'priority'</span>: row[<span class="number">3</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">3</span> <span class="keyword">else</span> <span class="number">3</span>,</span><br><span class="line">                    <span class="string">'due_date'</span>: row[<span class="number">4</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">4</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">'is_completed'</span>: <span class="built_in">bool</span>(row[<span class="number">5</span>]) <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">5</span> <span class="keyword">else</span> <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">'attachment'</span>: row[<span class="number">6</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">6</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">'created_at'</span>: row[<span class="number">7</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">7</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">'last_updated'</span>: row[<span class="number">8</span>] <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; <span class="number">8</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">                }</span><br><span class="line">            <span class="keyword">except</span> (IndexError, TypeError):</span><br><span class="line">                <span class="comment"># 如果索引访问失败，返回具有默认值的Task</span></span><br><span class="line">                <span class="keyword">return</span> cls(title=<span class="string">"Unknown"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 处理布尔值转换</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'is_completed'</span> <span class="keyword">in</span> task_data:</span><br><span class="line">            task_data[<span class="string">'is_completed'</span>] = <span class="built_in">bool</span>(task_data[<span class="string">'is_completed'</span>])</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 创建并返回Task对象</span></span><br><span class="line">        <span class="keyword">return</span> cls(**task_data) </span><br></pre></td></tr></tbody></table></figure><p><strong>知识点解释 (<code>@dataclass</code> 版 <code>Task</code>):</strong></p><ul><li><strong><code>@dataclass</code> 装饰器:</strong> 应用在类定义之前，自动添加 <code>__init__</code>, <code>__repr__</code>, <code>__eq__</code> 等方法。</li><li><strong>属性定义与类型提示:</strong> 直接在类级别声明属性及其类型 (<code>title: str</code>, <code>priority: int = 3</code>)。<code>Optional[T]</code> 表示该属性可以是 <code>T</code> 类型或 <code>None</code>。</li><li><strong>默认值:</strong> 直接在属性声明后赋值即可为非可变类型设置默认值 (<code>priority: int = 3</code>)。</li><li><strong><code>field()</code> 函数 (可选):</strong> 用于更精细地控制字段行为，如设置 <code>default_factory</code> (用于可变默认值，本例未使用但已在知识点中介绍), <code>repr=False</code> (不在打印输出中显示), <code>init=False</code> (不由 <code>__init__</code> 初始化), <code>compare=False</code> (不在等值比较中考虑) 等。</li><li><strong><code>to_dict()</code> 方法:</strong> 方便将对象状态转换为字典，特别用于准备插入或更新到数据库的数据。注意这里手动处理了 <code>is_completed</code> 从 <code>bool</code> 到 <code>int</code> 的转换，以匹配 SQLite 的存储方式。</li><li><strong><code>@classmethod from_row(cls, row)</code>:</strong> 这是一个<strong>类方法</strong>（第一个参数是类本身 <code>cls</code>，而不是实例 <code>self</code>），专门用于从数据库返回的行数据（这里是 <code>sqlite3.Row</code> 对象）创建 <code>Task</code> 类的实例。这是将数据库数据映射回对象的常用模式。它负责处理列名到属性的映射和必要的数据类型转换（如 <code>bool(row['is_completed'])</code>）。增加了错误处理，确保输入有效。</li></ul><h4 id="16-1-4-数据访问层实现-repositories"><a href="#16-1-4-数据访问层实现-repositories" class="headerlink" title="16.1.4 数据访问层实现 (repositories/)"></a>16.1.4 数据访问层实现 (<code>repositories/</code>)</h4><h5 id="任务仓库-repositories-task-repository-py"><a href="#任务仓库-repositories-task-repository-py" class="headerlink" title="任务仓库 (repositories/task_repository.py )"></a>任务仓库 (<code>repositories/task_repository.py</code> )</h5><p>此类封装所有与 <code>tasks</code> 表相关的 SQL 操作，并使用 <code>Task</code> dataclass 进行数据交互。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">任务数据访问层模块，实现对Task数据的CRUD操作。</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">from</span> models.task <span class="keyword">import</span> Task</span><br><span class="line"><span class="keyword">from</span> core.table_manager <span class="keyword">import</span> TableManager</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaskRepository</span>:</span><br><span class="line">    <span class="string">"""任务数据访问类，实现对Task表的增删改查操作"""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, conn: sqlite3.Connection, cursor: sqlite3.Cursor</span>):</span><br><span class="line">        <span class="variable language_">self</span>.conn = conn</span><br><span class="line">        <span class="variable language_">self</span>.cursor = cursor</span><br><span class="line">        <span class="variable language_">self</span>.table_name = <span class="string">'tasks'</span>  <span class="comment"># 表名</span></span><br><span class="line">        <span class="variable language_">self</span>.table_manager = TableManager(<span class="variable language_">self</span>.conn, <span class="variable language_">self</span>.cursor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_table</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""创建任务表"""</span></span><br><span class="line">        columns = {</span><br><span class="line">            <span class="string">"task_id"</span>: <span class="string">"INTEGER PRIMARY KEY AUTOINCREMENT"</span>,  <span class="comment"># 任务ID</span></span><br><span class="line">            <span class="string">"title"</span>: <span class="string">"TEXT NOT NULL"</span>,  <span class="comment"># 任务标题</span></span><br><span class="line">            <span class="string">"description"</span>: <span class="string">"TEXT"</span>,  <span class="comment"># 任务描述</span></span><br><span class="line">            <span class="string">"priority"</span>: <span class="string">"INTEGER DEFAULT 3"</span>,  <span class="comment"># 优先级，默认3</span></span><br><span class="line">            <span class="string">"due_date"</span>: <span class="string">"DATE"</span>,  <span class="comment"># 截止日期</span></span><br><span class="line">            <span class="string">"is_completed"</span>: <span class="string">"BOOLEAN DEFAULT 0"</span>,  <span class="comment"># 是否完成，默认False</span></span><br><span class="line">            <span class="string">"attachment"</span>: <span class="string">"BLOB"</span>,  <span class="comment"># 附件，用于存储文件</span></span><br><span class="line">            <span class="string">"created_at"</span>: <span class="string">"TIMESTAMP DEFAULT CURRENT_TIMESTAMP"</span>,  <span class="comment"># 创建时间</span></span><br><span class="line">            <span class="string">"last_updated"</span>: <span class="string">"TIMESTAMP"</span>  <span class="comment"># 最后更新时间</span></span><br><span class="line">        }</span><br><span class="line">        <span class="comment"># 调用TableManager的create_table方法创建任务表</span></span><br><span class="line">        created_flag = <span class="variable language_">self</span>.table_manager.create_table(<span class="variable language_">self</span>.table_name, columns)</span><br><span class="line">        <span class="keyword">return</span> created_flag</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_column</span>(<span class="params">self, column_name: <span class="built_in">str</span>, column_type: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""向任务表添加新列</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            column_name: 新列名</span></span><br><span class="line"><span class="string">            column_type: 新列类型</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        added_flag = <span class="variable language_">self</span>.table_manager.add_column(<span class="variable language_">self</span>.table_name, column_name, column_type)</span><br><span class="line">        <span class="keyword">return</span> added_flag</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_table_info</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">"""获取任务表结构信息</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            list: 包含列信息的字典列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        table_info = <span class="variable language_">self</span>.table_manager.get_table_info(<span class="variable language_">self</span>.table_name)</span><br><span class="line">        <span class="keyword">return</span> table_info</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert_task</span>(<span class="params">self, task: Task</span>) -&gt; <span class="type">Optional</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">"""插入新任务</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task: Task对象</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            int: 新任务的ID，如果插入失败返回None</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 将Task对象转换为字典</span></span><br><span class="line">            task_dict = task.to_dict()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果存在task_id，则从字典中移除，因为它是自增的</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'task_id'</span> <span class="keyword">in</span> task_dict:</span><br><span class="line">                <span class="keyword">del</span> task_dict[<span class="string">'task_id'</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 构建INSERT语句</span></span><br><span class="line">            columns = <span class="string">', '</span>.join(task_dict.keys())</span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            placeholders的执行逻辑：类似于下方的代码</span></span><br><span class="line"><span class="string">            task_dict = {'task1': 'value1', 'task2': 'value2', 'task3': 'value3'}</span></span><br><span class="line"><span class="string">            question_marks = ', '.join(['?' for _ in task_dict])</span></span><br><span class="line"><span class="string">            print(question_marks)  # 输出: ?, ?, ?</span></span><br><span class="line"><span class="string">            '"""</span></span><br><span class="line">            placeholders = placeholders = <span class="string">', '</span>.join([<span class="string">'?'</span> <span class="keyword">for</span> _ <span class="keyword">in</span> task_dict])</span><br><span class="line">            values = <span class="built_in">tuple</span>(task_dict.values())</span><br><span class="line">            insert_sql = <span class="string">f"INSERT INTO <span class="subst">{self.table_name}</span> (<span class="subst">{columns}</span>) VALUES (<span class="subst">{placeholders}</span>)"</span></span><br><span class="line">            <span class="comment"># 执行插入操作</span></span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(insert_sql, values)</span><br><span class="line">            <span class="variable language_">self</span>.conn.commit()</span><br><span class="line">            <span class="comment"># 获取新插入记录的ID</span></span><br><span class="line">            inserted_id = <span class="variable language_">self</span>.cursor.lastrowid</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Info] 成功插入任务: '<span class="subst">{task.title}</span>', ID: <span class="subst">{inserted_id}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> inserted_id</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 任务插入失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="variable language_">self</span>.conn.rollback()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert_many</span>(<span class="params">self, tasks: <span class="type">List</span>[Task]</span>) -&gt; <span class="type">Optional</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">"""批量插入任务记录</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            tasks: 要插入的Task对象列表</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            int: 成功插入的记录数，如果插入失败则返回None</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 确保有任务要插入</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> tasks:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"[Warning] 没有任务要插入"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            <span class="comment"># 将所有Task对象转换为字典</span></span><br><span class="line">            task_dicts = [task.to_dict() <span class="keyword">for</span> task <span class="keyword">in</span> tasks]</span><br><span class="line">            <span class="comment"># 移除所有task_id，因为它们是自增的</span></span><br><span class="line">            <span class="keyword">for</span> task_dict <span class="keyword">in</span> task_dicts:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">'task_id'</span> <span class="keyword">in</span> task_dict:</span><br><span class="line">                    <span class="keyword">del</span> task_dict[<span class="string">'task_id'</span>]</span><br><span class="line">            <span class="comment"># 确保所有任务的字段相同</span></span><br><span class="line">            columns = <span class="built_in">list</span>(task_dicts[<span class="number">0</span>].keys())</span><br><span class="line">            placeholders = <span class="string">', '</span>.join([<span class="string">'?'</span> <span class="keyword">for</span> _ <span class="keyword">in</span> columns])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 构建INSERT语句</span></span><br><span class="line">            insert_sql = <span class="string">f"INSERT INTO <span class="subst">{self.table_name}</span> (<span class="subst">{<span class="string">', '</span>.join(columns)}</span>) VALUES (<span class="subst">{placeholders}</span>)"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 准备批量插入的值</span></span><br><span class="line">            <span class="comment"># 这段代码使用列表推导式创建一个包含所有任务数据的列表:</span></span><br><span class="line">            <span class="comment"># 1. 外层循环遍历每个任务字典(task_dicts中的每个task_dict)</span></span><br><span class="line">            <span class="comment"># 2. 内层循环按照columns中定义的列顺序提取每个任务字典中的值</span></span><br><span class="line">            <span class="comment"># 3. 使用tuple()将每个任务的值转换为元组，确保与executemany()方法兼容</span></span><br><span class="line">            <span class="comment"># 4. 最终生成的values是一个元组列表，每个元组包含一个任务的所有字段值</span></span><br><span class="line">            <span class="comment"># 例如: [(任务1的值1, 任务1的值2...), (任务2的值1, 任务2的值2...), ...]</span></span><br><span class="line">            values = [<span class="built_in">tuple</span>(task_dict[col] <span class="keyword">for</span> col <span class="keyword">in</span> columns) <span class="keyword">for</span> task_dict <span class="keyword">in</span> task_dicts]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Info] 准备批量插入<span class="subst">{<span class="built_in">len</span>(values)}</span>条任务"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 执行批量插入</span></span><br><span class="line">            <span class="variable language_">self</span>.cursor.executemany(insert_sql, values)</span><br><span class="line">            <span class="variable language_">self</span>.conn.commit()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取新插入记录的数量</span></span><br><span class="line">            inserted_count = <span class="variable language_">self</span>.cursor.rowcount</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Info] 成功插入<span class="subst">{inserted_count}</span>条任务"</span>)</span><br><span class="line">            <span class="keyword">return</span> inserted_count</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 任务插入失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="variable language_">self</span>.conn.rollback()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_task</span>(<span class="params">self, task: Task</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""更新任务记录</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task: 要更新的Task对象，必须包含task_id</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 是否更新成功</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 检查task_id是否存在</span></span><br><span class="line">            <span class="keyword">if</span> task.task_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"[Error] 无法更新任务：缺少task_id"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="comment"># 将Task对象转换为字典</span></span><br><span class="line">            task_dict = task.to_dict()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 从字典中移除task_id，他讲在WHERE子句中使用</span></span><br><span class="line">            task_id = task_dict.pop(<span class="string">'task_id'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 构建SET字句</span></span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            这将生成类似于下面的SQL语句：</span></span><br><span class="line"><span class="string">            UPDATE tasks SET title = 'task1', description = 'task1 description', priority = 1, due_date = '2022-01-01', is_completed = 1, attachment = b'123456', last_updated = '2022-01-01 00:00:00' WHERE task_id = 1</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">            set_clause = <span class="string">', '</span>.join([<span class="string">f"<span class="subst">{col}</span> = ?"</span> <span class="keyword">for</span> col <span class="keyword">in</span> task_dict.keys()])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 检查task_dict中是否已包含last_updated字段</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'last_updated'</span> <span class="keyword">not</span> <span class="keyword">in</span> task_dict:</span><br><span class="line">                <span class="comment"># 如果没有包含last_updated字段，则使用SQLite的CURRENT_TIMESTAMP函数</span></span><br><span class="line">                <span class="comment"># 这样可以确保last_updated字段使用数据库服务器的当前时间</span></span><br><span class="line">                set_clause += <span class="string">", last_updated = CURRENT_TIMESTAMP"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 构建UPDATE语句</span></span><br><span class="line">            update_sql = <span class="string">f"UPDATE <span class="subst">{self.table_name}</span> SET <span class="subst">{set_clause}</span> WHERE task_id = ?"</span></span><br><span class="line">            <span class="comment"># 准备参数值</span></span><br><span class="line">            values = <span class="built_in">list</span>(task_dict.values())</span><br><span class="line">            values.append(task_id)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 执行更新操作</span></span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(update_sql, values)</span><br><span class="line">            <span class="variable language_">self</span>.conn.commit()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 检查是否有行被更新</span></span><br><span class="line">            updated_count = <span class="variable language_">self</span>.cursor.rowcount</span><br><span class="line">            <span class="keyword">if</span> updated_count &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"[Info] 成功更新任务 ID=<span class="subst">{task_id}</span>"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"[Warning] 未找到要更新的任务 ID=<span class="subst">{task_id}</span>"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 任务更新失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="variable language_">self</span>.conn.rollback()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_task</span>(<span class="params">self, task_id: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""删除任务记录</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task_id: 要删除的任务ID</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 是否删除成功</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment">#   构建DELETE语句</span></span><br><span class="line">            delete_sql = <span class="string">f"DELETE FROM <span class="subst">{self.table_name}</span> WHERE task_id = ?"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 执行删除操作</span></span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(delete_sql, (task_id,))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 检查是否有行被删除</span></span><br><span class="line">            deleted_count = <span class="variable language_">self</span>.cursor.rowcount</span><br><span class="line">            <span class="keyword">if</span> deleted_count &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"[Info] 成功删除任务 ID=<span class="subst">{task_id}</span>"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"[Warning] 未找到要删除的任务 ID=<span class="subst">{task_id}</span>"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 任务删除失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="variable language_">self</span>.conn.rollback()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_task_by_id</span>(<span class="params">self, task_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[Task]:</span><br><span class="line">        <span class="string">"""根据任务ID查找任务记录"""</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 构建SELECT语句</span></span><br><span class="line">            select_sql = <span class="string">f"SELECT * FROM <span class="subst">{self.table_name}</span> WHERE task_id = ?"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 执行查询操作</span></span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(select_sql, (task_id,))</span><br><span class="line"></span><br><span class="line">            <span class="comment">#  获取查询结果</span></span><br><span class="line">            row = <span class="variable language_">self</span>.cursor.fetchone()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果未找到，返回None</span></span><br><span class="line">            <span class="keyword">if</span> row <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 将结果转换为Task对象</span></span><br><span class="line">            <span class="keyword">return</span> Task.from_row(row)</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 任务查找失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_all_tasks</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[Task]:</span><br><span class="line">        <span class="string">"""查找所有任务记录"""</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 构建SELECT语句</span></span><br><span class="line">            select_sql = <span class="string">f"SELECT * FROM <span class="subst">{self.table_name}</span>"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 执行查询操作</span></span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(select_sql)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取所有结果</span></span><br><span class="line">            rows = <span class="variable language_">self</span>.cursor.fetchall()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 将结果转换为Task对象列表</span></span><br><span class="line">            <span class="keyword">return</span> [Task.from_row(row) <span class="keyword">for</span> row <span class="keyword">in</span> rows]</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 任务查找失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_by_criteria</span>(<span class="params">self, criteria: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">List</span>[Task]:</span><br><span class="line">        <span class="string">"""根据条件查找任务</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            criteria: 查询条件字典，格式为 {列名: 值}</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            list: 符合条件的Task对象列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 确保有条件要查询</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> criteria:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.find_all_tasks()</span><br><span class="line">            <span class="comment"># 构建WHERE子句</span></span><br><span class="line">            values = []  <span class="comment"># 用于占位符</span></span><br><span class="line">            where_clauses = []  <span class="comment"># 用于条件</span></span><br><span class="line">            <span class="keyword">for</span> col, val <span class="keyword">in</span> criteria.items():</span><br><span class="line">                where_clauses.append(<span class="string">f"<span class="subst">{col}</span> = ?"</span>)</span><br><span class="line">                values.append(val)</span><br><span class="line">            where_clause = <span class="string">' AND '</span>.join(where_clauses)  <span class="comment"># 例如：查询条件: priority = ? 若有多个条件，则用AND连接</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 构建SELECT语句</span></span><br><span class="line">            select_sql = <span class="string">f"SELECT * FROM <span class="subst">{self.table_name}</span> WHERE <span class="subst">{where_clause}</span>"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 执行查询操作</span></span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(select_sql, values)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取所有结果</span></span><br><span class="line">            rows = <span class="variable language_">self</span>.cursor.fetchall()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 奖结果转换为Task对象列表</span></span><br><span class="line">            <span class="keyword">return</span> [Task.from_row(row) <span class="keyword">for</span> row <span class="keyword">in</span> rows]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 任务查找失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_by_title_contains</span>(<span class="params">self, title_part: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[Task]:</span><br><span class="line">        <span class="string">"""根据标题部分查找任务"""</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 构建SELECT语句 使用LIKE模糊查询</span></span><br><span class="line">            select_sql = <span class="string">f"SELECT * FROM <span class="subst">{self.table_name}</span> WHERE title LIKE ?"</span></span><br><span class="line">            <span class="comment"># 执行查询，使用%作为通配符</span></span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(select_sql, (<span class="string">f'%<span class="subst">{title_part}</span>%'</span>,))</span><br><span class="line">            <span class="comment"># 获取所有结果</span></span><br><span class="line">            rows = <span class="variable language_">self</span>.cursor.fetchall()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 将结果转换为Task对象列表</span></span><br><span class="line">            <span class="keyword">return</span> [Task.from_row(row) <span class="keyword">for</span> row <span class="keyword">in</span> rows]</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 任务查找失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>知识点解释 (Repository - 适配 Dataclass):</strong></p><ul><li><strong>与 Dataclass 协作:</strong> <code>insert</code> 和 <code>update</code> 方法现在接收 <code>Task</code> dataclass 实例。它们使用 <code>task.to_dict()</code> 来获取需要持久化的数据，而不是手动从对象属性中提取。</li><li><strong><code>from_row</code> 的使用:</strong> <code>find_all</code>, <code>find_by_id</code>, <code>find_by_criteria</code> 等查询方法现在依赖 <code>Task.from_row(row)</code> 这个类方法来将数据库行数据（<code>sqlite3.Row</code> 对象）转换回 <code>Task</code> dataclass 实例。这使得模型转换逻辑集中在模型类自身。</li><li><strong>布尔值处理:</strong> 在 <code>insert</code>/<code>update</code> 时将 Python <code>bool</code> 转换为数据库的 <code>INTEGER</code> (0/1)，在 <code>from_row</code> 时将数据库的 <code>INTEGER</code> 转换回 <code>bool</code>。</li><li><strong>动态 SQL 构建 (需谨慎):</strong> <code>insert</code> 和 <code>update</code> 方法中动态构建了 SQL 语句的列名和占位符部分。这样做可以使代码适应模型的变化，但必须<strong>极其小心</strong>，确保列名<strong>不是</strong>来自用户输入，以防范 SQL 注入。这里列名来自 <code>task.to_dict().keys()</code>，是安全的。</li><li><strong>错误处理:</strong> 继续保持了对 <code>sqlite3.Error</code> 和 <code>sqlite3.IntegrityError</code> 的捕获以及事务回滚。查询方法在出错时返回空列表 <code>[]</code> 或 <code>None</code>。</li><li><strong><code>create_table</code> 职责:</strong> 将创建表的逻辑放在 Repository 初始化时执行，确保操作 Repository 前表结构一定存在，这是一种常见的实践模式。</li></ul><h4 id="16-1-5-业务逻辑层实现-services"><a href="#16-1-5-业务逻辑层实现-services" class="headerlink" title="16.1.5 业务逻辑层实现 (services/)"></a>16.1.5 业务逻辑层实现 (<code>services/</code>)</h4><h5 id="任务服务-services-task-service-py"><a href="#任务服务-services-task-service-py" class="headerlink" title="任务服务 (services/task_service.py )"></a>任务服务 (<code>services/task_service.py</code> )</h5><p>服务层的代码通常与底层数据模型是 dataclass 还是普通类关系不大，因为它主要通过 Repository 提供的接口（接收和返回 <code>Task</code> 对象）来工作。因此，之前的 <code>TaskService</code> 代码基本可以直接使用，或者做少量调整以利用 dataclass 的特性（如果需要的话）。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">任务服务模块，提供业务逻辑层功能。</span></span><br><span class="line"><span class="string">负责处理任务相关的业务规则和操作。</span></span><br><span class="line"><span class="string"># sqlite_practice/services/task_service.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Dict</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">from</span> models.task <span class="keyword">import</span> Task</span><br><span class="line"><span class="keyword">from</span> repositories.task_repository <span class="keyword">import</span> TaskRepository</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaskService</span>:</span><br><span class="line">    <span class="string">"""任务服务类，处理任务相关的业务逻辑"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, task_repository: TaskRepository</span>):</span><br><span class="line">        <span class="string">"""初始化任务服务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task_repository: 任务数据访问对象</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="variable language_">self</span>.task_repository = task_repository</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_task</span>(<span class="params">self, title: <span class="built_in">str</span>, description: <span class="built_in">str</span> = <span class="literal">None</span>, priority: <span class="built_in">int</span> = <span class="number">3</span>, </span></span><br><span class="line"><span class="params">                   due_date: <span class="built_in">str</span> = <span class="literal">None</span>, is_completed: <span class="built_in">bool</span> = <span class="literal">False</span>, </span></span><br><span class="line"><span class="params">                   attachment: <span class="built_in">bytes</span> = <span class="literal">None</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">"""创建新任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            title: 任务标题</span></span><br><span class="line"><span class="string">            description: 任务描述</span></span><br><span class="line"><span class="string">            priority: 优先级 (1-5)，默认为3</span></span><br><span class="line"><span class="string">            due_date: 截止日期，格式为'YYYY-MM-DD'</span></span><br><span class="line"><span class="string">            is_completed: 是否已完成</span></span><br><span class="line"><span class="string">            attachment: 附件数据</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            int: 新创建任务的ID，失败则返回None</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 验证优先级范围</span></span><br><span class="line">        <span class="keyword">if</span> priority &lt; <span class="number">1</span> <span class="keyword">or</span> priority &gt; <span class="number">5</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Warning] 优先级 <span class="subst">{priority}</span> 超出范围 (1-5)，将使用默认值 3"</span>)</span><br><span class="line">            priority = <span class="number">3</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 验证日期格式</span></span><br><span class="line">        <span class="keyword">if</span> due_date:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 尝试解析日期格式</span></span><br><span class="line">                datetime.strptime(due_date, <span class="string">'%Y-%m-%d'</span>)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"[Warning] 日期格式 '<span class="subst">{due_date}</span>' 无效，应为 'YYYY-MM-DD'，将设为空"</span>)</span><br><span class="line">                due_date = <span class="literal">None</span></span><br><span class="line">                </span><br><span class="line">        <span class="comment"># 验证标题不为空</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> title:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"[Error] 任务标题不能为空"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 创建任务对象</span></span><br><span class="line">        task = Task(</span><br><span class="line">            title=title,</span><br><span class="line">            description=description,</span><br><span class="line">            priority=priority,</span><br><span class="line">            due_date=due_date,</span><br><span class="line">            is_completed=is_completed,</span><br><span class="line">            attachment=attachment</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存任务</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.insert_task(task)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_tasks_batch</span>(<span class="params">self, task_data_list: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="type">Optional</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">"""批量创建任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task_data_list: 包含任务数据的字典列表</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            int: 成功创建的任务数量，失败则返回None</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> task_data_list:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"[Warning] 没有任务数据需要创建"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">        tasks = []</span><br><span class="line">        <span class="keyword">for</span> task_data <span class="keyword">in</span> task_data_list:</span><br><span class="line">            <span class="comment"># 验证必要字段</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'title'</span> <span class="keyword">not</span> <span class="keyword">in</span> task_data <span class="keyword">or</span> <span class="keyword">not</span> task_data[<span class="string">'title'</span>]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"[Warning] 跳过缺少标题的任务"</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">            <span class="comment"># 创建任务对象</span></span><br><span class="line">            task = Task(</span><br><span class="line">                title=task_data[<span class="string">'title'</span>],</span><br><span class="line">                description=task_data.get(<span class="string">'description'</span>),</span><br><span class="line">                priority=task_data.get(<span class="string">'priority'</span>, <span class="number">3</span>),</span><br><span class="line">                due_date=task_data.get(<span class="string">'due_date'</span>),</span><br><span class="line">                is_completed=task_data.get(<span class="string">'is_completed'</span>, <span class="literal">False</span>),</span><br><span class="line">                attachment=task_data.get(<span class="string">'attachment'</span>)</span><br><span class="line">            )</span><br><span class="line">            tasks.append(task)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> tasks:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"[Warning] 没有有效的任务需要创建"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 批量保存任务</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.insert_many(tasks)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_task</span>(<span class="params">self, task_id: <span class="built_in">int</span>, **kwargs</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""更新任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task_id: 要更新的任务ID</span></span><br><span class="line"><span class="string">            **kwargs: 要更新的字段和值</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 更新是否成功</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 查找现有任务</span></span><br><span class="line">        task = <span class="variable language_">self</span>.task_repository.find_task_by_id(task_id)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> task:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 未找到要更新的任务 ID=<span class="subst">{task_id}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 更新字段</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(task, key):</span><br><span class="line">                <span class="built_in">setattr</span>(task, key, value)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"[Warning] 忽略未知字段 '<span class="subst">{key}</span>'"</span>)</span><br><span class="line">                </span><br><span class="line">        <span class="comment"># 保存更新</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.update_task(task)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">complete_task</span>(<span class="params">self, task_id: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""将任务标记为已完成</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task_id: 要标记的任务ID</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 操作是否成功</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.update_task(task_id, is_completed=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_task</span>(<span class="params">self, task_id: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""删除任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task_id: 要删除的任务ID</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 删除是否成功</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.delete_task(task_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_task</span>(<span class="params">self, task_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[Task]:</span><br><span class="line">        <span class="string">"""获取指定ID的任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task_id: 任务ID</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Task: 任务对象，未找到则返回None</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.find_task_by_id(task_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_all_tasks</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[Task]:</span><br><span class="line">        <span class="string">"""获取所有任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            list: 任务对象列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.find_all_tasks()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_tasks_by_priority</span>(<span class="params">self, priority: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[Task]:</span><br><span class="line">        <span class="string">"""获取指定优先级的任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            priority: 优先级</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            list: 任务对象列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.find_by_criteria({<span class="string">'priority'</span>: priority})</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_incomplete_tasks</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[Task]:</span><br><span class="line">        <span class="string">"""获取未完成的任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            list: 任务对象列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.find_by_criteria({<span class="string">'is_completed'</span>: <span class="number">0</span>})  <span class="comment"># SQLite中布尔值存储为0/1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_overdue_tasks</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[Task]:</span><br><span class="line">        <span class="string">"""获取已逾期的任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            list: 任务对象列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        today = datetime.now().strftime(<span class="string">'%Y-%m-%d'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取所有任务</span></span><br><span class="line">        all_tasks = <span class="variable language_">self</span>.task_repository.find_all_tasks()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 筛选出截止日期已过且未完成的任务</span></span><br><span class="line">        overdue_tasks = []</span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> all_tasks:</span><br><span class="line">            <span class="keyword">if</span> (task.due_date <span class="keyword">and</span> task.due_date &lt; today <span class="keyword">and</span> <span class="keyword">not</span> task.is_completed):</span><br><span class="line">                overdue_tasks.append(task)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> overdue_tasks</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search_tasks_by_title</span>(<span class="params">self, title_part: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[Task]:</span><br><span class="line">        <span class="string">"""搜索标题包含指定字符串的任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            title_part: 标题中要搜索的文本</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            list: 符合条件的任务对象列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.find_by_title_contains(title_part)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_tasks_due_within_days</span>(<span class="params">self, days: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[Task]:</span><br><span class="line">        <span class="string">"""获取指定天数内到期的任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            days: 天数</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            list: 任务对象列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        today = datetime.now()</span><br><span class="line">        end_date = (today + timedelta(days=days)).strftime(<span class="string">'%Y-%m-%d'</span>)</span><br><span class="line">        today_str = today.strftime(<span class="string">'%Y-%m-%d'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取所有任务</span></span><br><span class="line">        all_tasks = <span class="variable language_">self</span>.task_repository.find_all_tasks()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 筛选出在指定日期范围内到期的任务</span></span><br><span class="line">        due_tasks = []</span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> all_tasks:</span><br><span class="line">            <span class="keyword">if</span> (task.due_date <span class="keyword">and</span> today_str &lt;= task.due_date &lt;= end_date):</span><br><span class="line">                due_tasks.append(task)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> due_tasks</span><br></pre></td></tr></tbody></table></figure><p><strong>知识点解释 (Service Layer):</strong></p><ul><li><strong>适配 Dataclass:</strong> 由于 Repository 返回的是 <code>Task</code> dataclass 实例，Service 层的方法（如 <code>complete_task</code>, <code>update_task_details</code>）可以直接操作这些对象的属性，代码更简洁。</li><li><strong>业务规则体现:</strong><ul><li><code>create_task</code> 中增加了对 <code>priority</code> 和 <code>due_date</code> 格式的校验。</li><li><code>complete_task</code> 增加了对任务是否已完成的检查，避免重复操作。</li><li><code>update_task_details</code> 增加了对不可修改字段 (<code>task_id</code>, <code>created_at</code>) 的保护，并对传入的字段和值进行基本检查。</li><li><code>get_tasks_due_within_days</code> 中日期的解析和比较逻辑清晰地放在服务层。</li></ul></li><li><strong>调用 Repository:</strong> 所有与数据库的交互都委托给 <code>self.task_repository</code>。</li></ul><hr><h4 id="16-1-7-使用示例-examples"><a href="#16-1-7-使用示例-examples" class="headerlink" title="16.1.7 使用示例 (examples/)"></a>16.1.7 使用示例 (<code>examples/</code>)</h4><p>现在我们已经构建了框架的各个组件（<code>DatabaseManager</code>, <code>Task</code> 模型, <code>TaskRepository</code>, <code>TaskService</code>），接下来将通过几个具体的示例脚本来演示如何使用这个框架完成不同的数据库操作任务。</p><p><strong>注意:</strong> 运行这些示例脚本时，请确保：</p><ol><li>Python 环境中已经安装了必要的库（虽然 <code>sqlite3</code> 是内置的，但未来章节可能需要 <code>pymysql</code>, <code>sqlalchemy</code> 等）。</li><li>脚本能够正确导入我们之前创建的模块（<code>core</code>, <code>models</code>, <code>repositories</code>, <code>services</code>, <code>utils</code>）。这通常意味着你需要从 <code>sqlite_practice</code> 这个项目的<strong>根目录</strong>来运行这些示例脚本，或者确保 <code>sqlite_practice</code> 目录位于 Python 的模块搜索路径 (<code>sys.path</code>) 中。示例代码中会包含尝试处理路径的代码。</li><li>每个示例脚本可能会创建自己的 SQLite 数据库文件（如 <code>example_sqlite.db</code>, <code>advanced_queries.db</code>, <code>transaction_example.db</code>），这些文件会出现在脚本运行的目录下或指定的 <code>data</code> 子目录中。</li></ol><h5 id="16-1-7-1-基本操作示例-examples-basic-operations-py"><a href="#16-1-7-1-基本操作示例-examples-basic-operations-py" class="headerlink" title="16.1.7.1 基本操作示例 (examples/basic_operations.py)"></a>16.1.7.1 基本操作示例 (<code>examples/basic_operations.py</code>)</h5><p>这个脚本演示了最核心的 CRUD (创建、读取、更新、删除) 操作，展示了如何通过 <code>TaskRepository</code> 来与数据库交互。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">基本数据库操作示例模块，展示SQLite数据库的基本CRUD操作。</span></span><br><span class="line"><span class="string">包括连接、创建表、增删改查等基本功能。</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> core.db_manager <span class="keyword">import</span> DatabaseManager</span><br><span class="line"><span class="keyword">from</span> core.table_manager <span class="keyword">import</span> TableManager</span><br><span class="line"><span class="keyword">from</span> models.task <span class="keyword">import</span> Task</span><br><span class="line"><span class="keyword">from</span> repositories.task_repository <span class="keyword">import</span> TaskRepository</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLiteExample</span>:</span><br><span class="line">    <span class="string">"""SQLite基本操作示例类，实现单例模式"""</span></span><br><span class="line">    </span><br><span class="line">    _instance = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="string">"""确保类只有一个实例"""</span></span><br><span class="line">        <span class="keyword">if</span> cls._instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            cls._instance = <span class="built_in">super</span>(SQLiteExample, cls).__new__(cls)</span><br><span class="line">            cls._instance._initialized = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, db_file: <span class="built_in">str</span> = <span class="string">"sqlite_practice.db"</span></span>):</span><br><span class="line">        <span class="string">"""初始化SQLite示例类"""</span></span><br><span class="line">        <span class="comment"># 避免重复初始化</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>._initialized:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        <span class="variable language_">self</span>.db_file = db_file</span><br><span class="line">        <span class="variable language_">self</span>.db_manager = DatabaseManager(<span class="variable language_">self</span>.db_file)</span><br><span class="line">        <span class="variable language_">self</span>.conn, <span class="variable language_">self</span>.cursor = <span class="variable language_">self</span>.db_manager.connect()</span><br><span class="line">        <span class="variable language_">self</span>.task_repository = TaskRepository(<span class="variable language_">self</span>.conn, <span class="variable language_">self</span>.cursor)</span><br><span class="line">        <span class="variable language_">self</span>.init_db()</span><br><span class="line">        <span class="variable language_">self</span>._initialized = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_db</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""初始化数据库和表结构</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 初始化是否成功</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 若数据库文件存在，则删除原有数据库</span></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(<span class="variable language_">self</span>.db_file):</span><br><span class="line">                <span class="variable language_">self</span>.clean_db()</span><br><span class="line">            <span class="comment"># 创建任务表</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.create_table()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[Error] 初始化数据库失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clean_db</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""清理数据库文件</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 清理是否成功</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.db_manager.clean_database()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert_sample_tasks</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">"""插入示例任务数据</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            int: 成功插入的任务数量</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n--- 插入示例任务数据 ---"</span>)</span><br><span class="line">        tasks = [</span><br><span class="line">            Task(title=<span class="string">"任务1"</span>, description=<span class="string">"这是任务1的描述"</span>, priority=<span class="number">1</span>),</span><br><span class="line">            Task(title=<span class="string">"任务2"</span>, description=<span class="string">"这是任务2的描述"</span>, priority=<span class="number">2</span>),</span><br><span class="line">            Task(title=<span class="string">"任务3"</span>, description=<span class="string">"这是任务3的描述"</span>, priority=<span class="number">3</span>),</span><br><span class="line">            Task(title=<span class="string">"任务4"</span>, description=<span class="string">"这是任务4的描述"</span>, priority=<span class="number">4</span>),</span><br><span class="line">            Task(title=<span class="string">"任务5"</span>, description=<span class="string">"这是任务5的描述"</span>, priority=<span class="number">5</span>),</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.insert_many(tasks)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert_single_task</span>(<span class="params">self, task: Task</span>) -&gt; <span class="type">Optional</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">"""插入单个任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task: 要插入的任务对象</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Optional[int]: 插入的任务ID，失败则返回None</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.insert_task(task)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_all_tasks</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[Task]:</span><br><span class="line">        <span class="string">"""查询所有任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            List[Task]: 任务列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.find_all_tasks()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_task_by_id</span>(<span class="params">self, task_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[Task]:</span><br><span class="line">        <span class="string">"""根据ID查询任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task_id: 任务ID</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Optional[Task]: 任务对象，未找到则返回None</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.find_task_by_id(task_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_tasks_by_criteria</span>(<span class="params">self, criteria: <span class="built_in">dict</span></span>) -&gt; <span class="type">List</span>[Task]:</span><br><span class="line">        <span class="string">"""根据条件查询任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            criteria: 查询条件字典</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            List[Task]: 符合条件的任务列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.find_by_criteria(criteria)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_tasks_by_title</span>(<span class="params">self, title_part: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[Task]:</span><br><span class="line">        <span class="string">"""根据标题模糊查询任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            title_part: 标题包含的文本</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            List[Task]: 符合条件的任务列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.find_by_title_contains(title_part)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_task</span>(<span class="params">self, task: Task</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""更新任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task: 要更新的任务对象</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 更新是否成功</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.update_task(task)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_task</span>(<span class="params">self, task_id: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""删除任务</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task_id: 要删除的任务ID</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            bool: 删除是否成功</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.task_repository.delete_task(task_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">"""关闭数据库连接"""</span></span><br><span class="line">        <span class="variable language_">self</span>.db_manager.close()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 实例化示例类</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[1;36m===== 初始化 SQLite 示例 =====\033[0m'</span>)</span><br><span class="line">    sqlite_example = SQLiteExample()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 插入示例任务数据</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[1;32m===== 插入示例任务数据 =====\033[0m'</span>)</span><br><span class="line">    sqlite_example.insert_sample_tasks()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查询所有任务</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[1;34m===== 查询所有任务 =====\033[0m'</span>)</span><br><span class="line">    tasks = sqlite_example.find_all_tasks()</span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'\033[0;37m'</span> + <span class="built_in">str</span>(task.to_dict()) + <span class="string">'\033[0m'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查询单个任务</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[1;34m===== 查询单个任务 (ID=1) =====\033[0m'</span>)</span><br><span class="line">    task = sqlite_example.find_task_by_id(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[0;33m'</span> + <span class="built_in">str</span>(task.to_dict()) + <span class="string">'\033[0m'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查询任务列表</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[1;34m===== 查询高优先级任务 (priority=3) =====\033[0m'</span>)</span><br><span class="line">    tasks = sqlite_example.find_tasks_by_criteria({<span class="string">'priority'</span>: <span class="number">3</span>})</span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'\033[0;35m'</span> + <span class="built_in">str</span>(task.to_dict()) + <span class="string">'\033[0m'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查询任务标题包含某些字符的任务</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[1;34m===== 查询标题包含"任务"的任务 =====\033[0m'</span>)</span><br><span class="line">    tasks = sqlite_example.find_tasks_by_title(<span class="string">'任务'</span>)</span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'\033[0;36m'</span> + <span class="built_in">str</span>(task.to_dict()) + <span class="string">'\033[0m'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 更新任务</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[1;33m===== 更新任务 (ID=1) =====\033[0m'</span>)</span><br><span class="line">    task = Task(task_id=<span class="number">1</span>, title=<span class="string">"任务1-更新"</span>, description=<span class="string">"这是任务1的更新描述"</span>, priority=<span class="number">1</span>, is_completed=<span class="literal">True</span>)</span><br><span class="line">    sqlite_example.update_task(task)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查询更新后的任务</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[1;34m===== 查询更新后的任务 (ID=1) =====\033[0m'</span>)</span><br><span class="line">    task = sqlite_example.find_task_by_id(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[0;32m'</span> + <span class="built_in">str</span>(task.to_dict()) + <span class="string">'\033[0m'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 删除任务</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[1;31m===== 删除任务 (ID=1) =====\033[0m'</span>)</span><br><span class="line">    sqlite_example.delete_task(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 查询删除后的任务</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[1;34m===== 查询删除后的任务 (ID=1) =====\033[0m'</span>)</span><br><span class="line">    task = sqlite_example.find_task_by_id(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[0;31m'</span> + <span class="built_in">str</span>(task) + <span class="string">'\033[0m'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 关闭数据库连接</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[1;36m===== 关闭数据库连接 =====\033[0m'</span>)</span><br><span class="line">    sqlite_example.close()</span><br></pre></td></tr></tbody></table></figure><p><strong>代码解释 (basic_operations.py):</strong></p><ul><li><strong>目的:</strong> 专注于演示框架的基本 CRUD 功能。</li><li><strong>流程:</strong> 按照“连接 -&gt; 初始化 Repo -&gt; 创建表 -&gt; 插入 -&gt; 查询 -&gt; 更新 -&gt; 查询 -&gt; 删除 -&gt; 查询 -&gt; 关闭”的逻辑顺序进行。</li><li><strong>交互:</strong> 主要通过 <code>TaskRepository</code> 实例 (<code>task_repo</code>) 的方法 (<code>insert</code>, <code>insert_many</code>, <code>find_all</code>, <code>find_by_id</code>, <code>update</code>, <code>find_by_criteria</code>, <code>find_by_title_contains</code>, <code>delete</code>) 来完成数据库操作。</li><li><strong>模型使用:</strong> 创建 <code>Task</code> dataclass 对象用于插入和更新，接收 <code>Task</code> 对象列表作为查询结果。</li><li><strong>连接管理:</strong> 示例中使用了手动的 <code>db_manager.connect()</code> 和 <code>db_manager.close()</code> 来展示 Repository 如何接收 <code>conn</code> 和 <code>cursor</code>。在实际应用或更复杂的示例（如下面的事务示例）中，使用 <code>with</code> 语句通常是更好的选择。</li><li><strong>错误处理:</strong> 在主流程外层添加了 <code>try...except...finally</code> 来捕获可能的数据库错误或其他异常，并确保连接最终被关闭。</li></ul><h5 id="16-1-7-2-高级查询示例-examples-advanced-queries-py"><a href="#16-1-7-2-高级查询示例-examples-advanced-queries-py" class="headerlink" title="16.1.7.2 高级查询示例 (examples/advanced_queries.py)"></a>16.1.7.2 高级查询示例 (<code>examples/advanced_queries.py</code>)</h5><p>此脚本展示了更复杂的查询场景，包括直接执行 SQL 和通过框架的 Service/Repository 层进行查询。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sqlite_practice/examples/advanced_queries_oop.py</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">高级查询示例模块 (面向对象重构版)。</span></span><br><span class="line"><span class="string">使用类封装演示流程，遵循面向对象原则，使用彩色输出。</span></span><br><span class="line"><span class="string">展示SQLite数据库的高级查询功能，通过调用分层框架实现。</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta  <span class="comment"># 导入 datetime/timedelta</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Any</span>, <span class="type">List</span>  <span class="comment"># 引入类型提示</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 导入框架组件 ---</span></span><br><span class="line"><span class="keyword">from</span> core.db_manager <span class="keyword">import</span> DatabaseManager</span><br><span class="line"><span class="keyword">from</span> models.task <span class="keyword">import</span> Task  <span class="comment"># Task dataclass</span></span><br><span class="line"><span class="keyword">from</span> repositories.task_repository <span class="keyword">import</span> TaskRepository</span><br><span class="line"><span class="keyword">from</span> services.task_service <span class="keyword">import</span> TaskService</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 辅助类：用于彩色/样式化打印 ---</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Colors</span>:</span><br><span class="line">    <span class="string">"""定义 ANSI 转义码常量用于彩色输出"""</span></span><br><span class="line">    HEADER = <span class="string">'\033[95m'</span>  <span class="comment"># 紫色 (用于标题)</span></span><br><span class="line">    BLUE = <span class="string">'\033[94m'</span>  <span class="comment"># 蓝色 (用于 SQL 或代码)</span></span><br><span class="line">    CYAN = <span class="string">'\033[96m'</span>  <span class="comment"># 青色 (用于提示信息)</span></span><br><span class="line">    GREEN = <span class="string">'\033[92m'</span>  <span class="comment"># 绿色 (用于成功信息)</span></span><br><span class="line">    WARNING = <span class="string">'\033[93m'</span>  <span class="comment"># 黄色 (用于警告)</span></span><br><span class="line">    FAIL = <span class="string">'\033[91m'</span>  <span class="comment"># 红色 (用于错误)</span></span><br><span class="line">    BOLD = <span class="string">'\033[1m'</span>  <span class="comment"># 加粗</span></span><br><span class="line">    UNDERLINE = <span class="string">'\033[4m'</span>  <span class="comment"># 下划线</span></span><br><span class="line">    END = <span class="string">'\033[0m'</span>  <span class="comment"># 重置所有格式</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 打印辅助函数 ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_header</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">"""打印带样式的标题"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n<span class="subst">{Colors.HEADER}</span><span class="subst">{Colors.BOLD}</span>--- <span class="subst">{text}</span> ---<span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_subheader</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">"""打印带样式的子标题"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n<span class="subst">{Colors.CYAN}</span><span class="subst">{Colors.UNDERLINE}</span>  <span class="subst">{text}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_info</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">"""打印普通信息"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  <span class="subst">{text}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_success</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">"""打印成功信息"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Colors.GREEN}</span>  ✔ <span class="subst">{text}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_warning</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">"""打印警告信息"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Colors.WARNING}</span>  ⚠️ [Warning] <span class="subst">{text}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_error</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">"""打印错误信息"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Colors.FAIL}</span>  ❌ [Error] <span class="subst">{text}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_sql</span>(<span class="params">sql: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">"""打印格式化的 SQL 语句"""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Colors.BLUE}</span>    SQL: <span class="subst">{sql.strip()}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_result_item</span>(<span class="params">item: <span class="type">Any</span>, indent: <span class="built_in">int</span> = <span class="number">4</span></span>):</span><br><span class="line">    <span class="string">"""打印格式化的查询结果项"""</span></span><br><span class="line">    prefix = <span class="string">" "</span> * indent</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, Task):</span><br><span class="line">        <span class="comment"># 使用 Task 的 __repr__ (dataclass 自动生成)</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{prefix}</span><span class="subst">{item}</span>"</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">hasattr</span>(item, <span class="string">'keys'</span>):  <span class="comment"># 支持 sqlite3.Row 或字典</span></span><br><span class="line">        details = <span class="string">", "</span>.join([<span class="string">f"<span class="subst">{Colors.BOLD}</span><span class="subst">{key}</span><span class="subst">{Colors.END}</span>: <span class="subst">{item[key]}</span>"</span> <span class="keyword">for</span> key <span class="keyword">in</span> item.keys()])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{prefix}</span>Row(<span class="subst">{details}</span>)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{prefix}</span><span class="subst">{item}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 主演示类 ---</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AdvancedQueryDemoOO</span>:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    面向对象的 SQLite 高级查询演示类。</span></span><br><span class="line"><span class="string">    封装了演示的设置、执行和清理逻辑。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 类属性定义数据库文件路径</span></span><br><span class="line">    DB_FILE = <span class="string">"advanced_queries_oop.db"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""初始化演示类实例"""</span></span><br><span class="line">        print_header(<span class="string">"初始化高级查询演示 (OOP)"</span>)</span><br><span class="line">        <span class="comment"># 创建 DatabaseManager 实例，但不立即连接</span></span><br><span class="line">        <span class="variable language_">self</span>.db_manager = DatabaseManager(<span class="variable language_">self</span>.DB_FILE)</span><br><span class="line">        <span class="comment"># 初始化依赖对象为 None</span></span><br><span class="line">        <span class="variable language_">self</span>.conn: <span class="type">Optional</span>[sqlite3.Connection] = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.cursor: <span class="type">Optional</span>[sqlite3.Cursor] = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.task_repo: <span class="type">Optional</span>[TaskRepository] = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.task_service: <span class="type">Optional</span>[TaskService] = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 执行数据库清理</span></span><br><span class="line">        <span class="variable language_">self</span>._cleanup_db()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_cleanup_db</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""(私有方法) 清理旧的数据库文件"""</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(<span class="variable language_">self</span>.DB_FILE):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.remove(<span class="variable language_">self</span>.DB_FILE)</span><br><span class="line">                print_info(<span class="string">f"旧数据库文件 '<span class="subst">{self.DB_FILE}</span>' 已清理。"</span>)</span><br><span class="line">            <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">                print_error(<span class="string">f"清理数据库文件 '<span class="subst">{self.DB_FILE}</span>' 失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                <span class="comment"># 清理失败可能导致后续问题，可以选择退出或继续</span></span><br><span class="line">                <span class="comment"># sys.exit(1)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_setup_database_and_framework</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""(私有方法) 建立数据库连接，初始化框架组件，并填充测试数据"""</span></span><br><span class="line">        print_subheader(<span class="string">"1. 设置数据库和框架组件"</span>)</span><br><span class="line">        <span class="comment"># self.db_manager 在 __init__ 中已创建</span></span><br><span class="line">        <span class="comment"># 使用 with 语句管理连接</span></span><br><span class="line">        <span class="comment"># 注意：这里我们将 conn 和 cursor 存储在 self 上，以便后续方法使用</span></span><br><span class="line">        <span class="comment"># 这在简单演示类中可行，但在多线程或长期运行应用中需谨慎管理状态</span></span><br><span class="line">        <span class="variable language_">self</span>.conn, <span class="variable language_">self</span>.cursor = <span class="variable language_">self</span>.db_manager.connect()  <span class="comment"># 直接调用 connect</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.conn <span class="keyword">or</span> <span class="keyword">not</span> <span class="variable language_">self</span>.cursor:</span><br><span class="line">            <span class="keyword">raise</span> ConnectionError(<span class="string">"未能获取数据库连接或游标"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化 Repository (依赖 conn, cursor)</span></span><br><span class="line">        <span class="comment"># Repository 初始化时会尝试创建表</span></span><br><span class="line">        <span class="variable language_">self</span>.task_repo = TaskRepository(<span class="variable language_">self</span>.conn, <span class="variable language_">self</span>.cursor)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化 Service (依赖 task_repo)</span></span><br><span class="line">        <span class="variable language_">self</span>.task_service = TaskService(<span class="variable language_">self</span>.task_repo)</span><br><span class="line">        print_success(<span class="string">"Repository 和 Service 初始化成功。"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 新建数据表</span></span><br><span class="line">        <span class="variable language_">self</span>.task_repo.create_table()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 填充测试数据</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._populate_test_data():</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"填充测试数据失败。"</span>)  <span class="comment"># 如果填充失败，抛出异常</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_future_date</span>(<span class="params">self, days: <span class="built_in">int</span>, format_str: <span class="built_in">str</span> = <span class="string">'%Y-%m-%d'</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">"""获取未来日期字符串</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            days: 向后推的天数</span></span><br><span class="line"><span class="string">            format_str: 日期格式，默认为 'YYYY-MM-DD'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            str: 未来日期字符串</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        future_date = datetime.now() + timedelta(days=days)</span><br><span class="line">        <span class="keyword">return</span> future_date.strftime(format_str)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_populate_test_data</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">"""(私有方法) 向数据库填充测试数据"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.task_repo: <span class="keyword">return</span> <span class="literal">False</span>  <span class="comment"># 防御性检查</span></span><br><span class="line">        print_subheader(<span class="string">"2. 填充测试数据"</span>)</span><br><span class="line">        today = datetime.now().strftime(<span class="string">'%Y-%m-%d'</span>)</span><br><span class="line">        tomorrow = <span class="variable language_">self</span>.get_future_date(<span class="number">1</span>)</span><br><span class="line">        next_week = <span class="variable language_">self</span>.get_future_date(<span class="number">7</span>)</span><br><span class="line">        next_month = <span class="variable language_">self</span>.get_future_date(<span class="number">30</span>)</span><br><span class="line">        yesterday = <span class="variable language_">self</span>.get_future_date(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        test_tasks = [</span><br><span class="line">            Task(title=<span class="string">"完成项目设计文档"</span>, description=<span class="string">"项目需求和架构设计"</span>, priority=<span class="number">1</span>, due_date=tomorrow),</span><br><span class="line">            Task(title=<span class="string">"修复关键Bug"</span>, description=<span class="string">"修复用户报告的登录问题"</span>, priority=<span class="number">1</span>, due_date=today),</span><br><span class="line">            Task(title=<span class="string">"制定项目计划"</span>, description=<span class="string">"项目时间线和里程碑规划"</span>, priority=<span class="number">1</span>, due_date=next_week),</span><br><span class="line">            Task(title=<span class="string">"紧急会议准备"</span>, priority=<span class="number">1</span>, due_date=today, is_completed=<span class="literal">False</span>),</span><br><span class="line">            Task(title=<span class="string">"代码重构"</span>, description=<span class="string">"重构认证模块的代码"</span>, priority=<span class="number">2</span>, due_date=next_week),</span><br><span class="line">            Task(title=<span class="string">"单元测试编写"</span>, description=<span class="string">"为核心功能编写单元测试"</span>, priority=<span class="number">2</span>, due_date=next_week),</span><br><span class="line">            Task(title=<span class="string">"API文档更新"</span>, description=<span class="string">"更新REST API文档"</span>, priority=<span class="number">2</span>, due_date=next_month),</span><br><span class="line">            Task(title=<span class="string">"中期报告撰写"</span>, priority=<span class="number">2</span>, due_date=<span class="variable language_">self</span>.get_future_date(<span class="number">10</span>)),</span><br><span class="line">            Task(title=<span class="string">"性能优化"</span>, description=<span class="string">"优化数据库查询性能"</span>, priority=<span class="number">3</span>, due_date=next_month),</span><br><span class="line">            Task(title=<span class="string">"学习新技术"</span>, description=<span class="string">"学习 GraphQL 技术"</span>, priority=<span class="number">3</span>, due_date=<span class="literal">None</span>),</span><br><span class="line">            Task(title=<span class="string">"代码审查"</span>, description=<span class="string">"审查团队成员的代码"</span>, priority=<span class="number">3</span>, due_date=next_week),</span><br><span class="line">            Task(title=<span class="string">"环境搭建"</span>, description=<span class="string">"搭建开发环境"</span>, priority=<span class="number">1</span>, is_completed=<span class="literal">True</span>, due_date=yesterday),</span><br><span class="line">            Task(title=<span class="string">"需求分析"</span>, description=<span class="string">"分析用户需求"</span>, priority=<span class="number">2</span>, is_completed=<span class="literal">True</span>, due_date=today),</span><br><span class="line">            Task(title=<span class="string">"旧项目归档"</span>, priority=<span class="number">3</span>, is_completed=<span class="literal">True</span>, due_date=<span class="literal">None</span>)</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        inserted_count = <span class="variable language_">self</span>.task_repo.insert_many(test_tasks)</span><br><span class="line">        <span class="keyword">if</span> inserted_count <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            print_success(</span><br><span class="line">                <span class="string">f"已尝试插入 <span class="subst">{<span class="built_in">len</span>(test_tasks)}</span> 条测试数据，成功 <span class="subst">{inserted_count <span class="keyword">if</span> inserted_count != -<span class="number">1</span> <span class="keyword">else</span> <span class="built_in">len</span>(test_tasks)}</span> 条。"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print_error(<span class="string">"填充测试数据过程中发生错误。"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_demonstrate_raw_sql</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""(私有方法) 演示直接执行原生 SQL 查询"""</span></span><br><span class="line">        print_header(<span class="string">"演示: 直接执行原生 SQL 查询"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.cursor:</span><br><span class="line">            print_error(<span class="string">"数据库游标无效。"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            print_subheader(<span class="string">"1. 按优先级统计任务数量 (GROUP BY, COUNT)"</span>)</span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(</span><br><span class="line">                <span class="string">f"SELECT priority, COUNT(*) as task_count FROM <span class="subst">{self.task_repo.table_name}</span> GROUP BY priority ORDER BY priority"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> <span class="variable language_">self</span>.cursor.fetchall(): print_result_item(row)</span><br><span class="line"></span><br><span class="line">            print_subheader(<span class="string">"2. 连接查询示例 (LEFT JOIN 语法演示)"</span>)</span><br><span class="line">            join_sql = <span class="string">f"SELECT t.task_id, t.title, u.username FROM <span class="subst">{self.task_repo.table_name}</span> t LEFT JOIN users u ON t.user_id = u.user_id WHERE t.priority = 1 LIMIT 5"</span></span><br><span class="line">            print_sql(join_sql + <span class="string">" (仅演示语法, users 表不存在)"</span>)</span><br><span class="line"></span><br><span class="line">            print_subheader(<span class="string">"3. 使用 CASE 表达式统计任务状态"</span>)</span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(</span><br><span class="line">                <span class="string">f"SELECT SUM(CASE WHEN is_completed = 1 THEN 1 ELSE 0 END) as completed_count, SUM(CASE WHEN is_completed = 0 THEN 1 ELSE 0 END) as pending_count, COUNT(*) as total_count FROM <span class="subst">{self.task_repo.table_name}</span>"</span>)</span><br><span class="line">            stats = <span class="variable language_">self</span>.cursor.fetchone()</span><br><span class="line">            <span class="keyword">if</span> stats: print_result_item(stats)</span><br><span class="line"></span><br><span class="line">            print_subheader(<span class="string">"4. 复杂条件查询: 一周内到期的高优先级(&lt;=2)未完成任务"</span>)</span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(</span><br><span class="line">                <span class="string">f"SELECT task_id, title, priority, due_date FROM <span class="subst">{self.task_repo.table_name}</span> WHERE is_completed = 0 AND priority &lt;= ? AND (due_date IS NOT NULL AND due_date &lt;= date('now', '+7 days')) ORDER BY priority ASC, due_date ASC"</span>,</span><br><span class="line">                (<span class="number">2</span>,))</span><br><span class="line">            urgent_tasks = <span class="variable language_">self</span>.cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"找到 <span class="subst">{<span class="built_in">len</span>(urgent_tasks)}</span> 条:"</span>)</span><br><span class="line">            <span class="keyword">for</span> task <span class="keyword">in</span> urgent_tasks: print_result_item(task)</span><br><span class="line"></span><br><span class="line">            print_subheader(<span class="string">"5. 分页查询: 获取第 2 页数据 (每页 3 条)"</span>)</span><br><span class="line">            page_size, page_number = <span class="number">3</span>, <span class="number">2</span></span><br><span class="line">            offset = (page_number - <span class="number">1</span>) * page_size</span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(</span><br><span class="line">                <span class="string">f"SELECT task_id, title FROM <span class="subst">{self.task_repo.table_name}</span> ORDER BY task_id LIMIT ? OFFSET ?"</span>,</span><br><span class="line">                (page_size, offset))</span><br><span class="line">            page_tasks = <span class="variable language_">self</span>.cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"第 <span class="subst">{page_number}</span> 页 (每页 <span class="subst">{page_size}</span> 条):"</span>)</span><br><span class="line">            <span class="keyword">for</span> task <span class="keyword">in</span> page_tasks: print_result_item(task)</span><br><span class="line"></span><br><span class="line">            print_subheader(<span class="string">"6. 子查询: 查找所有今天到期的任务 (使用 EXISTS)"</span>)</span><br><span class="line">            <span class="variable language_">self</span>.cursor.execute(</span><br><span class="line">                <span class="string">f"SELECT task_id, title, due_date FROM <span class="subst">{self.task_repo.table_name}</span> t1 WHERE EXISTS (SELECT 1 FROM <span class="subst">{self.task_repo.table_name}</span> t2 WHERE t2.task_id = t1.task_id AND t2.due_date = date('now')) ORDER BY priority"</span>)</span><br><span class="line">            today_tasks = <span class="variable language_">self</span>.cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"今天 (<span class="subst">{datetime.now().strftime(<span class="string">'%Y-%m-%d'</span>)}</span>) 到期的任务 (<span class="subst">{<span class="built_in">len</span>(today_tasks)}</span> 条):"</span>)</span><br><span class="line">            <span class="keyword">for</span> task <span class="keyword">in</span> today_tasks: print_result_item(task)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            print_error(<span class="string">f"执行原生 SQL 查询时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_demonstrate_repository_queries</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""(私有方法) 演示使用 TaskRepository 方法进行查询"""</span></span><br><span class="line">        print_header(<span class="string">"演示: 使用 Repository 方法进行查询"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.task_repo:</span><br><span class="line">            print_error(<span class="string">"TaskRepository 未初始化。"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            print_subheader(<span class="string">"1. 查找优先级为 1 的任务"</span>)</span><br><span class="line">            priority_1_tasks = <span class="variable language_">self</span>.task_repo.find_by_criteria({<span class="string">"priority"</span>: <span class="number">1</span>})</span><br><span class="line">            print_info(<span class="string">f"找到 <span class="subst">{<span class="built_in">len</span>(priority_1_tasks)}</span> 条:"</span>)</span><br><span class="line">            <span class="keyword">for</span> task <span class="keyword">in</span> priority_1_tasks: print_result_item(task)</span><br><span class="line"></span><br><span class="line">            print_subheader(<span class="string">"2. 查找已完成的任务"</span>)</span><br><span class="line">            completed_tasks = <span class="variable language_">self</span>.task_repo.find_by_criteria({<span class="string">"is_completed"</span>: <span class="literal">True</span>})</span><br><span class="line">            print_info(<span class="string">f"找到 <span class="subst">{<span class="built_in">len</span>(completed_tasks)}</span> 条:"</span>)</span><br><span class="line">            <span class="keyword">for</span> task <span class="keyword">in</span> completed_tasks: print_result_item(task)</span><br><span class="line"></span><br><span class="line">            print_subheader(<span class="string">"3. 搜索标题中包含 '代码' 的任务"</span>)</span><br><span class="line">            code_tasks = <span class="variable language_">self</span>.task_repo.find_by_title_contains(<span class="string">"代码"</span>)</span><br><span class="line">            print_info(<span class="string">f"找到 <span class="subst">{<span class="built_in">len</span>(code_tasks)}</span> 条:"</span>)</span><br><span class="line">            <span class="keyword">for</span> task <span class="keyword">in</span> code_tasks: print_result_item(task)</span><br><span class="line"></span><br><span class="line">            print_subheader(<span class="string">"4. 组合条件查询 (优先级=2 且 未完成)"</span>)</span><br><span class="line">            prio2_incomplete = <span class="variable language_">self</span>.task_repo.find_by_criteria({<span class="string">"priority"</span>: <span class="number">2</span>, <span class="string">"is_completed"</span>: <span class="literal">False</span>})</span><br><span class="line">            print_info(<span class="string">f"找到 <span class="subst">{<span class="built_in">len</span>(prio2_incomplete)}</span> 条:"</span>)</span><br><span class="line">            <span class="keyword">for</span> task <span class="keyword">in</span> prio2_incomplete: print_result_item(task)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print_error(<span class="string">f"使用 Repository 查询时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_demonstrate_service_queries</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""(私有方法) 演示使用 TaskService 方法进行业务查询"""</span></span><br><span class="line">        print_header(<span class="string">"演示: 使用 Service 层进行业务查询"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.task_service:</span><br><span class="line">            print_error(<span class="string">"TaskService 未初始化。"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            print_subheader(<span class="string">"1. 获取未完成的任务"</span>)</span><br><span class="line">            incomplete_tasks = <span class="variable language_">self</span>.task_service.get_incomplete_tasks()</span><br><span class="line">            print_info(<span class="string">f"找到 <span class="subst">{<span class="built_in">len</span>(incomplete_tasks)}</span> 条:"</span>)</span><br><span class="line">            <span class="keyword">for</span> task <span class="keyword">in</span> incomplete_tasks[:<span class="number">3</span>]: print_result_item(task)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(incomplete_tasks) &gt; <span class="number">3</span>: print_info(<span class="string">f"    ... 及其他 <span class="subst">{<span class="built_in">len</span>(incomplete_tasks) - <span class="number">3</span>}</span> 条"</span>)</span><br><span class="line"></span><br><span class="line">            print_subheader(<span class="string">"2. 获取未来 7 天内到期的任务"</span>)</span><br><span class="line">            due_soon_tasks = <span class="variable language_">self</span>.task_service.get_tasks_due_within_days(<span class="number">7</span>)</span><br><span class="line">            print_info(<span class="string">f"找到 <span class="subst">{<span class="built_in">len</span>(due_soon_tasks)}</span> 条:"</span>)</span><br><span class="line">            <span class="keyword">for</span> task <span class="keyword">in</span> due_soon_tasks: print_result_item(task)</span><br><span class="line"></span><br><span class="line">            print_subheader(<span class="string">"3. 获取已逾期的未完成任务"</span>)</span><br><span class="line">            overdue_tasks = <span class="variable language_">self</span>.task_service.get_overdue_tasks()</span><br><span class="line">            print_info(<span class="string">f"找到 <span class="subst">{<span class="built_in">len</span>(overdue_tasks)}</span> 条:"</span>)</span><br><span class="line">            <span class="keyword">for</span> task <span class="keyword">in</span> overdue_tasks: print_result_item(task)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print_error(<span class="string">f"使用 Service 查询时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        执行完整的演示流程: 设置 -&gt; 填充数据 -&gt; 各种查询演示 -&gt; 清理。</span></span><br><span class="line"><span class="string">        使用 try...finally 确保数据库连接总是被关闭。</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># --- 步骤 1: 设置数据库和框架 ---</span></span><br><span class="line">            <span class="comment"># 使用 with 语句确保连接在 setup 完成后也可用，</span></span><br><span class="line">            <span class="comment"># 同时在 run 方法结束时通过 finally 关闭。</span></span><br><span class="line">            <span class="comment"># 或者，让 setup 返回 conn/cursor/repo/service</span></span><br><span class="line">            <span class="variable language_">self</span>._setup_database_and_framework()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- 步骤 2: 执行各种查询演示 ---</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.cursor: <span class="variable language_">self</span>._demonstrate_raw_sql()</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.task_repo: <span class="variable language_">self</span>._demonstrate_repository_queries()</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.task_service: <span class="variable language_">self</span>._demonstrate_service_queries()</span><br><span class="line"></span><br><span class="line">            print_success(<span class="string">"\n所有查询演示执行完毕。"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> ConnectionError <span class="keyword">as</span> ce:</span><br><span class="line">            print_error(<span class="string">f"数据库连接错误: <span class="subst">{ce}</span>"</span>)</span><br><span class="line">        <span class="keyword">except</span> RuntimeError <span class="keyword">as</span> rte:  <span class="comment"># 捕获 setup 中可能抛出的错误</span></span><br><span class="line">            print_error(<span class="string">f"运行时错误 (可能在设置或填充数据时): <span class="subst">{rte}</span>"</span>)</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> db_err:</span><br><span class="line">            print_error(<span class="string">f"数据库操作错误: <span class="subst">{db_err}</span>"</span>)</span><br><span class="line">            <span class="keyword">import</span> traceback</span><br><span class="line">            traceback.print_exc()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print_error(<span class="string">f"发生意外错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">import</span> traceback</span><br><span class="line">            traceback.print_exc()</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># --- 步骤 3: 清理 ---</span></span><br><span class="line">            <span class="comment"># 无论 run 方法中发生什么，都确保关闭连接</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.db_manager:</span><br><span class="line">                <span class="variable language_">self</span>.db_manager.close()</span><br><span class="line">            print_header(<span class="string">"高级查询演示流程结束"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 脚本入口 ---</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 1. 创建演示类的实例</span></span><br><span class="line">    demo = AdvancedQueryDemoOO()</span><br><span class="line">    <span class="comment"># 2. 运行演示</span></span><br><span class="line">    demo.run()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>代码解释 (advanced_queries.py):</strong></p><ul><li><strong>目的:</strong> 展示更复杂的 SQL 查询以及如何在不同层次（原生 SQL, Repository, Service）执行它们。</li><li><strong><code>populate_test_data</code>:</strong> 创建了多样化的任务数据，包括不同的优先级、截止日期和完成状态，为后续复杂查询提供基础。</li><li><strong><code>run_raw_sql_queries</code>:</strong> 直接使用 <code>cursor</code> 执行 SQL。这展示了：<ul><li><strong>聚合函数 (<code>COUNT</code>, <code>SUM</code>) 和 <code>GROUP BY</code>:</strong> 用于统计分析。</li><li><strong><code>CASE</code> 表达式:</strong> 在 SQL 中实现条件逻辑。</li><li><strong>复杂 <code>WHERE</code> 子句:</strong> 结合 <code>AND</code>, <code>OR</code>, 比较运算符, <code>IS NOT NULL</code> 和 SQLite 内建日期函数 (<code>date('now', '+7 days')</code>)。</li><li><strong><code>ORDER BY</code> 多列排序。</strong></li><li><strong><code>LIMIT</code> 和 <code>OFFSET</code>:</strong> 实现分页。</li><li><strong><code>EXISTS</code> 子查询:</strong> 进行基于关联的条件判断。</li><li><strong>优点:</strong> 可以利用数据库特定的高级功能，或编写 ORM 难以表达的优化查询。</li><li><strong>缺点:</strong> 绕过了框架的封装，代码与数据库耦合，容易出错，且有 SQL 注入风险（如果不是硬编码 SQL 的话）。</li></ul></li><li><strong><code>run_repository_queries</code>:</strong> 使用 <code>TaskRepository</code> 提供的 <code>find_by_criteria</code> 和 <code>find_by_title_contains</code> 方法。展示了通过抽象接口进行条件查询。</li><li><strong><code>run_service_queries</code>:</strong> 使用 <code>TaskService</code> 提供的面向业务的方法，如 <code>get_incomplete_tasks</code>, <code>get_tasks_due_within_days</code>, <code>get_overdue_tasks</code>。这体现了 Service 层封装业务逻辑查询的优势。</li><li><strong><code>run_advanced_queries_main</code>:</strong> 主函数负责初始化框架组件（使用 <code>with DatabaseManager</code>），调用数据填充函数，然后依次调用三种查询方式的演示函数。</li></ul><hr><h3 id="16-2-MySQL-数据库-使用-PyMySQL-驱动"><a href="#16-2-MySQL-数据库-使用-PyMySQL-驱动" class="headerlink" title="16.2 MySQL 数据库 (使用 PyMySQL 驱动)"></a>16.2 MySQL 数据库 (使用 <code>PyMySQL</code> 驱动)</h3><p><strong>16.2.1 简介</strong></p><ul><li><strong>MySQL:</strong> 是一个非常流行的开源<strong>关系型数据库管理系统 (RDBMS)</strong>，广泛用于各种规模的应用程序，尤其是 Web 应用。它采用客户端-服务器架构，需要独立的服务器进程。</li><li><strong>PyMySQL:</strong> 是一个让 Python 程序能够连接并操作 MySQL 数据库的<strong>纯 Python 驱动库</strong>。它实现了 Python 的 <strong>DB-API 2.0 (PEP 249)</strong> 规范，提供了一套标准的数据库操作接口。</li><li><strong>前提:</strong> 在使用 <code>PyMySQL</code> 前，你需要确保：<ol><li>本地或远程有一个正在运行的 MySQL 服务器 (版本 5.5 或更高)。</li><li>你拥有连接该服务器所需的<strong>主机地址、端口号、用户名、密码</strong>。</li><li>服务器上已经<strong>创建了你要操作的数据库</strong>。</li></ol></li><li><strong>安装:</strong><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install PyMySQL</span><br></pre></td></tr></tbody></table></figure></li><li><strong>与 <code>sqlite3</code> 主要不同:</strong><ul><li>需要网络连接到服务器。</li><li>连接时参数更多。</li><li>SQL 参数占位符是 <strong><code>%s</code></strong>。</li><li>需要特别注意<strong>字符集 (<code>utf8mb4</code>)</strong> 和<strong>游标类型 (<code>DictCursor</code>)</strong> 的设置。</li><li>连接管理（关闭/连接池）更为重要。</li></ul></li></ul><p><strong>16.2.2 建立连接</strong></p><p>连接是与 MySQL 服务器交互的第一步。</p><p>我们把上一章的打印工具给拿过来，放置在根目录<code>print_utils</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">打印工具模块，提供彩色和结构化的打印函数。</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======== 彩色打印工具 ========</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Colors</span>:</span><br><span class="line">    HEADER = <span class="string">'\033[95m'</span></span><br><span class="line">    BLUE = <span class="string">'\033[94m'</span></span><br><span class="line">    CYAN = <span class="string">'\033[96m'</span></span><br><span class="line">    GREEN = <span class="string">'\033[92m'</span></span><br><span class="line">    WARNING = <span class="string">'\033[93m'</span></span><br><span class="line">    FAIL = <span class="string">'\033[91m'</span></span><br><span class="line">    BOLD = <span class="string">'\033[1m'</span></span><br><span class="line">    UNDERLINE = <span class="string">'\033[4m'</span></span><br><span class="line">    END = <span class="string">'\033[0m'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_header</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n<span class="subst">{Colors.HEADER}</span><span class="subst">{Colors.BOLD}</span>--- <span class="subst">{text}</span> ---<span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_subheader</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n<span class="subst">{Colors.CYAN}</span><span class="subst">{Colors.UNDERLINE}</span>  <span class="subst">{text}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_info</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"  <span class="subst">{text}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_success</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Colors.GREEN}</span>  ✔ <span class="subst">{text}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_warning</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Colors.WARNING}</span>  ⚠️ [Warning] <span class="subst">{text}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_error</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Colors.FAIL}</span>  ❌ [Error] <span class="subst">{text}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_sql</span>(<span class="params">sql: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{Colors.BLUE}</span>    SQL: <span class="subst">{sql.strip()}</span><span class="subst">{Colors.END}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_result_item</span>(<span class="params">item, indent: <span class="built_in">int</span> = <span class="number">4</span></span>):</span><br><span class="line">    prefix = <span class="string">" "</span> * indent</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">dict</span>):</span><br><span class="line">        details = <span class="string">", "</span>.join([</span><br><span class="line">            <span class="string">f"<span class="subst">{Colors.BOLD}</span><span class="subst">{key}</span><span class="subst">{Colors.END}</span>: <span class="subst">{<span class="built_in">repr</span>(value)}</span>"</span> <span class="keyword">for</span> key, value <span class="keyword">in</span> item.items()</span><br><span class="line">        ])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{prefix}</span>Row(<span class="subst">{details}</span>)"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"<span class="subst">{prefix}</span><span class="subst">{<span class="built_in">repr</span>(item)}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======== END 彩色打印工具 ======== </span></span><br></pre></td></tr></tbody></table></figure><p>当我们需要使用时，直接<code>from导入</code>并像调用函数一样调用即可</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --- PyMySQL 连接示例 ---</span></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> pymysql.cursors <span class="keyword">import</span> DictCursor <span class="comment"># 导入字典游标类</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Tuple</span>, <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span> <span class="comment"># 类型提示</span></span><br><span class="line"><span class="keyword">from</span> sqlite_practice.utils.print_utils <span class="keyword">import</span> (</span><br><span class="line">    Colors, print_header, print_subheader, print_info, print_success, print_warning, print_error, print_sql, print_result_item</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 数据库连接配置 ---</span></span><br><span class="line"><span class="comment"># !!! 警告: 生产环境中绝不应硬编码密码! 应使用更安全的方式管理凭证 !!!</span></span><br><span class="line">DB_CONFIG: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = {</span><br><span class="line">    <span class="string">'host'</span>: <span class="string">'localhost'</span>,            <span class="comment"># MySQL 服务器主机名或 IP 地址</span></span><br><span class="line">    <span class="string">'port'</span>: <span class="number">3306</span>,                   <span class="comment"># MySQL 默认端口</span></span><br><span class="line">    <span class="string">'user'</span>: <span class="string">'root'</span>,            <span class="comment"># 替换为你的 MySQL 用户名</span></span><br><span class="line">    <span class="string">'password'</span>: <span class="string">'root'</span>,    <span class="comment"># 替换为你的 MySQL 密码</span></span><br><span class="line">    <span class="string">'database'</span>: <span class="string">'pymysql_demo_db'</span>,  <span class="comment"># 替换为你要连接的数据库名 (需预先创建)</span></span><br><span class="line">    <span class="string">'charset'</span>: <span class="string">'utf8mb4'</span>,           <span class="comment"># !!! 强烈推荐: 支持完整 Unicode, 包括 emoji !!!</span></span><br><span class="line">    <span class="string">'cursorclass'</span>: DictCursor,      <span class="comment"># !!! 强烈推荐: 让查询结果以字典形式返回 !!!</span></span><br><span class="line">    <span class="string">'autocommit'</span>: <span class="literal">False</span>,            <span class="comment"># !!! 推荐: 关闭自动提交，显式控制事务 !!!</span></span><br><span class="line">    <span class="string">'connect_timeout'</span>: <span class="number">10</span>           <span class="comment"># (可选) 连接超时时间 (秒)</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 获取数据库连接的函数 ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_mysql_connection</span>() -&gt; <span class="type">Optional</span>[pymysql.connections.Connection]:</span><br><span class="line">    <span class="string">"""尝试建立到 MySQL 数据库的连接。"""</span></span><br><span class="line">    print_info(<span class="string">f"尝试连接到 MySQL: <span class="subst">{DB_CONFIG[<span class="string">'host'</span>]}</span>:<span class="subst">{DB_CONFIG[<span class="string">'port'</span>]}</span>, Database: <span class="subst">{DB_CONFIG[<span class="string">'database'</span>]}</span>"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        connection = pymysql.connect(**DB_CONFIG)</span><br><span class="line">        print_success(<span class="string">f"成功连接到数据库 '<span class="subst">{DB_CONFIG[<span class="string">'database'</span>]}</span>'"</span>)</span><br><span class="line">        <span class="keyword">return</span> connection</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"数据库连接失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        print_warning(<span class="string">"  请检查 DB_CONFIG 配置、MySQL 服务器状态及网络连接。"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>连接参数关键点:</strong></p><ul><li><strong><code>charset='utf8mb4'</code></strong>: 确保可以正确处理各种字符，包括表情符号。数据库、表、列也应使用此字符集。</li><li><strong><code>cursorclass=DictCursor</code></strong>: 使 <code>cursor.fetchone()</code> 返回字典，<code>cursor.fetchall()</code> 返回字典列表。可通过 <code>row['column_name']</code> 访问数据，比元组索引更易读。</li><li><strong><code>autocommit=False</code></strong>: 禁用自动提交。所有 <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code> 操作都需要显式调用 <code>conn.commit()</code> 才生效，便于事务管理。</li><li><strong>安全:</strong> 绝不在代码中硬编码生产环境的密码。使用环境变量、配置文件、Secrets Manager 等安全机制。</li></ul><p><strong>16.2.3 核心 API 概览</strong></p><p><code>PyMySQL</code> 遵循 DB-API 2.0 规范，核心 API 与 <code>sqlite3</code> 类似，但注意占位符和游标类型。</p><table><thead><tr><th align="left">API</th><th align="left">描述</th><th align="left">注意事项</th></tr></thead><tbody><tr><td align="left"><code>pymysql.connect(**config)</code></td><td align="left">连接 MySQL，返回 <code>Connection</code> 对象。</td><td align="left">参数多，需网络</td></tr><tr><td align="left"><code>connection.cursor([cursorclass])</code></td><td align="left">创建 <code>Cursor</code> 对象 (推荐 <code>DictCursor</code>)。</td><td align="left"><code>DictCursor</code> 返回字典</td></tr><tr><td align="left"><code>cursor.execute(sql, [args])</code></td><td align="left">执行单条 SQL (用 <strong><code>%s</code></strong> 占位符)。返回受影响行数。</td><td align="left"><strong><code>%s</code> 占位符</strong></td></tr><tr><td align="left"><code>cursor.executemany(sql, seq_of_args)</code></td><td align="left">批量执行 SQL (用 <strong><code>%s</code></strong>)。返回受影响总行数 (可能不精确)。</td><td align="left"><strong><code>%s</code> 占位符</strong></td></tr><tr><td align="left"><code>connection.commit()</code></td><td align="left">提交当前事务。</td><td align="left"><code>autocommit=False</code> 时必需</td></tr><tr><td align="left"><code>connection.rollback()</code></td><td align="left">回滚当前事务。</td><td align="left"></td></tr><tr><td align="left"><code>connection.begin()</code></td><td align="left">显式开始事务 (若 <code>autocommit=False</code>)。</td><td align="left">可选，但更清晰</td></tr><tr><td align="left"><code>cursor.fetchone()</code></td><td align="left">获取下一行结果 (字典或元组)，无结果时 <code>None</code>。</td><td align="left">依赖 <code>cursorclass</code></td></tr><tr><td align="left"><code>cursor.fetchall()</code></td><td align="left">获取所有剩余行结果 (字典或元组的列表)。</td><td align="left">依赖 <code>cursorclass</code></td></tr><tr><td align="left"><code>cursor.lastrowid</code></td><td align="left">(属性) 最后 INSERT 操作的自增 ID (<code>AUTO_INCREMENT</code> 列)。</td><td align="left"></td></tr><tr><td align="left"><code>cursor.rowcount</code></td><td align="left">(属性) 最后操作影响的行数 (对 SELECT 可能不同数据库行为有差异)。</td><td align="left"></td></tr><tr><td align="left"><code>connection.close()</code></td><td align="left"><strong>必须调用</strong>关闭网络连接。</td><td align="left"><strong>极其重要</strong></td></tr><tr><td align="left"><code>with connection.cursor() as cursor:</code></td><td align="left">(推荐) 游标上下文管理器，自动关闭游标。</td><td align="left"></td></tr><tr><td align="left"><code>connection.ping(reconnect=True)</code></td><td align="left">检查连接活性，可选重连。</td><td align="left">用于长连接场景</td></tr></tbody></table><p><strong>16.2.4 准备工作：创建表与填充数据</strong></p><p>为了演示查询，我们创建 <code>categories</code> 和 <code>products</code> 表。</p><p><strong>categories 表</strong></p><table><thead><tr><th>列名</th><th>数据类型</th><th>是否允许 NULL</th><th>键</th><th>默认值</th><th>额外</th><th>注释</th></tr></thead><tbody><tr><td>category_id</td><td>INT UNSIGNED</td><td>NO</td><td>PRI</td><td>—</td><td>AUTO_INCREMENT</td><td>产品类别主键</td></tr><tr><td>name</td><td>VARCHAR(50)</td><td>NO</td><td>UNI</td><td>—</td><td></td><td>类别名称</td></tr><tr><td>description</td><td>TEXT</td><td>YES</td><td></td><td>NULL</td><td></td><td>类别描述</td></tr></tbody></table><hr><p><strong>products 表</strong></p><table><thead><tr><th>列名</th><th>数据类型</th><th>是否允许 NULL</th><th>键</th><th>默认值</th><th>额外</th><th>注释</th></tr></thead><tbody><tr><td>id</td><td>INT UNSIGNED</td><td>NO</td><td>PRI</td><td>—</td><td>AUTO_INCREMENT</td><td>产品ID</td></tr><tr><td>name</td><td>VARCHAR(100)</td><td>NO</td><td></td><td>—</td><td></td><td>产品名称</td></tr><tr><td>price</td><td>DECIMAL(10, 2)</td><td>NO</td><td></td><td>—</td><td></td><td>价格</td></tr><tr><td>stock</td><td>INT UNSIGNED</td><td>NO</td><td></td><td>0</td><td></td><td>库存</td></tr><tr><td>category_id</td><td>INT UNSIGNED</td><td>YES</td><td>MUL</td><td>NULL</td><td></td><td>外键，关联 categories.category_id</td></tr><tr><td>added_date</td><td>DATE</td><td>YES</td><td></td><td>NULL</td><td></td><td>上架日期</td></tr><tr><td>created_at</td><td>TIMESTAMP</td><td>YES</td><td></td><td>CURRENT_TIMESTAMP</td><td></td><td>创建时间</td></tr><tr><td>updated_at</td><td>TIMESTAMP</td><td>YES</td><td></td><td>CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</td><td></td><td>更新时间</td></tr></tbody></table><p>这两个函数仅是一次性的，用于创建表与插入数据，可以看看语法，也可以不看，简单的SQL而已</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --- PyMySQL 连接示例 ---</span></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> pymysql.cursors <span class="keyword">import</span> DictCursor <span class="comment"># 导入字典游标类</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Tuple</span>, <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span> <span class="comment"># 类型提示</span></span><br><span class="line"><span class="keyword">from</span> print_utils <span class="keyword">import</span> (</span><br><span class="line">    Colors, print_header, print_subheader, print_info, print_success, print_warning, print_error, print_sql, print_result_item</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 数据库连接配置 ---</span></span><br><span class="line"><span class="comment"># !!! 警告: 生产环境中绝不应硬编码密码! 应使用更安全的方式管理凭证 !!!</span></span><br><span class="line">DB_CONFIG: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = {</span><br><span class="line">    <span class="string">'host'</span>: <span class="string">'localhost'</span>,            <span class="comment"># MySQL 服务器主机名或 IP 地址</span></span><br><span class="line">    <span class="string">'port'</span>: <span class="number">3306</span>,                   <span class="comment"># MySQL 默认端口</span></span><br><span class="line">    <span class="string">'user'</span>: <span class="string">'root'</span>,            <span class="comment"># 替换为你的 MySQL 用户名</span></span><br><span class="line">    <span class="string">'password'</span>: <span class="string">'root'</span>,    <span class="comment"># 替换为你的 MySQL 密码</span></span><br><span class="line">    <span class="string">'database'</span>: <span class="string">'pymysql_demo_db'</span>,  <span class="comment"># 替换为你要连接的数据库名 (需预先创建)</span></span><br><span class="line">    <span class="string">'charset'</span>: <span class="string">'utf8mb4'</span>,           <span class="comment"># !!! 强烈推荐: 支持完整 Unicode, 包括 emoji !!!</span></span><br><span class="line">    <span class="string">'cursorclass'</span>: DictCursor,      <span class="comment"># !!! 强烈推荐: 让查询结果以字典形式返回 !!!</span></span><br><span class="line">    <span class="string">'autocommit'</span>: <span class="literal">False</span>,            <span class="comment"># !!! 推荐: 关闭自动提交，显式控制事务 !!!</span></span><br><span class="line">    <span class="string">'connect_timeout'</span>: <span class="number">10</span>           <span class="comment"># (可选) 连接超时时间 (秒)</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_mysql_connection</span>() -&gt; <span class="type">Optional</span>[pymysql.Connection]:</span><br><span class="line">    <span class="string">"""创建 MySQL 连接"""</span></span><br><span class="line">    print_info(<span class="string">f"尝试连接到 MySQL: <span class="subst">{DB_CONFIG[<span class="string">'host'</span>]}</span>:<span class="subst">{DB_CONFIG[<span class="string">'port'</span>]}</span>, Database: <span class="subst">{DB_CONFIG[<span class="string">'database'</span>]}</span>"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        connection = pymysql.connect(**DB_CONFIG)</span><br><span class="line">        print_success(<span class="string">"连接成功"</span>)</span><br><span class="line">        <span class="keyword">return</span> connection</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"数据库连接失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        print_warning(<span class="string">"  请检查 DB_CONFIG 配置、MySQL 服务器状态及网络连接。"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 表结构定义与创建 ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_mysql_tables</span>(<span class="params">conn: pymysql.connections.Connection</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">"""创建演示所需的 categories 和 products 表。"""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            print_info(<span class="string">"开始创建表..."</span>)</span><br><span class="line">            cursor.execute(<span class="string">"DROP TABLE IF EXISTS products;"</span>)  <span class="comment"># 先删除依赖表</span></span><br><span class="line">            cursor.execute(<span class="string">"DROP TABLE IF EXISTS categories;"</span>)  <span class="comment"># 再删除主表</span></span><br><span class="line">            print_warning(<span class="string">"  (旧表 'products' 和 'categories' 已删除，如果存在)"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- 创建 categories 表 ---</span></span><br><span class="line">            cursor.execute(<span class="string">"""</span></span><br><span class="line"><span class="string">            CREATE TABLE categories (</span></span><br><span class="line"><span class="string">                category_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,</span></span><br><span class="line"><span class="string">                name VARCHAR(50) NOT NULL UNIQUE COMMENT '类别名称',</span></span><br><span class="line"><span class="string">                description TEXT COMMENT '类别描述'</span></span><br><span class="line"><span class="string">            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='产品类别表';</span></span><br><span class="line"><span class="string">            """</span>)</span><br><span class="line">            print_success(<span class="string">"表 'categories' 创建成功。"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- 创建 products 表 (包含外键) ---</span></span><br><span class="line">            cursor.execute(<span class="string">"""</span></span><br><span class="line"><span class="string">            CREATE TABLE products (</span></span><br><span class="line"><span class="string">                id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '产品ID',</span></span><br><span class="line"><span class="string">                name VARCHAR(100) NOT NULL COMMENT '产品名称',</span></span><br><span class="line"><span class="string">                price DECIMAL(10, 2) NOT NULL COMMENT '价格',</span></span><br><span class="line"><span class="string">                stock INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '库存',</span></span><br><span class="line"><span class="string">                category_id INT UNSIGNED COMMENT '外键, 关联 categories 表', </span></span><br><span class="line"><span class="string">                added_date DATE COMMENT '上架日期',</span></span><br><span class="line"><span class="string">                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',</span></span><br><span class="line"><span class="string">                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',</span></span><br><span class="line"><span class="string">                INDEX idx_prod_name (name(20)), -- 名称前缀索引</span></span><br><span class="line"><span class="string">                FOREIGN KEY fk_prod_cat (category_id) REFERENCES categories(category_id) </span></span><br><span class="line"><span class="string">                    ON DELETE SET NULL  -- 删除类别时，产品类别设为 NULL</span></span><br><span class="line"><span class="string">                    ON UPDATE CASCADE   -- 更新类别 ID 时，产品自动更新 </span></span><br><span class="line"><span class="string">            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='产品信息表';</span></span><br><span class="line"><span class="string">            """</span>)</span><br><span class="line">            print_success(<span class="string">"表 'products' 创建成功。"</span>)</span><br><span class="line">        conn.commit()  <span class="comment"># 提交 DDL 更改</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"创建表失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        conn.rollback()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 数据填充 ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">populate_mysql_data</span>(<span class="params">conn: pymysql.connections.Connection</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">"""向 categories 和 products 表填充测试数据。"""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            print_info(<span class="string">"开始填充测试数据..."</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- 插入类别 ---</span></span><br><span class="line">            categories_data = [</span><br><span class="line">                (<span class="string">'电子产品'</span>, <span class="string">'手机、电脑、配件等'</span>), (<span class="string">'图书音像'</span>, <span class="string">'各类实体书籍和数字媒体'</span>),</span><br><span class="line">                (<span class="string">'服装鞋包'</span>, <span class="string">'男女服装、鞋子和箱包'</span>), (<span class="string">'家居生活'</span>, <span class="string">'家具、厨具、家纺等'</span>),</span><br><span class="line">            ]</span><br><span class="line">            cat_sql = <span class="string">"INSERT INTO categories (name, description) VALUES (%s, %s)"</span></span><br><span class="line">            cursor.executemany(cat_sql, categories_data)</span><br><span class="line">            print_success(<span class="string">f"  插入了 <span class="subst">{cursor.rowcount}</span> 个类别。"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- 获取类别 ID 用于关联 ---</span></span><br><span class="line">            <span class="comment"># 注意：更可靠的方式是按名称查询获取 ID，这里简化</span></span><br><span class="line">            cursor.execute(<span class="string">"SELECT category_id, name FROM categories"</span>)</span><br><span class="line">            cat_map = {row[<span class="string">'name'</span>]: row[<span class="string">'category_id'</span>] <span class="keyword">for</span> row <span class="keyword">in</span> cursor.fetchall()}</span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- 插入产品 ---</span></span><br><span class="line">            products_data = [</span><br><span class="line">                (<span class="string">'智能手机 V12'</span>, <span class="number">4999.00</span>, <span class="number">50</span>, cat_map[<span class="string">'电子产品'</span>], <span class="string">'2024-10-01'</span>),</span><br><span class="line">                (<span class="string">'蓝牙耳机 AirSound'</span>, <span class="number">799.00</span>, <span class="number">100</span>, cat_map[<span class="string">'电子产品'</span>], <span class="string">'2024-11-15'</span>),</span><br><span class="line">                (<span class="string">'PyMySQL 深度指南'</span>, <span class="number">88.50</span>, <span class="number">200</span>, cat_map[<span class="string">'图书音像'</span>], <span class="string">'2023-05-20'</span>),</span><br><span class="line">                (<span class="string">'算法导论 (原版)'</span>, <span class="number">128.00</span>, <span class="number">80</span>, cat_map[<span class="string">'图书音像'</span>], <span class="string">'2024-01-10'</span>),</span><br><span class="line">                (<span class="string">'纯棉印花 T 恤'</span>, <span class="number">129.00</span>, <span class="number">300</span>, cat_map[<span class="string">'服装鞋包'</span>], <span class="string">'2024-08-01'</span>),</span><br><span class="line">                (<span class="string">'透气运动跑鞋'</span>, <span class="number">499.00</span>, <span class="number">60</span>, cat_map[<span class="string">'服装鞋包'</span>], <span class="string">'2024-09-01'</span>),</span><br><span class="line">                (<span class="string">'北欧风实木餐桌'</span>, <span class="number">2899.00</span>, <span class="number">10</span>, cat_map[<span class="string">'家居生活'</span>], <span class="string">'2023-12-01'</span>),</span><br><span class="line">                (<span class="string">'乳胶记忆棉枕头'</span>, <span class="number">159.00</span>, <span class="number">150</span>, cat_map[<span class="string">'家居生活'</span>], <span class="string">'2024-03-01'</span>),</span><br><span class="line">                (<span class="string">'游戏本 RTX 9000'</span>, <span class="number">12999.00</span>, <span class="number">20</span>, cat_map[<span class="string">'电子产品'</span>], <span class="literal">None</span>),</span><br><span class="line">                (<span class="string">'科幻短篇小说集'</span>, <span class="number">65.00</span>, <span class="number">120</span>, cat_map[<span class="string">'图书音像'</span>], <span class="string">'2024-06-15'</span>),</span><br><span class="line">                (<span class="string">'速干运动短裤'</span>, <span class="number">189.00</span>, <span class="number">100</span>, <span class="literal">None</span>, <span class="string">'2024-07-01'</span>),  <span class="comment"># 无类别</span></span><br><span class="line">                (<span class="string">'咖啡机'</span>, <span class="number">899.00</span>, <span class="number">30</span>, cat_map[<span class="string">'家居生活'</span>], <span class="string">'2024-05-01'</span>),</span><br><span class="line">                (<span class="string">'SQL 查询的艺术'</span>, <span class="number">75.00</span>, <span class="number">90</span>, cat_map[<span class="string">'图书音像'</span>], <span class="string">'2024-04-15'</span>)</span><br><span class="line">            ]</span><br><span class="line">            prod_sql = <span class="string">"INSERT INTO products (name, price, stock, category_id, added_date) VALUES (%s, %s, %s, %s, %s)"</span></span><br><span class="line">            cursor.executemany(prod_sql, products_data)</span><br><span class="line">            print_success(<span class="string">f"  插入了 <span class="subst">{cursor.rowcount}</span> 个产品。"</span>)</span><br><span class="line"></span><br><span class="line">        conn.commit()  <span class="comment"># 提交所有插入</span></span><br><span class="line">        print_success(<span class="string">"测试数据填充完成。"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"填充数据失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        conn.rollback()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 1.连接数据库</span></span><br><span class="line">    conn = get_mysql_connection()</span><br><span class="line">    <span class="keyword">if</span> conn <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 2.创建表结构</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> setup_mysql_tables(conn):</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3.填充测试数据</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> populate_mysql_data(conn):</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4.查询数据</span></span><br><span class="line">    <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">        print_header(<span class="string">"查询数据"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="16-2-5-数据库操作：CRUD-与查询详解"><a href="#16-2-5-数据库操作：CRUD-与查询详解" class="headerlink" title="16.2.5 数据库操作：CRUD 与查询详解"></a>16.2.5 <strong>数据库操作：CRUD 与查询详解</strong></h4><h5 id="16-2-5-1-插入数据-INSERT"><a href="#16-2-5-1-插入数据-INSERT" class="headerlink" title="16.2.5.1 插入数据 (INSERT)"></a>16.2.5.1 插入数据 (INSERT)</h5><h6 id="插入单行记录"><a href="#插入单行记录" class="headerlink" title="插入单行记录"></a>插入单行记录</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">insert_single_product</span>(<span class="params">conn: pymysql.Connection, product_name: <span class="built_in">str</span>, price: <span class="built_in">float</span>, stock: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">                          category_id: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>, added_date: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    插入单个产品记录</span></span><br><span class="line"><span class="string">    :param conn: 数据库连接</span></span><br><span class="line"><span class="string">    :param product_name: 产品名称</span></span><br><span class="line"><span class="string">    :param price: 产品价格</span></span><br><span class="line"><span class="string">    :param stock: 产品库存</span></span><br><span class="line"><span class="string">    :param category_id: 产品分类 ID (可选)</span></span><br><span class="line"><span class="string">    :param added_date: 产品添加日期 (可选)</span></span><br><span class="line"><span class="string">    :return: 新插入的产品 ID (若插入失败则返回 None)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    sql = <span class="string">"""</span></span><br><span class="line"><span class="string">    INSERT INTO products (name, price, stock, category_id, added_date) </span></span><br><span class="line"><span class="string">    VALUES (%s, %s, %s, %s, %s) </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    params = (product_name, price, stock, category_id, added_date)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(sql, params)</span><br><span class="line">            new_id = cursor.lastrowid  <span class="comment"># 获取自增主键值</span></span><br><span class="line">        conn.commit()</span><br><span class="line">        print_success(<span class="string">f"成功插入产品：<span class="subst">{product_name}</span> (ID: <span class="subst">{new_id}</span>)"</span>)</span><br><span class="line">        <span class="keyword">return</span> new_id</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"插入产品失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        conn.rollback()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 1.连接数据库</span></span><br><span class="line">    conn = get_mysql_connection()</span><br><span class="line">    <span class="keyword">if</span> conn <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        new_id = insert_single_product(conn, product_name=<span class="string">'iPhone X'</span>, price=<span class="number">9999.99</span>, stock=<span class="number">100</span>, category_id=<span class="number">1</span>,</span><br><span class="line">                                       added_date=<span class="string">'2021-01-01'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> new_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            print_success(<span class="string">f"新插入的产品 ID: <span class="subst">{new_id}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"插入产品失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="批量插入记录-executemany"><a href="#批量插入记录-executemany" class="headerlink" title="批量插入记录 (executemany)"></a>批量插入记录 (<code>executemany</code>)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">insert_multiple_products</span>(<span class="params">conn: pymysql.Connection, products_list: <span class="type">List</span>[<span class="type">Tuple</span>]</span>) -&gt; <span class="type">Optional</span>[<span class="type">List</span>[<span class="built_in">int</span>]]:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    批量插入产品记录</span></span><br><span class="line"><span class="string">    :param conn: 数据库连接</span></span><br><span class="line"><span class="string">    :param products_list: 产品列表 (列表项为元组，包含 (name, price, stock, category_id, added_date) 五个字段)</span></span><br><span class="line"><span class="string">    :return: 新插入的产品 ID 列表 (若插入失败则返回 None)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> products_list: <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    sql = <span class="string">"INSERT INTO products (name,price,stock,category_id,added_date,created_at) VALUES (%s,%s,%s,%s,%s,NOW())"</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.executemany(sql, products_list)</span><br><span class="line">            new_ids = [cursor.lastrowid <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(products_list))]  <span class="comment"># 获取自增主键值</span></span><br><span class="line">        conn.commit()</span><br><span class="line">        print_success(<span class="string">f"成功插入 <span class="subst">{<span class="built_in">len</span>(products_list)}</span> 个产品"</span>)</span><br><span class="line">        <span class="keyword">return</span> new_ids</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"插入产品失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        conn.rollback()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 使用 ---</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 1.创建数据库连接</span></span><br><span class="line">    conn = get_mysql_connection()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> conn:</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 演示插入多个产品</span></span><br><span class="line">    products_list = [</span><br><span class="line">        (<span class="string">'iPhone X'</span>, <span class="number">9999</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="string">'2021-01-01'</span>),</span><br><span class="line">        (<span class="string">'华为 P30 Pro'</span>, <span class="number">8888</span>, <span class="number">50</span>, <span class="number">2</span>, <span class="string">'2021-01-02'</span>),</span><br><span class="line">        (<span class="string">'小米 10'</span>, <span class="number">7777</span>, <span class="number">20</span>, <span class="number">3</span>, <span class="string">'2021-01-03'</span>),</span><br><span class="line">        (<span class="string">'OPPO Find X3'</span>, <span class="number">6666</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="string">'2021-01-04'</span>),</span><br><span class="line">        (<span class="string">'vivo NEX'</span>, <span class="number">5555</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="string">'2021-01-05'</span>),</span><br><span class="line">    ]</span><br><span class="line">    new_ids = insert_multiple_products(conn, products_list)</span><br><span class="line">    <span class="keyword">if</span> new_ids:</span><br><span class="line">        print_info(<span class="string">f"新插入的产品 ID 列表: <span class="subst">{new_ids}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><blockquote><p>注意，在使用的时候category_id 、 时不能存储4以上的，由于我们上面插入的insert外键最高为4，若需要更新为4类别的，则需要增加category_id的数量</p></blockquote><h5 id="16-2-5-2-更新数据-UPDATE"><a href="#16-2-5-2-更新数据-UPDATE" class="headerlink" title="16.2.5.2 更新数据 (UPDATE)"></a>16.2.5.2 更新数据 (UPDATE)</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update_product_stock</span>(<span class="params">conn: pymysql.Connection, product_id: <span class="built_in">int</span>, stock: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">"""更新指定产品的库存 (增加或减少)。"""</span></span><br><span class="line">    <span class="comment"># 注意：在真实应用中，直接加减可能导致并发问题，应使用更安全的更新方式</span></span><br><span class="line">    <span class="comment"># 例如：UPDATE products SET stock = stock + %s WHERE id = %s AND stock + %s &gt;= 0</span></span><br><span class="line">    <span class="comment"># 这里仅作基本 UPDATE 演示</span></span><br><span class="line">    sql_get_stock = <span class="string">"SELECT stock FROM products WHERE id = %s"</span></span><br><span class="line">    sql_update = <span class="string">"UPDATE products SET stock = %s WHERE id = %s"</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            <span class="comment"># 1.获取当前库存</span></span><br><span class="line">            cursor.execute(sql_get_stock, (product_id,))</span><br><span class="line">            result = cursor.fetchone()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">                print_warning(<span class="string">f"更新库存失败: 未找到产品 ID 为 <span class="subst">{product_id}</span> 的记录"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            current_stock = result[<span class="string">"stock"</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 2.计算新库存</span></span><br><span class="line">            new_stock = current_stock + stock</span><br><span class="line">            <span class="keyword">if</span> new_stock &lt; <span class="number">0</span>:</span><br><span class="line">                print_warning(<span class="string">f"更新库存失败: 库存不足 (当前库存: <span class="subst">{current_stock}</span>, 增加数量: <span class="subst">{stock}</span>)"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 3.执行更新</span></span><br><span class="line">            affected_rows = cursor.execute(sql_update, (new_stock, product_id))</span><br><span class="line">        conn.commit()</span><br><span class="line">        <span class="keyword">if</span> affected_rows &gt; <span class="number">0</span>:</span><br><span class="line">            print_success(<span class="string">f"成功更新产品 ID 为 <span class="subst">{product_id}</span> 的库存为 <span class="subst">{new_stock}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># rowcount 为 0 可能是 ID 不存在或值未改变</span></span><br><span class="line">            print_warning(<span class="string">f"更新库存失败: 未找到影响行数 (affected_rows: <span class="subst">{affected_rows}</span>)"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"更新库存失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        conn.rollback()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 1.创建数据库连接</span></span><br><span class="line">    conn = get_mysql_connection()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> conn:</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 2.更新商品库存</span></span><br><span class="line">    product_id = <span class="number">1</span></span><br><span class="line">    stock = <span class="number">10</span></span><br><span class="line">    <span class="keyword">if</span> update_product_stock(conn, product_id, stock):</span><br><span class="line">        print_info(<span class="string">f"库存更新成功"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print_error(<span class="string">f"库存更新失败"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="16-2-5-3-删除数据-DELETE"><a href="#16-2-5-3-删除数据-DELETE" class="headerlink" title="16.2.5.3 删除数据 (DELETE)"></a>16.2.5.3 删除数据 (DELETE)</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">delete_product_by_id</span>(<span class="params">conn: pymysql.connections.Connection, product_id: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">"""根据 ID 删除产品。"""</span></span><br><span class="line">    sql = <span class="string">"DELETE FROM products WHERE id = %s"</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            affected_rows = cursor.execute(sql, (product_id,))</span><br><span class="line">        conn.commit()</span><br><span class="line">        <span class="keyword">if</span> affected_rows &gt; <span class="number">0</span>:</span><br><span class="line">            print_success(<span class="string">f"成功删除产品 ID=<span class="subst">{product_id}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print_warning(<span class="string">f"删除产品 ID=<span class="subst">{product_id}</span> 时未找到匹配记录。"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"删除产品 ID=<span class="subst">{product_id}</span> 失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        conn.rollback()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 使用 ---</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 1.创建数据库连接</span></span><br><span class="line">    conn = get_mysql_connection()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> conn:</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 测试删除产品</span></span><br><span class="line">    affected_rows = delete_product_by_id(conn, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> affected_rows:</span><br><span class="line">        print_success(<span class="string">"删除产品成功"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print_warning(<span class="string">"删除产品失败"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="16-2-5-4-查询数据-SELECT-基础"><a href="#16-2-5-4-查询数据-SELECT-基础" class="headerlink" title="16.2.5.4 查询数据 (SELECT) - 基础"></a>16.2.5.4 查询数据 (SELECT) - 基础</h5><h6 id="查询所有列"><a href="#查询所有列" class="headerlink" title="查询所有列 (*)"></a>查询所有列 (<code>*</code>)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_header(<span class="string">"演示 SELECT 查询"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(<span class="string">"SELECT * FROM products"</span>) <span class="comment"># 核心知识点</span></span><br><span class="line">            result = cursor.fetchall() <span class="comment"># 获取全部结果集</span></span><br><span class="line">            print_info(<span class="string">f"查询结果: <span class="subst">{<span class="built_in">len</span>(result)}</span>条结果"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> result:print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="查询指定列"><a href="#查询指定列" class="headerlink" title="查询指定列"></a>查询指定列</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"查询所有产品的名称和价格 (前 5 条)"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(<span class="string">"SELECT name, price FROM products LIMIT 5"</span>)  <span class="comment"># 核心知识点 # 核心知识点</span></span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="16-2-5-5-查询数据-SELECT-条件过滤-WHERE"><a href="#16-2-5-5-查询数据-SELECT-条件过滤-WHERE" class="headerlink" title="16.2.5.5 查询数据 (SELECT) - 条件过滤 (WHERE)"></a>16.2.5.5 查询数据 (SELECT) - 条件过滤 (<code>WHERE</code>)</h5><h6 id="等于"><a href="#等于" class="headerlink" title="等于 (=)"></a>等于 (=)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"查询商品分类 ID 为 2的产品"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        category_id_to_find = <span class="number">2</span>  <span class="comment"># 假设要查询分类 ID 为 2 的产品</span></span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(<span class="string">"SELECT id,name,price FROM products Where category_id = %s"</span>, (category_id_to_find,))  <span class="comment"># 核心知识点</span></span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符 (>, <=)"></a>比较运算符 (&gt;, &lt;=)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"查询商品价钱大于100的所商品名和价格"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        max_price = <span class="number">100.0</span></span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(<span class="string">"SELECT name,price FROM productS WHERE price &gt; %s ORDER BY price DESC"</span>, (max_price,))</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="BETWEEN-…-AND-…区间查询"><a href="#BETWEEN-…-AND-…区间查询" class="headerlink" title="BETWEEN … AND …区间查询"></a>BETWEEN … AND …区间查询</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"查询商品价格在100~500之间的商品，且通过商品价格降序排序"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        min_p, max_p = <span class="number">100.0</span>, <span class="number">500.0</span></span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(<span class="string">"SELECT name, price FROM products WHERE price BETWEEN %s AND %s ORDER BY price"</span>, (min_p, max_p))</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="IN-…"><a href="#IN-…" class="headerlink" title="IN (…)"></a>IN (…)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"查询类别 ID 为 1 或 4 (电子产品或家居生活) 的产品"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        target_cat_ids = (<span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">        placeholders = <span class="string">', '</span>.join([<span class="string">'%s'</span>] * <span class="built_in">len</span>(target_cat_ids)) <span class="comment"># 有几个target_cat_ids参数就有几个占位符 %s</span></span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(<span class="string">f"SELECT id, name, category_id FROM products WHERE category_id IN (<span class="subst">{placeholders}</span>)"</span>,target_cat_ids)</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="LIKE-模糊匹配"><a href="#LIKE-模糊匹配" class="headerlink" title="LIKE (模糊匹配)"></a>LIKE (模糊匹配)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"查询名称包含 '运动' 的产品"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        search_term = <span class="string">"运动"</span></span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            <span class="comment"># 注意 % 需要在参数中传递，而不是直接放在 SQL 字符串里</span></span><br><span class="line">            cursor.execute(<span class="string">"SELECT name, price FROM products WHERE name LIKE %s"</span>, (<span class="string">f"%<span class="subst">{search_term}</span>%"</span>,))</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="IS-NULL-IS-NOT-NULL"><a href="#IS-NULL-IS-NOT-NULL" class="headerlink" title="IS NULL / IS NOT NULL"></a>IS NULL / IS NOT NULL</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"查询没有上架日期的产品"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(<span class="string">"SELECT id,name FROM products WHERE added_date IS NULL"</span>)</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="组合条件-AND-OR-NOT"><a href="#组合条件-AND-OR-NOT" class="headerlink" title="组合条件 (AND, OR, NOT)"></a>组合条件 (AND, OR, NOT)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"查询图书音像类(ID=2) 或 价格低于100元 且 库存大于0 的产品"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cat_id = <span class="number">2</span></span><br><span class="line">        max_p = <span class="number">100.0</span></span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(<span class="string">"SELECT * FROM products WHERE (category_id = %s OR price &lt; %s) AND stock &gt; 0"</span>, (cat_id, max_p))</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="16-2-5-6-查询数据-SELECT-排序-ORDER-BY"><a href="#16-2-5-6-查询数据-SELECT-排序-ORDER-BY" class="headerlink" title="16.2.5.6 查询数据 (SELECT) - 排序 (ORDER BY)"></a>16.2.5.6 查询数据 (SELECT) - 排序 (<code>ORDER BY</code>)</h5><h6 id="单列排序-ASC-DESC"><a href="#单列排序-ASC-DESC" class="headerlink" title="单列排序 (ASC/DESC)"></a>单列排序 (ASC/DESC)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"按库存数量降序排列产品 (前 5)"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(<span class="string">"SELECT name,stock FROM products ORDER BY stock DESC LIMIT 5"</span>)</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="多列排序"><a href="#多列排序" class="headerlink" title="多列排序"></a>多列排序</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"按类别 ID 升序、价格降序排列产品 (前 5)"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            <span class="comment"># 确保先按 category_id 排序，相同 category_id 的再按 price 降序</span></span><br><span class="line">            cursor.execute(<span class="string">"SELECT * FROM products ORDER BY category_id ASC,price DESC LIMIT 5"</span>)</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="16-2-5-7-查询数据-SELECT-去重-DISTINCT"><a href="#16-2-5-7-查询数据-SELECT-去重-DISTINCT" class="headerlink" title="16.2.5.7 查询数据 (SELECT) - 去重 (DISTINCT)"></a>16.2.5.7 查询数据 (SELECT) - 去重 (<code>DISTINCT</code>)</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"查询现有的所有产品分类的 ID"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(<span class="string">"SELECT DISTINCT category_id FROM products WHERE category_id IS NOT NULL"</span>)</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="16-2-5-8-查询数据-SELECT-聚合函数"><a href="#16-2-5-8-查询数据-SELECT-聚合函数" class="headerlink" title="16.2.5.8 查询数据 (SELECT) - 聚合函数"></a>16.2.5.8 查询数据 (SELECT) - 聚合函数</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"计算产品统计信息 (总数, 总库存, 平均价, 最高价, 最低价)"</span>)</span><br><span class="line">    sql = <span class="string">"""</span></span><br><span class="line"><span class="string">    SELECT </span></span><br><span class="line"><span class="string">        COUNT(*) as total_products, </span></span><br><span class="line"><span class="string">        SUM(stock) as total_stock, </span></span><br><span class="line"><span class="string">        AVG(price) as average_price, </span></span><br><span class="line"><span class="string">        MAX(price) as max_price, </span></span><br><span class="line"><span class="string">        MIN(price) as min_price </span></span><br><span class="line"><span class="string">    FROM products</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(sql)</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="16-2-5-9-查询数据-SELECT-分组-GROUP-BY"><a href="#16-2-5-9-查询数据-SELECT-分组-GROUP-BY" class="headerlink" title="16.2.5.9 查询数据 (SELECT) - 分组 (GROUP BY)"></a>16.2.5.9 查询数据 (SELECT) - 分组 (<code>GROUP BY</code>)</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"按类别名称分组，统计各类别的产品数量和平均价格"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sql = <span class="string">"""</span></span><br><span class="line"><span class="string">       SELECT</span></span><br><span class="line"><span class="string">            c.name as category_name, -- 从 categories 表获取分类名称</span></span><br><span class="line"><span class="string">            COUNT(p.id) as num_products, -- 统计每个分类下产品数量</span></span><br><span class="line"><span class="string">            AVG(p.price) as avg_price -- 统计每个分类下产品平均价格</span></span><br><span class="line"><span class="string">        FROM products as p </span></span><br><span class="line"><span class="string">        LEFT JOIN categories as c ON p.category_id = c.category_id -- 左连接 categories 表</span></span><br><span class="line"><span class="string">        GROUP BY c.name -- 按照类别名称分组</span></span><br><span class="line"><span class="string">        ORDER BY num_products DESC -- 按产品数量倒序排列</span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">       """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(sql)</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="16-2-5-10-查询数据-SELECT-分组过滤-HAVING"><a href="#16-2-5-10-查询数据-SELECT-分组过滤-HAVING" class="headerlink" title="16.2.5.10 查询数据 (SELECT) - 分组过滤 (HAVING)"></a>16.2.5.10 查询数据 (SELECT) - 分组过滤 (<code>HAVING</code>)</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"按类别分组，并找出平均价格高于 3000 元的类别"</span>)</span><br><span class="line">    sql = <span class="string">"""</span></span><br><span class="line"><span class="string">       SELECT</span></span><br><span class="line"><span class="string">         c.name as category_name,</span></span><br><span class="line"><span class="string">         COUNT(p.id) as num_products,</span></span><br><span class="line"><span class="string">         AVG(p.price) as avg_price</span></span><br><span class="line"><span class="string">       FROM</span></span><br><span class="line"><span class="string">         products p</span></span><br><span class="line"><span class="string">         JOIN categories c ON p.category_id = c.category_id -- 使用外键关联分类</span></span><br><span class="line"><span class="string">        GROUP BY c.name</span></span><br><span class="line"><span class="string">        HAVING AVG(p.price) &gt; %s -- 使用HAVING 过滤分组结果</span></span><br><span class="line"><span class="string">        ORDER BY avg_price DESC -- 按平均价格降序排序</span></span><br><span class="line"><span class="string">       """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        MIN_AVG_PRICE = <span class="number">3000.0</span></span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(sql, (MIN_AVG_PRICE,))</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="16-2-5-11-查询数据-SELECT-分页-LIMIT-OFFSET"><a href="#16-2-5-11-查询数据-SELECT-分页-LIMIT-OFFSET" class="headerlink" title="16.2.5.11 查询数据 (SELECT) - 分页 (LIMIT/OFFSET)"></a>16.2.5.11 查询数据 (SELECT) - 分页 (<code>LIMIT</code>/<code>OFFSET</code>)</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">print_subheader(<span class="string">"分页查询: 获取第 3 页数据 (每页 4 条)"</span>)</span><br><span class="line">page = <span class="number">3</span></span><br><span class="line">page_size = <span class="number">4</span></span><br><span class="line">offset = (page - <span class="number">1</span>) * page_size</span><br><span class="line">sql = <span class="string">"SELECT id, name, price FROM products ORDER BY id LIMIT %s OFFSET %s"</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">        cursor.execute(sql, (page_size, offset))</span><br><span class="line">        results = cursor.fetchall()</span><br><span class="line">        print_info(<span class="string">f"第 <span class="subst">{page}</span> 页 (每页 <span class="subst">{page_size}</span> 条)，获取 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line"><span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e: print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="16-2-5-12-查询数据-SELECT-连接查询-JOIN"><a href="#16-2-5-12-查询数据-SELECT-连接查询-JOIN" class="headerlink" title="16.2.5.12 查询数据 (SELECT) - 连接查询 (JOIN)"></a>16.2.5.12 查询数据 (SELECT) - 连接查询 (<code>JOIN</code>)</h5><h6 id="内连接-INNER-JOIN"><a href="#内连接-INNER-JOIN" class="headerlink" title="内连接 (INNER JOIN)"></a>内连接 (<code>INNER JOIN</code>)</h6><p><strong>INNER JOIN:</strong> 必须要两边表都有匹配的数据才会出现在结果中。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"内连接查询: 获取产品及其对应的类别名称 (只显示有类别的产品)"</span>)</span><br><span class="line">    sql  = <span class="string">"""</span></span><br><span class="line"><span class="string">    SELECT p.id,p.name AS product_name , p.price,c.name AS category_name</span></span><br><span class="line"><span class="string">    FROM products p</span></span><br><span class="line"><span class="string">    INNER JOIN categories c ON p.category_id = c.category_id -- 只返回两个表都能匹配上的行</span></span><br><span class="line"><span class="string">    ORDER BY p.name,c.name</span></span><br><span class="line"><span class="string">    LIMIT 5 -- 限制输出</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(sql)</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="左连接-LEFT-JOIN"><a href="#左连接-LEFT-JOIN" class="headerlink" title="左连接 (LEFT JOIN)"></a>左连接 (<code>LEFT JOIN</code>)</h6><p><strong>左连接</strong>保留左表所有行（右表无匹配则补空）</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"左连接查询: 获取所有产品及其类别名称 (没有类别的产品也会显示)"</span>)</span><br><span class="line">    sql = <span class="string">"""</span></span><br><span class="line"><span class="string">    SELECT p.id, p.name AS product_name, p.price, c.name AS category_name</span></span><br><span class="line"><span class="string">    FROM products p</span></span><br><span class="line"><span class="string">    -- 这里换成 RIGHT JOIN 就会少一条记录 (没有类别的产品)</span></span><br><span class="line"><span class="string">    LEFT JOIN categories c ON p.category_id = c.category_id -- 返回左表(products)的所有行</span></span><br><span class="line"><span class="string">    ORDER BY p.id</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(sql)</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="16-2-5-13-查询数据-SELECT-CASE-表达式"><a href="#16-2-5-13-查询数据-SELECT-CASE-表达式" class="headerlink" title="16.2.5.13 查询数据 (SELECT) - CASE 表达式"></a>16.2.5.13 查询数据 (SELECT) - <code>CASE</code> 表达式</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"使用 CASE 表达式根据价格给产品分类"</span>)</span><br><span class="line">    sql = <span class="string">"""</span></span><br><span class="line"><span class="string">    SELECT </span></span><br><span class="line"><span class="string">        name, price,</span></span><br><span class="line"><span class="string">        CASE </span></span><br><span class="line"><span class="string">            WHEN price &lt; 100 THEN '入门级'</span></span><br><span class="line"><span class="string">            WHEN price BETWEEN 100 AND 999.99 THEN '标准级'</span></span><br><span class="line"><span class="string">            WHEN price BETWEEN 1000 AND 4999.99 THEN '进阶级'</span></span><br><span class="line"><span class="string">            ELSE '旗舰级'</span></span><br><span class="line"><span class="string">        END AS price_level -- 给 CASE 结果起别名</span></span><br><span class="line"><span class="string">    FROM products</span></span><br><span class="line"><span class="string">    ORDER BY price</span></span><br><span class="line"><span class="string">    LIMIT 6 -- 限制输出</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(sql)</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h5 id="16-2-5-14-查询数据-SELECT-子查询-Subquery"><a href="#16-2-5-14-查询数据-SELECT-子查询-Subquery" class="headerlink" title="16.2.5.14 查询数据 (SELECT) - 子查询 (Subquery)"></a>16.2.5.14 查询数据 (SELECT) - 子查询 (Subquery)</h5><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_demonstration</span>(<span class="params">conn: pymysql.Connection</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""演示 SELECT 查询"""</span></span><br><span class="line">    print_subheader(<span class="string">"子查询: 查找价格高于平均价格的产品"</span>)</span><br><span class="line">    sql = <span class="string">"""</span></span><br><span class="line"><span class="string">    SELECT ID,name,price</span></span><br><span class="line"><span class="string">    FROM products</span></span><br><span class="line"><span class="string">    WHERE price &gt; (SELECT AVG(price) FROM products)</span></span><br><span class="line"><span class="string">    ORDER BY price DESC</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">            cursor.execute(sql)</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            print_info(<span class="string">f"查询到 <span class="subst">{<span class="built_in">len</span>(results)}</span> 条记录:"</span>)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> results: print_result_item(row)</span><br><span class="line">    <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><p>更详细的SQL语法，详见MYSQL篇章</p><hr><h3 id="16-3-SQLAlchemy-Core-SQL-表达式语言"><a href="#16-3-SQLAlchemy-Core-SQL-表达式语言" class="headerlink" title="16.3 SQLAlchemy Core: SQL 表达式语言"></a>16.3 SQLAlchemy Core: SQL 表达式语言</h3><p>SQLAlchemy Core 提供了一种使用 Python 对象构建 SQL 语句的方式，避免直接拼接字符串，从而提高代码的安全性和可维护性。本节将核心概念和常用 API 通过表格和简洁示例进行介绍。</p><p>首先，你需要安装 SQLAlchemy 库：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install SQLAlchemy</span><br></pre></td></tr></tbody></table></figure><p>SQLAlchemy 本身不包含数据库驱动程序 (DBAPI)，它依赖于第三方驱动来与具体的数据库进行通信。因此，你还需要根据你使用的数据库安装相应的驱动。SQLAlchemy 通过驱动实现与数据库的连接和交互。</p><p><strong>常用数据库及其推荐驱动:</strong></p><table><thead><tr><th align="left">数据库</th><th align="left">SQLAlchemy 连接 URL 方言</th><th align="left">推荐驱动 (DBAPI)</th><th align="left">安装命令 (示例)</th></tr></thead><tbody><tr><td align="left">PostgreSQL</td><td align="left"><code>postgresql</code></td><td align="left"><code>psycopg2</code> (binary)</td><td align="left"><code>pip install psycopg2-binary</code></td></tr><tr><td align="left">MySQL</td><td align="left"><code>mysql</code></td><td align="left"><code>mysqlclient</code></td><td align="left"><code>pip install mysqlclient</code></td></tr><tr><td align="left"></td><td align="left"><code>mysql</code></td><td align="left"><code>PyMySQL</code></td><td align="left"><code>pip install PyMySQL</code></td></tr><tr><td align="left">SQLite</td><td align="left"><code>sqlite</code></td><td align="left"><code>sqlite3</code> (内置)</td><td align="left">(无需额外安装)</td></tr><tr><td align="left">Microsoft SQL</td><td align="left"><code>mssql</code></td><td align="left"><code>pyodbc</code></td><td align="left"><code>pip install pyodbc</code></td></tr><tr><td align="left">Oracle</td><td align="left"><code>oracle</code></td><td align="left"><code>cx_Oracle</code></td><td align="left"><code>pip install cx_Oracle</code></td></tr></tbody></table><p><strong>选择驱动</strong>:</p><ul><li>对于 PostgreSQL，<code>psycopg2</code> 是最常用且功能最全的选择。<code>psycopg2-binary</code> 包含了预编译的 C 扩展，安装更方便。</li><li>对于 MySQL，<code>mysqlclient</code> 是一个性能较好的 C 扩展驱动，但可能需要编译环境。<code>PyMySQL</code> 是纯 Python 实现，安装简单，兼容性好，在许多场景下性能也足够。SQLAlchemy 连接 URL 中需要指定驱动，如 <code>mysql+pymysql://...</code> 或 <code>mysql+mysqlclient://...</code>。</li><li>SQLite 的 <code>sqlite3</code> 驱动是 Python 内置的。</li></ul><blockquote><p>本章我们还是使用PyMysql作为核心驱动！</p></blockquote><h5 id="16-3-1-引擎-Engine-数据库连接的入口"><a href="#16-3-1-引擎-Engine-数据库连接的入口" class="headerlink" title="16.3.1 引擎 (Engine): 数据库连接的入口"></a>16.3.1 引擎 (Engine): 数据库连接的入口</h5><p><code>Engine</code> 是 SQLAlchemy 应用与数据库交互的起点，负责管理连接池和数据库方言。</p><p><strong>创建引擎 (<code>create_engine</code>)</strong></p><p>使用 <code>sqlalchemy.create_engine()</code> 函数创建。</p><table><thead><tr><th align="left">参数</th><th align="left">类型</th><th align="left">描述</th><th align="left">示例 (SQLite 文件)</th></tr></thead><tbody><tr><td align="left"><code>url</code></td><td align="left"><code>str</code></td><td align="left"><strong>必需</strong>. 数据库连接 URL，格式为 <code>dialect+driver://user:password@host:port/database</code>。具体格式见下方说明。</td><td align="left"><code>"sqlite:///myapp.db"</code></td></tr><tr><td align="left"><code>echo</code></td><td align="left"><code>bool</code></td><td align="left">可选，默认为 <code>False</code>。设为 <code>True</code> 时，打印 SQLAlchemy 执行的所有 SQL 语句。<strong>调试时非常有用</strong>。</td><td align="left"><code>echo=True</code></td></tr><tr><td align="left"><code>pool_size</code></td><td align="left"><code>int</code></td><td align="left">可选，连接池保持的最小连接数。</td><td align="left"><code>pool_size=5</code></td></tr><tr><td align="left"><code>max_overflow</code></td><td align="left"><code>int</code></td><td align="left">可选，超出 <code>pool_size</code> 后允许额外创建的最大连接数。</td><td align="left"><code>max_overflow=10</code></td></tr><tr><td align="left"><code>pool_recycle</code></td><td align="left"><code>int</code></td><td align="left">可选，连接在连接池中保持多少秒后被回收 (防止数据库服务器因超时关闭连接)。</td><td align="left"><code>pool_recycle=3600</code> (1 小时)</td></tr><tr><td align="left"><code>connect_args</code></td><td align="left"><code>dict</code></td><td align="left">可选，传递给底层 DBAPI <code>connect()</code> 方法的额外参数。</td><td align="left"><code>connect_args={'timeout': 10}</code> (某些驱动)</td></tr><tr><td align="left"><code>execution_options</code></td><td align="left"><code>dict</code></td><td align="left">可选，设置执行选项，如 <code>isolation_level</code> (事务隔离级别)。</td><td align="left"></td></tr><tr><td align="left"><code>json_serializer</code></td><td align="left"><code>callable</code></td><td align="left">可选，用于序列化 JSON 数据。</td><td align="left"></td></tr><tr><td align="left"><code>json_deserializer</code></td><td align="left"><code>callable</code></td><td align="left">可选，用于反序列化 JSON 数据。</td><td align="left"></td></tr></tbody></table><p><strong>数据库连接 URL ( <code>url</code> ) 详解:</strong></p><ul><li><strong>格式</strong>: <code>dialect[+driver]://[user[:password]@][host][:port]/[database][?key=value&amp;key=value...]</code></li><li><strong><code>dialect</code></strong>: 数据库类型 (<code>sqlite</code>, <code>mysql</code>, <code>postgresql</code>, <code>mssql</code>, <code>oracle</code> 等)。</li><li><strong><code>driver</code> (可选)</strong>: 使用的 DBAPI 库 (<code>psycopg2</code>, <code>pymysql</code>, <code>mysqlclient</code>, <code>pyodbc</code> 等)。如果省略，SQLAlchemy 会尝试默认驱动。</li><li><strong>示例</strong>:<ul><li>SQLite (文件): <code>sqlite:///path/to/your/database.db</code> (注意三个 <code>/</code>)</li><li>SQLite (内存): <code>sqlite:///:memory:</code> (或者仅 <code>sqlite://</code>)</li><li>MySQL (PyMySQL): <code>mysql+pymysql://user:pass@host:3306/dbname?charset=utf8mb4</code></li><li>PostgreSQL (psycopg2): <code>postgresql+psycopg2://user:pass@host:5432/dbname</code></li></ul></li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/engine_examples.py</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> print_utils <span class="keyword">import</span> print_header, print_info, print_success, print_error</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 创建不同数据库的 Engine 示例 ---</span></span><br><span class="line">print_header(<span class="string">"创建 SQLAlchemy Engine 示例"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 1. SQLite (文件数据库)</span></span><br><span class="line">    <span class="comment"># URL: sqlite:///path/to/database.db (三个斜杠表示相对或绝对路径)</span></span><br><span class="line">    sqlite_file_engine = create_engine(<span class="string">"sqlite:///sqlalchemy_core_example.db"</span>, echo=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># echo=True 会打印 SQLAlchemy 执行的 SQL 语句，非常适合学习和调试</span></span><br><span class="line">    print_success(<span class="string">"创建 SQLite 文件数据库引擎成功 (带 SQL 日志)。"</span>)</span><br><span class="line">    <span class="comment"># 可以在这里测试连接 (可选)</span></span><br><span class="line">    <span class="comment"># with sqlite_file_engine.connect() as conn:</span></span><br><span class="line">    <span class="comment">#     print_success("SQLite 文件数据库连接测试成功。")</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. SQLite (内存数据库)</span></span><br><span class="line">    <span class="comment"># URL: sqlite:///:memory: (四个斜杠或仅 :memory:)</span></span><br><span class="line">    sqlite_memory_engine = create_engine(<span class="string">"sqlite:///:memory:"</span>, echo=<span class="literal">False</span>)</span><br><span class="line">    print_success(<span class="string">"创建 SQLite 内存数据库引擎成功。"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. PostgreSQL (使用 psycopg2 驱动)</span></span><br><span class="line">    <span class="comment"># URL: postgresql+psycopg2://user:password@host:port/database</span></span><br><span class="line">    <span class="comment"># 替换为你的实际 PostgreSQL 配置</span></span><br><span class="line">    <span class="comment">#pg_url = "postgresql+psycopg2://your_user:your_password@localhost:5432/your_database"</span></span><br><span class="line">    <span class="comment"># pg_engine = create_engine(pg_url, echo=True, pool_size=5, max_overflow=10)</span></span><br><span class="line">    <span class="comment"># pool_size: 连接池中保持的最小连接数</span></span><br><span class="line">    <span class="comment"># max_overflow: 超出 pool_size 后允许临时创建的最大连接数</span></span><br><span class="line">    <span class="comment">#print_info(f"PostgreSQL 连接 URL (示例): {pg_url} (请替换为实际配置)")</span></span><br><span class="line">    <span class="comment"># print_success("创建 PostgreSQL 引擎配置示例 (pool_size=5, max_overflow=10)。")</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. MySQL (使用 PyMySQL 驱动)</span></span><br><span class="line">    <span class="comment"># URL: mysql+pymysql://user:password@host:port/database?charset=utf8mb4</span></span><br><span class="line">    <span class="comment"># 推荐在 URL 中指定 charset=utf8mb4</span></span><br><span class="line">    mysql_url = <span class="string">"mysql+pymysql://root:root@localhost:3306/pymysql_demo?charset=utf8mb4"</span></span><br><span class="line">    mysql_engine = create_engine(mysql_url, echo=<span class="literal">True</span>)</span><br><span class="line">    print_success(<span class="string">"创建 MySQL 引擎配置示例 (pymysql_demo)。"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> ImportError <span class="keyword">as</span> ie:</span><br><span class="line">    print_error(<span class="string">f"创建引擎失败：缺少必要的数据库驱动。请安装相应的库。错误: <span class="subst">{ie}</span>"</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    print_error(<span class="string">f"创建引擎时发生意外错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="16-3-2-元数据与表定义"><a href="#16-3-2-元数据与表定义" class="headerlink" title="16.3.2. 元数据与表定义"></a>16.3.2. 元数据与表定义</h5><p>使用 <code>MetaData</code>, <code>Table</code>, <code>Column</code> 对象在 Python 代码中定义数据库模式。</p><p><strong>核心类与概念</strong></p><table><thead><tr><th align="left">类/概念</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>MetaData</code></td><td align="left">表和其他模式对象的容器。通常一个数据库一个实例。</td></tr><tr><td align="left"><code>Table</code></td><td align="left">代表数据库中的一张表。关联到 <code>MetaData</code>。</td></tr><tr><td align="left"><code>Column</code></td><td align="left">代表表中的一列。包含名称、类型和约束。</td></tr><tr><td align="left"><strong>SQLAlchemy Types</strong></td><td align="left">独立于数据库的类型，如 <code>Integer</code>, <code>String</code>, <code>DateTime</code>, <code>Boolean</code> 等。</td></tr><tr><td align="left"><strong>Constraints</strong></td><td align="left">约束条件，如主键、外键、唯一、非空、检查约束、索引。</td></tr></tbody></table><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> MetaData, Table, Column, Integer, String</span><br><span class="line"></span><br><span class="line">metadata = MetaData()</span><br><span class="line"></span><br><span class="line">user_table = Table(</span><br><span class="line">    <span class="string">"user"</span>,</span><br><span class="line">    metadata,</span><br><span class="line">    Column(<span class="string">"id"</span>, Integer, primary_key=<span class="literal">True</span>),</span><br><span class="line">    Column(<span class="string">"name"</span>, String(<span class="number">50</span>), nullable=<span class="literal">False</span>),</span><br><span class="line">    Column(<span class="string">"email"</span>, String(<span class="number">120</span>), unique=<span class="literal">True</span>),</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><p>简单来说，SQLAlchemy 中的 <code>MetaData</code> 对象就是一个<strong>数据库结构蓝图的“登记簿”</strong>。</p><p><strong>它主要干两件事：</strong></p><ol><li><strong>记录信息</strong>：它收集并保存了你在 Python 代码里定义的所有数据库表（<code>Table</code> 对象）、列、索引、外键等这些“蓝图”信息。</li><li><strong>操作数据库结构</strong>：当你需要根据这些“蓝图”在实际数据库中创建表时，你会用到它，比如调用 <code>metadata.create_all(engine)</code> 就能把所有登记在册的表都建出来</li></ol><p><strong><code>Table</code> 构造函数关键参数</strong></p><table><thead><tr><th align="left">参数</th><th align="left">类型</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>name</code></td><td align="left"><code>str</code></td><td align="left"><strong>必需</strong>. 表名。</td></tr><tr><td align="left"><code>metadata</code></td><td align="left"><code>MetaData</code></td><td align="left"><strong>必需</strong>. 关联的 <code>MetaData</code> 对象。</td></tr><tr><td align="left"><code>*columns</code></td><td align="left"><code>Column</code>, <code>Constraint</code>, <code>Index</code> 等对象</td><td align="left"><strong>必需</strong>. 定义表的列和表级约束。</td></tr><tr><td align="left"><code>**kwargs</code></td><td align="left"></td><td align="left">特定数据库方言的选项 (如 <code>mysql_engine='InnoDB'</code>)。</td></tr></tbody></table><p><strong><code>Column</code> 构造函数关键参数</strong></p><table><thead><tr><th align="left">参数</th><th align="left">类型</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>name</code></td><td align="left"><code>str</code></td><td align="left">列名 (通常省略，SQLAlchemy 会使用属性名)。</td></tr><tr><td align="left"><code>type_</code></td><td align="left">SQLAlchemy Type</td><td align="left"><strong>必需</strong>. 列的数据类型 (如 <code>Integer</code>, <code>String(50)</code>, <code>DateTime</code>)。</td></tr><tr><td align="left"><code>primary_key</code></td><td align="left"><code>bool</code></td><td align="left">是否为主键。</td></tr><tr><td align="left"><code>nullable</code></td><td align="left"><code>bool</code></td><td align="left">是否允许为空 (默认为 <code>True</code>)。</td></tr><tr><td align="left"><code>default</code></td><td align="left"><code>Any</code></td><td align="left">Python 级别的默认值。</td></tr><tr><td align="left"><code>server_default</code></td><td align="left"><code>str</code> 或 SQL Expression</td><td align="left">数据库级别的默认值 (如 <code>func.now()</code> 或 <code>"0"</code>)。</td></tr><tr><td align="left"><code>unique</code></td><td align="left"><code>bool</code></td><td align="left">是否唯一。</td></tr><tr><td align="left"><code>index</code></td><td align="left"><code>bool</code></td><td align="left">是否为此列创建索引。</td></tr><tr><td align="left"><code>ForeignKey(...)</code></td><td align="left"><code>ForeignKey</code> 对象</td><td align="left">定义外键约束，指向 <code>目标表名.目标列名</code>。</td></tr><tr><td align="left"><code>onupdate</code></td><td align="left"><code>Any</code> 或 SQL Expression</td><td align="left">更新行时自动设置的值 (常用于时间戳)。</td></tr><tr><td align="left"><code>server_onupdate</code></td><td align="left"><code>WorkspaceedValue</code> 或 <code>str</code> 等</td><td align="left">数据库级别的更新触发器。</td></tr><tr><td align="left"><code>comment</code></td><td align="left"><code>str</code></td><td align="left">列注释 (部分数据库支持)。</td></tr></tbody></table><blockquote><p><strong>主键、唯一、索引、默认值、非空等示例</strong></p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Table, Column, Integer, String, Boolean, DateTime, func</span><br><span class="line"></span><br><span class="line">user_table = Table(</span><br><span class="line">    <span class="string">"user"</span>,</span><br><span class="line">    metadata,</span><br><span class="line">    Column(<span class="string">"id"</span>, Integer, primary_key=<span class="literal">True</span>),</span><br><span class="line">    Column(<span class="string">"username"</span>, String(<span class="number">50</span>), nullable=<span class="literal">False</span>, unique=<span class="literal">True</span>, index=<span class="literal">True</span>),</span><br><span class="line">    Column(<span class="string">"email"</span>, String(<span class="number">120</span>), nullable=<span class="literal">False</span>),</span><br><span class="line">    Column(<span class="string">"created_at"</span>, DateTime, server_default=func.now()),  <span class="comment"># 数据库默认值</span></span><br><span class="line">    Column(<span class="string">"is_active"</span>, Boolean, default=<span class="literal">True</span>),  <span class="comment"># Python 级默认值</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>外键约束示例</strong></p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> ForeignKey</span><br><span class="line"></span><br><span class="line">address_table = Table(</span><br><span class="line">    <span class="string">"address"</span>,</span><br><span class="line">    metadata,</span><br><span class="line">    Column(<span class="string">"id"</span>, Integer, primary_key=<span class="literal">True</span>),</span><br><span class="line">    Column(<span class="string">"user_id"</span>, Integer, ForeignKey(<span class="string">"user.id"</span>)),</span><br><span class="line">    Column(<span class="string">"address"</span>, String(<span class="number">255</span>)),</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>表级约束与索引示例</strong></p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Table, Column, Integer, String, UniqueConstraint, Index</span><br><span class="line">metadata = MetaData()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义名为 product 的表</span></span><br><span class="line">product_table = Table(</span><br><span class="line">    <span class="string">"product"</span>,       <span class="comment"># 表名为 "product"</span></span><br><span class="line">    metadata,        <span class="comment"># 关联的 MetaData 对象</span></span><br><span class="line">    Column(<span class="string">"id"</span>, Integer, primary_key=<span class="literal">True</span>),     <span class="comment"># 主键列，整数类型，自动增长</span></span><br><span class="line">    Column(<span class="string">"name"</span>, String(<span class="number">100</span>)),                 <span class="comment"># 产品名称列，字符串，最大长度100</span></span><br><span class="line">    Column(<span class="string">"sku"</span>, String(<span class="number">50</span>)),                   <span class="comment"># SKU（库存单位）列，字符串，最大长度50</span></span><br><span class="line">    <span class="comment"># 表级唯一约束，确保 sku 值在整个表中唯一</span></span><br><span class="line">    UniqueConstraint(<span class="string">"sku"</span>, name=<span class="string">"uix_1"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在 name 列上创建索引，加快查询速度（例如根据产品名称搜索）</span></span><br><span class="line">    Index(<span class="string">"ix_product_name"</span>, <span class="string">"name"</span>),</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>常用 SQLAlchemy 类型</strong></p><table><thead><tr><th align="left">类型</th><th align="left">映射的常见 SQL 类型 (示例)</th></tr></thead><tbody><tr><td align="left"><code>Integer</code> / <code>SmallInteger</code> / <code>BigInteger</code></td><td align="left"><code>INTEGER</code>, <code>SMALLINT</code>, <code>BIGINT</code></td></tr><tr><td align="left"><code>String(length)</code></td><td align="left"><code>VARCHAR(length)</code></td></tr><tr><td align="left"><code>Text</code></td><td align="left"><code>TEXT</code>, <code>CLOB</code></td></tr><tr><td align="left"><code>Numeric(prec, scale)</code></td><td align="left"><code>NUMERIC(prec, scale)</code>, <code>DECIMAL</code></td></tr><tr><td align="left"><code>Float(precision)</code></td><td align="left"><code>FLOAT</code>, <code>REAL</code></td></tr><tr><td align="left"><code>Boolean</code></td><td align="left"><code>BOOLEAN</code>, <code>SMALLINT</code> (0/1)</td></tr><tr><td align="left"><code>Date</code></td><td align="left"><code>DATE</code></td></tr><tr><td align="left"><code>Time</code></td><td align="left"><code>TIME</code></td></tr><tr><td align="left"><code>DateTime</code></td><td align="left"><code>TIMESTAMP</code>, <code>DATETIME</code></td></tr><tr><td align="left"><code>LargeBinary</code></td><td align="left"><code>BLOB</code>, <code>BYTEA</code></td></tr><tr><td align="left"><code>JSON</code></td><td align="left"><code>JSON</code>, <code>JSONB</code> (需要数据库支持)</td></tr></tbody></table><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/metadata_table_example.py</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> (MetaData, Table, Column, Integer, String, DateTime,</span><br><span class="line">                        Boolean, Numeric, ForeignKey, Index, PrimaryKeyConstraint,</span><br><span class="line">                        UniqueConstraint, CheckConstraint, func, TIMESTAMP, Text) <span class="comment"># func 用于 server_default</span></span><br><span class="line"><span class="keyword">from</span> print_utils <span class="keyword">import</span> print_header, print_info, print_success, print_error</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库配置</span></span><br><span class="line">DB_CONFIG = {</span><br><span class="line">    <span class="string">"host"</span>: <span class="string">"localhost"</span>,</span><br><span class="line">    <span class="string">"port"</span>: <span class="number">3306</span>,</span><br><span class="line">    <span class="string">"user"</span>: <span class="string">"root"</span>,</span><br><span class="line">    <span class="string">"password"</span>: <span class="string">"root"</span>,</span><br><span class="line">    <span class="string">"db_name"</span>: <span class="string">"pymysql_demo"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_database</span>():</span><br><span class="line">    <span class="string">"""创建数据库（如果不存在）"""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 连接到MySQL（不指定数据库）</span></span><br><span class="line">        conn = pymysql.connect(</span><br><span class="line">            host=DB_CONFIG[<span class="string">"host"</span>],</span><br><span class="line">            port=DB_CONFIG[<span class="string">"port"</span>],</span><br><span class="line">            user=DB_CONFIG[<span class="string">"user"</span>],</span><br><span class="line">            password=DB_CONFIG[<span class="string">"password"</span>]</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        cursor = conn.cursor()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查数据库是否存在</span></span><br><span class="line">        cursor.execute(<span class="string">f"SHOW DATABASES LIKE '<span class="subst">{DB_CONFIG[<span class="string">'db_name'</span>]}</span>'"</span>)</span><br><span class="line">        result = cursor.fetchone()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果数据库不存在，则创建</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">            print_info(<span class="string">f"数据库 '<span class="subst">{DB_CONFIG[<span class="string">'db_name'</span>]}</span>' 不存在，正在创建..."</span>)</span><br><span class="line">            cursor.execute(<span class="string">f"CREATE DATABASE <span class="subst">{DB_CONFIG[<span class="string">'db_name'</span>]}</span> CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci"</span>)</span><br><span class="line">            print_success(<span class="string">f"数据库 '<span class="subst">{DB_CONFIG[<span class="string">'db_name'</span>]}</span>' 创建成功"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print_info(<span class="string">f"数据库 '<span class="subst">{DB_CONFIG[<span class="string">'db_name'</span>]}</span>' 已存在"</span>)</span><br><span class="line">            </span><br><span class="line">        conn.commit()</span><br><span class="line">        cursor.close()</span><br><span class="line">        conn.close()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"创建数据库时出错: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line">        <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_table</span>():</span><br><span class="line">    print_header(<span class="string">"定义 SQLAlchemy Core 表结构示例 (MySQL)"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.创建 MetaData 对象</span></span><br><span class="line">    metadata_obj = MetaData()</span><br><span class="line">    print_info(<span class="string">"Meta 对象已创建"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义 "categories" 表</span></span><br><span class="line">    categories_table = Table(</span><br><span class="line">        <span class="string">"categories"</span>, <span class="comment"># 表名</span></span><br><span class="line">        metadata_obj, <span class="comment"># 关联的 MetaData 对象</span></span><br><span class="line">        Column(<span class="string">"category_id"</span>, Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>, comment=<span class="string">"类别ID"</span>), <span class="comment"># 主键，自增</span></span><br><span class="line">        Column(<span class="string">"name"</span>, String(<span class="number">50</span>), nullable=<span class="literal">False</span>, unique=<span class="literal">True</span>, comment=<span class="string">"类别名称"</span>), <span class="comment"># 非空、唯一、注释</span></span><br><span class="line">        mysql_engine=<span class="string">"InnoDB"</span>, <span class="comment"># 指定存储引擎</span></span><br><span class="line">        mysql_charset=<span class="string">"utf8mb4"</span>, <span class="comment"># 指定字符集</span></span><br><span class="line">        mysql_collate=<span class="string">"utf8mb4_unicode_ci"</span>, <span class="comment"># 指定排序规则</span></span><br><span class="line">        mysql_row_format=<span class="string">"DYNAMIC"</span> <span class="comment"># 指定行格式</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 定义 "products" 表</span></span><br><span class="line">    products_table = Table(</span><br><span class="line">        <span class="string">"products"</span>,</span><br><span class="line">        metadata_obj,</span><br><span class="line">        Column(<span class="string">"id"</span>, Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>, comment=<span class="string">"产品ID"</span>), <span class="comment"># 主键，自增</span></span><br><span class="line">        Column(<span class="string">"name"</span>, String(<span class="number">100</span>), nullable=<span class="literal">False</span>, comment=<span class="string">"产品名称"</span>),</span><br><span class="line">        Column(<span class="string">"price"</span>, Numeric(<span class="number">10</span>, <span class="number">2</span>), nullable=<span class="literal">False</span>, comment=<span class="string">"价格"</span>),</span><br><span class="line">        Column(<span class="string">"category_id"</span>, Integer, ForeignKey(<span class="string">"categories.category_id"</span>), nullable=<span class="literal">False</span>, comment=<span class="string">"类别ID"</span>), <span class="comment"># 外键</span></span><br><span class="line">        <span class="comment"># Mysql中常用TIMESTAMP类型，并设置自动更新</span></span><br><span class="line">        Column(<span class="string">"created_at"</span>, TIMESTAMP, server_default=func.now(), comment=<span class="string">"创建时间"</span>),</span><br><span class="line">        Column(<span class="string">"updated_at"</span>, TIMESTAMP, server_default=func.now(), onupdate=func.now(), comment=<span class="string">"更新时间"</span>),</span><br><span class="line">        Column(<span class="string">"is_active"</span>, Boolean, default=<span class="literal">True</span>, comment=<span class="string">"是否激活"</span>),</span><br><span class="line">        mysql_engine=<span class="string">"InnoDB"</span>, <span class="comment"># 指定存储引擎，支持事务和外键</span></span><br><span class="line">        mysql_charset=<span class="string">"utf8mb4"</span>, <span class="comment"># 指定字符集，支持中文</span></span><br><span class="line">        mysql_collate=<span class="string">"utf8mb4_unicode_ci"</span>, <span class="comment"># 指定排序规则，支持中文</span></span><br><span class="line">        mysql_row_format=<span class="string">"DYNAMIC"</span> <span class="comment"># 指定行格式，支持动态行</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> metadata_obj, categories_table, products_table</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.创建表</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_tables</span>(<span class="params">engine, metadata_obj</span>):</span><br><span class="line">    metadata_obj.create_all(bind=engine)</span><br><span class="line">    print_success(<span class="string">"表创建完成"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_table</span>(<span class="params">metadata_obj, products_table</span>):</span><br><span class="line">    print_info(<span class="string">"\nMetaData 中包含的表:"</span>)</span><br><span class="line">    <span class="keyword">for</span> table_name <span class="keyword">in</span> metadata_obj.tables:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f" - <span class="subst">{table_name}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    print_info(<span class="string">"\n'products' 表的列信息:"</span>)</span><br><span class="line">    <span class="keyword">for</span> column <span class="keyword">in</span> products_table.columns:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f" - 列名: <span class="subst">{column.name}</span>, 类型: <span class="subst">{column.<span class="built_in">type</span>}</span>, 主键: <span class="subst">{column.primary_key}</span>, 外键: <span class="subst">{column.foreign_keys}</span>"</span>)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 先确保数据库存在</span></span><br><span class="line">    create_database()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建数据库连接</span></span><br><span class="line">    engine = create_engine(<span class="string">f"mysql+pymysql://<span class="subst">{DB_CONFIG[<span class="string">'user'</span>]}</span>:<span class="subst">{DB_CONFIG[<span class="string">'password'</span>]}</span>@<span class="subst">{DB_CONFIG[<span class="string">'host'</span>]}</span>:<span class="subst">{DB_CONFIG[<span class="string">'port'</span>]}</span>/<span class="subst">{DB_CONFIG[<span class="string">'db_name'</span>]}</span>"</span>, echo=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建表结构定义</span></span><br><span class="line">    metadata_obj, categories_table, products_table = create_table()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建表</span></span><br><span class="line">    create_tables(engine, metadata_obj)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查表结构</span></span><br><span class="line">    check_table(metadata_obj, products_table)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="16-3-3-执行-SQL-表达式语句"><a href="#16-3-3-执行-SQL-表达式语句" class="headerlink" title="16.3.3. 执行 SQL 表达式语句"></a>16.3.3. 执行 SQL 表达式语句</h5><p>定义好表之后，就可以使用 SQLAlchemy Core 构建并执行 INSERT, SELECT, UPDATE, DELETE 语句了。</p><p><strong>核心执行流程</strong></p><ol><li><strong>获取连接</strong>: 使用 <code>with engine.connect() as connection:</code> 或 <code>with engine.begin() as connection:</code> (推荐，自动事务管理)。</li><li><strong>构建语句</strong>: 使用 <code>insert(table)</code>, <code>select(columns)</code>, <code>update(table)</code>, <code>delete(table)</code>。</li><li><strong>添加子句</strong>: 链式调用 <code>.values(...)</code>, <code>.where(...)</code>, <code>.order_by(...)</code>, <code>.limit(...)</code>, <code>.offset(...)</code>, <code>.join(...)</code> 等方法。</li><li><strong>执行</strong>: <code>result = connection.execute(statement, [parameters])</code>。</li><li><strong>处理结果</strong> (对于 SELECT)。</li><li><strong>事务管理</strong>: 如果使用 <code>engine.connect()</code>, DML 操作后需 <code>connection.commit()</code> 或 <code>connection.rollback()</code>。如果使用 <code>engine.begin()</code>, 事务自动处理。</li></ol><p><strong>常用语句构建函数/方法</strong></p><table><thead><tr><th align="left">函数/方法</th><th align="left">用途</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><code>insert(table)</code></td><td align="left">构建 INSERT 语句。</td><td align="left"><code>stmt = insert(products_table).values(name="P1", price=10)</code></td></tr><tr><td align="left"><code>select(...)</code></td><td align="left">构建 SELECT 语句。参数是列对象或表对象。</td><td align="left"><code>stmt = select(products_table.c.name, products_table.c.price)</code></td></tr><tr><td align="left"><code>update(table)</code></td><td align="left">构建 UPDATE 语句。</td><td align="left"><code>stmt = update(products_table).where(products_table.c.id == 1)</code></td></tr><tr><td align="left"><code>delete(table)</code></td><td align="left">构建 DELETE 语句。</td><td align="left"><code>stmt = delete(products_table).where(products_table.c.stock == 0)</code></td></tr><tr><td align="left"><code>.values(...)</code></td><td align="left">(INSERT/UPDATE) 指定要插入或更新的列和值。</td><td align="left"><code>.values(name="P2", price=20)</code></td></tr><tr><td align="left"><code>.where(...)</code></td><td align="left">(SELECT/UPDATE/DELETE) 指定过滤条件。</td><td align="left"><code>.where(products_table.c.price &gt; 100)</code></td></tr><tr><td align="left"><code>.order_by(...)</code></td><td align="left">(SELECT) 指定排序方式 (<code>.asc()</code>, <code>.desc()</code>)。</td><td align="left"><code>.order_by(products_table.c.price.desc())</code></td></tr><tr><td align="left"><code>.limit(n)</code></td><td align="left">(SELECT) 限制返回结果数量。</td><td align="left"><code>.limit(10)</code></td></tr><tr><td align="left"><code>.offset(n)</code></td><td align="left">(SELECT) 跳过指定数量的结果 (用于分页)。</td><td align="left"><code>.offset(20)</code></td></tr><tr><td align="left"><code>.join(...)</code></td><td align="left">(SELECT) 连接其他表。参数通常是目标表和连接条件。</td><td align="left"><code>.join(categories_table, products_table.c.category_id == ...)</code></td></tr><tr><td align="left"><code>.label(name)</code></td><td align="left">给列或表达式设置别名。</td><td align="left"><code>select(products_table.c.name.label("product_name"))</code></td></tr><tr><td align="left"><code>text(sql)</code></td><td align="left">用于执行原生 SQL 字符串 (配合参数绑定使用)。</td><td align="left"><code>stmt = text("SELECT * FROM products WHERE id = :id")</code></td></tr></tbody></table><p><strong>常用条件操作符/函数</strong></p><table><thead><tr><th align="left">操作符/函数</th><th align="left">用途</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><code>==</code>, <code>!=</code>, <code>&lt;</code>, <code>&gt;</code></td><td align="left">基本比较。</td><td align="left"><code>table.c.price == 100</code></td></tr><tr><td align="left"><code>&amp;</code> / <code>and_(...)</code></td><td align="left">逻辑与 (AND)。</td><td align="left"><code>(table.c.price &gt; 10) &amp; (table.c.stock &gt; 0)</code></td></tr><tr><td align="left">`</td><td align="left"><code>/</code>or_(…)`</td><td align="left">逻辑或 (OR)。</td></tr><tr><td align="left"><code>~</code> / <code>not_(...)</code></td><td align="left">逻辑非 (NOT)。</td><td align="left"><code>~table.c.name.like('A%')</code></td></tr><tr><td align="left"><code>.like(pattern)</code></td><td align="left">SQL LIKE 操作 ( <code>%</code> 通配符)。</td><td align="left"><code>table.c.name.like('%Core%')</code></td></tr><tr><td align="left"><code>.ilike(pattern)</code></td><td align="left">不区分大小写的 LIKE (某些数据库)。</td><td align="left"><code>table.c.name.ilike('%core%')</code></td></tr><tr><td align="left"><code>.in_([...])</code></td><td align="left">SQL IN 操作。</td><td align="left"><code>table.c.category_id.in_([1, 3, 5])</code></td></tr><tr><td align="left"><code>.is_(None)</code></td><td align="left">SQL IS NULL。</td><td align="left"><code>table.c.added_date.is_(None)</code></td></tr><tr><td align="left"><code>.isnot(None)</code></td><td align="left">SQL IS NOT NULL。</td><td align="left"><code>table.c.description.isnot(None)</code></td></tr><tr><td align="left"><code>.between(a, b)</code></td><td align="left">SQL BETWEEN 操作。</td><td align="left"><code>table.c.price.between(100, 500)</code></td></tr><tr><td align="left"><code>func.&lt;name&gt;</code></td><td align="left">SQL 函数 (如 <code>func.now()</code>, <code>func.count()</code>)</td><td align="left"><code>select(func.count(products_table.c.id))</code></td></tr></tbody></table><p><strong>结果处理 (<code>ResultProxy</code> / <code>CursorResult</code>)</strong></p><p><code>connection.execute()</code> 返回一个结果对象，用于获取数据。</p><table><thead><tr><th align="left">方法</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>Workspaceall()</code></td><td align="left">获取所有行，返回 <code>Row</code> 对象列表。</td></tr><tr><td align="left"><code>Workspaceone()</code></td><td align="left">获取下一行，返回 <code>Row</code> 对象或 <code>None</code>。</td></tr><tr><td align="left"><code>Workspacemany(size=None)</code></td><td align="left">获取指定数量的行，返回 <code>Row</code> 对象列表。</td></tr><tr><td align="left"><code>scalar()</code></td><td align="left">获取结果的第一行第一列的值，无结果或多列时行为可能变化或报错。</td></tr><tr><td align="left"><code>scalars()</code> (2.0+)</td><td align="left">返回 <code>ScalarResult</code>，迭代产生每行第一列的值。</td></tr><tr><td align="left"><code>first()</code></td><td align="left">获取第一行 (<code>Row</code> 对象)，无结果返回 <code>None</code>。常用。</td></tr><tr><td align="left"><code>one()</code></td><td align="left">获取唯一一行，无结果或多于一行时报错。</td></tr><tr><td align="left"><code>one_or_none()</code></td><td align="left">获取唯一一行，无结果返回 <code>None</code>，多于一行时报错。</td></tr><tr><td align="left"><code>mappings()</code> (2.0+)</td><td align="left">返回 <code>MappingResult</code>，迭代产生字典形式的行。</td></tr><tr><td align="left">(直接迭代结果对象)</td><td align="left">每次迭代返回一个 <code>Row</code> 对象。</td></tr><tr><td align="left"><code>rowcount</code> (属性)</td><td align="left">DML 操作影响的行数。</td></tr><tr><td align="left"><code>inserted_primary_key</code> (属性)</td><td align="left">INSERT 操作的自增主键 (元组)。可能只包含第一个插入行的主键。</td></tr><tr><td align="left"><code>keys()</code> (属性)</td><td align="left">返回结果的列名列表。</td></tr></tbody></table><p><strong><code>Row</code> 对象访问</strong>:</p><ul><li>按索引: <code>row[0]</code></li><li>按列名: <code>row['column_name']</code> 或 <code>row.column_name</code></li><li>按列对象: <code>row[table.c.column_name]</code></li><li>转字典: <code>dict(row._mapping)</code> (SQLAlchemy 2.0+) 或 <code>dict(row)</code> (旧版)</li></ul><hr><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/metadata_table_example.py</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> (MetaData, Table, Column, Integer, String, DateTime,</span><br><span class="line">                        Boolean, Numeric, ForeignKey, Index, PrimaryKeyConstraint,</span><br><span class="line">                        UniqueConstraint, CheckConstraint, func, TIMESTAMP, Text)  <span class="comment"># func 用于 server_default</span></span><br><span class="line"><span class="keyword">from</span> print_utils <span class="keyword">import</span> print_header, print_info, print_success, print_error, print_subheader, print_sql,print_warning</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 固定的代码，请放在最上面 ---</span></span><br><span class="line">DB_CONFIG = {</span><br><span class="line">    <span class="string">'DB_URI'</span>: <span class="string">'mysql+pymysql://root:root@localhost:3306/pymysql_demo'</span></span><br><span class="line">}</span><br><span class="line">engine = create_engine(DB_CONFIG[<span class="string">'DB_URI'</span>])</span><br><span class="line">products_table: Table = Table(<span class="string">'products'</span>, MetaData(),</span><br><span class="line">                              Column(<span class="string">'id'</span>, Integer, primary_key=<span class="literal">True</span>),</span><br><span class="line">                              Column(<span class="string">'name'</span>, String(<span class="number">50</span>), nullable=<span class="literal">False</span>),</span><br><span class="line">                              Column(<span class="string">'price'</span>, Numeric(<span class="number">10</span>, <span class="number">2</span>), nullable=<span class="literal">False</span>),</span><br><span class="line">                              Column(<span class="string">'category_id'</span>, Integer, ForeignKey(<span class="string">'categories.category_id'</span>), nullable=<span class="literal">False</span>),</span><br><span class="line">                              Column(<span class="string">'is_active'</span>, Boolean, default=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">                              )</span><br><span class="line"></span><br><span class="line">categories_table = Table(<span class="string">'categories'</span>, MetaData(),</span><br><span class="line">                         Column(<span class="string">'category_id'</span>, Integer, primary_key=<span class="literal">True</span>),</span><br><span class="line">                         Column(<span class="string">'name'</span>, String(<span class="number">50</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">                         )</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h6 id="插入单行记录-1"><a href="#插入单行记录-1" class="headerlink" title="插入单行记录"></a>插入单行记录</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">insert_category_data</span>():</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    插入类别表数据</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    print_header(<span class="string">"SQLAlchemy 类别表 插入示例"</span>)</span><br><span class="line">    <span class="comment">###### 插入单条记录 (INSERT Single)</span></span><br><span class="line">    print_subheader(<span class="string">"1. 插入单个产品记录"</span>)</span><br><span class="line">    stmt_insert_single = insert(categories_table).values(</span><br><span class="line">        name=<span class="string">"书籍类"</span></span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_insert_single))  <span class="comment"># 打印生成的 SQL</span></span><br><span class="line"></span><br><span class="line">    inserted_pk = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> engine.begin() <span class="keyword">as</span> connection:  <span class="comment"># 自动事务管理</span></span><br><span class="line">            result = connection.execute(stmt_insert_single)</span><br><span class="line">            <span class="keyword">if</span> result.inserted_primary_key:</span><br><span class="line">                inserted_pk = result.inserted_primary_key[<span class="number">0</span>]  <span class="comment"># 获取自增主键</span></span><br><span class="line">                print_success(<span class="string">f"成功插入类别 '书籍类' (ID: <span class="subst">{inserted_pk}</span>)"</span>)</span><br><span class="line">            <span class="keyword">elif</span> result.rowcount == <span class="number">1</span>:</span><br><span class="line">                print_success(<span class="string">"成功插入类别 '书籍类' (无法获取主键)"</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print_warning(<span class="string">"插入类别 '书籍类' 时 rowcount 不为 1"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"插入类别 '书籍类' 时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">insert_product_data</span>():</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    插入产品表数据</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    print_header(<span class="string">"SQLAlchemy 产品表 插入示例"</span>)</span><br><span class="line">    <span class="comment"># 先获取已插入的类别ID</span></span><br><span class="line">    <span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">        result = conn.execute(categories_table.select().where(categories_table.c.name == <span class="string">"书籍类"</span>))</span><br><span class="line">        category = result.fetchone()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> category:</span><br><span class="line">            print_error(<span class="string">"未找到'书籍类'类别"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        category_id = category[<span class="number">0</span>]  <span class="comment"># 获取实际的category_id值</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用具体的category_id值插入产品</span></span><br><span class="line">        stmt_insert_single = insert(products_table).values(</span><br><span class="line">            name=<span class="string">"SQLAlchemy书籍"</span>, </span><br><span class="line">            price=<span class="number">123.45</span>, </span><br><span class="line">            category_id=category_id,  <span class="comment"># 使用具体的ID值</span></span><br><span class="line">            is_active=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_insert_single))  <span class="comment"># 打印生成的 SQL</span></span><br><span class="line"></span><br><span class="line">    inserted_pk = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> engine.begin() <span class="keyword">as</span> connection:  <span class="comment"># 自动事务管理</span></span><br><span class="line">            result = connection.execute(stmt_insert_single)</span><br><span class="line">            <span class="keyword">if</span> result.inserted_primary_key:</span><br><span class="line">                inserted_pk = result.inserted_primary_key[<span class="number">0</span>]  <span class="comment"># 获取自增主键</span></span><br><span class="line">                print_success(<span class="string">f"成功插入产品 'SQLAlchemy书籍' (ID: <span class="subst">{inserted_pk}</span>)"</span>)</span><br><span class="line">            <span class="keyword">elif</span> result.rowcount == <span class="number">1</span>:</span><br><span class="line">                print_success(<span class="string">"成功插入产品 'SQLAlchemy书籍' (无法获取主键)"</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print_warning(<span class="string">"插入产品 'SQLAlchemy书籍' 时 rowcount 不为 1"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"插入单个产品时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># insert_category_data() 先执行类别表插入</span></span><br><span class="line">    insert_product_data()</span><br></pre></td></tr></tbody></table></figure><h6 id="批量插入记录-INSERT-Multiple"><a href="#批量插入记录-INSERT-Multiple" class="headerlink" title="批量插入记录 (INSERT Multiple)"></a>批量插入记录 (INSERT Multiple)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">insert_many_products</span>():</span><br><span class="line">    print_header(<span class="string">"SQLAlchemy 批量插入示例"</span>)</span><br><span class="line">    print_subheader(<span class="string">"1. 批量插入多个产品记录"</span>)</span><br><span class="line">    stmt_insert_many = insert(products_table).values([</span><br><span class="line">        {<span class="string">'name'</span>: <span class="string">'Python编程'</span>, <span class="string">'price'</span>: <span class="number">123.45</span>, <span class="string">'category_id'</span>: <span class="number">1</span>},</span><br><span class="line">        {<span class="string">'name'</span>: <span class="string">'SQLAlchemy教程'</span>, <span class="string">'price'</span>: <span class="number">99.99</span>, <span class="string">'category_id'</span>: <span class="number">1</span>},</span><br><span class="line">        {<span class="string">'name'</span>: <span class="string">'大话西游之月光宝盒'</span>, <span class="string">'price'</span>: <span class="number">150.00</span>, <span class="string">'category_id'</span>: <span class="number">1</span>}</span><br><span class="line">    ])</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_insert_many))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> engine.begin() <span class="keyword">as</span> connection: <span class="comment"># 使用事务</span></span><br><span class="line">            result = connection.execute(stmt_insert_many)</span><br><span class="line">            print_success(<span class="string">f"成功插入 <span class="subst">{result.rowcount}</span> 条记录"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"插入失败: <span class="subst">{e}</span>"</span>) </span><br></pre></td></tr></tbody></table></figure><h6 id="更新数据-UPDATE"><a href="#更新数据-UPDATE" class="headerlink" title="更新数据 (UPDATE)"></a>更新数据 (UPDATE)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update_product</span>():</span><br><span class="line">    print_header(<span class="string">"SQLAlchemy 更新示例"</span>)</span><br><span class="line">    <span class="comment"># 更新商品价格</span></span><br><span class="line">    stmt_update = update(products_table).where(products_table.c.<span class="built_in">id</span> == <span class="number">1</span>).values(</span><br><span class="line">        price = <span class="number">999999</span></span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_update))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> engine.begin() <span class="keyword">as</span> connection:</span><br><span class="line">            result = connection.execute(stmt_update)</span><br><span class="line">            print_success(<span class="string">f"成功更新 <span class="subst">{result.rowcount}</span> 条记录"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"更新失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="批量更新记录-UPDATE-Multiple"><a href="#批量更新记录-UPDATE-Multiple" class="headerlink" title="批量更新记录 (UPDATE Multiple)"></a>批量更新记录 (UPDATE Multiple)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update_products</span>():</span><br><span class="line">    print_header(<span class="string">"SQLAlchemy 批量更新示例"</span>)</span><br><span class="line">    category_id_to_update = <span class="number">1</span></span><br><span class="line">    price_increase_factor = <span class="number">1.10</span> <span class="comment"># 价格提高10%</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构建 UPDATE 语句</span></span><br><span class="line">    stmt_update = update(products_table).where(</span><br><span class="line">        products_table.c.category_id == category_id_to_update</span><br><span class="line">    ).values(</span><br><span class="line">        price = products_table.c.price * price_increase_factor</span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_update))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> engine.begin() <span class="keyword">as</span> connection:</span><br><span class="line">            result = connection.execute(stmt_update)</span><br><span class="line">            print_success(<span class="string">f"成功更新 <span class="subst">{result.rowcount}</span> 条记录"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"更新失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="删除数据-DELETE"><a href="#删除数据-DELETE" class="headerlink" title="删除数据 (DELETE)"></a>删除数据 (DELETE)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">delete_product</span>():</span><br><span class="line">    print_header(<span class="string">"SQLAlchemy 删除示例"</span>)</span><br><span class="line">    product_id_to_delete = <span class="number">1</span></span><br><span class="line">    stmt_delete = delete(products_table).where(products_table.c.<span class="built_in">id</span> == product_id_to_delete)</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_delete))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> engine.begin() <span class="keyword">as</span> connection:</span><br><span class="line">            result = connection.execute(stmt_delete)</span><br><span class="line">            print_success(<span class="string">f"成功删除 <span class="subst">{result.rowcount}</span> 条记录"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"删除失败: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="批量删除记录-DELETE-Multiple"><a href="#批量删除记录-DELETE-Multiple" class="headerlink" title="批量删除记录 (DELETE Multiple)"></a>批量删除记录 (DELETE Multiple)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">delete_products</span>():</span><br><span class="line">    print_header(<span class="string">"SQLAlchemy 批量删除示例"</span>)</span><br><span class="line">    <span class="comment"># 批量删除数据，例如：isActive = False</span></span><br><span class="line">    stmt_delete = delete(products_table).where(products_table.c.is_active == <span class="literal">False</span>)</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_delete))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> engine.begin() <span class="keyword">as</span> connection:</span><br><span class="line">            result = connection.execute(stmt_delete)</span><br><span class="line">            print_success(<span class="string">f"成功删除 <span class="subst">{result.rowcount}</span> 条记录"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"删除失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><blockquote><p>在进入最重要的查询的基础前，我们可以看到代码有很多是重复的，每一次都要进行begin，捕获…这个繁杂的过程会导致代码冗余，我们可以采用AOP的思想，去实现一个事务的装饰器，如下：</p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="comment"># 添加事务装饰器 - AOP思想实现</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transactional</span>(<span class="params">func=<span class="literal">None</span>, *, engine_obj=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    使用AOP思想实现的事务装饰器</span></span><br><span class="line"><span class="string">    可以直接应用于函数上，无需手动管理事务</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    用法:</span></span><br><span class="line"><span class="string">    @transactional  # 使用默认引擎</span></span><br><span class="line"><span class="string">    def my_function():</span></span><br><span class="line"><span class="string">        # 执行SQL操作，自动事务管理</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    @transactional(engine_obj=custom_engine)  # 使用自定义引擎</span></span><br><span class="line"><span class="string">    def another_function():</span></span><br><span class="line"><span class="string">        # 执行SQL操作，自动事务管理</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    _engine = engine_obj <span class="keyword">or</span> engine  <span class="comment"># 如果未指定引擎，使用全局引擎</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">fn</span>):</span><br><span class="line"><span class="meta">        @wraps(<span class="params">fn</span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">            <span class="comment"># 创建connection参数</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'connection'</span> <span class="keyword">in</span> kwargs:</span><br><span class="line">                <span class="comment"># 如果已经有连接传入，则使用该连接</span></span><br><span class="line">                <span class="keyword">return</span> fn(*args, **kwargs)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> _engine.begin() <span class="keyword">as</span> connection:</span><br><span class="line">                    <span class="comment"># 注入connection到被装饰函数的kwargs中</span></span><br><span class="line">                    kwargs[<span class="string">'connection'</span>] = connection</span><br><span class="line">                    result = fn(*args, **kwargs)</span><br><span class="line">                    <span class="keyword">return</span> result</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                print_error(<span class="string">f"事务执行失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 处理@transactional和@transactional()两种调用方式</span></span><br><span class="line">    <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> decorator</span><br><span class="line">    <span class="keyword">return</span> decorator(func)</span><br></pre></td></tr></tbody></table></figure><p>通过这个装饰器，我们就可以实现代码的优雅性</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用事务装饰器实现的方法</span></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">insert_many_products_aop</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""使用AOP事务装饰器实现的批量插入"""</span></span><br><span class="line">    print_header(<span class="string">"SQLAlchemy 批量插入示例 (使用事务装饰器)"</span>)</span><br><span class="line"></span><br><span class="line">    stmt_insert_many = insert(products_table).values([</span><br><span class="line">        {<span class="string">'name'</span>: <span class="string">'Python编程AOP版'</span>, <span class="string">'price'</span>: <span class="number">123.45</span>, <span class="string">'category_id'</span>: <span class="number">1</span>},</span><br><span class="line">        {<span class="string">'name'</span>: <span class="string">'SQLAlchemy教程AOP版'</span>, <span class="string">'price'</span>: <span class="number">99.99</span>, <span class="string">'category_id'</span>: <span class="number">1</span>},</span><br><span class="line">        {<span class="string">'name'</span>: <span class="string">'大话西游之月光宝盒AOP版'</span>, <span class="string">'price'</span>: <span class="number">150.00</span>, <span class="string">'category_id'</span>: <span class="number">1</span>}</span><br><span class="line">    ])</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_insert_many))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 不需要手动管理事务，直接执行</span></span><br><span class="line">    result = connection.execute(stmt_insert_many)</span><br><span class="line">    print_success(<span class="string">f"成功插入 <span class="subst">{result.rowcount}</span> 条记录"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="查询数据-SELECT-基础"><a href="#查询数据-SELECT-基础" class="headerlink" title="查询数据 (SELECT - 基础)"></a>查询数据 (SELECT - 基础)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_all_products</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="comment"># --- 查询所有产品的所有列 ---</span></span><br><span class="line">    print_info(<span class="string">"查询所有产品的 '*' (前 5 条):"</span>)</span><br><span class="line">    stmt_select_all = select(products_table).limit(<span class="number">5</span>)</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_select_all))</span><br><span class="line">    result = connection.execute(stmt_select_all)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result.fetchmany(<span class="number">5</span>):</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br></pre></td></tr></tbody></table></figure><h6 id="查询数据-SELECT-条件过滤-WHERE"><a href="#查询数据-SELECT-条件过滤-WHERE" class="headerlink" title="查询数据 (SELECT - 条件过滤 WHERE)"></a>查询数据 (SELECT - 条件过滤 WHERE)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/metadata_table_example.py</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> and_, or_, not_ <span class="comment"># 导入逻辑操作符</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> *  <span class="comment"># func 用于 server_default</span></span><br><span class="line"><span class="keyword">from</span> print_utils <span class="keyword">import</span> print_header, print_info, print_success, print_error, print_subheader, print_sql, print_warning</span><br><span class="line"><span class="comment"># ====================== 基础查询 ======================</span></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_all_products</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">"查询所有产品的 '*' (前 5 条):"</span>)</span><br><span class="line">    stmt_select_all = select(products_table).limit(<span class="number">5</span>)</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_select_all))</span><br><span class="line">    result = connection.execute(stmt_select_all)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result.fetchmany(<span class="number">5</span>):</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====================== 条件查询 ======================</span></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_by_category_id</span>(<span class="params">category_id_to_find, connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">f"\n查询类别 ID 为 <span class="subst">{category_id_to_find}</span> 的产品:"</span>)</span><br><span class="line">    stmt_eq = select(products_table.c.<span class="built_in">id</span>, products_table.c.name, products_table.c.price).where(</span><br><span class="line">        products_table.c.category_id == category_id_to_find</span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_eq))</span><br><span class="line">    result = connection.execute(stmt_eq)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_by_price_gt</span>(<span class="params">max_price, connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">f"\n查询价格大于 <span class="subst">{max_price}</span> 的产品名称和价格 (降序):"</span>)</span><br><span class="line">    stmt_gt = select(products_table.c.name, products_table.c.price).where(</span><br><span class="line">        products_table.c.price &gt; max_price</span><br><span class="line">    ).order_by(products_table.c.price.desc())</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_gt))</span><br><span class="line">    result = connection.execute(stmt_gt)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_by_price_between</span>(<span class="params">min_p, max_p, connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">f"\n查询价格在 <span class="subst">{min_p}</span> 到 <span class="subst">{max_p}</span> 之间的产品名称和价格 (升序):"</span>)</span><br><span class="line">    stmt_between = select(products_table.c.name, products_table.c.price).where(</span><br><span class="line">        products_table.c.price.between(min_p, max_p)</span><br><span class="line">    ).order_by(products_table.c.price)</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_between))</span><br><span class="line">    result = connection.execute(stmt_between)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_by_category_ids</span>(<span class="params">target_cat_ids, connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">f"\n查询类别 ID 在 <span class="subst">{target_cat_ids}</span> 中的产品:"</span>)</span><br><span class="line">    stmt_in = select(products_table.c.<span class="built_in">id</span>, products_table.c.name, products_table.c.category_id).where(</span><br><span class="line">        products_table.c.category_id.in_(target_cat_ids)</span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_in))</span><br><span class="line">    result = connection.execute(stmt_in)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_by_name_like</span>(<span class="params">search_term, connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">f"\n查询名称包含 '<span class="subst">{search_term}</span>' 的产品:"</span>)</span><br><span class="line">    stmt_like = select(products_table.c.name, products_table.c.price).where(</span><br><span class="line">        products_table.c.name.like(<span class="string">f"%<span class="subst">{search_term}</span>%"</span>)</span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_like))</span><br><span class="line">    result = connection.execute(stmt_like)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alter_add_stock_column</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">"增加 stock 字段到 products 表:"</span>)</span><br><span class="line">    stmt_alter = text(<span class="string">"ALTER TABLE products ADD COLUMN stock INTEGER NOT NULL"</span>)</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_alter))</span><br><span class="line">    connection.execute(stmt_alter)       </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_by_complex_condition</span>(<span class="params">cat_id, min_stock, connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">f"\n查询类别 ID 为 <span class="subst">{cat_id}</span> 且 (价格小于 50 或 库存大于 <span class="subst">{min_stock}</span>) 的产品:"</span>)</span><br><span class="line">    stmt_complex = select(products_table).where(</span><br><span class="line">        and_(</span><br><span class="line">            products_table.c.category_id == cat_id,</span><br><span class="line">            or_(</span><br><span class="line">                products_table.c.price &lt; <span class="number">50.0</span>,</span><br><span class="line">                products_table.c.stock &gt; min_stock</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_complex))</span><br><span class="line">    result = connection.execute(stmt_complex)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 基础查询示例</span></span><br><span class="line">    select_all_products()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 条件查询示例</span></span><br><span class="line">    select_by_category_id(<span class="number">1</span>)</span><br><span class="line">    select_by_price_gt(<span class="number">100.0</span>)</span><br><span class="line">    select_by_price_between(<span class="number">100.0</span>, <span class="number">500.0</span>)</span><br><span class="line">    select_by_category_ids([<span class="number">1</span>, <span class="number">3</span>])</span><br><span class="line">    select_by_name_like(<span class="string">"Core"</span>)</span><br><span class="line">    select_by_complex_condition(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h6 id="查询数据-SELECT-排序-ORDER-BY"><a href="#查询数据-SELECT-排序-ORDER-BY" class="headerlink" title="查询数据 (SELECT - 排序 ORDER BY)"></a>查询数据 (SELECT - 排序 ORDER BY)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">print_subheader(<span class="string">"7. 查询数据 (排序 ORDER BY)"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_products_order_by_price_desc</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">"\n按价格降序排列产品 (前 5 条):"</span>)</span><br><span class="line">    stmt_order_desc = select(</span><br><span class="line">        products_table.c.name, products_table.c.price</span><br><span class="line">    ).order_by(</span><br><span class="line">        products_table.c.price.desc() <span class="comment"># 使用 .desc() 指定降序</span></span><br><span class="line">    ).limit(<span class="number">5</span>)</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_order_desc))</span><br><span class="line">    result = connection.execute(stmt_order_desc)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_products_order_by_multi_columns</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">"\n按类别 ID 升序、价格降序排列产品 (前 5 条):"</span>)</span><br><span class="line">    stmt_order_multi = select(</span><br><span class="line">        products_table.c.name, products_table.c.category_id, products_table.c.price</span><br><span class="line">    ).order_by(</span><br><span class="line">        products_table.c.category_id.asc(), <span class="comment"># 先按类别 ID 升序</span></span><br><span class="line">        products_table.c.price.desc()      <span class="comment"># 同类别内按价格降序</span></span><br><span class="line">    ).limit(<span class="number">5</span>)</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_order_multi))</span><br><span class="line">    result = connection.execute(stmt_order_multi)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br></pre></td></tr></tbody></table></figure><h6 id="查询数据-SELECT-去重-DISTINCT"><a href="#查询数据-SELECT-去重-DISTINCT" class="headerlink" title="查询数据 (SELECT - 去重 DISTINCT)"></a>查询数据 (SELECT - 去重 DISTINCT)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_distinct_products</span>():</span><br><span class="line">    print_info(<span class="string">"\n查询所有类别 ID 并去重:"</span>)</span><br><span class="line">    stmt_distinct = select(products_table.c.category_id,products_table.c.name).distinct()</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_distinct))</span><br><span class="line">    result = connection.execute(stmt_distinct)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br></pre></td></tr></tbody></table></figure><h6 id="查询数据-SELECT-聚合函数"><a href="#查询数据-SELECT-聚合函数" class="headerlink" title="查询数据 (SELECT - 聚合函数)"></a>查询数据 (SELECT - 聚合函数)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_aggregation_products</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">"\n计算产品统计信息 (总数, 总库存, 平均价, 最高价, 最低价):"</span>)</span><br><span class="line">    stmt_aggregation = select(</span><br><span class="line">        func.count(products_table.c.<span class="built_in">id</span>).label(<span class="string">"total_products"</span>), <span class="comment"># 计算产品总数并取别名</span></span><br><span class="line">        func.<span class="built_in">sum</span>(products_table.c.stock).label(<span class="string">"total_stock"</span>),  <span class="comment"># 计算总库存并取别名</span></span><br><span class="line">        func.avg(products_table.c.price).label(<span class="string">"average_price"</span>),  <span class="comment"># 计算平均价格并取别名</span></span><br><span class="line">        func.<span class="built_in">max</span>(products_table.c.price).label(<span class="string">"max_price"</span>),  <span class="comment"># 计算最高价格并取别名</span></span><br><span class="line">        func.<span class="built_in">min</span>(products_table.c.price).label(<span class="string">"min_price"</span>)  <span class="comment"># 计算最低价格并取别名</span></span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_aggregation))</span><br><span class="line">    result = connection.execute(stmt_aggregation).first() <span class="comment"># 聚合查询通常只有一行元组结果</span></span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        print_result_item(<span class="built_in">dict</span>(result._mapping))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print_info(<span class="string">"未能获取产品统计信息。"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="查询数据-SELECT-分组-GROUP-BY"><a href="#查询数据-SELECT-分组-GROUP-BY" class="headerlink" title="查询数据 (SELECT - 分组 GROUP BY)"></a>查询数据 (SELECT - 分组 GROUP BY)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_group_by_category</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">"\n按类别分组计算产品统计信息:"</span>)</span><br><span class="line">    stmt_group_by = select(</span><br><span class="line">        products_table.c.category_id,</span><br><span class="line">        func.count(products_table.c.<span class="built_in">id</span>).label(<span class="string">"product_count"</span>),</span><br><span class="line">        func.<span class="built_in">sum</span>(products_table.c.price).label(<span class="string">"price"</span>),</span><br><span class="line">    ).group_by(products_table.c.category_id).order_by(products_table.c.category_id.asc())</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_group_by))</span><br><span class="line">    result = connection.execute(stmt_group_by).first()</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        print_result_item(<span class="built_in">dict</span>(result._mapping))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print_info(<span class="string">"未能获取产品统计信息。"</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_group_by_category</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">"\n按类别分组计算产品统计信息 (产品数量大于1的类别):"</span>)</span><br><span class="line">    stmt_group_by = select(</span><br><span class="line">        products_table.c.category_id, <span class="comment"># 类别 ID</span></span><br><span class="line">        func.count(products_table.c.<span class="built_in">id</span>).label(<span class="string">"product_count"</span>), <span class="comment">#  产品数量</span></span><br><span class="line">        func.<span class="built_in">sum</span>(products_table.c.price).label(<span class="string">"price"</span>), <span class="comment"># 价格总和</span></span><br><span class="line">    ).group_by(products_table.c.category_id)\</span><br><span class="line">     .having(</span><br><span class="line">         and_(</span><br><span class="line">             func.count(products_table.c.<span class="built_in">id</span>) &gt; <span class="number">1</span>, <span class="comment"># 产品数量大于1</span></span><br><span class="line">             func.<span class="built_in">sum</span>(products_table.c.price) &gt; <span class="number">0</span> <span class="comment"># 价格总和大于0</span></span><br><span class="line">         )</span><br><span class="line">     )\</span><br><span class="line">     .order_by(products_table.c.category_id.asc())</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_group_by))</span><br><span class="line">    result = connection.execute(stmt_group_by).first()</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        print_result_item(<span class="built_in">dict</span>(result._mapping))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print_info(<span class="string">"未能获取产品统计信息。"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="查询数据-SELECT-分页-LIMIT-OFFSET"><a href="#查询数据-SELECT-分页-LIMIT-OFFSET" class="headerlink" title="查询数据 (SELECT - 分页 LIMIT/OFFSET)"></a>查询数据 (SELECT - 分页 LIMIT/OFFSET)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_limit_pages</span>(<span class="params">connection=<span class="literal">None</span>, page=<span class="number">1</span>, page_size=<span class="number">3</span></span>):</span><br><span class="line">    print_info(<span class="string">f"\n分页查询产品数据 (每页 <span class="subst">{page_size}</span> 条, 第 <span class="subst">{page}</span> 页):"</span>)</span><br><span class="line">    offset_val = (page - <span class="number">1</span>) * page_size</span><br><span class="line">    print_info(<span class="string">f"当前页码: <span class="subst">{page}</span>, 每页显示 <span class="subst">{page_size}</span> 条, 偏移量: <span class="subst">{offset_val}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取总记录数</span></span><br><span class="line">    count_stmt = select(func.count()).select_from(products_table)</span><br><span class="line">    total_count = connection.execute(count_stmt).scalar()</span><br><span class="line">    total_pages = (total_count + page_size - <span class="number">1</span>) // page_size</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 分页查询</span></span><br><span class="line">    stmt_paging = select(products_table.c.name, products_table.c.price)\</span><br><span class="line">        .offset(offset_val)\</span><br><span class="line">        .limit(page_size)</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_paging))</span><br><span class="line">    result = connection.execute(stmt_paging)</span><br><span class="line">    </span><br><span class="line">    print_info(<span class="string">f"总记录数: <span class="subst">{total_count}</span>, 总页数: <span class="subst">{total_pages}</span>"</span>)</span><br><span class="line">    print_info(<span class="string">"当前页数据:"</span>)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        print_result_item(<span class="built_in">dict</span>(row._mapping))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 演示分页效果</span></span><br><span class="line">    <span class="keyword">for</span> page <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">        select_limit_pages(page=page)</span><br><span class="line">        print_info(<span class="string">"-"</span> * <span class="number">50</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h6 id="查询数据-SELECT-连接查询-JOIN"><a href="#查询数据-SELECT-连接查询-JOIN" class="headerlink" title="查询数据 (SELECT - 连接查询 JOIN)"></a>查询数据 (SELECT - 连接查询 JOIN)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_products_with_join</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">"\n内连接查询: 获取产品及其对应的类别名称 (只显示有类别的产品):"</span>)</span><br><span class="line">    stmt_inner_join = select(</span><br><span class="line">        products_table.c.name,</span><br><span class="line">        products_table.c.price,</span><br><span class="line">        categories_table.c.name.label(<span class="string">"category_name"</span>)  <span class="comment"># 使用label设置别名</span></span><br><span class="line">    ).join(</span><br><span class="line">        categories_table,  <span class="comment"># 指定要连接的表</span></span><br><span class="line">        products_table.c.category_id == categories_table.c.category_id  <span class="comment"># 指定连接条件</span></span><br><span class="line">    ).where(</span><br><span class="line">        products_table.c.category_id == <span class="number">1</span>  <span class="comment"># 指定过滤条件</span></span><br><span class="line">    )  <span class="comment"># 如果 ForeignKey 已定义，SQLAlchemy 通常能自动推断条件: .join(categories_table)</span></span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_inner_join))</span><br><span class="line">    result = connection.execute(stmt_inner_join)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        print_result_item(<span class="built_in">dict</span>(row._mapping))</span><br></pre></td></tr></tbody></table></figure><h6 id="查询数据-SELECT-CASE-表达式"><a href="#查询数据-SELECT-CASE-表达式" class="headerlink" title="查询数据 (SELECT - CASE 表达式)"></a>查询数据 (SELECT - CASE 表达式)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_products_with_level</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    print_info(<span class="string">"\n使用 CASE 表达式根据价格给产品分类:"</span>)</span><br><span class="line">    stmt_case = select(</span><br><span class="line">        products_table.c.name,</span><br><span class="line">        products_table.c.price,</span><br><span class="line">        <span class="keyword">case</span>(</span><br><span class="line">            (products_table.c.price &gt; <span class="number">500</span>, <span class="string">"白金级"</span>),</span><br><span class="line">            (products_table.c.price &gt; <span class="number">200</span>, <span class="string">"进阶级"</span>),</span><br><span class="line">            (products_table.c.price &gt; <span class="number">100</span>, <span class="string">"标准级"</span>),</span><br><span class="line">            (products_table.c.price &gt; <span class="number">10</span>, <span class="string">"入门级"</span>),</span><br><span class="line">            else_=<span class="string">"未知"</span></span><br><span class="line">        ).label(<span class="string">"price_level"</span>)</span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_case))</span><br><span class="line">    result = connection.execute(stmt_case)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        print_result_item(<span class="built_in">dict</span>(row._mapping))</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h6 id="查询数据-SELECT-子查询-Subquery"><a href="#查询数据-SELECT-子查询-Subquery" class="headerlink" title="查询数据 (SELECT - 子查询 Subquery)"></a>查询数据 (SELECT - 子查询 Subquery)</h6><p><strong>子查询方法快速参考</strong></p><p>为了方便快速选择合适的子查询构建方式，这里根据核心使用场景进行了归纳：</p><table><thead><tr><th><strong>方法/概念</strong></th><th><strong>核心场景 (一句话概括)</strong></th><th><strong>关键点/提示</strong></th></tr></thead><tbody><tr><td><strong><code>.scalar_subquery()</code></strong></td><td>WHERE 中与<strong>单个</strong>预期值比较</td><td>子查询应返回<strong>单行单列</strong>。用于 <code>&gt;、=、&lt;</code> 等比较。</td></tr><tr><td><strong><code>.subquery()</code></strong></td><td>FROM 或 JOIN 中<strong>像表一样使用</strong>子查询结果</td><td>像操作普通 <code>Table</code> 一样操作它；用 <code>.c</code> 访问列；聚合列需用 <code>.label()</code> 命名。</td></tr><tr><td><strong>(直接用 <code>select()</code>)</strong></td><td>WHERE 中与<strong>列表</strong>比较 (如 <code>IN</code>)</td><td>子查询应返回<strong>单列多行（如id）</strong>；常与 <code>.in_()</code> 配合。</td></tr><tr><td><strong><code>.exists()</code></strong></td><td>WHERE 中检查<strong>是否存在</strong>满足条件的关联行</td><td>只关心“有没有”，不关心“是什么”或“有多少”。</td></tr><tr><td><strong><code>.alias()</code></strong></td><td>需要在<strong>同一查询</strong>中区分<strong>同一个表</strong>的多次引用时</td><td><strong>相关子查询</strong>和<strong>自连接</strong>的必备工具。</td></tr><tr><td><code>.correlate()</code></td><td>(较少用) <strong>显式声明</strong>子查询依赖的外部表</td><td>主要用于非 <code>WHERE</code>/<code>FROM</code> 子句的子查询，或自动关联失效时。</td></tr><tr><td><code>.lateral()</code></td><td>(需数据库支持) 子查询引用<strong>同 FROM 中之前</strong>的表</td><td>用于行级计算或复杂的 Top-N 查询。</td></tr></tbody></table><p><strong>选择思路小结</strong>:</p><ul><li>需要子查询返回<strong>一个值</strong>来比较？ -&gt; <strong><code>.scalar_subquery()</code></strong></li><li>需要把子查询的结果<strong>当作一张表</strong>来连接 (JOIN) 或从中选择 (FROM)？ -&gt; <strong><code>.subquery()</code></strong></li><li>需要判断某个东西是否在子查询返回的<strong>列表</strong>里？ -&gt; <strong>直接用 <code>select()</code> 配合 <code>.in_()</code></strong></li><li>只需要判断有没有符合条件的<strong>关联数据</strong>，不在乎具体内容？ -&gt; <strong><code>.exists()</code></strong></li><li>查询中涉及<strong>自己和自己比</strong>（相关子查询、自连接）？ -&gt; <strong><code>.alias()</code></strong></li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_products_with_subquery</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">""" --- 子查询用在 WHERE 子句中 ---"""</span></span><br><span class="line">    print_info(<span class="string">"\n子查询: 查找价格高于平均价格的产品:"</span>)</span><br><span class="line">    <span class="comment"># 1.构建子查询，计算平均价格</span></span><br><span class="line">    <span class="comment"># scalar_subquery : 返回一个标量值而不是一个结果集，用于where子句中比较</span></span><br><span class="line">    subquery_avg_price = select(func.avg(products_table.c.price)).scalar_subquery()</span><br><span class="line">    <span class="comment"># 2.构建主查询，在 WHERE 子句中使用子查询结果</span></span><br><span class="line">    stmt_subquery_where = select(products_table.c.name, products_table.c.price).where(</span><br><span class="line">        products_table.c.price &gt; subquery_avg_price</span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_subquery_where))</span><br><span class="line">    result = connection.execute(stmt_subquery_where)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        print_result_item(<span class="built_in">dict</span>(row._mapping))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_products_with_subquery_in_select</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">""" --- 子查询用在 SELECT 子句中 ---"""</span></span><br><span class="line">    print_info(<span class="string">"\n子查询: 查找每个类别中价格最高的产品 (使用派生表):"</span>)</span><br><span class="line">    <span class="comment"># 1.构建子查询：找出每个 category_id 对应的最高价格</span></span><br><span class="line">    subquery_max_price = select(</span><br><span class="line">        products_table.c.category_id,</span><br><span class="line">        func.<span class="built_in">max</span>(products_table.c.price).label(<span class="string">"max_price"</span>)</span><br><span class="line"></span><br><span class="line">    ).group_by(products_table.c.category_id).subquery()</span><br><span class="line">    <span class="comment"># subquery 表示一个子查询，可以作为主查询的一部分 也可以作为一个用来join的对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 将主表与子查询连接，找出价格等于该类别最高价的产品</span></span><br><span class="line">    stmt_subquery_from = select(</span><br><span class="line">        products_table.c.name,</span><br><span class="line">        products_table.c.price,</span><br><span class="line">        products_table.c.category_id,</span><br><span class="line">    ).join(  <span class="comment"># 将主表与子查询连接</span></span><br><span class="line">        subquery_max_price,</span><br><span class="line">        and_(  <span class="comment"># 指定连接条件</span></span><br><span class="line">            products_table.c.category_id == subquery_max_price.c.category_id,</span><br><span class="line">            products_table.c.price == subquery_max_price.c.max_price  <span class="comment"># 价格等于该类别最高价</span></span><br><span class="line">        )</span><br><span class="line">    ).order_by(products_table.c.category_id)</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_subquery_from))</span><br><span class="line">    result = connection.execute(stmt_subquery_from)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        print_result_item(<span class="built_in">dict</span>(row._mapping))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_products_with_in_subquery</span>(<span class="params">connection=<span class="literal">None</span>, min_price=<span class="number">100</span>, max_price=<span class="number">200</span></span>):</span><br><span class="line">    <span class="string">""" --- 子查询用在 IN 子句中 ---"""</span></span><br><span class="line">    print_info(<span class="string">f"\n子查询: 查找价格在 <span class="subst">{min_price}</span> 到 <span class="subst">{max_price}</span> 之间的产品，以及这些产品所属的类别:"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.构建子查询，找出价格在指定范围内的产品ID</span></span><br><span class="line">    subquery_product_ids = select(products_table.c.<span class="built_in">id</span>).where(</span><br><span class="line">        products_table.c.price.between(min_price, max_price)</span><br><span class="line">    ).scalar_subquery()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.使用IN子句查询符合条件的产品及其类别信息</span></span><br><span class="line">    stmt = select(</span><br><span class="line">        products_table.c.name,</span><br><span class="line">        products_table.c.price,</span><br><span class="line">        categories_table.c.name.label(<span class="string">"category_name"</span>)</span><br><span class="line">    ).join(</span><br><span class="line">        categories_table,</span><br><span class="line">        products_table.c.category_id == categories_table.c.category_id</span><br><span class="line">    ).where(</span><br><span class="line">        products_table.c.<span class="built_in">id</span>.in_(subquery_product_ids)</span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt))</span><br><span class="line">    result = connection.execute(stmt)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        print_result_item(<span class="built_in">dict</span>(row._mapping))</span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_products_with_alias_self_comparison</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">""" --- 子查询用于自连接比较 ---"""</span></span><br><span class="line">    print_info(<span class="string">"\n子查询: 查找比同类别平均价格高的产品:"</span>)</span><br><span class="line">    <span class="comment"># 1.创建产品表的别名，用于自连接</span></span><br><span class="line">    avg_price_by_category = select(</span><br><span class="line">        products_table.c.category_id,</span><br><span class="line">        func.avg(products_table.c.price).label(<span class="string">"avg_price"</span>)</span><br><span class="line">    ).group_by(products_table.c.category_id).subquery() <span class="comment"># subquery 表示一个子查询，可以作为主查询的一部分 也可以作为一个用来join的对象</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2.构建主查询，连接原表和子查询</span></span><br><span class="line">    stmt = select(</span><br><span class="line">        products_table.c.name,</span><br><span class="line">        products_table.c.category_id,</span><br><span class="line">        products_table.c.price,</span><br><span class="line">        avg_price_by_category.c.avg_price</span><br><span class="line">    ).join(</span><br><span class="line">        avg_price_by_category,</span><br><span class="line">        products_table.c.category_id == avg_price_by_category.c.category_id,</span><br><span class="line">    ).where(</span><br><span class="line">        products_table.c.price &gt; avg_price_by_category.c.avg_price</span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt))</span><br><span class="line">    result = connection.execute(stmt)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        print_result_item(<span class="built_in">dict</span>(row._mapping))</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h6 id="SQLAlchemy-数据库函数-func"><a href="#SQLAlchemy-数据库函数-func" class="headerlink" title="SQLAlchemy 数据库函数 (func)"></a>SQLAlchemy 数据库函数 (func)</h6><p>SQLAlchemy 通过 <code>sqlalchemy.func</code> 这个特殊对象，提供了一种<strong>与数据库无关</strong>的方式来调用 SQL 内置函数。这意味着你可以用统一的 Python 语法（如 <code>func.count()</code>, <code>func.now()</code>, <code>func.lower()</code>）来生成对应数据库（如 MySQL, PostgreSQL, SQLite）的特定函数调用（如 <code>COUNT()</code>, <code>NOW()</code>, <code>LOWER()</code>）。SQLAlchemy 的方言 (Dialect) 会负责进行正确的语法转换。</p><p><strong>常用 <code>func</code> 函数调用参考表</strong></p><p>下表列出了一些常用的 SQL 函数及其通过 <code>func</code> 调用的方式：</p><table><thead><tr><th align="left"><code>func</code> 调用示例</th><th align="left">对应 SQL 函数 (常见)</th><th align="left">用途说明</th><th align="left">分类</th></tr></thead><tbody><tr><td align="left"><code>func.count(col)</code> / <code>func.count()</code></td><td align="left"><code>COUNT(col)</code> / <code>COUNT(*)</code></td><td align="left">计数 (指定列或所有行)</td><td align="left">聚合</td></tr><tr><td align="left"><code>func.sum(col)</code></td><td align="left"><code>SUM(col)</code></td><td align="left">求和</td><td align="left">聚合</td></tr><tr><td align="left"><code>func.avg(col)</code></td><td align="left"><code>AVG(col)</code></td><td align="left">平均值</td><td align="left">聚合</td></tr><tr><td align="left"><code>func.max(col)</code></td><td align="left"><code>MAX(col)</code></td><td align="left">最大值</td><td align="left">聚合</td></tr><tr><td align="left"><code>func.min(col)</code></td><td align="left"><code>MIN(col)</code></td><td align="left">最小值</td><td align="left">聚合</td></tr><tr><td align="left"><code>func.count(distinct(col))</code></td><td align="left"><code>COUNT(DISTINCT col)</code></td><td align="left">计算非重复值的数量</td><td align="left">聚合</td></tr><tr><td align="left"><code>func.now()</code></td><td align="left"><code>NOW()</code>, <code>CURRENT_TIMESTAMP</code></td><td align="left">获取当前日期时间 (时间戳)</td><td align="left">日期/时间</td></tr><tr><td align="left"><code>func.current_date()</code></td><td align="left"><code>CURRENT_DATE</code></td><td align="left">获取当前日期</td><td align="left">日期/时间</td></tr><tr><td align="left"><code>func.current_time()</code></td><td align="left"><code>CURRENT_TIME</code></td><td align="left">获取当前时间</td><td align="left">日期/时间</td></tr><tr><td align="left"><code>func.extract(field, date_col)</code></td><td align="left"><code>EXTRACT(field FROM date_col)</code></td><td align="left">提取日期/时间部分 (‘year’, ‘month’)</td><td align="left">日期/时间</td></tr><tr><td align="left"><code>func.lower(str_col)</code></td><td align="left"><code>LOWER(str_col)</code></td><td align="left">字符串转小写</td><td align="left">字符串</td></tr><tr><td align="left"><code>func.upper(str_col)</code></td><td align="left"><code>UPPER(str_col)</code></td><td align="left">字符串转大写</td><td align="left">字符串</td></tr><tr><td align="left"><code>func.length(str_col)</code></td><td align="left"><code>LENGTH(str_col)</code>, <code>LEN()</code></td><td align="left">获取字符串长度</td><td align="left">字符串</td></tr><tr><td align="left"><code>func.concat(*args)</code></td><td align="left"><code>CONCAT(arg1, arg2, ...)</code></td><td align="left">字符串拼接</td><td align="left">字符串</td></tr><tr><td align="left"><code>func.substring(str, start, len)</code></td><td align="left"><code>SUBSTRING(str, start, len)</code>, <code>SUBSTR()</code></td><td align="left">提取子字符串</td><td align="left">字符串</td></tr><tr><td align="left"><code>func.abs(num_col)</code></td><td align="left"><code>ABS(num_col)</code></td><td align="left">绝对值</td><td align="left">数学</td></tr><tr><td align="left"><code>func.round(num_col, digits)</code></td><td align="left"><code>ROUND(num_col, digits)</code></td><td align="left">四舍五入</td><td align="left">数学</td></tr><tr><td align="left"><code>func.random()</code></td><td align="left"><code>RAND()</code>, <code>RANDOM()</code></td><td align="left">生成随机数 (具体行为看数据库)</td><td align="left">其他</td></tr></tbody></table><p><strong>注意:</strong> 某些函数（特别是日期/时间函数）的具体名称和行为可能因数据库方言而异，但通过 <code>func</code> 调用通常能提供较好的兼容性。</p><p><strong>代码示例 (完整版)</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ======== SQLAlchemy 数据库函数示例 ========</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demonstrate_sqlalchemy_functions</span>():</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    展示 SQLAlchemy 中各种数据库函数的使用方法</span></span><br><span class="line"><span class="string">    包括聚合函数、字符串函数、日期时间函数、数学函数和条件函数</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    print_subheader(<span class="string">"16. 使用 SQLAlchemy func 调用数据库函数 - 完整示例"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 演示聚合函数</span></span><br><span class="line">    <span class="comment">#demonstrate_aggregate_functions()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 演示字符串函数</span></span><br><span class="line">    <span class="comment">#demonstrate_string_functions()</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 演示日期/时间函数</span></span><br><span class="line">    <span class="comment">#demonstrate_datetime_functions()</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 演示数学函数</span></span><br><span class="line">    <span class="comment">#demonstrate_math_functions()</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 演示条件函数</span></span><br><span class="line">    demonstrate_conditional_functions()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demonstrate_aggregate_functions</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""展示 SQLAlchemy 聚合函数的使用"""</span></span><br><span class="line">    print_info(<span class="string">"\n聚合函数示例：产品统计"</span>)</span><br><span class="line"></span><br><span class="line">    stmt_agg_complete = select(</span><br><span class="line">        func.count(products_table.c.<span class="built_in">id</span>).label(<span class="string">"total_products"</span>),</span><br><span class="line">        func.count(distinct(products_table.c.category_id)).label(<span class="string">"distinct_categories"</span>),</span><br><span class="line">        func.<span class="built_in">sum</span>(products_table.c.stock).label(<span class="string">"total_stock"</span>),</span><br><span class="line">        func.avg(products_table.c.price).label(<span class="string">"average_price"</span>),</span><br><span class="line">        func.<span class="built_in">max</span>(products_table.c.price).label(<span class="string">"max_price"</span>),</span><br><span class="line">        func.<span class="built_in">min</span>(products_table.c.price).label(<span class="string">"min_price"</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_agg_complete))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = connection.execute(stmt_agg_complete).first()</span><br><span class="line">        <span class="keyword">if</span> result:</span><br><span class="line">            print_info(<span class="string">"聚合统计结果:"</span>)</span><br><span class="line">            print_result_item(<span class="built_in">dict</span>(result._mapping))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print_info(<span class="string">"未能获取产品统计信息。"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"执行聚合查询时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demonstrate_datetime_functions</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""展示 SQLAlchemy 日期/时间函数的使用"""</span></span><br><span class="line">    print_info(<span class="string">"\n日期/时间函数示例：数据库当前时间和日期部分提取"</span>)</span><br><span class="line">    stmt_func_datetime_complete = select(</span><br><span class="line">        func.now().label(<span class="string">"now"</span>),</span><br><span class="line">        func.current_date().label(<span class="string">"current_date"</span>),</span><br><span class="line">        func.current_time().label(<span class="string">"current_time"</span>),</span><br><span class="line">        func.current_timestamp().label(<span class="string">"current_timestamp"</span>),</span><br><span class="line">        func.sysdate().label(<span class="string">"sysdate"</span>),</span><br><span class="line">        func.localtime().label(<span class="string">"localtime"</span>),</span><br><span class="line">        func.localtimestamp().label(<span class="string">"localtimestamp"</span>),</span><br><span class="line">        func.extract(<span class="string">'year'</span>, func.current_timestamp()).label(<span class="string">"year"</span>),</span><br><span class="line">        func.extract(<span class="string">'month'</span>, func.current_timestamp()).label(<span class="string">"month"</span>),</span><br><span class="line">        func.extract(<span class="string">'day'</span>, func.current_timestamp()).label(<span class="string">"day"</span>),</span><br><span class="line">        func.extract(<span class="string">'hour'</span>, func.current_timestamp()).label(<span class="string">"hour"</span>),</span><br><span class="line">        func.extract(<span class="string">'minute'</span>, func.current_timestamp()).label(<span class="string">"minute"</span>),</span><br><span class="line">        func.extract(<span class="string">'second'</span>, func.current_timestamp()).label(<span class="string">"second"</span>),</span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_func_datetime_complete))</span><br><span class="line">    result = connection.execute(stmt_func_datetime_complete)</span><br><span class="line">    </span><br><span class="line">    print_info(<span class="string">"\n日期时间函数结果:"</span>)</span><br><span class="line">    print_info(<span class="string">"-"</span> * <span class="number">80</span>)</span><br><span class="line">    print_info(<span class="string">f"<span class="subst">{<span class="string">'函数名'</span>:&lt;<span class="number">20</span>}</span> <span class="subst">{<span class="string">'值'</span>:&lt;<span class="number">30</span>}</span>"</span>)</span><br><span class="line">    print_info(<span class="string">"-"</span> * <span class="number">80</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> row._mapping.items():</span><br><span class="line">            print_info(<span class="string">f"<span class="subst">{key:&lt;<span class="number">20</span>}</span> <span class="subst">{<span class="built_in">str</span>(value):&lt;<span class="number">30</span>}</span>"</span>)</span><br><span class="line">        print_info(<span class="string">"-"</span> * <span class="number">80</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@transactional</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demonstrate_math_functions</span>(<span class="params">connection=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""展示 SQLAlchemy 数学函数的使用"""</span></span><br><span class="line">    print_info(<span class="string">"\n数学函数示例：数学运算"</span>)</span><br><span class="line">    stmt_func_math = select(</span><br><span class="line">        func.<span class="built_in">abs</span>(-<span class="number">10</span>).label(<span class="string">"绝对值"</span>),</span><br><span class="line">        func.ceil(<span class="number">10.5</span>).label(<span class="string">"向上取整"</span>),</span><br><span class="line">        func.floor(<span class="number">10.5</span>).label(<span class="string">"向下取整"</span>),</span><br><span class="line">        func.sign(-<span class="number">10</span>).label(<span class="string">"符号"</span>),</span><br><span class="line">        func.sqrt(<span class="number">16</span>).label(<span class="string">"平方根"</span>),</span><br><span class="line">        func.power(<span class="number">2</span>, <span class="number">3</span>).label(<span class="string">"幂运算"</span>),</span><br><span class="line">        func.mod(<span class="number">10</span>, <span class="number">3</span>).label(<span class="string">"取模"</span>),</span><br><span class="line">        func.<span class="built_in">round</span>(<span class="number">10.5</span>).label(<span class="string">"四舍五入"</span>),</span><br><span class="line">    )</span><br><span class="line">    print_sql(<span class="built_in">str</span>(stmt_func_math))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = connection.execute(stmt_func_math)</span><br><span class="line">        print_info(<span class="string">"\n数学函数结果:"</span>)</span><br><span class="line">        print_info(<span class="string">"-"</span> * <span class="number">80</span>)</span><br><span class="line">        print_info(<span class="string">f"<span class="subst">{<span class="string">'函数名'</span>:&lt;<span class="number">20</span>}</span> <span class="subst">{<span class="string">'值'</span>:&lt;<span class="number">30</span>}</span>"</span>)</span><br><span class="line">        print_info(<span class="string">"-"</span> * <span class="number">80</span>)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">            <span class="keyword">for</span> key, value <span class="keyword">in</span> row._mapping.items():</span><br><span class="line">                print_info(<span class="string">f"<span class="subst">{key:&lt;<span class="number">20</span>}</span> <span class="subst">{<span class="built_in">str</span>(value):&lt;<span class="number">30</span>}</span>"</span>)</span><br><span class="line">            print_info(<span class="string">"-"</span> * <span class="number">80</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"执行数学函数查询时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    demonstrate_sqlalchemy_functions()</span><br></pre></td></tr></tbody></table></figure><hr><h5 id="16-3-4-SQLAlchemy-ORM-对象关系映射"><a href="#16-3-4-SQLAlchemy-ORM-对象关系映射" class="headerlink" title="16.3.4 SQLAlchemy ORM: 对象关系映射"></a>16.3.4 SQLAlchemy ORM: 对象关系映射</h5><p>ORM (Object Relational Mapper) 将数据库表映射为 Python 类，允许通过对象进行数据库操作。它是 SQLAlchemy 的核心功能，构建于 Core 之上。</p><p><strong>核心概念:</strong> 类 (Model) &lt;-&gt; 表 (Table), 对象 (Instance) &lt;-&gt; 行 (Row), 属性 (Attribute) &lt;-&gt; 列 (Column)。</p><p><strong>建议项目结构 (用于 ORM 示例):</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sqlalchemy_orm_practice/  <span class="comment"># 根目录</span></span><br><span class="line">├── __init__.py</span><br><span class="line">├── core_config.py        <span class="comment"># Engine 和 SessionLocal 设置 (使用 PyMySQL)</span></span><br><span class="line">├── models/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── base.py           <span class="comment"># DeclarativeBase, AbstractBaseModel, Mixins</span></span><br><span class="line">│   └── orm_models.py     <span class="comment"># CategoryORM, ProductORM 模型定义</span></span><br><span class="line">├── crud/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   └── orm_crud_ops.py   <span class="comment"># CRUD 操作示例类</span></span><br><span class="line">├── utils/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   └── print_utils.py <span class="comment"># 打印工具</span></span><br><span class="line">└── main_orm_runner.py    <span class="comment"># 主运行脚本 (创建表, 调用示例)</span></span><br></pre></td></tr></tbody></table></figure><h6 id="16-3-3-1-Session-ORM-的数据库交互句柄"><a href="#16-3-3-1-Session-ORM-的数据库交互句柄" class="headerlink" title="16.3.3.1. Session: ORM 的数据库交互句柄"></a>16.3.3.1. Session: ORM 的数据库交互句柄</h6><p><code>Session</code> 是与数据库交互的接口，管理对象状态 (Unit of Work) 和事务。</p><ul><li><strong>文件</strong>: <code>sqlalchemy_orm_practice/core_config.py</code></li><li><strong>知识点:</strong><ul><li><strong>创建</strong>: <code>sessionmaker</code> (工厂) -&gt; <code>SessionLocal</code> (配置好的 Session 类) -&gt; <code>session = SessionLocal()</code> (实例)。</li><li><strong>配置 (<code>sessionmaker</code>)</strong>: <code>bind=engine</code> (必需), <code>autocommit=False</code> (默认), <code>autoflush=False</code> (推荐), <code>expire_on_commit=True</code> (默认)。</li><li><strong>生命周期/作用域</strong>: 短期存在，非线程安全。Web 应用模式：<strong>每请求一 Session</strong>。<strong>严禁全局共享 Session 实例</strong>。</li><li><strong>上下文管理 (<code>with</code>)</strong>: <code>with SessionLocal() as session:</code> 自动管理 <code>session.close()</code>。</li></ul></li><li><strong>核心 Session 方法 (快速参考):</strong></li></ul><table><thead><tr><th align="left">方法</th><th align="left">用途说明</th></tr></thead><tbody><tr><td align="left"><code>session.add(obj)</code></td><td align="left">添加新对象实例 (标记为待 INSERT)。</td></tr><tr><td align="left"><code>session.add_all(list)</code></td><td align="left">添加多个新对象实例。</td></tr><tr><td align="left"><code>session.delete(obj)</code></td><td align="left">标记持久化对象为待 DELETE。</td></tr><tr><td align="left"><code>session.commit()</code></td><td align="left">Flush 挂起更改并提交事务。</td></tr><tr><td align="left"><code>session.rollback()</code></td><td align="left">回滚事务，撤销更改。</td></tr><tr><td align="left"><code>session.flush()</code></td><td align="left">将更改同步到 DB (不提交事务)，获取自增 ID 等。</td></tr><tr><td align="left"><code>session.get(Model, pk)</code></td><td align="left">通过主键高效获取单个对象。</td></tr><tr><td align="left"><code>session.execute(stmt)</code></td><td align="left">(2.0+) 执行 Core 语句 (ORM 查询主要方式)。</td></tr></tbody></table><p><strong>代码示例: Engine 和 Session 设置 (使用 PyMySQL)</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">SQLAlchemy ORM 核心配置模块</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">此模块包含数据库连接引擎和会话的配置。</span></span><br><span class="line"><span class="string">提供了创建数据库引擎和会话工厂的功能，用于整个应用程序的数据库交互。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">主要组件:</span></span><br><span class="line"><span class="string">- engine: 数据库连接引擎</span></span><br><span class="line"><span class="string">- SessionLocal: 本地会话工厂，用于创建数据库会话</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine  <span class="comment"># 数据库引擎</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker  <span class="comment"># 会话工厂</span></span><br><span class="line"><span class="keyword">from</span> utils.print_utils <span class="keyword">import</span> print_info, print_success, print_error  <span class="comment"># 打印工具</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 数据库连接配置 (使用 PyMySQL) ---</span></span><br><span class="line"><span class="comment"># !!! 生产环境应使用更安全的方式管理密码 !!!</span></span><br><span class="line">DB_USER = <span class="string">"root"</span></span><br><span class="line">DB_PASSWORD = <span class="string">"root"</span></span><br><span class="line">DB_HOST = <span class="string">"localhost"</span></span><br><span class="line">DB_PORT = <span class="number">3306</span></span><br><span class="line">DB_NAME = <span class="string">"sqlalchemy_orm_db"</span>  <span class="comment"># 确保此数据库已创建</span></span><br><span class="line">DB_CHARSET = <span class="string">"utf8mb4"</span></span><br><span class="line">ORM_DATABASE_URL = <span class="string">f"mysql+pymysql://<span class="subst">{DB_USER}</span>:<span class="subst">{DB_PASSWORD}</span>@<span class="subst">{DB_HOST}</span>:<span class="subst">{DB_PORT}</span>/<span class="subst">{DB_NAME}</span>?charset=<span class="subst">{DB_CHARSET}</span>"</span></span><br><span class="line">print_info(<span class="string">f"ORM 数据库连接 URL: <span class="subst">{ORM_DATABASE_URL.replace(DB_PASSWORD, <span class="string">'******'</span>)}</span>"</span>)  <span class="comment"># 打印时隐藏密码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 创建 Engine(针对 ORM) ---</span></span><br><span class="line">orm_engine = create_engine(</span><br><span class="line">    ORM_DATABASE_URL,</span><br><span class="line">    echo=<span class="literal">True</span>,  <span class="comment"># 打印 SQL 语句</span></span><br><span class="line">    future=<span class="literal">True</span>,  <span class="comment"># 启用 SQLAlchemy 2.0 新特性</span></span><br><span class="line">    pool_size=<span class="number">10</span>,  <span class="comment"># 连接池大小</span></span><br><span class="line">    max_overflow=<span class="number">20</span>,  <span class="comment"># 连接池溢出时最多创建的连接数</span></span><br><span class="line">    pool_recycle=<span class="number">3600</span>,  <span class="comment"># 连接池中连接的最大空闲时间，超过此时间的连接会被自动关闭</span></span><br><span class="line">)</span><br><span class="line">print_success(<span class="string">"ORM 数据库引擎创建成功"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 创建 SessionLocal 工厂 ---</span></span><br><span class="line">SessionLocal = sessionmaker(</span><br><span class="line">    autocommit=<span class="literal">False</span>,  <span class="comment"># 自动提交</span></span><br><span class="line">    autoflush=<span class="literal">False</span>,  <span class="comment"># 推荐 - 关闭自动刷新</span></span><br><span class="line">    bind=orm_engine,  <span class="comment"># 绑定引擎</span></span><br><span class="line">    expire_on_commit=<span class="literal">True</span>  <span class="comment"># 会话在提交后过期</span></span><br><span class="line">)</span><br><span class="line">print_success(<span class="string">"ORM 会话工厂创建成功"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例 (通常在其他模块中):</span></span><br><span class="line"><span class="comment"># with SessionLocal() as session:</span></span><br><span class="line"><span class="comment">#     # ... use session ...</span></span><br><span class="line"><span class="comment">#     session.commit() # or session.rollback()</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h6 id="16-3-3-2-声明式映射-Declarative-Mapping-定义模型"><a href="#16-3-3-2-声明式映射-Declarative-Mapping-定义模型" class="headerlink" title="16.3.3.2. 声明式映射 (Declarative Mapping): 定义模型"></a>16.3.3.2. 声明式映射 (Declarative Mapping): 定义模型</h6><p>使用带类型注解的 Python 类映射数据库表 (SQLAlchemy 2.0 风格)。</p><ul><li><p><strong>文件</strong>: <code>sqlalchemy_orm_practice/models/base.py</code>, <code>sqlalchemy_orm_practice/models/orm_models.py</code></p></li><li><p><strong>知识点:</strong></p><ul><li><strong><code>DeclarativeBase</code></strong>: 模型基类 (<code>class Base(DeclarativeBase):</code>)。<code>Base.metadata</code> 包含模式信息。</li><li><strong><code>__tablename__</code></strong>: 定义表名。</li><li><strong><code>Mapped[&lt;type&gt;]</code></strong>: Python 类型注解。</li><li><strong><code>mapped_column()</code></strong>: 定义列属性 (SQL 类型, 约束)。<code>ForeignKey("t.c")</code> 在此定义。</li><li><strong><code>__abstract__ = True</code></strong>: 定义不映射到表的抽象模型基类。</li><li><strong>Mixin</strong>: 普通类，用于通过多重继承共享属性或方法。</li></ul></li></ul><p><strong>代码示例: Base 和 Models 定义</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sqlalchemy_orm_practice/models/base.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">SQLAlchemy ORM 基础模型模块</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">此模块定义了应用程序中所有 ORM 模型的基类和 Mixin 类。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">主要组件:</span></span><br><span class="line"><span class="string">- DeclarativeBase: 所有 ORM 模型的基类</span></span><br><span class="line"><span class="string">- 各种可复用的 Mixin 类，如 TimestampMixin（提供时间戳功能）</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="comment"># -----Mapped 与 mapped_column 是做什么用的？ ----------</span></span><br><span class="line"><span class="comment"># Mapped[&lt;type&gt;] (例如 Mapped[int], Mapped[Optional[datetime]]):</span></span><br><span class="line"><span class="comment"># 类型注解工具：这是 SQLAlchemy 2.0 引入的，主要用于类型提示。它告诉开发者和其他工具（如静态类型检查器 Mypy）这个类属性是一个被 ORM 映射的字段，并且它在 Python 代码中的期望类型是什么。</span></span><br><span class="line"><span class="comment"># 提高可读性：让模型定义更清晰易懂。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mapped_column(...) (例如 mapped_column(Integer, primary_key=True)):</span></span><br><span class="line"><span class="comment"># 列定义函数：这是实际用来定义数据库列属性的函数。</span></span><br><span class="line"><span class="comment"># 您可以在这里指定该列在数据库中的具体 SQL 类型（如 Integer, String(50), TIMESTAMP）、是否为主键 (primary_key=True)、</span></span><br><span class="line"><span class="comment"># 是否允许为空 (nullable=False)、默认值 (default=... 或 server_default=func.now())、索引、外键 (ForeignKey(...))、注释等。</span></span><br><span class="line"><span class="comment"># 它是 SQLAlchemy 2.0 中声明模型列的首选方式，用于替代旧版本中直接使用 Column(...) 的方式。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Integer, DateTime, Boolean, TIMESTAMP, func, MetaData</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> DeclarativeBase, Mapped, mapped_column</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> utils.print_utils <span class="keyword">import</span> print_success</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 定义 Declarative Base ---</span></span><br><span class="line"><span class="comment"># DeclarativeBase 继承后会得到什么？</span></span><br><span class="line"><span class="comment"># 1.声明式能力：继承 DeclarativeBase 后，基类就获得了将 Python 类定义直接映射到数据库表的能力</span></span><br><span class="line"><span class="comment"># 2.metadata 属性：这个 Base 类会自动拥有一个名为 metadata 的 MetaData 对象。所有继承自 Base 的模型类，其表结构信息都会自动注册到这个 Base.metadata 中。</span></span><br><span class="line"><span class="comment"># DDL 操作基础：使得后续可以通过 Base.metadata.create_all(engine) 来自动创建所有定义的数据库表。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span>(<span class="title class_ inherited__">DeclarativeBase</span>):</span><br><span class="line">    <span class="string">"""所有ORM 模型的基类"""</span></span><br><span class="line">    <span class="comment"># 可选：可以定义一个 MetaData 对象来控制 ORM 行为</span></span><br><span class="line">    <span class="comment"># metadata = MetaData()</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 定义 Mixin (用于共享字段逻辑) ---</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimestampMixin</span>:</span><br><span class="line">    <span class="string">"""提供时间戳功能的 Mixin 类"""</span></span><br><span class="line">    <span class="comment"># 使用 server_default 和 onupdate 选项，可以 利用数据库能力自动管理时间戳</span></span><br><span class="line">    create_time: Mapped[<span class="type">Optional</span>[datetime]] = mapped_column(</span><br><span class="line">        TIMESTAMP, server_default=func.now(), comment=<span class="string">"创建时间"</span></span><br><span class="line">    )</span><br><span class="line">    update_time: Mapped[<span class="type">Optional</span>[datetime]] = mapped_column(</span><br><span class="line">        TIMESTAMP, server_default=func.now(), onupdate=func.now(), comment=<span class="string">"更新时间"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 定义抽象基类 (可选，用于共享 ID 等基础字段) ---</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AbstractBaseModel</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    <span class="string">"""包含 通用 ID 和 逻辑删除标记的抽象基类"""</span></span><br><span class="line">    __abstract__ = <span class="literal">True</span>  <span class="comment"># 不会创建对应的表</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[<span class="built_in">int</span>] = mapped_column(</span><br><span class="line">        Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>, comment=<span class="string">"主键ID"</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># Mysql 中 常用 TINYINT(1) 来存储布尔值，sqlalchemy 中可以用 Boolean 类型 他会自动映射为 TINYINT(1)</span></span><br><span class="line">    is_deleted: Mapped[<span class="built_in">bool</span>] = mapped_column(Boolean, server_default=<span class="string">"0"</span>, index=<span class="literal">True</span>, comment=<span class="string">"逻辑删除标记"</span>)</span><br><span class="line">print_success(<span class="string">"ORM Base, Mixin, AbstractBaseModel 已定义 (models/base.py)。"</span>)</span><br></pre></td></tr></tbody></table></figure><h6 id="16-3-3-3-定义关系-relationship"><a href="#16-3-3-3-定义关系-relationship" class="headerlink" title="16.3.3.3. 定义关系 (relationship)"></a>16.3.3.3. 定义关系 (relationship)</h6><p>在模型间建立关联，映射数据库外键。</p><ul><li><p><strong>文件</strong>: <code>sqlalchemy_orm_practice/models/orm_models.py</code> (在模型类中添加/修改 <code>relationship</code> 定义)</p></li><li><p><strong>知识点:</strong></p><ul><li><strong>核心</strong>: <code>relationship("TargetModel", back_populates="attr", lazy="...")</code></li><li><strong><code>back_populates</code></strong>: <strong>必须</strong>用于双向关系，值是对方模型的关系属性名。</li><li><strong><code>lazy</code> (加载策略)</strong>: <code>'select'</code> (默认, 易 N+1), <code>'joined'</code> (JOIN, 适合 to-one), <code>'selectin'</code> (推荐 to-many), <code>'subquery'</code>, <code>'noload'</code>, <code>'raise'</code>。可在查询时用 <code>options()</code> 覆盖。</li><li><strong><code>secondary</code></strong>: 指定多对多关联表。</li><li><strong><code>cascade</code></strong>: 控制级联操作 (<code>save-update</code>, <code>delete</code>, <code>delete-orphan</code> 等)。</li></ul></li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sqlalchemy_orm_practice/models/orm_models.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">SQLAlchemy ORM 模型定义模块</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">此模块包含具体的 ORM 模型类定义，用于映射到数据库表。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">主要模型:</span></span><br><span class="line"><span class="string">- CategoryORM: 映射到 categories 表的分类模型</span></span><br><span class="line"><span class="string">- ProductORM: 映射到 products 表的产品模型，与 CategoryORM 有关联关系</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> String, Integer, Numeric, ForeignKey, Boolean</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Mapped, mapped_column, relationship  <span class="comment"># 导入 relationship</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> .base <span class="keyword">import</span> AbstractBaseModel, TimestampMixin, Base  <span class="comment"># 从同目录的 base.py 导入</span></span><br><span class="line"><span class="keyword">from</span> utils.print_utils <span class="keyword">import</span> print_success  <span class="comment"># 绝对导入</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 定义具体模型 ---</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CategoryORM</span>(AbstractBaseModel, TimestampMixin):  <span class="comment"># 继承 AbstractBaseModel 和 TimestampMixin</span></span><br><span class="line">    <span class="string">"""产品类型 ORM 模型"""</span></span><br><span class="line">    __tablename__ = <span class="string">"categories_orm"</span></span><br><span class="line"></span><br><span class="line">    name: Mapped[<span class="built_in">str</span>] = mapped_column(</span><br><span class="line">        String(<span class="number">100</span>), nullable=<span class="literal">False</span>, index=<span class="literal">True</span>, unique=<span class="literal">True</span>, comment=<span class="string">"类别名称"</span></span><br><span class="line">    )</span><br><span class="line">    description: Mapped[<span class="type">Optional</span>[<span class="built_in">str</span>]] = mapped_column(</span><br><span class="line">        String(<span class="number">255</span>), nullable=<span class="literal">True</span>, comment=<span class="string">"类别描述"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 添加关系 (见下一节) ---</span></span><br><span class="line">    products: Mapped[<span class="type">List</span>[<span class="string">"ProductORM"</span>]] = relationship(</span><br><span class="line">        <span class="string">"ProductORM"</span>,  <span class="comment"># 目标模型类名</span></span><br><span class="line">        back_populates=<span class="string">"category"</span>,  <span class="comment"># 指向 ProductORM 类的 category 属性</span></span><br><span class="line">        cascade=<span class="string">"all, delete-orphan"</span>,  <span class="comment"># 级联操作: 删除 CategoryORM 时同时删除关联的 ProductORM</span></span><br><span class="line">        lazy=<span class="string">"selectin"</span>  <span class="comment"># 延迟加载，仅在需要时才加载数据</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""打印对象信息"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"&lt;CategoryORM(id=<span class="subst">{self.<span class="built_in">id</span>}</span>, name='<span class="subst">{self.name}</span>')&gt;"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductORM</span>(AbstractBaseModel, TimestampMixin):</span><br><span class="line">    <span class="string">"""产品 ORM 模型"""</span></span><br><span class="line">    __tablename__ = <span class="string">"products_orm"</span></span><br><span class="line"></span><br><span class="line">    name: Mapped[<span class="built_in">str</span>] = mapped_column(</span><br><span class="line">        String(<span class="number">100</span>), index=<span class="literal">True</span>, comment=<span class="string">"产品名称"</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 使用 Mapped[float] 作为 Python 类型提示，数据库类型由 Numeric 指定</span></span><br><span class="line">    price: Mapped[<span class="built_in">float</span>] = mapped_column(</span><br><span class="line">        Numeric(<span class="number">10</span>, <span class="number">2</span>), nullable=<span class="literal">False</span>, comment=<span class="string">"产品价格"</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># default 和 server_default 用于设置默认值，server_default 用于设置数据库默认值</span></span><br><span class="line">    stock: Mapped[<span class="built_in">int</span>] = mapped_column(</span><br><span class="line">        Integer, default=<span class="number">0</span>, server_default=<span class="string">"0"</span>, nullable=<span class="literal">False</span>, comment=<span class="string">"库存数量"</span></span><br><span class="line">    )</span><br><span class="line">    is_available: Mapped[<span class="built_in">bool</span>] = mapped_column(</span><br><span class="line">        Boolean, default=<span class="literal">True</span>, server_default=<span class="string">"1"</span>, nullable=<span class="literal">False</span>, comment=<span class="string">"是否上架"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 外键定义 ---</span></span><br><span class="line">    category_id: Mapped[<span class="type">Optional</span>[<span class="built_in">int</span>]] = mapped_column(</span><br><span class="line">        Integer, ForeignKey(<span class="string">"categories_orm.id"</span>, ondelete=<span class="string">"SET NULL"</span>),  <span class="comment"># 关联 categories_orm 表的 id 列，删除时设置为 NULL</span></span><br><span class="line">        nullable=<span class="literal">True</span>, index=<span class="literal">True</span>, comment=<span class="string">"类别所属ID"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 添加关系 ---</span></span><br><span class="line">    category: Mapped[<span class="type">Optional</span>[<span class="string">"CategoryORM"</span>]] = relationship(</span><br><span class="line">        <span class="string">"CategoryORM"</span>, back_populates=<span class="string">"products"</span>, lazy=<span class="string">"joined"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"&lt;ProductORM(id=<span class="subst">{self.<span class="built_in">id</span>}</span>, name='<span class="subst">{self.name}</span>', price=<span class="subst">{self.price}</span>)&gt;"</span></span><br><span class="line">print_success(<span class="string">"具体模型 CategoryORM, ProductORM (含关系占位) 已定义 (models/orm_models.py)。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 创建表的函数 (通常在应用启动或 main 脚本中调用) ---</span></span><br><span class="line"><span class="comment"># def create_orm_tables(engine):</span></span><br><span class="line"><span class="comment">#     print_info("尝试创建所有 ORM 模型对应的表...")</span></span><br><span class="line"><span class="comment">#     try:</span></span><br><span class="line"><span class="comment">#         Base.metadata.create_all(bind=engine)</span></span><br><span class="line"><span class="comment">#         print_success("ORM 表已创建 (如果尚不存在)。")</span></span><br><span class="line"><span class="comment">#     except Exception as e:</span></span><br><span class="line"><span class="comment">#         print_error(f"创建 ORM 表时出错: {e}")</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h6 id="16-3-3-4-ORM-CRUD-操作-使用-Session-和-select"><a href="#16-3-3-4-ORM-CRUD-操作-使用-Session-和-select" class="headerlink" title="16.3.3.4. ORM CRUD 操作 (使用 Session 和 select)"></a>16.3.3.4. ORM CRUD 操作 (使用 Session 和 select)</h6><p>(2.0+) 主要通过 <code>session.execute()</code> 结合 <code>select()</code>, <code>update()</code>, <code>delete()</code> 语句，或直接操作 Session 管理的对象。</p><ul><li><strong>文件</strong>: <code>sqlalchemy_orm_practice/crud/orm_crud_ops.py</code></li><li><strong>代码示例 :</strong></li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sqlalchemy_orm_practice/crud/orm_crud_ops.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">SQLAlchemy ORM CRUD 操作模块</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">此模块演示了 SQLAlchemy ORM 的基本 CRUD（创建、读取、更新、删除）操作。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">主要功能:</span></span><br><span class="line"><span class="string">- 创建: 创建新的类别和产品记录</span></span><br><span class="line"><span class="string">- 读取: 按 ID、条件筛选和排序查询记录</span></span><br><span class="line"><span class="string">- 更新: 更新现有记录的属性</span></span><br><span class="line"><span class="string">- 删除: 从数据库中删除记录</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> select, update, delete, func  <span class="comment"># 导入 SQL 语句构造模块</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.exc <span class="keyword">import</span> SQLAlchemyError  <span class="comment"># 导入 SQLAlchemy 异常处理模块</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Session  <span class="comment"># 导入 ORM 会话模块</span></span><br><span class="line"><span class="keyword">from</span> core_config <span class="keyword">import</span> SessionLocal  <span class="comment"># 导入 ORM 会话工厂</span></span><br><span class="line"><span class="keyword">from</span> models.orm_models <span class="keyword">import</span> CategoryORM, ProductORM  <span class="comment"># 导入 ORM 模型定义</span></span><br><span class="line"><span class="keyword">from</span> utils.print_utils <span class="keyword">import</span> print_header, print_subheader, print_info, print_success, print_error, print_sql, \</span><br><span class="line">    print_warning, \</span><br><span class="line">    print_result_item</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrmCrudOps</span>:</span><br><span class="line">    <span class="string">"""封装 ORM  CRUD 示例的类"""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, session: Session</span>):</span><br><span class="line">        <span class="string">"""依赖注入 Session 对象"""</span></span><br><span class="line">        <span class="variable language_">self</span>.session = session</span><br><span class="line">        <span class="variable language_">self</span>.last_category_id: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>  <span class="comment"># 记录最后一个插入的类别 ID</span></span><br><span class="line">        <span class="variable language_">self</span>.last_product_id: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>  <span class="comment"># 记录最后一个插入的产品 ID</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">###### 创建对象 (INSERT) ######</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_objects</span>(<span class="params">self</span>) -&gt; <span class="built_in">tuple</span>[<span class="type">Optional</span>[<span class="built_in">int</span>], <span class="type">Optional</span>[<span class="built_in">int</span>]]:</span><br><span class="line">        <span class="string">"""创建Category和Product对象并插入到数据库中"""</span></span><br><span class="line">        print_subheader(<span class="string">"1. 创建 ORM 对象 (INSERT)"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="variable language_">self</span>.session.begin_nested():  <span class="comment"># 开启事务</span></span><br><span class="line">                <span class="comment"># 创建 Category 对象</span></span><br><span class="line">                category = CategoryORM(name=<span class="string">"书籍类"</span>, description=<span class="string">"书籍类产品...包含各类图书"</span>)</span><br><span class="line">                <span class="variable language_">self</span>.session.add(category)  <span class="comment"># 将 Category 对象添加到会话中</span></span><br><span class="line">                <span class="variable language_">self</span>.session.flush()  <span class="comment"># 刷新会话，以便获取新插入对象的 ID</span></span><br><span class="line">                <span class="variable language_">self</span>.last_category_id = category.<span class="built_in">id</span>  <span class="comment"># 记录最后一个插入的类别 ID</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># 创建 Product 并关联</span></span><br><span class="line">                product = ProductORM(name=<span class="string">"Python 编程指南"</span>, price=<span class="number">39.99</span>, category_id=category.<span class="built_in">id</span>)</span><br><span class="line">                <span class="variable language_">self</span>.session.add(product)  <span class="comment"># 将 Product 对象添加到会话中</span></span><br><span class="line">                <span class="variable language_">self</span>.session.flush()  <span class="comment"># 刷新会话，以便获取新插入对象的 ID</span></span><br><span class="line">                <span class="variable language_">self</span>.last_product_id = product.<span class="built_in">id</span>  <span class="comment"># 记录最后一个插入的产品 ID</span></span><br><span class="line">            print_success(<span class="string">"创建 ORM 对象成功。"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.last_category_id, <span class="variable language_">self</span>.last_product_id</span><br><span class="line">        <span class="keyword">except</span> SQLAlchemyError <span class="keyword">as</span> e:</span><br><span class="line">            print_error(<span class="string">f"创建 ORM 对象失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">##### 查询对象 (SELECT) #####</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query_object</span>(<span class="params">self</span>):</span><br><span class="line">        print_subheader(<span class="string">"2. 查询 ORM 对象 (SELECT)"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 按 主键查询（session.get）</span></span><br><span class="line">            print_info(<span class="string">f"\n使用 session.get() 查询 Category ID=<span class="subst">{self.last_category_id}</span>:"</span>)</span><br><span class="line">            category = <span class="variable language_">self</span>.session.get(CategoryORM, <span class="variable language_">self</span>.last_category_id)</span><br><span class="line">            <span class="keyword">if</span> category:</span><br><span class="line">                print_success(<span class="string">f"查询结果: <span class="subst">{category}</span>"</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print_warning(<span class="string">f"查询结果: 未找到 ID=<span class="subst">{self.last_category_id}</span> 的 Category 对象。"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 条件查询(获取第一个)</span></span><br><span class="line">            print_info(<span class="string">"\n条件查询 Product (name like '%Python%'):"</span>)</span><br><span class="line">            stmt_find = select(ProductORM).where(ProductORM.name.like(<span class="string">"%Python%"</span>)).limit(<span class="number">1</span>)</span><br><span class="line">            product = <span class="variable language_">self</span>.session.execute(stmt_find).scalars().first()</span><br><span class="line">            <span class="keyword">if</span> product:</span><br><span class="line">                print_success(<span class="string">f"查询结果: <span class="subst">{product}</span>"</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print_warning(<span class="string">"查询结果: 未找到符合条件的 Product 对象。"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> SQLAlchemyError <span class="keyword">as</span> e:</span><br><span class="line">            print_error(<span class="string">f"查询失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">##### 更新对象 (UPDATE) #####</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_object</span>(<span class="params">self</span>):</span><br><span class="line">        print_subheader(<span class="string">"3. 更新 ORM 对象 (UPDATE)"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="variable language_">self</span>.session.begin_nested():  <span class="comment"># 开启事务</span></span><br><span class="line">                <span class="comment"># 方法一: 修改对象属性</span></span><br><span class="line">                print_info(<span class="string">f"\n修改 Product ID=<span class="subst">{self.last_product_id}</span>的价格"</span>)</span><br><span class="line">                product_to_update = <span class="variable language_">self</span>.session.get(ProductORM,<span class="variable language_">self</span>.last_product_id)</span><br><span class="line">                <span class="keyword">if</span> product_to_update:</span><br><span class="line">                    product_to_update.price = <span class="number">88.88</span> <span class="comment"># 直接修改属性</span></span><br><span class="line">                <span class="keyword">else</span>:print_warning(<span class="string">f"查询结果: 未找到 ID=<span class="subst">{self.last_product_id}</span> 的 Product 对象。"</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 方法二： ORM 级 UPDATE语句 (批量)</span></span><br><span class="line">                print_info(<span class="string">"\n批量降低 '书籍类' 的库存"</span>)</span><br><span class="line">                stmt_bulk_update = update(ProductORM).where(</span><br><span class="line">                    ProductORM.category.has(CategoryORM.name == <span class="string">"书籍类"</span>)</span><br><span class="line">                ).values(</span><br><span class="line">                    stock = ProductORM.stock - <span class="number">5</span> <span class="comment"># 批量修改库存</span></span><br><span class="line">                ).execution_options(synchronize_session=<span class="string">"fetch"</span>) <span class="comment"># 重要: 更新后刷新 session 中的对象</span></span><br><span class="line">                <span class="comment"># synchronize_session='fetch'/'evaluate'/False</span></span><br><span class="line">                <span class="comment"># 'fetch': 执行 UPDATE 后，SELECT 受影响行以更新 Session (最安全但可能慢)</span></span><br><span class="line">                <span class="comment"># 'evaluate': 尝试在 Python 中评估更新效果 (快，但可能不精确)</span></span><br><span class="line">                <span class="comment"># False: 不更新 Session 中的对象状态 (最快，但 Session 可能与 DB 不一致)</span></span><br><span class="line">                result = <span class="variable language_">self</span>.session.execute(stmt_bulk_update)</span><br><span class="line">                print_success(<span class="string">f"受影响的行数: <span class="subst">{result.rowcount}</span>"</span>)</span><br><span class="line">            print_success(<span class="string">"更新操作已暂存 (待外层 Commit)。"</span>)</span><br><span class="line">        <span class="keyword">except</span> SQLAlchemyError <span class="keyword">as</span> e:print_error(<span class="string">f"更新失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">###### 删除对象 (DELETE) ######</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_objects</span>(<span class="params">self</span>):</span><br><span class="line">        print_subheader(<span class="string">"4. 删除 ORM 对象 (DELETE)"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="variable language_">self</span>.session.begin_nested(): <span class="comment"># 事务</span></span><br><span class="line">                <span class="comment"># 方法一: 删除单个对象</span></span><br><span class="line">                print_info(<span class="string">f"\n删除 Product ID=<span class="subst">{self.last_product_id}</span>:"</span>)</span><br><span class="line">                product_to_del = <span class="variable language_">self</span>.session.get(ProductORM, <span class="variable language_">self</span>.last_product_id)</span><br><span class="line">                <span class="keyword">if</span> product_to_del:</span><br><span class="line">                    <span class="variable language_">self</span>.session.delete(product_to_del) <span class="comment"># 标记删除</span></span><br><span class="line">                    print_success(<span class="string">f"  ID=<span class="subst">{self.last_product_id}</span> 已标记删除。"</span>)</span><br><span class="line">                <span class="keyword">else</span>: print_warning(<span class="string">f"  未找到 ID=<span class="subst">{self.last_product_id}</span>。"</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 方法二: ORM 级 DELETE 语句 (批量)</span></span><br><span class="line">                print_info(<span class="string">"\n批量删除类别为 NULL 的产品:"</span>)</span><br><span class="line">                stmt_bulk_del = delete(ProductORM).where(ProductORM.category_id == <span class="literal">None</span>)</span><br><span class="line">                result = <span class="variable language_">self</span>.session.execute(stmt_bulk_del)</span><br><span class="line">                print_success(<span class="string">f"  批量删除影响了 <span class="subst">{result.rowcount}</span> 行。"</span>)</span><br><span class="line">            print_success(<span class="string">"  删除操作已暂存 (待外层 Commit)。"</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print_error(<span class="string">f"删除对象时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 在 main_orm_runner.py 中如何使用 ---</span></span><br><span class="line"><span class="comment"># with SessionLocal() as main_session:</span></span><br><span class="line"><span class="comment">#     crud_executor = OrmCrudOps(main_session)</span></span><br><span class="line"><span class="comment">#     try:</span></span><br><span class="line"><span class="comment">#         crud_executor.create_objects()</span></span><br><span class="line"><span class="comment">#         crud_executor.query_objects()</span></span><br><span class="line"><span class="comment">#         crud_executor.update_objects()</span></span><br><span class="line"><span class="comment">#         # crud_executor.delete_objects() # 决定是否执行删除</span></span><br><span class="line"><span class="comment">#         main_session.commit() # 提交所有操作</span></span><br><span class="line"><span class="comment">#         print_success("\n主事务已提交！")</span></span><br><span class="line"><span class="comment">#     except Exception as main_err:</span></span><br><span class="line"><span class="comment">#         print_error(f"\n主流程出错: {main_err}")</span></span><br><span class="line"><span class="comment">#         main_session.rollback()</span></span><br><span class="line"><span class="comment">#         print_info("主事务已回滚。")</span></span><br></pre></td></tr></tbody></table></figure><h6 id="16-3-3-5-运行示例测试"><a href="#16-3-3-5-运行示例测试" class="headerlink" title="16.3.3.5 运行示例测试"></a>16.3.3.5 运行示例测试</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">SQLAlchemy ORM 主运行脚本</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">此脚本作为项目的入口点，创建数据库表并运行各个示例模块的功能演示。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">主要功能:</span></span><br><span class="line"><span class="string">- 初始化数据库: 创建所有所需的表</span></span><br><span class="line"><span class="string">- 运行示例: 按顺序调用各个模块的示例功能</span></span><br><span class="line"><span class="string">- 演示工作流: 展示完整的 ORM 使用流程和最佳实践</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> func, inspect</span><br><span class="line"><span class="keyword">from</span> utils.print_utils <span class="keyword">import</span> print_header, print_info, print_success, print_error, print_warning</span><br><span class="line"><span class="keyword">from</span> core_config <span class="keyword">import</span> SessionLocal, orm_engine</span><br><span class="line"><span class="keyword">from</span> models.base <span class="keyword">import</span> Base</span><br><span class="line"><span class="keyword">from</span> models.orm_models <span class="keyword">import</span> CategoryORM, ProductORM</span><br><span class="line"><span class="keyword">from</span> crud.orm_crud_ops <span class="keyword">import</span> OrmCrudOps</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_tables</span>():</span><br><span class="line">    <span class="string">"""创建数据库表"""</span></span><br><span class="line">    print_header(<span class="string">"创建数据库表"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 创建所有模型对应的表</span></span><br><span class="line">        Base.metadata.create_all(bind=orm_engine)</span><br><span class="line">        print_success(<span class="string">"所有 ORM 表已创建 (如果尚不存在)。"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 打印创建的表信息</span></span><br><span class="line">        inspector = inspect(orm_engine)</span><br><span class="line">        tables = inspector.get_table_names()</span><br><span class="line">        print_info(<span class="string">f"数据库中的表: <span class="subst">{tables}</span>"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"创建表时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_crud_examples</span>():</span><br><span class="line">    <span class="string">"""运行 CRUD 操作示例"""</span></span><br><span class="line">    print_header(<span class="string">"运行 ORM CRUD 操作示例"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用会话上下文管理器</span></span><br><span class="line">    <span class="keyword">with</span> SessionLocal() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="comment"># 创建 CRUD 操作执行器</span></span><br><span class="line">        crud_executor = OrmCrudOps(session)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 1. 创建对象</span></span><br><span class="line">            category_id, product_id = crud_executor.create_objects()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> category_id <span class="keyword">or</span> <span class="keyword">not</span> product_id:</span><br><span class="line">                print_warning(<span class="string">"创建对象失败，跳过后续操作。"</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">                </span><br><span class="line">            <span class="comment"># 2. 查询对象</span></span><br><span class="line">            crud_executor.query_object()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 3. 更新对象</span></span><br><span class="line">            crud_executor.update_object()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 4. 删除对象 (可选)</span></span><br><span class="line">            <span class="comment"># 取消注释下一行以执行删除操作</span></span><br><span class="line">            <span class="comment"># crud_executor.delete_objects()</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 提交所有操作</span></span><br><span class="line">            session.commit()</span><br><span class="line">            print_success(<span class="string">"\n所有操作已成功提交！"</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print_error(<span class="string">f"\n执行 CRUD 操作时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line">            session.rollback()</span><br><span class="line">            print_info(<span class="string">"所有操作已回滚。"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 创建表结构</span></span><br><span class="line">    <span class="comment"># create_tables()</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行 CRUD 示例</span></span><br><span class="line">    run_crud_examples()</span><br><span class="line">    </span><br><span class="line">    print_header(<span class="string">"程序执行完毕"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><hr><h3 id="16-4-mybatis-py-轻量级-Python-SQL-映射器"><a href="#16-4-mybatis-py-轻量级-Python-SQL-映射器" class="headerlink" title="16.4 mybatis-py: 轻量级 Python SQL 映射器"></a>16.4 mybatis-py: 轻量级 Python SQL 映射器</h3><p><code>mybatis-py</code> 是一个为 Python 开发者设计的轻量级 SQL 映射框架，其核心理念与 Java 领域知名的 MyBatis 框架相近。它旨在提供一种方式，让开发者能够更直接地控制 SQL 语句的编写和执行，同时又通过映射机制简化 Python 代码与数据库之间的交互。对于既想利用 SQL 的全部能力进行性能调优或处理复杂逻辑，又希望避免直接操作原生数据库驱动（如 <code>pymysql</code>）时繁琐的模板代码的场景，<code>mybatis-py</code> 是一个值得考虑的工具。</p><h5 id="16-4-1-核心知识"><a href="#16-4-1-核心知识" class="headerlink" title="16.4.1 核心知识"></a>16.4.1 核心知识</h5><ul><li><p><strong>核心定位</strong>: 半自动化 ORM / SQL 映射器 (强调 SQL 控制权)。</p></li><li><p><strong>主要功能特性概览:</strong></p><table><thead><tr><th align="left">特性编号</th><th align="left">功能描述</th><th align="left">详细说明与开发者价值</th></tr></thead><tbody><tr><td align="left">1</td><td align="left"><strong>半自动化的 ORM</strong></td><td align="left">提供 Python 方法到 SQL 语句的映射，以及结果集到 Python 字典或简单对象的转换，简化数据访问代码，但开发者仍需编写 SQL。</td></tr><tr><td align="left">2</td><td align="left"><strong>支持动态 SQL</strong></td><td align="left">核心特性之一。允许在 XML Mapper 文件中使用 <code>&lt;if&gt;</code>, <code>&lt;foreach&gt;</code>, <code>&lt;where&gt;</code>, <code>&lt;set&gt;</code> 等标签，根据传入参数动态构建和调整 SQL 语句，实现复杂查询逻辑。</td></tr><tr><td align="left">3</td><td align="left"><strong>装饰器 API</strong></td><td align="left">提供了类似 MyBatis 注解的 Python 装饰器 (<code>@mb.SelectOne</code>, <code>@mb.Insert</code> 等)，可直接在 Python 方法上绑定 SQL 语句，适用于简单、固定的 SQL 操作。</td></tr><tr><td align="left">4</td><td align="left"><strong>LRU 缓存及过期机制</strong></td><td align="left">内置基于 LRU (Least Recently Used) 算法的查询缓存，可配置缓存池大小和条目过期时间，对不经常变动但查询频繁的数据能有效提升性能。</td></tr><tr><td align="left">5</td><td align="left"><strong>Prepared Statement 支持</strong></td><td align="left">当使用 <code>#{placeholder}</code> 语法时，优先使用预编译语句，将 SQL 结构与数据分离，这是防御 SQL 注入攻击的关键手段。</td></tr><tr><td align="left">6</td><td align="left"><strong>预防大对象机制 (OOM)</strong></td><td align="left">内置机制（通过 <code>max_result_bytes</code> 参数）限制从数据库拉取并处理的数据总量，旨在避免因查询结果集过大导致的应用程序内存溢出问题。</td></tr><tr><td align="left">7</td><td align="left"><strong>多数据库支持</strong></td><td align="left">目前明确支持 MySQL 和 PostgreSQL，可以通过 <code>ConnectionFactory</code> 指定不同的 <code>dbms_name</code>。</td></tr></tbody></table></li><li><p>**安装 <code>mybatis-py</code> **</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -U mybatis</span><br></pre></td></tr></tbody></table></figure><ul><li><code>mybatis</code>: <code>mybatis-py</code> 库。</li></ul></li><li><p><strong>数据库及表示例准备 (MySQL):</strong><br><em>(确保 MySQL 服务已启动，并已创建相应数据库、用户及授权。以下 SQL 用于创建本节演示所需的库和表。)</em></p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. 创建数据库 (如果不存在)，使用 utf8mb4 字符集以支持更广泛的字符</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> mybatis_py_complete_demo <span class="keyword">CHARACTER SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 创建用户并授权 (请务必将 'your_strong_password' 替换为强密码)</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">'mb_user_complete'</span>@<span class="string">'localhost'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'your_strong_password'</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> mybatis_py_complete_demo.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">'mb_user_complete'</span>@<span class="string">'localhost'</span>;</span><br><span class="line">FLUSH PRIVILEGES; <span class="comment">-- 刷新权限使之立即生效</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 切换到目标数据库</span></span><br><span class="line">USE mybatis_py_complete_demo;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. 创建示例表 'fruit_categories' (水果类别表)</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> fruit_categories (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span> COMMENT <span class="string">'类别ID (主键)'</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span> COMMENT <span class="string">'类别名称 (唯一)'</span>,</span><br><span class="line">    description TEXT COMMENT <span class="string">'类别描述'</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">'水果类别表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5. 创建示例表 'fruits' (水果信息表)，并设置外键关联</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> fruits (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span> COMMENT <span class="string">'水果ID (主键)'</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">'水果名称'</span>,</span><br><span class="line">    category_id <span class="type">INT</span> COMMENT <span class="string">'类别ID (外键), 允许为NULL表示未分类'</span>,</span><br><span class="line">    price <span class="type">INT</span> COMMENT <span class="string">'价格 (单位：分，使用整数存储以避免浮点精度问题)'</span>,</span><br><span class="line">    description TEXT COMMENT <span class="string">'水果描述 (可选)'</span>,</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (category_id) <span class="keyword">REFERENCES</span> fruit_categories(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">SET</span> <span class="keyword">NULL</span>  <span class="comment">-- 如果关联的类别被删除，此水果的 category_id 设为 NULL</span></span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE   <span class="comment">-- 如果关联的类别的 id 更新，此水果的 category_id 自动更新</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">'水果信息表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 6. 清空表数据并插入初始记录 (方便重复运行示例)</span></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS<span class="operator">=</span><span class="number">0</span>; <span class="comment">-- 临时禁用外键检查，方便清空</span></span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> fruits;</span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> fruit_categories;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS<span class="operator">=</span><span class="number">1</span>; <span class="comment">-- 重新启用外键检查</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> fruit_categories (name, description) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">'温带水果'</span>, <span class="string">'如苹果、梨等'</span>),</span><br><span class="line">(<span class="string">'热带水果'</span>, <span class="string">'如香蕉、芒果、菠萝等'</span>),</span><br><span class="line">(<span class="string">'浆果类'</span>, <span class="string">'如草莓、蓝莓、树莓等'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> fruits (name, category_id, price, description) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">'红富士苹果'</span>, (<span class="keyword">SELECT</span> id <span class="keyword">FROM</span> fruit_categories <span class="keyword">WHERE</span> name<span class="operator">=</span><span class="string">'温带水果'</span>), <span class="number">750</span>, <span class="string">'脆甜多汁的红富士苹果'</span>),</span><br><span class="line">(<span class="string">'香芽蕉'</span>, (<span class="keyword">SELECT</span> id <span class="keyword">FROM</span> fruit_categories <span class="keyword">WHERE</span> name<span class="operator">=</span><span class="string">'热带水果'</span>), <span class="number">420</span>, <span class="string">'口感软糯的香芽蕉'</span>),</span><br><span class="line">(<span class="string">'奶油草莓'</span>, (<span class="keyword">SELECT</span> id <span class="keyword">FROM</span> fruit_categories <span class="keyword">WHERE</span> name<span class="operator">=</span><span class="string">'浆果类'</span>), <span class="number">1200</span>, <span class="string">'大颗香甜的奶油草莓'</span>);</span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>建议项目结构 (用于 <code>mybatis-py</code> 示例):</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">db_framework_practice/</span><br><span class="line">├── examples/</span><br><span class="line">│   ├── mybatis_py_v_final/      # 为当前完整重写版本创建新目录</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── config.py             # 数据库连接参数</span><br><span class="line">│   │   ├── ex01_decorators_main.py # 装饰器使用示例主程序</span><br><span class="line">│   │   ├── fruit_repo_deco.py    # 使用装饰器的水果仓库类</span><br><span class="line">│   │   ├── mappers/                # 存放 XML Mapper 文件</span><br><span class="line">│   │   │   ├── __init__.py         # 使 mappers 成为一个包</span><br><span class="line">│   │   │   └── fruits_mapper.xml      # 使用动态sql的核心模块</span><br><span class="line">│   │   └── ex02_xml_mapper_main.py # XML Mapper 使用示例主程序</span><br><span class="line">│   │   └── ex03_flask_app_main.py  # Flask 集成示例 (在后续提供)</span><br><span class="line">├── utils/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   └── print_utils.py            # 打印工具模块</span><br><span class="line">└── ...</span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>数据库配置文件: <code>examples/mybatis_py_v_final/config.py</code></strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">数据库连接配置模块</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">此模块包含数据库连接的配置参数，用于建立与数据库的连接。</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库连接参数</span></span><br><span class="line">DB_CONFIG = {</span><br><span class="line">    <span class="string">'dbms_name'</span>: <span class="string">'mysql'</span>, <span class="comment"># change to 'postgresql' if you are using PostgreSQL</span></span><br><span class="line">    <span class="string">'host'</span>: <span class="string">'localhost'</span>,</span><br><span class="line">    <span class="string">'port'</span>: <span class="number">3306</span>,</span><br><span class="line">    <span class="string">'user'</span>: <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span>: <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'database'</span>: <span class="string">'mybatis_demo'</span>,</span><br><span class="line"><span class="string">'charset'</span>: <span class="string">'utf8mb4'</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># Mybatis 实例通用配置</span></span><br><span class="line">MYBATIS_CONFIG = {</span><br><span class="line">    <span class="string">"cache_memory_limit"</span>: <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>, <span class="comment"># 10MB 缓存</span></span><br><span class="line">    <span class="string">"cache_max_live_ms"</span>: <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>,     <span class="comment"># 5 分钟缓存有效期 (毫秒)</span></span><br><span class="line">    <span class="string">"max_result_bytes"</span>: <span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>    <span class="comment"># 50MB 最大结果集字节数 (用于 select_many)</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li></ul><hr><p><strong><code>Mybatis</code> 类核心 API (基于提供的源码分析)</strong></p><p>以下是对 <code>mybatis-py</code> 源码中 <code>Mybatis</code> 类的核心构造函数、主要方法及其参数的总结。</p><ul><li><p><strong><code>Mybatis.__init__(...)</code> 构造函数参数</strong></p><table><thead><tr><th align="left">参数</th><th align="left">类型</th><th align="left">描述</th><th align="left">源码默认/说明</th></tr></thead><tbody><tr><td align="left"><code>conn</code></td><td align="left"><code>AbstractConnection</code></td><td align="left"><strong>必需</strong>. 已建立的数据库连接对象 (通常通过 <code>ConnectionFactory.get_connection()</code> 获取)。</td><td align="left">-</td></tr><tr><td align="left"><code>mapper_path</code></td><td align="left"><code>str</code></td><td align="left"><strong>必需</strong>. XML Mapper 文件所在的目录路径或 Python 包路径 (例如 <code>"mappers"</code> 或 <code>"your_package.mappers"</code>)。</td><td align="left">库会在此路径下查找并加载所有 <code>.xml</code> 后缀的 Mapper 文件。</td></tr><tr><td align="left"><code>cache_memory_limit</code></td><td align="left"><code>Optional[int]</code></td><td align="left">可选。缓存的内存限制 (字节)。如果为 <code>None</code>，源码中 <code>Cache</code> 对象以 <code>0</code> 初始化，可能表示不启用或使用不同逻辑。</td><td align="left">默认: <code>None</code> (源码中 Cache(0,…))</td></tr><tr><td align="left"><code>cache_max_live_ms</code></td><td align="left"><code>int</code></td><td align="left">可选。缓存条目的最大存活时间 (毫秒)。</td><td align="left">默认: <code>5 * 1000</code> (即 5 秒)</td></tr><tr><td align="left"><code>max_result_bytes</code></td><td align="left"><code>int</code></td><td align="left">可选。<code>select_many</code> 方法返回的结果列表允许占用的最大总字节数，用于防止 OOM。</td><td align="left">默认: <code>100 * 1024 * 1024</code> (即 100MB)</td></tr></tbody></table></li><li><p><strong>XML Mapper 调用方法 (Mybatis 实例方法)</strong></p><table><thead><tr><th align="left">方法</th><th align="left">参数</th><th align="left">返回类型</th><th align="left">用途说明</th></tr></thead><tbody><tr><td align="left"><code>select_one(id: str, params: dict)</code></td><td align="left"><code>id</code> (XML中语句的 <code>namespace.id</code> 或全局唯一 <code>id</code>) &lt;br&gt; <code>params</code> (传递给SQL的参数字典)</td><td align="left"><code>Optional[Dict]</code></td><td align="left">执行 <code>&lt;select&gt;</code> 语句，预期返回单条记录 (字典) 或 <code>None</code>。会使用缓存。</td></tr><tr><td align="left"><code>select_many(id: str, params: dict)</code></td><td align="left"><code>id</code> (XML中语句的 <code>namespace.id</code> 或全局唯一 <code>id</code>) &lt;br&gt; <code>params</code> (传递给SQL的参数字典)</td><td align="left"><code>Optional[List[Dict]]</code></td><td align="left">执行 <code>&lt;select&gt;</code> 语句，返回多条记录 (字典列表) 或 <code>None</code> (若无结果)。会使用缓存及 <code>max_result_bytes</code> 限制。</td></tr><tr><td align="left"><code>update(id: str, params: dict)</code></td><td align="left"><code>id</code> (XML中语句的 <code>namespace.id</code> 或全局唯一 <code>id</code>) &lt;br&gt; <code>params</code> (传递给SQL的参数字典)</td><td align="left"><code>int</code></td><td align="left">执行 <code>&lt;update&gt;</code> 语句，返回受影响的行数 (<code>cursor.rowcount()</code>)。<strong>会清空整个缓存</strong>。</td></tr><tr><td align="left"><code>delete(id: str, params: dict)</code></td><td align="left"><code>id</code> (XML中语句的 <code>namespace.id</code> 或全局唯一 <code>id</code>) &lt;br&gt; <code>params</code> (传递给SQL的参数字典)</td><td align="left"><code>int</code></td><td align="left">执行 <code>&lt;delete&gt;</code> 语句，返回受影响的行数 (<code>cursor.rowcount()</code>)。<strong>会清空整个缓存</strong>。</td></tr><tr><td align="left"><code>insert(id: str, params: dict, primary_key: str = None)</code></td><td align="left"><code>id</code> (XML中语句的 <code>namespace.id</code> 或全局唯一 <code>id</code>) &lt;br&gt; <code>params</code> (参数字典) &lt;br&gt; <code>primary_key</code> (可选，用于 PostgreSQL 的 <code>RETURNING</code> 子句，指定主键列名)</td><td align="left"><code>int</code></td><td align="left">执行 <code>&lt;insert&gt;</code> 语句。返回值是 <code>cursor.lastrowid()</code> (通常用于获取 MySQL 自增ID)。<strong>会清空整个缓存</strong>。<code>params</code> 字典可能被 XML 中的 <code>keyProperty</code> 修改。</td></tr></tbody></table></li><li><p><strong>装饰器方法 (<code>@mb.DecoratorName</code>)</strong></p><table><thead><tr><th align="left">装饰器方法 (<code>@mb.&lt;Name&gt;</code>)</th><th align="left">装饰器参数</th><th align="left">装饰的函数签名 (示例)</th><th align="left">用途及内部行为说明</th></tr></thead><tbody><tr><td align="left"><code>SelectOne(unparsed_sql)</code></td><td align="left"><code>unparsed_sql</code> (原始SQL字符串)</td><td align="left"><code>def func(**kwargs) -&gt; Optional[Dict]</code></td><td align="left">将函数映射到给定的 <code>SELECT</code> SQL，预期返回单条记录。<code>kwargs</code> 作为参数传递给 SQL (<code>#{key}</code> 占位符)。内部处理 SQL 解析、参数绑定、缓存、结果转换。</td></tr><tr><td align="left"><code>SelectMany(unparsed_sql)</code></td><td align="left"><code>unparsed_sql</code> (原始SQL字符串)</td><td align="left"><code>def func(**kwargs) -&gt; Optional[List[Dict]]</code></td><td align="left">将函数映射到给定的 <code>SELECT</code> SQL，返回多条记录。处理同上，并应用 <code>max_result_bytes</code>。</td></tr><tr><td align="left"><code>Insert(unparsed_sql, primary_key=None)</code></td><td align="left"><code>unparsed_sql</code> (SQL), <code>primary_key</code> (主键列名)</td><td align="left"><code>def func(**kwargs) -&gt; int</code> (通常返回 <code>lastrowid</code>)</td><td align="left">将函数映射到 <code>INSERT</code> SQL。<code>primary_key</code> 主要用于 PostgreSQL 的 <code>RETURNING</code>。MySQL 中通常返回 <code>lastrowid</code>。<strong>清空缓存</strong>。</td></tr><tr><td align="left"><code>Update(unparsed_sql)</code></td><td align="left"><code>unparsed_sql</code> (原始SQL字符串)</td><td align="left"><code>def func(**kwargs) -&gt; int</code> (返回受影响行数)</td><td align="left">将函数映射到 <code>UPDATE</code> SQL，返回受影响行数。<strong>清空缓存</strong>。</td></tr><tr><td align="left"><code>Delete(unparsed_sql)</code></td><td align="left"><code>unparsed_sql</code> (原始SQL字符串)</td><td align="left"><code>def func(**kwargs) -&gt; int</code> (返回受影响行数)</td><td align="left">将函数映射到 <code>DELETE</code> SQL，返回受影响行数。<strong>清空缓存</strong>。</td></tr></tbody></table></li><li><p><strong><code>Workspace_rows(cursor, batch_size=1000)</code> 辅助函数 (内部)</strong>:</p><ul><li>在 <code>Mybatis.select_many</code> 和装饰器 <code>SelectMany</code> 内部使用，用于分批从数据库游标获取数据。</li><li>将每批获取的行数据 (通常是元组) 转换为字典列表 (键为列名)。</li><li>使用 <code>yield</code> 以生成器方式逐条返回字典，这使得调用方 (如 <code>select_many</code>) 可以在迭代过程中检查 <code>max_result_bytes</code> 限制。</li></ul></li><li><p><strong>缓存键 (<code>CacheKey(sql, param_list)</code>)</strong>:</p><ul><li>用于在缓存中唯一标识一个查询。</li><li>它基于经过内部处理和参数绑定后的 SQL 语句 (<code>sql</code>) 和实际绑定的参数列表 (<code>param_list</code>) 生成。</li><li>确保 SQL 相同但参数不同的查询会有不同的缓存条目。</li></ul></li></ul><hr><ul><li><p><strong>方法一: 使用装饰器 API</strong><br>适用于 SQL 语句相对固定且逻辑简单的场景。</p><ul><li><strong>文件</strong>: <code>db_framework_practice/examples/mybatis_py_v2/ex01_decorators_usage.py</code> (封装操作)</li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">装饰器使用示例模块</span></span><br><span class="line"><span class="string"># db_framework_practice/examples/mybatis_py_v2/ex01_decorators_usage.py</span></span><br><span class="line"><span class="string">此模块演示了如何使用MyBatis-Py V2的装饰器功能进行数据库操作。</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mybatis <span class="keyword">import</span> Mybatis, ConnectionFactory</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> DB_CONFIG</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Optional</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">from</span> utils.print_utils <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FruitRepository</span>:</span><br><span class="line">    <span class="string">"""水果数据仓库类，封装对水果表的所有数据库操作"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, mappers_dir=<span class="string">"mappers"</span>, cache_size=<span class="number">50</span>*<span class="number">1024</span>*<span class="number">1024</span></span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        初始化水果仓库</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            mappers_dir: XML映射文件目录</span></span><br><span class="line"><span class="string">            cache_size: 缓存大小，默认50MB</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="variable language_">self</span>.connection_factory = ConnectionFactory.get_connection(**DB_CONFIG)</span><br><span class="line">        <span class="variable language_">self</span>.mybatis = Mybatis(<span class="variable language_">self</span>.connection_factory, mappers_dir, cache_memory_limit=cache_size)</span><br><span class="line">        <span class="variable language_">self</span>._init_operations()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_operations</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""初始化数据库操作方法"""</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">        @self.mybatis.SelectOne(<span class="params"><span class="string">"SELECT * FROM fruits WHERE id=#{id}"</span></span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">get_one</span>(<span class="params"><span class="built_in">id</span>: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">            <span class="string">"""获取一个水果记录，返回一个字典"""</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">        @self.mybatis.SelectMany(<span class="params"><span class="string">"SELECT * FROM fruits WHERE category_id = #{category_id}"</span></span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">get_many</span>(<span class="params">category_id: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">            <span class="string">"""获取多个水果记录，返回一个列表"""</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">        @self.mybatis.Insert(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">            <span class="string">"INSERT INTO fruits (name, category_id, price, description) VALUES (#{name}, #{category_id}, #{price}, #{description})"</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">            primary_key=<span class="string">"id"</span></span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">insert</span>(<span class="params">name: <span class="built_in">str</span>, category_id: <span class="built_in">int</span>, price: <span class="built_in">float</span>, description: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">            <span class="string">"""插入水果记录，返回插入的ID"""</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">        @self.mybatis.Delete(<span class="params"><span class="string">"DELETE FROM fruits WHERE id = #{id}"</span></span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params"><span class="built_in">id</span>: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">            <span class="string">"""删除水果记录，返回删除的行数"""</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">        @self.mybatis.Update(<span class="params"><span class="string">"UPDATE fruits SET name=#{name}, category_id=#{category_id}, price=#{price}, description=#{description} WHERE id=#{id}"</span></span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params"><span class="built_in">id</span>: <span class="built_in">int</span>, name: <span class="built_in">str</span>, category_id: <span class="built_in">int</span>, price: <span class="built_in">float</span>, description: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            更新水果记录，返回更新的行数</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将所有操作绑定到实例上</span></span><br><span class="line">        <span class="variable language_">self</span>.get_one = get_one</span><br><span class="line">        <span class="variable language_">self</span>.get_many = get_many</span><br><span class="line">        <span class="variable language_">self</span>.insert = insert</span><br><span class="line">        <span class="variable language_">self</span>.delete = delete</span><br><span class="line">        <span class="variable language_">self</span>.update = update</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""关闭数据库连接"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">'connection_factory'</span>) <span class="keyword">and</span> <span class="variable language_">self</span>.connection_factory:</span><br><span class="line">            <span class="variable language_">self</span>.connection_factory.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">"""主函数，用于测试FruitRepository类的功能"""</span></span><br><span class="line">    print_header(<span class="string">"Mybatis-Py: 装饰器 API 使用示例 (面向对象版)"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建仓库实例</span></span><br><span class="line">    repo = FruitRepository()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 测试查询功能</span></span><br><span class="line">        print_info(<span class="string">"1. 测试查询单个水果"</span>)</span><br><span class="line">        fruit = repo.get_one(<span class="built_in">id</span>=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> fruit:</span><br><span class="line">            print_success(<span class="string">f"查询到水果: <span class="subst">{fruit[<span class="string">'name'</span>]}</span>, 价格: <span class="subst">{fruit[<span class="string">'price'</span>]}</span>"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print_warning(<span class="string">"未找到ID为1的水果"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试查询多个水果</span></span><br><span class="line">        print_info(<span class="string">"\n2. 测试查询某分类下的所有水果"</span>)</span><br><span class="line">        category_id = <span class="number">1</span></span><br><span class="line">        fruits = repo.get_many(category_id=category_id)</span><br><span class="line">        print_success(<span class="string">f"分类 <span class="subst">{category_id}</span> 下有 <span class="subst">{<span class="built_in">len</span>(fruits)}</span> 个水果:"</span>)</span><br><span class="line">        <span class="keyword">for</span> fruit <span class="keyword">in</span> fruits:</span><br><span class="line">            print_info(<span class="string">f"  - <span class="subst">{fruit[<span class="string">'name'</span>]}</span>: ¥<span class="subst">{fruit[<span class="string">'price'</span>]}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试插入操作</span></span><br><span class="line">        print_info(<span class="string">"\n3. 测试插入新水果"</span>)</span><br><span class="line">        new_fruit = {</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"蓝莓"</span>,</span><br><span class="line">            <span class="string">"category_id"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">"price"</span>: <span class="number">25.5</span>,</span><br><span class="line">            <span class="string">"description"</span>: <span class="string">"新鲜蓝莓，富含抗氧化物质"</span></span><br><span class="line">        }</span><br><span class="line">        new_id = repo.insert(**new_fruit)</span><br><span class="line">        print_success(<span class="string">f"插入成功，新水果ID: <span class="subst">{new_id}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 测试更新操作</span></span><br><span class="line">        print_info(<span class="string">"\n4. 测试更新水果"</span>)</span><br><span class="line">        update_fruit = {</span><br><span class="line">            <span class="string">"id"</span>: new_id,  <span class="comment"># 使用刚插入的ID</span></span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"有机蓝莓"</span>,</span><br><span class="line">            <span class="string">"category_id"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">"price"</span>: <span class="number">28.5</span>,</span><br><span class="line">            <span class="string">"description"</span>: <span class="string">"有机认证蓝莓，无农药"</span></span><br><span class="line">        }</span><br><span class="line">        affected_rows = repo.update(**update_fruit)</span><br><span class="line">        print_success(<span class="string">f"更新了 <span class="subst">{affected_rows}</span> 行记录"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 验证更新结果</span></span><br><span class="line">        updated_fruit = repo.get_one(<span class="built_in">id</span>=new_id)</span><br><span class="line">        <span class="keyword">if</span> updated_fruit:</span><br><span class="line">            print_success(<span class="string">f"更新后的水果: <span class="subst">{updated_fruit[<span class="string">'name'</span>]}</span>, 价格: <span class="subst">{updated_fruit[<span class="string">'price'</span>]}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试删除操作</span></span><br><span class="line">        print_info(<span class="string">"\n5. 测试删除水果"</span>)</span><br><span class="line">        deleted_rows = repo.delete(<span class="built_in">id</span>=new_id)</span><br><span class="line">        print_success(<span class="string">f"删除了 <span class="subst">{deleted_rows}</span> 行记录"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print_error(<span class="string">f"操作失败: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 关闭连接</span></span><br><span class="line">        repo.close()</span><br><span class="line">        print_info(<span class="string">"\n测试完成，已关闭数据库连接"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure><p>​</p></li><li><p><strong>方法二: 使用 XML Mapper 文件</strong><br>对于包含动态逻辑或较为复杂的 SQL 语句，XML Mapper 文件提供了更强大的表达能力。</p></li><li><p><strong>1. XML Mapper 文件 (<code>ddb_framework_practice/examples/mybatis_py_v2/mappers/fruits_mapper.xml</code>)</strong></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"fruits"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        定义一个插入新水果记录的 SQL 映射语句。</span></span><br><span class="line"><span class="comment">        id="insertNewFruit"：这是对应 Python 接口中方法的名称（如 FruitMapper.insertNewFruit）。</span></span><br><span class="line"><span class="comment">        useGeneratedKeys="true"：表示使用数据库自动生成的主键（例如 MySQL 的 AUTO_INCREMENT）。</span></span><br><span class="line"><span class="comment">        keyProperty="generated_id_xml"：表示将生成的主键值赋给 Python 实体类中的属性 `generated_id_xml`。</span></span><br><span class="line"><span class="comment">        keyColumn="id"：表示数据库中自动生成的主键列名是 `id`。</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertFruit"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"generated_id_xml"</span> <span class="attr">keyColumn</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        INSERT INTO fruits (name, category_id, price, description)</span><br><span class="line">        VALUES (</span><br><span class="line">        #{name},</span><br><span class="line">        #{category_id},</span><br><span class="line">        #{price},</span><br><span class="line">        #{description}</span><br><span class="line">        )</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteFruitById"</span>&gt;</span></span><br><span class="line">        DELETE FROM fruits WHERE id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateFruit"</span>&gt;</span></span><br><span class="line">        UPDATE fruits</span><br><span class="line">        SET</span><br><span class="line">        name = #{name},</span><br><span class="line">        category_id = #{category_id},</span><br><span class="line">        price = #{price},</span><br><span class="line">        description = #{description}</span><br><span class="line">        WHERE id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findFruitDetailsById"</span> <span class="attr">resultType</span>=<span class="string">"dict"</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">        f.id,</span><br><span class="line">        f.name,</span><br><span class="line">        f.category_id,</span><br><span class="line">        fc.name as category_name,</span><br><span class="line">        f.price,</span><br><span class="line">        f.description</span><br><span class="line">        FROM fruits as f</span><br><span class="line">        LEFT JOIN FRUIT_CATEGORIES FC ON</span><br><span class="line">        f.category_id = fc.id</span><br><span class="line">        WHERE f.id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findFruitsByCriteria"</span> <span class="attr">resultType</span>=<span class="string">"dict"</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">        f.id,</span><br><span class="line">        f.name,</span><br><span class="line">        f.category_id,</span><br><span class="line">        fc.name as category_name,</span><br><span class="line">        f.price,</span><br><span class="line">        f.description</span><br><span class="line">        FROM fruits as f</span><br><span class="line">        LEFT JOIN fruit_categories FC ON</span><br><span class="line">        f.category_id = fc.id</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"'name' in params"</span>&gt;</span></span><br><span class="line">                f.name LIKE CONCAT('%', #{name}, '%')</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>2. Python 代码 (<code>db_framework_practice/examples/mybatis_py_v2/ex02_xml_mapper_usage.py</code>)</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># db_framework_practice/examples/mybatis_py_v2/ex02_xml_mapper_usage.py</span></span><br><span class="line"><span class="keyword">from</span> mybatis <span class="keyword">import</span> Mybatis, ConnectionFactory</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Optional</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">from</span> utils.print_utils <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> DB_CONFIG</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FruitRepoXmlOperational</span>:</span><br><span class="line">    <span class="string">"""使用 XML Mapper 操作水果数据的数据仓库类"""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, mappers_dir=<span class="string">"mappers"</span>, cache_size=<span class="number">0</span></span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        初始化水果仓库</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            mappers_dir: XML映射文件目录</span></span><br><span class="line"><span class="string">            cache_size: 缓存大小，默认50MB</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="variable language_">self</span>.connection_factory = ConnectionFactory.get_connection(**DB_CONFIG)</span><br><span class="line">        <span class="variable language_">self</span>.mybatis = Mybatis(<span class="variable language_">self</span>.connection_factory, mappers_dir, cache_memory_limit=cache_size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert_fruit</span>(<span class="params">self, fruit: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">"""插入水果数据(使用xml mapper)"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.mybatis.insert(<span class="string">"fruits.insertFruit"</span>, fruit)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_fruit</span>(<span class="params">self, fruit_id: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">"""删除水果数据(使用xml mapper)"""</span></span><br><span class="line">        <span class="comment"># 将单个ID参数转换为字典格式，以符合mybatis.delete的参数要求</span></span><br><span class="line">        delete_params = {<span class="string">"id"</span>: fruit_id}</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.mybatis.delete(<span class="string">"fruits.deleteFruitById"</span>, delete_params)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_fruit</span>(<span class="params">self, fruit: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">"""更新水果数据(使用xml mapper)"""</span></span><br><span class="line">        result = <span class="variable language_">self</span>.mybatis.update(<span class="string">"fruits.updateFruit"</span>, fruit)</span><br><span class="line">        <span class="keyword">if</span> result &gt; <span class="number">0</span>:</span><br><span class="line">            print_success(<span class="string">f"更新水果数据成功,影响行数: <span class="subst">{result}</span>"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print_error(<span class="string">f"更新水果数据失败,影响行数: <span class="subst">{result}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_fruit_details_by_id</span>(<span class="params">self, fruit_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">"""根据ID查询水果详细信息(使用xml mapper)"""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.mybatis.select_one(<span class="string">"fruits.findFruitDetailsById"</span>, {<span class="string">"id"</span>: fruit_id})</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_fruits_by_criteria</span>(<span class="params">self, params: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">"""根据条件查询水果列表(使用xml mapper)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            params: 查询参数字典，可包含以下键:</span></span><br><span class="line"><span class="string">                - category_id: 分类ID</span></span><br><span class="line"><span class="string">                - min_price: 最低价格</span></span><br><span class="line"><span class="string">                - max_price: 最高价格</span></span><br><span class="line"><span class="string">                - name: 水果名称(支持模糊查询)</span></span><br><span class="line"><span class="string">                - sort_by: 排序字段，如'price'</span></span><br><span class="line"><span class="string">                - sort_order: 排序方向，如'DESC'</span></span><br><span class="line"><span class="string">                - limit: 返回记录数量限制</span></span><br><span class="line"><span class="string">                - offset: 分页偏移量</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            符合条件的水果列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 直接将params传递给mybatis，不再额外包装</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.mybatis.select_many(<span class="string">"fruits.findFruitsByCriteria"</span>, params)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    repo = FruitRepoXmlOperational()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试查询水果列表</span></span><br><span class="line">    print_header(<span class="string">"测试查询水果列表"</span>)</span><br><span class="line">    params = {</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"苹"</span>,</span><br><span class="line">    }</span><br><span class="line">    fruits = repo.find_fruits_by_criteria(params)</span><br><span class="line">    <span class="keyword">for</span> fruit <span class="keyword">in</span> fruits:</span><br><span class="line">        print_info(<span class="string">f"水果ID: <span class="subst">{fruit[<span class="string">'id'</span>]}</span>, 名称: <span class="subst">{fruit[<span class="string">'name'</span>]}</span>, 价格: <span class="subst">{fruit[<span class="string">'price'</span>]}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></li></ul><h5 id="16-4-2-实战-Flask-Integration"><a href="#16-4-2-实战-Flask-Integration" class="headerlink" title="16.4.2 实战 (Flask Integration)"></a>16.4.2 实战 (Flask Integration)</h5><p>将 <code>mybatis-py</code> 集成到 Flask Web 应用中，提供 API 接口。</p><ul><li><p><strong>项目结构</strong>:</p><ul><li>Flask 应用: <code>db_framework_practice/examples/mybatis_py_v_final/ex03_flask_integration.py</code></li><li>XML Mapper: <code>db_framework_practice/examples/mybatis_py_v_final/mappers/flask_fruits_ops.xml</code> (可复用或创建新的)</li><li>配置文件: <code>db_framework_practice/examples/mybatis_py_v_final/config.py</code></li><li>打印工具: <code>db_framework_practice/utils/print_utils.py</code></li></ul></li><li><p><strong>XML Mapper (<code>db_framework_practice/examples/mybatis_py_v_final/mappers/flask_fruits_ops.xml</code>)</strong>:</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"flask_api_fruits"</span>&gt;</span> <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getAllFruitsForApi"</span> <span class="attr">resultType</span>=<span class="string">"dict"</span>&gt;</span></span><br><span class="line">        SELECT f.id, f.name, fc.name AS category_name, f.price, f.description</span><br><span class="line">        FROM fruits f</span><br><span class="line">        LEFT JOIN fruit_categories fc ON f.category_id = fc.id</span><br><span class="line">        ORDER BY f.name</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getFruitByIdForApi"</span> <span class="attr">resultType</span>=<span class="string">"dict"</span>&gt;</span></span><br><span class="line">        SELECT f.id, f.name, fc.name AS category_name, f.price, f.description</span><br><span class="line">        FROM fruits f</span><br><span class="line">        LEFT JOIN fruit_categories fc ON f.category_id = fc.id</span><br><span class="line">        WHERE f.id = #{fruit_id_param}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"addNewFruitForApi"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"new_fruit_id"</span> <span class="attr">keyColumn</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        INSERT INTO fruits (name, category_id, price, description)</span><br><span class="line">        VALUES (#{name}, #{category_id}, #{price}, #{description})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateFruitForApi"</span>&gt;</span></span><br><span class="line">        UPDATE fruits</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"'name' in params and params.name != null"</span>&gt;</span>name = #{name},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"'category_id' in params and params.category_id != null"</span>&gt;</span>category_id = #{category_id},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"'price' in params and params.price != null"</span>&gt;</span>price = #{price},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"'description' in params"</span>&gt;</span>description = #{description},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        WHERE id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteFruitForApi"</span>&gt;</span></span><br><span class="line">        DELETE FROM fruits WHERE id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></li><li><p><strong>Flask 应用代码 (<code>db_framework_practice/examples/mybatis_py_v_final/ex03_flask_integration.py</code>)</strong>:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># db_framework_practice/examples/mybatis_py_v_final/ex03_flask_integration.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify, request</span><br><span class="line"><span class="keyword">import</span> pymysql <span class="comment"># 用于捕获 pymysql.Error</span></span><br><span class="line"><span class="keyword">import</span> mybatis.errors <span class="comment"># mybatis-py 错误类</span></span><br><span class="line"><span class="keyword">from</span> mybatis <span class="keyword">import</span> Mybatis, ConnectionFactory, DictCursor <span class="comment"># 导入 DictCursor</span></span><br><span class="line"><span class="comment"># import orjson # 可选的高性能 JSON</span></span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Callable</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 动态路径设置，确保能导入同级和父级模块 ---</span></span><br><span class="line">current_file_dir_flask = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">project_root_flask_app = os.path.abspath(os.path.join(current_file_dir_flask, <span class="string">'../../../'</span>))</span><br><span class="line"><span class="keyword">if</span> project_root_flask_app <span class="keyword">not</span> <span class="keyword">in</span> sys.path:</span><br><span class="line">    sys.path.append(project_root_flask_app)</span><br><span class="line"></span><br><span class="line">examples_root_flask_app = os.path.abspath(os.path.join(current_file_dir_flask, <span class="string">'../'</span>)) <span class="comment"># mybatis_py_v_final 的父目录</span></span><br><span class="line"><span class="keyword">if</span> examples_root_flask_app <span class="keyword">not</span> <span class="keyword">in</span> sys.path: <span class="comment"># 允许从 mybatis_py_v_final 导入 config</span></span><br><span class="line">     sys.path.insert(<span class="number">0</span>, examples_root_flask_app) <span class="comment"># 插入到最前面，优先查找</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.print_utils <span class="keyword">import</span> print_header, print_info, print_success, print_error</span><br><span class="line"><span class="keyword">from</span> mybatis_py_v_final.config <span class="keyword">import</span> DB_CONNECTION_PARAMS_V3, MYBATIS_INSTANCE_CONFIG</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">print_header(<span class="string">"Mybatis-Py Flask 集成示例 (V_FINAL - 完整版)"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 数据库和 Mybatis 实例管理 (简化版，生产环境需更健壮) ---</span></span><br><span class="line"><span class="comment"># 全局变量在多线程/多进程环境中存在风险，Flask 有更好的上下文管理机制 (如 g 对象)</span></span><br><span class="line">_MB_INSTANCE_FLASK_APP: <span class="type">Optional</span>[Mybatis] = <span class="literal">None</span></span><br><span class="line">_DB_CONN_ERR_FLASK_APP: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line">_DB_ERR_MSG_FLASK_APP: <span class="built_in">str</span> = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_mybatis_for_request</span>() -&gt; <span class="type">Optional</span>[Mybatis]:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取或初始化用于当前请求的 Mybatis 实例。</span></span><br><span class="line"><span class="string">    警告: 此简单实现仍使用全局变量，未完全适配 Flask 请求生命周期。</span></span><br><span class="line"><span class="string">    在真实应用中，推荐使用 Flask 的 g 对象或 before_request/teardown_request。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">global</span> _MB_INSTANCE_FLASK_APP, _DB_CONN_ERR_FLASK_APP, _DB_ERR_MSG_FLASK_APP</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查现有连接是否有效</span></span><br><span class="line">    <span class="keyword">if</span> _MB_INSTANCE_FLASK_APP <span class="keyword">and</span> _MB_INSTANCE_FLASK_APP.conn:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            _MB_INSTANCE_FLASK_APP.conn.ping(reconnect=<span class="literal">True</span>) <span class="comment"># 尝试 ping，如果断开则重连</span></span><br><span class="line">            _MB_INSTANCE_FLASK_APP.conn.set_autocommit(<span class="literal">False</span>) <span class="comment"># 确保 autocommit 状态</span></span><br><span class="line">            _DB_CONN_ERR_FLASK_APP = <span class="literal">False</span> <span class="comment"># 如果 ping 成功，清除错误标记</span></span><br><span class="line">            <span class="comment"># print_info("[FLASK_APP] Existing Mybatis connection is active.")</span></span><br><span class="line">            <span class="keyword">return</span> _MB_INSTANCE_FLASK_APP</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> ping_err:</span><br><span class="line">            print_warning(<span class="string">f"[FLASK_APP] Ping failed for existing connection: <span class="subst">{ping_err}</span>. Attempting new connection."</span>)</span><br><span class="line">            _DB_CONN_ERR_FLASK_APP = <span class="literal">True</span> <span class="comment"># 标记错误</span></span><br><span class="line">            _DB_ERR_MSG_FLASK_APP = <span class="built_in">str</span>(ping_err)</span><br><span class="line">            <span class="keyword">try</span>: _MB_INSTANCE_FLASK_APP.conn.close() <span class="comment"># 关闭无效连接</span></span><br><span class="line">            <span class="keyword">except</span>: <span class="keyword">pass</span></span><br><span class="line">            _MB_INSTANCE_FLASK_APP = <span class="literal">None</span> <span class="comment"># 清除旧实例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果实例不存在，或连接出错/丢失，则创建新实例</span></span><br><span class="line">    <span class="keyword">if</span> _MB_INSTANCE_FLASK_APP <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> _DB_CONN_ERR_FLASK_APP:</span><br><span class="line">        print_info(<span class="string">"[FLASK_APP] Creating new Mybatis instance for Flask request..."</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            db_params_with_cursor = {**DB_CONNECTION_PARAMS_V3, <span class="string">'cursorclass'</span>: DictCursor}</span><br><span class="line">            conn_req = ConnectionFactory.get_connection(**db_params_with_cursor)</span><br><span class="line">            conn_req.set_autocommit(<span class="literal">False</span>) <span class="comment"># 非常重要：手动控制事务</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># XML Mappers 目录路径 (相对于此 ex03_flask_integration.py 文件)</span></span><br><span class="line">            mapper_dir_for_flask = os.path.join(os.path.dirname(__file__), <span class="string">"mappers"</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(mapper_dir_for_flask):</span><br><span class="line">                 os.makedirs(mapper_dir_for_flask, exist_ok=<span class="literal">True</span>)</span><br><span class="line">                 print_warning(<span class="string">f"Mappers directory '<span class="subst">{mapper_dir_for_flask}</span>' for Flask was created."</span>)</span><br><span class="line">            </span><br><span class="line">            _MB_INSTANCE_FLASK_APP = Mybatis(conn_req, mapper_dir_for_flask, **MYBATIS_INSTANCE_CONFIG)</span><br><span class="line">            _DB_CONN_ERR_FLASK_APP = <span class="literal">False</span></span><br><span class="line">            _DB_ERR_MSG_FLASK_APP = <span class="string">""</span></span><br><span class="line">            print_success(<span class="string">"[FLASK_APP] New Mybatis instance created successfully for Flask."</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            _DB_CONN_ERR_FLASK_APP = <span class="literal">True</span></span><br><span class="line">            _DB_ERR_MSG_FLASK_APP = <span class="built_in">str</span>(e)</span><br><span class="line">            _MB_INSTANCE_FLASK_APP = <span class="literal">None</span></span><br><span class="line">            print_error(<span class="string">f"[FLASK_APP] Failed to create Mybatis instance for Flask: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> _MB_INSTANCE_FLASK_APP</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 数据库操作装饰器 ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">db_request_handler</span>(<span class="params">commit_on_success: <span class="built_in">bool</span> = <span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Flask 请求装饰器: 统一处理 Mybatis 实例获取、事务和错误。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">view_function: <span class="type">Callable</span>[..., <span class="type">Any</span>]</span>):</span><br><span class="line"><span class="meta">        @functools.wraps(<span class="params">view_function</span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args: <span class="type">Any</span>, **kwargs: <span class="type">Any</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">            mb_instance = get_mybatis_for_request()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> mb_instance:</span><br><span class="line">                <span class="keyword">return</span> jsonify(error=<span class="string">"Database service temporarily unavailable."</span>, details=_DB_ERR_MSG_FLASK_APP), <span class="number">503</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                response = view_function(mb_instance, *args, **kwargs) <span class="comment"># 注入 Mybatis 实例</span></span><br><span class="line">                <span class="keyword">if</span> commit_on_success:</span><br><span class="line">                    mb_instance.conn.commit()</span><br><span class="line">                    print_success(<span class="string">f"[FLASK_APP] Transaction committed for: <span class="subst">{request.path}</span> <span class="subst">{request.method}</span>"</span>)</span><br><span class="line">                <span class="keyword">return</span> response</span><br><span class="line">            <span class="keyword">except</span> mybatis.errors.MybatisError <span class="keyword">as</span> me:</span><br><span class="line">                <span class="keyword">if</span> mb_instance.conn: mb_instance.conn.rollback()</span><br><span class="line">                print_error(<span class="string">f"[FLASK_APP] MybatisError at <span class="subst">{request.path}</span>: <span class="subst">{me}</span>"</span>)</span><br><span class="line">                <span class="keyword">return</span> jsonify(error=<span class="string">"A database operation error occurred."</span>, details=<span class="built_in">str</span>(me)), <span class="number">500</span></span><br><span class="line">            <span class="keyword">except</span> pymysql.Error <span class="keyword">as</span> pe: <span class="comment"># 更具体的数据库驱动错误</span></span><br><span class="line">                <span class="keyword">if</span> mb_instance.conn: mb_instance.conn.rollback()</span><br><span class="line">                <span class="keyword">global</span> _DB_CONN_ERR_FLASK_APP, _DB_ERR_MSG_FLASK_APP</span><br><span class="line">                _DB_CONN_ERR_FLASK_APP = <span class="literal">True</span></span><br><span class="line">                _DB_ERR_MSG_FLASK_APP = <span class="built_in">str</span>(pe)</span><br><span class="line">                print_error(<span class="string">f"[FLASK_APP] PyMySQLError at <span class="subst">{request.path}</span>: <span class="subst">{pe}</span>"</span>)</span><br><span class="line">                <span class="keyword">return</span> jsonify(error=<span class="string">"A database communication error occurred."</span>, details=<span class="built_in">str</span>(pe)), <span class="number">502</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e_global:</span><br><span class="line">                <span class="keyword">if</span> mb_instance.conn: mb_instance.conn.rollback()</span><br><span class="line">                print_error(<span class="string">f"[FLASK_APP] Unexpected error at <span class="subst">{request.path}</span>: <span class="subst">{e_global}</span>"</span>)</span><br><span class="line">                <span class="keyword">import</span> traceback</span><br><span class="line">                traceback.print_exc() <span class="comment"># 打印完整堆栈到服务器日志</span></span><br><span class="line">                <span class="keyword">return</span> jsonify(error=<span class="string">"An unexpected internal server error occurred."</span>), <span class="number">500</span></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Flask 路由定义 ---</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/api/v3/fruits'</span>, methods=[<span class="string">'GET'</span>]</span>)</span></span><br><span class="line"><span class="meta">@db_request_handler() </span><span class="comment"># 默认 commit_on_success=False</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">api_get_all_fruits_v3</span>(<span class="params">mb: Mybatis</span>):</span><br><span class="line">    <span class="string">"""API 端点: 获取所有水果"""</span></span><br><span class="line">    print_info(<span class="string">f"[FLASK_APP] Handling GET /api/v3/fruits"</span>)</span><br><span class="line">    <span class="comment"># 假设 XML `flask_api_fruits.getAllFruitsForApi` 已定义</span></span><br><span class="line">    fruits = mb.select_many(<span class="string">"flask_api_fruits.getAllFruitsForApi"</span>)</span><br><span class="line">    print_success(<span class="string">f"[FLASK_APP] Found <span class="subst">{<span class="built_in">len</span>(fruits)}</span> fruits."</span>)</span><br><span class="line">    <span class="keyword">return</span> jsonify(fruits <span class="keyword">if</span> fruits <span class="keyword">else</span> []) <span class="comment"># 确保空列表也是有效 JSON</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/api/v3/fruits/&lt;int:fruit_id&gt;'</span>, methods=[<span class="string">'GET'</span>]</span>)</span></span><br><span class="line"><span class="meta">@db_request_handler()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">api_get_fruit_by_id_v3</span>(<span class="params">mb: Mybatis, fruit_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">"""API 端点: 根据 ID 获取单个水果"""</span></span><br><span class="line">    print_info(<span class="string">f"[FLASK_APP] Handling GET /api/v3/fruits/<span class="subst">{fruit_id}</span>"</span>)</span><br><span class="line">    fruit = mb.select_one(<span class="string">"flask_api_fruits.getFruitByIdForApi"</span>, {<span class="string">'fruit_id_param'</span>: fruit_id})</span><br><span class="line">    <span class="keyword">if</span> fruit:</span><br><span class="line">        print_success(<span class="string">f"[FLASK_APP] Found fruit: <span class="subst">{fruit.get(<span class="string">'name'</span>)}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(fruit)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print_warning(<span class="string">f"[FLASK_APP] Fruit ID <span class="subst">{fruit_id}</span> not found."</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(error=<span class="string">f"Fruit with ID <span class="subst">{fruit_id}</span> not found."</span>), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/api/v3/fruits'</span>, methods=[<span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="meta">@db_request_handler(<span class="params">commit_on_success=<span class="literal">True</span></span>) </span><span class="comment"># 写操作，成功后提交</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">api_add_fruit_v3</span>(<span class="params">mb: Mybatis</span>):</span><br><span class="line">    <span class="string">"""API 端点: 添加新水果"""</span></span><br><span class="line">    print_info(<span class="string">f"[FLASK_APP] Handling POST /api/v3/fruits"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> request.is_json:</span><br><span class="line">        <span class="keyword">return</span> jsonify(error=<span class="string">"Request body must be JSON."</span>), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    data = request.get_json()</span><br><span class="line">    required_fields = [<span class="string">'name'</span>, <span class="string">'price'</span>, <span class="string">'category_id'</span>] <span class="comment"># 假设这些是必需的</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>(field <span class="keyword">in</span> data <span class="keyword">for</span> field <span class="keyword">in</span> required_fields):</span><br><span class="line">        <span class="keyword">return</span> jsonify(error=<span class="string">f"Missing required fields in JSON: <span class="subst">{<span class="string">', '</span>.join(required_fields)}</span>."</span>), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    params = {</span><br><span class="line">        <span class="string">"name"</span>: data.get(<span class="string">"name"</span>),</span><br><span class="line">        <span class="string">"category_id"</span>: data.get(<span class="string">"category_id"</span>),</span><br><span class="line">        <span class="string">"price"</span>: data.get(<span class="string">"price"</span>),</span><br><span class="line">        <span class="string">"description"</span>: data.get(<span class="string">"description"</span>) <span class="comment"># 可选</span></span><br><span class="line">    }</span><br><span class="line">    mb.insert(<span class="string">'flask_api_fruits.addNewFruitForApi'</span>, params)</span><br><span class="line">    new_id = params.get(<span class="string">'new_fruit_id'</span>) <span class="comment"># 尝试获取由 keyProperty 设置的 ID</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> new_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        print_success(<span class="string">f"[FLASK_APP] Fruit '<span class="subst">{params[<span class="string">'name'</span>]}</span>' added, new ID: <span class="subst">{new_id}</span>."</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(message=<span class="string">"Fruit added successfully."</span>, <span class="built_in">id</span>=new_id), <span class="number">201</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 对于 MySQL, 如果 keyProperty 行为不符合预期, lastrowid 可能在 cursor 上</span></span><br><span class="line">        <span class="comment"># 但 Mybatis 封装了 cursor, 这里简化处理</span></span><br><span class="line">        print_warning(<span class="string">"[FLASK_APP] Fruit added, but ID not retrieved via keyProperty in params."</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(message=<span class="string">"Fruit added (ID retrieval might vary)."</span>), <span class="number">201</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/api/v3/fruits/&lt;int:fruit_id&gt;'</span>, methods=[<span class="string">'PUT'</span>]</span>)</span></span><br><span class="line"><span class="meta">@db_request_handler(<span class="params">commit_on_success=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">api_update_fruit_v3</span>(<span class="params">mb: Mybatis, fruit_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">"""API 端点: 更新指定 ID 的水果信息"""</span></span><br><span class="line">    print_info(<span class="string">f"[FLASK_APP] Handling PUT /api/v3/fruits/<span class="subst">{fruit_id}</span>"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> request.is_json:</span><br><span class="line">        <span class="keyword">return</span> jsonify(error=<span class="string">"Request body must be JSON."</span>), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    data = request.get_json()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data: <span class="comment"># 确保至少有一些数据用于更新</span></span><br><span class="line">        <span class="keyword">return</span> jsonify(error=<span class="string">"No data provided for update."</span>), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    params = {</span><br><span class="line">        <span class="string">"id"</span>: fruit_id, <span class="comment"># 对应 XML 中的 WHERE id = #{id}</span></span><br><span class="line">        <span class="string">"name"</span>: data.get(<span class="string">"name"</span>), <span class="comment"># 对应 XML 中的 name = #{name}</span></span><br><span class="line">        <span class="string">"category_id"</span>: data.get(<span class="string">"category_id"</span>),</span><br><span class="line">        <span class="string">"price"</span>: data.get(<span class="string">"price"</span>),</span><br><span class="line">        <span class="string">"description"</span>: data.get(<span class="string">"description"</span>)</span><br><span class="line">    }</span><br><span class="line">    <span class="comment"># 清理掉值为 None 的参数，以便 XML 中的 &lt;if test&gt; 能正确工作</span></span><br><span class="line">    update_params_clean = {k: v <span class="keyword">for</span> k, v <span class="keyword">in</span> params.items() <span class="keyword">if</span> v <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>}</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(update_params_clean) &lt;= <span class="number">1</span> <span class="keyword">and</span> <span class="string">"id"</span> <span class="keyword">in</span> update_params_clean: <span class="comment"># 至少要更新一个字段</span></span><br><span class="line">         <span class="keyword">return</span> jsonify(error=<span class="string">"No fields to update provided besides ID."</span>), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    affected_rows = mb.update(<span class="string">"flask_api_fruits.updateFruitForApi"</span>, update_params_clean)</span><br><span class="line">    <span class="keyword">if</span> affected_rows &gt; <span class="number">0</span>:</span><br><span class="line">        print_success(<span class="string">f"[FLASK_APP] Fruit ID <span class="subst">{fruit_id}</span> updated, <span class="subst">{affected_rows}</span> row(s) affected."</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(message=<span class="string">f"Fruit ID <span class="subst">{fruit_id}</span> updated successfully."</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print_warning(<span class="string">f"[FLASK_APP] Fruit ID <span class="subst">{fruit_id}</span> not found or no changes made during update."</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(error=<span class="string">f"Fruit ID <span class="subst">{fruit_id}</span> not found or no changes applied."</span>), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/api/v3/fruits/&lt;int:fruit_id&gt;'</span>, methods=[<span class="string">'DELETE'</span>]</span>)</span></span><br><span class="line"><span class="meta">@db_request_handler(<span class="params">commit_on_success=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">api_delete_fruit_v3</span>(<span class="params">mb: Mybatis, fruit_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">"""API 端点: 删除指定 ID 的水果"""</span></span><br><span class="line">    print_info(<span class="string">f"[FLASK_APP] Handling DELETE /api/v3/fruits/<span class="subst">{fruit_id}</span>"</span>)</span><br><span class="line">    affected_rows = mb.delete(<span class="string">"flask_api_fruits.deleteFruitForApi"</span>, {<span class="string">'id'</span>: fruit_id})</span><br><span class="line">    <span class="keyword">if</span> affected_rows &gt; <span class="number">0</span>:</span><br><span class="line">        print_success(<span class="string">f"[FLASK_APP] Fruit ID <span class="subst">{fruit_id}</span> deleted, <span class="subst">{affected_rows}</span> row(s) affected."</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(message=<span class="string">f"Fruit ID <span class="subst">{fruit_id}</span> deleted successfully."</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print_warning(<span class="string">f"[FLASK_APP] Fruit ID <span class="subst">{fruit_id}</span> not found for deletion."</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(error=<span class="string">f"Fruit ID <span class="subst">{fruit_id}</span> not found."</span>), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Flask 应用关闭时的清理 ---</span></span><br><span class="line"><span class="meta">@app.teardown_appcontext</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shutdown_flask_db_conn_final</span>(<span class="params">exception=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">"""在应用上下文销毁时关闭数据库连接"""</span></span><br><span class="line">    <span class="keyword">global</span> _MB_INSTANCE_FLASK_APP</span><br><span class="line">    <span class="keyword">if</span> _MB_INSTANCE_FLASK_APP <span class="keyword">and</span> _MB_INSTANCE_FLASK_APP.conn:</span><br><span class="line">        print_info(<span class="string">"[FLASK_APP] App context tearing down. Closing DB connection for Flask app."</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            _MB_INSTANCE_FLASK_APP.conn.close()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e_close_final:</span><br><span class="line">            print_error(<span class="string">f"[FLASK_APP] Error closing DB connection: <span class="subst">{e_close_final}</span>"</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            _MB_INSTANCE_FLASK_APP.conn = <span class="literal">None</span> <span class="comment"># 确保标记为已关闭</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print_info(<span class="string">"启动 Flask 开发服务器 (Mybatis-Py V_FINAL 示例)..."</span>)</span><br><span class="line">    <span class="comment"># 确保 mappers 目录存在于 ex03_flask_integration.py 文件的同级，</span></span><br><span class="line">    <span class="comment"># 并且其中包含 flask_fruits_ops.xml 文件。</span></span><br><span class="line">    app.run(debug=<span class="literal">True</span>, host=<span class="string">'0.0.0.0'</span>, port=<span class="number">5005</span>) <span class="comment"># 使用新端口避免冲突</span></span><br></pre></td></tr></tbody></table></figure><ul><li><strong>重点提示</strong>:<ul><li><strong><code>get_mybatis_for_request()</code></strong>: 此函数尝试管理 <code>Mybatis</code> 实例。在生产级 Flask 应用中，<strong>强烈建议</strong>使用 Flask 的 <code>g</code> 对象结合 <code>before_request</code> 和 <code>teardown_request</code> (或 <code>teardown_appcontext</code>) 来管理每个请求的数据库连接和 Mybatis 实例，以避免全局状态和并发问题。</li><li><strong><code>@db_request_handler</code></strong>: 此装饰器封装了获取 <code>Mybatis</code> 实例、执行视图函数、事务提交/回滚以及统一的错误处理逻辑。这是一种简化视图函数代码的常用模式。</li><li><strong>事务管理</strong>: 写操作（POST, PUT, DELETE）通过 <code>commit_on_success=True</code> 在视图函数成功执行后提交事务。读操作（GET）则不需要。</li><li><strong>XML Mapper 路径</strong>: <code>Mybatis</code> 构造函数中的 <code>mapper_dir_path</code> 需要正确指向包含 <code>flask_fruits_ops.xml</code> 的目录。示例中假设它在当前 Flask 应用文件同级的 <code>mappers</code> 目录下。</li><li><strong>错误响应</strong>: API 端点在发生错误时返回适当的 HTTP 状态码和 JSON 错误信息。</li></ul></li></ul></li></ul><hr><h2 id="第十七章-音视频处理"><a href="#第十七章-音视频处理" class="headerlink" title="第十七章 音视频处理"></a>第十七章 音视频处理</h2><p>本章节我们将学习如何使用 Python 来调用强大的 <strong>FFmpeg</strong> 工具包，以处理常见的音视频文件操作。FFmpeg 功能极其丰富，虽然它本身是 C 语言开发的，但通过 Python 调用其命令行工具是实现自动化处理、集成到 Web 后端或脚本中的常用且高效的方法。我们的重点是学习如何“处理”音视频，而不是从零“实现”编解码器。我们将主要使用 <strong><code>ffmpeg-python</code></strong> 这个库来简化调用过程，让代码更符合 Python 的风格。</p><hr><h3 id="17-1-FFmpeg-介绍、核心概念、安装与-Python-交互方式"><a href="#17-1-FFmpeg-介绍、核心概念、安装与-Python-交互方式" class="headerlink" title="17.1 FFmpeg 介绍、核心概念、安装与 Python 交互方式"></a>17.1 FFmpeg 介绍、核心概念、安装与 Python 交互方式</h3><p><strong>目标:</strong></p><ul><li>深入理解 FFmpeg 是什么，它的重要性以及核心组成。</li><li>掌握音视频处理中的基本术语（容器、流、编解码器等）。</li><li>在你的操作系统上<strong>成功安装</strong> FFmpeg 命令行工具并配置好环境变量。</li><li>了解 Python 与 FFmpeg 交互的几种方式，并安装好我们将主要使用的 <code>ffmpeg-python</code> 库。</li></ul><h4 id="17-1-1-FFmpeg：音视频领域的“瑞士军刀”"><a href="#17-1-1-FFmpeg：音视频领域的“瑞士军刀”" class="headerlink" title="17.1.1 FFmpeg：音视频领域的“瑞士军刀”"></a>17.1.1 FFmpeg：音视频领域的“瑞士军刀”</h4><p><strong>什么是 FFmpeg？</strong></p><p>FFmpeg 不仅仅是一个简单的程序，它是一个<strong>完整的、跨平台的、开源的音视频处理解决方案</strong>。如果你需要对音频或视频文件进行几乎任何你能想到的操作——包括但不限于：录制、转换格式（转码）、编辑（裁剪、合并、旋转）、提取信息、添加滤镜/特效（水印、调色、降噪）、压缩、以及进行网络流传输（推流/拉流）——FFmpeg 都是这个领域内最强大、最通用、使用最广泛的工具集。从大型视频网站的后台转码系统，到你电脑上的视频播放器、剪辑软件，再到各种流媒体服务，背后都极有可能有 FFmpeg 的身影。</p><p><strong>FFmpeg 的重要性：</strong></p><ul><li><strong>功能全面:</strong> 支持海量的音视频格式（容器）和编解码器（算法），无论是常见的 MP4/H.264/AAC，还是较新的 AV1/Opus，甚至很多生僻格式，FFmpeg 大多都能处理。</li><li><strong>跨平台:</strong> 无缝运行在 Windows、macOS、Linux 等主流操作系统上。</li><li><strong>开源免费:</strong> 遵循 LGPL 或 GPL 等开源协议（取决于编译选项），可以自由使用、修改和分发。</li><li><strong>性能优异:</strong> 核心代码使用 C 语言编写，并针对性能进行了深度优化，利用了多核 CPU 和 SIMD 指令集等技术，处理效率高。</li><li><strong>命令行驱动:</strong> 提供了极其灵活和强大的命令行接口，可以通过参数组合实现复杂的操作流程，非常适合编写脚本进行自动化处理或在服务器后端调用。</li></ul><p><strong>FFmpeg 的核心组成:</strong></p><p>FFmpeg是一整个“庞大”的项目，他其中含有大量的工具，虽然我们最常用的是 <code>ffmpeg</code> 这个命令，但了解其主要组成部分有助于理解它的工作方式：</p><h6 id="ffmpeg-命令行工具"><a href="#ffmpeg-命令行工具" class="headerlink" title="ffmpeg (命令行工具)"></a><code>ffmpeg</code> (命令行工具)</h6><p>这是最核心、最常用的工具。它负责读取输入文件/流，根据用户指定的参数进行解码、滤镜处理、编码、封装等一系列操作，最终输出结果文件/流。我们后续的大部分操作都是通过构建不同的 <code>ffmpeg</code> 命令来实现的。</p><h6 id="ffprobe-命令行工具"><a href="#ffprobe-命令行工具" class="headerlink" title="ffprobe (命令行工具)"></a><code>ffprobe</code> (命令行工具)</h6><p>这是一个多媒体流分析工具。它可以读取音视频文件或流，提取并显示其中非常详细的元数据和技术信息，例如：</p><ul><li>文件格式（容器类型）。</li><li>包含的数据流（视频、音频、字幕等）。</li><li>每个流的编解码器、比特率、时长、帧率（视频）、分辨率（视频）、采样率（音频）、声道数（音频）等。</li><li>文件的元数据标签（标题、作者、专辑等）。<br>在进行任何处理之前，使用 <code>ffprobe</code> 了解输入文件的属性往往是必要的第一步，这对于编写健壮的处理脚本至关重要。</li></ul><h6 id="ffplay-命令行工具"><a href="#ffplay-命令行工具" class="headerlink" title="ffplay (命令行工具)"></a><code>ffplay</code> (命令行工具)</h6><p>一个基于 FFmpeg 库和 SDL（一个跨平台多媒体库）的简单媒体播放器。它主要用于：</p><ul><li>快速预览音视频文件。</li><li>测试 FFmpeg 的解码能力。</li><li>实时查看应用滤镜的效果。<br>它功能相对简单，不如专门的播放器强大，但在开发调试时非常方便。</li></ul><h6 id="核心库-libav"><a href="#核心库-libav" class="headerlink" title="核心库 (libav*)"></a>核心库 (libav*)</h6><p>这些是以 <code>libav</code> 开头的 C 语言库，是 FFmpeg 所有功能的基石，也是许多其他播放器、编辑器、转码软件（甚至包括 Chrome 浏览器）使用的底层库：</p><ul><li><code>libavcodec</code>: 包含了海量的音频/视频<strong>编解码器 (CODEC)</strong>。</li><li><code>libavformat</code>: 负责处理各种多媒体<strong>容器格式 (Format)</strong> 的<strong>解复用 (Demuxing)</strong> 和<strong>复用 (Muxing)</strong>。</li><li><code>libavfilter</code>: 提供了丰富的音频和视频<strong>滤镜 (Filter)</strong>，用于实现各种特效和处理。</li><li><code>libavutil</code>: 包含了一些基础的通用工具函数（如数学运算、数据结构、日志等）。</li><li><code>libswscale</code>: 用于进行高效的图像<strong>缩放 (Scaling)</strong> 和<strong>色彩空间转换</strong>。</li><li><code>libswresample</code>: 用于进行音频<strong>重采样 (Resampling)</strong>、<strong>格式转换</strong>和<strong>声道布局</strong>处理。</li><li><code>libavdevice</code>: 用于访问操作系统提供的多媒体设备（如摄像头、麦克风、屏幕录制）。</li></ul><h4 id="17-1-2-音视频基础概念"><a href="#17-1-2-音视频基础概念" class="headerlink" title="17.1.2 音视频基础概念"></a>17.1.2 音视频基础概念</h4><p>理解以下术语对于使用 FFmpeg 至关重要：</p><table><thead><tr><th align="left">术语</th><th align="left">英文</th><th align="left">比喻</th><th align="left">作用与解释</th><th align="left">常见示例</th></tr></thead><tbody><tr><td align="left">容器格式</td><td align="left">Container / Format</td><td align="left">文件盒子</td><td align="left">定义文件结构，规定如何将音视频流、元数据打包存储。决定文件扩展名。</td><td align="left"><code>.mp4</code>, <code>.mkv</code>, <code>.mov</code>, <code>.avi</code>, <code>.mp3</code>, <code>.aac</code></td></tr><tr><td align="left">数据流</td><td align="left">Stream</td><td align="left">文件内容</td><td align="left">容器内实际的、连续的数据序列，如视频数据、音频数据、字幕数据。</td><td align="left">H.264 视频流, AAC 音频流, SRT 字幕流</td></tr><tr><td align="left">编解码器</td><td align="left">Codec (Coder/Decoder)</td><td align="left">压缩/解压算法</td><td align="left">用于压缩（编码）原始音视频数据以减小体积，或解压缩（解码）数据以便播放或编辑。</td><td align="left">H.264, H.265(HEVC), VP9, AV1, AAC, MP3, Opus</td></tr></tbody></table><p><strong>相关处理过程:</strong></p><ul><li><strong>编码 (Encoding):</strong> 将未压缩或已解码的音视频数据，使用特定的<strong>编解码器</strong>压缩成目标格式的数据<strong>流</strong>。这是有损或无损压缩的过程。</li><li><strong>解码 (Decoding):</strong> 将已编码的音视频数据<strong>流</strong>，使用对应的<strong>编解码器</strong>解压缩成原始的、可播放或可处理的数据（如图像帧序列、音频样本）。</li><li><strong>转码 (Transcoding):</strong> 先将输入文件<strong>解码</strong>，然后对解码后的数据进行处理（可选，如加滤镜），最后<strong>重新编码</strong>成目标格式/参数。这是一个<strong>解码+编码</strong>的过程，通常比较耗时和消耗 CPU 资源。</li><li><strong>封装转换/重封装 (Remuxing):</strong> <strong>不经过解码和重新编码</strong>，直接将一个容器中的音视频流<strong>原封不动地</strong>提取出来，再放入<strong>另一个类型</strong>的容器中。例如，将 MKV 文件中的 H.264 视频和 AAC 音频直接放入 MP4 文件。这个过程非常快，几乎不损失质量，但前提是目标容器必须支持源文件中的音视频编码格式。</li><li><strong>复用/封装 (Muxing):</strong> 将<strong>多个</strong>单独的编码后的流（如一个视频流、一个音频流）合并到一个<strong>容器文件</strong>中。</li><li><strong>解复用/分离 (Demuxing):</strong> 从一个<strong>容器文件</strong>中提取出<strong>单个</strong>的流（如只提取音频流）。</li></ul><h4 id="17-1-3-安装-FFmpeg-命令行工具-重要前提！"><a href="#17-1-3-安装-FFmpeg-命令行工具-重要前提！" class="headerlink" title="17.1.3 安装 FFmpeg 命令行工具 (重要前提！)"></a>17.1.3 安装 FFmpeg 命令行工具 (重要前提！)</h4><p><code>ffmpeg-python</code> 库本身<strong>不包含</strong> FFmpeg 的可执行程序。你必须<strong>首先独立地在你的操作系统中安装 FFmpeg</strong>，并确保 <code>ffmpeg</code> 和 <code>ffprobe</code> 命令可以在你的终端或命令行中直接运行。</p><h6 id="Windows-安装与配置"><a href="#Windows-安装与配置" class="headerlink" title="Windows 安装与配置"></a>Windows 安装与配置</h6><ol><li><strong>下载:</strong> 访问 FFmpeg 官网下载页面 ([下载链接](<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cuZmZtcGVnLm9yZy9kb3dubG9hZC5odG1s">Download FFmpeg</a>))。推荐从 <code>gyan.dev</code> 或 <code>BtbN</code> 下载预编译的 Windows 版本。建议选择 “release” 版本下的 “full” 构建（如 <code>ffmpeg-release-full.zip</code>），它包含了较全面的编解码器支持。</li></ol><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250502095638177.png" alt="image-20250502095638177"></p><ol><li><p><strong>解压:</strong> 将下载的 <code>.zip</code> 文件解压到一个<strong>固定且路径不含中文或特殊字符</strong>的位置，例如 <code>C:\ffmpeg</code> 或 <code>D:\tools\ffmpeg\</code>。解压后你会看到 <code>bin</code>, <code>doc</code>, <code>licenses</code> 等文件夹。关键的可执行文件在 <code>bin</code> 目录中。</p></li><li><p><strong>配置环境变量 (关键步骤):</strong></p><ul><li>在 Windows 搜索栏搜索“环境变量”并打开“编辑系统环境变量”。</li><li>在弹出的“系统属性”窗口中，点击“高级”选项卡下的“环境变量…”按钮。</li><li>在下方的“系统变量”列表中，找到名为 <code>Path</code> 的变量，选中它，点击“编辑…”。</li><li>在“编辑环境变量”窗口中，点击“新建”，然后将你刚才解压后 <code>ffmpeg</code> 文件夹下 <code>bin</code> 目录的<strong>完整路径</strong>（例如 <code>C:\ffmpeg\bin</code>）粘贴进去。</li><li>点击“确定”关闭所有打开的设置窗口。</li></ul></li><li><p><strong>验证:</strong> <strong>必须重新打开</strong>一个新的 CMD 或 PowerShell 窗口（旧窗口不会加载新的环境变量）。输入以下命令并回车：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -version</span><br><span class="line">ffprobe -version</span><br></pre></td></tr></tbody></table></figure><p>如果能成功显示 FFmpeg 和 ffprobe 的版本信息，则安装和配置成功。如果提示“不是内部或外部命令”，请仔细检查你的 PATH 环境变量设置是否正确，路径是否包含 <code>bin</code> 目录，以及是否<strong>重新打开了</strong>命令行窗口。有时需要重启电脑才能使环境变量完全生效。</p></li></ol><h6 id="macOS-安装"><a href="#macOS-安装" class="headerlink" title="macOS 安装"></a>macOS 安装</h6><p>使用 Homebrew 是最推荐的方式：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install ffmpeg</span><br></pre></td></tr></tbody></table></figure><p>验证：打开新的终端窗口，输入 <code>ffmpeg -version</code>。</p><h6 id="Linux-安装"><a href="#Linux-安装" class="headerlink" title="Linux 安装"></a>Linux 安装</h6><ul><li><strong>Debian/Ubuntu:</strong><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update &amp;&amp; <span class="built_in">sudo</span> apt install ffmpeg</span><br></pre></td></tr></tbody></table></figure></li><li><strong>CentOS/RHEL/Fedora:</strong><br>通常需要先启用 EPEL 和 RPM Fusion 仓库（如果尚未启用）：<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (根据你的具体发行版和版本，启用仓库的命令可能略有不同)</span></span><br><span class="line"><span class="comment"># 例如 CentOS 7/8:</span></span><br><span class="line"><span class="comment"># sudo yum install epel-release -y</span></span><br><span class="line"><span class="comment"># sudo yum localinstall --nogpgcheck https://download1.rpmfusion.org/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm https://download1.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-$(rpm -E %rhel).noarch.rpm -y</span></span><br><span class="line"><span class="comment"># sudo yum install ffmpeg ffmpeg-devel -y</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 例如 Fedora:</span></span><br><span class="line"><span class="comment"># sudo dnf install https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm -y</span></span><br><span class="line"><span class="comment"># sudo dnf install ffmpeg --allowerasing -y</span></span><br></pre></td></tr></tbody></table></figure>验证：输入 <code>ffmpeg -version</code>。</li></ul><h4 id="17-1-4-Python-交互方式的选择与-ffmpeg-python-安装"><a href="#17-1-4-Python-交互方式的选择与-ffmpeg-python-安装" class="headerlink" title="17.1.4 Python 交互方式的选择与 ffmpeg-python 安装"></a>17.1.4 Python 交互方式的选择与 <code>ffmpeg-python</code> 安装</h4><p>在 Python 中与 FFmpeg 交互主要有两种方式：</p><h6 id="subprocess-模块-基础方式"><a href="#subprocess-模块-基础方式" class="headerlink" title="subprocess 模块 (基础方式)"></a><code>subprocess</code> 模块 (基础方式)</h6><p>这是 Python 内置的标准库，可以用来启动和管理子进程，执行任何命令行程序，包括 <code>ffmpeg</code>。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> shlex <span class="comment"># 用于安全处理带空格或特殊字符的参数</span></span><br><span class="line"></span><br><span class="line">input_file = <span class="string">'input.mp4'</span></span><br><span class="line">output_file = <span class="string">'output.avi'</span></span><br><span class="line"><span class="comment"># 推荐将命令构造成列表，避免 shell 注入风险</span></span><br><span class="line">cmd = [<span class="string">'ffmpeg'</span>, <span class="string">'-i'</span>, input_file, <span class="string">'-c:v'</span>, <span class="string">'copy'</span>, <span class="string">'-c:a'</span>, <span class="string">'copy'</span>, output_file]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"将要执行: <span class="subst">{<span class="string">' '</span>.join(cmd)}</span>"</span>) <span class="comment"># 打印命令方便查看</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># check=True: 如果 ffmpeg 返回非 0 退出码（表示错误），则抛出 CalledProcessError</span></span><br><span class="line">    <span class="comment"># capture_output=True: 捕获标准输出和标准错误</span></span><br><span class="line">    <span class="comment"># text=True, encoding='utf-8': 将输出解码为文本</span></span><br><span class="line">    result = subprocess.run(cmd, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>, check=<span class="literal">True</span>, encoding=<span class="string">'utf-8'</span>, errors=<span class="string">'ignore'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"FFmpeg 命令成功执行。"</span>)</span><br><span class="line">    <span class="comment"># FFmpeg 的详细进度和信息通常输出到 stderr</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"FFmpeg 输出 (stderr):"</span>)</span><br><span class="line">    <span class="built_in">print</span>(result.stderr)</span><br><span class="line"><span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 命令执行失败</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"FFmpeg 命令执行失败，返回码: <span class="subst">{e.returncode}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"FFmpeg 错误输出 (stderr):"</span>)</span><br><span class="line">    <span class="built_in">print</span>(e.stderr)</span><br><span class="line"><span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"错误：找不到 ffmpeg 命令。请确认 FFmpeg 已安装并添加到系统 PATH。"</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"执行命令时发生未知错误: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><p><strong>优点:</strong> 无需额外库，灵活，可以直接执行任何 FFmpeg 命令。<br><strong>缺点:</strong> 当命令参数复杂（尤其是涉及滤镜 <code>-vf</code> 或 <code>-filter_complex</code> 时，包含大量引号、逗号、分号）时，手动构建命令列表非常繁琐且极易出错。需要手动解析 FFmpeg 的 <code>stderr</code> 输出以获取进度或判断具体错误。</p><h6 id="ffmpeg-python-库-推荐"><a href="#ffmpeg-python-库-推荐" class="headerlink" title="ffmpeg-python 库 (推荐)"></a><code>ffmpeg-python</code> 库 (推荐)</h6><p>这是一个非常流行的 Python 库，它<strong>封装</strong>了调用 FFmpeg 命令行的过程。你使用 Python 的函数和链式调用来定义输入、输出、滤镜等操作，<code>ffmpeg-python</code> 会<strong>自动为你生成</strong>对应的、复杂的 FFmpeg 命令行参数，并替你调用 <code>subprocess</code> 来执行。</p><p>需要注意的是，下载需要下载的是这个库，而不是单<code>pip install ffmpeg</code>！</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install ffmpeg-python</span><br></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ffmpeg  <span class="comment"># 使用 python-ffmpeg 库</span></span><br><span class="line"></span><br><span class="line">input_file = <span class="string">"input.mp4"</span></span><br><span class="line">output_file = <span class="string">"output.avi"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"将要使用 python-ffmpeg 库处理：<span class="subst">{input_file}</span> -&gt; <span class="subst">{output_file}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 使用 ffmpeg-python 库的流式 API</span></span><br><span class="line">    <span class="comment"># 创建输入流</span></span><br><span class="line">    stream = ffmpeg.<span class="built_in">input</span>(input_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置输出选项，使用相同的视频编解码器设置</span></span><br><span class="line">    stream = ffmpeg.output(stream, output_file, vcodec=<span class="string">'copy'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印将要执行的 FFmpeg 命令</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"等效的 FFmpeg 命令: <span class="subst">{<span class="string">' '</span>.join(ffmpeg.<span class="built_in">compile</span>(stream))}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行 FFmpeg 处理</span></span><br><span class="line">    ffmpeg.run(stream, capture_stdout=<span class="literal">True</span>, capture_stderr=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"FFmpeg 处理成功完成！"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"注意：使用 python-ffmpeg 库时，输出信息被库内部处理"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> ffmpeg.Error <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 处理 FFmpeg 错误</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"FFmpeg 处理失败"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"FFmpeg 错误输出:"</span>)</span><br><span class="line">    <span class="built_in">print</span>(e.stderr.decode(<span class="string">'utf-8'</span>, errors=<span class="string">'ignore'</span>))</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"错误：找不到 ffmpeg-python 库。请使用 'pip install ffmpeg-python' 安装。"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"注意：这个库需要系统中已安装 FFmpeg 命令行工具。"</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"处理视频时发生未知错误: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><p><strong>优点:</strong></p><ul><li><strong>代码更 Pythonic、更易读:</strong> 使用函数调用和链式操作构建流程，比拼接字符串或列表清晰。</li><li><strong>简化复杂命令:</strong> 特别是对于包含多个滤镜、输入、输出的复杂操作，能大大简化命令构建过程。</li><li><strong>减少引用/转义错误:</strong> 库会自动处理参数的引用和转义问题。</li></ul><p><strong>缺点:</strong></p><ul><li><strong>仍然依赖外部 FFmpeg:</strong> 它只是一个包装器，不是 FFmpeg 的 Python 重新实现，所以一定要保证自己的环境变量存在ffmpeg！</li><li><strong>可能无法覆盖所有参数:</strong> 对于 FFmpeg 非常规或最新的参数，库可能没有直接对应的函数或关键字参数（但通常提供传递原生参数的方式）。</li><li><strong>错误调试:</strong> 虽然它捕获了 <code>stderr</code>，但有时理解错误原因仍需结合 FFmpeg 本身的知识。</li></ul><hr><h3 id="17-2-FFmpeg-命令行结构"><a href="#17-2-FFmpeg-命令行结构" class="headerlink" title="17.2 FFmpeg 命令行结构"></a>17.2 FFmpeg 命令行结构</h3><p><strong>目标:</strong></p><ul><li>深入理解 FFmpeg 命令行的组成、选项类型、作用顺序和流指定符。</li><li>了解如何使用 <code>ffprobe</code> 获取媒体文件的详细信息。</li><li>全面掌握 <code>ffmpeg-python</code> 库的核心语法，包括如何定义输入、输出、滤镜，以及如何执行处理和获取信息。</li><li>建立 FFmpeg 命令行参数与 <code>ffmpeg-python</code> 函数/参数之间的对应关系。</li></ul><h4 id="17-2-1-FFmpeg-命令行结构详解"><a href="#17-2-1-FFmpeg-命令行结构详解" class="headerlink" title="17.2.1 FFmpeg 命令行结构详解"></a>17.2.1 FFmpeg 命令行结构详解</h4><p>要精确控制 FFmpeg，理解其命令行结构至关重要。其基本模式为：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg [全局选项] [输入选项] -i 输入文件1 ... [输出选项] 输出文件1 ...</span><br></pre></td></tr></tbody></table></figure><h6 id="选项的作用域与顺序"><a href="#选项的作用域与顺序" class="headerlink" title="选项的作用域与顺序"></a>选项的作用域与顺序</h6><p>理解选项的作用域和顺序是正确使用 FFmpeg 的关键。选项通常会影响<strong>紧随其后</strong>的文件或操作。</p><h6 id="全局选项-Global-Options"><a href="#全局选项-Global-Options" class="headerlink" title="全局选项 (Global Options)"></a><strong>全局选项 (Global Options)</strong></h6><p>这些选项位于 <code>ffmpeg</code> 命令之后、第一个 <code>-i</code> 输入文件之前，它们控制整个 FFmpeg 进程的行为。</p><ul><li><strong><code>-y</code></strong>: 自动覆盖同名输出文件，无需确认。</li><li><strong><code>-n</code></strong>: 如果输出文件已存在则不执行，防止覆盖。</li><li><strong><code>-stats</code></strong>: (通常默认开启) 显示处理进度统计信息。</li><li><strong><code>-v &lt;level&gt;</code> 或 <code>-loglevel &lt;level&gt;</code></strong>: 设置日志记录的详细程度。常用的 <code>&lt;level&gt;</code> 包括：<ul><li><code>quiet</code>: 静默，几乎不输出。</li><li><code>panic</code>, <code>fatal</code>, <code>error</code>: 只输出严重错误。</li><li><code>warning</code>: 输出警告和错误。</li><li><code>info</code>: 输出标准信息（默认）。</li><li><code>verbose</code>, <code>debug</code>, <code>trace</code>: 输出更详细的调试信息。</li></ul></li><li><strong><code>-hide_banner</code></strong>: 隐藏 FFmpeg 启动时打印的版本号、库信息和编译配置等横幅。</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例 1: 覆盖输出文件并隐藏版本信息</span></span><br><span class="line">ffmpeg -y -hide_banner -i input.mp4 output.avi</span><br><span class="line"><span class="comment"># -y: 自动覆盖 output.avi</span></span><br><span class="line"><span class="comment"># -hide_banner: 不显示版本等信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例 2: 只显示警告及以上级别的日志</span></span><br><span class="line">ffmpeg -v warning -i input.mp4 output_warn.mp4</span><br><span class="line"><span class="comment"># -v warning: 只输出警告和错误信息</span></span><br></pre></td></tr></tbody></table></figure><hr><h6 id="输入选项-Input-Options"><a href="#输入选项-Input-Options" class="headerlink" title="输入选项 (Input Options)"></a><strong>输入选项 (Input Options)</strong></h6><p>这些选项放在特定的 <code>-i</code> <strong>之前</strong>，并且<strong>只对紧随其后</strong>的那个输入文件生效。</p><ul><li><strong><code>-f &lt;格式&gt;</code></strong>: 强制 FFmpeg 以指定的<strong>容器格式</strong>来解析输入文件（通常 FFmpeg 能自动检测，但在处理原始数据流或特殊格式时需要）。</li><li><strong><code>-r &lt;帧率&gt;</code></strong>: 强制指定输入视频的<strong>帧率</strong>（例如，用于帧率信息丢失的原始视频流或图像序列）。</li><li><strong><code>-s &lt;宽x高&gt;</code></strong>: 强制指定输入视频的<strong>分辨率</strong>（例如 <code>640x480</code>，主要用于原始视频流）。</li><li><strong><code>-ss &lt;时间&gt;</code></strong>: <strong>放在 <code>-i</code> 之前</strong>，表示<strong>输入定位 (Input Seeking)</strong>。FFmpeg 会尝试快速跳转到接近指定时间点（可以使用秒 <code>15.5</code> 或 <code>HH:MM:SS.ms</code> <code>00:01:05.500</code> 格式）的关键帧开始处理。<strong>优点是速度快，缺点是定位可能不完全精确到帧</strong>。</li><li><strong><code>-stream_loop &lt;次数&gt;</code></strong>: 设置输入流循环次数。<code>-1</code> 表示无限循环（常用于将单张图片或短 GIF 做成循环背景视频）。<code>0</code> 表示不循环（默认）。</li><li><strong><code>-re</code></strong>: 要求 FFmpeg 以<strong>源文件固有</strong>的帧率读取输入。如果不加此参数，FFmpeg 会尽可能快地读取文件。该选项主要用于模拟直播推流或处理实时输入设备，以匹配源的自然速率。</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例 1：提取视频的前五秒转换为图片序列</span></span><br><span class="line">ffmpeg -i input.mp4 -t 5 -vf fps=30 D:/video_frames/frame_%04d.png</span><br><span class="line"><span class="comment">#-i my_video.mp4: 指定你的输入视频文件。</span></span><br><span class="line"><span class="comment">#-t 5: 告诉 FFmpeg 只处理输入视频的前 5 秒。</span></span><br><span class="line"><span class="comment">#-vf fps=30: 使用 fps 视频滤镜，设置输出图片的帧率为 30 帧/秒。这样 5 秒的视频会生成 5 * 30 = 150 张图片。这个帧率与你后面要测试的命令中的 -framerate 30 相匹配。</span></span><br><span class="line"><span class="comment">#D:/video_frames/frame_%04d.png: 指定输出图片的位置和命名规则。</span></span><br><span class="line"><span class="comment"># frame_%04d.png: 图片的命名规则（frame_0001.png, frame_0002.png, ..., frame_0150.png）。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例 2: 将图片序列合成为视频，指定输入帧率和开始时间点对应的图片</span></span><br><span class="line">ffmpeg -framerate 30 -ss 2 -f image2 -i frame_%04d.png output.mp4</span><br><span class="line"><span class="comment"># -framerate 30: 假设图片序列是 30fps</span></span><br><span class="line"><span class="comment"># -ss 2: 从时间点 2 秒对应的帧开始 (即大约第 60 帧，frame_0060.png)</span></span><br><span class="line"><span class="comment"># -f image2: 明确输入是图像序列</span></span><br><span class="line"><span class="comment"># -i frame_%04d.png: 输入文件模式 (frame_0001.png, frame_0002.png...)</span></span><br></pre></td></tr></tbody></table></figure><p>代码实现与最佳实践如下：</p><ul><li><p>1.使用函数封装命令、定义形参以便后续调整值</p></li><li><p>2.使用列表构造命令，防止注入攻击</p><p>当你用 <code>subprocess.run()</code> 运行一个外部命令（比如 <code>ffmpeg</code>）时，如果不特别指定 <code>stdout</code> 和 <code>stderr</code> 参数，那么这个外部命令（子进程）的<strong>标准输出</strong>和<strong>标准错误</strong>会直接连接到你的 Python 脚本（父进程）的标准输出和标准错误。简单来说，就是 <code>ffmpeg</code> 打印的任何信息（无论是正常信息还是错误信息）都会<strong>直接显示在你的 Python 脚本运行的那个终端窗口里</strong>。</p><p>当你给 <code>subprocess.run()</code> 传递 <code>stdout=subprocess.PIPE</code> 这个参数时，你是在告诉 Python： “请不要让子进程 (<code>ffmpeg</code>) 的<strong>标准输出</strong>直接打印到终端。而是，<strong>创建一个管道</strong>，把子进程的标准输出<strong>重定向</strong>到这个管道里。这样一来，我这个父进程（Python 脚本）后续就可以从这个管道里<strong>读取</strong>子进程的输出了。”</p><p>在 Python 3.7 及更高版本中，<code>subprocess.run()</code> 提供了一个更方便的参数 <code>capture_output=True</code>。<strong>设置 <code>capture_output=True</code> 等同于同时设置 <code>stdout=subprocess.PIPE</code> 和 <code>stderr=subprocess.PIPE</code></strong>，这也是我们第一个示例使用的值</p></li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_frames_with_ffmpeg</span>(<span class="params">input_video, output_pattern, duration=<span class="number">5</span>, fps=<span class="number">30</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 确保输出目录存在</span></span><br><span class="line">        output_dir = os.path.dirname(output_pattern)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_dir):</span><br><span class="line">            os.makedirs(output_dir)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"创建输出目录: <span class="subst">{output_dir}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构建ffmpeg命令</span></span><br><span class="line">        command = [</span><br><span class="line">            <span class="string">'ffmpeg'</span>,</span><br><span class="line">            <span class="string">'-i'</span>, input_video,</span><br><span class="line">            <span class="string">'-t'</span>, <span class="built_in">str</span>(duration),</span><br><span class="line">            <span class="string">'-vf'</span>, <span class="string">f'fps=<span class="subst">{fps}</span>'</span>,</span><br><span class="line">            output_pattern</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 执行命令</span></span><br><span class="line">        result = subprocess.run(</span><br><span class="line">            command,</span><br><span class="line">            stdout=subprocess.PIPE,</span><br><span class="line">            stderr=subprocess.PIPE,</span><br><span class="line">            text=<span class="literal">True</span>,</span><br><span class="line">            check=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"视频帧提取成功!"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"执行ffmpeg命令失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误输出: <span class="subst">{e.stderr}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"发生错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_video_from_frames</span>(<span class="params">input_pattern, output_video, framerate=<span class="number">30</span>, start_time=<span class="number">0</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    将图片序列转换回视频文件</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        input_pattern: 输入图片序列的模式，例如 "frame_%04d.png"</span></span><br><span class="line"><span class="string">        output_video: 输出视频文件路径</span></span><br><span class="line"><span class="string">        framerate: 帧率，默认为30fps</span></span><br><span class="line"><span class="string">        start_time: 开始时间（秒），默认为0</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        bool: 操作是否成功</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 确保输出目录存在</span></span><br><span class="line">        output_dir = os.path.dirname(output_video)</span><br><span class="line">        <span class="keyword">if</span> output_dir <span class="keyword">and</span> <span class="keyword">not</span> os.path.exists(output_dir):</span><br><span class="line">            os.makedirs(output_dir)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"创建输出目录: <span class="subst">{output_dir}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构建ffmpeg命令</span></span><br><span class="line">        command = [</span><br><span class="line">            <span class="string">'ffmpeg'</span>,</span><br><span class="line">            <span class="string">'-framerate'</span>, <span class="built_in">str</span>(framerate),</span><br><span class="line">            <span class="string">'-ss'</span>, <span class="built_in">str</span>(start_time),</span><br><span class="line">            <span class="string">'-f'</span>, <span class="string">'image2'</span>,</span><br><span class="line">            <span class="string">'-i'</span>, input_pattern,</span><br><span class="line">            <span class="string">'-c:v'</span>, <span class="string">'libx264'</span>,</span><br><span class="line">            <span class="string">'-pix_fmt'</span>, <span class="string">'yuv420p'</span>,</span><br><span class="line">            output_video</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 执行命令</span></span><br><span class="line">        result = subprocess.run(</span><br><span class="line">            command,</span><br><span class="line">            stdout=subprocess.PIPE,</span><br><span class="line">            stderr=subprocess.PIPE,</span><br><span class="line">            text=<span class="literal">True</span>,</span><br><span class="line">            check=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"从图片序列创建视频成功!"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"执行ffmpeg命令失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误输出: <span class="subst">{e.stderr}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"发生错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例使用</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 从视频提取帧</span></span><br><span class="line">    <span class="comment"># input_video = "input.mp4"  # 输入视频文件路径</span></span><br><span class="line">    <span class="comment"># output_pattern = "D:/video_frames/frame_%04d.png"  # 输出图片路径模式</span></span><br><span class="line">    <span class="comment"># extract_frames_with_ffmpeg(input_video, output_pattern, duration=5, fps=30)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 从帧创建视频</span></span><br><span class="line">    input_frames = <span class="string">"D:/video_frames/frame_%04d.png"</span>  <span class="comment"># 输入图片序列</span></span><br><span class="line">    output_video = <span class="string">"D:/video_frames/output.mp4"</span>  <span class="comment"># 输出视频文件</span></span><br><span class="line">    create_video_from_frames(input_frames, output_video, framerate=<span class="number">30</span>, start_time=<span class="number">2</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><hr><h6 id="输出选项-Output-Options"><a href="#输出选项-Output-Options" class="headerlink" title="输出选项 (Output Options)"></a>输出选项 (Output Options)</h6><p>这些选项位于某个输出文件名<strong>之前</strong>，并且<strong>只对紧随其后</strong>的那个输出文件生效。这是控制输出文件特性最关键、最丰富的一类选项。</p><p><strong>视频编码器选择 (<code>-c:v</code> 或 <code>-vcodec</code>)</strong></p><p>选择合适的视频编码器是平衡<strong>画质、文件大小、编码速度和兼容性</strong>的关键。</p><table><thead><tr><th align="left">编码器 (值)</th><th align="left">常用库名 (FFmpeg)</th><th align="left">类型</th><th align="left">压缩效率</th><th align="left">编码速度</th><th align="left">兼容性</th><th align="left">主要用途/备注</th></tr></thead><tbody><tr><td align="left">H.264 / AVC</td><td align="left"><code>libx264</code></td><td align="left">有损</td><td align="left">良好</td><td align="left">快-中等</td><td align="left">极好</td><td align="left"><strong>最通用</strong>，Web、移动端、流媒体广泛支持。质量和效率良好。</td></tr><tr><td align="left">H.265 / HEVC</td><td align="left"><code>libx265</code></td><td align="left">有损</td><td align="left"><strong>优异</strong></td><td align="left">中等-慢</td><td align="left">好</td><td align="left">压缩率比 H.264 高约 30-50%，但编码更耗时，部分旧设备不支持。</td></tr><tr><td align="left">VP9</td><td align="left"><code>libvpx-vp9</code></td><td align="left">有损</td><td align="left"><strong>优异</strong></td><td align="left">中等-慢</td><td align="left">好</td><td align="left">Google 开发，开源免费，WebM 容器常用，YouTube 使用。效率类似 H.265。</td></tr><tr><td align="left">AV1</td><td align="left"><code>libaom-av1</code></td><td align="left">有损</td><td align="left"><strong>顶尖</strong></td><td align="left"><strong>极慢</strong></td><td align="left">增长中</td><td align="left">最新一代开放标准，压缩率最高，但编码非常非常慢，解码要求也高。</td></tr><tr><td align="left">MPEG-4 Visual</td><td align="left"><code>mpeg4</code></td><td align="left">有损</td><td align="left">一般</td><td align="left">快</td><td align="left">较好</td><td align="left">较旧的标准，兼容性尚可，效率不如 H.264。</td></tr><tr><td align="left"><strong><code>copy</code></strong></td><td align="left"><code>copy</code></td><td align="left"><strong>无损(复制)</strong></td><td align="left">N/A</td><td align="left"><strong>极快</strong></td><td align="left">取决于容器</td><td align="left"><strong>特殊值:</strong> 不重新编码，直接复制原始视频流。仅用于改变容器或截取。</td></tr><tr><td align="left">… 其他特定编码器</td><td align="left">…</td><td align="left">…</td><td align="left">…</td><td align="left">…</td><td align="left">…</td><td align="left">如 <code>prores</code>, <code>dnxhd</code> (编辑用), <code>h264_nvenc</code> (Nvidia 硬编) 等。</td></tr></tbody></table><p><strong>选择建议:</strong></p><ul><li><strong>追求兼容性/通用性:</strong> 首选 <code>libx264</code> (H.264)。</li><li><strong>追求最高压缩率 (不计时间):</strong> 选 <code>libaom-av1</code> (AV1)，其次 <code>libx265</code> (H.265) 或 <code>libvpx-vp9</code> (VP9)。</li><li><strong>仅改变容器或截取:</strong> 优先尝试 <code>copy</code> 以获得最快速度和无损质量。</li><li><strong>硬件加速:</strong> 如果你的硬件支持且 FFmpeg 编译时包含支持（如 Nvidia GPU 的 <code>h264_nvenc</code>, <code>hevc_nvenc</code>），可以尝试使用，通常能大幅提高编码速度，但质量控制方式和效果可能与软编码略有不同。</li></ul><p><strong>音频编码器选择 (<code>-c:a</code> 或 <code>-acodec</code>)</strong></p><table><thead><tr><th align="left">编码器 (值)</th><th align="left">常用库名 (FFmpeg)</th><th align="left">类型</th><th align="left">压缩效率</th><th align="left">兼容性</th><th align="left">主要用途/备注</th></tr></thead><tbody><tr><td align="left">AAC</td><td align="left"><code>aac</code></td><td align="left">有损</td><td align="left">良好</td><td align="left">极好</td><td align="left"><strong>最通用</strong>，MP4/MOV/流媒体常用，是 Apple 平台标准。质量良好。</td></tr><tr><td align="left">Opus</td><td align="left"><code>libopus</code></td><td align="left">有损</td><td align="left"><strong>优异</strong></td><td align="left">好</td><td align="left">开放免费，特别适合语音和网络传输（低延迟、低码率下表现好），WebRTC 标准。</td></tr><tr><td align="left">MP3</td><td align="left"><code>libmp3lame</code></td><td align="left">有损</td><td align="left">一般</td><td align="left">极好</td><td align="left">历史悠久，兼容性最好，但同等码率下效率不如 AAC/Opus。</td></tr><tr><td align="left">Vorbis</td><td align="left"><code>libvorbis</code></td><td align="left">有损</td><td align="left">良好</td><td align="left">好</td><td align="left">开放免费，常用于 Ogg, WebM 容器。</td></tr><tr><td align="left">FLAC</td><td align="left"><code>flac</code></td><td align="left"><strong>无损</strong></td><td align="left">较高</td><td align="left">较好</td><td align="left">无损压缩，保留原始音频质量，文件较大。适合存档或对音质要求极高。</td></tr><tr><td align="left"><strong><code>copy</code></strong></td><td align="left"><code>copy</code></td><td align="left"><strong>无损 (复制)</strong></td><td align="left">N/A</td><td align="left">取决于容器</td><td align="left"><strong>特殊值:</strong> 直接复制原始音频流。</td></tr><tr><td align="left">… 其他</td><td align="left">…</td><td align="left">…</td><td align="left">…</td><td align="left">…</td><td align="left">如 <code>pcm_s16le</code> (未压缩 PCM), <code>alac</code> (Apple 无损) 等。</td></tr></tbody></table><p><strong>选择建议:</strong></p><ul><li><strong>通用、兼容性好:</strong> 首选 <code>aac</code>。</li><li><strong>网络传输、语音、低码率高质量:</strong> 首选 <code>libopus</code>。</li><li><strong>需要无损压缩:</strong> 选 <code>flac</code>。</li><li><strong>仅改变容器或截取:</strong> 尝试 <code>copy</code>。</li></ul><p><strong>字幕编码器选择 (<code>-c:s</code> 或 <code>-scodec</code>)</strong><br>字幕相对简单，常用选项：</p><ul><li><code>srt</code>: 输出为 SubRip (.srt) 格式（通常作为单独文件，或封装在 MKV 中）。</li><li><code>mov_text</code>: 输出为 MP4/MOV 兼容的内嵌文本字幕。</li><li><code>copy</code>: 直接复制原始字幕流（如果目标容器支持）。</li></ul><p><strong>质量与比特率控制</strong></p><p>这是影响输出文件大小和视觉/听觉感受的关键。主要有两种策略：</p><blockquote><p>比特率就是<strong>每秒钟用多少数据来记录或传输声音和图像</strong>，这个数值<strong>直接决定了音视频的清晰程度和文件的大小</strong>。</p></blockquote><table><thead><tr><th align="left">控制方式</th><th align="left">对应参数 (常用)</th><th align="left">描述</th><th align="left">优点</th><th align="left">缺点</th></tr></thead><tbody><tr><td align="left"><strong>恒定质量</strong></td><td align="left"><code>-crf &lt;值&gt;</code> (视频)</td><td align="left"><strong>推荐用于视频。</strong> 让编码器根据画面复杂度动态调整比特率以维持<strong>感知质量恒定</strong>。值越低，质量越好，文件越大。对 x264 常用 18(高)-28(低)；x265 类似，但相同值压缩率更高。</td><td align="left">文件大小更可控，质量相对稳定。</td><td align="left">最终比特率和文件大小不固定。</td></tr><tr><td align="left"><strong>平均比特率</strong></td><td align="left"><code>-b:v &lt;值&gt;</code> (视频) <code>-b:a &lt;值&gt;</code> (音频)</td><td align="left"><strong>推荐用于音频，也可用于视频。</strong> 指定输出文件的<strong>目标平均比特率</strong>（如 ‘2M’, ‘128k’）。编码器会尽量使最终平均速率接近此值。</td><td align="left">文件大小更容易预测和控制。</td><td align="left">简单画面可能浪费码率，复杂画面可能码率不足导致质量下降。</td></tr><tr><td align="left"><strong>最大/最小比特率</strong></td><td align="left"><code>-maxrate &lt;值&gt; -minrate &lt;值&gt; -bufsize &lt;值&gt;</code></td><td align="left">通常与 <code>-b:v</code> 配合，限制比特率波动范围，用于流媒体兼容性。<code>-bufsize</code> 定义解码器缓冲区大小。</td><td align="left">兼容性好，码率波动可控。</td><td align="left">配置复杂，可能影响质量。</td></tr></tbody></table><p><strong>选择建议:</strong></p><ul><li><strong>视频:</strong> 优先使用 <strong><code>-crf</code></strong> 控制质量，选择一个你能接受的质量和文件大小平衡点 (如 22-24)。只有在对输出文件大小有严格限制时才使用 <code>-b:v</code>。</li><li><strong>音频:</strong> 通常使用 <strong><code>-b:a</code></strong> 指定目标比特率 (如 <code>128k</code>, <code>192k</code>, <code>256k</code> for AAC/Opus)。</li></ul><p><strong>编码速度 (<code>-preset</code>)</strong></p><p>编码器通常提供预设参数集，用于在<strong>编码速度</strong>和<strong>压缩效率</strong>（同等质量下文件大小）之间做权衡。</p><table><thead><tr><th align="left">Preset 值</th><th align="left">速度</th><th align="left">压缩效率/质量</th><th align="left">CPU 消耗</th></tr></thead><tbody><tr><td align="left"><code>ultrafast</code></td><td align="left">最快</td><td align="left">最低</td><td align="left">最低</td></tr><tr><td align="left"><code>superfast</code></td><td align="left">很快</td><td align="left">较低</td><td align="left">较低</td></tr><tr><td align="left"><code>veryfast</code></td><td align="left">较快</td><td align="left">较低</td><td align="left">较低</td></tr><tr><td align="left"><code>faster</code></td><td align="left">稍快</td><td align="left">一般</td><td align="left">一般</td></tr><tr><td align="left"><code>fast</code></td><td align="left">快</td><td align="left">较好</td><td align="left">较高</td></tr><tr><td align="left"><code>medium</code></td><td align="left"><strong>默认值</strong></td><td align="left">好</td><td align="left">中等</td></tr><tr><td align="left"><code>slow</code></td><td align="left">慢</td><td align="left">更好</td><td align="left">高</td></tr><tr><td align="left"><code>slower</code></td><td align="left">较慢</td><td align="left">优异</td><td align="left">较高</td></tr><tr><td align="left"><code>veryslow</code></td><td align="left">最慢</td><td align="left">最佳</td><td align="left">最高</td></tr><tr><td align="left"><code>placebo</code></td><td align="left">(极慢)</td><td align="left">(几乎无提升)</td><td align="left">(极高)</td></tr></tbody></table><p><strong>选择建议:</strong> 从 <code>medium</code> 或 <code>fast</code> 开始尝试。如果追求极致压缩率且不介意时间，可选 <code>slow</code> 或 <code>slower</code>。如果速度是首要考虑，可选 <code>veryfast</code> 或 <code>ultrafast</code>，但文件会大很多。</p><p><strong>时间控制 (<code>-ss</code>, <code>-t</code>, <code>-to</code>)</strong></p><table><thead><tr><th align="left">选项</th><th align="left">位置</th><th align="left">作用</th><th align="left">精度</th><th align="left">速度</th></tr></thead><tbody><tr><td align="left"><code>-ss &lt;时间&gt;</code></td><td align="left"><strong>输入前</strong></td><td align="left"><strong>输入定位 (Seeking):</strong> 从输入源的指定时间点开始读取。</td><td align="left">不精确</td><td align="left">快</td></tr><tr><td align="left"><code>-ss &lt;时间&gt;</code></td><td align="left"><strong>输出前</strong></td><td align="left"><strong>输出定位 (Seeking):</strong> 解码到指定时间点才开始输出。</td><td align="left">精确</td><td align="left">慢</td></tr><tr><td align="left"><code>-t &lt;时长&gt;</code></td><td align="left">输出前</td><td align="left">限制<strong>输出</strong>的总时长。</td><td align="left">N/A</td><td align="left">N/A</td></tr><tr><td align="left"><code>-to &lt;时间&gt;</code></td><td align="left">输出前</td><td align="left">指定<strong>输出</strong>的结束时间点 (相对于输入开始时间)。</td><td align="left">N/A</td><td align="left">N/A</td></tr></tbody></table><p><strong>选择建议:</strong></p><ul><li><strong>快速截取大致片段:</strong> <code>-ss</code> 放在 <code>-i</code> 前。</li><li><strong>精确截取片段:</strong> <code>-ss</code> 放在输出文件前（会解码前面所有内容），或者先用 <code>-ss</code> (输入前) 定位到大概位置，再用 <code>-t</code> 或 <code>-to</code> (输出前) 精确控制结束点。</li><li><strong>只截取开头部分:</strong> 只用 <code>-t</code> 或 <code>-to</code>。</li></ul><hr><p><span style="color:#f33">场景 1: 快速截取大致片段</span></p><p><strong>目标:</strong> 快速从视频<strong>大约</strong> 1 分钟（60 秒）处开始，截取 15 秒长度的片段。优先考虑速度，不强求帧级别的精确。</p><p><strong>方法:</strong> 将 <code>-ss</code> 放在 <code>-i</code> 输入文件<strong>之前</strong>（输入定位），并使用 <code>-t</code> 指定输出时长。可以尝试使用 <code>-c copy</code> 以获得最快速度。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -ss 60 -i input.mp4 -t 15 -c copy output_fast_cut.mp4</span><br><span class="line"><span class="comment"># -ss 60: (输入定位) 快速跳转到 input.mp4 中接近第 60 秒的位置 (通常是前面的关键帧)</span></span><br><span class="line"><span class="comment"># -i input.mp4: 输入文件</span></span><br><span class="line"><span class="comment"># -t 15: (输出选项) 从定位到的点开始，截取 15 秒的时长</span></span><br><span class="line"><span class="comment"># -c copy: (输出选项) 直接复制音视频流，不重新编码，速度最快 (如果格式兼容)</span></span><br></pre></td></tr></tbody></table></figure><p><span style="color:#f33">场景 2: 精确截取片段</span></p><p><strong>目标:</strong> <strong>精确地</strong>从视频的第 1 分 05 秒 (<code>00:01:05</code>) 开始，截取到第 1 分 15 秒 (<code>00:01:15</code>) 结束（总时长 10 秒）。</p><p>将 <code>-ss</code> 放在输出文件<strong>之前</strong>，并配合 <code>-to</code> 或 <code>-t</code>。FFmpeg 会解码 <code>-ss</code> 之前的所有内容。通常<strong>不能</strong>使用 <code>-c copy</code>。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -ss 00:01:05 -to 00:01:15 -c:v libx264 -c:a aac output.mp4</span><br><span class="line"><span class="comment"># -i input.mp4: 输入文件</span></span><br><span class="line"><span class="comment"># -ss 00:01:05: (输出定位) 精确地从解码后的第 1分05秒 开始编码输出</span></span><br><span class="line"><span class="comment"># -to 00:01:15: (输出定位) 精确地在解码后的第 1分15秒 结束编码输出 (注意是绝对时间点)</span></span><br><span class="line"><span class="comment"># -c:v libx264 -c:a aac: 需要重新编码视频和音频以保证精确切割</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p><strong>注意:</strong> 这种方式<strong>非常精确</strong>，但因为需要解码前面的内容，所以<strong>速度很慢</strong>，尤其当 <code>-ss</code> 的时间点靠后时。</p></blockquote><p>若我们一个视频很长的情况下，而我们需要截取的片段而又在非常的末尾，这时候选择这种精确片段的语法就不好了，所以我们换一种思路：</p><p>先用 <code>-ss</code> (输入前) 快速定位到大概位置，再用 <code>-t</code> 精确控制截取<strong>时长</strong>。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -ss 00:01:00 -i input.mp4 -t 10 -c:v libx264 -c:a aac output.mp4</span><br><span class="line"><span class="comment"># -ss 00:01:00: (输入定位) 快速跳转到接近 1 分钟的位置</span></span><br><span class="line"><span class="comment"># -i input.mp4: 输入文件</span></span><br><span class="line"><span class="comment"># -t 10: (输出选项) 从实际定位到的点开始，精确地截取 10 秒的**时长**</span></span><br><span class="line"><span class="comment"># 这种方式下，起始点可能略早于 1 分钟，但输出时长是准确的 10 秒，速度比纯输出定位快得多。</span></span><br></pre></td></tr></tbody></table></figure><p><span style="color:#f33">场景 3: 只截取开头部分</span></p><p><strong>目标:</strong> 只保留视频的前 20 秒。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 -t 指定时长</span></span><br><span class="line">ffmpeg -i input.mp4 -t 20 -c copy output_first_20s_t.mp4</span><br><span class="line"><span class="comment"># -t 20: 从开头截取 20 秒时长</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 -to 指定结束时间点</span></span><br><span class="line">ffmpeg -i input.mp4 -to 20 -c copy output_first_20s_to.mp4</span><br><span class="line"><span class="comment"># -to 20: 从开头截取到第 20 秒结束</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意: -t 和 -to 在只截取开头时效果类似，都比较快，且通常可以使用 -c copy。</span></span><br></pre></td></tr></tbody></table></figure><h6 id="复杂滤镜（-filter-complex）"><a href="#复杂滤镜（-filter-complex）" class="headerlink" title="复杂滤镜（-filter_complex）"></a>复杂滤镜（-filter_complex）</h6><p><code>-filter_complex</code> 在我们接下来需要介绍的滤镜篇十分重要！他是实现复杂的滤镜效果的核心关键点</p><p><strong>为什么需要 <code>-filter_complex</code>？</strong></p><p>我们用的 <code>-vf</code> (视频滤镜) 和 <code>-af</code> (音频滤镜) 适用于<strong>简单的、线性的</strong>处理流程：一个输入流 -&gt; 经过一个或多个滤镜（用逗号分隔） -&gt; 一个输出流。</p><p>但如果你需要做更复杂的操作，比如：</p><ul><li><strong>处理多个输入流：</strong> 例如，把一个 logo 图片叠加到视频上（视频是输入1，logo 是输入2）。</li><li><strong>一个滤镜产生多个输出：</strong> 例如，<code>split</code> 滤镜可以把一个视频流复制成两份，分别进行不同处理。</li><li><strong>合并多个流：</strong> 例如，把两个视频左右拼接 (<code>hstack</code>)，或者把处理过的视频流和处理过的音频流合并输出。</li></ul><p>这些情况就需要用到 <code>-filter_complex</code> 来定义一个<strong>滤镜图 (filtergraph)</strong>。</p><p><strong><code>-filter_complex</code> 的基本语法结构:</strong></p><p>可以把它想象成用文字描述一个“数据流管道系统”：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-filter_complex <span class="string">"[输入流标签1][输入流标签2]... 滤镜1=参数[输出流标签A]; [输入流标签C]滤镜2=参数[输出流标签B]; [标签A][标签B]滤镜3[最终输出标签]"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对应如下命令行</span></span><br><span class="line">ffmpeg -i input.mp4 -i logo.png \</span><br><span class="line">-filter_complex <span class="string">"[0:v][1:v] overlay=10:10 [outv]"</span> \</span><br><span class="line">-map <span class="string">"[outv]"</span> -map 0:a? \</span><br><span class="line">output.mp4</span><br></pre></td></tr></tbody></table></figure><p><strong>核心组成部分解释:</strong></p><ol><li><p><strong><code>[...]</code> (方括号 - 流标签 / Stream Labels):</strong></p><ul><li><p>这就像是给在滤镜图内部流动的<strong>临时数据流</strong>（视频流、音频流）起名字。</p></li><li><p>引用输入文件流:</p><p>通常用</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[文件索引:流标识符]</span><br></pre></td></tr></tbody></table></figure><p>的形式。例如：</p><ul><li><code>[0:v]</code> 指的是第一个输入文件 (<code>-i</code> 后面第一个) 的视频流 (通常是第一个视频流)。</li><li><code>[0:a]</code> 指的是第一个输入文件的第一个音频流。</li><li><code>[1:v]</code> 指的是第二个输入文件的视频流。</li></ul></li><li><p><strong>自定义标签:</strong> 你可以给一个滤镜处理后的<strong>输出流</strong>起一个自定义的名字，比如 <code>[scaled_video]</code>, <code>[watermarked]</code>, <code>[outv]</code>。这个名字可以被<strong>后续的滤镜</strong>或最后的 <code>-map</code> 指令引用。</p></li></ul></li></ol><p><strong><code>-map</code> 的配合:</strong></p><p>因为 <code>-filter_complex</code> 处理后的输出流是带有<strong>自定义标签</strong>的（比如上面例子中的 <code>[outv]</code>），FFmpeg 不会自动将它映射到最终的输出文件。你需要使用 <code>-map</code> 选项来<strong>明确告诉</strong> FFmpeg 使用哪个标签的流作为输出文件的视频流、哪个作为音频流等。</p><ul><li><code>-map "[outv]"</code>: 将标签为 <code>outv</code> 的流映射为输出文件的<strong>第一个视频流</strong>（通常是这样）。</li><li><code>-map "[outa]"</code>: 将标签为 <code>outa</code> 的流映射为输出文件的<strong>第一个音频流</strong>。</li><li>你仍然可以用 <code>-map 0:a?</code> 这样的方式来映射<strong>未经滤镜图处理</strong>的原始输入流（比如直接复制原始音频）。</li></ul><p><strong>简单示例：叠加 Logo (回顾)</strong></p><p>我们再看一下这个例子，体会一下标签和分号的作用：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -i logo.png \</span><br><span class="line">-filter_complex <span class="string">"[0:v][1:v] overlay=10:10 [outv]"</span> \</span><br><span class="line">-map <span class="string">"[outv]"</span> -map 0:a? \</span><br><span class="line">output.mp4</span><br></pre></td></tr></tbody></table></figure><ul><li><code>-filter_complex</code> 内:<ul><li><code>[0:v]</code> 和 <code>[1:v]</code> 是<strong>输入标签</strong>，分别代表 <code>input.mp4</code> 的视频流和 <code>logo.png</code> 的视频流。</li><li><code>overlay=10:10</code> 是作用于这两个输入流的<strong>滤镜</strong>。</li><li><code>[outv]</code> 是 <code>overlay</code> 滤镜处理完成后的<strong>输出标签</strong>。</li><li><strong>这里只有一个滤镜链，所以没有用到分号 <code>;</code>。</strong></li></ul></li><li><strong><code>-map "[outv]"</code>:</strong> 将带有 <code>outv</code> 标签的视频流（叠加结果）指定为输出视频。</li><li><strong><code>-map 0:a?</code>:</strong> 将原始视频的音频（如果存在）也指定到输出。</li></ul><hr><h4 id="17-2-2-常用滤镜-vf-af"><a href="#17-2-2-常用滤镜-vf-af" class="headerlink" title="17.2.2 **常用滤镜 (-vf, -af) **"></a>17.2.2 **常用滤镜 (<code>-vf</code>, <code>-af</code>) **</h4><p>FFmpeg 的滤镜系统是其最强大的功能之一，它允许你对音视频流进行各种精密的修改和处理。你可以将滤镜想象成一个个处理单元，音视频数据流过这些单元时会被修改，像 Photoshop (PS), Premiere Pro, DaVinci Resolve 这些图形界面工具非常强大，对于<strong>单张图片或单个视频的精细、创意性编辑</strong>，它们通常更直观、效率更高，因为你可以实时看到效果并进行微调。</p><p>但假设思考这么一些场景你就能够理解FFmpeg的强大之处：</p><p>网站后台自动处理用户上传的图片（统一尺寸、加水印）、视频网站自动生成不同清晰度的版本等。</p><p>用户上传视频到你的网站，后端服务器自动调用 FFmpeg 进行转码、截图、添加片头片尾等。</p><p>一个监控系统，当检测到特定事件时，自动调用 FFmpeg 截取相关录像片段并进行压缩或格式转换。</p><ul><li><strong>作用:</strong> 修改或分析音视频流的内容。常见的操作包括：调整尺寸/裁剪、旋转/翻转、叠加图像/文字、调色、降噪、改变速度、调整音量、混音等等。</li><li><strong>分类:</strong><ul><li><strong>视频滤镜 (<code>-vf</code>):</strong> 处理视频帧数据。</li><li><strong>音频滤镜 (<code>-af</code>):</strong> 处理音频采样数据。</li></ul></li><li><strong>数量庞大:</strong> FFmpeg 内置了数百种滤镜，覆盖了绝大部分常见的处理需求。你可以通过 <code>ffmpeg -filters</code> 命令查看所有支持的滤镜。</li></ul><hr><p>在进行滤镜处理之前，我们给出三张好看的原图作为参考</p><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/1.png" alt="Image 1" style="width:calc(33.33% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/2.png" alt="Image 2" style="width:calc(33.33% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/3.png" alt="Image 3" style="width:calc(33.33% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"></div><hr><h5 id="1-模糊-boxblur"><a href="#1-模糊-boxblur" class="headerlink" title="(1) 模糊 (boxblur)"></a>(1) 模糊 (<code>boxblur</code>)</h5><p><strong>参数:</strong> <code>boxblur</code>。用于实现均匀模糊效果。</p><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## ./ffmpeg -i 1.jpg -vf boxblur=2 blur1.jpg</span></span><br><span class="line">ffmpeg -i 1.png -vf boxblur=2 blur1.png</span><br></pre></td></tr></tbody></table></figure><p><em>(注：示例命令中的 <code>./ffmpeg</code> 通常在 Linux/macOS 下表示当前目录的可执行文件，Windows 下或配置好 PATH 后直接用 <code>ffmpeg</code> 即可。以下示例统一使用 <code>ffmpeg</code>。)</em></p><p><strong>说明:</strong> 值越大越模糊。以下是值分别为 2、4、8 的效果：</p><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/blur1.png" alt="Image 1" style="width:calc(33.33% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/blur2.png" alt="Image 2" style="width:calc(33.33% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/blur3.png" alt="Image 3" style="width:calc(33.33% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"></div><hr><h5 id="2-变色"><a href="#2-变色" class="headerlink" title="(2) 变色"></a>(2) 变色</h5><p>FFmpeg 提供了多种变色方法。</p><h6 id="a-colorbalance"><a href="#a-colorbalance" class="headerlink" title="(a) colorbalance"></a>(a) <code>colorbalance</code></h6><p>通过调整 RGB 三个颜色通道在不同亮度区域（阴影、中间调、高光）的权重来实现色彩平衡调整。</p><p><strong>参数说明:</strong><br>选项有三组，分别对应阴影(shadows/<code>s</code>)、中间调(midtones/<code>m</code>)、高光(highlights/<code>h</code>)：</p><ul><li><code>rs</code>, <code>gs</code>, <code>bs</code>: 调整阴影部分的红/绿/蓝。</li><li><code>rm</code>, <code>gm</code>, <code>bm</code>: 调整中间调的红/绿/蓝。</li><li><code>rh</code>, <code>gh</code>, <code>bh</code>: 调整高光的红/绿/蓝。</li></ul><p>每个选项的值范围为 <code>[-1, 1]</code>。正数表示增强该颜色在该区域的影响力（偏向该色），负数表示减弱（远离该色）。</p><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 增强阴影中的红色</span></span><br><span class="line">ffmpeg -i 3.png -vf colorbalance=rs=1 colorbalance_rs1.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 增强中间调的红色</span></span><br><span class="line">ffmpeg -i 3.png -vf colorbalance=<span class="built_in">rm</span>=1 colorbalance_rm2.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 增强高光中的红色</span></span><br><span class="line">ffmpeg -i 3.png -vf colorbalance=rh=1 colorbalance_rh3.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 稍微增加阴影和中间调的红色和绿色，略微减少蓝色，使整体偏暖</span></span><br><span class="line">ffmpeg -i 3.png -vf colorbalance=rs=0.2:gs=0.1:<span class="built_in">rm</span>=0.3:gm=0.2:bm=-0.1 colorbalance_warm.jpg</span><br><span class="line"><span class="comment"># rs=0.2, gs=0.1: 轻微增加阴影中的红、绿色</span></span><br><span class="line"><span class="comment"># rm=0.3, gm=0.2: 稍多增加中间调的红、绿色</span></span><br><span class="line"><span class="comment"># bm=-0.1: 轻微减少中间调的蓝色</span></span><br></pre></td></tr></tbody></table></figure><p>效果图：</p><div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/colorbalance_rs1.jpg" alt="Image 1" style="width:100%;height:150px;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/colorbalance_rm2.jpg" alt="Image 2" style="width:100%;height:150px;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/colorbalance_rh3.jpg" alt="Image 3" style="width:100%;height:150px;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/colorbalance_warm.jpg" alt="Image 4" style="width:100%;height:150px;display:block;object-fit:cover;border-radius:4px"></div><h6 id="b-colorchannelmixer"><a href="#b-colorchannelmixer" class="headerlink" title="(b) colorchannelmixer"></a>(b) <code>colorchannelmixer</code></h6><p>通过一个 3x4 (或 4x4) 矩阵对 RGBA 四个通道进行线性组合，重新计算每个输出通道的值。可以实现灰度、各种色调（如棕褐色）等复杂效果。</p><p><strong>参数说明:</strong><br>需要提供 12 个（用于 RGB 输出）或 16 个（用于 RGBA 输出）用冒号 <code>:</code> 分隔的权重值。顺序为：<code>rr:rg:rb:ra:gr:gg:gb:ga:br:bg:bb:ba[:ar:ag:ab:aa]</code>。<br>计算公式为（以红色输出为例）：<br><code>R_out = R_in*rr + G_in*rg + B_in*rb + A_in*ra</code><br>（Gout, Bout, Aout 同理）<br>权重值通常在 <code>[0, 1]</code> 范围内。</p><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 灰度效果 (一种近似计算)</span></span><br><span class="line"><span class="comment">## R_out = G_out = B_out = 0.3*R_in + 0.4*G_in + 0.3*B_in + 0*A_in</span></span><br><span class="line">ffmpeg -i 2.png -vf colorchannelmixer=.3:.4:.3:0:.3:.4:.3:0:.3:.4:.3:0 colorchannelmixer_gray.jpg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 棕褐色调 (Sepia)</span></span><br><span class="line">ffmpeg -i 2.png -vf colorchannelmixer=.393:.769:.189:0:.349:.686:.168:0:.272:.534:.131:0 colorchannelmixer_sepia.jpg</span><br></pre></td></tr></tbody></table></figure><p>效果图：</p><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/colorchannelmixer_gray.jpg" alt="Image 1" style="width:calc(50% - 7px);height:300px;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/colorchannelmixer_sepia.jpg" alt="Image 2" style="width:calc(50% - 7px);height:300px;display:block;object-fit:cover;border-radius:4px"></div>######(c) `hue` 与 Saturation<p>调整图像的<strong>色相 (Hue)</strong> 和 <strong>饱和度 (Saturation)</strong>。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic4.zhimg.com/v2-bd09649cf732f00c620b0be275cdbc48_r.jpg" alt="PS中关于HSB色彩模式详解 - 知乎"></p><p><strong>参数说明:</strong></p><ul><li><code>h=&lt;角度&gt;</code>: 色相角度 (单位：度)，在色轮上旋转颜色。范围 <code>[0, 360]</code> 循环，默认 0。</li><li><code>s=&lt;数值&gt;</code>: 饱和度。范围 <code>[-10, 10]</code>，默认 1。大于 1 增强饱和度，小于 1 降低，0 为灰度，负数为补色效果。</li><li><code>H=&lt;弧度&gt;</code>: 同 <code>h</code>，但单位是弧度。</li><li><code>b=&lt;数值&gt;</code>: 亮度。范围 <code>[-10, 10]</code>，默认 0。</li></ul><p>有关色相、饱和度、亮度请详见<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vc3Rhcm1hcC92aWV3P25vZGVJZD1hZWI5YjdiYmMxNmU1OTdiM2EyNzIwMGMmbGVtbWFUaXRsZT0lRTglODklQjIlRTclOUIlQjgmbGVtbWFJZD02MjIxMDM3MCZzdGFyTWFwRnJvbT1sZW1tYV9zdGFyTWFwJmZyb21Nb2R1bGU9bGVtbWFfc3Rhck1hcA">色彩三要素</a></p><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 改变色相到 180 度，饱和度不变</span></span><br><span class="line">ffmpeg -i 3.png -vf hue=h=180:s=1 hue_h180.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 降低饱和度 (接近黑白但略带反色)</span></span><br><span class="line">ffmpeg -i 3.png -vf hue=h=0:s=-5 hue_s-5.jpg</span><br></pre></td></tr></tbody></table></figure><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/hue_h180.jpg" alt="Image 1" style="width:calc(50% - 7px);height:300px;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/hue_s-5.jpg" alt="Image 2" style="width:calc(50% - 7px);height:300px;display:block;object-fit:cover;border-radius:4px"></div>-----<h5 id="d-lutyuv-lutrgb"><a href="#d-lutyuv-lutrgb" class="headerlink" title="(d) lutyuv / lutrgb"></a>(d) <code>lutyuv</code> / <code>lutrgb</code></h5><p>这两个滤镜应用查找表 (LUT) 的<strong>概念</strong>来进行颜色转换，但它们的主要工作方式是<strong>基于你提供的数学表达式</strong>来计算每个颜色分量的输出值。</p><ul><li><code>lutyuv</code>: 在 YUV 颜色空间操作（Y: 亮度, U/V: 色度）。</li><li><code>lutrgb</code>: 在 RGB 颜色空间操作（R: 红, G: 绿, B: 蓝）。</li></ul><p><strong>Y = 亮度 (有多亮)</strong></p><p><strong>U = 蓝色色度差 (颜色有多偏蓝/黄)</strong></p><p><strong>V = 红色色度差 (颜色有多偏红/青)</strong></p><p>视频压缩和传输常常使用 YUV (或类似的 YCbCr) 而不是我们屏幕显示常用的 RGB（红绿蓝），主要是符合人眼特性、与压缩效率高两个优点</p><p>它们的核心是通过表达式，根据<strong>输入像素各分量的当前值 (<code>val</code>)</strong> 来计算<strong>输出像素各分量的新值</strong>。</p><h6 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h6><p>你需要为想要修改的颜色分量指定一个计算表达式。例如，对于 <code>lutyuv</code>，你可以指定 <code>y='&lt;表达式&gt;'</code>, <code>u='&lt;表达式&gt;'</code>, <code>v='&lt;表达式&gt;'</code>。</p><p>表达式中可用的常用变量包括：</p><table><thead><tr><th align="left">变量名</th><th align="left">含义</th><th align="left">示例用法</th></tr></thead><tbody><tr><td align="left"><code>val</code></td><td align="left">当前正在处理的颜色分量的输入值。</td><td align="left"><code>y=2*val</code> (亮度翻倍)</td></tr><tr><td align="left"><code>negval</code></td><td align="left">输入值的反转值，等于 <code>maxval + minval - val</code>。</td><td align="left"><code>y=negval</code> (亮度反转)</td></tr><tr><td align="left"><code>clipval</code></td><td align="left">同 <code>val</code>，但其值会被自动限制在对应分量的有效范围内。</td><td align="left"></td></tr><tr><td align="left"><code>minval</code></td><td align="left">当前颜色分量允许的最小值 (例如 YUV 中的 16 或 RGB 中的 0)。</td><td align="left"><code>y=maxval+minval-val</code></td></tr><tr><td align="left"><code>maxval</code></td><td align="left">当前颜色分量允许的最大值 (例如 YUV 中的 235/240 或 RGB 中的 255)。</td><td align="left"><code>y=maxval-val</code></td></tr><tr><td align="left"><code>w</code>, <code>h</code></td><td align="left">图像/视频的宽度和高度 (像素)。</td><td align="left"><code>x/w</code> (归一化坐标)</td></tr><tr><td align="left"><code>x</code>, <code>y</code></td><td align="left">当前正在处理的像素的坐标 (从 0 开始)。</td><td align="left"><code>y=val+x/10</code></td></tr><tr><td align="left"><code>t</code></td><td align="left">当前帧的时间戳 (秒)。</td><td align="left"><code>y=val*sin(t)</code></td></tr></tbody></table><p>表达式支持常见的数学运算符 (<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>^</code>) 和函数 (<code>sin</code>, <code>cos</code>, <code>max</code>, <code>min</code>, <code>clip</code>, <code>if</code> 等)。</p><h6 id="命令行示例-lutyuv"><a href="#命令行示例-lutyuv" class="headerlink" title="命令行示例 (lutyuv)"></a>命令行示例 (<code>lutyuv</code>)</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 底片效果 (反转 Y, U, V 三个分量)</span></span><br><span class="line"><span class="comment"># 使用 negval 变量更简洁</span></span><br><span class="line">ffmpeg -i 1.png -vf lutyuv=<span class="string">"y=negval:u=negval:v=negval"</span> lutyuv_negate.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 黑白效果 (移除色度信息，将 U, V 设为中间值 128)</span></span><br><span class="line"><span class="comment"># Y (亮度) 分量保持不变 (y=val 是默认值)</span></span><br><span class="line">ffmpeg -i 1.png -vf lutyuv=<span class="string">"u=128:v=128"</span> lutyuv_bw.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提升亮度 (Y 值翻倍，注意可能过曝导致细节丢失)</span></span><br><span class="line"><span class="comment"># 计算结果会自动 clip 到有效范围 [minval, maxval]</span></span><br><span class="line">ffmpeg -i 1.png -vf lutyuv=<span class="string">"y=2*val"</span> lutyuv_brighten.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调整色度 (示例：增加 U 分量，略微增加 V 分量)</span></span><br><span class="line">ffmpeg -i 1.png -vf lutyuv=<span class="string">'u=1.2*val:v=1.1*val'</span> lutyuv_adjust_uv.jpg</span><br></pre></td></tr></tbody></table></figure><h6 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h6><div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/lutyuv_negate.jpg" alt="Image 1" style="width:100%;height:300px;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/lutyuv_bw.jpg" alt="Image 2" style="width:100%;height:300px;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/lutyuv_brighten.jpg" alt="Image 3" style="width:100%;height:300px;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/lutyuv_adjust_uv.jpg" alt="Image 4" style="width:100%;height:300px;display:block;object-fit:cover;border-radius:4px"></div><hr><h6 id="重要说明：基于表达式的-LUT-vs-加载-LUT-预设文件"><a href="#重要说明：基于表达式的-LUT-vs-加载-LUT-预设文件" class="headerlink" title="重要说明：基于表达式的 LUT vs 加载 LUT 预设文件"></a>重要说明：基于表达式的 LUT vs 加载 LUT 预设文件</h6><p>常识来说LUT 被描述为一种<strong>可以保存和加载的“滤镜效果文件”</strong>（通常是 <code>.cube</code>, <code>.3dl</code>, <code>.look</code> 等格式）。这种用法在视频编辑和调色领域非常普遍。</p><p><strong>这两种关于 LUT 的描述都是正确的，但指向的是不同的概念和 FFmpeg 功能：</strong></p><ol><li><p><strong>LUT 预设文件 (<code>.cube</code> 等):</strong></p><ul><li>存储了一个<strong>预先计算好的、庞大的颜色映射表</strong>，定义了各种输入颜色如何精确地转换为输出颜色。</li><li>常用于应用复杂的<strong>色彩风格</strong>(如电影感、复古色调)或进行<strong>色彩空间转换</strong>(如 Log 转 Rec.709)。</li><li>在 FFmpeg 中，<strong>加载和应用这类文件</strong> 主要使用 <strong><code>lut3d</code></strong> 滤镜 (对于 3D LUTs，如 <code>.cube</code>) 或 <code>lut1d</code> 滤镜 (对于 1D LUTs)。</li></ul></li><li><p><strong>FFmpeg 的 <code>lutyuv</code>/<code>lutrgb</code>/<code>lut</code> 滤镜 (基于表达式):</strong></p><ul><li>如上所述，这些滤镜允许你<strong>使用数学表达式来实时定义颜色转换规则</strong>。</li><li>它们非常<strong>灵活</strong>，适合进行程序化的、基于像素值或坐标的颜色调整（例如上面示例中的反相、去色、亮度调整）。</li><li>但它们<strong>不直接加载</strong> <code>.cube</code> 等外部预设文件。</li></ul></li></ol><p><strong>如何使用 FFmpeg 加载常见的 <code>.cube</code> LUT 文件？</strong></p><p>你需要使用 <code>lut3d</code> 滤镜：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例：将 "my_film_look.cube" 这个 LUT 文件应用到视频上</span></span><br><span class="line">ffmpeg -i input.mp4 -vf lut3d=<span class="string">"path/to/my_film_look.cube"</span> output_lut_applied.mp4</span><br></pre></td></tr></tbody></table></figure><ul><li><code>-vf lut3d="&lt;你的LUT文件路径&gt;"</code>: 这里的参数就是你的 <code>.cube</code> (或其他支持的 LUT 格式) 文件的路径。</li></ul><blockquote><p>附：<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMU1IZ1VkVzhJYVlHRlI0VEl6YV95bGcjbGlzdC9wYXRoPSUyRnNoYXJlbGluazExMDE3NDQ3MzQ5MTItNTg4NTc3NDA2NTI2NDclMkYwMi5MVVQmcGFyZW50UGF0aD0lMkZzaGFyZWxpbmsxMTAxNzQ0NzM0OTEyLTU4ODU3NzQwNjUyNjQ3">100个LUT文件模板下载</a></p></blockquote><hr><h5 id="3-裁剪-crop"><a href="#3-裁剪-crop" class="headerlink" title="(3) 裁剪 (crop)"></a>(3) 裁剪 (<code>crop</code>)</h5><p>从视频或图像中裁剪出指定尺寸和位置的矩形区域(基于图片大小)</p><p><strong>参数说明:</strong> <code>crop=width:height:x:y</code> 或 <code>crop=w=W:h=H:x=X:y=Y</code></p><ul><li><code>w</code>, <code>h</code>: 输出宽度和高度。可用 <code>iw</code>, <code>ih</code> (输入宽高)。</li><li><code>x</code>, <code>y</code>: 裁剪区域左上角坐标。默认居中。</li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 从 (100, 100) 裁剪 200x300</span></span><br><span class="line">ffmpeg -i 1.png -vf crop=w=200:h=300:x=100:y=100 crop_1.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 从中心裁剪 400x500 (省略 x, y)</span></span><br><span class="line">ffmpeg -i 1.png -vf crop=400:500 crop_center.jpg</span><br></pre></td></tr></tbody></table></figure><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/crop_1.jpg" alt="Image 1" style="width:calc(50% - 7px);height:300px;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/crop_center.jpg" alt="Image 2" style="width:calc(50% - 7px);height:300px;display:block;object-fit:cover;border-radius:4px"></div><hr><h5 id="4-去-Logo-delogo"><a href="#4-去-Logo-delogo" class="headerlink" title="(4) 去 Logo (delogo)"></a>(4) 去 Logo (<code>delogo</code>)</h5><p>在指定矩形区域内应用像素插值或模糊，尝试去除静态 Logo。效果有限，如下图，此图片携带b站的水印</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250502170301166.png" alt="image-20250502170301166"></p><p><strong>参数说明:</strong> <code>delogo=x=X:y=Y:w=W:h=H[:band=B][:show=S]</code></p><ul><li><code>x,y,w,h</code>: Logo 区域。</li><li><code>show</code>: 设为 <code>1</code> 时显示处理区域的绿色边框（用于调试），对于调试来说，建议使用<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly91dXRvb2wuY24vaW1nLWNvb3JkLw">在线图片坐标拾取工具 - UU在线工具</a></li></ul><p><strong>左上角:</strong> <code>x = 534</code>, <code>y = 22</code></p><p><strong>右下角 :</strong> <code>x = 763</code>, <code>y = 76</code></p><p>我们可以计算出 <code>delogo</code> 滤镜需要的宽度 (<code>w</code>) 和高度 (<code>h</code>)：</p><p><strong>宽度 <code>w</code> =</strong> 右下角 x - 左上角 x = <code>763 - 534</code> = <strong><code>229</code></strong></p><p><strong>高度 <code>h</code> =</strong> 右下角 y - 左上角 y = <code>76 - 22</code> = <strong><code>54</code></strong></p><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i 4.png -vf <span class="string">"delogo=x=534:y=22:w=229:h=54"</span> output_delogo.jpg</span><br></pre></td></tr></tbody></table></figure><p>效果图如下：<strong>请注意:</strong> <code>delogo</code> 的实际效果取决于水印周围的背景复杂度，它主要是基于边缘像素进行插值填充，可能不会完美去除或产生理想的模糊效果，有时看起来会有些“涂抹”感。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/output_delogo.jpg" alt="output_delogo"></p><hr><h5 id="5-加边框-drawbox"><a href="#5-加边框-drawbox" class="headerlink" title="(5) 加边框 (drawbox)"></a>(5) 加边框 (<code>drawbox</code>)</h5><p>在图像或视频上绘制矩形边框。</p><p><strong>参数说明:</strong> <code>drawbox=x=X:y=Y:w=W:h=H:color=C[@A][:t=T]</code></p><ul><li><code>x,y,w,h</code>: 边框位置和尺寸。默认 <code>x=0, y=0, w=iw, h=ih</code> (整个画面)。</li><li><code>color</code> 或 <code>c</code>: 边框颜色，可以是颜色名 (<code>red</code>, <code>blue</code>) 或十六进制 (<code>0xFF0000</code>)，可以用 <code>@透明度</code> 指定透明度 (如 <code>red@0.5</code>)。默认黑色。</li><li><code>thickness</code> 或 <code>t</code>: 边框线宽（像素）。<code>fill</code> 表示填充整个矩形。默认 3。</li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 绘制默认黑色实心边框 (充满边界)</span></span><br><span class="line">ffmpeg -i 1.png -vf drawbox drawbox_default.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在 (10,10) 绘制 200x100 的半透明红色边框，线宽默认</span></span><br><span class="line">ffmpeg -i 1.png -vf drawbox=x=10:y=10:w=200:h=100:color=red@0.5 drawbox_rect.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在 (10,10) 绘制 300x230 的半透明粉色边框，线宽 10</span></span><br><span class="line">ffmpeg -i 1.png -vf drawbox=x=10:y=10:w=300:h=230:color=pink@0.5:t=10 drawbox_thick.jpg</span><br></pre></td></tr></tbody></table></figure><p>效果图</p><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/drawbox_default.jpg" alt="Image 1" style="width:calc(33.33% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/drawbox_rect.jpg" alt="Image 2" style="width:calc(33.33% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/drawbox_thick.jpg" alt="Image 3" style="width:calc(33.33% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"></div><hr><h5 id="6-画网格-drawgrid"><a href="#6-画网格-drawgrid" class="headerlink" title="(6) 画网格 (drawgrid)"></a>(6) 画网格 (<code>drawgrid</code>)</h5><p>在视频上绘制网格线。</p><p><strong>参数说明:</strong> <code>drawgrid=width=W:height=H:thickness=T:color=C[@A]</code></p><ul><li><code>width</code> 或 <code>w</code>: 网格单元的宽度。可用 <code>iw</code> (输入宽)。</li><li><code>height</code> 或 <code>h</code>: 网格单元的高度。可用 <code>ih</code> (输入高)。</li><li><code>thickness</code> 或 <code>t</code>: 网格线的厚度。</li><li><code>color</code> 或 <code>c</code>: 网格线颜色和透明度。</li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 绘制 3x3 九宫格 (单元宽高为输入宽/高除以3)，白色半透明，线宽 2</span></span><br><span class="line">ffmpeg -i 1.png -vf drawgrid=w=iw/3:h=ih/3:t=2:c=white@0.5 drawgrid_3x3.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 绘制单元格为 400x100 的红色半透明网格，线宽 2</span></span><br><span class="line">ffmpeg -i 1.png -vf drawgrid=w=400:h=100:t=2:c=red@0.5 drawgrid_400x100.jpg</span><br></pre></td></tr></tbody></table></figure><p>效果图：</p><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/drawgrid_3x3.jpg" alt="Image 1" style="width:calc(50% - 7px);height:300px;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/drawgrid_400x100.jpg" alt="Image 2" style="width:calc(50% - 7px);height:300px;display:block;object-fit:cover;border-radius:4px"></div><hr><h5 id="7-添加字幕-subtitles-或-drawtext"><a href="#7-添加字幕-subtitles-或-drawtext" class="headerlink" title="(7) 添加字幕 (subtitles 或 drawtext)"></a>(7) 添加字幕 (<code>subtitles</code> 或 <code>drawtext</code>)</h5><p>对于视频在线转SRT字幕，推荐<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMW15em9ZMkU2Ti8_c3BtX2lkX2Zyb209MzMzLjMzNy5zZWFyY2gtY2FyZC5hbGwuY2xpY2smdmRfc291cmNlPWEwZDE0ZTA1YjA0MzEzN2IzNmIxZTQxMTZmMDkyNWQ3">离线语音转文字WhisperDesktop1.7魔改版,自带100种语言,安装包4G</a></p><ul><li><p><code>subtitles</code> 滤镜: 用于<strong>烧录</strong>（硬编码）ASS 或 SRT 等格式的<strong>字幕文件</strong>到视频帧上。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 烧录 SRT 字幕，使用默认样式</span></span><br><span class="line">ffmpeg -i input.mp4 -vf subtitles=subtitle.srt output_hardsub.mp4</span><br><span class="line"><span class="comment"># 烧录 ASS 字幕，并强制使用 ASS 文件内定义的样式</span></span><br><span class="line">ffmpeg -i input.mp4 -vf <span class="string">"subtitles=subtitle.ass:force_style='PrimaryColour=&amp;H00FFFFFF&amp;,Fontsize=24'"</span> output_hardsub_styled.mp4</span><br></pre></td></tr></tbody></table></figure></li><li><p><code>drawtext</code> 滤镜: 用于在视频上绘制<strong>动态或静态文本</strong>，可以设置字体、大小、颜色、位置、滚动等，非常灵活，但配置复杂。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在左上角显示时间码</span></span><br><span class="line">ffmpeg -i input.mp4 -vf <span class="string">"drawtext=fontfile=/path/to/font.ttf:text='%{pts\:hms}':x=10:y=10:fontsize=24:fontcolor=yellow"</span> output_timecode.mp4</span><br></pre></td></tr></tbody></table></figure></li></ul><hr><h5 id="8-画边缘-edgedetect"><a href="#8-画边缘-edgedetect" class="headerlink" title="(8) 画边缘 (edgedetect)"></a>(8) 画边缘 (<code>edgedetect</code>)</h5><p><strong>作用:</strong><br>此滤idge]用于检测并绘制图像或视频中的边缘（即像素亮度/颜色发生剧烈变化的地方）。它通常基于 Canny 边缘检测算法。</p><p><strong>参数说明:</strong><br><code>edgedetect=low=L:high=H[:mode=M]</code></p><ul><li><strong><code>low</code>, <code>high</code></strong>: Canny 算法的低阈值和高阈值，范围 <code>[0, 1]</code>，且 <code>low &lt;= high</code>。这两个阈值共同决定了哪些变化被识别为边缘。<strong>阈值越高，检测到的边缘越少</strong>，只有非常明显的边缘才会被保留；<strong>阈值越低，检测到的边缘越多</strong>，可能会包含一些噪音或不重要的细节。需要根据具体图像和需求调整。</li><li><strong><code>mode</code></strong>: 控制输出的模式，常用的有：<ul><li><code>wires</code> (默认): 输出一个黑色背景、白色线条表示边缘的图像。这就是你看到的“线稿”效果。</li><li><code>colormix</code>: 将检测到的边缘（通常为白色）与原始图像的颜色进行混合，产生一种带有彩色边缘描边的效果。</li><li><code>canny</code>: 输出 Canny 算法中间过程产生的灰度边缘强度图。</li></ul></li></ul><p><strong><code>edgedetect</code> 的实际用途:</strong></p><p>你可能会问，只是得到一个“线稿”有什么用？实际上，边缘检测是许多更复杂任务的基础或辅助步骤：</p><ol><li><strong>计算机视觉预处理:</strong> 在进行目标识别、特征提取、图像分割等高级计算机视觉任务前，边缘检测可以<strong>提取图像的关键结构信息</strong>，减少需要处理的数据量，并突出对象的轮廓。</li><li><strong>艺术/风格化效果:</strong> 可以故意使用 <code>wires</code> 模式来创造<strong>素描、卡通、技术绘图</strong>等艺术风格。结合其他滤镜（如与原图叠加、调整颜色等）可以产生更多样的视觉效果。</li></ol><p><strong>命令行示例 (不同模式):</strong></p><ul><li><p><strong>示例 1: <code>wires</code> 模式 (默认 - 线稿效果)</strong><br>使用不同的阈值组合，观察边缘检测的敏感度变化。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 较低阈值，检测更多边缘细节</span></span><br><span class="line">ffmpeg -i 1.png -vf edgedetect=low=0.1:high=0.2 edge_py_1_01_02.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 较高阈值，只保留较强边缘</span></span><br><span class="line">ffmpeg -i 1.png -vf edgedetect=low=0.5:high=0.8 edge_py_2_05_08.jpg</span><br></pre></td></tr></tbody></table></figure><p>效果图：</p><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/edge_py_1_01_02.jpg" alt="Image 1" style="width:calc(50% - 7px);height:300px;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/edge_py_2_05_08.jpg" alt="Image 2" style="width:calc(50% - 7px);height:300px;display:block;object-fit:cover;border-radius:4px"></div></li><li><p><strong>示例 2: <code>colormix</code> 模式 (彩色边缘描边)</strong><br>将边缘信息（白色）与原图颜色混合。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i 1.png -vf edgedetect=low=0.1:high=0.4:mode=colormix edge_py_2_colormix.jpg</span><br></pre></td></tr></tbody></table></figure><p><em>这个命令会生成一个保留了原图大概颜色，但在边缘处有明显白色（或受原色影响的亮色）描边的图像，视觉效果与 <code>wires</code> 完全不同。</em></p></li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/edge_py_2_colormix.jpg" alt="edge_py_2_colormix"></p><hr><h5 id="9-EQ-效果-eq"><a href="#9-EQ-效果-eq" class="headerlink" title="(9) EQ 效果 (eq)"></a>(9) EQ 效果 (<code>eq</code>)</h5><p>调整视频的亮度 (Brightness)、对比度 (Contrast)、饱和度 (Saturation) 和 Gamma。</p><p><strong>参数说明:</strong></p><ul><li><code>brightness</code>: 亮度，范围 <code>[-1.0, 1.0]</code>，默认 0。</li><li><code>contrast</code>: 对比度，范围 <code>[-2.0, 2.0]</code>，默认 1。</li><li><code>saturation</code>: 饱和度，范围 <code>[0.0, 3.0]</code>，默认 1。</li><li><code>gamma</code>: Gamma 值 (整体亮度调整)，范围 <code>[0.1, 10.0]</code>，默认 1。</li><li><code>gamma_r</code>, <code>gamma_g</code>, <code>gamma_b</code>: 分别调整红绿蓝通道的 Gamma。</li><li><code>gamma_weight</code>: Gamma 应用的权重。</li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加亮度 (增加 0.3)</span></span><br><span class="line">ffmpeg -i 1.png -vf <span class="string">"eq=brightness=0.3"</span> output_brightness_p0.3.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 降低亮度 (降低 0.2)</span></span><br><span class="line">ffmpeg -i 1.png -vf <span class="string">"eq=brightness=-0.2"</span> output_brightness_n0.2.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加对比度 (设置为 1.5)</span></span><br><span class="line">ffmpeg -i 1.png -vf <span class="string">"eq=contrast=1.5"</span> output_contrast_p1.5.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 降低对比度 (设置为 0.7)</span></span><br><span class="line">ffmpeg -i 1.png -vf <span class="string">"eq=contrast=0.7"</span> output_contrast_p0.7.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加饱和度 (设置为 1.8，颜色更鲜艳)</span></span><br><span class="line">ffmpeg -i 1.png -vf <span class="string">"eq=saturation=1.8"</span> output_saturation_p1.8.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 降低饱和度 (设置为 0.3，颜色变淡)</span></span><br><span class="line">ffmpeg -i 1.png -vf <span class="string">"eq=saturation=0.3"</span> output_saturation_p0.3.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加 Gamma (设置为 1.6，中间调变亮)</span></span><br><span class="line">ffmpeg -i 1.png -vf <span class="string">"eq=gamma=1.6"</span> output_gamma_p1.6.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 降低红色通道 Gamma (减少红色在高光和中间调的影响，画面偏青/蓝)</span></span><br><span class="line">ffmpeg -i 1.png -vf <span class="string">"eq=gamma_r=0.5"</span> output_gamma_r_p0.5.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加蓝色通道 Gamma (增加蓝色在高光和中间调的影响，画面偏蓝/冷)</span></span><br><span class="line">ffmpeg -i 1.png -vf <span class="string">"eq=gamma_b=1.5"</span> output_gamma_b_p1.5.jpg</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>效果图：</p><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px"><div style="text-align:center"><p style="margin-bottom:5px;font-size:14px">增加亮度 (brightness=0.3)</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/output_brightness_p0.3.jpg" alt="增加亮度" style="width:150px;height:150px;display:block;object-fit:cover;border-radius:4px"></div><div style="text-align:center"><p style="margin-bottom:5px;font-size:14px">降低亮度 (brightness=-0.2)</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/output_brightness_n0.2.jpg" alt="降低亮度" style="width:150px;height:150px;display:block;object-fit:cover;border-radius:4px"></div><div style="text-align:center"><p style="margin-bottom:5px;font-size:14px">增加对比度 (contrast=1.5)</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/output_contrast_p1.5.jpg" alt="增加对比度" style="width:150px;height:150px;display:block;object-fit:cover;border-radius:4px"></div><div style="text-align:center"><p style="margin-bottom:5px;font-size:14px">降低对比度 (contrast=0.7)</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/output_contrast_p0.7.jpg" alt="降低对比度" style="width:150px;height:150px;display:block;object-fit:cover;border-radius:4px"></div><div style="text-align:center"><p style="margin-bottom:5px;font-size:14px">增加饱和度 (saturation=1.8)</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/output_saturation_p1.8.jpg" alt="增加饱和度" style="width:150px;height:150px;display:block;object-fit:cover;border-radius:4px"></div><div style="text-align:center"><p style="margin-bottom:5px;font-size:14px">降低饱和度 (saturation=0.3)</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/output_saturation_p0.3.jpg" alt="降低饱和度" style="width:150px;height:150px;display:block;object-fit:cover;border-radius:4px"></div><div style="text-align:center"><p style="margin-bottom:5px;font-size:14px">增加Gamma (gamma=1.6)</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/output_gamma_p1.6.jpg" alt="增加Gamma" style="width:150px;height:150px;display:block;object-fit:cover;border-radius:4px"></div><div style="text-align:center"><p style="margin-bottom:5px;font-size:14px">降低红色通道 (gamma_r=0.5)</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/output_gamma_r_p0.5.jpg" alt="降低红色通道Gamma" style="width:150px;height:150px;display:block;object-fit:cover;border-radius:4px"></div><div style="text-align:center"><p style="margin-bottom:5px;font-size:14px">增加蓝色通道 (gamma_b=1.5)</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/output_gamma_b_p1.5.jpg" alt="增加蓝色通道Gamma" style="width:150px;height:150px;display:block;object-fit:cover;border-radius:4px"></div></div><hr><h5 id="10-缩放-scale"><a href="#10-缩放-scale" class="headerlink" title="(10) 缩放 (scale)"></a>(10) 缩放 (<code>scale</code>)</h5><p>调整视频或图像的分辨率（尺寸）。</p><p><strong>参数说明:</strong> <code>scale=width:height[:flags=F]</code></p><ul><li><code>width</code>, <code>height</code>: 目标宽度和高度。可以使用 <code>iw</code>, <code>ih</code> (输入宽高) 进行计算，<code>-1</code> 或 <code>-2</code> 表示按比例自动计算（<code>-2</code> 保证结果为偶数）。</li><li><code>flags</code>: 缩放算法（如 <code>bilinear</code>, <code>bicubic</code>, <code>lanczos</code> 等），影响速度和质量。</li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 缩放到固定 200x200 (可能变形)</span></span><br><span class="line">ffmpeg -i 3.png -vf scale=200:200 scale_200x200.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 缩放到宽度 640，高度按比例自动计算</span></span><br><span class="line">ffmpeg -i 3.png -vf scale=640:-2 scale_640w.jpg</span><br></pre></td></tr></tbody></table></figure><p>效果图：</p><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/scale_200x200.jpg" alt="Image 1" style="width:calc(50% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/scale_640w.jpg" alt="Image 2" style="width:calc(50% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"></div><hr><h5 id="11-等比放大-hqx"><a href="#11-等比放大-hqx" class="headerlink" title="(11) 等比放大 (hqx)"></a>(11) 等比放大 (<code>hqx</code>)</h5><p>使用 hqx 算法进行高质量的<strong>整数倍</strong>放大（2x, 3x, 4x）。</p><p><strong>参数说明:</strong> <code>hqx=n=N</code></p><ul><li><code>n</code>: 放大倍数，必须是 2, 3 或 4。</li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 放大 4 倍</span></span><br><span class="line">ffmpeg -i 1.png -vf hqx=n=4 hqx4.jpg</span><br></pre></td></tr></tbody></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/image-20250502214022903.png" alt="image-20250502214022903"></p><hr><h5 id="12-横向倒置-hflip"><a href="#12-横向倒置-hflip" class="headerlink" title="(12) 横向倒置 (hflip)"></a>(12) 横向倒置 (<code>hflip</code>)</h5><p>水平翻转图像或视频（镜像效果）。</p><p><strong>参数说明:</strong> 无。</p><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i 3.png -vf hflip hflip.jpg</span><br></pre></td></tr></tbody></table></figure><p>效果图：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/hflip.jpg" alt="hflip"></p><hr><h5 id="13-纵向倒置-vflip"><a href="#13-纵向倒置-vflip" class="headerlink" title="(13) 纵向倒置 (vflip)"></a>(13) 纵向倒置 (<code>vflip</code>)</h5><p>垂直翻转图像或视频。</p><p><strong>参数说明:</strong> 无。</p><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i 3.png -vf vflip vflip.jpg</span><br></pre></td></tr></tbody></table></figure><p>效果图：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/vflip.jpg" alt="vflip"></p><hr><h5 id="14-加噪音-noise"><a href="#14-加噪音-noise" class="headerlink" title="(14) 加噪音 (noise)"></a>(14) 加噪音 (<code>noise</code>)</h5><p>为视频添加不同类型的噪音。</p><p>其中Y/U/V/S分别指的是☞ Y（亮度）、U（蓝色度差）、V（红色度差）、A（透明度）分量的噪音强度，一般会使用alls或allf，指全部色彩</p><p><strong>参数说明:</strong> <code>noise=alls=S[:allf=F]</code> 或指定分量 <code>ys</code>, <code>us</code>, <code>vs</code>, <code>as</code> 和 <code>yf</code>, <code>uf</code>, <code>vf</code>, <code>af</code>。</p><ul><li><code>alls</code> (或 <code>ys</code>, <code>us</code>…): 噪音强度，范围 <code>[0, 100]</code>，默认 0。</li><li><code>allf</code> (或 <code>yf</code>, <code>uf</code>…): 噪音标志/类型，可以是：<ul><li><code>t</code> (temporal): 随时间变化的噪音。</li><li><code>u</code> (uniform): 空间上均匀但不随时间变化的噪音。</li><li><code>p</code> (pattern): 随时间重复的图案噪音。</li><li><code>a</code> (averaged): 时间上平滑（平均）的图案噪音。</li><li>可以组合，如 <code>t+u</code>。</li></ul></li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 添加强度为 100 的临时+统一噪音</span></span><br><span class="line">ffmpeg -i 2.png -vf noise=alls=100:allf=t+u noise_tu.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 添加强度为 100 的平滑平均噪音</span></span><br><span class="line">ffmpeg -i 2.png -vf noise=alls=100:allf=a noise_a.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 添加强度为 100 的随机图案噪音</span></span><br><span class="line">ffmpeg -i 2.png -vf noise=alls=100:allf=p noise_p.jpg</span><br></pre></td></tr></tbody></table></figure><p>效果图：</p><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/noise_tu.jpg" alt="Image 1" style="width:calc(33.33% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/noise_a.jpg" alt="Image 2" style="width:calc(33.33% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/noise_p.jpg" alt="Image 3" style="width:calc(33.33% - 7px);height:auto;display:block;object-fit:cover;border-radius:4px"></div><hr><h5 id="15-加水印-overlay"><a href="#15-加水印-overlay" class="headerlink" title="(15) 加水印 (overlay)"></a>(15) 加水印 (<code>overlay</code>)</h5><p><strong>作用:</strong></p><p><code>overlay</code> 滤镜是 FFmpeg 中非常常用的一个功能，它的作用是将一个视频流（或图片流，图片会被当作单帧视频）<strong>叠加</strong>到另一个视频流的上方，就像给视频添加“图层”一样。这常用于添加 logo、水印、画中画 (PiP) 等效果。</p><p><strong>核心概念:</strong></p><ul><li><strong>至少需要两个输入:</strong> 一个是主视频流 (背景)，另一个是要叠加的视频/图片流 (前景/水印)。</li><li><strong>复杂滤镜 (<code>-filter_complex</code>):</strong> 因为涉及多个输入流，<code>overlay</code> 通常在 <code>-filter_complex</code> 中使用。</li><li><strong>坐标定位:</strong> 你可以精确控制叠加层（水印）在背景视频上的位置。</li><li><strong>时间控制:</strong> 可以控制叠加层何时出现、何时消失。</li></ul><p><strong>主要参数 (<code>overlay=...</code>):</strong></p><table><thead><tr><th align="left">参数名 (命令行)</th><th align="left">描述</th><th align="left">常用值/表达式示例</th></tr></thead><tbody><tr><td align="left"><code>x=&lt;表达式&gt;</code></td><td align="left">叠加层左上角的 <strong>水平 (X)</strong> 坐标。</td><td align="left"><code>10</code> (左边距 10), <code>main_w-overlay_w-10</code> (右边距 10), <code>(main_w-overlay_w)/2</code> (水平居中)</td></tr><tr><td align="left"><code>y=&lt;表达式&gt;</code></td><td align="left">叠加层左上角的 <strong>垂直 (Y)</strong> 坐标。</td><td align="left"><code>10</code> (上边距 10), <code>main_h-overlay_h-10</code> (下边距 10), <code>(main_h-overlay_h)/2</code> (垂直居中)</td></tr><tr><td align="left"><code>eof_action</code></td><td align="left">当<strong>较短</strong>的那个输入流结束时，如何处理？</td><td align="left"><code>repeat</code> (默认, 对静态图片水印常用，会保持最后一帧), <code>endall</code> (结束整个处理), <code>pass</code> (移除叠加层，保留主视频流)</td></tr><tr><td align="left"><code>shortest</code></td><td align="left">(布尔值 <code>0</code>或<code>1</code>) <strong>注意:</strong> 这个通常作为<strong>输出选项 (<code>-shortest</code>)</strong> 使用。</td><td align="left"><code>-shortest</code> (命令行)</td></tr><tr><td align="left"><code>format</code></td><td align="left">指定内部处理时使用的像素格式，影响是否支持透明度。</td><td align="left"><code>rgb</code>, <code>rgba</code>, <code>yuv420</code>, <code>yuva420p</code> 等</td></tr></tbody></table><p><strong>表达式中可用的变量:</strong></p><ul><li><code>main_w</code>, <code>W</code>: 主视频流（背景）的宽度。</li><li><code>main_h</code>, <code>H</code>: 主视频流（背景）的高度。</li><li><code>overlay_w</code>, <code>w</code>: 叠加层（水印）的宽度。</li><li><code>overlay_h</code>, <code>h</code>: 叠加层（水印）的高度。</li><li><code>t</code>: 当前时间戳 (秒)。</li></ul><p><strong>命令行示例:</strong></p><p><strong>示例 1: 添加静态 PNG 图片水印 (带透明度) 到右下角</strong></p><p>假设 <code>input.mp4</code> 是主视频，<code>logo.png</code> 是带透明背景的水印图片。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -i logo.png \</span><br><span class="line">-filter_complex <span class="string">"[0:v][1:v]overlay=x=main_w-overlay_w-10:y=main_h-overlay_h-10[outv]"</span> \</span><br><span class="line">-map <span class="string">"[outv]"</span> -map 0:a? \</span><br><span class="line">-c:v libx264 -preset fast -c:a copy \</span><br><span class="line">output_watermarked.mp4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对于Windows来说，无法使用 \换行符执行指令，所以只能混在一行，在这里我们还限制了一下图片的大小，避免图片太大</span></span><br><span class="line">ffmpeg -i input.mp4 -i logo.png -filter_complex <span class="string">"[1:v]scale=w=-2:h=60[scaled_logo]; [0:v][scaled_logo]overlay=x=main_w-overlay_w-10:y=main_h-overlay_h-10[outv]"</span> -map <span class="string">"[outv]"</span> -map 0:a? -c:v libx264 -preset fast -c:a copy output_watermarked_scaled.mp4</span><br></pre></td></tr></tbody></table></figure><ul><li><code>-i input.mp4 -i logo.png</code>: 指定两个输入文件。</li><li><code>-filter_complex "[0:v][1:v]overlay=x=main_w-overlay_w-10:y=main_h-overlay_h-10[outv]"</code>:<ul><li><code>[0:v]</code> 代表第一个输入（视频）的视频流。</li><li><code>[1:v]</code> 代表第二个输入（logo）的视频流（图片被当作单帧视频）。</li><li><code>overlay=...</code>: 应用 overlay 滤镜。</li><li><code>x=main_w-overlay_w-10</code>: 设置 x 坐标为 主视频宽度 - logo宽度 - 10像素（右边距10）。</li><li><code>y=main_h-overlay_h-10</code>: 设置 y 坐标为 主视频高度 - logo高度 - 10像素（下边距10）。</li><li><code>[outv]</code>: 将处理后的视频流标记为 <code>outv</code>。</li></ul></li><li><code>-map "[outv]"</code>: 将标记为 <code>outv</code> 的视频流映射到输出。</li><li><code>-map 0:a?</code>: 将第一个输入文件中的音频流（如果存在 <code>?</code>）映射到输出。</li><li><code>-c:v libx264 -preset fast</code>: 对视频进行 H.264 重新编码（烧录水印需要重编码），使用较快的预设。</li><li><code>-c:a copy</code>: 直接复制原始音频流。</li><li><code>output_watermarked.mp4</code>: 输出文件名。</li></ul><p><strong>示例 2: 添加动态 GIF 水印 (循环播放) 到左上角</strong></p><p>假设 <code>input.mp4</code> 是主视频，<code>animated_logo.gif</code> 是动态水印。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意：GIF 作为输入时，需要特殊的输入选项来控制循环</span></span><br><span class="line">ffmpeg -i input.mp4 -ignore_loop 0 -stream_loop -1 -i animated_logo.gif \</span><br><span class="line">-filter_complex <span class="string">"[0:v][1:v]overlay=x=10:y=10:eof_action=repeat[outv]"</span> \</span><br><span class="line">-map <span class="string">"[outv]"</span> -map 0:a? \</span><br><span class="line">-c:v libx264 -preset fast -c:a copy \</span><br><span class="line">output_animated_watermark.mp4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对于Windows来说，无法使用 \换行符执行指令，所以只能混在一行</span></span><br><span class="line">ffmpeg -i input.mp4 -ignore_loop 0 -stream_loop -1 -i animated_logo.gif -filter_complex <span class="string">"[0:v][1:v]overlay=x=10:y=10:eof_action=repeat[outv]"</span> -map <span class="string">"[outv]"</span> -map 0:a? -c:v libx264 -preset fast -c:a copy -shortest output_animated_watermark.mp4</span><br></pre></td></tr></tbody></table></figure><ul><li><code>-ignore_loop 0</code>: <strong>输入选项 (针对 GIF)</strong>，告诉 FFmpeg <strong>不要</strong>忽略 GIF 文件内部定义的循环次数（如果 GIF 本身只循环几次，这个选项会让它按原样播放）。如果 GIF 本身是无限循环的，此选项影响不大。</li><li><code>-stream_loop -1</code>: <strong>输入选项 (针对 GIF)</strong>，告诉 FFmpeg 在 GIF 播放完<strong>一次</strong>后，<strong>无限循环</strong>地重新读取 GIF 输入流。这确保了即使 GIF 本身时长很短，它也会在整个视频时长内持续显示。如果想让 GIF 只播放一次然后消失，可以将 <code>eof_action</code> 设为 <code>pass</code> 并且<strong>不使用</strong> <code>-stream_loop -1</code> (或者结合 <code>-shortest</code> 输出选项)。</li><li><code>-filter_complex "[0:v][1:v]overlay=x=10:y=10:eof_action=repeat[outv]"</code>:<ul><li><code>x=10:y=10</code>: 将 GIF 放在左上角（边距 10）。</li><li><code>eof_action=repeat</code>: 当 GIF 流结束时（如果 <code>-stream_loop</code> 不是 <code>-1</code>），保持其最后一帧。由于我们用了 <code>-stream_loop -1</code>，这个参数在这里影响不大。</li></ul></li><li>其他 <code>-map</code>, <code>-c:v</code>, <code>-c:a</code> 参数同上。</li><li><code>-shortest</code>：这个选项告诉 FFmpeg：“当所有输入流中，<strong>最短</strong>的那个流结束时，就结束整个输出文件。” 在你的例子中，<code>input.mp4</code> 是有限时长的（比如 1 分多钟），而无限循环的 GIF 被视为无限时长，所以 <code>-shortest</code> 会让输出在 <code>input.mp4</code> 播放完毕时自动停止。</li></ul><p><strong>示例三：添加固定尺寸 (64x64) 且位置随机飘动的动态水印</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -ignore_loop 0 -stream_loop -1 -i animated_logo.gif -filter_complex <span class="string">"[1:v]scale=h=64:w=-2[scaled_logo];[0:v][scaled_logo]overlay=x='if(eq(mod(trunc(t*50/(main_w-overlay_w))\,2)\,0)\,mod(t*50\,main_w-overlay_w)\,main_w-overlay_w-mod(t*50\,main_w-overlay_w))':y='if(eq(mod(trunc(t*50/(main_h-overlay_h))\,2)\,0)\,mod(t*50\,main_h-overlay_h)\,main_h-overlay_h-mod(t*50\,main_h-overlay_h))'[outv]"</span> -map <span class="string">"[outv]"</span> -map 0:a? -c:v libx264 -preset fast -c:a copy -</span><br><span class="line">shortest output_bouncing_escaped.mp4</span><br></pre></td></tr></tbody></table></figure><hr><h5 id="16-加底板-画布扩展-pad"><a href="#16-加底板-画布扩展-pad" class="headerlink" title="(16) 加底板/画布扩展 (pad)"></a>(16) 加底板/画布扩展 (<code>pad</code>)</h5><p>扩展视频或图像的画布尺寸，并可以用指定颜色填充新增区域。常用于需要固定输出尺寸或添加边框背景的场景。</p><p><strong>参数说明:</strong> <code>pad=width=W:height=H[:x=X][:y=Y][:color=C]</code></p><ul><li><code>width</code>, <code>height</code>: 输出画布的<strong>总宽度</strong>和<strong>总高度</strong>。必须大于等于输入尺寸。</li><li><code>x</code>, <code>y</code>: <strong>输入图像</strong>在输出画布上的左上角坐标。默认居中 <code>(ow-iw)/2:(oh-ih)/2</code>。</li><li><code>color</code>: 填充扩展区域的颜色，默认黑色。</li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 将 2.jpg 放到一个 800x800 的紫色底板上，原图放在 (40, 40) 的位置</span></span><br><span class="line">ffmpeg -i 3.png -vf pad=width=800:height=800:x=40:y=40:color=violet pad_violet.jpg</span><br></pre></td></tr></tbody></table></figure><p>效果图：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/pad_violet.jpg" alt="pad_violet"></p><hr><h5 id="17-旋转-rotate"><a href="#17-旋转-rotate" class="headerlink" title="(17) 旋转 (rotate)"></a>(17) 旋转 (<code>rotate</code>)</h5><p>按指定角度旋转视频（围绕中心点）。</p><p><strong>参数说明:</strong> <code>rotate=angle=A[:out_w=OW][:out_h=OH][:bilinear=B]</code></p><ul><li><code>angle</code> 或 <code>a</code>: 旋转角度。<strong>注意：单位是弧度 (Radians)</strong>。可以使用 <code>PI</code> 常量和数学表达式。顺时针为负，逆时针为正。例如 <code>PI/6</code> (30度), <code>-PI/2</code> (-90度)。要使用角度需转换：<code>angle=45*PI/180</code>。</li><li><code>out_w</code>, <code>out_h</code>: (可选) 输出的宽度和高度，默认与输入相同。旋转后图像可能会超出原边界，可以用 <code>ow='hypot(iw,ih)'</code> 来设置足够大的画布。</li><li><code>bilinear</code>: 是否使用双线性插值 (0 或 1)，默认 1 (使用)。</li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 逆时针旋转 PI/6 弧度 (30度)</span></span><br><span class="line">ffmpeg -i 1.png -vf rotate=angle=PI/6 rotate_30deg.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment">## 顺时针旋转 90 度</span></span><br><span class="line">ffmpeg -i 1.png -vf rotate=angle=-PI/2 rotate_neg90deg.jpg</span><br></pre></td></tr></tbody></table></figure><p>效果图：</p><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/rotate_30deg.jpg" alt="Image 1" style="width:calc(50% - 7px);height:300px;display:block;object-fit:cover;border-radius:4px"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="./assets/rotate_neg90deg.jpg" alt="Image 2" style="width:calc(50% - 7px);height:300px;display:block;object-fit:cover;border-radius:4px"></div><hr><h5 id="18-光晕-晕影-vignette"><a href="#18-光晕-晕影-vignette" class="headerlink" title="(18) 光晕/晕影 (vignette)"></a>(18) 光晕/晕影 (<code>vignette</code>)</h5><p>在图像或视频边缘添加暗角（或亮角）效果。</p><p><strong>参数说明:</strong> <code>vignette=angle=A[:x0=X][:y0=Y][:mode=M][:eval=E]</code></p><ul><li><code>angle</code> 或 <code>a</code>: 控制光晕形状的角度表达式（单位：弧度）。常用 <code>PI/4</code> (圆形) 或 <code>PI/5</code>。</li><li><code>x0</code>, <code>y0</code>: 光晕中心的相对坐标（0 到 1），默认 0.5 (中心)。</li><li><code>mode</code>: 模式 (<code>backward</code>, <code>forward</code>)。</li><li><code>eval</code>: 评估模式 (<code>init</code>, <code>frame</code>)。</li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 添加一个圆形暗角</span></span><br><span class="line">ffmpeg -i 1.png -vf vignette=angle=PI/4 vignette_circle.jpg</span><br></pre></td></tr></tbody></table></figure><p>效果图：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/assets/vignette_circle.jpg" alt="vignette_circle"></p><hr><h5 id="19-淡入淡出-fade-afade"><a href="#19-淡入淡出-fade-afade" class="headerlink" title="(19) 淡入淡出 (fade, afade)"></a>(19) 淡入淡出 (<code>fade</code>, <code>afade</code>)</h5><p>作用:</p><p>为视频 (fade) 或音频 (afade) 添加淡入 (Fade In) 或淡出 (Fade Out) 效果。这在视频开头、结尾或者场景切换时非常常用。</p><p><strong>主要参数:</strong></p><ul><li><p>type或 t: 指定淡入淡出类型。</p><ul><li><code>in</code>: 淡入效果。</li><li><code>out</code>: 淡出效果。</li></ul></li><li><p><code>start_time</code> 或 <code>st</code>: 效果<strong>开始</strong>的时间点（单位：秒）。对于淡入，通常是 <code>0</code>；对于淡出，需要计算好（视频总时长 - 淡出时长）。</p></li><li><p><code>duration</code> 或 <code>d</code>: 效果<strong>持续</strong>的时长（单位：秒）。</p></li><li><p><code>color</code> 或 <code>c</code> (仅 <code>fade</code>): 指定淡入/淡出的目标颜色，默认是黑色。例如 <code>color=white</code> 可以实现淡入自白色或淡出至白色。</p></li><li><p><code>alpha</code>: 值为 <code>1</code> 时，只对 alpha 透明通道应用淡入淡出，可用于实现透明度的渐变。默认 <code>0</code>。</p></li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例 1: 视频前 2 秒从黑色淡入，最后 3 秒淡出到黑色 (假设视频总长 35 秒)</span></span><br><span class="line">ffmpeg -i input.mp4 -vf <span class="string">"fade=type=in:start_time=0:duration=2, fade=type=out:start_time=32:duration=3"</span> -c:a copy output_video_fade.mp4</span><br><span class="line"><span class="comment"># -vf "...": 应用视频滤镜链。</span></span><br><span class="line"><span class="comment">#   fade=type=in:start_time=0:duration=2: 第一个 fade 滤镜，类型为 in (淡入)，从第 0 秒开始，持续 2 秒。</span></span><br><span class="line"><span class="comment">#   , : 滤镜链分隔符。</span></span><br><span class="line"><span class="comment">#   fade=type=out:start_time=32:duration=3: 第二个 fade 滤镜，类型为 out (淡出)，从第 32 秒开始 (35-3=32)，持续 3 秒。</span></span><br><span class="line"><span class="comment"># -c:a copy: 音频直接复制。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例 2: 音频在最后 5 秒淡出 (假设音频总长 60 秒)</span></span><br><span class="line">ffmpeg -i input.mp3 -af <span class="string">"afade=type=out:start_time=55:duration=5"</span> output_audio_fade.mp3</span><br><span class="line"><span class="comment"># -af "...": 应用音频滤镜。</span></span><br><span class="line"><span class="comment">#   afade=type=out:start_time=55:duration=5: 音频淡出，从 55 秒开始，持续 5 秒。</span></span><br></pre></td></tr></tbody></table></figure><hr><h5 id="20-旋转-90-180-270-度-transpose"><a href="#20-旋转-90-180-270-度-transpose" class="headerlink" title="(20) 旋转 90/180/270 度 (transpose)"></a>(20) 旋转 90/180/270 度 (<code>transpose</code>)</h5><p>作用:</p><p>对视频进行精确的 90 度倍数旋转或翻转。相比于 rotate 滤镜（它允许任意角度旋转但可能涉及复杂的插值和画布调整），transpose 对于标准的 90 度旋转更简单、更常用，且通常效率更高。</p><p><strong>主要参数:</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transpose=&lt;方向值&gt;</span><br></pre></td></tr></tbody></table></figure><ul><li><code>0</code>: 逆时针旋转 90 度并垂直翻转。</li><li><code>1</code> 或 <code>clock</code>: <strong>顺时针</strong>旋转 90 度。 <strong>(常用)</strong></li><li><code>2</code> 或 <code>cclock</code>: <strong>逆时针</strong>旋转 90 度。 <strong>(常用)</strong></li><li><code>3</code> 或 <code>clock_flip</code>: 顺时针旋转 90 度并垂直翻转。</li><li>(还有 <code>cclock_flip</code> 等)</li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将视频顺时针旋转 90 度 (例如，竖屏拍的视频转成横屏)</span></span><br><span class="line">ffmpeg -i portrait_video.mp4 -vf <span class="string">"transpose=1"</span> -c:a copy output_rotated_cw.mp4</span><br><span class="line"><span class="comment"># -vf "transpose=1": 应用 transpose 滤镜，参数 1 表示顺时针旋转 90 度。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将视频逆时针旋转 90 度</span></span><br><span class="line">ffmpeg -i portrait_video.mp4 -vf <span class="string">"transpose=2"</span> -c:a copy output_rotated_ccw.mp4</span><br><span class="line"><span class="comment"># -vf "transpose=2": 参数 2 表示逆时针旋转 90 度。</span></span><br></pre></td></tr></tbody></table></figure><hr><h5 id="21-改变播放速度-setpts-atempo"><a href="#21-改变播放速度-setpts-atempo" class="headerlink" title="(21) 改变播放速度 (setpts, atempo)"></a>(21) 改变播放速度 (<code>setpts</code>, <code>atempo</code>)</h5><p>作用:</p><p>改变视频 (setpts) 或音频 (atempo) 的播放速度，实现快放或慢放效果。</p><ul><li><strong><code>setpts=&lt;表达式&gt;</code> (视频):</strong> 通过<strong>修改视频帧的显示时间戳 (Presentation Timestamp)</strong> 来改变速度。</li><li><strong><code>atempo=&lt;倍数&gt;</code> (音频):</strong> 调整音频的播放速度，同时<strong>尽量保持音高不变</strong>（这是它与简单地改变采样率或 <code>asetpts</code> 的主要区别）。</li></ul><p><strong>主要参数/表达式:</strong></p><ul><li><code>setpts</code> 表达式:<ul><li><code>PTS/N</code>: 将播放速度提高 N 倍 (例如 <code>PTS/2</code> 是 2 倍速)。</li><li><code>PTS*N</code>: 将播放速度减慢 N 倍 (例如 <code>PTS*2</code> 是 0.5 倍速)。</li><li><code>PTS-STARTPTS</code>: 让时间戳从 0 开始（有时用于修复时间码问题）。</li></ul></li><li><code>atempo</code> 倍数:<ul><li><code>1.0</code> 是原速。</li><li><code>2.0</code> 是 2 倍速。</li><li><code>0.5</code> 是 0.5 倍速 (慢放)。</li><li><strong>注意:</strong> <code>atempo</code> 滤镜接受的倍数范围有限制 (通常在 0.5 到 100.0 之间)。对于超出范围的速度调整，可以<strong>链式调用</strong>多个 <code>atempo</code> 滤镜 (例如 <code>atempo=2.0,atempo=2.0</code> 实现 4 倍速)。</li></ul></li></ul><p><strong>重要:</strong> 改变视频速度时，通常需要<strong>同时改变音频速度</strong>以保持音画同步。因此 <code>setpts</code> 和 <code>atempo</code> 常常在 <code>-filter_complex</code> 中配合使用。</p><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例 1: 将视频和音频都加速到 1.5 倍速</span></span><br><span class="line">ffmpeg -i input.mp4 -filter_complex <span class="string">"[0:v]setpts=PTS/1.5[v];[0:a]atempo=1.5[a]"</span> -map <span class="string">"[v]"</span> -map <span class="string">"[a]"</span> output_fast_1.5x.mp4</span><br><span class="line"><span class="comment"># -filter_complex "...": 定义复杂滤镜图。</span></span><br><span class="line"><span class="comment">#   [0:v]setpts=PTS/1.5[v]: 将输入视频流 [0:v] 的 PTS 除以 1.5 (加速)，标记输出为 [v]。</span></span><br><span class="line"><span class="comment">#   [0:a]atempo=1.5[a]: 将输入音频流 [0:a] 的速度提高 1.5 倍，标记输出为 [a]。</span></span><br><span class="line"><span class="comment"># -map "[v]" -map "[a]": 将处理后的音视频流映射到输出。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例 2: 将视频和音频都减慢到 0.75 倍速</span></span><br><span class="line">ffmpeg -i input.mp4 -filter_complex <span class="string">"[0:v]setpts=PTS*(1/0.75)[v];[0:a]atempo=0.75[a]"</span> -map <span class="string">"[v]"</span> -map <span class="string">"[a]"</span> output_slow_0.75x.mp4</span><br><span class="line"><span class="comment"># setpts=PTS*(1/0.75): 将 PTS 乘以约 1.333，实现 0.75 倍慢放。</span></span><br><span class="line"><span class="comment"># atempo=0.75: 音频速度变为 0.75 倍。</span></span><br></pre></td></tr></tbody></table></figure><hr><h5 id="22-绘制文本-drawtext-详解"><a href="#22-绘制文本-drawtext-详解" class="headerlink" title="(22) 绘制文本 (drawtext) 详解"></a>(22) 绘制文本 (<code>drawtext</code>) 详解</h5><p>作用:</p><p>在视频帧上绘制静态或动态文本，功能非常强大，可以控制字体、大小、颜色、位置、背景框、滚动、时间显示等。</p><p><strong>主要参数 (非常多，仅列举常用):</strong></p><ul><li><code>fontfile=&lt;字体文件路径&gt;</code>: <strong>必需</strong> (除非系统配置了默认字体且 FFmpeg 能找到)，指定 TrueType (.ttf) 或 OpenType (.otf) 字体文件的路径。路径中若有特殊字符或空格，需要恰当引用或转义。</li><li><code>text=&lt;文本内容&gt;</code>: 要绘制的文本字符串。可以包含<strong>变量</strong>（如时间码、帧号、元数据）和<strong>表达式</strong>。例如 <code>text='Frame %{frame_num}'</code> 或 <code>text='%{pts\:hms}'</code> (显示 HH:MM:SS.ms 格式时间码)。特殊字符需要转义。</li><li><code>x=&lt;表达式&gt;</code>: 文本左上角的<strong>水平 (X) 坐标</strong>。可以使用 <code>w</code>, <code>h</code> (视频宽高), <code>tw</code>, <code>th</code> (文本宽高), <code>line_h</code> (行高) 等变量。例如 <code>(w-tw)/2</code> (水平居中)。</li><li><code>y=&lt;表达式&gt;</code>: 文本左上角的<strong>垂直 (Y) 坐标</strong>。例如 <code>h-th-10</code> (下边距 10)。</li><li><code>fontsize=&lt;大小&gt;</code>: 字体大小（像素）。</li><li><code>fontcolor=&lt;颜色&gt;</code>: 字体颜色 (颜色名如 <code>white</code>, <code>yellow</code>, 或十六进制 <code>0xFF0000</code>, 或表达式)。</li><li><code>box=&lt;1或0&gt;</code>: 是否绘制背景框，<code>1</code> 表示绘制，<code>0</code> (默认) 不绘制。</li><li><code>boxcolor=&lt;颜色&gt;[@透明度]</code>: 背景框颜色和可选透明度 (如 <code>black@0.5</code>)。</li><li><code>boxborderw=&lt;宽度&gt;</code>: 背景框边框的宽度。</li><li><code>shadowx</code>, <code>shadowy</code>: 文字阴影的 X, Y 偏移。</li><li><code>shadowcolor</code>: 阴影颜色。</li><li><code>enable='&lt;表达式&gt;'</code>: <strong>条件渲染</strong>！只有当表达式求值为非零时，才绘制文本。例如 <code>enable='between(t,5,10)'</code> 表示只在视频时间 5 到 10 秒之间显示文本。</li></ul><p><strong>命令行示例 (来自你的笔记):</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例 1: 左右滚动的字幕 (需要根据你的字体路径修改 fontfile)</span></span><br><span class="line"><span class="comment"># 这个 x 表达式实现了从右向左滚动的效果，50 控制速度</span></span><br><span class="line">ffmpeg -i input.mp4 -vf <span class="string">"drawtext=fontfile=/path/to/your/font.ttf:fontcolor=0xaaff00:fontsize=18:shadowy=0:x='if(gte(t,2), (main_w-mod(t*50,main_w+text_w)), NAN)':y=(main_h-line_h-10):text='关注广州小程，提升专业技能。'"</span> -b:v 500k -c:a copy output_scrolling.mp4</span><br><span class="line"><span class="comment"># 注：x 表达式中的 NAN 表示在 t&lt;2 时不绘制 (移出画面)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例 2: 固定位置的两行字幕 (需要根据你的字体路径修改 fontfile)</span></span><br><span class="line">ffmpeg -i input.mp4 -vf <span class="string">"drawtext=fontfile=/path/to/your/HeiTi.ttf:fontcolor=yellow:fontsize=20:shadowy=0:x=(w-tw)/2:y=main_h-line_h-50:text='关注广州小程', drawtext=fontfile=/path/to/your/YaHei.ttf:fontcolor=0xaaff00:fontsize=18:shadowy=0:x=(w-tw)/2:y=main_h-line_h-20:text='提升专业技能。'"</span> -b:v 500k -c:a copy output_static_lines.mp4</span><br><span class="line"><span class="comment"># 注：用逗号分隔两个 drawtext 滤镜实例来实现多行/多样式文本</span></span><br></pre></td></tr></tbody></table></figure><hr><h5 id="23-视频堆叠-hstack-vstack-xstack"><a href="#23-视频堆叠-hstack-vstack-xstack" class="headerlink" title="(23) 视频堆叠 (hstack, vstack, xstack)"></a>(23) 视频堆叠 (<code>hstack</code>, <code>vstack</code>, <code>xstack</code>)</h5><p>作用:</p><p>将多个视频输入水平 (hstack)、垂直 (vstack) 或按自定义网格 (xstack) 布局拼接在一起，形成一个更大的视频画面。这在制作对比视频、画中画（另一种方式）或多画面监控展示时非常有用。这需要使用 -filter_complex。</p><p><strong>主要参数:</strong></p><ul><li><p><code>hstack</code>, <code>vstack</code>:</p><ul><li><code>inputs=&lt;N&gt;</code>: 指定要堆叠的视频输入流的数量。<strong>必需</strong>。</li><li><code>shortest=&lt;0|1&gt;</code>: 设为 <code>1</code> 时，输出时长以最短的那个输入流为准。默认 <code>0</code>。</li></ul></li><li><p><code>xstack</code>:</p><p>(更复杂，用于网格布局)</p><ul><li><code>inputs=&lt;N&gt;</code>: 输入流数量。</li><li><code>layout=&lt;布局字符串&gt;</code>: 定义网格布局，例如 <code>0_0|w0_0|0_h0|w0_h0</code> 表示 2x2 网格。</li><li><code>shortest=&lt;0|1&gt;</code>: 同上。</li><li><code>fill=&lt;颜色&gt;</code>: 当布局尺寸大于输入流总尺寸时，用指定颜色填充空白区域。</li></ul></li></ul><p><strong>注意:</strong></p><ul><li>默认情况下，<code>hstack</code>/<code>vstack</code> 要求所有输入视频具有<strong>相同的高度</strong>（对于 <code>hstack</code>）或<strong>相同的宽度</strong>（对于 <code>vstack</code>）。如果尺寸不同，你需要先用 <code>scale</code> 滤镜统一尺寸。</li><li><code>xstack</code> 则会自动将所有输入缩放到网格单元允许的最大尺寸。</li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例 1: 水平并排拼接两个视频 (左右排列)</span></span><br><span class="line"><span class="comment"># 假设 left.mp4 和 right.mp4 分辨率相同</span></span><br><span class="line">ffmpeg -i left.mp4 -i right.mp4 \</span><br><span class="line">-filter_complex <span class="string">"[0:v][1:v]hstack=inputs=2[outv]"</span> \</span><br><span class="line">-map <span class="string">"[outv]"</span> -map 0:a? -c:a copy \</span><br><span class="line">output_hstack.mp4</span><br><span class="line"><span class="comment"># [0:v][1:v]: 选择两个输入的视频流。</span></span><br><span class="line"><span class="comment"># hstack=inputs=2: 应用水平堆叠滤镜，指明有两个输入。</span></span><br><span class="line"><span class="comment"># [outv]: 标记输出视频流。</span></span><br><span class="line"><span class="comment"># -map "[outv]" -map 0:a?: 映射处理后的视频和第一个输入的音频。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例 2: 垂直上下拼接两个视频 (需要先统一宽度)</span></span><br><span class="line">ffmpeg -i top.mp4 -i bottom.mp4 \</span><br><span class="line">-filter_complex \</span><br><span class="line"><span class="string">"[0:v]scale=w=640:h=-2[top_scaled]; \</span></span><br><span class="line"><span class="string"> [1:v]scale=w=640:h=-2[bottom_scaled]; \</span></span><br><span class="line"><span class="string"> [top_scaled][bottom_scaled]vstack=inputs=2[outv]"</span> \</span><br><span class="line">-map <span class="string">"[outv]"</span> -map 0:a? -c:a copy \</span><br><span class="line">output_vstack.mp4</span><br><span class="line"><span class="comment"># 先用 scale 将两个视频宽度统一为 640 (高度自适应偶数)。</span></span><br><span class="line"><span class="comment"># 再用 vstack 将缩放后的流垂直堆叠。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例 3: 将四个视频排列成 2x2 网格</span></span><br><span class="line">ffmpeg -i input1.mp4 -i input2.mp4 -i input3.mp4 -i input4.mp4 \</span><br><span class="line">-filter_complex \</span><br><span class="line"><span class="string">"xstack=inputs=4:layout=0_0|w0_0|0_h0|w0_h0[outv]"</span> \</span><br><span class="line">-map <span class="string">"[outv]"</span> -map 0:a? -c:a copy \</span><br><span class="line">output_xstack_2x2.mp4</span><br><span class="line"><span class="comment"># xstack=inputs=4: 指定 4 个输入。</span></span><br><span class="line"><span class="comment"># layout=0_0|w0_0|0_h0|w0_h0: 定义 2x2 布局。</span></span><br><span class="line"><span class="comment">#   0_0: 第一个视频放在左上角 (0,0)。</span></span><br><span class="line"><span class="comment">#   w0_0: 第二个视频放在第一个视频右边 (x=第一个视频宽度, y=0)。</span></span><br><span class="line"><span class="comment">#   0_h0: 第三个视频放在第一个视频下方 (x=0, y=第一个视频高度)。</span></span><br><span class="line"><span class="comment">#   w0_h0: 第四个视频放在右下角。</span></span><br></pre></td></tr></tbody></table></figure><hr><h5 id="24-锐化-unsharp-smartblur"><a href="#24-锐化-unsharp-smartblur" class="headerlink" title="(24) 锐化 (unsharp, smartblur)"></a>(24) 锐化 (<code>unsharp</code>, <code>smartblur</code>)</h5><p>作用:</p><p>提高图像或视频的清晰度，突出细节。有多种锐化滤镜，unsharp (反锐化掩模) 是其中常用的一种，效果比较自然。smartblur 则可以在模糊的同时保留边缘（也可用于轻微锐化）。</p><p><strong>主要参数 (<code>unsharp</code>):</strong></p><ul><li><code>luma_msize_x</code> 或 <code>lx</code>: Luma (亮度) 矩阵的水平大小 (奇数, 3-63, 默认 5)。</li><li><code>luma_msize_y</code> 或 <code>ly</code>: Luma 矩阵的垂直大小 (奇数, 3-63, 默认 5)。</li><li><code>luma_amount</code> 或 <code>la</code>: Luma 锐化/模糊的强度。<strong>正值锐化，负值模糊</strong>。范围 <code>[-1.5, 1.5]</code>，默认 <code>1.0</code> (轻微锐化)。值越大锐化越强。</li><li><code>chroma_msize_x</code>/<code>cx</code>, <code>chroma_msize_y</code>/<code>cy</code>, <code>chroma_amount</code>/<code>ca</code>: 对应 Chroma (色度) 通道的参数，用法同 Luma。通常调整 Luma 即可。</li></ul><p><strong>命令行示例:</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例 1: 应用中等强度的锐化 (使用 5x5 矩阵，亮度强度 0.8)</span></span><br><span class="line">ffmpeg -i input.mp4 -vf <span class="string">"unsharp=lx=5:ly=5:la=0.8"</span> -c:a copy output_unsharp_medium.mp4</span><br><span class="line"><span class="comment"># lx=5:ly=5: 使用 5x5 的分析矩阵。</span></span><br><span class="line"><span class="comment"># la=0.8: 设置亮度锐化强度为 0.8 (比默认 1.0 稍弱)。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例 2: 应用更强的锐化 (使用 7x7 矩阵，亮度强度 1.2)</span></span><br><span class="line">ffmpeg -i input.mp4 -vf <span class="string">"unsharp=lx=7:ly=7:la=1.2"</span> -c:a copy output_unsharp_strong.mp4</span><br><span class="line"><span class="comment"># lx=7:ly=7: 使用更大的分析矩阵，可能影响更多细节。</span></span><br><span class="line"><span class="comment"># la=1.2: 设置更高的锐化强度。</span></span><br></pre></td></tr></tbody></table></figure><ul><li><strong>注意:</strong> 过度锐化会导致图像出现噪点、光晕（halos）和不自然的边缘，需要适度调整参数。</li></ul><hr><h4 id="17-2-3-流标识符-Stream-Specifiers-详解"><a href="#17-2-3-流标识符-Stream-Specifiers-详解" class="headerlink" title="17.2.3 流标识符 (Stream Specifiers) 详解"></a>17.2.3 流标识符 (Stream Specifiers) 详解</h4><p>为了精确地对多媒体文件中的特定流进行操作，需要使用流标识符。</p><table><thead><tr><th align="left">标识符</th><th align="left">含义</th><th align="left">示例用法</th><th align="left"><code>ffmpeg-python</code> 对应 (概念)</th></tr></thead><tbody><tr><td align="left"><code>v</code></td><td align="left">文件中所有的视频流</td><td align="left"><code>-vn</code> (禁用视频), <code>-map v</code></td><td align="left"><code>in_node['v']</code> (通常指第一个)</td></tr><tr><td align="left"><code>a</code></td><td align="left">文件中所有的音频流</td><td align="left"><code>-an</code> (禁用音频), <code>-map a</code></td><td align="left"><code>in_node['a']</code> (通常指第一个)</td></tr><tr><td align="left"><code>s</code></td><td align="left">文件中所有的字幕流</td><td align="left"><code>-sn</code> (禁用字幕), <code>-map s?</code></td><td align="left"><code>in_node['s']</code> (通常指第一个)</td></tr><tr><td align="left"><code>N</code> (数字)</td><td align="left">文件中<strong>绝对索引</strong>为 N 的流 (从 0 开始)</td><td align="left"><code>-map 0:1</code> (映射文件 0 的流 1)</td><td align="left"><code>in_node[1]</code></td></tr><tr><td align="left"><code>v:N</code></td><td align="left">文件中第 N+1 个<strong>视频</strong>流 (索引从 0 开始)</td><td align="left"><code>-c:v:0 libx264</code> (设置第 1 个视频流编码)</td><td align="left"><code>in_node['v:0']</code> 或 <code>in_node.video</code></td></tr><tr><td align="left"><code>a:N</code></td><td align="left">文件中第 N+1 个<strong>音频</strong>流 (索引从 0 开始)</td><td align="left"><code>-b:a:1 192k</code> (设置第 2 个音频流码率)</td><td align="left"><code>in_node['a:1']</code></td></tr><tr><td align="left"><code>s:N</code></td><td align="left">文件中第 N+1 个<strong>字幕</strong>流 (索引从 0 开始)</td><td align="left"><code>-map 0:s:0</code> (映射文件 0 的第 1 个字幕)</td><td align="left"><code>in_node['s:0']</code></td></tr><tr><td align="left"><code>i:STREAM_ID</code></td><td align="left">(较新版本) 根据流的<strong>唯一 ID</strong> 选择</td><td align="left"><code>-map i:137</code></td><td align="left">(需手动过滤)</td></tr><tr><td align="left"><code>p:PROGRAM_ID[:STREAM_SPEC]</code></td><td align="left">(较新版本) 根据<strong>节目 ID</strong> 选择 (用于 TS 流等)</td><td align="left"><code>-map p:101</code> 或 <code>-map p:101:v</code></td><td align="left">(需手动过滤)</td></tr><tr><td align="left"><code>m:key[:value]</code></td><td align="left">根据流的<strong>元数据</strong>选择</td><td align="left"><code>-map m:language:eng</code></td><td align="left">(需手动过滤)</td></tr></tbody></table><p>在 <code>ffmpeg-python</code> 中，我们主要通过字典访问方式（如 <code>in_node['a:1']</code>）来选择流。</p><p>想象一下，一个多媒体文件（比如一个 <code>.mkv</code> 或 <code>.mp4</code> 文件）就像一个<strong>大包裹</strong>。这个包裹里可能装了很多东西，这些东西就是<strong>流 (Stream)</strong>：</p><ul><li>可能有一段<strong>视频画面</strong> (Video Stream)</li><li>可能<strong>不止一段</strong>音频：比如一条是电影原声<strong>普通话</strong> (Audio Stream 0)，一条是<strong>粤语</strong>配音 (Audio Stream 1)，还有一条是<strong>导演评论</strong>音轨 (Audio Stream 2)。</li><li>可能还有几条<strong>字幕</strong>：一条是<strong>中文字幕</strong> (Subtitle Stream 0)，一条是<strong>英文字幕</strong> (Subtitle Stream 1)。</li></ul><p><strong>FFmpeg 的默认行为 (没有流标识符时):</strong></p><p>如果你只给 FFmpeg 一个简单的命令，比如 <code>ffmpeg -i input.mkv output.mp4</code>，它会尝试自己做决定，从 <code>input.mkv</code> 里选一些流放到 <code>output.mp4</code> 里。它通常会：</p><ul><li>选<strong>一个</strong>它认为“最好”的视频流（比如分辨率最高的那个）。</li><li>选<strong>一个</strong>它认为“最好”的音频流（比如声道数最多的那个）。</li><li>可能还会选<strong>一个</strong>字幕流（比如第一个）。</li></ul><p><strong>问题来了：</strong></p><ul><li>如果 <code>input.mkv</code> 里有国语和粤语两条音轨，但 FFmpeg 默认选了粤语，而你其实想要国语的，怎么办？</li><li>如果你想把国语和粤语<strong>两条音轨都保留</strong>在输出文件 <code>output.mp4</code> 里，怎么办？</li><li>如果你只想提取视频，<strong>完全不要</strong>任何音频和字幕，怎么办？</li><li>如果你有两个输入文件，想用第一个文件的视频配上第二个文件的音频，怎么办？</li></ul><p><strong>流标识符的作用：精确的“指名道姓”</strong></p><p>这时候，<strong>流标识符</strong>就派上用场了！它就像给包裹里的每一样东西（每个流）都编上号或者打上标签，让你能够<strong>精确地告诉 FFmpeg 你要对哪个具体的东西进行操作</strong>。</p><p>它最常用的地方是配合 <strong><code>-map</code> 输出选项</strong>：</p><ul><li><p><strong><code>-map</code> 的作用:</strong> 这个选项用来<strong>手动指定</strong>哪些流应该被包含在<strong>输出文件</strong>中。一旦你使用了 <code>-map</code>，FFmpeg 就不再使用默认规则去猜了，<strong>只有你明确 <code>-map</code> 指定的流才会被输出</strong>。</p></li><li><p>配合流标识符:</p><ul><li><pre><code class="language-bash">ffmpeg -i input.mkv -map 0:v:0 -map 0:a:1 -c copy output.mp4
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - `-map 0:v:0`: 告诉 FFmpeg，选择第一个输入文件 (`0`) 的第一个视频流 (`v:0`)。</span><br><span class="line">  - `-map 0:a:1`: 告诉 FFmpeg，选择第一个输入文件 (`0`) 的第二个音频流 (`a:1`)（假设这是粤语音轨）。</span><br><span class="line">  - `-c copy`: 直接复制选中的流。</span><br><span class="line">  - 结果 `output.mp4` 就只包含指定的那个视频流和粤语音轨。</span><br><span class="line"></span><br><span class="line">- ```bash</span><br><span class="line">  ffmpeg -i input.mkv -map 0:v -map 0:a -c copy output_va.mkv</span><br></pre></td></tr></tbody></table></figure>

- `-map 0:v`: 选择第一个输入的所有视频流。
- `-map 0:a`: 选择第一个输入的所有音频流。
- 结果 `output_va.mkv` 会包含原文件所有的视频和音频流。
</code></pre></li><li><pre><code class="language-bash">ffmpeg -i video.mp4 -i audio.mp3 -map 0:v -map 1:a -c copy output_merged.mp4
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - `-map 0:v`: 选择第一个输入 (`video.mp4`) 的视频流。</span><br><span class="line">  - `-map 1:a`: 选择第二个输入 (`audio.mp3`) 的音频流。</span><br><span class="line">  - 结果 `output_merged.mp4` 就是用第一个视频配上第二个音频。</span><br><span class="line"></span><br><span class="line">- ```bash</span><br><span class="line">  ffmpeg -i input.mkv -map 0 -map -0:s -c copy output_no_subs.mkv</span><br></pre></td></tr></tbody></table></figure>

- `-map 0`: 先选择第一个输入的所有流。
- `-map -0:s`: 然后**取消选择**第一个输入的所有字幕流 (`-` 号表示取消)。
- 结果 `output_no_subs.mkv` 包含原视频和音频，但不含字幕。
</code></pre></li></ul></li></ul><p><strong>流标识符的其他用途:</strong></p><p>除了配合 <code>-map</code>，流标识符还可以用来<strong>给特定的流指定选项</strong>：</p><ul><li><code>-c:a:0 aac -b:a:0 128k</code>: 对第一个音频流 (<code>a:0</code>) 使用 AAC 编码，比特率为 128k。</li><li><code>-c:a:1 libopus</code>: 对第二个音频流 (<code>a:1</code>) 使用 Opus 编码。</li><li><code>-metadata:s:a:0 language=eng</code>: 为第一个音频流 (<code>a:0</code>) 设置语言元数据为英语。</li><li>在 <code>-filter_complex</code> 中，像 <code>[0:v]</code> 这样的标签实际上也是基于流标识符来引用特定的输入流。</li></ul><p><strong><code>ffmpeg-python</code> 中的对应:</strong></p><p>使用<code>ffmpeg-python</code> 库时，选择流的方式更 Pythonic：</p><ul><li><code>input_node['v']</code> 或 <code>input_node.video</code> 通常选择第一个视频流。</li><li><code>input_node['a:1']</code> 选择第二个音频流。</li><li><code>input_node[0]</code> 选择第一个流（不区分类型）。 库在底层会将这些选择转换成合适的 FFmpeg 命令行 <code>-map</code> 参数或滤镜图标签。</li></ul><hr><h4 id="17-2-4-FFmpeg-自身能力查询命令"><a href="#17-2-4-FFmpeg-自身能力查询命令" class="headerlink" title="17.2.4 FFmpeg 自身能力查询命令"></a>17.2.4 FFmpeg 自身能力查询命令</h4><p><strong>为何要查询 FFmpeg 的能力？</strong></p><p>在你编写任何调用 FFmpeg 的脚本或程序之前，了解你所使用的 FFmpeg 版本<strong>究竟能做什么</strong>至关重要。FFmpeg 功能极其强大，但并非所有安装版本都包含全部功能。例如，某些编解码器（特别是需要额外授权或有专利问题的）可能在默认编译中未被包含；或者你可能需要确认是否支持特定的网络协议或滤镜。</p><p>因此，执行信息查询命令的主要<strong>作用和价值</strong>在于：</p><ol><li><strong>避免运行时错误：</strong> 提前确认 FFmpeg 支持你将要使用的编码器、格式、滤镜或协议，可以避免在脚本执行到一半时才发现功能缺失而导致失败。例如，你想编码为 <code>libfdk_aac</code>，但查询 <code>ffmpeg -encoders</code> 后发现它不在列表中，你就需要换用 FFmpeg 内置的 <code>aac</code> 编码器。</li><li><strong>确保兼容性与选择最佳方案：</strong> 查看支持列表可以帮助你选择最适合你需求的、且当前环境支持的最佳工具。比如，检查是否有硬件加速编码器（如 <code>h264_nvenc</code>）可用，或者对比几种可选的音频编码器。</li><li><strong>辅助调试：</strong> 特别是当你自行编译 FFmpeg 或遇到奇怪问题时，检查编译时链接的库和启用的功能（可以通过 <code>-version</code> 或查询相关组件）可以帮助诊断问题根源。</li><li><strong>发现新功能：</strong> 浏览支持列表也是学习 FFmpeg 强大功能、寻找特定处理方案的途径。</li></ol><p><strong>常用查询命令详解：</strong></p><h6 id="查看编解码器-encoders-decoders"><a href="#查看编解码器-encoders-decoders" class="headerlink" title="查看编解码器 (-encoders, -decoders)"></a>查看编解码器 (<code>-encoders</code>, <code>-decoders</code>)</h6><p>命令 <code>ffmpeg -encoders</code> 会列出所有当前 FFmpeg 版本<strong>编译支持的编码器</strong>。编码器用于将原始音视频数据压缩。输出会标明编码器名称（如 <code>libx264</code>）、类型（V=视频, A=音频, S=字幕）和简短描述。类似地，<code>ffmpeg -decoders</code> 列出所有支持的<strong>解码器</strong>，用于解压缩。了解这些列表可以让你确定：</p><ul><li><strong>输出兼容性：</strong> 你能否使用 <code>-c:v libx265</code> 或 <code>-c:a libopus</code> 来编码你的输出文件？</li><li><strong>输入兼容性：</strong> 当你拿到一个不常见的视频文件时，FFmpeg 是否内置了对应的解码器来读取它？</li><li><strong>硬件加速：</strong> 列表中是否包含如 <code>h264_nvenc</code>, <code>hevc_qsv</code> 等硬件加速编解码器？</li></ul><h6 id="查看协议-protocols"><a href="#查看协议-protocols" class="headerlink" title="查看协议 (-protocols)"></a>查看协议 (<code>-protocols</code>)</h6><p>命令 <code>ffmpeg -protocols</code> 显示 FFmpeg 支持的<strong>输入和输出协议</strong>。这决定了 FFmpeg 能从哪些来源读取数据以及能将数据发送到哪些目的地。常见的协议包括 <code>file</code> (本地文件), <code>http</code>, <code>https</code>, <code>ftp</code>, <code>tcp</code>, <code>udp</code>, 以及流媒体常用的 <code>rtmp</code>, <code>rtsp</code>, <code>hls</code>, <code>pipe</code> (管道) 等。在你需要处理网络流（如拉取 RTSP 流进行处理，或将处理结果推送到 RTMP 服务器）或与其他进程通过管道交互时，确认协议支持是前提。</p><h6 id="查看格式-formats"><a href="#查看格式-formats" class="headerlink" title="查看格式 (-formats)"></a>查看格式 (<code>-formats</code>)</h6><p>命令 <code>ffmpeg -formats</code> 列出 FFmpeg 支持的所有<strong>容器格式 (Muxers/Demuxers)</strong>。容器格式定义了音视频流如何打包存储。输出中 <code>D</code> 列表示支持解复用（Demuxing，读取这种格式的文件），<code>E</code> 列表示支持复用（Muxing，写入这种格式的文件）。常见的格式如 <code>mp4</code>, <code>mov</code>, <code>mkv</code>, <code>webm</code>, <code>avi</code>, <code>flv</code>, <code>mpegts</code>, <code>mp3</code>, <code>aac</code>, <code>wav</code>, <code>ogg</code>, <code>image2</code> (用于图像序列) 等。在你需要进行格式转换，或者使用 <code>-f</code> 参数强制指定格式时，需要确保目标格式是被支持的（有 <code>E</code> 标记）。</p><h6 id="查看和学习滤镜-filters-h-filter"><a href="#查看和学习滤镜-filters-h-filter" class="headerlink" title="查看和学习滤镜 (-filters, -h filter=<滤镜名>)"></a>查看和学习滤镜 (<code>-filters</code>, <code>-h filter=&lt;滤镜名&gt;</code>)</h6><p>命令 <code>ffmpeg -filters</code> 会打印出当前版本支持的<strong>所有滤镜</strong>的列表，这个列表通常非常长！它对于快速浏览有哪些可用的处理功能很有帮助。但更实用的是 <code>ffmpeg -h filter=&lt;滤镜名&gt;</code> 命令。例如，你想了解如何精确地缩放视频，可以运行 <code>ffmpeg -h filter=scale</code>。这个命令会输出 <code>scale</code> 滤镜的<strong>详细文档</strong>，包括它接受的所有参数（如 <code>width</code>, <code>height</code>, <code>flags</code>, <code>interl</code> 等）、每个参数的含义、可接受的值范围、默认值，甚至可能有使用示例。在你使用任何不熟悉的滤镜之前，通过 <code>-h filter=</code> 来查阅其用法是避免参数错误的关键步骤。</p><h6 id="获取完整帮助-h-full"><a href="#获取完整帮助-h-full" class="headerlink" title="获取完整帮助 (-h full)"></a>获取完整帮助 (<code>-h full</code>)</h6><p>命令 <code>ffmpeg -h full</code> 会输出 FFmpeg 所有可用的命令行选项的极其详尽的帮助信息。内容非常多，适合在需要查找非常规或底层参数时作为最终参考。</p><hr><h4 id="17-2-5-ffprobe-获取文件信息详解-深度解读"><a href="#17-2-5-ffprobe-获取文件信息详解-深度解读" class="headerlink" title="17.2.5 ffprobe 获取文件信息详解 (深度解读)"></a>17.2.5 <code>ffprobe</code> 获取文件信息详解 (深度解读)</h4><p><strong>为何要探测文件信息？</strong></p><p><code>ffprobe</code> 是 FFmpeg 套件中的<strong>媒体文件侦探</strong>。在你对音视频文件进行任何修改或处理<strong>之前</strong>，使用 <code>ffprobe</code> 深入了解它的“底细”至关重要，其<strong>作用和价值</strong>体现在：</p><ol><li><p>制定处理策略:</p><p>获取文件的精确属性（如分辨率、帧率、时长、编码格式、比特率、音频声道数、采样率、像素格式等）是决定后续操作的基础。例如：</p><ul><li>只有当视频分辨率<strong>大于</strong> 1920x1080 时，才执行缩小操作。</li><li>只有当音频编码<strong>不是</strong> AAC 时，才进行音频转码。</li><li>根据获取的视频<strong>时长</strong>来计算截取片段的起止时间或判断是否需要处理。</li><li>根据<strong>帧率</strong>来设置输出帧率或进行帧率转换。</li><li>检查<strong>像素格式</strong>以确保后续滤镜或编码器兼容。</li><li>检测<strong>是否有音频流</strong>来决定是否需要处理或复制音频。</li><li>读取<strong>旋转 (Rotation) 元数据</strong>，以便在必要时进行反向旋转校正。</li></ul></li><li><p><strong>动态参数计算:</strong> 在脚本中，你可以用 <code>ffprobe</code> 获取的值来动态计算 FFmpeg 命令的参数。例如，使用探测到的宽度 <code>iw</code> 和高度 <code>ih</code> 来计算缩放或裁剪的目标尺寸，或者使用探测到的时长 <code>duration</code> 来设置滤镜效果的时间参数。</p></li><li><p><strong>错误预检查与调试:</strong> 可以用来检查输入文件是否有效、是否损坏、是否包含预期的流类型。如果一个文件处理失败，<code>ffprobe</code> 的输出可以帮助判断问题是出在文件本身还是处理命令上。</p></li><li><p><strong>内容分析与质量评估:</strong> 查看文件的编码器、Profile/Level、比特率等信息，可以大致评估源文件的质量，并据此选择合适的处理参数。</p></li></ol><p><strong>推荐的 <code>ffprobe</code> 命令及其详解:</strong></p><p>对于脚本化处理，获取 <strong>JSON 格式</strong>的输出是最方便的：</p><p>Bash</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffprobe -v quiet -print_format json -show_format -show_streams your_video.mp4</span><br></pre></td></tr></tbody></table></figure><ul><li><strong><code>-v quiet</code></strong>: 设置日志级别为 <code>quiet</code>，这样 <code>ffprobe</code> 在执行时不会打印版本信息、库信息等额外的日志，只输出纯净的 JSON 数据（或错误信息），便于程序解析。</li><li><strong><code>-print_format json</code></strong>: 明确指定输出格式为 JSON。JSON 是一种结构化的数据格式，Python 的 <code>json</code> 模块可以轻松地将其解析为字典和列表。</li><li><strong><code>-show_format</code></strong>: 指示 <code>ffprobe</code> 在输出中包含关于<strong>容器格式 (Format)</strong> 的信息。这部分信息描述了整个文件的属性。</li><li><strong><code>-show_streams</code></strong>: 指示 <code>ffprobe</code> 在输出中包含文件中<strong>每一个数据流 (Stream)</strong> 的详细信息（包括视频、音频、字幕等）。</li></ul><p><strong>深入理解 JSON 输出结构:</strong></p><p><code>ffprobe</code> 输出的 JSON 是一个 Python 字典，其中最重要的两个键是 <code>"format"</code> 和 <code>"streams"</code>。</p><h6 id="format-对象-容器-文件级别信息"><a href="#format-对象-容器-文件级别信息" class="headerlink" title="&quot;format&quot; 对象 (容器/文件级别信息)"></a><code>"format"</code> 对象 (容器/文件级别信息)</h6><p>这个字典包含了文件的整体信息：</p><ul><li><code>filename</code>: 文件的完整路径。</li><li><code>nb_streams</code>: 文件中包含的流的总数。</li><li><code>format_name</code>: 容器格式的名称（通常是逗号分隔的列表，如 ‘mov,mp4,m4a,3gp,3g2,mj2’）。</li><li><code>format_long_name</code>: 容器格式的更详细名称。</li><li><code>start_time</code>: 文件播放的起始时间戳（通常是 “0.000000”）。</li><li><code>duration</code>: <strong>文件的总时长</strong>（单位：秒，字符串形式）。<strong>极其常用！</strong></li><li><code>size</code>: 文件总大小（单位：字节，字符串形式）。</li><li><code>bit_rate</code>: <strong>文件的平均总比特率</strong>（单位：bps，字符串形式）。</li><li><code>probe_score</code>: FFmpeg 对探测到的格式的置信度（通常不用太关心）。</li><li><code>tags</code>: 一个字典，包含了容器级别的元数据标签，例如 <code>major_brand</code>, <code>minor_version</code>, <code>compatible_brands</code>, <code>title</code>, <code>artist</code>, <code>album</code>, <code>encoder</code> (编码这个文件的软件信息), <code>comment</code> 等。</li></ul><h6 id="streams-列表-流级别信息"><a href="#streams-列表-流级别信息" class="headerlink" title="&quot;streams&quot; 列表 (流级别信息)"></a><code>"streams"</code> 列表 (流级别信息)</h6><p>这是一个列表，列表中的每个元素都是一个字典，详细描述了文件中的一个流。你需要遍历这个列表，并通过 <code>codec_type</code> 来判断是视频流、音频流还是其他类型的流。</p><ul><li>通用关键字段:<ul><li><code>index</code>: 流的索引号（从 0 开始）。</li><li><code>codec_type</code>: <strong>流类型</strong>，值为 ‘video’, ‘audio’, ‘subtitle’, ‘data’ 等。<strong>用于区分不同流</strong>。</li><li><code>codec_name</code>: 编解码器的短名称（如 ‘h264’, ‘aac’, ‘vp9’）。</li><li><code>codec_long_name</code>: 编解码器的完整名称。</li><li><code>profile</code>: 编码时使用的配置文件（如 H.264 的 ‘High’, ‘Main’）。</li><li><code>time_base</code>: 时间戳的基本单位（分数形式，如 “1/16000”，表示时间戳的单位是 1/16000 秒）。</li><li><code>start_time</code>: 此流的起始时间（秒）。</li><li><code>duration</code>: <strong>此流的持续时间</strong>（秒，可能与 <code>format</code> 中的总时长略有不同）。</li><li><code>bit_rate</code>: <strong>此流的平均比特率</strong>（bps）。</li><li><code>nb_frames</code>: 此流的总帧数（对某些编码可能是估计值）。</li><li><code>disposition</code>: 一个字典，包含布尔标志，指示流的用途，如 <code>default</code> (是否为默认流), <code>dub</code> (是否为配音), <code>original</code>, <code>comment</code>, <code>forced</code> (强制字幕)等。</li><li><code>tags</code>: 此流特有的元数据，如 <code>language</code> (‘eng’, ‘chi’), <code>handler_name</code>, <code>rotate</code> (视频旋转角度)等。</li></ul></li><li>视频流 (<code>codec_type == 'video'</code>) 特有关键字段:<ul><li><code>width</code>, <code>height</code>: 视频解码后的<strong>宽度和高度</strong>（像素）。</li><li><code>coded_width</code>, <code>coded_height</code>: 视频编码时的宽度和高度（可能因编码要求而与 <code>width</code>/<code>height</code> 不同）。</li><li><code>pix_fmt</code>: <strong>像素格式</strong>（如 ‘yuv420p’, ‘rgb24’）。</li><li><code>level</code>: 编码级别（如 H.264 的 41 代表 Level 4.1）。</li><li><code>color_range</code>, <code>color_space</code>, <code>color_transfer</code>, <code>color_primaries</code>: 详细的色彩空间信息。</li><li><code>sample_aspect_ratio</code> (SAR), <code>display_aspect_ratio</code> (DAR): 像素宽高比和显示宽高比。</li><li><code>r_frame_rate</code>: 容器中标称的基础帧率（分数，如 “25/1”）。</li><li><code>avg_frame_rate</code>: 平均帧率（分数，如 “30000/1001” 表示 29.97fps）。<strong>常用！</strong></li></ul></li><li>音频流 (<code>codec_type == 'audio'</code>) 特有关键字段:<ul><li><code>sample_fmt</code>: 音频采样格式（如 ‘fltp’ - 浮点平面）。</li><li><code>sample_rate</code>: <strong>采样率</strong>（Hz，如 ‘44100’, ‘48000’）。<strong>常用！</strong></li><li><code>channels</code>: <strong>声道数</strong>（如 1, 2, 6）。<strong>常用！</strong></li><li><code>channel_layout</code>: 声道布局描述（如 ‘mono’, ‘stereo’, ‘5.1(side)’）。<strong>常用！</strong></li><li><code>bits_per_sample</code>: 每个采样点的位数（对于某些格式可能为 0）。</li></ul></li></ul><h6 id="Python-解析-ffprobe-JSON-示例-增强版"><a href="#Python-解析-ffprobe-JSON-示例-增强版" class="headerlink" title="Python 解析 ffprobe JSON 示例 (增强版)"></a>Python 解析 <code>ffprobe</code> JSON 示例 (增强版)</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path <span class="comment"># 使用 pathlib 处理路径，更健壮</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_media_info</span>(<span class="params">filepath: <span class="built_in">str</span></span>) -&gt; <span class="built_in">dict</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="string">"""使用 ffprobe 获取媒体文件的详细信息 (JSON 格式)"""</span></span><br><span class="line">    ffprobe_cmd = <span class="string">'ffprobe'</span> <span class="comment"># 假设 ffprobe 在系统 PATH 中</span></span><br><span class="line">    filepath_obj = Path(filepath)</span><br><span class="line">    <span class="comment"># 检查文件是否存在</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> filepath_obj.is_file():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误: 输入文件不存在 '<span class="subst">{filepath}</span>'"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构建 ffprobe 命令列表</span></span><br><span class="line">    cmd = [</span><br><span class="line">        ffprobe_cmd,</span><br><span class="line">        <span class="string">'-v'</span>, <span class="string">'quiet'</span>,           <span class="comment"># 抑制日志输出，只输出 JSON 或错误</span></span><br><span class="line">        <span class="string">'-print_format'</span>, <span class="string">'json'</span>, <span class="comment"># 指定输出格式为 JSON</span></span><br><span class="line">        <span class="string">'-show_format'</span>,          <span class="comment"># 要求包含容器格式信息</span></span><br><span class="line">        <span class="string">'-show_streams'</span>,         <span class="comment"># 要求包含所有流的信息</span></span><br><span class="line">        <span class="built_in">str</span>(filepath_obj)        <span class="comment"># 将 Path 对象转换为字符串路径</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"执行命令: <span class="subst">{<span class="string">' '</span>.join(cmd)}</span>"</span>) <span class="comment"># 打印将要执行的命令，方便调试</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 执行命令并捕获输出</span></span><br><span class="line">        result = subprocess.run(</span><br><span class="line">            cmd,</span><br><span class="line">            capture_output=<span class="literal">True</span>, <span class="comment"># 捕获 stdout 和 stderr</span></span><br><span class="line">            text=<span class="literal">True</span>,           <span class="comment"># 将输出解码为文本</span></span><br><span class="line">            check=<span class="literal">True</span>,          <span class="comment"># 如果 ffprobe 返回非零退出码则抛出异常</span></span><br><span class="line">            encoding=<span class="string">'utf-8'</span>,    <span class="comment"># 指定编码</span></span><br><span class="line">            errors=<span class="string">'ignore'</span>      <span class="comment"># 忽略解码中的小错误</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 解析 JSON 输出</span></span><br><span class="line">        media_info = json.loads(result.stdout)</span><br><span class="line">        <span class="keyword">return</span> media_info</span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 处理命令执行失败的情况</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"ffprobe 执行失败 for '<span class="subst">{filepath}</span>':"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  返回码: <span class="subst">{e.returncode}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  命令: <span class="subst">{<span class="string">' '</span>.join(e.cmd)}</span>"</span>) <span class="comment"># 打印执行的命令</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  错误输出 (stderr): <span class="subst">{e.stderr}</span>"</span>) <span class="comment"># 打印错误信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="comment"># 处理 ffprobe 命令未找到的情况</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误: ffprobe 命令 '<span class="subst">{ffprobe_cmd}</span>' 未找到。请确保已安装 FFmpeg 并将其添加到系统 PATH。"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> json.JSONDecodeError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 处理 JSON 解析失败的情况</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误: 解析 ffprobe 输出失败。错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="comment"># 打印原始输出可能有助于诊断 ffprobe 的问题</span></span><br><span class="line">        <span class="comment"># print("原始输出:", result.stdout if 'result' in locals() else 'N/A')</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 捕获其他未知错误</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"获取媒体信息时发生未知错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例:</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 替换为你需要分析的文件路径</span></span><br><span class="line">    target_file = <span class="string">'input.mp4'</span> <span class="comment"># 或者你电脑上的其他音视频文件</span></span><br><span class="line"></span><br><span class="line">    info = get_media_info(target_file)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> info:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"\n--- 文件 '<span class="subst">{target_file}</span>' 的详细信息 ---"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 安全地访问 format 信息</span></span><br><span class="line">        format_info = info.get(<span class="string">'format'</span>, {})</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n[容器信息]"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  格式: <span class="subst">{format_info.get(<span class="string">'format_long_name'</span>, <span class="string">'N/A'</span>)}</span> (<span class="subst">{format_info.get(<span class="string">'format_name'</span>, <span class="string">'N/A'</span>)}</span>)"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            duration_sec = <span class="built_in">float</span>(format_info.get(<span class="string">'duration'</span>, <span class="number">0</span>))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  时长: <span class="subst">{duration_sec:<span class="number">.2</span>f}</span> 秒"</span>)</span><br><span class="line">        <span class="keyword">except</span> (ValueError, TypeError):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  时长: N/A"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            size_mb = <span class="built_in">int</span>(format_info.get(<span class="string">'size'</span>, <span class="number">0</span>)) / (<span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  大小: <span class="subst">{size_mb:<span class="number">.2</span>f}</span> MB"</span>)</span><br><span class="line">        <span class="keyword">except</span> (ValueError, TypeError):</span><br><span class="line">             <span class="built_in">print</span>(<span class="string">f"  大小: N/A"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            bitrate_kbps = <span class="built_in">int</span>(format_info.get(<span class="string">'bit_rate'</span>, <span class="number">0</span>)) / <span class="number">1000</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  总比特率: <span class="subst">{bitrate_kbps:<span class="number">.1</span>f}</span> kbps"</span>)</span><br><span class="line">        <span class="keyword">except</span> (ValueError, TypeError):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  总比特率: N/A"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"  流数量: <span class="subst">{format_info.get(<span class="string">'nb_streams'</span>, <span class="number">0</span>)}</span>"</span>)</span><br><span class="line">        <span class="keyword">if</span> format_info.get(<span class="string">'tags'</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  元数据标签: <span class="subst">{format_info.get(<span class="string">'tags'</span>)}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n[流信息]"</span>)</span><br><span class="line">        <span class="comment"># 安全地访问 streams 列表</span></span><br><span class="line">        <span class="keyword">for</span> stream <span class="keyword">in</span> info.get(<span class="string">'streams'</span>, []):</span><br><span class="line">            stream_index = stream.get(<span class="string">'index'</span>, <span class="string">'N/A'</span>)</span><br><span class="line">            codec_type = stream.get(<span class="string">'codec_type'</span>, <span class="string">'N/A'</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"  --- 流 #<span class="subst">{stream_index}</span> (<span class="subst">{codec_type}</span>) ---"</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"    编码: <span class="subst">{stream.get(<span class="string">'codec_long_name'</span>, <span class="string">'N/A'</span>)}</span> (<span class="subst">{stream.get(<span class="string">'codec_name'</span>, <span class="string">'N/A'</span>)}</span>)"</span>)</span><br><span class="line">            <span class="keyword">if</span> codec_type == <span class="string">'video'</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"    分辨率: <span class="subst">{stream.get(<span class="string">'width'</span>)}</span>x<span class="subst">{stream.get(<span class="string">'height'</span>)}</span>"</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"    像素格式: <span class="subst">{stream.get(<span class="string">'pix_fmt'</span>, <span class="string">'N/A'</span>)}</span>"</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"    帧率 (avg): <span class="subst">{stream.get(<span class="string">'avg_frame_rate'</span>, <span class="string">'N/A'</span>)}</span>"</span>)</span><br><span class="line">            <span class="keyword">elif</span> codec_type == <span class="string">'audio'</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"    采样率: <span class="subst">{stream.get(<span class="string">'sample_rate'</span>)}</span> Hz"</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"    声道: <span class="subst">{stream.get(<span class="string">'channels'</span>)}</span> (<span class="subst">{stream.get(<span class="string">'channel_layout'</span>, <span class="string">'N/A'</span>)}</span>)"</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                stream_duration = <span class="built_in">float</span>(stream.get(<span class="string">'duration'</span>, <span class="number">0</span>))</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"    流时长: <span class="subst">{stream_duration:<span class="number">.2</span>f}</span> 秒"</span>)</span><br><span class="line">            <span class="keyword">except</span> (ValueError, TypeError):</span><br><span class="line">                 <span class="built_in">print</span>(<span class="string">f"    流时长: N/A"</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                stream_bitrate = <span class="built_in">int</span>(stream.get(<span class="string">'bit_rate'</span>, <span class="number">0</span>)) / <span class="number">1000</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"    流比特率: <span class="subst">{stream_bitrate:<span class="number">.1</span>f}</span> kbps"</span>)</span><br><span class="line">            <span class="keyword">except</span> (ValueError, TypeError):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"    流比特率: N/A"</span>)</span><br><span class="line">            <span class="keyword">if</span> stream.get(<span class="string">'tags'</span>):</span><br><span class="line">                 <span class="built_in">print</span>(<span class="string">f"    流标签: <span class="subst">{stream.get(<span class="string">'tags'</span>)}</span>"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"\n未能获取文件 '<span class="subst">{target_file}</span>' 的信息。请检查文件路径和 FFmpeg 安装。"</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        </span><br></pre></td></tr></tbody></table></figure><p>详细信息流如下：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">--- 文件 'input.mp4' 的详细信息 ---</span><br><span class="line"></span><br><span class="line"><span class="punctuation">[</span>容器信息<span class="punctuation">]</span></span><br><span class="line">  格式<span class="punctuation">:</span> QuickTime / MOV (mov<span class="punctuation">,</span>mp4<span class="punctuation">,</span>m4a<span class="punctuation">,</span><span class="number">3</span>gp<span class="punctuation">,</span><span class="number">3</span>g2<span class="punctuation">,</span>mj2)</span><br><span class="line">  时长<span class="punctuation">:</span> <span class="number">35.33</span> 秒</span><br><span class="line">  大小<span class="punctuation">:</span> <span class="number">1.92</span> MB</span><br><span class="line">  总比特率<span class="punctuation">:</span> <span class="number">456.8</span> kbps</span><br><span class="line">  流数量<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">  元数据标签<span class="punctuation">:</span> <span class="punctuation">{</span>'major_brand'<span class="punctuation">:</span> 'isom'<span class="punctuation">,</span> 'minor_version'<span class="punctuation">:</span> '<span class="number">512</span>'<span class="punctuation">,</span> 'compatible_brands'<span class="punctuation">:</span> 'isomiso2avc1mp41'<span class="punctuation">,</span> 'encoder'<span class="punctuation">:</span> 'Lavf59<span class="number">.27</span><span class="number">.100</span>'<span class="punctuation">,</span> 'description'<span class="punctuation">:</span> 'Packed by Bilibili XCoder v2<span class="number">.0</span><span class="number">.2</span>'<span class="punctuation">}</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">[</span>流信息<span class="punctuation">]</span></span><br><span class="line">  --- 流 #<span class="number">0</span> (video) ---</span><br><span class="line">    编码<span class="punctuation">:</span> H<span class="number">.264</span> / AVC / MPEG<span class="number">-4</span> AVC / MPEG<span class="number">-4</span> part <span class="number">10</span> (h264)</span><br><span class="line">    分辨率<span class="punctuation">:</span> <span class="number">720</span>x996</span><br><span class="line">    像素格式<span class="punctuation">:</span> yuv420p</span><br><span class="line">    帧率 (avg)<span class="punctuation">:</span> <span class="number">1060000</span>/<span class="number">35333</span></span><br><span class="line">    流时长<span class="punctuation">:</span> <span class="number">35.33</span> 秒</span><br><span class="line">    流比特率<span class="punctuation">:</span> <span class="number">341.0</span> kbps</span><br><span class="line">    流标签<span class="punctuation">:</span> <span class="punctuation">{</span>'language'<span class="punctuation">:</span> 'und'<span class="punctuation">,</span> 'handler_name'<span class="punctuation">:</span> 'VideoHandler'<span class="punctuation">,</span> 'vendor_id'<span class="punctuation">:</span> '<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>'<span class="punctuation">}</span></span><br><span class="line">  --- 流 #<span class="number">1</span> (audio) ---</span><br><span class="line">    编码<span class="punctuation">:</span> AAC (Advanced Audio Coding) (aac)</span><br><span class="line">    采样率<span class="punctuation">:</span> <span class="number">44100</span> Hz</span><br><span class="line">    声道<span class="punctuation">:</span> <span class="number">2</span> (stereo)</span><br><span class="line">    流时长<span class="punctuation">:</span> <span class="number">35.32</span> 秒</span><br><span class="line">    流比特率<span class="punctuation">:</span> <span class="number">105.5</span> kbps</span><br><span class="line">    流标签<span class="punctuation">:</span> <span class="punctuation">{</span>'language'<span class="punctuation">:</span> 'und'<span class="punctuation">,</span> 'handler_name'<span class="punctuation">:</span> 'SoundHandler'<span class="punctuation">,</span> 'vendor_id'<span class="punctuation">:</span> '<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>'<span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><hr><h3 id="17-3-ffmpeg-python-核心-API"><a href="#17-3-ffmpeg-python-核心-API" class="headerlink" title="17.3 ffmpeg-python 核心 API"></a>17.3 <code>ffmpeg-python</code> 核心 API</h3><p><code>ffmpeg-python</code> 的核心思想与其他 Python 库直接绑定 FFmpeg 的 C API 不同。它并不直接执行编解码或滤镜操作，而是提供了一套 Pythonic 的接口，让你像用 Python 代码描述流程一样来<strong>构建一个媒体处理的有向无环图 (DAG - Directed Acyclic Graph)</strong>。</p><p>在这个图中：</p><ul><li><strong>节点 (Node):</strong> 代表一个处理单元，比如一个输入文件、一个滤镜操作、或者一个输出文件。</li><li><strong>边 (Edge / Stream):</strong> 代表在节点之间流动的<strong>媒体流 (Stream)</strong>，可以是视频流、音频流等。</li></ul><p>你通过调用 <code>ffmpeg-python</code> 的函数（如 <code>ffmpeg.input</code>, <code>ffmpeg.filter</code>, <code>ffmpeg.output</code>）来创建节点，并通过链式调用或将流作为参数传递来连接这些节点，形成处理图。<strong>这个图仅仅是一个处理流程的描述</strong>。</p><p>只有当你调用最终输出节点的 <code>.run()</code> 或 <code>.run_async()</code> 方法时，<code>ffmpeg-python</code> 才会<strong>将这个图编译 (compile)</strong> 成一个等效的、可能非常复杂的 <strong>FFmpeg 命令行参数列表</strong>，然后调用你系统上安装的 <code>ffmpeg</code> 可执行程序（通过 Python 的 <code>subprocess</code> 模块）来<strong>实际执行</strong>这个命令。</p><p>这种方式的主要优点是代码可读性高、符合 Python 习惯、并且能优雅地处理复杂的滤镜链和多输入多输出场景，避免了手动拼接命令行字符串的痛苦和易错性。</p><h4 id="17-3-1-API-ffmpeg-probe-探测媒体文件信息"><a href="#17-3-1-API-ffmpeg-probe-探测媒体文件信息" class="headerlink" title="17.3.1 API: ffmpeg.probe() - 探测媒体文件信息"></a>17.3.1 API: <code>ffmpeg.probe()</code> - 探测媒体文件信息</h4><p><strong>作用:</strong><br>调用系统中的 <code>ffprobe</code> 命令行工具，分析指定的媒体文件，并将其详细信息解析为一个结构化的 Python 字典返回。这是在进行任何处理之前了解文件属性的关键步骤。</p><p><strong>语法:</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg.probe(filename, cmd=<span class="string">'ffprobe'</span>, **kwargs)</span><br></pre></td></tr></tbody></table></figure><p><strong>参数详解:</strong></p><ul><li><code>filename</code> (字符串, <strong>必需</strong>): 要分析的媒体文件的路径或 URL。建议使用 <code>pathlib</code> 处理路径，并传入 <code>str(path_obj)</code>。</li><li><code>cmd</code> (字符串, 可选): 指定 <code>ffprobe</code> 可执行文件的路径。如果 <code>ffprobe</code> 已经在系统 PATH 环境变量中，则保持默认值 <code>'ffprobe'</code> 即可。</li><li><code>**kwargs</code> (可选关键字参数): 对应传递给 <code>ffprobe</code> 命令行的额外选项（需要去掉选项前的 <code>-</code>）。例如：<ul><li><code>select_streams='v'</code>: 对应 <code>-select_streams v</code>，表示只探测视频流的信息。</li><li><code>show_entries='stream=codec_name,duration:format=bit_rate'</code>: 对应 <code>-show_entries stream=codec_name,duration:format=bit_rate</code>，表示只在输出中包含指定的条目，减少输出量。</li><li><code>count_frames=None</code>: 对应 <code>-count_frames</code> 标志，用于计算流的总帧数（可能较慢）。</li></ul></li></ul><p><strong>代码示例:</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ffmpeg</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> sys <span class="comment"># 用于退出</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 配置 ffprobe 路径 (如果需要) ---</span></span><br><span class="line">FFPROBE_PATH = <span class="string">"ffprobe"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">probe_and_display</span>(<span class="params">filepath: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">"""调用 ffmpeg.probe 并打印关键信息"""</span></span><br><span class="line">    filepath_obj = Path(filepath)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> filepath_obj.is_file():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误: 文件不存在 '<span class="subst">{filepath}</span>'"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n--- 使用 ffmpeg.probe 探测: <span class="subst">{filepath}</span> ---"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 调用 probe 函数</span></span><br><span class="line">        info = ffmpeg.probe(<span class="built_in">str</span>(filepath_obj), cmd=FFPROBE_PATH)</span><br><span class="line">        <span class="comment"># 探测成功，info 是一个包含详细信息的字典</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[探测成功，解析信息如下]"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 解析容器信息 ---</span></span><br><span class="line">        format_info = info.get(<span class="string">'format'</span>, {})</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"  [容器 Format]"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"    时长 (秒): <span class="subst">{<span class="built_in">float</span>(format_info.get(<span class="string">'duration'</span>, <span class="number">0</span>)):<span class="number">.3</span>f}</span>"</span>) <span class="comment"># 更高精度</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"    格式: <span class="subst">{format_info.get(<span class="string">'format_long_name'</span>, <span class="string">'N/A'</span>)}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"    总比特率 (kbps): <span class="subst">{<span class="built_in">int</span>(format_info.get(<span class="string">'bit_rate'</span>, <span class="number">0</span>)) / <span class="number">1000</span>:<span class="number">.1</span>f}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"    流数量: <span class="subst">{format_info.get(<span class="string">'nb_streams'</span>, <span class="number">0</span>)}</span>"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 解析流信息 ---</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"  [数据流 Streams]"</span>)</span><br><span class="line">        streams_list = info.get(<span class="string">'streams'</span>, [])</span><br><span class="line">        <span class="keyword">for</span> stream <span class="keyword">in</span> streams_list:</span><br><span class="line">            index = stream.get(<span class="string">'index'</span>, <span class="string">'N/A'</span>)</span><br><span class="line">            codec_type = stream.get(<span class="string">'codec_type'</span>, <span class="string">'N/A'</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"    --- 流 #<span class="subst">{index}</span> (<span class="subst">{codec_type}</span>) ---"</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"      编码: <span class="subst">{stream.get(<span class="string">'codec_name'</span>, <span class="string">'N/A'</span>)}</span> (Profile: <span class="subst">{stream.get(<span class="string">'profile'</span>, <span class="string">'N/A'</span>)}</span>)"</span>)</span><br><span class="line">            <span class="keyword">if</span> codec_type == <span class="string">'video'</span>:</span><br><span class="line">                <span class="comment"># 获取视频信息</span></span><br><span class="line">                width = stream.get(<span class="string">'width'</span>)</span><br><span class="line">                height = stream.get(<span class="string">'height'</span>)</span><br><span class="line">                pix_fmt = stream.get(<span class="string">'pix_fmt'</span>, <span class="string">'N/A'</span>)</span><br><span class="line">                frame_rate = stream.get(<span class="string">'avg_frame_rate'</span>, <span class="string">'N/A'</span>) <span class="comment"># 平均帧率更常用</span></span><br><span class="line">                <span class="comment"># 计算帧率的数值 (分数形式转小数)</span></span><br><span class="line">                fps_num = <span class="number">0</span></span><br><span class="line">                <span class="keyword">if</span> frame_rate != <span class="string">'N/A'</span> <span class="keyword">and</span> <span class="string">'/'</span> <span class="keyword">in</span> frame_rate:</span><br><span class="line">                    num, den = <span class="built_in">map</span>(<span class="built_in">int</span>, frame_rate.split(<span class="string">'/'</span>))</span><br><span class="line">                    <span class="keyword">if</span> den != <span class="number">0</span>: fps_num = num / den</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"      分辨率: <span class="subst">{width}</span>x<span class="subst">{height}</span>"</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"      像素格式: <span class="subst">{pix_fmt}</span>"</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"      帧率: <span class="subst">{frame_rate}</span> (~<span class="subst">{fps_num:<span class="number">.2</span>f}</span> fps)"</span>)</span><br><span class="line">            <span class="keyword">elif</span> codec_type == <span class="string">'audio'</span>:</span><br><span class="line">                <span class="comment"># 获取音频信息</span></span><br><span class="line">                sample_rate = stream.get(<span class="string">'sample_rate'</span>)</span><br><span class="line">                channels = stream.get(<span class="string">'channels'</span>)</span><br><span class="line">                channel_layout = stream.get(<span class="string">'channel_layout'</span>, <span class="string">'N/A'</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"      采样率: <span class="subst">{sample_rate}</span> Hz"</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"      声道: <span class="subst">{channels}</span> (<span class="subst">{channel_layout}</span>)"</span>)</span><br><span class="line">            <span class="comment"># 打印流的比特率和时长</span></span><br><span class="line">            stream_bitrate_str = stream.get(<span class="string">'bit_rate'</span>)</span><br><span class="line">            stream_duration_str = stream.get(<span class="string">'duration'</span>)</span><br><span class="line">            <span class="keyword">try</span>: <span class="built_in">print</span>(<span class="string">f"      流比特率: <span class="subst">{<span class="built_in">int</span>(stream_bitrate_str) / <span class="number">1000</span>:<span class="number">.1</span>f}</span> kbps"</span>)</span><br><span class="line">            <span class="keyword">except</span>: <span class="built_in">print</span>(<span class="string">f"      流比特率: N/A"</span>)</span><br><span class="line">            <span class="keyword">try</span>: <span class="built_in">print</span>(<span class="string">f"      流时长: <span class="subst">{<span class="built_in">float</span>(stream_duration_str):<span class="number">.3</span>f}</span> 秒"</span>)</span><br><span class="line">            <span class="keyword">except</span>: <span class="built_in">print</span>(<span class="string">f"      流时长: N/A"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> ffmpeg.Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"ffprobe 执行出错 (ffmpeg.Error):"</span>)</span><br><span class="line">        <span class="built_in">print</span>(e.stderr.decode(errors=<span class="string">'ignore'</span>)) <span class="comment"># 打印原始错误输出</span></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"错误: ffprobe 命令 '<span class="subst">{FFPROBE_PATH}</span>' 未找到。"</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"探测过程中发生未知错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 使用示例 ---</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 确保存在一个可供探测的文件</span></span><br><span class="line">    test_file = Path(<span class="string">"input.mp4"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> test_file.is_file():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"警告: 测试文件 '<span class="subst">{test_file}</span>' 不存在。请准备一个视频文件或运行之前的示例代码创建它。"</span>)</span><br><span class="line">        <span class="comment"># 如果需要，可以在这里添加创建测试文件的逻辑</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        probe_and_display(<span class="built_in">str</span>(test_file))</span><br></pre></td></tr></tbody></table></figure><p><strong>返回值:</strong></p><ul><li>成功时: 返回一个 Python <strong>字典 (dict)</strong>，包含了从 <code>ffprobe</code> 获取并解析的媒体信息。</li><li>失败时: 抛出 <code>ffmpeg.Error</code> 或其他异常。</li></ul><p><strong>知识点表格: <code>ffmpeg.probe()</code></strong></p><table><thead><tr><th align="left">API / 参数</th><th align="left">类型</th><th align="left">作用</th><th align="left">备注</th></tr></thead><tbody><tr><td align="left"><code>ffmpeg.probe()</code></td><td align="left">Function</td><td align="left">调用 <code>ffprobe</code> 分析媒体文件并返回信息字典。</td><td align="left">是进行处理前获取属性的关键。</td></tr><tr><td align="left"><code>filename</code></td><td align="left"><code>str</code></td><td align="left">(必需) 文件路径。</td><td align="left"></td></tr><tr><td align="left"><code>cmd</code></td><td align="left"><code>str</code></td><td align="left">(可选) <code>ffprobe</code> 可执行文件路径。</td><td align="left">默认 <code>'ffprobe'</code>。</td></tr><tr><td align="left"><code>**kwargs</code></td><td align="left"><code>dict</code></td><td align="left">(可选) 传递给 <code>ffprobe</code> 的额外选项。</td><td align="left">如 <code>select_streams</code>, <code>show_entries</code>。</td></tr><tr><td align="left">返回值</td><td align="left"><code>dict</code></td><td align="left">媒体信息字典 (<code>format</code>, <code>streams</code>)。</td><td align="left"></td></tr><tr><td align="left">异常</td><td align="left"><code>ffmpeg.Error</code></td><td align="left"><code>ffprobe</code> 执行失败时抛出。</td><td align="left">可通过 <code>.stderr</code> 获取原始错误信息。</td></tr></tbody></table><hr><h4 id="17-3-2-输入节点-ffmpeg-input"><a href="#17-3-2-输入节点-ffmpeg-input" class="headerlink" title="17.3.2 输入节点 (ffmpeg.input)"></a>17.3.2 输入节点 (<code>ffmpeg.input</code>)</h4><p><strong>作用:</strong><br>在 <code>ffmpeg-python</code> 构建的处理图中创建<strong>输入节点</strong>，代表一个媒体文件、设备或网络流来源。这是所有处理流程的起点。</p><p><strong>语法:</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ffmpeg</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取1~4.png的文件列表</span></span><br><span class="line">file_pattern = <span class="string">"%d.png"</span>  <span class="comment"># 使用ffmpeg的图像序列模式</span></span><br><span class="line">file_list = glob.glob(<span class="string">"[1-4].png"</span>)  <span class="comment"># 用于验证文件是否存在</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> file_list:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"找到以下图像文件: <span class="subst">{file_list}</span>"</span>)</span><br><span class="line">    <span class="comment"># 使用ffmpeg的图像序列模式</span></span><br><span class="line">    input_node = ffmpeg.<span class="built_in">input</span>(file_pattern, pattern_type=<span class="string">'sequence'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"未找到1~4.png的文件"</span>)</span><br></pre></td></tr></tbody></table></figure><p><strong>参数详解:</strong></p><ul><li><p><code>filename</code> (字符串, <strong>必需</strong>): 输入来源的标识符。可以是：</p><ul><li>本地文件路径: <code>'input.mp4'</code>, <code>'images/logo.png'</code>, <code>str(Path('video.mkv'))</code></li><li>URL: <code>'http://server/stream.m3u8'</code>, <code>'rtmp://server/live'</code></li><li>设备名称 (依赖 FFmpeg 编译和系统支持): 例如 Linux 上的 <code>/dev/video0</code> (需要 <code>-f v4l2</code>) 或 Windows 上的 <code>'video=Integrated Camera'</code> (需要 <code>-f dshow</code>)。</li><li>图像序列模式: <code>'img%04d.png'</code> (匹配 img0001.png, img0002.png…)</li><li>Lavfi 滤镜源: <code>'color=c=black:s=1280x720:d=10'</code> (创建一个 10 秒的黑色视频源)</li></ul></li><li><p><strong><code>**kwargs</code></strong> (可选关键字参数): 对应 FFmpeg 命令行中<strong>放在 <code>-i</code> 之前</strong>的<strong>输入选项</strong>。键名通常与命令行选项相同（去掉 <code>-</code>）。</p><p><strong>常用输入选项 (<code>kwargs</code>):</strong></p><ul><li><code>ss=&lt;time&gt;</code>: <strong>输入定位</strong>。从指定时间点开始读取输入。<code>time</code> 可以是秒数或 <code>HH:MM:SS.ms</code> 格式。比输出定位 <code>-ss</code> 快，但不精确到帧。</li><li><code>t=&lt;duration&gt;</code>: 从输入源<strong>最多读取</strong>指定 <code>duration</code> 时长的数据。</li><li><code>to=&lt;time&gt;</code>: 从输入源读取数据，<strong>直到</strong>达到指定的时间点 <code>time</code>。</li><li><code>f=&lt;format&gt;</code>: 强制使用指定的<strong>输入格式/解复用器</strong> (Demuxer)。例如，读取摄像头时可能需要 <code>f='v4l2'</code> (Linux) 或 <code>f='dshow'</code> (Windows)；读取图像序列时用 <code>f='image2'</code>；读取 Lavfi 源时用 <code>f='lavfi'</code>。</li><li><code>framerate=&lt;rate&gt;</code>: 强制指定输入的<strong>帧率</strong>。主要用于本身没有帧率信息的输入，如图形序列。</li><li><code>s='&lt;WxH&gt;'</code>: 强制指定输入的<strong>分辨率</strong>。主要用于本身没有分辨率信息的原始视频流。</li><li><code>pix_fmt=&lt;format&gt;</code>: 强制指定输入的<strong>像素格式</strong>。主要用于原始视频流。</li><li><code>loop=1</code>: (用于 <code>image2</code> demuxer) 无限循环<strong>单个</strong>输入图像。通常和 <code>-t</code> 配合生成持续时间的视频。</li><li><code>stream_loop=&lt;count&gt;</code>: (用于视频/GIF等) 循环读取整个输入流指定的次数。<code>-1</code> 表示无限循环。</li></ul></li></ul><p><strong>代码示例:</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ffmpeg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 基本文件输入</span></span><br><span class="line">in1 = ffmpeg.<span class="built_in">input</span>(<span class="string">'input.mp4'</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"输入节点 1 (视频文件):"</span>, <span class="built_in">repr</span>(in1)) <span class="comment"># repr() 显示节点信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 输入文件的一部分 (从第 5 秒开始，处理 10 秒)</span></span><br><span class="line">in2 = ffmpeg.<span class="built_in">input</span>(<span class="string">'input.mp4'</span>, ss=<span class="number">5</span>, t=<span class="number">10</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"输入节点 2 (视频片段):"</span>, <span class="built_in">repr</span>(in2))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 输入图像序列 (假设文件名为 1.png, 2.png...)</span></span><br><span class="line"><span class="comment"># framerate=24 参数的意义：</span></span><br><span class="line"><span class="comment"># 决定了将图像序列转换为视频时的播放速度（每秒显示24张图片）</span></span><br><span class="line"><span class="comment"># 影响输出视频的流畅度和文件大小（帧率越高越流畅，但文件更大）</span></span><br><span class="line"><span class="comment"># 确定了时间轴的刻度（例如：第100张图片将在第100/24≈4.17秒出现）</span></span><br><span class="line"><span class="comment"># 对于动画或视觉效果，24fps是电影行业的标准帧率，给人流畅的视觉体验</span></span><br><span class="line">in_images = ffmpeg.<span class="built_in">input</span>(<span class="string">'%d.png'</span>, framerate=<span class="number">24</span>, f=<span class="string">'image2'</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"输入节点 3 (图像序列):"</span>, <span class="built_in">repr</span>(in_images))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 循环输入一个 GIF</span></span><br><span class="line">in_gif_loop = ffmpeg.<span class="built_in">input</span>(<span class="string">'animation.gif'</span>, stream_loop=-<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"输入节点 4 (循环 GIF):"</span>, <span class="built_in">repr</span>(in_gif_loop))</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>返回值:</strong><br><code>ffmpeg.input()</code> 函数返回一个代表输入源的<strong>节点对象 (Node)</strong>。这个对象包含了关于输入流的信息，并且可以用<strong>流选择器</strong>来获取具体的 <code>Stream</code> 对象用于后续处理。</p><p><strong>知识点表格: <code>ffmpeg.input()</code></strong></p><table><thead><tr><th align="left">API / 参数</th><th align="left">类型</th><th align="left">作用</th><th align="left">备注</th></tr></thead><tbody><tr><td align="left"><code>ffmpeg.input()</code></td><td align="left">Function</td><td align="left">在处理图中创建输入节点。</td><td align="left">处理流程的起点。</td></tr><tr><td align="left"><code>filename</code></td><td align="left"><code>str</code></td><td align="left">(必需) 输入源路径、URL 或标识符。</td><td align="left"></td></tr><tr><td align="left"><code>**kwargs</code></td><td align="left"><code>dict</code></td><td align="left">(可选) 对应 FFmpeg 的输入选项。</td><td align="left">如 <code>ss</code>, <code>t</code>, <code>f</code>, <code>framerate</code> 等。</td></tr><tr><td align="left"><strong>返回值</strong></td><td align="left"><code>Node</code></td><td align="left">代表输入源的节点对象。</td><td align="left">可用于选择流 <code>node['v']</code> 等。</td></tr></tbody></table><hr><h4 id="17-3-3-流-Stream-的概念与选择"><a href="#17-3-3-流-Stream-的概念与选择" class="headerlink" title="17.3.3 流 (Stream) 的概念与选择"></a>17.3.3 流 (Stream) 的概念与选择</h4><p><strong>作用:</strong></p><p>一个媒体文件（如 MKV, MP4）通常包含多个<strong>数据流 (Stream)</strong>，例如一个视频流、一个或多个音频流（不同语言）、一个或多个字幕流等。<code>ffmpeg.input()</code> 函数返回的是一个代表整个输入源的<strong>节点 (Node)</strong> 对象。为了对特定的数据流（比如只对视频进行缩放，或只选择英语音轨）进行操作，你需要从输入节点中<strong>精确地选择</strong>出你想要的那个流。</p><p>选择流会得到一个 <strong><code>Stream</code> 对象</strong>，这个 <code>Stream</code> 对象是后续应用<strong>滤镜 (<code>.filter()</code>)</strong> 的主体。</p><p><strong>语法:</strong></p><p>主要使用类似字典的方括号访问方式：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stream = input_node[stream_specifier]</span><br></pre></td></tr></tbody></table></figure><p>或者使用便捷属性（只适用于第一个默认流）：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">video_stream = input_node.video <span class="comment"># 等同于 input_node['v'] 或 input_node['v:0']</span></span><br><span class="line">audio_stream = input_node.audio <span class="comment"># 等同于 input_node['a'] 或 input_node['a:0']</span></span><br><span class="line">subtitle_stream = input_node.subtitle <span class="comment"># 等同于 input_node['s'] 或 input_node['s:0']</span></span><br></pre></td></tr></tbody></table></figure><p><strong>参数详解 (<code>stream_specifier</code>):</strong></p><p><code>stream_specifier</code> 是一个字符串，其格式与 FFmpeg 命令行中的流标识符非常相似，用于指定要选择哪个流。</p><table><thead><tr><th><strong>ffmpeg-python specifier</strong></th><th><strong>FFmpeg CLI 等效</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td><code>'v'</code> 或 <code>'v:0'</code></td><td><code>v</code> 或 <code>v:0</code></td><td>第一个视频流</td></tr><tr><td><code>'a'</code> 或 <code>'a:0'</code></td><td><code>a</code> 或 <code>a:0</code></td><td>第一个音频流</td></tr><tr><td><code>'s'</code> 或 <code>'s:0'</code></td><td><code>s</code> 或 <code>s:0</code></td><td>第一个字幕流</td></tr><tr><td><code>N</code> (整数)</td><td><code>N</code></td><td>第 N+1 个流（绝对索引，从 0 开始，不区分类型）</td></tr><tr><td><code>'v:N'</code></td><td><code>v:N</code></td><td>第 N+1 个<strong>视频</strong>流 (索引从 0 开始)</td></tr><tr><td><code>'a:N'</code></td><td><code>a:N</code></td><td>第 N+1 个<strong>音频</strong>流 (索引从 0 开始)</td></tr><tr><td><code>'s:N'</code></td><td><code>s:N</code></td><td>第 N+1 个<strong>字幕</strong>流 (索引从 0 开始)</td></tr><tr><td><em>其他</em></td><td><em>其他标识符</em></td><td><code>ffmpeg-python</code> 对更复杂的标识符 (如 <code>i:ID</code>, <code>p:ID</code>, <code>m:key:value</code>) 的直接支持可能有限，通常通过先 <code>probe</code> 获取信息再按 <code>index</code> 选择更可靠。</td></tr></tbody></table><p><strong>代码示例: 选择不同的流</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ffmpeg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设 input_multi.mkv 文件包含：</span></span><br><span class="line"><span class="comment"># 流 0: 视频 (1080p)</span></span><br><span class="line"><span class="comment"># 流 1: 音频 (英语, 立体声)</span></span><br><span class="line"><span class="comment"># 流 2: 音频 (日语, 5.1声道)</span></span><br><span class="line"><span class="comment"># 流 3: 字幕 (英语 SRT)</span></span><br><span class="line"><span class="comment"># 流 4: 字幕 (中文字幕 ASS)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 创建输入节点</span></span><br><span class="line">    input_node = ffmpeg.<span class="built_in">input</span>(<span class="string">'input_multi.mkv'</span>) <span class="comment"># 替换为你的多流文件路径</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 选择流 ---</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 选择第一个视频流 (最常用)</span></span><br><span class="line">    video_default = input_node[<span class="string">'v'</span>]</span><br><span class="line">    <span class="comment"># video_default = input_node.video # 效果相同</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"选择的默认视频流:"</span>, <span class="built_in">repr</span>(video_default))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 选择第一个音频流 (英语)</span></span><br><span class="line">    audio_eng = input_node[<span class="string">'a'</span>]</span><br><span class="line">    <span class="comment"># audio_eng = input_node['a:0'] # 效果相同</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"选择的默认音频流 (英语):"</span>, <span class="built_in">repr</span>(audio_eng))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 按类型和索引选择第二个音频流 (日语 5.1)</span></span><br><span class="line">    audio_jpn_51 = input_node[<span class="string">'a:1'</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"选择的第二个音频流 (日语):"</span>, <span class="built_in">repr</span>(audio_jpn_51))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. 按绝对索引选择第四个流 (这里是第一个字幕流)</span></span><br><span class="line">    <span class="comment"># 注意：索引从 0 开始，所以第 4 个流的索引是 3</span></span><br><span class="line">    subtitle_eng = input_node[<span class="number">3</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"选择的第 4 个流 (索引3, 英语字幕):"</span>, <span class="built_in">repr</span>(subtitle_eng))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. 按类型和索引选择第二个字幕流 (中文 ASS)</span></span><br><span class="line">    subtitle_chn = input_node[<span class="string">'s:1'</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"选择的第二个字幕流 (中文):"</span>, <span class="built_in">repr</span>(subtitle_chn))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 后续可以将选择的流用于处理 ---</span></span><br><span class="line">    <span class="comment"># 例如，只输出视频和日语 5.1 音频</span></span><br><span class="line">    <span class="comment"># output_node = ffmpeg.output(video_default, audio_jpn_51, 'output_jpn_audio.mp4')</span></span><br><span class="line">    <span class="comment"># output_node.run() # 执行 (需要 ffmpeg)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> ffmpeg.Error <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"处理出错: <span class="subst">{e.stderr.decode(errors=<span class="string">'ignore'</span>)}</span>"</span>)</span><br><span class="line"><span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"错误: 输入文件 'input_multi.mkv' 或 ffmpeg/ffprobe 命令未找到。"</span>)</span><br><span class="line"><span class="keyword">except</span> IndexError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"错误：尝试选择的流索引不存在。请用 ffprobe 确认文件流信息。"</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"发生未知错误: <span class="subst">{e}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><p>返回值:</p><p>成功选择流会返回一个 ffmpeg.Stream 对象。这个对象代表了处理图中的一个特定数据流，可以对其调用 .filter() 方法或将其传递给 ffmpeg.output()。如果指定的流不存在（例如，文件只有一个音频流，但你尝试选择 a:1），通常会在后续构建图或执行时（取决于库的实现细节）引发错误。</p><p><strong>知识点: 流选择</strong></p><table><thead><tr><th><strong>语法/属性</strong></th><th><strong>作用</strong></th><th><strong>返回值</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td><code>node[specifier]</code></td><td><strong>主要方式:</strong> 使用流标识符选择流。</td><td><code>ffmpeg.Stream</code></td><td><code>specifier</code> 如 <code>'v'</code>, <code>'a:1'</code>, <code>0</code> 等。</td></tr><tr><td><code>node.video</code></td><td>便捷属性，选择第一个视频流。</td><td><code>ffmpeg.Stream</code></td><td>等同于 <code>node['v']</code> 或 <code>node['v:0']</code>。</td></tr><tr><td><code>node.audio</code></td><td>便捷属性，选择第一个音频流。</td><td><code>ffmpeg.Stream</code></td><td>等同于 <code>node['a']</code> 或 <code>node['a:0']</code>。</td></tr><tr><td><code>node.subtitle</code></td><td>便捷属性，选择第一个字幕流。</td><td><code>ffmpeg.Stream</code></td><td>等同于 <code>node['s']</code> 或 <code>node['s:0']</code>。</td></tr></tbody></table><hr><h4 id="17-3-4-应用滤镜-Stream-filter"><a href="#17-3-4-应用滤镜-Stream-filter" class="headerlink" title="17.3.4 应用滤镜 (Stream.filter)"></a>17.3.4 应用滤镜 (<code>Stream.filter</code>)</h4><p><strong>作用:</strong></p><p>在 <code>ffmpeg-python</code> 中，获取到一个代表特定流的 <code>Stream</code> 对象后（例如通过 <code>input_node['v']</code> 或 <code>input_node['a']</code>），你可以对这个流<strong>应用一个或多个 FFmpeg 滤镜</strong>来进行处理。这是修改音视频内容的核心步骤，比如调整大小、裁剪、调色、调整音量等。</p><p>每次调用 <code>.filter()</code> 都会在处理图中添加一个滤镜节点，并返回一个代表<strong>滤镜处理后输出</strong>的新 <code>Stream</code> 对象。</p><p><strong>语法:</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filtered_stream = stream_object.<span class="built_in">filter</span>(filter_name, *args, **kwargs)</span><br></pre></td></tr></tbody></table></figure><p><strong>参数详解:</strong></p><ul><li><code>filter_name</code> (字符串, <strong>必需</strong>): 你想要应用的 FFmpeg 滤镜的名称。例如 <code>'scale'</code>, <code>'crop'</code>, <code>'volume'</code>, <code>'hflip'</code>, <code>'drawtext'</code> 等。你可以通过 <code>ffmpeg -filters</code> 查看所有可用滤镜。</li><li><code>*args</code> (可选位置参数): 传递给滤镜的位置参数。某些简单的滤镜可以直接按顺序接收参数值。例如，<code>scale</code> 滤镜可以接受宽度和高度作为前两个位置参数：<code>filter('scale', 640, 360)</code>。</li><li><code>**kwargs</code> (可选关键字参数): <strong>(推荐使用)</strong> 使用 <code>键=值</code> 的形式传递滤镜的选项。键名通常与 FFmpeg 滤镜文档中定义的选项名一致。使用关键字参数通常更清晰易读，不易出错。例如：<code>filter('scale', width=640, height=-2)</code>。<ul><li><strong>注意:</strong> 如果 FFmpeg 滤镜选项名包含特殊字符或与 Python 关键字冲突（虽然不常见），你可能需要用字典解包的方式传递：<code>filter('filter_name', **{'option-with-hyphen': 'value'})</code>。</li></ul></li></ul><p><strong>链式调用 (Chaining):</strong></p><p>由于 <code>.filter()</code> 返回一个新的 <code>Stream</code> 对象，你可以方便地进行<strong>链式调用</strong>，将多个滤镜按顺序应用到同一个流上，形成一个简单的<strong>滤镜链 (filterchain)</strong>（对应命令行中用逗号分隔多个滤镜）。</p><p><strong>代码示例 1: 缩放视频流</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ffmpeg</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">input_file = <span class="string">"input.mp4"</span></span><br><span class="line">output_file = <span class="string">"output.mp4"</span></span><br><span class="line">FFMPEG_PATH = <span class="string">'ffmpeg'</span>  <span class="comment"># 在系统变量中</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_video_duration</span>(<span class="params">input_file</span>):</span><br><span class="line">    <span class="string">"""获取视频时长（秒）"""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        probe = ffmpeg.probe(input_file)</span><br><span class="line">        duration = <span class="built_in">float</span>(probe[<span class="string">'format'</span>][<span class="string">'duration'</span>])</span><br><span class="line">        <span class="keyword">return</span> duration</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"获取视频时长失败: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_progress_bar</span>(<span class="params">current, total, bar_length=<span class="number">50</span></span>):</span><br><span class="line">    <span class="string">"""打印进度条"""</span></span><br><span class="line">    progress = <span class="built_in">min</span>(<span class="number">1.0</span>, current / total) <span class="keyword">if</span> total &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    arrow = <span class="string">'='</span> * <span class="built_in">int</span>(<span class="built_in">round</span>(progress * bar_length))</span><br><span class="line">    spaces = <span class="string">' '</span> * (bar_length - <span class="built_in">len</span>(arrow))</span><br><span class="line">    percent = <span class="built_in">round</span>(progress * <span class="number">100</span>, <span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">    sys.stdout.write(<span class="string">f"\r[<span class="subst">{arrow}</span><span class="subst">{spaces}</span>] <span class="subst">{percent}</span>%"</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scaleVedio</span>(<span class="params">input_file: <span class="built_in">str</span>, output_file: <span class="built_in">str</span>, width: <span class="built_in">int</span>, height: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 获取视频时长</span></span><br><span class="line">        duration = get_video_duration(input_file)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1.创建输入节点</span></span><br><span class="line">        input_node = ffmpeg.<span class="built_in">input</span>(input_file)</span><br><span class="line">        <span class="comment"># 2.选择视频流</span></span><br><span class="line">        video_stream = input_node[<span class="string">'v'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3.对视频流应用 scale 滤镜</span></span><br><span class="line">        scaled_video_stream = video_stream.<span class="built_in">filter</span>(<span class="string">'scale'</span>,width=width,height=height)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4.创建输出节点</span></span><br><span class="line">        <span class="comment"># a? 表示如果存在银平流则选择第一个，不存在也不会报错</span></span><br><span class="line">        output_node = ffmpeg.output(scaled_video_stream, input_node[<span class="string">'a?'</span>], output_file,</span><br><span class="line">                                    acodec=<span class="string">'copy'</span>)  <span class="comment"># 音频直接复制</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5. 查看命令 (调试)</span></span><br><span class="line">        cmd = output_node.<span class="built_in">compile</span>(cmd=FFMPEG_PATH)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"生成的命令:"</span>, cmd)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 6. 执行并显示进度条</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"开始执行缩放..."</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用subprocess代替直接run，以便捕获实时输出</span></span><br><span class="line">        process = subprocess.Popen(</span><br><span class="line">            cmd, </span><br><span class="line">            stderr=subprocess.PIPE, </span><br><span class="line">            universal_newlines=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 正则表达式用于从ffmpeg输出中提取时间信息</span></span><br><span class="line">        time_pattern = re.<span class="built_in">compile</span>(<span class="string">r"time=(\d+):(\d+):(\d+)\.\d+"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化进度条</span></span><br><span class="line">        print_progress_bar(<span class="number">0</span>, duration)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 读取ffmpeg的输出并更新进度条</span></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> process.stderr:</span><br><span class="line">            matches = time_pattern.search(line)</span><br><span class="line">            <span class="keyword">if</span> matches:</span><br><span class="line">                hours, minutes, seconds = <span class="built_in">map</span>(<span class="built_in">int</span>, matches.groups())</span><br><span class="line">                current_time = hours * <span class="number">3600</span> + minutes * <span class="number">60</span> + seconds</span><br><span class="line">                print_progress_bar(current_time, duration)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 等待进程完成</span></span><br><span class="line">        process.wait()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 完成进度条</span></span><br><span class="line">        print_progress_bar(duration, duration)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n缩放完成！"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> ffmpeg.Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\n缩放失败:"</span>, e.stderr.decode(errors=<span class="string">'ignore'</span>))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"\n发生错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    scaleVedio(input_file, output_file, <span class="number">1600</span>, -<span class="number">2</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>代码示例 2: 链式调用 - 调整音量并改变速度</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ffmpeg</span><br><span class="line"></span><br><span class="line">input_file = <span class="string">"input.mp4"</span></span><br><span class="line">output_file = <span class="string">"output.mp4"</span></span><br><span class="line">FFMPEG_PATH = <span class="string">'ffmpeg'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">adjust_video</span>(<span class="params">input_file: <span class="built_in">str</span>, output_file: <span class="built_in">str</span>, speed: <span class="built_in">float</span>, volume: <span class="built_in">float</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. 输入并选择音频流</span></span><br><span class="line">        input_stream = ffmpeg.<span class="built_in">input</span>(input_file)</span><br><span class="line">        audio_stream = input_stream[<span class="string">'a'</span>]</span><br><span class="line">        video_stream = input_stream[<span class="string">'v'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2.链式调用滤镜</span></span><br><span class="line">        process_audio_stream = (</span><br><span class="line">            audio_stream</span><br><span class="line">            .<span class="built_in">filter</span>(<span class="string">'volume'</span>, volume)  <span class="comment"># 调整音量</span></span><br><span class="line">            .<span class="built_in">filter</span>(<span class="string">'atempo'</span>, speed)  <span class="comment"># 调整播放速度</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2.1 处理视频流，添加速度调整</span></span><br><span class="line">        process_video_stream = (</span><br><span class="line">            video_stream</span><br><span class="line">            .<span class="built_in">filter</span>(<span class="string">'setpts'</span>, <span class="string">f'PTS/<span class="subst">{speed}</span>'</span>)  <span class="comment"># 调整视频播放速度</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 定义输出，视频不再使用copy编码，因为需要处理视频速度</span></span><br><span class="line">        output_node = ffmpeg.output(</span><br><span class="line">            process_video_stream,  <span class="comment"># 使用处理后的视频流</span></span><br><span class="line">            process_audio_stream,</span><br><span class="line">            output_file</span><br><span class="line">            <span class="comment"># 不再使用vcodec='copy'，让ffmpeg自动选择合适的编码器</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4.查看命令</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"生成的命令:"</span>, output_node.<span class="built_in">compile</span>(cmd=FFMPEG_PATH))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5. 执行命令</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"开始执行命令..."</span>)</span><br><span class="line">        output_node.run(cmd=FFMPEG_PATH, capture_stdout=<span class="literal">True</span>, capture_stderr=<span class="literal">True</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"执行完成！"</span>)</span><br><span class="line">    <span class="keyword">except</span> ffmpeg.Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"执行出错:"</span>, e.stderr.decode(<span class="string">'utf8'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    adjust_video(input_file, output_file, speed=<span class="number">5.0</span>, volume=<span class="number">3.0</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>返回值:</strong><br><code>.filter()</code> 方法返回一个新的 <strong><code>ffmpeg.Stream</code></strong> 对象，代表应用了该滤镜之后的输出流。你可以继续对这个新的 <code>Stream</code> 对象调用 <code>.filter()</code> 或将它传递给 <code>ffmpeg.output()</code>。</p><p><strong>知识点表格: <code>Stream.filter()</code></strong></p><table><thead><tr><th align="left">API / 参数</th><th align="left">类型</th><th align="left">作用</th><th align="left">备注</th></tr></thead><tbody><tr><td align="left"><code>.filter()</code></td><td align="left">Method on <code>Stream</code> obj</td><td align="left">对当前流应用一个 FFmpeg 滤镜。</td><td align="left">返回一个新的 <code>Stream</code> 对象，允许链式调用。</td></tr><tr><td align="left"><code>filter_name</code></td><td align="left"><code>str</code></td><td align="left">(必需) FFmpeg 滤镜名称。</td><td align="left">如 <code>'scale'</code>, <code>'volume'</code>。</td></tr><tr><td align="left"><code>*args</code></td><td align="left"></td><td align="left">(可选) 滤镜的位置参数。</td><td align="left">顺序必须与 FFmpeg 文档一致。</td></tr><tr><td align="left"><code>**kwargs</code></td><td align="left"><code>dict</code></td><td align="left">(可选/推荐) 滤镜的关键字参数。</td><td align="left">键名通常同 FFmpeg 选项名。</td></tr><tr><td align="left"><strong>返回值</strong></td><td align="left"><code>ffmpeg.Stream</code></td><td align="left">代表应用滤镜后的输出流。</td><td align="left"></td></tr></tbody></table><hr><h4 id="17-3-5-输出节点-ffmpeg-output-与输出选项详解-表格优化版"><a href="#17-3-5-输出节点-ffmpeg-output-与输出选项详解-表格优化版" class="headerlink" title="17.3.5 输出节点 (ffmpeg.output) 与输出选项详解 (表格优化版)"></a>17.3.5 输出节点 (<code>ffmpeg.output</code>) 与输出选项详解 (表格优化版)</h4><p><strong>作用:</strong></p><p><code>ffmpeg.output()</code> 函数用于在处理图中<strong>定义一个输出节点</strong>。它指定了处理流程的终点（即生成的输出文件），并且包含了将输入流编码、封装到这个输出文件时所需的所有配置，如使用的编码器、比特率、格式、时长限制等。</p><p><strong>语法:</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output_node = ffmpeg.output(*streams_and_filename, **kwargs)</span><br><span class="line"><span class="comment"># 或者更清晰地分开写：</span></span><br><span class="line"><span class="comment"># output_node = ffmpeg.output(stream1, stream2, ..., filename, **kwargs)</span></span><br></pre></td></tr></tbody></table></figure><p><strong>参数详解:</strong></p><ul><li><p><strong><code>*streams_and_filename</code></strong> (位置参数):</p><ul><li><strong><code>*streams</code></strong> (必需): 一个或多个 <code>ffmpeg.Stream</code> 对象，代表要包含在输出文件中的数据流。</li><li><strong><code>filename</code></strong> (字符串, 必需): <strong>最后一个</strong>位置参数，指定输出文件的路径和名称。扩展名（如 <code>.mp4</code>）有助于 FFmpeg 推断默认格式。</li></ul></li><li><p><strong><code>**kwargs</code></strong> (可选关键字参数): <strong>(核心)</strong> 这些参数是控制输出文件属性的关键，它们直接映射到 FFmpeg 命令中放在输出文件名前的<strong>输出选项</strong>。下面表格列出了最常用的 <code>kwargs</code>：</p><p><strong>常用 <code>ffmpeg.output()</code> 关键字参数 (<code>kwargs</code>)</strong></p><table><thead><tr><th align="left"><code>ffmpeg-python</code> kwarg</th><th align="left">FFmpeg CLI Option</th><th align="left">描述</th><th align="left">示例值 (<code>''</code> 内为字符串)</th></tr></thead><tbody><tr><td align="left"><code>f</code></td><td align="left"><code>-f &lt;format&gt;</code></td><td align="left">强制指定输出文件的<strong>容器格式</strong> (Muxer)。</td><td align="left"><code>'mp4'</code>, <code>'flv'</code>, <code>'hls'</code>, <code>'mp3'</code></td></tr><tr><td align="left"><code>vcodec</code> 或 <code>c:v</code></td><td align="left"><code>-c:v &lt;codec&gt;</code></td><td align="left">指定<strong>视频编码器</strong>。</td><td align="left"><code>'libx264'</code>, <code>'copy'</code>, <code>'h264_nvenc'</code></td></tr><tr><td align="left"><code>acodec</code> 或 <code>c:a</code></td><td align="left"><code>-c:a &lt;codec&gt;</code></td><td align="left">指定<strong>音频编码器</strong>。</td><td align="left"><code>'aac'</code>, <code>'libopus'</code>, <code>'copy'</code></td></tr><tr><td align="left"><code>scodec</code> 或 <code>c:s</code></td><td align="left"><code>-c:s &lt;codec&gt;</code></td><td align="left">指定<strong>字幕编码器</strong>。</td><td align="left"><code>'srt'</code>, <code>'mov_text'</code>, <code>'copy'</code></td></tr><tr><td align="left"><code>video_bitrate</code> 或 <code>b:v</code></td><td align="left"><code>-b:v &lt;rate&gt;</code></td><td align="left">设置视频<strong>平均比特率</strong>。与 <code>crf</code> 通常不同时使用。</td><td align="left"><code>'2M'</code>, <code>'1500k'</code></td></tr><tr><td align="left"><code>audio_bitrate</code> 或 <code>b:a</code></td><td align="left"><code>-b:a &lt;rate&gt;</code></td><td align="left">设置音频<strong>平均比特率</strong>。</td><td align="left"><code>'128k'</code>, <code>'192k'</code></td></tr><tr><td align="left"><code>crf</code></td><td align="left"><code>-crf &lt;value&gt;</code></td><td align="left"><strong>恒定速率因子</strong> (用于 x264/x265 等)，控制视频质量。值越低质量越好。<strong>推荐使用</strong>。</td><td align="left"><code>23</code>, <code>28</code></td></tr><tr><td align="left"><code>preset</code></td><td align="left"><code>-preset &lt;value&gt;</code></td><td align="left">编码器<strong>预设</strong>，平衡速度与压缩率。</td><td align="left"><code>'fast'</code>, <code>'medium'</code>, <code>'slow'</code></td></tr><tr><td align="left"><code>pix_fmt</code></td><td align="left"><code>-pix_fmt &lt;format&gt;</code></td><td align="left">指定输出视频的<strong>像素格式</strong>，影响颜色和兼容性。</td><td align="left"><code>'yuv420p'</code> (常用)</td></tr><tr><td align="left"><code>vf</code></td><td align="left"><code>-vf &lt;filter_string&gt;</code></td><td align="left">应用简单的视频滤镜链 (字符串形式)。<strong>注意：推荐使用 <code>.filter()</code> 方法构建。</strong></td><td align="left"><code>'scale=640:-1,hflip'</code></td></tr><tr><td align="left"><code>af</code></td><td align="left"><code>-af &lt;filter_string&gt;</code></td><td align="left">应用简单的音频滤镜链 (字符串形式)。<strong>注意：推荐使用 <code>.filter()</code> 方法构建。</strong></td><td align="left"><code>'volume=0.8,atempo=1.1'</code></td></tr><tr><td align="left"><code>t</code></td><td align="left"><code>-t &lt;duration&gt;</code></td><td align="left">限制输出文件的<strong>持续时长</strong>（秒）。</td><td align="left"><code>60</code>, <code>'00:01:30.5'</code></td></tr><tr><td align="left"><code>to</code></td><td align="left"><code>-to &lt;time&gt;</code></td><td align="left">指定输出文件的<strong>结束时间点</strong>（相对于输入开始时间）。</td><td align="left"><code>120</code>, <code>'00:02:00.0'</code></td></tr><tr><td align="left"><code>movflags</code></td><td align="left"><code>-movflags &lt;flags&gt;</code></td><td align="left">(主要用于 MP4) 设置 MP4 的标志。<code>'+faststart'</code> <strong>强烈推荐</strong>用于网络播放。</td><td align="left"><code>'+faststart'</code></td></tr><tr><td align="left"><code>shortest</code></td><td align="left"><code>-shortest</code></td><td align="left">(布尔值 <code>True</code>) 当有多个输入流时长不同时，使输出时长等于<strong>最短</strong>的输入流。</td><td align="left"><code>True</code></td></tr><tr><td align="left"><code>map</code></td><td align="left"><code>-map &lt;specifier&gt;</code></td><td align="left">(字符串列表) 手动指定流映射。<strong>注意：通常直接传递 Stream 对象给 <code>output()</code> 更 Pythonic，一般无需此参数。</strong></td><td align="left"><code>['0:v:0', '1:a']</code></td></tr><tr><td align="left"><code>**{'option': value}</code></td><td align="left"><code>-option value</code></td><td align="left">传递 <code>ffmpeg-python</code> <strong>没有直接关键字参数</strong>对应的原生 FFmpeg 选项。</td><td align="left"><code>**{'q:v': 2}</code></td></tr></tbody></table></li></ul><p><strong>代码示例 :</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ffmpeg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设已经有输入节点和处理后的流</span></span><br><span class="line"><span class="comment"># input_node = ffmpeg.input('input.mp4')</span></span><br><span class="line"><span class="comment"># video_processed = input_node['v'].filter('scale', 640, -1) # 假设处理过</span></span><br><span class="line"><span class="comment"># audio_original = input_node['a']</span></span><br><span class="line"></span><br><span class="line">FFMPEG_PATH = <span class="string">'ffmpeg'</span> <span class="comment"># 假设在 PATH 中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 示例 1: 输出为 MP4，指定编码器和质量 (CRF) ---</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     print("\n--- 示例 1: 输出 MP4 (H.264/AAC, CRF) ---")</span></span><br><span class="line"><span class="comment">#     out1 = ffmpeg.output(</span></span><br><span class="line"><span class="comment">#         video_processed,        # 处理后的视频流</span></span><br><span class="line"><span class="comment">#         audio_original,         # 原始音频流</span></span><br><span class="line"><span class="comment">#         'output_h264_crf.mp4',  # 输出文件名</span></span><br><span class="line"><span class="comment">#         vcodec='libx264',       # 视频编码器</span></span><br><span class="line"><span class="comment">#         crf=24,                 # 视频质量控制</span></span><br><span class="line"><span class="comment">#         preset='fast',          # 编码速度</span></span><br><span class="line"><span class="comment">#         acodec='aac',           # 音频编码器</span></span><br><span class="line"><span class="comment">#         audio_bitrate='128k',   # 音频比特率</span></span><br><span class="line"><span class="comment">#         pix_fmt='yuv420p',      # 像素格式</span></span><br><span class="line"><span class="comment">#         movflags='+faststart'   # MP4 优化</span></span><br><span class="line"><span class="comment">#     )</span></span><br><span class="line"><span class="comment">#     print("命令:", out1.compile(cmd=FFMPEG_PATH))</span></span><br><span class="line"><span class="comment">#     # out1.run(cmd=FFMPEG_PATH, capture_stderr=True, overwrite_output=True)</span></span><br><span class="line"><span class="comment">#     print("输出 1 完成 (注释掉了执行)")</span></span><br><span class="line"><span class="comment"># except ffmpeg.Error as e: print("错误:", e.stderr.decode())</span></span><br><span class="line"><span class="comment"># except Exception as e: print(f"发生错误: {e}")</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 示例 2: 输出为 WebM，指定比特率 ---</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     print("\n--- 示例 2: 输出 WebM (VP9/Opus, Bitrate) ---")</span></span><br><span class="line"><span class="comment">#     out2 = ffmpeg.output(</span></span><br><span class="line"><span class="comment">#         video_processed,</span></span><br><span class="line"><span class="comment">#         audio_original,</span></span><br><span class="line"><span class="comment">#         'output_vp9_opus.webm',</span></span><br><span class="line"><span class="comment">#         # f='webm',             # 通常根据扩展名可推断</span></span><br><span class="line"><span class="comment">#         vcodec='libvpx-vp9',    # VP9 视频编码</span></span><br><span class="line"><span class="comment">#         video_bitrate='1M',     # 视频目标比特率 1Mbps</span></span><br><span class="line"><span class="comment">#         acodec='libopus',       # Opus 音频编码</span></span><br><span class="line"><span class="comment">#         audio_bitrate='96k'     # 音频目标比特率 96kbps</span></span><br><span class="line"><span class="comment">#     )</span></span><br><span class="line"><span class="comment">#     print("命令:", out2.compile(cmd=FFMPEG_PATH))</span></span><br><span class="line"><span class="comment">#     # out2.run(cmd=FFMPEG_PATH, capture_stderr=True, overwrite_output=True)</span></span><br><span class="line"><span class="comment">#     print("输出 2 完成 (注释掉了执行)")</span></span><br><span class="line"><span class="comment"># except ffmpeg.Error as e: print("错误:", e.stderr.decode())</span></span><br><span class="line"><span class="comment"># except Exception as e: print(f"发生错误: {e}")</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 示例 3: 仅提取音频并转换为 MP3，设置时长 ---</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     print("\n--- 示例 3: 提取 MP3 音频 (前 30 秒) ---")</span></span><br><span class="line"><span class="comment">#     out3 = ffmpeg.output(</span></span><br><span class="line"><span class="comment">#         audio_original,           # 只传入音频流</span></span><br><span class="line"><span class="comment">#         'output_audio_30s.mp3',</span></span><br><span class="line"><span class="comment">#         acodec='libmp3lame',      # MP3 编码器</span></span><br><span class="line"><span class="comment">#         audio_bitrate='192k',</span></span><br><span class="line"><span class="comment">#         t=30                      # 只输出前 30 秒</span></span><br><span class="line"><span class="comment">#     )</span></span><br><span class="line"><span class="comment">#     print("命令:", out3.compile(cmd=FFMPEG_PATH))</span></span><br><span class="line"><span class="comment">#     # out3.run(cmd=FFMPEG_PATH, capture_stderr=True, overwrite_output=True)</span></span><br><span class="line"><span class="comment">#     print("输出 3 完成 (注释掉了执行)")</span></span><br><span class="line"><span class="comment"># except ffmpeg.Error as e: print("错误:", e.stderr.decode())</span></span><br><span class="line"><span class="comment"># except Exception as e: print(f"发生错误: {e}")</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 示例 4: 改变容器格式，直接复制流 (Remuxing) ---</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     print("\n--- 示例 4: 转换容器 MKV -&gt; MP4 (流复制) ---")</span></span><br><span class="line"><span class="comment">#     in_mkv = ffmpeg.input('input.mkv') # 假设此文件存在</span></span><br><span class="line"><span class="comment">#     out4 = ffmpeg.output(</span></span><br><span class="line"><span class="comment">#         in_mkv,                 # 直接传入输入节点，自动选择流</span></span><br><span class="line"><span class="comment">#         'output_remux.mp4',</span></span><br><span class="line"><span class="comment">#         codec='copy',           # 对所有流使用 copy (vcodec='copy', acodec='copy')</span></span><br><span class="line"><span class="comment">#         movflags='+faststart'</span></span><br><span class="line"><span class="comment">#     )</span></span><br><span class="line"><span class="comment">#     print("命令:", out4.compile(cmd=FFMPEG_PATH))</span></span><br><span class="line"><span class="comment">#     # out4.run(cmd=FFMPEG_PATH, capture_stderr=True, overwrite_output=True)</span></span><br><span class="line"><span class="comment">#     print("输出 4 完成 (注释掉了执行)")</span></span><br><span class="line"><span class="comment"># except ffmpeg.Error as e: print("错误:", e.stderr.decode())</span></span><br><span class="line"><span class="comment"># except FileNotFoundError: print("错误: input.mkv 未找到")</span></span><br><span class="line"><span class="comment"># except Exception as e: print(f"发生错误: {e}")</span></span><br></pre></td></tr></tbody></table></figure><p><strong>返回值:</strong><br><code>ffmpeg.output()</code> 函数返回一个代表输出操作的 <strong><code>OutputNode</code> 对象</strong>。你需要调用这个对象的 <code>.run()</code> 或 <code>.run_async()</code> 方法来最终执行整个处理流程。</p><p><strong>知识点表格: <code>ffmpeg.output()</code></strong></p><table><thead><tr><th align="left">API / 参数</th><th align="left">类型</th><th align="left">作用</th><th align="left">备注</th></tr></thead><tbody><tr><td align="left"><code>ffmpeg.output()</code></td><td align="left">Function</td><td align="left">创建输出节点，定义输出文件和编码/格式选项。</td><td align="left">处理流程的终点。</td></tr><tr><td align="left"><code>*streams</code></td><td align="left"><code>ffmpeg.Stream</code></td><td align="left">(必需) 一个或多个要写入的流对象。</td><td align="left">来自 <code>input</code> 或 <code>filter</code> 的结果。</td></tr><tr><td align="left"><code>filename</code></td><td align="left"><code>str</code></td><td align="left">(必需) 输出文件的路径和名称。</td><td align="left">扩展名用于推断格式。</td></tr><tr><td align="left"><code>**kwargs</code></td><td align="left"><code>dict</code></td><td align="left">(可选) 对应 FFmpeg 的输出选项。</td><td align="left">控制编码、质量、格式、时长等。</td></tr><tr><td align="left"><strong>返回值</strong></td><td align="left"><code>OutputNode</code></td><td align="left">代表输出操作的节点对象。</td><td align="left">可以调用 <code>.run()</code>, <code>.compile()</code> 等。</td></tr></tbody></table><hr><h4 id="17-3-6-全局选项与调试工具-compile-view-global-args"><a href="#17-3-6-全局选项与调试工具-compile-view-global-args" class="headerlink" title="17.3.6 全局选项与调试工具 (.compile, .view, global_args)"></a>17.3.6 全局选项与调试工具 (<code>.compile</code>, <code>.view</code>, <code>global_args</code>)</h4><p>当你构建的 FFmpeg 处理流程变得复杂，或者执行结果不符合预期时，<code>ffmpeg-python</code> 提供了一些工具来帮助你理解和调试发生了什么。</p><h6 id="API-Node-compile-查看生成的命令"><a href="#API-Node-compile-查看生成的命令" class="headerlink" title="API: Node.compile() - 查看生成的命令"></a>API: <code>Node.compile()</code> - 查看生成的命令</h6><p><strong>作用:</strong><br>这个方法<strong>不会</strong>执行任何 FFmpeg 命令。它的唯一作用是<strong>将你通过 <code>ffmpeg-python</code> 构建的处理图（从输入到输出）编译成最终将要传递给 <code>ffmpeg</code> 可执行程序的命令行参数列表</strong>。这对于以下情况<strong>极其有用</strong>：</p><ul><li><strong>调试:</strong> 当 <code>.run()</code> 报错时，你可以先 <code>.compile()</code> 看看生成的具体命令是什么，然后将这个命令<strong>手动复制</strong>到你的终端里执行，这样可以更直接地看到 FFmpeg 的原始输出和错误信息，更容易定位问题。</li><li><strong>学习:</strong> 通过观察 <code>ffmpeg-python</code> 代码如何转换为命令行参数，可以加深对 FFmpeg 命令和 <code>ffmpeg-python</code> 库本身的理解。</li><li><strong>集成:</strong> 在某些特殊情况下，你可能只想用 <code>ffmpeg-python</code> 来构建命令参数列表，然后用自己定制的 <code>subprocess</code> 调用或其他方式来执行它。</li></ul><p><strong>语法:</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arguments_list = output_node.<span class="built_in">compile</span>(cmd=<span class="string">'ffmpeg'</span>)</span><br></pre></td></tr></tbody></table></figure><p><strong>参数详解:</strong></p><ul><li><code>cmd</code> (字符串, 可选): 指定 <code>ffmpeg</code> 可执行文件的路径。这应该与你传递给 <code>.run()</code> 的 <code>cmd</code> 参数保持一致。默认是 <code>'ffmpeg'</code>。</li></ul><p><strong>代码示例:</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ffmpeg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建一个稍微复杂点的处理流程 (仅用于演示 compile)</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    in_file = ffmpeg.<span class="built_in">input</span>(<span class="string">'input.mp4'</span>, ss=<span class="number">5</span>) <span class="comment"># 输入，从第5秒开始</span></span><br><span class="line">    logo = ffmpeg.<span class="built_in">input</span>(<span class="string">'logo.png'</span>)</span><br><span class="line"></span><br><span class="line">    processed_video = (</span><br><span class="line">        in_file[<span class="string">'v'</span>]</span><br><span class="line">        .<span class="built_in">filter</span>(<span class="string">'scale'</span>, <span class="number">640</span>, -<span class="number">1</span>) <span class="comment"># 缩放</span></span><br><span class="line">        .overlay(logo[<span class="string">'v'</span>], x=<span class="number">10</span>, y=<span class="number">10</span>) <span class="comment"># 叠加 logo</span></span><br><span class="line">    )</span><br><span class="line">    output_node = ffmpeg.output(</span><br><span class="line">        processed_video,          <span class="comment"># 处理后的视频</span></span><br><span class="line">        in_file[<span class="string">'a'</span>],           <span class="comment"># 原始音频</span></span><br><span class="line">        <span class="string">'output_compiled.mp4'</span>,  <span class="comment"># 输出文件</span></span><br><span class="line">        t=<span class="number">15</span>,                   <span class="comment"># 输出时长 15 秒</span></span><br><span class="line">        vcodec=<span class="string">'libx264'</span>,</span><br><span class="line">        acodec=<span class="string">'aac'</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调用 compile 获取参数列表</span></span><br><span class="line">    ffmpeg_args = output_node.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印生成的参数列表</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"--- Generated FFmpeg Command Arguments (List) ---"</span>)</span><br><span class="line">    <span class="built_in">print</span>(ffmpeg_args)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 为了更直观，可以尝试将其拼接成命令行字符串（注意空格和引号）</span></span><br><span class="line">    <span class="comment"># 注意：直接 join 可能对包含空格的参数处理不当，仅作演示</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n--- Equivalent Command Line (Approximation) ---"</span>)</span><br><span class="line">    <span class="comment"># 在实际执行时，推荐直接将列表传递给 subprocess.run</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"ffmpeg <span class="subst">{<span class="string">' '</span>.join(ffmpeg_args)}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"构建图或编译时出错: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>运行上述代码（假设输入文件存在），你将在控制台看到一个 Python 列表，其中包含了 <code>ffmpeg-python</code> 为你生成的所有命令行参数，例如 <code>['-i', 'input.mp4', '-i', 'logo.png', '-filter_complex', '[1:v]...[outv]', '-map', '[outv]', ...]</code>。你可以把这个列表（去掉 Python 的方括号和引号，加上开头的 <code>ffmpeg</code>）组合成一个完整的命令行字符串，在终端里运行来验证。</p><p><strong>返回值:</strong><br><code>compile()</code> 方法返回一个<strong>字符串列表 (<code>list[str]</code>)</strong>，代表将要传递给 <code>ffmpeg</code> 可执行程序的参数。</p><p><strong>知识点表格: <code>Node.compile()</code></strong></p><table><thead><tr><th align="left">API / 参数</th><th align="left">类型</th><th align="left">作用</th><th align="left">备注</th></tr></thead><tbody><tr><td align="left"><code>.compile()</code></td><td align="left">Method on Node</td><td align="left">将处理图编译为 FFmpeg 命令行参数列表，<strong>不执行</strong>。</td><td align="left">主要用于调试和学习。</td></tr><tr><td align="left"><code>cmd</code></td><td align="left"><code>str</code></td><td align="left">(可选) <code>ffmpeg</code> 可执行文件路径（通常不需要指定）。</td><td align="left"></td></tr><tr><td align="left"><strong>返回值</strong></td><td align="left"><code>list[str]</code></td><td align="left">代表命令行参数的字符串列表。</td><td align="left"></td></tr></tbody></table><h6 id="API-Node-view-可视化处理图"><a href="#API-Node-view-可视化处理图" class="headerlink" title="API: Node.view() - 可视化处理图"></a>API: <code>Node.view()</code> - 可视化处理图</h6><p><strong>作用:</strong><br>对于非常复杂的滤镜图，文本描述可能不够直观。<code>.view()</code> 方法可以利用 <strong>Graphviz</strong> 工具自动生成处理图的<strong>可视化流程图</strong>（通常是 PNG, PDF 或 SVG 格式），并尝试用系统默认程序打开它。这有助于你理解数据流是如何在不同的滤镜节点之间传递和连接的。</p><p><strong>重要前提:</strong><br>要使用 <code>.view()</code>，你<strong>必须</strong>：</p><ol><li><strong>安装 <code>graphviz</code> Python 库:</strong> <code>pip install graphviz</code></li><li><strong>安装 Graphviz 软件本身:</strong> 这是一个独立的开源图形可视化软件。你需要根据你的操作系统进行安装，并确保其 <code>dot</code> 命令可以在系统的 PATH 环境变量中被找到。<ul><li><strong>Windows:</strong> 从 Graphviz 官网 (<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly9ncmFwaHZpei5vcmcvZG93bmxvYWQv">https://graphviz.org/download/</a>) 下载 msi 安装包并安装，<strong>务必</strong>在安装过程中勾选 “Add Graphviz to the system PATH for all users” 或类似选项。</li><li><strong>macOS:</strong> <code>brew install graphviz</code></li><li><strong>Linux (Debian/Ubuntu):</strong> <code>sudo apt install graphviz</code></li><li><strong>Linux (Fedora/CentOS):</strong> <code>sudo yum install graphviz</code> 或 <code>sudo dnf install graphviz</code></li></ul></li></ol><p><strong>语法:</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">output_node.view(filename=<span class="string">'graph'</span>, <span class="built_in">format</span>=<span class="string">'png'</span>)</span><br></pre></td></tr></tbody></table></figure><p><strong>参数详解:</strong></p><ul><li><code>filename</code> (字符串, 可选): 生成的图形文件的基本名称（不含扩展名），默认为 <code>'graph'</code>。</li><li><code>format</code> (字符串, 可选): 输出图形的文件格式，默认为 <code>'png'</code>。可以是 Graphviz <code>dot</code> 命令支持的任何格式，如 <code>'pdf'</code>, <code>'svg'</code>。</li></ul><p><strong>代码示例:</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ffmpeg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设 output_node 是之前构建好的复杂输出节点</span></span><br><span class="line"><span class="comment"># output_node = ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 尝试生成并查看处理图 (需要正确安装 Graphviz)</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n--- 尝试生成并显示处理流程图 ---"</span>)</span><br><span class="line">    <span class="comment"># 这会生成 graph.gv 和 graph.gv.png (或你指定的格式) 文件</span></span><br><span class="line">    <span class="comment"># 并尝试用系统默认程序打开 png 文件</span></span><br><span class="line">    output_node.view(filename=<span class="string">'my_ffmpeg_graph'</span>, <span class="built_in">format</span>=<span class="string">'png'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"图形文件已生成 (或尝试打开)。请查找 my_ffmpeg_graph.gv 和 my_ffmpeg_graph.gv.png"</span>)</span><br><span class="line"><span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"错误：无法执行 'dot' 命令。请确保 Graphviz 已正确安装并已添加到系统 PATH。"</span>)</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"错误：需要安装 'graphviz' Python 库 (pip install graphviz)。"</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"生成图形时发生错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>返回值:</strong><br><code>.view()</code> 方法通常返回 <code>None</code>，它的主要作用是产生副作用（生成文件和尝试打开查看器）。</p><p><strong>知识点表格: <code>Node.view()</code></strong></p><table><thead><tr><th align="left">API / 参数</th><th align="left">类型</th><th align="left">作用</th><th align="left">备注</th></tr></thead><tbody><tr><td align="left"><code>.view()</code></td><td align="left">Method on Node</td><td align="left">使用 Graphviz 生成处理流程图的可视化文件。</td><td align="left"><strong>依赖 Graphviz 软件和 Python 库。</strong></td></tr><tr><td align="left"><code>filename</code></td><td align="left"><code>str</code></td><td align="left">(可选) 输出图形文件的基本名称。</td><td align="left">默认 <code>'graph'</code>。</td></tr><tr><td align="left"><code>format</code></td><td align="left"><code>str</code></td><td align="left">(可选) 输出图形的文件格式。</td><td align="left">默认 <code>'png'</code>。支持 ‘pdf’, ‘svg’ 等。</td></tr><tr><td align="left"><strong>返回值</strong></td><td align="left"><code>None</code></td><td align="left">-</td><td align="left">主要产生副作用（生成文件/打开查看器）。</td></tr></tbody></table><h6 id="API-全局选项-global-args-in-run-run-async"><a href="#API-全局选项-global-args-in-run-run-async" class="headerlink" title="API: 全局选项 (global_args in .run() / .run_async())"></a>API: 全局选项 (<code>global_args</code> in <code>.run()</code> / <code>.run_async()</code>)</h6><p><strong>作用:</strong><br>有时候你需要传递 FFmpeg 的<strong>全局选项</strong>（即放在 <code>ffmpeg</code> 命令之后、第一个 <code>-i</code> 之前的选项），例如 <code>-progress</code> 来输出进度信息，或者 <code>-report</code> 生成详细日志文件，或者 <code>-v</code> 覆盖默认日志级别。<code>ffmpeg-python</code> 允许你在执行 <code>.run()</code> 或 <code>.run_async()</code> 时通过 <code>global_args</code> 参数来传递这些选项。</p><p><strong>语法:</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">output_node.run(..., global_args=[<span class="string">'-option1'</span>, <span class="string">'value1'</span>, <span class="string">'-option2'</span>, ...])</span><br></pre></td></tr></tbody></table></figure><p><strong>参数详解:</strong></p><ul><li><code>global_args</code> (列表 <code>list[str]</code>, 可选): 一个包含全局选项及其值的<strong>字符串列表</strong>。每个选项和它的值（如果需要值的话）应该作为列表中的<strong>独立元素</strong>。</li></ul><p><strong>代码示例:</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ffmpeg</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">output_node = ffmpeg.<span class="built_in">input</span>(<span class="string">'input.mp4'</span>).output(<span class="string">'output.avi'</span>)</span><br><span class="line">FFMPEG_PATH = <span class="string">'ffmpeg'</span></span><br><span class="line">PROGRESS_FILE = <span class="string">'ffmpeg_progress.txt'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保进度文件不存在，以免混淆</span></span><br><span class="line"><span class="keyword">if</span> os.path.exists(PROGRESS_FILE):</span><br><span class="line">    os.remove(PROGRESS_FILE)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n--- 示例：使用 global_args 传递 -progress ---"</span>)</span><br><span class="line">    <span class="comment"># 使用 -progress 选项将详细进度写入文件</span></span><br><span class="line">    <span class="comment"># 注意：-progress 需要一个目标，这里是 file: 协议</span></span><br><span class="line">    output_node.run(</span><br><span class="line">        cmd=FFMPEG_PATH,</span><br><span class="line">        capture_stderr=<span class="literal">True</span>,</span><br><span class="line">        overwrite_output=<span class="literal">True</span>,</span><br><span class="line">        global_args=[<span class="string">'-progress'</span>, <span class="string">f'file:<span class="subst">{PROGRESS_FILE}</span>'</span>] <span class="comment"># 传递全局选项</span></span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"FFmpeg 执行完成。进度信息已写入 <span class="subst">{PROGRESS_FILE}</span> (如果成功)。"</span>)</span><br><span class="line">    <span class="comment"># 你可以在这里读取并解析 PROGRESS_FILE 的内容</span></span><br><span class="line">    <span class="comment"># with open(PROGRESS_FILE, 'r') as f:</span></span><br><span class="line">    <span class="comment">#     progress_data = f.read()</span></span><br><span class="line">    <span class="comment">#     print("进度文件内容:\n", progress_data[:500] + "...") # 只打印部分</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> ffmpeg.Error <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"FFmpeg 执行失败:"</span>)</span><br><span class="line">    <span class="built_in">print</span>(e.stderr.decode(errors=<span class="string">'ignore'</span>))</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"执行时发生错误: <span class="subst">{e}</span>"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>知识点表格: <code>global_args</code> (用于 <code>.run()</code> / <code>.run_async()</code>)</strong></p><table><thead><tr><th align="left">参数名</th><th align="left">类型</th><th align="left">作用</th><th align="left">备注</th></tr></thead><tbody><tr><td align="left"><code>global_args</code></td><td align="left"><code>list[str]</code></td><td align="left">(可选) 传递给 FFmpeg 的全局选项列表。</td><td align="left">每个选项及其值是列表中的独立字符串元素。</td></tr></tbody></table><hr></div></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/16/684f747174bc3.webp" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/16/684f747174bc3.webp" title="头像" alt="头像"></a><div class="post-copyright__author_name">Prorise</div><div class="post-copyright__author_desc">这聒噪的世界让沉默的人显得另类</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://prorise-cool.github.io/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl(&quot;https://prorise-cool.github.io/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/&quot;)">Python教程：深入其境</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/bYMH/418X445/ef9a3f68-d36a-441a-95fe-8179b1a25992.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/bYMH/418X445/ef9a3f68-d36a-441a-95fe-8179b1a25992.png" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/cYu3/347X390/zfb.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tc.z.wiki/autoupload/iXoPwUD80CPTvQUyITTBFOykMT9FcWW5SasRoXZEs3Wyl5f0KlZfm6UsKj-HyTuv/20250609/cYu3/347X390/zfb.png" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display:none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://prorise-cool.github.io/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Python教程：深入其境&amp;url=https://prorise-cool.github.io/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/&amp;pic=https://bu.dusays.com/2025/06/17/685113b7c5e0c.webp" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Prorise-cool.github.io" target="_blank">格物致知</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Python/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>Python<span class="tagsPageCount">3</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2025/06/17/685113b7c7d81.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c39b1.webp" onerror="onerror=null,src=&quot;/img/404.jpg&quot;" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python教程：Python知识点前篇速览</div></div></a></div><div class="next-post pull-right"><a href="/2025/06/19/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%8B%E7%AF%87/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c7d81.webp" onerror="onerror=null,src=&quot;/img/404.jpg&quot;" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Python教程：应用之巅</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/" title="Python教程：Python知识点前篇速览"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c39b1.webp" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-06-17</div><div class="title">Python教程：Python知识点前篇速览</div></div></a></div><div><a href="/2025/06/19/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%8B%E7%AF%87/" title="Python教程：应用之巅"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c7d81.webp" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-06-19</div><div class="title">Python教程：应用之巅</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" rel="external nofollow noreferrer">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Waline</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/16/684f747174bc3.webp" onerror="this.onerror=null,this.src=&quot;/img/friend_404.gif&quot;" alt="avatar"><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/user/status.png" alt="status"></div></div><div class="author-info__description"><div style="line-height:1.4;color:rgba(255,255,255,.9);text-align:center">🚀 全栈开发者，专注于构建优雅高效的数字解决方案<br><span style="color:#fff;font-weight:700">前端 · 后端 · 架构 · 优化</span><br>📚 分享实战经验，一起探索技术边界</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Prorise</h1><div class="author-info__desc">这聒噪的世界让沉默的人显得另类</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/361040115?spm_id_from=333.1387.0.0" rel="external nofollow noreferrer" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background:url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center/100% no-repeat"></div><div class="back face" style="background:url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center/100% no-repeat"></div></div></div></div><div class="card-widget card-latest-comments"><div class="item-headline"><i class="fas fa-comments"></i><span>最新评论</span></div><div class="item-content"><a href="/messages/" class="headline-right" title="查看更多"><i class="fas fa-angle-right"></i></a><div class="aside-list" id="latest-comments"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%BA%94%E7%AB%A0%EF%BC%9APython-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%85%A8%E8%A7%A3%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">第十五章：Python 网络编程全解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80"><span class="toc-number">1.1.</span> <span class="toc-text">15.1 网络编程基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-Socket-%E7%BC%96%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.2.</span> <span class="toc-text">15.2 Socket 编程详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-2-1-TCP-%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-number">1.2.1.</span> <span class="toc-text">15.2.1 TCP 套接字</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#TCP-%E5%A5%97%E6%8E%A5%E5%AD%97%E7%89%B9%E6%80%A7"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">TCP 套接字特性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E4%B8%AD%E7%9A%84-TCP-%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">Python 中的 TCP 客户端示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E4%B8%AD%E7%9A%84-TCP-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">Python 中的 TCP 服务器示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-2-2-UDP-%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-number">1.2.2.</span> <span class="toc-text">15.2.2 UDP 套接字</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#UDP-%E5%A5%97%E6%8E%A5%E5%AD%97%E7%89%B9%E6%80%A7"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">UDP 套接字特性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E4%B8%AD%E7%9A%84-UDP-%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">Python 中的 UDP 客户端示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E4%B8%AD%E7%9A%84-UDP-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">Python 中的 UDP 服务器示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-2-3-TCP-%E4%B8%8E-UDP-%E5%AF%B9%E6%AF%94"><span class="toc-number">1.2.3.</span> <span class="toc-text">15.2.3 TCP 与 UDP 对比</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-3-%E9%80%9A%E7%94%A8%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E4%B8%8E-Python-%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text">15.3 通用网络协议与 Python 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-3-1-HTTP-HTTPS-%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.1.</span> <span class="toc-text">15.3.1 HTTP/HTTPS 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HTTP-HTTPS-%E5%8D%8F%E8%AE%AE%E7%89%B9%E6%80%A7"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">HTTP/HTTPS 协议特性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E6%A0%87%E5%87%86%E5%BA%93-HTTP-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">Python 标准库 HTTP 客户端</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9-HTTP-%E5%BA%93"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">推荐的第三方 HTTP 库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#requests-%E5%BA%93%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">requests 库示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#aiohttp-%E5%BC%82%E6%AD%A5-HTTP-%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">aiohttp 异步 HTTP 示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-3-2-FTP-SFTP-%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.2.</span> <span class="toc-text">15.3.2 FTP/SFTP 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#FTP-SFTP-%E5%8D%8F%E8%AE%AE%E7%89%B9%E6%80%A7"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">FTP/SFTP 协议特性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E6%A0%87%E5%87%86%E5%BA%93-FTP-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">Python 标准库 FTP 客户端</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%AC%E5%9C%B0%E7%9A%84-FTP-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">快速搭建一个本地的 FTP 服务器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-FTP-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">实现 FTP 文件上传下载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E7%9A%84-FTP-SFTP-%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">推荐的 FTP/SFTP 第三方库</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-3-3-WebSocket-%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.3.</span> <span class="toc-text">15.3.3 WebSocket 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#WebSocket-%E5%8D%8F%E8%AE%AE%E7%89%B9%E6%80%A7"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">WebSocket 协议特性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E7%9A%84-WebSocket-%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">推荐的 WebSocket 第三方库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#websockets-%E5%BA%93%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">websockets 库示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-websockets-%E5%AE%9E%E7%8E%B0%E5%9C%A8%E7%BA%BF%E8%81%8A%E5%A4%A9%E5%AE%A4"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">使用 websockets 实现在线聊天室</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-3-4-MQTT-%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.4.</span> <span class="toc-text">15.3.4 MQTT 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#MQTT-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">MQTT 应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-%E7%89%A9%E8%81%94%E7%BD%91-IoT-%E6%A0%B8%E5%BF%83%E9%A2%86%E5%9F%9F"><span class="toc-number">1.3.4.1.1.</span> <span class="toc-text">1.物联网 (IoT) - 核心领域</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-%E5%B7%A5%E4%B8%9A%E7%89%A9%E8%81%94%E7%BD%91-IIoT-%E4%B8%8E-SCADA"><span class="toc-number">1.3.4.1.2.</span> <span class="toc-text">2.工业物联网 (IIoT) 与 SCADA</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-%E8%BD%A6%E8%81%94%E7%BD%91-IoV-%E4%B8%8E%E8%BF%9C%E7%A8%8B%E4%BF%A1%E6%81%AF%E5%A4%84%E7%90%86-Telematics"><span class="toc-number">1.3.4.1.3.</span> <span class="toc-text">3.车联网 (IoV) 与远程信息处理 (Telematics)</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MQTT-%E5%8D%8F%E8%AE%AE%E7%89%B9%E6%80%A7"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">MQTT 协议特性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E7%9A%84-MQTT-%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">推荐的 MQTT 第三方库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#paho-mqtt-%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">paho-mqtt 示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-3-5-WebRTC-%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.5.</span> <span class="toc-text">15.3.5 WebRTC 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-WebRTC-%E5%8D%8F%E8%AE%AE%E7%89%B9%E6%80%A7"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">1.WebRTC 协议特性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-P2P-%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">2.P2P 通信原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%B8%B8%E7%94%A8-API"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">3.常用 API</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E8%B7%B5-Vue3-Flask-SocketIO"><span class="toc-number">1.3.5.4.</span> <span class="toc-text">4. 项目实践 (Vue3 + Flask-SocketIO)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-%E9%A1%B9%E7%9B%AE%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.5.4.1.</span> <span class="toc-text">1.项目初始化</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-%E5%AE%9E%E7%8E%B0%E8%BF%9E%E6%8E%A5%E4%B8%8E%E6%88%BF%E9%97%B4%E5%8A%A0%E5%85%A5"><span class="toc-number">1.3.5.4.2.</span> <span class="toc-text">2.实现连接与房间加入</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-%E5%AE%9E%E7%8E%B0%E5%91%BC%E5%8F%AB%E4%BF%A1%E4%BB%A4-%E8%AF%B7%E6%B1%82-%E6%8E%A5%E5%8F%97-%E6%8C%82%E6%96%AD"><span class="toc-number">1.3.5.4.3.</span> <span class="toc-text">3.实现呼叫信令 (请求/接受/挂断)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-%E8%8E%B7%E5%8F%96%E5%AA%92%E4%BD%93%E6%B5%81%E3%80%81%E5%88%9B%E5%BB%BA-PeerConnection-%E5%B9%B6%E4%BA%A4%E6%8D%A2-SDP"><span class="toc-number">1.3.5.4.4.</span> <span class="toc-text">4.获取媒体流、创建 PeerConnection 并交换 SDP</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-%E5%AE%9E%E7%8E%B0-ICE-Candidate-%E4%BA%A4%E6%8D%A2%E4%B8%8E%E6%98%BE%E7%A4%BA%E8%BF%9C%E7%AB%AF%E6%B5%81"><span class="toc-number">1.3.5.4.5.</span> <span class="toc-text">5.实现 ICE Candidate 交换与显示远端流</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E5%AE%8C%E6%95%B4%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81-server-flask-py"><span class="toc-number">1.3.5.4.6.</span> <span class="toc-text">最终完整后端代码 (server_flask.py)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E5%AE%8C%E6%95%B4%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81-src-App-vue"><span class="toc-number">1.3.5.4.7.</span> <span class="toc-text">最终完整前端代码 (src/App.vue)</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E8%BF%9B%E9%98%B6%E5%AE%9E%E7%8E%B0-%E8%B0%83%E4%BC%98"><span class="toc-number">1.3.5.5.</span> <span class="toc-text">5.进阶实现+调优</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E6%88%98-%E9%80%9A%E8%BF%87-aiortc-%E5%81%9A%E4%B8%80%E4%B8%AA%E8%B6%85%E4%BD%8E%E5%BB%B6%E8%BF%9F%E6%91%84%E5%83%8F%E5%A4%B4%E8%BD%AC%E6%92%AD"><span class="toc-number">1.3.5.5.1.</span> <span class="toc-text">实战 : 通过 aiortc 做一个超低延迟摄像头转播</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81%EF%BC%88%E9%87%87%E7%94%A8-VUE3-daisyui-tailwindcss-%E5%AE%9E%E7%8E%B0%EF%BC%89"><span class="toc-number">1.3.5.5.2.</span> <span class="toc-text">前端代码（采用 VUE3+daisyui+tailwindcss 实现）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF"><span class="toc-number">1.3.5.5.3.</span> <span class="toc-text">后端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-3-6-%E8%A7%86%E9%A2%91%E6%B5%81%E5%8D%8F%E8%AE%AE-RTMP-RTSP-HLS"><span class="toc-number">1.3.6.</span> <span class="toc-text">15.3.6 视频流协议(RTMP/RTSP/HLS)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E8%A7%86%E9%A2%91%E6%B5%81%E5%8D%8F%E8%AE%AE%E5%AF%B9%E6%AF%94"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">主要视频流协议对比</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%A4%E8%AF%86%E5%BF%85%E8%A6%81%E7%9A%84%E4%B8%A4%E4%B8%AA%E5%BA%93"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">认识必要的两个库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96-RTSP-%E8%A7%86%E9%A2%91%E6%B5%81-%E4%BD%BF%E7%94%A8-opencv-python"><span class="toc-number">1.3.6.3.</span> <span class="toc-text">读取 RTSP 视频流 (使用 opencv-python)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#EasyRTSPServer-Simulator-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.6.3.1.</span> <span class="toc-text">EasyRTSPServer Simulator 工具使用</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#15-3-7-2-%E6%8E%A8%E9%80%81-RTMP-%E7%9B%B4%E6%92%AD%E6%B5%81-%E4%BD%BF%E7%94%A8-ffmpeg-python"><span class="toc-number">1.3.6.4.</span> <span class="toc-text">15.3.7.2 推送 RTMP 直播流 (使用 ffmpeg-python)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-4-%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8A%A0%E5%AF%86"><span class="toc-number">1.4.</span> <span class="toc-text">15.4 网络安全与加密</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-4-1-TLS-SSL-%E5%8A%A0%E5%AF%86%E9%80%9A%E4%BF%A1%EF%BC%9A%E4%BF%9D%E9%9A%9C%E4%BC%A0%E8%BE%93%E9%80%9A%E9%81%93%E5%AE%89%E5%85%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">15.4.1 TLS/SSL 加密通信：保障传输通道安全</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#TLS-SSL-%E7%9A%84%E5%85%B3%E9%94%AE%E7%89%B9%E6%80%A7%E4%B8%8E%E5%AE%89%E5%85%A8%E6%84%8F%E4%B9%89"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">TLS/SSL 的关键特性与安全意义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E4%B8%AD%E7%9A%84-TLS-SSL-%E6%94%AF%E6%8C%81%EF%BC%9Assl-%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">Python 中的 TLS/SSL 支持：ssl 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1%EF%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%AE%89%E5%85%A8%E7%9A%84-TLS-SSL-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.4.1.2.1.</span> <span class="toc-text">示例 1：创建一个安全的 TLS/SSL 客户端</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2%EF%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%9F%BA%E7%A1%80%E7%9A%84-TLS-SSL-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">示例 2：创建一个基础的 TLS/SSL 服务器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-4-2-%E6%95%B0%E6%8D%AE%E6%91%98%E8%A6%81%E4%B8%8E%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0-Hashing-%EF%BC%9A%E9%AA%8C%E8%AF%81%E6%95%B0%E6%8D%AE%E5%AE%8C%E6%95%B4%E6%80%A7"><span class="toc-number">1.4.2.</span> <span class="toc-text">15.4.2 数据摘要与哈希函数 (Hashing)：验证数据完整性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E4%B8%AD%E7%9A%84%E5%93%88%E5%B8%8C%E6%94%AF%E6%8C%81%EF%BC%9Ahashlib-%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">Python 中的哈希支持：hashlib 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E5%AF%B9%E6%AF%94%E4%B8%8E%E9%80%89%E6%8B%A9"><span class="toc-number">1.4.2.1.1.</span> <span class="toc-text">常用哈希算法对比与选择</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1%EF%BC%9A%E8%AE%A1%E7%AE%97%E6%95%B0%E6%8D%AE%E7%9A%84%E5%93%88%E5%B8%8C%E5%80%BC"><span class="toc-number">1.4.2.1.2.</span> <span class="toc-text">示例 1：计算数据的哈希值</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2%EF%BC%9A%E5%AE%89%E5%85%A8%E7%9A%84%E5%AF%86%E7%A0%81%E5%AD%98%E5%82%A8%EF%BC%88%E5%8A%A0%E7%9B%90%E5%93%88%E5%B8%8C%EF%BC%89"><span class="toc-number">1.4.2.1.3.</span> <span class="toc-text">示例 2：安全的密码存储（加盐哈希）</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HMAC%EF%BC%9A%E5%B8%A6%E5%AF%86%E9%92%A5%E7%9A%84%E5%93%88%E5%B8%8C%EF%BC%8C%E7%94%A8%E4%BA%8E%E6%B6%88%E6%81%AF%E8%AE%A4%E8%AF%81"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">HMAC：带密钥的哈希，用于消息认证</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E4%B8%AD%E7%9A%84-HMAC-%E6%94%AF%E6%8C%81%EF%BC%9Ahmac-%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">Python 中的 HMAC 支持：hmac 模块</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-4-3-%E6%95%B0%E6%8D%AE%E7%BC%96%E7%A0%81-Data-Encoding-%EF%BC%9A%E5%AE%89%E5%85%A8%E4%BC%A0%E8%BE%93%E7%9A%84%E5%8F%98%E5%BD%A2%E6%9C%AF"><span class="toc-number">1.4.3.</span> <span class="toc-text">15.4.3 数据编码 (Data Encoding)：安全传输的变形术</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Base64-%E7%BC%96%E7%A0%81%EF%BC%9A"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">Base64 编码：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#URL-%E7%BC%96%E7%A0%81-Percent-Encoding-%EF%BC%9A"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">URL 编码 (Percent-Encoding)：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-4-4-%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86-Symmetric-Encryption-%EF%BC%9A%E5%85%B1%E4%BA%AB%E5%90%8C%E4%B8%80%E6%8A%8A%E9%92%A5%E5%8C%99%E7%9A%84%E4%BF%9D%E9%99%A9%E7%AE%B1"><span class="toc-number">1.5.</span> <span class="toc-text">15.4.4 对称加密 (Symmetric Encryption)：共享同一把钥匙的保险箱</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DES-%E5%92%8C-3DES-Data-Encryption-Standard-%EF%BC%9A%E6%98%94%E6%97%A5%E6%A0%87%E5%87%86%EF%BC%8C%E3%80%90%E7%BB%9D%E5%AF%B9%E9%81%BF%E5%85%8D%E3%80%91"><span class="toc-number">1.5.1.</span> <span class="toc-text">DES 和 3DES (Data Encryption Standard)：昔日标准，【绝对避免】</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AES-Advanced-Encryption-Standard-%EF%BC%9A%E7%8E%B0%E4%BB%A3%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E7%9A%84%E5%9F%BA%E7%9F%B3"><span class="toc-number">1.5.2.</span> <span class="toc-text">AES (Advanced Encryption Standard)：现代对称加密的基石</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-4-4-1-AES-%E5%9D%97%E5%8A%A0%E5%AF%86%E6%93%8D%E4%BD%9C%E6%A8%A1%E5%BC%8F-%E3%80%90%E4%BD%BF%E7%94%A8-AES-%E7%9A%84%E5%85%B3%E9%94%AE%EF%BC%81%E3%80%91"><span class="toc-number">1.5.3.</span> <span class="toc-text">15.4.4.1 AES 块加密操作模式 - 【使用 AES 的关键！】</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ECB-Electronic-Codebook-%E6%A8%A1%E5%BC%8F%EF%BC%9A%E3%80%90%E6%9E%81%E5%85%B6%E5%8D%B1%E9%99%A9%EF%BC%8C%E7%A6%81%E6%AD%A2%E4%BD%BF%E7%94%A8%EF%BC%81%E3%80%91"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">ECB (Electronic Codebook) 模式：【极其危险，禁止使用！】</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CBC-Cipher-Block-Chaining-%E6%A8%A1%E5%BC%8F%EF%BC%9A%E3%80%90%E5%B8%B8%E7%94%A8%EF%BC%8C%E9%9C%80%E6%AD%A3%E7%A1%AE%E7%AE%A1%E7%90%86-IV%E3%80%91"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">CBC (Cipher Block Chaining) 模式：【常用，需正确管理 IV】</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GCM-Galois-Counter-Mode-%E6%A8%A1%E5%BC%8F%EF%BC%9A%E3%80%90%E5%BC%BA%E7%83%88%E6%8E%A8%E8%8D%90%EF%BC%8C%E8%AE%A4%E8%AF%81%E5%8A%A0%E5%AF%86%E3%80%91"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">GCM (Galois/Counter Mode) 模式：【强烈推荐，认证加密】</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.3.4.</span> <span class="toc-text">其他模式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-4-4-2-Python-%E5%AE%9E%E7%8E%B0-AES-%E5%8A%A0%E5%AF%86-%E4%BD%BF%E7%94%A8-cryptography-%E5%BA%93"><span class="toc-number">1.5.4.</span> <span class="toc-text">15.4.4.2 Python 实现 AES 加密 (使用 cryptography 库)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1%EF%BC%9A%E4%BD%BF%E7%94%A8-AES-GCM-%E6%8E%A8%E8%8D%90%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">示例 1：使用 AES-GCM (推荐模式)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2%EF%BC%9A%E4%BD%BF%E7%94%A8-AES-CBC-%E5%A6%82%E6%9E%9C%E5%BF%85%E9%A1%BB%E4%BD%BF%E7%94%A8%EF%BC%8C%E4%B8%94%E7%90%86%E8%A7%A3%E5%85%B6%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">示例 2：使用 AES-CBC (如果必须使用，且理解其局限性)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-4-5-%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86-Asymmetric-Encryption-%EF%BC%9A%E5%85%AC%E9%92%A5%E4%B8%8E%E7%A7%81%E9%92%A5%E7%9A%84%E4%B8%96%E7%95%8C"><span class="toc-number">1.6.</span> <span class="toc-text">15.4.5 非对称加密 (Asymmetric Encryption)：公钥与私钥的世界</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RSA-Rivest%E2%80%93Shamir%E2%80%93Adleman-%EF%BC%9A%E5%BA%94%E7%94%A8%E6%9C%80%E5%B9%BF%E6%B3%9B%E7%9A%84%E9%9D%9E%E5%AF%B9%E7%A7%B0%E7%AE%97%E6%B3%95"><span class="toc-number">1.6.1.</span> <span class="toc-text">RSA (Rivest–Shamir–Adleman)：应用最广泛的非对称算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Python-%E5%AE%9E%E7%8E%B0-RSA-%E4%BD%BF%E7%94%A8-cryptography-%E5%BA%93"><span class="toc-number">1.6.2.</span> <span class="toc-text">Python 实现 RSA (使用 cryptography 库)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%87%8D%E8%A6%81%E9%9D%9E%E5%AF%B9%E7%A7%B0%E7%AE%97%E6%B3%95%EF%BC%9AECC-%E6%A4%AD%E5%9C%86%E6%9B%B2%E7%BA%BF%E5%AF%86%E7%A0%81%E5%AD%A6"><span class="toc-number">1.6.3.</span> <span class="toc-text">其他重要非对称算法：ECC (椭圆曲线密码学)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E5%85%AD%E7%AB%A0-%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">2.</span> <span class="toc-text">第十六章 操作数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#16-1-SQLite-%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%88%86%E5%B1%82%E6%93%8D%E4%BD%9C%E6%A1%86%E6%9E%B6"><span class="toc-number">2.1.</span> <span class="toc-text">16.1 SQLite 数据库：构建一个分层操作框架</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#16-1-1-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.1.1.</span> <span class="toc-text">16.1.1 项目结构设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16-1-2-%E6%A0%B8%E5%BF%83%E5%B1%82%E5%AE%9E%E7%8E%B0-core"><span class="toc-number">2.1.2.</span> <span class="toc-text">16.1.2 核心层实现 (core/)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E5%99%A8-core-db-manager-py"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">数据库管理器 (core/db_manager.py)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%A8%E7%AE%A1%E7%90%86%E5%99%A8-core-table-manager-py"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">表管理器 (core/table_manager.py)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16-1-3-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E5%B1%82%E5%AE%9E%E7%8E%B0-models"><span class="toc-number">2.1.3.</span> <span class="toc-text">16.1.3 数据模型层实现 (models/)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%EF%BC%9A%E4%BD%BF%E7%94%A8-dataclass-%E7%AE%80%E5%8C%96-Python-%E7%B1%BB%E5%AE%9A%E4%B9%89"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">前置知识：使用 @dataclass 简化 Python 类定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9E%8B-models-task-py-%E4%BD%BF%E7%94%A8-dataclass"><span class="toc-number">2.1.3.2.</span> <span class="toc-text">任务模型 (models/task.py - 使用 @dataclass)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16-1-4-%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82%E5%AE%9E%E7%8E%B0-repositories"><span class="toc-number">2.1.4.</span> <span class="toc-text">16.1.4 数据访问层实现 (repositories/)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E4%BB%93%E5%BA%93-repositories-task-repository-py"><span class="toc-number">2.1.4.1.</span> <span class="toc-text">任务仓库 (repositories/task_repository.py )</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16-1-5-%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%B1%82%E5%AE%9E%E7%8E%B0-services"><span class="toc-number">2.1.5.</span> <span class="toc-text">16.1.5 业务逻辑层实现 (services/)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%9C%8D%E5%8A%A1-services-task-service-py"><span class="toc-number">2.1.5.1.</span> <span class="toc-text">任务服务 (services/task_service.py )</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16-1-7-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-examples"><span class="toc-number">2.1.6.</span> <span class="toc-text">16.1.7 使用示例 (examples/)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#16-1-7-1-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B-examples-basic-operations-py"><span class="toc-number">2.1.6.1.</span> <span class="toc-text">16.1.7.1 基本操作示例 (examples/basic_operations.py)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-1-7-2-%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B-examples-advanced-queries-py"><span class="toc-number">2.1.6.2.</span> <span class="toc-text">16.1.7.2 高级查询示例 (examples/advanced_queries.py)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-2-MySQL-%E6%95%B0%E6%8D%AE%E5%BA%93-%E4%BD%BF%E7%94%A8-PyMySQL-%E9%A9%B1%E5%8A%A8"><span class="toc-number">2.2.</span> <span class="toc-text">16.2 MySQL 数据库 (使用 PyMySQL 驱动)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#16-2-5-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%EF%BC%9ACRUD-%E4%B8%8E%E6%9F%A5%E8%AF%A2%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.2.1.</span> <span class="toc-text">16.2.5 数据库操作：CRUD 与查询详解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-1-%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE-INSERT"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">16.2.5.1 插入数据 (INSERT)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E5%8D%95%E8%A1%8C%E8%AE%B0%E5%BD%95"><span class="toc-number">2.2.1.1.1.</span> <span class="toc-text">插入单行记录</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E8%AE%B0%E5%BD%95-executemany"><span class="toc-number">2.2.1.1.2.</span> <span class="toc-text">批量插入记录 (executemany)</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-2-%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE-UPDATE"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">16.2.5.2 更新数据 (UPDATE)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-3-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE-DELETE"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">16.2.5.3 删除数据 (DELETE)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-4-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E5%9F%BA%E7%A1%80"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">16.2.5.4 查询数据 (SELECT) - 基础</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E5%88%97"><span class="toc-number">2.2.1.4.1.</span> <span class="toc-text">查询所有列 (*)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%8C%87%E5%AE%9A%E5%88%97"><span class="toc-number">2.2.1.4.2.</span> <span class="toc-text">查询指定列</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-5-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E6%9D%A1%E4%BB%B6%E8%BF%87%E6%BB%A4-WHERE"><span class="toc-number">2.2.1.5.</span> <span class="toc-text">16.2.5.5 查询数据 (SELECT) - 条件过滤 (WHERE)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AD%89%E4%BA%8E"><span class="toc-number">2.2.1.5.1.</span> <span class="toc-text">等于 (=)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AF%94%E8%BE%83%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">2.2.1.5.2.</span> <span class="toc-text">比较运算符 (&gt;, &lt;=)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#BETWEEN-%E2%80%A6-AND-%E2%80%A6%E5%8C%BA%E9%97%B4%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.2.1.5.3.</span> <span class="toc-text">BETWEEN … AND …区间查询</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#IN-%E2%80%A6"><span class="toc-number">2.2.1.5.4.</span> <span class="toc-text">IN (…)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#LIKE-%E6%A8%A1%E7%B3%8A%E5%8C%B9%E9%85%8D"><span class="toc-number">2.2.1.5.5.</span> <span class="toc-text">LIKE (模糊匹配)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#IS-NULL-IS-NOT-NULL"><span class="toc-number">2.2.1.5.6.</span> <span class="toc-text">IS NULL / IS NOT NULL</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%84%E5%90%88%E6%9D%A1%E4%BB%B6-AND-OR-NOT"><span class="toc-number">2.2.1.5.7.</span> <span class="toc-text">组合条件 (AND, OR, NOT)</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-6-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E6%8E%92%E5%BA%8F-ORDER-BY"><span class="toc-number">2.2.1.6.</span> <span class="toc-text">16.2.5.6 查询数据 (SELECT) - 排序 (ORDER BY)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8D%95%E5%88%97%E6%8E%92%E5%BA%8F-ASC-DESC"><span class="toc-number">2.2.1.6.1.</span> <span class="toc-text">单列排序 (ASC/DESC)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A4%9A%E5%88%97%E6%8E%92%E5%BA%8F"><span class="toc-number">2.2.1.6.2.</span> <span class="toc-text">多列排序</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-7-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E5%8E%BB%E9%87%8D-DISTINCT"><span class="toc-number">2.2.1.7.</span> <span class="toc-text">16.2.5.7 查询数据 (SELECT) - 去重 (DISTINCT)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-8-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.1.8.</span> <span class="toc-text">16.2.5.8 查询数据 (SELECT) - 聚合函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-9-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E5%88%86%E7%BB%84-GROUP-BY"><span class="toc-number">2.2.1.9.</span> <span class="toc-text">16.2.5.9 查询数据 (SELECT) - 分组 (GROUP BY)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-10-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E5%88%86%E7%BB%84%E8%BF%87%E6%BB%A4-HAVING"><span class="toc-number">2.2.1.10.</span> <span class="toc-text">16.2.5.10 查询数据 (SELECT) - 分组过滤 (HAVING)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-11-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E5%88%86%E9%A1%B5-LIMIT-OFFSET"><span class="toc-number">2.2.1.11.</span> <span class="toc-text">16.2.5.11 查询数据 (SELECT) - 分页 (LIMIT/OFFSET)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-12-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2-JOIN"><span class="toc-number">2.2.1.12.</span> <span class="toc-text">16.2.5.12 查询数据 (SELECT) - 连接查询 (JOIN)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%85%E8%BF%9E%E6%8E%A5-INNER-JOIN"><span class="toc-number">2.2.1.12.1.</span> <span class="toc-text">内连接 (INNER JOIN)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B7%A6%E8%BF%9E%E6%8E%A5-LEFT-JOIN"><span class="toc-number">2.2.1.12.2.</span> <span class="toc-text">左连接 (LEFT JOIN)</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-13-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-CASE-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">2.2.1.13.</span> <span class="toc-text">16.2.5.13 查询数据 (SELECT) - CASE 表达式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-2-5-14-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E5%AD%90%E6%9F%A5%E8%AF%A2-Subquery"><span class="toc-number">2.2.1.14.</span> <span class="toc-text">16.2.5.14 查询数据 (SELECT) - 子查询 (Subquery)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-3-SQLAlchemy-Core-SQL-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%AF%AD%E8%A8%80"><span class="toc-number">2.3.</span> <span class="toc-text">16.3 SQLAlchemy Core: SQL 表达式语言</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#16-3-1-%E5%BC%95%E6%93%8E-Engine-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%85%A5%E5%8F%A3"><span class="toc-number">2.3.0.1.</span> <span class="toc-text">16.3.1 引擎 (Engine): 数据库连接的入口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-3-2-%E5%85%83%E6%95%B0%E6%8D%AE%E4%B8%8E%E8%A1%A8%E5%AE%9A%E4%B9%89"><span class="toc-number">2.3.0.2.</span> <span class="toc-text">16.3.2. 元数据与表定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-3-3-%E6%89%A7%E8%A1%8C-SQL-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%AF%AD%E5%8F%A5"><span class="toc-number">2.3.0.3.</span> <span class="toc-text">16.3.3. 执行 SQL 表达式语句</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E5%8D%95%E8%A1%8C%E8%AE%B0%E5%BD%95-1"><span class="toc-number">2.3.0.3.1.</span> <span class="toc-text">插入单行记录</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E8%AE%B0%E5%BD%95-INSERT-Multiple"><span class="toc-number">2.3.0.3.2.</span> <span class="toc-text">批量插入记录 (INSERT Multiple)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE-UPDATE"><span class="toc-number">2.3.0.3.3.</span> <span class="toc-text">更新数据 (UPDATE)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95-UPDATE-Multiple"><span class="toc-number">2.3.0.3.4.</span> <span class="toc-text">批量更新记录 (UPDATE Multiple)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE-DELETE"><span class="toc-number">2.3.0.3.5.</span> <span class="toc-text">删除数据 (DELETE)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%E8%AE%B0%E5%BD%95-DELETE-Multiple"><span class="toc-number">2.3.0.3.6.</span> <span class="toc-text">批量删除记录 (DELETE Multiple)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E5%9F%BA%E7%A1%80"><span class="toc-number">2.3.0.3.7.</span> <span class="toc-text">查询数据 (SELECT - 基础)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E6%9D%A1%E4%BB%B6%E8%BF%87%E6%BB%A4-WHERE"><span class="toc-number">2.3.0.3.8.</span> <span class="toc-text">查询数据 (SELECT - 条件过滤 WHERE)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E6%8E%92%E5%BA%8F-ORDER-BY"><span class="toc-number">2.3.0.3.9.</span> <span class="toc-text">查询数据 (SELECT - 排序 ORDER BY)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E5%8E%BB%E9%87%8D-DISTINCT"><span class="toc-number">2.3.0.3.10.</span> <span class="toc-text">查询数据 (SELECT - 去重 DISTINCT)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="toc-number">2.3.0.3.11.</span> <span class="toc-text">查询数据 (SELECT - 聚合函数)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E5%88%86%E7%BB%84-GROUP-BY"><span class="toc-number">2.3.0.3.12.</span> <span class="toc-text">查询数据 (SELECT - 分组 GROUP BY)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E5%88%86%E9%A1%B5-LIMIT-OFFSET"><span class="toc-number">2.3.0.3.13.</span> <span class="toc-text">查询数据 (SELECT - 分页 LIMIT/OFFSET)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2-JOIN"><span class="toc-number">2.3.0.3.14.</span> <span class="toc-text">查询数据 (SELECT - 连接查询 JOIN)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-CASE-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">2.3.0.3.15.</span> <span class="toc-text">查询数据 (SELECT - CASE 表达式)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-SELECT-%E5%AD%90%E6%9F%A5%E8%AF%A2-Subquery"><span class="toc-number">2.3.0.3.16.</span> <span class="toc-text">查询数据 (SELECT - 子查询 Subquery)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#SQLAlchemy-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%87%BD%E6%95%B0-func"><span class="toc-number">2.3.0.3.17.</span> <span class="toc-text">SQLAlchemy 数据库函数 (func)</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-3-4-SQLAlchemy-ORM-%E5%AF%B9%E8%B1%A1%E5%85%B3%E7%B3%BB%E6%98%A0%E5%B0%84"><span class="toc-number">2.3.0.4.</span> <span class="toc-text">16.3.4 SQLAlchemy ORM: 对象关系映射</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#16-3-3-1-Session-ORM-%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%A4%E4%BA%92%E5%8F%A5%E6%9F%84"><span class="toc-number">2.3.0.4.1.</span> <span class="toc-text">16.3.3.1. Session: ORM 的数据库交互句柄</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#16-3-3-2-%E5%A3%B0%E6%98%8E%E5%BC%8F%E6%98%A0%E5%B0%84-Declarative-Mapping-%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.3.0.4.2.</span> <span class="toc-text">16.3.3.2. 声明式映射 (Declarative Mapping): 定义模型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#16-3-3-3-%E5%AE%9A%E4%B9%89%E5%85%B3%E7%B3%BB-relationship"><span class="toc-number">2.3.0.4.3.</span> <span class="toc-text">16.3.3.3. 定义关系 (relationship)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#16-3-3-4-ORM-CRUD-%E6%93%8D%E4%BD%9C-%E4%BD%BF%E7%94%A8-Session-%E5%92%8C-select"><span class="toc-number">2.3.0.4.4.</span> <span class="toc-text">16.3.3.4. ORM CRUD 操作 (使用 Session 和 select)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#16-3-3-5-%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.0.4.5.</span> <span class="toc-text">16.3.3.5 运行示例测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-4-mybatis-py-%E8%BD%BB%E9%87%8F%E7%BA%A7-Python-SQL-%E6%98%A0%E5%B0%84%E5%99%A8"><span class="toc-number">2.4.</span> <span class="toc-text">16.4 mybatis-py: 轻量级 Python SQL 映射器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#16-4-1-%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86"><span class="toc-number">2.4.0.1.</span> <span class="toc-text">16.4.1 核心知识</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-4-2-%E5%AE%9E%E6%88%98-Flask-Integration"><span class="toc-number">2.4.0.2.</span> <span class="toc-text">16.4.2 实战 (Flask Integration)</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%83%E7%AB%A0-%E9%9F%B3%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">第十七章 音视频处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#17-1-FFmpeg-%E4%BB%8B%E7%BB%8D%E3%80%81%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E3%80%81%E5%AE%89%E8%A3%85%E4%B8%8E-Python-%E4%BA%A4%E4%BA%92%E6%96%B9%E5%BC%8F"><span class="toc-number">3.1.</span> <span class="toc-text">17.1 FFmpeg 介绍、核心概念、安装与 Python 交互方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#17-1-1-FFmpeg%EF%BC%9A%E9%9F%B3%E8%A7%86%E9%A2%91%E9%A2%86%E5%9F%9F%E7%9A%84%E2%80%9C%E7%91%9E%E5%A3%AB%E5%86%9B%E5%88%80%E2%80%9D"><span class="toc-number">3.1.1.</span> <span class="toc-text">17.1.1 FFmpeg：音视频领域的“瑞士军刀”</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ffmpeg-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">3.1.1.0.1.</span> <span class="toc-text">ffmpeg (命令行工具)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ffprobe-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">3.1.1.0.2.</span> <span class="toc-text">ffprobe (命令行工具)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ffplay-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">3.1.1.0.3.</span> <span class="toc-text">ffplay (命令行工具)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%BA%93-libav"><span class="toc-number">3.1.1.0.4.</span> <span class="toc-text">核心库 (libav*)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-1-2-%E9%9F%B3%E8%A7%86%E9%A2%91%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-number">3.1.2.</span> <span class="toc-text">17.1.2 音视频基础概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-1-3-%E5%AE%89%E8%A3%85-FFmpeg-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7-%E9%87%8D%E8%A6%81%E5%89%8D%E6%8F%90%EF%BC%81"><span class="toc-number">3.1.3.</span> <span class="toc-text">17.1.3 安装 FFmpeg 命令行工具 (重要前提！)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Windows-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.3.0.1.</span> <span class="toc-text">Windows 安装与配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#macOS-%E5%AE%89%E8%A3%85"><span class="toc-number">3.1.3.0.2.</span> <span class="toc-text">macOS 安装</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Linux-%E5%AE%89%E8%A3%85"><span class="toc-number">3.1.3.0.3.</span> <span class="toc-text">Linux 安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-1-4-Python-%E4%BA%A4%E4%BA%92%E6%96%B9%E5%BC%8F%E7%9A%84%E9%80%89%E6%8B%A9%E4%B8%8E-ffmpeg-python-%E5%AE%89%E8%A3%85"><span class="toc-number">3.1.4.</span> <span class="toc-text">17.1.4 Python 交互方式的选择与 ffmpeg-python 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#subprocess-%E6%A8%A1%E5%9D%97-%E5%9F%BA%E7%A1%80%E6%96%B9%E5%BC%8F"><span class="toc-number">3.1.4.0.1.</span> <span class="toc-text">subprocess 模块 (基础方式)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ffmpeg-python-%E5%BA%93-%E6%8E%A8%E8%8D%90"><span class="toc-number">3.1.4.0.2.</span> <span class="toc-text">ffmpeg-python 库 (推荐)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17-2-FFmpeg-%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%BB%93%E6%9E%84"><span class="toc-number">3.2.</span> <span class="toc-text">17.2 FFmpeg 命令行结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#17-2-1-FFmpeg-%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%BB%93%E6%9E%84%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.2.1.</span> <span class="toc-text">17.2.1 FFmpeg 命令行结构详解</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%80%89%E9%A1%B9%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%8E%E9%A1%BA%E5%BA%8F"><span class="toc-number">3.2.1.0.1.</span> <span class="toc-text">选项的作用域与顺序</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%80%89%E9%A1%B9-Global-Options"><span class="toc-number">3.2.1.0.2.</span> <span class="toc-text">全局选项 (Global Options)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E9%80%89%E9%A1%B9-Input-Options"><span class="toc-number">3.2.1.0.3.</span> <span class="toc-text">输入选项 (Input Options)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E9%80%89%E9%A1%B9-Output-Options"><span class="toc-number">3.2.1.0.4.</span> <span class="toc-text">输出选项 (Output Options)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E6%BB%A4%E9%95%9C%EF%BC%88-filter-complex%EF%BC%89"><span class="toc-number">3.2.1.0.5.</span> <span class="toc-text">复杂滤镜（-filter_complex）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-2-2-%E5%B8%B8%E7%94%A8%E6%BB%A4%E9%95%9C-vf-af"><span class="toc-number">3.2.2.</span> <span class="toc-text">17.2.2 **常用滤镜 (-vf, -af) **</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%A8%A1%E7%B3%8A-boxblur"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">(1) 模糊 (boxblur)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%8F%98%E8%89%B2"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">(2) 变色</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#a-colorbalance"><span class="toc-number">3.2.2.2.1.</span> <span class="toc-text">(a) colorbalance</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#b-colorchannelmixer"><span class="toc-number">3.2.2.2.2.</span> <span class="toc-text">(b) colorchannelmixer</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#d-lutyuv-lutrgb"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">(d) lutyuv / lutrgb</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">3.2.2.3.1.</span> <span class="toc-text">参数说明</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%A4%BA%E4%BE%8B-lutyuv"><span class="toc-number">3.2.2.3.2.</span> <span class="toc-text">命令行示例 (lutyuv)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E5%9B%BE"><span class="toc-number">3.2.2.3.3.</span> <span class="toc-text">效果图</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E8%AF%B4%E6%98%8E%EF%BC%9A%E5%9F%BA%E4%BA%8E%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84-LUT-vs-%E5%8A%A0%E8%BD%BD-LUT-%E9%A2%84%E8%AE%BE%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.2.3.4.</span> <span class="toc-text">重要说明：基于表达式的 LUT vs 加载 LUT 预设文件</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E8%A3%81%E5%89%AA-crop"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">(3) 裁剪 (crop)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%8E%BB-Logo-delogo"><span class="toc-number">3.2.2.5.</span> <span class="toc-text">(4) 去 Logo (delogo)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E5%8A%A0%E8%BE%B9%E6%A1%86-drawbox"><span class="toc-number">3.2.2.6.</span> <span class="toc-text">(5) 加边框 (drawbox)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-%E7%94%BB%E7%BD%91%E6%A0%BC-drawgrid"><span class="toc-number">3.2.2.7.</span> <span class="toc-text">(6) 画网格 (drawgrid)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-%E6%B7%BB%E5%8A%A0%E5%AD%97%E5%B9%95-subtitles-%E6%88%96-drawtext"><span class="toc-number">3.2.2.8.</span> <span class="toc-text">(7) 添加字幕 (subtitles 或 drawtext)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-%E7%94%BB%E8%BE%B9%E7%BC%98-edgedetect"><span class="toc-number">3.2.2.9.</span> <span class="toc-text">(8) 画边缘 (edgedetect)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-EQ-%E6%95%88%E6%9E%9C-eq"><span class="toc-number">3.2.2.10.</span> <span class="toc-text">(9) EQ 效果 (eq)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10-%E7%BC%A9%E6%94%BE-scale"><span class="toc-number">3.2.2.11.</span> <span class="toc-text">(10) 缩放 (scale)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#11-%E7%AD%89%E6%AF%94%E6%94%BE%E5%A4%A7-hqx"><span class="toc-number">3.2.2.12.</span> <span class="toc-text">(11) 等比放大 (hqx)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-%E6%A8%AA%E5%90%91%E5%80%92%E7%BD%AE-hflip"><span class="toc-number">3.2.2.13.</span> <span class="toc-text">(12) 横向倒置 (hflip)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#13-%E7%BA%B5%E5%90%91%E5%80%92%E7%BD%AE-vflip"><span class="toc-number">3.2.2.14.</span> <span class="toc-text">(13) 纵向倒置 (vflip)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#14-%E5%8A%A0%E5%99%AA%E9%9F%B3-noise"><span class="toc-number">3.2.2.15.</span> <span class="toc-text">(14) 加噪音 (noise)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#15-%E5%8A%A0%E6%B0%B4%E5%8D%B0-overlay"><span class="toc-number">3.2.2.16.</span> <span class="toc-text">(15) 加水印 (overlay)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#16-%E5%8A%A0%E5%BA%95%E6%9D%BF-%E7%94%BB%E5%B8%83%E6%89%A9%E5%B1%95-pad"><span class="toc-number">3.2.2.17.</span> <span class="toc-text">(16) 加底板/画布扩展 (pad)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#17-%E6%97%8B%E8%BD%AC-rotate"><span class="toc-number">3.2.2.18.</span> <span class="toc-text">(17) 旋转 (rotate)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#18-%E5%85%89%E6%99%95-%E6%99%95%E5%BD%B1-vignette"><span class="toc-number">3.2.2.19.</span> <span class="toc-text">(18) 光晕/晕影 (vignette)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#19-%E6%B7%A1%E5%85%A5%E6%B7%A1%E5%87%BA-fade-afade"><span class="toc-number">3.2.2.20.</span> <span class="toc-text">(19) 淡入淡出 (fade, afade)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#20-%E6%97%8B%E8%BD%AC-90-180-270-%E5%BA%A6-transpose"><span class="toc-number">3.2.2.21.</span> <span class="toc-text">(20) 旋转 90/180/270 度 (transpose)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#21-%E6%94%B9%E5%8F%98%E6%92%AD%E6%94%BE%E9%80%9F%E5%BA%A6-setpts-atempo"><span class="toc-number">3.2.2.22.</span> <span class="toc-text">(21) 改变播放速度 (setpts, atempo)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-%E7%BB%98%E5%88%B6%E6%96%87%E6%9C%AC-drawtext-%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.2.2.23.</span> <span class="toc-text">(22) 绘制文本 (drawtext) 详解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#23-%E8%A7%86%E9%A2%91%E5%A0%86%E5%8F%A0-hstack-vstack-xstack"><span class="toc-number">3.2.2.24.</span> <span class="toc-text">(23) 视频堆叠 (hstack, vstack, xstack)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24-%E9%94%90%E5%8C%96-unsharp-smartblur"><span class="toc-number">3.2.2.25.</span> <span class="toc-text">(24) 锐化 (unsharp, smartblur)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-2-3-%E6%B5%81%E6%A0%87%E8%AF%86%E7%AC%A6-Stream-Specifiers-%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.2.3.</span> <span class="toc-text">17.2.3 流标识符 (Stream Specifiers) 详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-2-4-FFmpeg-%E8%87%AA%E8%BA%AB%E8%83%BD%E5%8A%9B%E6%9F%A5%E8%AF%A2%E5%91%BD%E4%BB%A4"><span class="toc-number">3.2.4.</span> <span class="toc-text">17.2.4 FFmpeg 自身能力查询命令</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8-encoders-decoders"><span class="toc-number">3.2.4.0.1.</span> <span class="toc-text">查看编解码器 (-encoders, -decoders)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%8D%8F%E8%AE%AE-protocols"><span class="toc-number">3.2.4.0.2.</span> <span class="toc-text">查看协议 (-protocols)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%A0%BC%E5%BC%8F-formats"><span class="toc-number">3.2.4.0.3.</span> <span class="toc-text">查看格式 (-formats)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%92%8C%E5%AD%A6%E4%B9%A0%E6%BB%A4%E9%95%9C-filters-h-filter"><span class="toc-number">3.2.4.0.4.</span> <span class="toc-text">查看和学习滤镜 (-filters, -h filter=&lt;滤镜名&gt;)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AE%8C%E6%95%B4%E5%B8%AE%E5%8A%A9-h-full"><span class="toc-number">3.2.4.0.5.</span> <span class="toc-text">获取完整帮助 (-h full)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-2-5-ffprobe-%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6%E4%BF%A1%E6%81%AF%E8%AF%A6%E8%A7%A3-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E8%AF%BB"><span class="toc-number">3.2.5.</span> <span class="toc-text">17.2.5 ffprobe 获取文件信息详解 (深度解读)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#format-%E5%AF%B9%E8%B1%A1-%E5%AE%B9%E5%99%A8-%E6%96%87%E4%BB%B6%E7%BA%A7%E5%88%AB%E4%BF%A1%E6%81%AF"><span class="toc-number">3.2.5.0.1.</span> <span class="toc-text">"format" 对象 (容器/文件级别信息)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#streams-%E5%88%97%E8%A1%A8-%E6%B5%81%E7%BA%A7%E5%88%AB%E4%BF%A1%E6%81%AF"><span class="toc-number">3.2.5.0.2.</span> <span class="toc-text">"streams" 列表 (流级别信息)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Python-%E8%A7%A3%E6%9E%90-ffprobe-JSON-%E7%A4%BA%E4%BE%8B-%E5%A2%9E%E5%BC%BA%E7%89%88"><span class="toc-number">3.2.5.0.3.</span> <span class="toc-text">Python 解析 ffprobe JSON 示例 (增强版)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17-3-ffmpeg-python-%E6%A0%B8%E5%BF%83-API"><span class="toc-number">3.3.</span> <span class="toc-text">17.3 ffmpeg-python 核心 API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#17-3-1-API-ffmpeg-probe-%E6%8E%A2%E6%B5%8B%E5%AA%92%E4%BD%93%E6%96%87%E4%BB%B6%E4%BF%A1%E6%81%AF"><span class="toc-number">3.3.1.</span> <span class="toc-text">17.3.1 API: ffmpeg.probe() - 探测媒体文件信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-3-2-%E8%BE%93%E5%85%A5%E8%8A%82%E7%82%B9-ffmpeg-input"><span class="toc-number">3.3.2.</span> <span class="toc-text">17.3.2 输入节点 (ffmpeg.input)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-3-3-%E6%B5%81-Stream-%E7%9A%84%E6%A6%82%E5%BF%B5%E4%B8%8E%E9%80%89%E6%8B%A9"><span class="toc-number">3.3.3.</span> <span class="toc-text">17.3.3 流 (Stream) 的概念与选择</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-3-4-%E5%BA%94%E7%94%A8%E6%BB%A4%E9%95%9C-Stream-filter"><span class="toc-number">3.3.4.</span> <span class="toc-text">17.3.4 应用滤镜 (Stream.filter)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-3-5-%E8%BE%93%E5%87%BA%E8%8A%82%E7%82%B9-ffmpeg-output-%E4%B8%8E%E8%BE%93%E5%87%BA%E9%80%89%E9%A1%B9%E8%AF%A6%E8%A7%A3-%E8%A1%A8%E6%A0%BC%E4%BC%98%E5%8C%96%E7%89%88"><span class="toc-number">3.3.5.</span> <span class="toc-text">17.3.5 输出节点 (ffmpeg.output) 与输出选项详解 (表格优化版)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-3-6-%E5%85%A8%E5%B1%80%E9%80%89%E9%A1%B9%E4%B8%8E%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7-compile-view-global-args"><span class="toc-number">3.3.6.</span> <span class="toc-text">17.3.6 全局选项与调试工具 (.compile, .view, global_args)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#API-Node-compile-%E6%9F%A5%E7%9C%8B%E7%94%9F%E6%88%90%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">3.3.6.0.1.</span> <span class="toc-text">API: Node.compile() - 查看生成的命令</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#API-Node-view-%E5%8F%AF%E8%A7%86%E5%8C%96%E5%A4%84%E7%90%86%E5%9B%BE"><span class="toc-number">3.3.6.0.2.</span> <span class="toc-text">API: Node.view() - 可视化处理图</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#API-%E5%85%A8%E5%B1%80%E9%80%89%E9%A1%B9-global-args-in-run-run-async"><span class="toc-number">3.3.6.0.3.</span> <span class="toc-text">API: 全局选项 (global_args in .run() / .run_async())</span></a></li></ol></li></ol></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/06/19/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%8B%E7%AF%87/" title="Python教程：应用之巅"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c7d81.webp" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" alt="Python教程：应用之巅"></a><div class="content"><a class="title" href="/2025/06/19/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%8B%E7%AF%87/" title="Python教程：应用之巅">Python教程：应用之巅</a><time datetime="2025-06-19T06:00:00.000Z" title="发表于 2025-06-19 14:00:00">2025-06-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/" title="Python教程：深入其境"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c5e0c.webp" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" alt="Python教程：深入其境"></a><div class="content"><a class="title" href="/2025/06/18/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%AD%E7%AF%87/" title="Python教程：深入其境">Python教程：深入其境</a><time datetime="2025-06-18T02:00:00.000Z" title="发表于 2025-06-18 10:00:00">2025-06-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/" title="Python教程：Python知识点前篇速览"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/17/685113b7c39b1.webp" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" alt="Python教程：Python知识点前篇速览"></a><div class="content"><a class="title" href="/2025/06/17/Python%E7%9F%A5%E8%AF%86%E7%82%B9%E5%89%8D%E7%AF%87/" title="Python教程：Python知识点前篇速览">Python教程：Python知识点前篇速览</a><time datetime="2025-06-17T07:05:54.000Z" title="发表于 2025-06-17 15:05:54">2025-06-17</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:3381292732@qq.com" rel="external nofollow noreferrer" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://weibo.com/u/7484736298?tabtype=home" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/06/16/684f745b722d7.webp" size="50px"><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Prorise-cool" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://space.bilibili.com/361040115?spm_id_from=333.788.0.0" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div id="workboard"><div id="runtimeTextTip"></div></div><div class="footer_custom_text">这是我的个人博客，分享技术与生活点滴。</div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener external nofollow noreferrer" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.foreverblog.cn/">十年之约</a></div></div><div class="footer-group"><div class="footer-title">主题</div><div class="footer-links"><a class="footer-item" title="文档" href="/docs/">文档</a><a class="footer-item" title="源码" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu">源码</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" rel="external nofollow noreferrer" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="博客框架为Hexo7.0" title="博客框架为Hexo7.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo7.0"></a><a class="github-badge" target="_blank" href="https://www.dogecloud.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站使用多吉云为静态资源提供CDN加速" title="本站使用多吉云为静态资源提供CDN加速"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/CDN-多吉云-3693F3.svg" alt="本站使用多吉云为静态资源提供CDN加速"></a><a class="github-badge" target="_blank" href="https://github.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站采用CC BY-NC-SA 4.0协议" title="本站采用CC BY-NC-SA 4.0协议"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用CC BY-NC-SA 4.0协议"></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">©2025 By <a class="footer-bar-link" href="/about/" title="Prorise" target="_blank">Prorise</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = ["生活明朗, 万物可爱, 人间值得, 未来可期.","愿你眼里的星星，永远亮晶晶。","愿我们每个人都能被世界温柔以待。"]
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/typed.js/2.0.12/typed.min.js').then(subtitleType)
  }
} else {
  subtitleType()
}</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Prorise-cool?tab=repositories" title="网站源码">网站源码</a><a class="footer-bar-link" target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn/" title="湘ICP备23041-302号">湘ICP备23041-302号</a><a class="footer-bar-link cc" href="/copyright" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">2</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" rel="external nofollow noreferrer" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="后续项目..."><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="后续项目..."><span class="back-menu-item-text">后续项目...</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>个人</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="fas fa-check-double faa-tada"></i><span> 代办清单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>预览</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?server=netease&amp;id=3117791189"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/messages/"><i class="fas fa-comments faa-tada"></i><span> 评论总览</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 即刻短文</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Python/" style="font-size:.88rem">Python<sup>3</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight,500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="anzhiyufont anzhiyu-icon-comment-sms"></i></button><button id="to_comment" type="button" title="直达评论" onclick="FixedCommentBtn()"><i class="anzhiyufont anzhiyu-icon-comments"></i></button><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" rel="external nofollow noreferrer" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="3117791189" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=3117791189&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async="" src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>//- 从这里开始的所有JS代码，都必须有缩进（例如2个空格）
// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("06/10/2025 00:00:00"); // 此处读取您配置中的建站时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  
  // --- 已将您的专属LOGO和个人信息集成到这里 ---
  const ascll = [
    `欢迎访问 Prorise 的数字空间!`,
    `代码构建世界，思想驱动未来`,
    // 这里的反引号和所有ASCII art行，都必须有正确的缩进
    `
     ____                      _             
    |  _ \\  _ __   ___   _ __  (_) ___   ___  
    | |_) || '__| / _ \\ | '__| | |/ __| / _ \\ 
    |  __/ | |   | (_) || |    | |\\__ \\|  __/ 
    |_|    |_|    \\___/ |_|    |_||___/ \\___| 
                                             
    `,
    "已稳定运行",
    dnum,
    "天",
    `©2025 By Prorise 1.0.0`,
  ];
  
  const ascll2 = [`SYS-INFO`, `前置摄像头拍照成功`, `您的帅气脸庞为：`, `😎`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c${ascll[2]} \n%c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF; font-family:monospace;",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );

  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，朋友.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Created by Prorise %c 你正在访问 Prorise 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 注意，你的所有操作已被记录.", "color:white; background-color:#d9534f", "")
  );
});</script><script async="" src="/anzhiyu/random.js"></script><script async="">(function () {
  var grt = new Date("06/10/2025 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "";
        img.title = "下班了就该开开心心的玩耍，嘿嘿~";
        img.alt = "下班了就该开开心心的玩耍，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js').then(runMermaid)
  }

  anzhiyu.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.prorise666.site/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.prorise666.site/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  let initFn = window.walineFn || null

  const initWaline = (Fn) => {
    const waline = Fn(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://waline.prorise666.site',
      pageview: true,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: true,
      imageUploader: true,
    }, null))

    const destroyWaline = () => {
      waline.destroy()
    }

    anzhiyu.addGlobalFn('pjax', destroyWaline, 'destroyWaline')
  }

  const loadWaline = async () => {
    if (initFn) initWaline(initFn)
    else {
      await getCSS('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline.css')
      if (true) await getCSS('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline-meta.css')
      const { init } = await import('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline.js')
      initFn = init || Waline.init
      initWaline(initFn)
      window.walineFn = initFn
    }
  }

  if ('Twikoo' === 'Waline' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async="" src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.prorise666.site/',
        region: 'ap-shanghai',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async="" data-pjax="" src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail=""</script><script async="" data-pjax="" src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="/js/load-on-demand.js"></script><script defer="" id="fluttering_ribbon" mobile="false" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="" color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script id="click-heart" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="" mobile="false"></script><script src="//code.tidio.co//tk571vck0ua2wjoalfbp8wyrlsdaunmz.js" async=""></script><script>(() => {
  const isChatBtn = true
  const isChatHideShow = true

  if (isChatBtn) {
    let isShow = false
    const close = () => {
      window.tidioChatApi.hide()
      isShow = false
      document.body.style.position = 'relative';
      document.documentElement.style.overflow = 'auto'
    }
    
    const open = () => {
      window.tidioChatApi.open()
      window.tidioChatApi.show()
      isShow = true
    }

    const onTidioChatApiReady = () => {
      window.tidioChatApi.hide()
      window.tidioChatApi.on("close", close)
    }
    if (window.tidioChatApi) {
      window.tidioChatApi.on("ready", onTidioChatApiReady)
    } else {
      document.addEventListener("tidioChat-ready", onTidioChatApiReady)
    }

    window.chatBtnFn = () => {
      if (!window.tidioChatApi) return
      isShow ? close() : open()
    }
  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => {
        window.tidioChatApi && window.tidioChatApi.hide()
      },
      show: () => {
        window.tidioChatApi && window.tidioChatApi.show()
      }
    }
  }
})()</script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://npm.elemecdn.com/meting@2.0.1/dist/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '[object Object]', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div>
    <link rel="stylesheet" href="https://ai.tianli0.top/static/public/postChatUser_summary.min.css">
    <script>
        let tianliGPT_key = '';
        let tianliGPT_postSelector = '#post-container .post-content';
        let tianliGPT_Title = '✨ AI 文章摘要';
        let tianliGPT_postURL = '/^https?:\/\/[^\/]+\/[0-9]{4}\/[0-9]{2}\/[0-9]{2}\/';
        let tianliGPT_blacklist = '';
        let tianliGPT_wordLimit = '1000';
        let tianliGPT_typingAnimate = true;
        let tianliGPT_theme = 'default';
        var postChatConfig = {
          backgroundColor: "#4d648d",
          bottom: "76px",
          left: "16px",
          fill: "#FFFFFF",
          width: "50px",
          frameWidth: "380px",
          frameHeight: "600px",
          defaultInput: true,
          upLoadWeb: true,
          showInviteLink: true,
          userTitle: "💬 智能助手",
          userDesc: "我是 Prorise 博客的 AI 助手，有任何关于网站内容的问题都可以问我哦～",
          addButton: true,
          beginningText: "这篇文章介绍了",
          userIcon: "https://ai.tianli0.top/static/img/PostChat.webp",
          userMode: "magic",
          defaultChatQuestions: ["你好","你是谁"],
          defaultSearchQuestions: ["视频压缩","设计"]
        };
    </script>
    <script data-postchat_key="" src="https://ai.tianli0.top/static/public/tianli_gpt.min.js"></script>
  </body></html>